<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            nftableså­ç³»ç»Ÿæµ…åˆ†æ |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/rocket-lunch.svg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/rocket-lunch.svg"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        nftableså­ç³»ç»Ÿæµ…åˆ†æ
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-08-17 01:56:39</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Sat Aug 17 2024 01:55:08 GMT+0800">2024-08-17 01:55:08</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/netfilter/">netfilter</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/nftables/">nftables</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/netlink/">netlink</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>15.2k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>78 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è½¬çœ¼é—´ä¸Šä¸€ç¯‡æ–‡ç« åˆæ˜¯å‡ ä¸ªæœˆå‰çš„äº‹æƒ…äº†ï¼Œä¸»è¦åŸå› æ˜¯è¿‘æœŸé‡åˆ°äº†ä¸€ä¸ªè®©æˆ‘ååˆ†ç—´è¿·çš„æ¸¸æˆâ€”â€”PUBGï¼å»ºè®®ç›´æ¥è·Ÿæˆ‘å­¦ä¹ æˆ‘çš„æ— æ•Œé—ªèº«å–·ï¼ä¾ç¨€è®°å¾—åœ¨è“æ¥¼ä¸‰æ¥¼æ‹è§’è¿ç»­å–·æ­»ä¸€é˜Ÿè¢«å¯¹é¢éª‚æˆ‘æ˜¯å¼€æŒ‚çš„ï¼å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆï¼ï¼</p>
<p><strong>æœ€è¿‘çš„åæ€1192ä¼¤å®³åƒé¸¡ä¹Ÿæ˜¯ä¹…ä¹…éš¾ä»¥å¹³å¤ã€‚</strong></p>
<p>å‰é¢ä¸€ç›´æåˆ°æˆ‘è¦å¼€å§‹å†™fuzzingç›¸å…³å†…å®¹ï¼Œæœ¬æ¥ä¹Ÿå°±æ‰“ç®—ä»AFLæºç å¼€å§‹çœ‹ç„¶åè®°å½•ä¸‹æ¥ï¼Œä½†æ˜¯åœ¨å­¦ä¹ å®Œäº†ä¹‹åå°±åˆæ‡’å¾—å†™äº†ã€‚å½“ç„¶æœ€ä¸»è¦çš„è¿˜æ˜¯åœ¨åŒäº‹é‚£é‡Œè¯·æ•™äº†ä¸€ä¸‹æŒ–æ´å¿ƒå¾—ï¼Œä¹Ÿæ˜¯è®©æˆ‘é€‰æ‹©ä¸åœ¨çº ç»“äºfuzzingä¹‹ç±»çš„â€œæ­ªé—¨é‚ªé“â€å¼€å§‹ä»å†…å¿ƒå®¡è§†ä»£ç ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ç›®çš„æ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹netlinké€šä¿¡æœºåˆ¶ä»¥åŠnftableså­ç³»ç»Ÿï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¹‹åä¼šèšç„¦å¤ç°å…³äºnetlinkä»¥åŠnftableså­ç³»ç»Ÿç›¸å…³æ¼æ´ï¼Œåœ¨åç»­çš„æ–‡ç« ä¸­ä¸ä¼šå†å‡ºç°å¯¹è¿™å®ƒä»¬çš„è§£é‡Šï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« ç®—æ˜¯ä¸ºåç»­çš„æ¼æ´å¤ç°æ‰“åŸºç¡€å§ã€‚</p>
<h2 id="Netlinké€šä¿¡æœºåˆ¶"><a href="#Netlinké€šä¿¡æœºåˆ¶" class="headerlink" title="Netlinké€šä¿¡æœºåˆ¶"></a>Netlinké€šä¿¡æœºåˆ¶</h2><p>Netlinkæ˜¯Linuxæä¾›çš„ç”¨äºå†…æ ¸å’Œç”¨æˆ·æ€è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æ–¹å¼ã€‚ä½†æ˜¯æ³¨æ„è™½ç„¶Netlinkä¸»è¦ç”¨äºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é€šä¿¡ï¼Œä½†æ˜¯ä¹Ÿèƒ½ç”¨äºç”¨æˆ·ç©ºé—´çš„ä¸¤ä¸ªè¿›ç¨‹é€šä¿¡ã€‚åªæ˜¯è¿›ç¨‹é—´é€šä¿¡æœ‰å…¶ä»–å¾ˆå¤šæ–¹å¼ï¼Œä¸€èˆ¬ä¸ç”¨Netlinkã€‚é™¤ééœ€è¦ç”¨åˆ°Netlinkçš„å¹¿æ’­ç‰¹æ€§æ—¶ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é€šä¿¡æ–¹å¼æœ‰ä¸‰ç§ï¼š&#x2F;procã€ioctlã€Netlinkã€‚è€Œå‰ä¸¤ç§éƒ½æ˜¯å•å‘çš„ï¼Œä½†æ˜¯Netlinkå¯ä»¥å®ç°åŒå·¥é€šä¿¡ã€‚Netlinkåè®®åŸºäºBSD socketå’ŒAF_NETLINKåœ°å€ç°‡(address family)ï¼Œä½¿ç”¨32ä½çš„ç«¯å£å·å¯»å€(ä»¥å‰ç§°ä½œPID)ï¼Œæ¯ä¸ªNetlinkåè®®(æˆ–ç§°ä½œæ€»çº¿ï¼Œmanæ‰‹å†Œä¸­åˆ™ç§°ä¹‹ä¸ºnetlink family)ï¼Œé€šå¸¸ä¸ä¸€ä¸ªæˆ–ä¸€ç»„å†…æ ¸æœåŠ¡&#x2F;ç»„ä»¶ç›¸å…³è”ï¼Œå¦‚NETLINK_ROUTEç”¨äºè·å–å’Œè®¾ç½®è·¯ç”±ä¸é“¾è·¯ä¿¡æ¯ã€NETLINK_KOBJECT_UEVENTç”¨äºå†…æ ¸å‘ç”¨æˆ·ç©ºé—´çš„udevè¿›ç¨‹å‘é€é€šçŸ¥ç­‰ã€‚</p>
<h3 id="ç”¨æˆ·æ€æ•°æ®ç»“æ„"><a href="#ç”¨æˆ·æ€æ•°æ®ç»“æ„" class="headerlink" title="ç”¨æˆ·æ€æ•°æ®ç»“æ„"></a>ç”¨æˆ·æ€æ•°æ®ç»“æ„</h3><p>ä»¥ä¸‹é¢è¿™ä¸ªç¨‹åºä¸ºä¾‹å­å¯¹å…¶ä¸­æ¶‰åŠåˆ°çš„ç»“æ„ä½“è¿›è¡Œåˆ†æã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PAYLOAD 1024 <span class="comment">// maximum payload size</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_TEST 25 <span class="comment">//è‡ªå®šä¹‰çš„åè®®</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> state;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">src_addr</span>, <span class="title">dest_addr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> <span class="literal">NULL</span>; <span class="comment">//Netlinkæ•°æ®åŒ…å¤´</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sock_fd, retval;</span><br><span class="line">    <span class="keyword">int</span> state_smg = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Create a socket</span></span><br><span class="line">    sock_fd = socket(AF_NETLINK, SOCK_RAW, NETLINK_TEST);</span><br><span class="line">    <span class="keyword">if</span>(sock_fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error getting socket: %s&quot;</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// To prepare binding</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;src_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(src_addr));</span><br><span class="line">    src_addr.nl_family = AF_NETLINK;</span><br><span class="line">    src_addr.nl_pid = <span class="number">100</span>; <span class="comment">//Aï¼šè®¾ç½®æºç«¯ç«¯å£å·</span></span><br><span class="line">    src_addr.nl_groups = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//Bind</span></span><br><span class="line">    retval = bind(sock_fd, (struct sockaddr*)&amp;src_addr, <span class="keyword">sizeof</span>(src_addr));</span><br><span class="line">    <span class="keyword">if</span>(retval &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind failed: %s&quot;</span>, strerror(errno));</span><br><span class="line">        close(sock_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// To orepare create mssage</span></span><br><span class="line">    nlh = (struct nlmsghdr *)<span class="built_in">malloc</span>(NLMSG_SPACE(MAX_PAYLOAD));</span><br><span class="line">    <span class="keyword">if</span>(!nlh)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;malloc nlmsghdr error!\n&quot;</span>);</span><br><span class="line">        close(sock_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;dest_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(dest_addr));</span><br><span class="line">    dest_addr.nl_family = AF_NETLINK;</span><br><span class="line">    dest_addr.nl_pid = <span class="number">0</span>; <span class="comment">//Bï¼šè®¾ç½®ç›®çš„ç«¯å£å·</span></span><br><span class="line">    dest_addr.nl_groups = <span class="number">0</span>;</span><br><span class="line">    nlh-&gt;nlmsg_len = NLMSG_SPACE(MAX_PAYLOAD);</span><br><span class="line">    nlh-&gt;nlmsg_pid = <span class="number">100</span>; <span class="comment">//Cï¼šè®¾ç½®æºç«¯å£</span></span><br><span class="line">    nlh-&gt;nlmsg_flags = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(NLMSG_DATA(nlh),<span class="string">&quot;Hello you!&quot;</span>); <span class="comment">//è®¾ç½®æ¶ˆæ¯ä½“</span></span><br><span class="line">    iov.iov_base = (<span class="keyword">void</span> *)nlh;</span><br><span class="line">    iov.iov_len = NLMSG_SPACE(MAX_PAYLOAD);</span><br><span class="line">    <span class="comment">//Create mssage</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    msg.msg_name = (<span class="keyword">void</span> *)&amp;dest_addr;</span><br><span class="line">    msg.msg_namelen = <span class="keyword">sizeof</span>(dest_addr);</span><br><span class="line">    msg.msg_iov = &amp;iov;</span><br><span class="line">    msg.msg_iovlen = <span class="number">1</span>;å®šä¹‰å¦‚ä¸‹</span><br><span class="line">    <span class="comment">//send message</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;state_smg\n&quot;</span>);</span><br><span class="line">    state_smg = sendmsg(sock_fd,&amp;msg,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(state_smg == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;get error sendmsg = %s\n&quot;</span>,strerror(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(nlh,<span class="number">0</span>,NLMSG_SPACE(MAX_PAYLOAD));</span><br><span class="line">    <span class="comment">//receive message</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;waiting received!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;In while recvmsg\n&quot;</span>);</span><br><span class="line">        state = recvmsg(sock_fd, &amp;msg, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(state&lt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;state&lt;1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Received message: %s\n&quot;</span>,(<span class="keyword">char</span> *) NLMSG_DATA(nlh));</span><br><span class="line">    &#125;</span><br><span class="line">    close(sock_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºé¦–å…ˆåˆ›å»ºä¸€ä¸ªsocketï¼Œè¿™é‡Œé€‰æ‹©çš„åœ°å€æ—å³ä¸º<code>AF_NETLINK</code>ï¼Œå¥—æ¥å­—é€‰æ‹©ç±»å‹ä¸ºSOCK_RAWæˆ–SOCK_DGRAM,å› ä¸ºnetlinkæ˜¯ä¸€ä¸ªé¢å‘æ•°æ®æŠ¥çš„æœåŠ¡ï¼Œæœ€ååè®®é€‰æ‹©å¥—æ¥å­—ä½¿ç”¨å“ªç§netlinkç‰¹å¾ã€‚</p>
<p>éšåé€šè¿‡bindå‡½æ•°è¿›è¡Œåœ°å€ç»‘å®šï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œç¬¬äºŒä¸ªå‚æ•°å…¶å®å°±æ˜¯ç»“æ„ä½“<code>struct sockaddr_nl</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> &#123;</span></span><br><span class="line">	<span class="keyword">__kernel_sa_family_t</span>	nl_family;	<span class="comment">/* AF_NETLINK	*/</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>	nl_pad;		<span class="comment">/* zero		*/</span></span><br><span class="line">	__u32		nl_pid;		<span class="comment">/* port ID	*/</span></span><br><span class="line">       	__u32		nl_groups;	<span class="comment">/* multicast groups mask */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç®€å•æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç»“æ„ä½“ï¼Œé¦–å…ˆç¬¬ä¸€ä¸ªæˆå‘˜<code>nl_family</code>ä¸ºå›ºå®šçš„<code>AF_NETLINK</code>ï¼Œå…¶æ¬¡<code>nl_pad</code>æˆå‘˜åœ¨èµ·åˆæ˜¯ç”¨ä¸åˆ°çš„æ‰€ä»¥è¿™é‡Œä¸º0ï¼Œé‡ç‚¹å…³æ³¨åä¸¤ä¸ªæˆå‘˜ã€‚</p>
<p>æˆå‘˜<code>nl_pid</code>åœ¨Netlinkè§„èŒƒé‡Œï¼ŒPIDå…¨ç§°æ˜¯Port-ID(32bits)ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯ç”¨äºå”¯ä¸€çš„æ ‡è¯†ä¸€ä¸ªåŸºäºnetlinkçš„socketé€šé“ã€‚é€šå¸¸æƒ…å†µä¸‹<code>nl_pid</code>éƒ½è®¾ç½®ä¸ºå½“å‰è¿›ç¨‹çš„è¿›ç¨‹å·ã€‚å‰é¢æˆ‘ä»¬ä¹Ÿè¯´è¿‡ï¼ŒNetlinkä¸ä»…å¯ä»¥å®ç°ç”¨æˆ·-å†…æ ¸ç©ºé—´çš„é€šä¿¡è¿˜å¯ä½¿ç°å®ç”¨æˆ·ç©ºé—´ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´ï¼Œæˆ–å†…æ ¸ç©ºé—´ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚è¯¥å±æ€§ä¸º0æ—¶ä¸€èˆ¬æŒ‡å†…æ ¸ã€‚</p>
<p>æˆå‘˜<code>nl_groups</code>å¦‚æœç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹å¸Œæœ›åŠ å…¥æŸä¸ªå¤šæ’­ç»„ï¼Œåˆ™å¿…é¡»æ‰§è¡Œbind()ç³»ç»Ÿè°ƒç”¨ã€‚è¯¥å­—æ®µæŒ‡æ˜äº†è°ƒç”¨è€…å¸Œæœ›åŠ å…¥çš„å¤šæ’­ç»„å·çš„æ©ç (æ³¨æ„ä¸æ˜¯ç»„å·ï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†è®²è§£è¿™ä¸ªå­—æ®µ)ã€‚å¦‚æœè¯¥å­—æ®µä¸º0åˆ™è¡¨ç¤ºè°ƒç”¨è€…ä¸å¸Œæœ›åŠ å…¥ä»»ä½•å¤šæ’­ç»„ã€‚å¯¹äºæ¯ä¸ªéš¶å±äºNetlinkåè®®åŸŸçš„åè®®ï¼Œæœ€å¤šå¯æ”¯æŒ32ä¸ªå¤šæ’­ç»„(å› ä¸ºnl_groupsçš„é•¿åº¦ä¸º32æ¯”ç‰¹)ï¼Œæ¯ä¸ªå¤šæ’­ç»„ç”¨ä¸€ä¸ªæ¯”ç‰¹æ¥è¡¨ç¤ºã€‚</p>
<p>å›åˆ°ä¸Šé¢ç¨‹åºæµç¨‹ï¼Œç´§æ¥ç€åˆ›å»ºä¸€ä¸ª<code>struct nlmsghdr</code>ï¼Œè¯¥ç»“æ„ä½“ä½œä¸ºNetlinkçš„æŠ¥æ–‡æ¶ˆæ¯å¤´ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> &#123;</span></span><br><span class="line">	__u32		nlmsg_len;	<span class="comment">/* Length of message including header */</span></span><br><span class="line">	__u16		nlmsg_type;	<span class="comment">/* Message content */</span></span><br><span class="line">	__u16		nlmsg_flags;	<span class="comment">/* Additional flags */</span></span><br><span class="line">	__u32		nlmsg_seq;	<span class="comment">/* Sequence number */</span></span><br><span class="line">	__u32		nlmsg_pid;	<span class="comment">/* Sending process port ID */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆç¬¬ä¸€ä¸ªæˆå‘˜å¾ˆæ˜æ˜¾å…¶å«ä¹‰å°±æ˜¯æ•´ä¸ªæ¶ˆæ¯çš„é•¿åº¦ï¼ŒæŒ‰ç…§å­—èŠ‚è®¡ç®—ï¼ŒåŒ…æ‹¬äº†Netlinkæ¶ˆæ¯å¤´æœ¬èº«ã€‚</p>
<p>ç¬¬äºŒä¸ªæˆå‘˜åˆ™æ˜¯æ¶ˆæ¯çš„ç±»å‹ï¼Œç¬¬ä¸‰ä¸ªæˆå‘˜åˆ™æ˜¯é™„åŠ åœ¨æ¶ˆæ¯çš„é¢å¤–è¯´æ˜ä¿¡æ¯ã€‚æ¶ˆæ¯åºåˆ—å·ï¼Œç”¨ä»¥å°†æ¶ˆæ¯æ’é˜Ÿï¼Œæœ‰äº›ç±»ä¼¼TCPåè®®ä¸­çš„åºå·ï¼ˆä¸å®Œå…¨ä¸€æ ·ï¼‰ï¼Œä½†æ˜¯netlinkçš„è¿™ä¸ªå­—æ®µæ˜¯å¯é€‰çš„ï¼Œä¸å¼ºåˆ¶ä½¿ç”¨ã€‚æœ€åä¸€ä¸ªæˆå‘˜è¡¨ç¤ºå‘é€ç«¯å£çš„IDå·ï¼Œå¯¹äºå†…æ ¸æ¥è¯´è¯¥å€¼å°±æ˜¯0ï¼Œå¯¹äºç”¨æˆ·è¿›ç¨‹æ¥è¯´å°±æ˜¯å…¶socketæ‰€ç»‘å®šçš„IDå·ã€‚</p>
<p>è¿™é‡Œå†çœ‹ç”³è¯·<code>nlmsghdr</code>æ—¶æ‰€ç”³è¯·çš„å¤§å°æ˜¯å¤šå°‘ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_ALIGNTO	4U</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_ALIGN(len) ( ((len)+NLMSG_ALIGNTO-1) &amp; ~(NLMSG_ALIGNTO-1) )</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_HDRLEN	 ((int) NLMSG_ALIGN(sizeof(struct nlmsghdr)))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_LENGTH(len) ((len)+NLMSG_ALIGN(NLMSG_HDRLEN))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_SPACE(len) NLMSG_ALIGN(NLMSG_LENGTH(len))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_DATA(nlh)  ((void*)(((char*)nlh) + NLMSG_LENGTH(0)))</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ç®€å•çš„è¿ç®—å¯ä»¥ç®—å‡ºæ¥è¿™é‡Œç”³è¯·çš„å †å—å¤§å°ä¸ºï¼š0x410 å…¶å«ä¹‰å°±æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„å¤§å° 0x400 ä»¥åŠæ¶ˆæ¯å¤´çš„å¤§å°0x10ã€‚</p>
<p>ç¨‹åºå†å¾€åå°±æ˜¯å¾€DATAæ®µå†™ä¸Šæ¶ˆæ¯ä½“ï¼Œéšåè®¾ç½®iovï¼Œæ¥ç€å¯¹<code>struct msghdr</code>è¿›è¡Œè®¾ç½®ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Structure describing messages sent by</span></span><br><span class="line"><span class="comment">   `sendmsg&#x27; and received by `recvmsg&#x27;.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *msg_name;		<span class="comment">/* Address to send to/receive from.  */</span></span><br><span class="line">    <span class="keyword">socklen_t</span> msg_namelen;	<span class="comment">/* Length of address data.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">msg_iov</span>;</span>	<span class="comment">/* Vector of data to send/receive into.  */</span></span><br><span class="line">    <span class="keyword">int</span> msg_iovlen;		<span class="comment">/* Number of elements in the vector.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *msg_control;		<span class="comment">/* Ancillary data (eg BSD filedesc passing). */</span></span><br><span class="line">    <span class="keyword">socklen_t</span> msg_controllen;	<span class="comment">/* Ancillary data buffer length.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> msg_flags;		<span class="comment">/* Flags in received message.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªç»“æ„ä½“ä¸ä»…é™äºåœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä¸ä»…æ˜¯Netlinkä¸“å±çš„ä¸€ä¸ªç»“æ„ä½“ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹è¿™ä¸ªç»“æ„ä½“ï¼Œé¦–å…ˆè¿™é‡Œ<code>msg_name</code>æˆå‘˜æŒ‡å‘çš„æ˜¯æ•°æ®åŒ…çš„ç›®çš„åœ°å€ï¼ˆè¿™é‡Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„dest_addrï¼Œå¯ä»¥æ³¨æ„åˆ°å…¶nl_pidä¸º0è¡¨ç¤ºå…¶ç›®çš„ä¸ºå†…æ ¸ï¼‰ã€‚ç„¶åå°±æ˜¯<code>msg_iov</code>ä¹Ÿå°±æ˜¯æŒ‡å‘å‰é¢ç”¨äºæŒ‡å‘å®é™…è½½è·çš„iovç»“æ„ï¼Œåé¢çš„<code>msg_iovlen</code>æˆå‘˜è¡¨ç¤ºçš„æ˜¯<code>msg_iov</code>çš„ä¸ªæ•°è€Œä¸æ˜¯é•¿åº¦ã€‚</p>
<p>ç¨‹åºåç»­å°±æ˜¯å‘é€æ¶ˆæ¯ä»¥åŠæ¥å—æ¶ˆæ¯ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼ˆæ¯•ç«Ÿè¿™ä¸€æ®µä¸»è¦è¿˜æ˜¯è¯´æ•°æ®ç»“æ„ç›¸å…³çš„å†…å®¹ï¼‰ã€‚</p>
<h3 id="å†…æ ¸æ€Netlink-socket-API"><a href="#å†…æ ¸æ€Netlink-socket-API" class="headerlink" title="å†…æ ¸æ€Netlink socket API"></a>å†…æ ¸æ€Netlink socket API</h3><p>è¿™é‡Œé¦–å…ˆå¤§æ¦‚ä»‹ç»ä¸€ä¸‹åœ¨é¢å¯¹é€šä¿¡æ—¶å†…æ ¸æ€æ‰€éœ€è¦ä½¿ç”¨åˆ°çš„ç›¸å…³APIï¼Œå…·ä½“çš„å‡½æ•°åˆ†æä»¥åŠç»“æ„ä½“åˆ†ææ”¾åœ¨åé¢ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/sock.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_TEST 25</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_MSGSIZE 1024</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stringlength</span><span class="params">(<span class="keyword">char</span> *s)</span></span>;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nl_sk</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//å‘ç”¨æˆ·æ€è¿›ç¨‹å›å‘æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendnlmsg</span><span class="params">(<span class="keyword">char</span> *message, <span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb_1</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line">    <span class="keyword">int</span> len = NLMSG_SPACE(MAX_MSGSIZE);</span><br><span class="line">    <span class="keyword">int</span> slen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!message || !nl_sk)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_ERR <span class="string">&quot;pid:%d\n&quot;</span>,pid);</span><br><span class="line">    skb_1 = alloc_skb(len,GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span>(!skb_1)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;my_net_link:alloc_skb error\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    slen = stringlength(message);</span><br><span class="line">    nlh = nlmsg_put(skb_1,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,MAX_MSGSIZE,<span class="number">0</span>);</span><br><span class="line">    NETLINK_CB(skb_1).pid = <span class="number">0</span>;</span><br><span class="line">    NETLINK_CB(skb_1).dst_group = <span class="number">0</span>;</span><br><span class="line">    message[slen]= <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(NLMSG_DATA(nlh),message,slen+<span class="number">1</span>);</span><br><span class="line">    printk(<span class="string">&quot;my_net_link:send message &#x27;%s&#x27;.\n&quot;</span>,(<span class="keyword">char</span> *)NLMSG_DATA(nlh));</span><br><span class="line">    netlink_unicast(nl_sk,skb_1,pid,MSG_DONTWAIT);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stringlength</span><span class="params">(<span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> slen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; *s; s++)</span><br><span class="line">    &#123;</span><br><span class="line">        slen++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> slen;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ¥æ”¶ç”¨æˆ·æ€å‘æ¥çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nl_data_ready</span><span class="params">(struct sk_buff *__skb)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line">     <span class="keyword">char</span> str[<span class="number">100</span>];</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> <span class="title">cmpl</span>;</span></span><br><span class="line">     printk(<span class="string">&quot;begin data_ready\n&quot;</span>);</span><br><span class="line">     <span class="keyword">int</span> i=<span class="number">10</span>;</span><br><span class="line">     <span class="keyword">int</span> pid;</span><br><span class="line">     skb = skb_get (__skb);</span><br><span class="line">     <span class="keyword">if</span>(skb-&gt;len &gt;= NLMSG_SPACE(<span class="number">0</span>))</span><br><span class="line">     &#123;</span><br><span class="line">         nlh = nlmsg_hdr(skb);</span><br><span class="line">         <span class="built_in">memcpy</span>(str, NLMSG_DATA(nlh), <span class="keyword">sizeof</span>(str));</span><br><span class="line">         printk(<span class="string">&quot;Message received:%s\n&quot;</span>,str) ;</span><br><span class="line">         pid = nlh-&gt;nlmsg_pid;</span><br><span class="line">         <span class="keyword">while</span>(i--)</span><br><span class="line">        &#123;<span class="comment">//æˆ‘ä»¬ä½¿ç”¨completionåšå»¶æ—¶ï¼Œæ¯3ç§’é’Ÿå‘ç”¨æˆ·æ€å›å‘ä¸€ä¸ªæ¶ˆæ¯</span></span><br><span class="line">            init_completion(&amp;cmpl);</span><br><span class="line">            wait_for_completion_timeout(&amp;cmpl,<span class="number">3</span> * HZ);</span><br><span class="line">            sendnlmsg(<span class="string">&quot;I am from kernel!&quot;</span>,pid);</span><br><span class="line">        &#125;</span><br><span class="line">         flag = <span class="number">1</span>;</span><br><span class="line">         kfree_skb(skb);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">// Initialize netlink</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">netlink_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    nl_sk = netlink_kernel_create(&amp;init_net, NETLINK_TEST, <span class="number">1</span>,</span><br><span class="line">                                 nl_data_ready, <span class="literal">NULL</span>, THIS_MODULE);</span><br><span class="line">    <span class="keyword">if</span>(!nl_sk)&#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;my_net_link: create netlink socket error.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;my_net_link_4: create netlink socket ok.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">netlink_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(nl_sk != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        sock_release(nl_sk-&gt;sk_socket);</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;my_net_link: self module exited\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">module_init(netlink_init);</span><br><span class="line">module_exit(netlink_exit);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;zhao_h&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct sock *<span class="title">netlink_kernel_create</span><span class="params">(struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="keyword">int</span> unit,<span class="keyword">unsigned</span> <span class="keyword">int</span> groups,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="keyword">void</span> (*input)(struct sk_buff *skb),</span></span></span><br><span class="line"><span class="params"><span class="function">                                   struct mutex *cb_mutex,struct <span class="keyword">module</span> *<span class="keyword">module</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>netï¼šæ˜¯ä¸€ä¸ªç½‘ç»œåå­—ç©ºé—´namespaceï¼Œåœ¨ä¸åŒçš„åå­—ç©ºé—´é‡Œé¢å¯ä»¥æœ‰è‡ªå·±çš„è½¬å‘ä¿¡æ¯åº“ï¼Œæœ‰è‡ªå·±çš„ä¸€å¥—net_deviceç­‰ç­‰ã€‚é»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯ä½¿ç”¨ init_netè¿™ä¸ªå…¨å±€å˜é‡ã€‚</li>
<li>unitï¼šè¡¨ç¤ºnetlinkåè®®ç±»å‹ï¼Œå¦‚NETLINK_TESTã€NETLINK_SELINUXã€‚</li>
<li>groupsï¼šå¤šæ’­åœ°å€ã€‚</li>
<li>inputï¼šä¸ºå†…æ ¸æ¨¡å—å®šä¹‰çš„netlinkæ¶ˆæ¯å¤„ç†å‡½æ•°ï¼Œå½“æœ‰æ¶ˆæ¯åˆ°è¾¾è¿™ä¸ªnetlink socketæ—¶ï¼Œè¯¥inputå‡½æ•°æŒ‡é’ˆå°±ä¼šè¢«å¼•ç”¨ï¼Œä¸”åªæœ‰æ­¤å‡½æ•°è¿”å›æ—¶ï¼Œè°ƒç”¨è€…çš„sendmsgæ‰èƒ½è¿”å›ã€‚</li>
<li>cb_mutexï¼šä¸ºè®¿é—®æ•°æ®æ—¶çš„äº’æ–¥ä¿¡å·é‡ã€‚</li>
<li>moduleï¼š ä¸€èˆ¬ä¸ºTHIS_MODULEã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">netlink_unicast</span><span class="params">(struct sock *ssk, struct sk_buff *skb, u32 pid, <span class="keyword">int</span> nonblock)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>sskï¼šä¸ºå‡½æ•° netlink_kernel_create()è¿”å›çš„socketã€‚</li>
<li>skbï¼šå­˜æ”¾æ¶ˆæ¯ï¼Œå®ƒçš„dataå­—æ®µæŒ‡å‘è¦å‘é€çš„netlinkæ¶ˆæ¯ç»“æ„ï¼Œè€Œ skbçš„æ§åˆ¶å—ä¿å­˜äº†æ¶ˆæ¯çš„åœ°å€ä¿¡æ¯ï¼Œå®NETLINK_CB(skb)å°±ç”¨äºæ–¹ä¾¿è®¾ç½®è¯¥æ§åˆ¶å—ã€‚</li>
<li>pidï¼šä¸ºæ¥æ”¶æ­¤æ¶ˆæ¯è¿›ç¨‹çš„pidï¼Œå³ç›®æ ‡åœ°å€ï¼Œå¦‚æœç›®æ ‡ä¸ºç»„æˆ–å†…æ ¸ï¼Œå®ƒè®¾ç½®ä¸º 0ã€‚</li>
<li>nonblockï¼šè¡¨ç¤ºè¯¥å‡½æ•°æ˜¯å¦ä¸ºéé˜»å¡ï¼Œå¦‚æœä¸º1ï¼Œè¯¥å‡½æ•°å°†åœ¨æ²¡æœ‰æ¥æ”¶ç¼“å­˜å¯åˆ©ç”¨æ—¶ç«‹å³è¿”å›ï¼›è€Œå¦‚æœä¸º0ï¼Œè¯¥å‡½æ•°åœ¨æ²¡æœ‰æ¥æ”¶ç¼“å­˜å¯åˆ©ç”¨å®šæ—¶ç¡çœ ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">netlink_broadcast</span><span class="params">(struct sock *ssk, struct sk_buff *skb, u32 pid, u32 group, <span class="keyword">gfp_t</span> allocation)</span></span>;</span><br></pre></td></tr></table></figure>

<p>å‰é¢çš„ä¸‰ä¸ªå‚æ•°ä¸ netlink_unicastç›¸åŒï¼Œå‚æ•°groupä¸ºæ¥æ”¶æ¶ˆæ¯çš„å¤šæ’­ç»„ï¼Œè¯¥å‚æ•°çš„æ¯ä¸€ä¸ªä½ä»£è¡¨ä¸€ä¸ªå¤šæ’­ç»„ï¼Œå› æ­¤å¦‚æœå‘é€ç»™å¤šä¸ªå¤šæ’­ç»„ï¼Œå°±æŠŠè¯¥å‚æ•°è®¾ç½®ä¸ºå¤šä¸ªå¤šæ’­ç»„ç»„IDçš„ä½æˆ–ã€‚å‚æ•°allocationä¸ºå†…æ ¸å†…å­˜åˆ†é…ç±»å‹ï¼Œä¸€èˆ¬åœ°ä¸ºGFP_ATOMICæˆ–GFP_KERNELï¼ŒGFP_ATOMICç”¨äºåŸå­çš„ä¸Šä¸‹æ–‡ï¼ˆå³ä¸å¯ä»¥ç¡çœ ï¼‰ï¼Œè€ŒGFP_KERNELç”¨äºéåŸå­ä¸Šä¸‹æ–‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">netlink_broadcast</span><span class="params">(struct sock *ssk, struct sk_buff *skb, u32 pid, u32 group, <span class="keyword">gfp_t</span> allocation)</span></span>;</span><br></pre></td></tr></table></figure>

<p>é‡Šæ”¾ netlink socketã€‚</p>
<h2 id="Netlinkå†…æ ¸æ¥æ”¶æ¶ˆæ¯"><a href="#Netlinkå†…æ ¸æ¥æ”¶æ¶ˆæ¯" class="headerlink" title="Netlinkå†…æ ¸æ¥æ”¶æ¶ˆæ¯"></a>Netlinkå†…æ ¸æ¥æ”¶æ¶ˆæ¯</h2><h3 id="Netlinkåˆå§‹åŒ–"><a href="#Netlinkåˆå§‹åŒ–" class="headerlink" title="Netlinkåˆå§‹åŒ–"></a>Netlinkåˆå§‹åŒ–</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __net_init <span class="title">nfnetlink_net_init</span><span class="params">(struct net *net)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nfnl</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_kernel_cfg</span> <span class="title">cfg</span> =</span> &#123;</span><br><span class="line">		.groups	= NFNLGRP_MAX,</span><br><span class="line">		.input	= nfnetlink_rcv,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">		.bind	= nfnetlink_bind,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	nfnl = netlink_kernel_create(net, NETLINK_NETFILTER, &amp;cfg);</span><br><span class="line">	<span class="keyword">if</span> (!nfnl)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	net-&gt;nfnl_stash = nfnl;</span><br><span class="line">	rcu_assign_pointer(net-&gt;nfnl, nfnl);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¸»è¦æ˜¯é€šè¿‡<code>netlink_kernel_create</code>å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªsockï¼ˆä¸Šé¢çš„å†…æ ¸æ€Netlink socket APIç»å‘ç°æ˜¯æ¯”è¾ƒè€çš„å†…æ ¸ç‰ˆæœ¬ï¼Œä¸‹é¢çš„å†…å®¹ä»¥å†…æ ¸5.10ä¸ºä¾‹ï¼Œç›®çš„æ˜¯ä¸ºäº†æ›´è´´åˆåç»­çš„æ¼æ´å¤ç°ï¼‰ï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªsockç»™äº†è¢«åˆå§‹åŒ–çš„netï¼ŒåŒæ—¶è¿˜æ³¨å†Œäº†ä¸€ç»„å›è°ƒå‡½æ•°cfgï¼Œå¯ä»¥çœ‹åˆ°å…¶inputæˆå‘˜å°±æ˜¯<code>nfnetlink_rcv</code>é‚£ä¹ˆåœ¨åç»­å¦‚æœæ”¶åˆ°<code>netlink</code>çš„æ¶ˆæ¯åä¼šè°ƒç”¨è¯¥æˆå‘˜å³<code>nfnetlink_rcv</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *</span></span><br><span class="line"><span class="class">__<span class="title">netlink_kernel_create</span>(<span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>, <span class="title">int</span> <span class="title">unit</span>, <span class="keyword">struct</span> <span class="title">module</span> *<span class="title">module</span>,</span></span><br><span class="line"><span class="class">			<span class="keyword">struct</span> <span class="title">netlink_kernel_cfg</span> *<span class="title">cfg</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">listeners</span> *<span class="title">listeners</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> *<span class="title">cb_mutex</span> =</span> cfg ? cfg-&gt;cb_mutex : <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> groups;</span><br><span class="line"></span><br><span class="line">	BUG_ON(!nl_table);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unit &lt; <span class="number">0</span> || unit &gt;= MAX_LINKS)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sock_create_lite(PF_NETLINK, SOCK_DGRAM, unit, &amp;sock))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (__netlink_create(net, sock, cb_mutex, unit, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_sock_release_nosk;</span><br><span class="line"></span><br><span class="line">	sk = sock-&gt;sk;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!cfg || cfg-&gt;groups &lt; <span class="number">32</span>)</span><br><span class="line">		groups = <span class="number">32</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		groups = cfg-&gt;groups;</span><br><span class="line"></span><br><span class="line">	listeners = kzalloc(<span class="keyword">sizeof</span>(*listeners) + NLGRPSZ(groups), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!listeners)</span><br><span class="line">		<span class="keyword">goto</span> out_sock_release;</span><br><span class="line"></span><br><span class="line">	sk-&gt;sk_data_ready = netlink_data_ready;</span><br><span class="line">	<span class="keyword">if</span> (cfg &amp;&amp; cfg-&gt;input)</span><br><span class="line">		nlk_sk(sk)-&gt;netlink_rcv = cfg-&gt;input;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (netlink_insert(sk, <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">goto</span> out_sock_release;</span><br><span class="line"></span><br><span class="line">	nlk = nlk_sk(sk);</span><br><span class="line">	nlk-&gt;flags |= NETLINK_F_KERNEL_SOCKET;</span><br><span class="line"></span><br><span class="line">	netlink_table_grab();</span><br><span class="line">	<span class="keyword">if</span> (!nl_table[unit].registered) &#123;</span><br><span class="line">		nl_table[unit].groups = groups;</span><br><span class="line">		rcu_assign_pointer(nl_table[unit].listeners, listeners);</span><br><span class="line">		nl_table[unit].cb_mutex = cb_mutex;</span><br><span class="line">		nl_table[unit].<span class="keyword">module</span> = <span class="keyword">module</span>;</span><br><span class="line">		<span class="keyword">if</span> (cfg) &#123;</span><br><span class="line">			nl_table[unit].bind = cfg-&gt;bind;</span><br><span class="line">			nl_table[unit].unbind = cfg-&gt;unbind;</span><br><span class="line">			nl_table[unit].flags = cfg-&gt;flags;</span><br><span class="line">			<span class="keyword">if</span> (cfg-&gt;compare)</span><br><span class="line">				nl_table[unit].compare = cfg-&gt;compare;</span><br><span class="line">		&#125;</span><br><span class="line">		nl_table[unit].registered = <span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree(listeners);</span><br><span class="line">		nl_table[unit].registered++;</span><br><span class="line">	&#125;</span><br><span class="line">	netlink_table_ungrab();</span><br><span class="line">	<span class="keyword">return</span> sk;</span><br><span class="line"></span><br><span class="line">out_sock_release:</span><br><span class="line">	kfree(listeners);</span><br><span class="line">	netlink_kernel_release(sk);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">out_sock_release_nosk:</span><br><span class="line">	sock_release(sock);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__netlink_kernel_create);</span><br><span class="line"></span><br><span class="line">netlink_kernel_create(struct net *net, <span class="keyword">int</span> unit, struct netlink_kernel_cfg *cfg)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> __netlink_kernel_create(net, unit, THIS_MODULE, cfg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨å‰é¢å°†å†…æ ¸socké€šè¿‡<code>nlk_sk</code>ï¼Œå¹¶ä¸ºå…¶æ·»åŠ äº†<code>netlink_rcv</code>æˆå‘˜ä¸º<code>cfg-&gt;input</code>ä¹Ÿå°±æ˜¯æœ€å¼€å§‹çš„<code>nfnetlink_rcv</code>å‡½æ•°ã€‚</p>
<p>è¿™é‡Œæœ€ç»ˆä¼šè°ƒç”¨<code>__netlink_create</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __netlink_create(struct net *net, struct socket *sock,</span><br><span class="line">			    struct mutex *cb_mutex, <span class="keyword">int</span> protocol,</span><br><span class="line">			    <span class="keyword">int</span> kern)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span>;</span></span><br><span class="line"></span><br><span class="line">	sock-&gt;ops = &amp;netlink_ops;</span><br><span class="line"></span><br><span class="line">	sk = sk_alloc(net, PF_NETLINK, GFP_KERNEL, &amp;netlink_proto, kern);</span><br><span class="line">	<span class="keyword">if</span> (!sk)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	sock_init_data(sock, sk);</span><br><span class="line"></span><br><span class="line">	nlk = nlk_sk(sk);</span><br><span class="line">	<span class="keyword">if</span> (cb_mutex) &#123;</span><br><span class="line">		nlk-&gt;cb_mutex = cb_mutex;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		nlk-&gt;cb_mutex = &amp;nlk-&gt;cb_def_mutex;</span><br><span class="line">		mutex_init(nlk-&gt;cb_mutex);</span><br><span class="line">		lockdep_set_class_and_name(nlk-&gt;cb_mutex,</span><br><span class="line">					   nlk_cb_mutex_keys + protocol,</span><br><span class="line">					   nlk_cb_mutex_key_strings[protocol]);</span><br><span class="line">	&#125;</span><br><span class="line">	init_waitqueue_head(&amp;nlk-&gt;wait);</span><br><span class="line"></span><br><span class="line">	sk-&gt;sk_destruct = netlink_sock_destruct;</span><br><span class="line">	sk-&gt;sk_protocol = protocol;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”³è¯·çš„sockçš„opsä¸º<code>netlink_ops</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">netlink_ops</span> =</span> &#123;</span><br><span class="line">	.family =	PF_NETLINK,</span><br><span class="line">	.owner =	THIS_MODULE,</span><br><span class="line">	.release =	netlink_release,</span><br><span class="line">	.bind =		netlink_bind,</span><br><span class="line">	.connect =	netlink_connect,</span><br><span class="line">	.socketpair =	sock_no_socketpair,</span><br><span class="line">	.accept =	sock_no_accept,</span><br><span class="line">	.getname =	netlink_getname,</span><br><span class="line">	.poll =		datagram_poll,</span><br><span class="line">	.ioctl =	netlink_ioctl,</span><br><span class="line">	.listen =	sock_no_listen,</span><br><span class="line">	.shutdown =	sock_no_shutdown,</span><br><span class="line">	.setsockopt =	netlink_setsockopt,</span><br><span class="line">	.getsockopt =	netlink_getsockopt,</span><br><span class="line">	.sendmsg =	netlink_sendmsg,</span><br><span class="line">	.recvmsg =	netlink_recvmsg,</span><br><span class="line">	.mmap =		sock_no_mmap,</span><br><span class="line">	.sendpage =	sock_no_sendpage,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="sockå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ"><a href="#sockå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ" class="headerlink" title="sockå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ"></a>sockå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ</h3><p>å½“ç”¨æˆ·éœ€è¦è¿›è¡Œé…ç½®è§„åˆ™é›†ç­‰æ“ä½œæ—¶ï¼Œå°±éœ€è¦é€šè¿‡netlinkå‘å†…æ ¸å‘èµ·è¯·æ±‚ã€‚ç”±äºæ‰€æœ‰å­ç³»ç»Ÿéƒ½å…±ç”¨ä¸€ä¸ªnfnetlinkï¼Œæ‰€ä»¥åœ¨ä¼ å…¥æ—¶éœ€è¦æŒ‡å®šå­ç³»ç»Ÿçš„idä»¥åŠè¯·æ±‚æ“ä½œçš„idï¼Œåœ¨sockè¿™ä¸€å±‚çš„ä¸»è¦æ“ä½œæ˜¯æ ¹æ®è¿™ä¸¤ä¸ªidé€‰å‡ºå¯¹åº”çš„å‡½æ•°è¿›è¡Œè°ƒç”¨ä»¥åŠæå–å‡ºæ•°æ®ä¼ å…¥è¯¥å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> __sys_sendmsg(<span class="keyword">int</span> fd, struct user_msghdr __user *msg, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span><br><span class="line">		   <span class="keyword">bool</span> forbid_cmsg_compat)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> fput_needed, err;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg_sys</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (forbid_cmsg_compat &amp;&amp; (flags &amp; MSG_CMSG_COMPAT))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);</span><br><span class="line">	<span class="keyword">if</span> (!sock)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	err = ___sys_sendmsg(sock, msg, &amp;msg_sys, flags, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	fput_light(sock-&gt;file, fput_needed);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE3(sendmsg, <span class="keyword">int</span>, fd, struct user_msghdr __user *, msg, <span class="keyword">unsigned</span> <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> __sys_sendmsg(fd, msg, flags, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ç”¨æˆ·æ€æœ€åæ˜¯è°ƒç”¨sendmsgå‘å†…æ ¸ä¼ é€’æ¶ˆæ¯ï¼Œé€™è£ç³»çµ±èª¿ç”¨ç›´æ¥èª¿ç”¨äº†<code>__sys_sendmsg</code>ï¼Œé¦–å…ˆé€šéfdæè¿°ç¬¦ç¶“é<code>sockfd_lookup_light</code>å‡½æ•¸èª¿ç”¨ï¼Œæ‰¾åˆ°å°æ‡‰çš„socketå¥—æ¥å­—çµæ§‹å¯¦ä¾‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct socket *<span class="title">sockfd_lookup_light</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> *err, <span class="keyword">int</span> *fput_needed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span> =</span> fdget(fd);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"></span><br><span class="line">	*err = -EBADF;</span><br><span class="line">	<span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">		sock = sock_from_file(f.file, err);</span><br><span class="line">		<span class="keyword">if</span> (likely(sock)) &#123;</span><br><span class="line">			*fput_needed = f.flags &amp; FDPUT_FPUT;</span><br><span class="line">			<span class="keyword">return</span> sock;</span><br><span class="line">		&#125;</span><br><span class="line">		fdput(f);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç·Šæ¥ç€ç›´æ¥èª¿ç”¨äº†<code>___sys_sendmsg</code>å‡½æ•¸ï¼Œé€™è£çš„ç¬¬ä¸‰å€‹åƒæ•¸<code>msg_sys</code>çµæ§‹é«”åŒç”¨æˆ¶æ…‹ï¼Œéƒ½å«<code>msghdr</code>ä½†æ˜¯å®šç¾©ä¸åŒã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> &#123;</span></span><br><span class="line">	<span class="keyword">void</span>		*msg_name;	<span class="comment">/* ptr to socket address structure */</span></span><br><span class="line">	<span class="keyword">int</span>		msg_namelen;	<span class="comment">/* size of socket address structure */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iov_iter</span>	<span class="title">msg_iter</span>;</span>	<span class="comment">/* data */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ancillary data. msg_control_user is the user buffer used for the</span></span><br><span class="line"><span class="comment">	 * recv* side when msg_control_is_user is set, msg_control is the kernel</span></span><br><span class="line"><span class="comment">	 * buffer used for all other cases.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">void</span>		*msg_control;</span><br><span class="line">		<span class="keyword">void</span> __user	*msg_control_user;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">bool</span>		msg_control_is_user : <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">__kernel_size_t</span>	msg_controllen;	<span class="comment">/* ancillary data buffer length */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>	msg_flags;	<span class="comment">/* flags on received message */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kiocb</span>	*<span class="title">msg_iocb</span>;</span>	<span class="comment">/* ptr to iocb for async requests */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é€™è£æ¯”è¼ƒå¤§çš„å€åˆ¥æ˜¯<code>msg_iter</code>æˆå“¡ï¼Œå…¶çˆ²<code>msg_iov</code>å’Œ<code>msg_iovlen</code>çš„åˆé«”ã€‚ </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ___sys_sendmsg(struct socket *sock, struct user_msghdr __user *msg,</span><br><span class="line">			 struct msghdr *msg_sys, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags,</span><br><span class="line">			 struct used_address *used_address,</span><br><span class="line">			 <span class="keyword">unsigned</span> <span class="keyword">int</span> allowed_msghdr_flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovstack</span>[<span class="title">UIO_FASTIOV</span>], *<span class="title">iov</span> =</span> iovstack;</span><br><span class="line">	<span class="keyword">ssize_t</span> err;</span><br><span class="line"></span><br><span class="line">	msg_sys-&gt;msg_name = &amp;address;</span><br><span class="line"></span><br><span class="line">	err = sendmsg_copy_msghdr(msg_sys, msg, flags, &amp;iov);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	err = ____sys_sendmsg(sock, msg_sys, flags, used_address,</span><br><span class="line">				allowed_msghdr_flags);</span><br><span class="line">	kfree(iov);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå‡½æ•¸å…§éƒ¨å…ˆæ˜¯å®šç¾©äº†ä¸€å€‹<code>iovstack</code>è®Šé‡ï¼Œå…¶ä½œç”¨æ˜¯åŠ é€Ÿç”¨æˆ¶æ•¸æ“šçš„æ‹·è²ï¼Œé€™è£æœƒå‡è¨­ç”¨æˆ¶æ•¸æ“šçš„iovecå€‹æ•¸ä¸æœƒè¶…é<code>UIO_FASTIOV</code>å€‹ï¼Œå¦‚æœè¶…éäº†å‰‡æœƒå»é€šé<code>kmalloc_array</code>å»ç”³è«‹å…§å­˜ã€‚</p>
<p>é€™è£ç¹¼çºŒé—œæ³¨<code>___sys_sendmsg</code>ç¬¬äº”å€‹åƒæ•¸ï¼Œå…¶å®šç¾©çˆ²<code>struct used_address</code>çµæ§‹é«”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">used_address</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">name</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> name_len;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶å…©å€‹å­—æ®µåˆ†åˆ¥ç”¨æ–¼å­˜æ”¾æ¶ˆæ¯çš„åœ°å€ä»¥åŠæ¶ˆæ¯åœ°å€çš„é•·åº¦ã€‚è¯¥ç»“æ„ä½“ä¸»è¦ç”¨ä¸sendmmsgç³»ç»Ÿè°ƒç”¨ï¼ˆç”¨äºåŒæ—¶å‘ä¸€ä¸ªsocketåœ°å€å‘é€å¤šä¸ªæ•°æ®åŒ…ï¼Œå¯ä»¥é¿å…é‡å¤çš„ç½‘ç»œsecurityæ£€æŸ¥ï¼Œä»è€Œæé«˜å‘é€æ•ˆç‡ï¼‰ä¿å­˜å¤šä¸ªæ•°æ®åŒ…çš„ç›®çš„åœ°å€ã€‚ç°åœ¨è¿™é‡Œè®¾ç½®ä¸ºNULLï¼Œè¡¨ç¤ºä¸ä½¿ç”¨ã€‚</p>
<p>å‡½æ•¸å…§é¦–å…ˆèª¿ç”¨<code>sendmsg_copy_msghdr</code>å‡½æ•¸å»å°†ç”¨æˆ·æ€çš„<code>msghdr</code>å†…å®¹copyè‡³å†…æ ¸ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sendmsg_copy_msghdr</span><span class="params">(struct msghdr *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct user_msghdr __user *umsg, <span class="keyword">unsigned</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct iovec **iov)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; MSG_CMSG_COMPAT) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">compat_msghdr</span> __<span class="title">user</span> *<span class="title">msg_compat</span>;</span></span><br><span class="line"></span><br><span class="line">		msg_compat = (struct compat_msghdr __user *) umsg;</span><br><span class="line">		err = get_compat_msghdr(msg, msg_compat, <span class="literal">NULL</span>, iov);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		err = copy_msghdr_from_user(msg, umsg, <span class="literal">NULL</span>, iov);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„flagså¯ä»¥ä»å‰é¢çš„å†…å®¹çœ‹åˆ°æ˜¯ä¸å­˜åœ¨<code>MSG_CMSG_COMPAT</code>æ ‡è¯†ä½çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè¿›å…¥åˆ°<code>copy_msghdr_from_user</code>å‡½æ•°ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">copy_msghdr_from_user</span><span class="params">(struct msghdr *kmsg,</span></span></span><br><span class="line"><span class="params"><span class="function">				 struct user_msghdr __user *umsg,</span></span></span><br><span class="line"><span class="params"><span class="function">				 struct sockaddr __user **save_addr,</span></span></span><br><span class="line"><span class="params"><span class="function">				 struct iovec **iov)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">	<span class="keyword">ssize_t</span> err;</span><br><span class="line"></span><br><span class="line">	err = __copy_msghdr_from_user(kmsg, umsg, save_addr, &amp;msg.msg_iov,</span><br><span class="line">					&amp;msg.msg_iovlen);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	err = import_iovec(save_addr ? READ : WRITE,</span><br><span class="line">			    msg.msg_iov, msg.msg_iovlen,</span><br><span class="line">			    UIO_FASTIOV, iov, &amp;kmsg-&gt;msg_iter);</span><br><span class="line">	<span class="keyword">return</span> err &lt; <span class="number">0</span> ? err : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦åšçš„äº‹æƒ…æœ‰ä¸¤ä»¶ï¼Œé¦–å…ˆé€šè¿‡<code>__copy_msghdr_from_user</code>å‡½æ•°ï¼Œå°†ç”¨æˆ·æ€çš„<code>msghdr</code>å†…å®¹æ‹·è´è‡³å†…æ ¸ä¸­ï¼Œå…¶æ¬¡å°±æ˜¯å°†ç”¨æˆ·æ€çš„iovecæ‹·è´è‡³å†…æ ¸ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __copy_msghdr_from_user(struct msghdr *kmsg,</span><br><span class="line">			    struct user_msghdr __user *umsg,</span><br><span class="line">			    struct sockaddr __user **save_addr,</span><br><span class="line">			    struct iovec __user **uiov, <span class="keyword">size_t</span> *nsegs)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">	<span class="keyword">ssize_t</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(&amp;msg, umsg, <span class="keyword">sizeof</span>(*umsg)))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">	kmsg-&gt;msg_control_is_user = <span class="literal">true</span>;</span><br><span class="line">	kmsg-&gt;msg_control_user = msg.msg_control;</span><br><span class="line">	kmsg-&gt;msg_controllen = msg.msg_controllen;</span><br><span class="line">	kmsg-&gt;msg_flags = msg.msg_flags;</span><br><span class="line"></span><br><span class="line">	kmsg-&gt;msg_namelen = msg.msg_namelen;</span><br><span class="line">	<span class="keyword">if</span> (!msg.msg_name)</span><br><span class="line">		kmsg-&gt;msg_namelen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kmsg-&gt;msg_namelen &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kmsg-&gt;msg_namelen &gt; <span class="keyword">sizeof</span>(struct sockaddr_storage))</span><br><span class="line">		kmsg-&gt;msg_namelen = <span class="keyword">sizeof</span>(struct sockaddr_storage);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (save_addr)</span><br><span class="line">		*save_addr = msg.msg_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msg.msg_name &amp;&amp; kmsg-&gt;msg_namelen) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!save_addr) &#123;</span><br><span class="line">			err = move_addr_to_kernel(msg.msg_name,</span><br><span class="line">						  kmsg-&gt;msg_namelen,</span><br><span class="line">						  kmsg-&gt;msg_name);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kmsg-&gt;msg_name = <span class="literal">NULL</span>;</span><br><span class="line">		kmsg-&gt;msg_namelen = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msg.msg_iovlen &gt; UIO_MAXIOV)</span><br><span class="line">		<span class="keyword">return</span> -EMSGSIZE;</span><br><span class="line"></span><br><span class="line">	kmsg-&gt;msg_iocb = <span class="literal">NULL</span>;</span><br><span class="line">	*uiov = msg.msg_iov;</span><br><span class="line">	*nsegs = msg.msg_iovlen;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>__copy_msghdr_from_user</code>å‡½æ•°å†…éƒ¨å‰é¢éƒ¨åˆ†å°±æ˜¯å¯¹kmsgçš„æˆå‘˜åšèµ‹å€¼ï¼Œéšåè¿›å…¥åˆ°<code>move_addr_to_kernel</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">move_addr_to_kernel</span><span class="params">(<span class="keyword">void</span> __user *uaddr, <span class="keyword">int</span> ulen, struct sockaddr_storage *kaddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (ulen &lt; <span class="number">0</span> || ulen &gt; <span class="keyword">sizeof</span>(struct sockaddr_storage))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (ulen == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(kaddr, uaddr, ulen))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	<span class="keyword">return</span> audit_sockaddr(ulen, kaddr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¹Ÿå°±æ˜¯å°†å†…å®¹å¤åˆ¶åˆ°å†…æ ¸åœ°å€ä¸­ï¼Œè¿™é‡Œçš„å†…æ ¸å¯ä»¥è¿½æº¯åˆ°å¼€å¤´çš„<code>___sys_sendmsg</code>å‡½æ•°ä¸­<code>struct sockaddr_storage address;</code>ä¹Ÿå°±æ˜¯è¿™ä¸ªä½ç½®ï¼Œè€Œè¿™ä¸ªç»“æ„ä½“åœ¨å‰é¢ä¹Ÿæ˜¯ä»‹ç»è¿‡ã€‚</p>
<p>åœ¨<code>__copy_msghdr_from_user</code>å‡½æ•°æœ€ååˆ™æ˜¯å°†iovåœ°å€å’Œä¸ªæ•°å†™åˆ°<code>kmsg</code>ä¸­ï¼Œæ¥ç€è¿”å›å‡½æ•°è°ƒç”¨<code>import_iovec</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct iovec *<span class="title">iovec_from_user</span><span class="params">(<span class="keyword">const</span> struct iovec __user *uvec,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_segs, <span class="keyword">unsigned</span> <span class="keyword">long</span> fast_segs,</span></span></span><br><span class="line"><span class="params"><span class="function">		struct iovec *fast_iov, <span class="keyword">bool</span> compat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">iov</span> =</span> fast_iov;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * SuS says &quot;The readv() function *may* fail if the iovcnt argument was</span></span><br><span class="line"><span class="comment">	 * less than or equal to 0, or greater than &#123;IOV_MAX&#125;.  Linux has</span></span><br><span class="line"><span class="comment">	 * traditionally returned zero for zero segments, so...</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (nr_segs == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> iov;</span><br><span class="line">	<span class="keyword">if</span> (nr_segs &gt; UIO_MAXIOV)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line">	<span class="keyword">if</span> (nr_segs &gt; fast_segs) &#123;</span><br><span class="line">		iov = kmalloc_array(nr_segs, <span class="keyword">sizeof</span>(struct iovec), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!iov)</span><br><span class="line">			<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (compat)</span><br><span class="line">		ret = copy_compat_iovec_from_user(iov, uvec, nr_segs);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ret = copy_iovec_from_user(iov, uvec, nr_segs);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="keyword">if</span> (iov != fast_iov)</span><br><span class="line">			kfree(iov);</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> iov;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> __import_iovec(<span class="keyword">int</span> type, <span class="keyword">const</span> struct iovec __user *uvec,</span><br><span class="line">		 <span class="keyword">unsigned</span> nr_segs, <span class="keyword">unsigned</span> fast_segs, struct iovec **iovp,</span><br><span class="line">		 struct iov_iter *i, <span class="keyword">bool</span> compat)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">ssize_t</span> total_len = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> seg;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">iov</span>;</span></span><br><span class="line"></span><br><span class="line">	iov = iovec_from_user(uvec, nr_segs, fast_segs, *iovp, compat);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(iov)) &#123;</span><br><span class="line">		*iovp = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(iov);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * According to the Single Unix Specification we should return EINVAL if</span></span><br><span class="line"><span class="comment">	 * an element length is &lt; 0 when cast to ssize_t or if the total length</span></span><br><span class="line"><span class="comment">	 * would overflow the ssize_t return value of the system call.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Linux caps all read/write calls to MAX_RW_COUNT, and avoids the</span></span><br><span class="line"><span class="comment">	 * overflow case.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (seg = <span class="number">0</span>; seg &lt; nr_segs; seg++) &#123;</span><br><span class="line">		<span class="keyword">ssize_t</span> len = (<span class="keyword">ssize_t</span>)iov[seg].iov_len;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!access_ok(iov[seg].iov_base, len)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (iov != *iovp)</span><br><span class="line">				kfree(iov);</span><br><span class="line">			*iovp = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (len &gt; MAX_RW_COUNT - total_len) &#123;</span><br><span class="line">			len = MAX_RW_COUNT - total_len;</span><br><span class="line">			iov[seg].iov_len = len;</span><br><span class="line">		&#125;</span><br><span class="line">		total_len += len;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	iov_iter_init(i, type, iov, nr_segs, total_len);</span><br><span class="line">	<span class="keyword">if</span> (iov == *iovp)</span><br><span class="line">		*iovp = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		*iovp = iov;</span><br><span class="line">	<span class="keyword">return</span> total_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">import_iovec</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">const</span> struct iovec __user *uvec,</span></span></span><br><span class="line"><span class="params"><span class="function">		 <span class="keyword">unsigned</span> nr_segs, <span class="keyword">unsigned</span> fast_segs,</span></span></span><br><span class="line"><span class="params"><span class="function">		 struct iovec **iovp, struct iov_iter *i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> __import_iovec(type, uvec, nr_segs, fast_segs, iovp, i,</span><br><span class="line">			      in_compat_syscall());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢åˆ™æ˜¯å¯¹iovçš„åˆå§‹åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ____sys_sendmsg(struct socket *sock, struct msghdr *msg_sys,</span><br><span class="line">			   <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, struct used_address *used_address,</span><br><span class="line">			   <span class="keyword">unsigned</span> <span class="keyword">int</span> allowed_msghdr_flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> ctl[<span class="keyword">sizeof</span>(struct cmsghdr) + <span class="number">20</span>]</span><br><span class="line">				__aligned(<span class="keyword">sizeof</span>(<span class="keyword">__kernel_size_t</span>));</span><br><span class="line">	<span class="comment">/* 20 is size of ipv6_pktinfo */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *ctl_buf = ctl;</span><br><span class="line">	<span class="keyword">int</span> ctl_len;</span><br><span class="line">	<span class="keyword">ssize_t</span> err;</span><br><span class="line"></span><br><span class="line">	err = -ENOBUFS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msg_sys-&gt;msg_controllen &gt; INT_MAX)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	flags |= (msg_sys-&gt;msg_flags &amp; allowed_msghdr_flags);</span><br><span class="line">	ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">	<span class="keyword">if</span> ((MSG_CMSG_COMPAT &amp; flags) &amp;&amp; ctl_len) &#123;</span><br><span class="line">		err =</span><br><span class="line">		    cmsghdr_from_user_compat_to_kern(msg_sys, sock-&gt;sk, ctl,</span><br><span class="line">						     <span class="keyword">sizeof</span>(ctl));</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		ctl_buf = msg_sys-&gt;msg_control;</span><br><span class="line">		ctl_len = msg_sys-&gt;msg_controllen;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctl_len) &#123;</span><br><span class="line">		BUILD_BUG_ON(<span class="keyword">sizeof</span>(struct cmsghdr) !=</span><br><span class="line">			     CMSG_ALIGN(<span class="keyword">sizeof</span>(struct cmsghdr)));</span><br><span class="line">		<span class="keyword">if</span> (ctl_len &gt; <span class="keyword">sizeof</span>(ctl)) &#123;</span><br><span class="line">			ctl_buf = sock_kmalloc(sock-&gt;sk, ctl_len, GFP_KERNEL);</span><br><span class="line">			<span class="keyword">if</span> (ctl_buf == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		err = -EFAULT;</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(ctl_buf, msg_sys-&gt;msg_control_user, ctl_len))</span><br><span class="line">			<span class="keyword">goto</span> out_freectl;</span><br><span class="line">		msg_sys-&gt;msg_control = ctl_buf;</span><br><span class="line">		msg_sys-&gt;msg_control_is_user = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	msg_sys-&gt;msg_flags = flags;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK)</span><br><span class="line">		msg_sys-&gt;msg_flags |= MSG_DONTWAIT;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If this is sendmmsg() and current destination address is same as</span></span><br><span class="line"><span class="comment">	 * previously succeeded address, omit asking LSM&#x27;s decision.</span></span><br><span class="line"><span class="comment">	 * used_address-&gt;name_len is initialized to UINT_MAX so that the first</span></span><br><span class="line"><span class="comment">	 * destination address never matches.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (used_address &amp;&amp; msg_sys-&gt;msg_name &amp;&amp;</span><br><span class="line">	    used_address-&gt;name_len == msg_sys-&gt;msg_namelen &amp;&amp;</span><br><span class="line">	    !<span class="built_in">memcmp</span>(&amp;used_address-&gt;name, msg_sys-&gt;msg_name,</span><br><span class="line">		    used_address-&gt;name_len)) &#123;</span><br><span class="line">		err = sock_sendmsg_nosec(sock, msg_sys);</span><br><span class="line">		<span class="keyword">goto</span> out_freectl;</span><br><span class="line">	&#125;</span><br><span class="line">	err = sock_sendmsg(sock, msg_sys);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If this is sendmmsg() and sending to current destination address was</span></span><br><span class="line"><span class="comment">	 * successful, remember it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (used_address &amp;&amp; err &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		used_address-&gt;name_len = msg_sys-&gt;msg_namelen;</span><br><span class="line">		<span class="keyword">if</span> (msg_sys-&gt;msg_name)</span><br><span class="line">			<span class="built_in">memcpy</span>(&amp;used_address-&gt;name, msg_sys-&gt;msg_name,</span><br><span class="line">			       used_address-&gt;name_len);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out_freectl:</span><br><span class="line">	<span class="keyword">if</span> (ctl_buf != ctl)</span><br><span class="line">		sock_kfree_s(sock-&gt;sk, ctl_buf, ctl_len);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å›åˆ°<code>___sys_sendmsg</code>å‡½æ•°ï¼Œåœ¨æ‰§è¡Œå®Œ<code>sendmsg_copy_msghdr</code>ä¹‹åç´§æ¥ç€ä¼šè°ƒç”¨<code>____sys_sendmsg</code>å‡½æ•°ã€‚</p>
<p>åœ¨å‡½æ•°å‰åŠæ®µä¼šå¯¹flagså’Œ<code>msghdr</code>ç»“æ„ä½“åšå®Œæ£€æµ‹ä¹‹åä¼šæ ¹æ®ä¼ å…¥çš„<code>used_address</code>æŒ‡é’ˆåˆ¤æ–­å½“å‰å‘é€æ¶ˆæ¯çš„ç›®çš„åœ°å€å’Œå®ƒè®°å½•çš„åœ°å€æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™è°ƒç”¨<code>sock_sendmsg_nosec</code>å‡½æ•°ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™è°ƒç”¨<code>sock_sendmsg</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err = security_socket_sendmsg(sock, msg,</span><br><span class="line">					  msg_data_left(msg));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err ?: sock_sendmsg_nosec(sock, msg);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(sock_sendmsg);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçœ‹<code>sock_sendmsg</code>çš„å®šä¹‰å¯ä»¥çœ‹åˆ°æœ€ç»ˆä¹Ÿä¼šè°ƒç”¨<code>sock_sendmsg_nosec</code>å‡½æ•°ï¼ŒåŒºåˆ«å°±æ˜¯å…¶åšäº†å®‰å…¨æ£€æµ‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INDIRECT_CALL_INET(f, f2, f1, ...) f(__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">sock_sendmsg_nosec</span><span class="params">(struct socket *sock, struct msghdr *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = INDIRECT_CALL_INET(sock-&gt;ops-&gt;sendmsg, inet6_sendmsg,</span><br><span class="line">				     inet_sendmsg, sock, msg,</span><br><span class="line">				     msg_data_left(msg));</span><br><span class="line">	BUG_ON(ret == -EIOCBQUEUED);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®å‰é¢æ‰€æåˆ°çš„<code>Netlink</code>åˆå§‹åŒ–ä¸­ï¼Œå¯ä»¥å¾—çŸ¥è¿™é‡Œçš„sendmsgä¸º<code>netlink_sendmsg</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">netlink_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span> =</span> nlk_sk(sk);</span><br><span class="line">	DECLARE_SOCKADDR(struct sockaddr_nl *, addr, msg-&gt;msg_name);</span><br><span class="line">	u32 dst_portid;</span><br><span class="line">	u32 dst_group;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	u32 netlink_skb_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msg-&gt;msg_flags &amp; MSG_OOB)</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">	err = scm_send(sock, msg, &amp;scm, <span class="literal">true</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msg-&gt;msg_namelen) &#123;</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (msg-&gt;msg_namelen &lt; <span class="keyword">sizeof</span>(struct sockaddr_nl))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (addr-&gt;nl_family != AF_NETLINK)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		dst_portid = addr-&gt;nl_pid;</span><br><span class="line">		dst_group = ffs(addr-&gt;nl_groups);</span><br><span class="line">		err =  -EPERM;</span><br><span class="line">		<span class="keyword">if</span> ((dst_group || dst_portid) &amp;&amp;</span><br><span class="line">		    !netlink_allowed(sock, NL_CFG_F_NONROOT_SEND))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		netlink_skb_flags |= NETLINK_SKB_DST;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		dst_portid = nlk-&gt;dst_portid;</span><br><span class="line">		dst_group = nlk-&gt;dst_group;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nlk-&gt;bound) &#123;</span><br><span class="line">		err = netlink_autobind(sock);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Ensure nlk is hashed and visible. */</span></span><br><span class="line">		smp_rmb();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = -EMSGSIZE;</span><br><span class="line">	<span class="keyword">if</span> (len &gt; sk-&gt;sk_sndbuf - <span class="number">32</span>)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	err = -ENOBUFS;</span><br><span class="line">	skb = netlink_alloc_large_skb(len, dst_group);</span><br><span class="line">	<span class="keyword">if</span> (skb == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	NETLINK_CB(skb).portid	= nlk-&gt;portid;</span><br><span class="line">	NETLINK_CB(skb).dst_group = dst_group;</span><br><span class="line">	NETLINK_CB(skb).creds	= scm.creds;</span><br><span class="line">	NETLINK_CB(skb).flags	= netlink_skb_flags;</span><br><span class="line"></span><br><span class="line">	err = -EFAULT;</span><br><span class="line">	<span class="keyword">if</span> (memcpy_from_msg(skb_put(skb, len), msg, len)) &#123;</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_netlink_send(sk, skb);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dst_group) &#123;</span><br><span class="line">		refcount_inc(&amp;skb-&gt;users);</span><br><span class="line">		netlink_broadcast(sk, skb, dst_portid, dst_group, GFP_KERNEL);</span><br><span class="line">	&#125;</span><br><span class="line">	err = netlink_unicast(sk, skb, dst_portid, msg-&gt;msg_flags &amp; MSG_DONTWAIT);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	scm_destroy(&amp;scm);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ª<code>sockaddr_nl</code>ï¼Œå‰é¢çš„ä¸»è¦é€»è¾‘å°±æ˜¯åˆ¤æ–­æ˜¯å¦å¯ä»¥è¿›è¡Œç»„æ’­ä»¥åŠåœ¨åšä¸€äº›éªŒè¯ã€‚</p>
<p>åé¢ä¼šåˆ¤æ–­å‘é€çš„æ•°æ®é•¿åº¦æ˜¯å¦è¿‡é•¿ï¼Œå¹¶ä¸”é€šè¿‡<code>netlink_alloc_large_skb</code>ç”³è¯·ä¸€ä¸ªskbç»“æ„ã€‚åœ¨åˆ›å»ºå®Œæˆskbç»“æ„ä¹‹åå›å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NETLINK_CB(skb)		(*(struct netlink_skb_parms*)&amp;((skb)-&gt;cb))</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨<code>NETLINK_CB</code>å®æ¥æ“ä½œskbä¸­çš„æ‰©å±•cbå­—æ®µï¼Œä¸€å…±48ä¸ªå­—èŠ‚ç”¨äºå­˜æ”¾netlinkçš„åœ°å€å’Œæ ‡è¯†ç›¸å…³çš„å†…å®¹ï¼Œå¹¶å°†netlinkå­—æ®µå¼ºåˆ¶å®šä¹‰ä¸ºäº†<code>netlink_skb_parms</code>ç»“æ„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">netlink_skb_parms</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">scm_creds</span>    <span class="title">creds</span>;</span>        <span class="comment">/* Skb credentials    */</span></span><br><span class="line">    __u32            portid;</span><br><span class="line">    __u32            dst_group;</span><br><span class="line">    __u32            flags;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span>        *<span class="title">sk</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­portidè¡¨ç¤ºåŸç«¯å¥—æ¥å­—æ‰€ç»‘å®šçš„idï¼Œdst_groupè¡¨ç¤ºæ¶ˆæ¯ç›®çš„ç»„æ’­åœ°å€ï¼Œflagä¸ºæ ‡è¯†ï¼ŒskæŒ‡å‘åŸç«¯å¥—æ¥å­—çš„sockç»“æ„ã€‚</p>
<p>è¿™é‡Œé¦–å…ˆå°†å¥—æ¥å­—ç»‘å®šçš„portidèµ‹å€¼åˆ°skbå¾—cbå­—æ®µä¸­ã€åŒæ—¶è®¾ç½®ç»„æ’­åœ°å€çš„æ•°é‡ä»¥åŠnetlink_skbæ ‡è¯†ï¼ˆè¿™é‡Œæ˜¯å·²ç»ç½®ä½NETLINK_SKB_DSTï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">skb_tail_pointer</span><span class="params">(<span class="keyword">const</span> struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> skb-&gt;tail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">memcpy_from_msg</span><span class="params">(<span class="keyword">void</span> *data, struct msghdr *msg, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> copy_from_iter_full(data, len, &amp;msg-&gt;msg_iter) ? <span class="number">0</span> : -EFAULT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥è°ƒç”¨æœ€å…³é”®çš„è°ƒç”¨memcpy_from_msgæ‹·è´æ•°æ®ï¼Œå®ƒé¦–å…ˆè°ƒç”¨skb_putè°ƒæ•´skb-&gt;tailæŒ‡é’ˆï¼Œç„¶åæ‰§è¡Œcopy_from_iter(data, len, &amp;msg-&gt;msg_iter)å°†æ•°æ®ä»msg-&gt;msg_iterä¸­ä¼ è¾“åˆ°skb-&gt;dataä¸­ã€‚</p>
<p>éšåè°ƒç”¨<code>security_netlink_send</code>å‡½æ•°è¿›è¡Œsecurityæ£€æŸ¥ï¼Œæœ€åæ ¹æ®æ˜¯å¦ç»„æ’­è°ƒç”¨<code>netlink_broadcast</code>æˆ–è€…<code>netlink_unicast</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">netlink_unicast</span><span class="params">(struct sock *ssk, struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">		    u32 portid, <span class="keyword">int</span> nonblock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">long</span> timeo;</span><br><span class="line"></span><br><span class="line">	skb = netlink_trim(skb, gfp_any());</span><br><span class="line"></span><br><span class="line">	timeo = sock_sndtimeo(ssk, nonblock);</span><br><span class="line">retry:</span><br><span class="line">	sk = netlink_getsockbyportid(ssk, portid);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(sk)) &#123;</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(sk);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (netlink_is_kernel(sk))</span><br><span class="line">		<span class="keyword">return</span> netlink_unicast_kernel(sk, skb, ssk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sk_filter(sk, skb)) &#123;</span><br><span class="line">		err = skb-&gt;len;</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">		sock_put(sk);</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = netlink_attachskb(sk, skb, &amp;timeo, ssk);</span><br><span class="line">	<span class="keyword">if</span> (err == <span class="number">1</span>)</span><br><span class="line">		<span class="keyword">goto</span> retry;</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> netlink_sendskb(sk, skb);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(netlink_unicast);</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè°ƒç”¨<code>netlink_trim</code>é‡æ–°è£å‰ªskbçš„æ•°æ®åŒºçš„å¤§å°ï¼Œè¿™å¯èƒ½ä¼šcloneå‡ºä¸€ä¸ªæ–°çš„skbç»“æ„åŒæ—¶é‡æ–°åˆ†é…<code>skb-&gt;data</code>çš„å†…å­˜ç©ºé—´ï¼Œå½“ç„¶å¦‚æœåŸæœ¬skbä¸­å¤šä½™çš„å†…å­˜æ•°æ®åŒºéå¸¸å°æˆ–è€…è¯¥å†…å­˜ç©ºé—´æ˜¯åœ¨vmallocç©ºé—´ä¸­çš„å°±ä¸ä¼šæ‰§è¡Œä¸Šè¿°æ“ä½œï¼Œæˆ‘ä»¬ç°åœ¨è·Ÿéšçš„æƒ…æ™¯ä¸Šä¸‹æ–‡ä¸­å°±æ˜¯åä¸€ç§æƒ…å†µï¼Œå¹¶ä¸ä¼šé‡æ–°åˆ†é…ç©ºé—´ã€‚</p>
<p>éšåé€šè¿‡<code>sock_sndtimeo</code>å‡½æ•°è®°ä¸‹å‘é€è¶…æ—¶ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœå·²ç»è®¾ç½®äº†MSG_DONTWAITæ ‡è¯†ï¼Œåˆ™ç­‰å¾…æ—¶é—´ä¸º0ï¼Œå¦åˆ™è¿”å›sk-&gt;sk_sndtimeoã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct sock *<span class="title">netlink_getsockbyportid</span><span class="params">(struct sock *ssk, u32 portid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sock</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span>;</span></span><br><span class="line"></span><br><span class="line">	sock = netlink_lookup(sock_net(ssk), ssk-&gt;sk_protocol, portid);</span><br><span class="line">	<span class="keyword">if</span> (!sock)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ECONNREFUSED);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Don&#x27;t bother queuing skb if kernel socket has no input function */</span></span><br><span class="line">	nlk = nlk_sk(sock);</span><br><span class="line">	<span class="keyword">if</span> (sock-&gt;sk_state == NETLINK_CONNECTED &amp;&amp;</span><br><span class="line">	    nlk-&gt;dst_portid != nlk_sk(ssk)-&gt;portid) &#123;</span><br><span class="line">		sock_put(sock);</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ECONNREFUSED);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥è°ƒç”¨netlink_getsockbyportidæ ¹æ®ç›®çš„portidå·å’ŒåŸç«¯sockç»“æ„æŸ¥æ‰¾ç›®çš„ç«¯çš„sockç»“æ„ã€‚æ¥ä¸‹æ¥è°ƒç”¨<code>netlink_getsockbyportid</code>å‡½æ•°æ ¹æ®ç›®çš„portidå·å’ŒåŸç«¯sockç»“æ„æŸ¥æ‰¾ç›®çš„ç«¯çš„sockç»“æ„ã€‚</p>
<p>åœ¨æ‰¾åˆ°sockç»“æ„ä¹‹åï¼Œé€šè¿‡<code>netlink_is_kernel</code>å‡½æ•°åˆ¤æ–­è¯¥sockæ˜¯å¦ä¸ºå†…æ ¸çš„netlink socketï¼Œå¦‚æœç›®çš„åœ°å€æ˜¯å†…æ ¸ç©ºé—´ï¼Œåˆ™è°ƒç”¨<code>netlink_unicast_kernel</code>å‘å†…æ ¸è¿›è¡Œå•æ’­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">netlink_unicast_kernel</span><span class="params">(struct sock *sk, struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">				  struct sock *ssk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_sock</span> *<span class="title">nlk</span> =</span> nlk_sk(sk);</span><br><span class="line"></span><br><span class="line">	ret = -ECONNREFUSED;</span><br><span class="line">	<span class="keyword">if</span> (nlk-&gt;netlink_rcv != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		ret = skb-&gt;len;</span><br><span class="line">		netlink_skb_set_owner_r(skb, sk);</span><br><span class="line">		NETLINK_CB(skb).sk = ssk;</span><br><span class="line">		netlink_deliver_tap_kernel(sk, ssk, skb);</span><br><span class="line">		nlk-&gt;netlink_rcv(skb);</span><br><span class="line">		consume_skb(skb);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">	&#125;</span><br><span class="line">	sock_put(sk);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æŸ¥ç›®æ ‡netlinkå¥—æ¥å­—æ˜¯å¦æ³¨å†Œäº†netlink_rcv()æ¥æ”¶å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç›´æ¥ä¸¢å¼ƒè¯¥æ•°æ®åŒ…ï¼Œå¦åˆ™ç»§ç»­å‘é€æµç¨‹ã€‚</p>
<p>è¿›å…¥ifåˆ†æ”¯ä¼šå…ˆå¯¹skbè®¾ç½®ä¸€äº›æ ‡è¯†ï¼Œæœ€ç»ˆè°ƒç”¨<code>nlk-&gt;netlink_rcv</code>å‡½æ•°ï¼Œå°†æ¶ˆæ¯é€åˆ°å†…æ ¸ä¸­çš„ç›®çš„netlinkå¥—æ¥å­—ä¸­ï¼Œç»è¿‡å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“çš„æ˜¯è¿™é‡Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>nfnetlink_rcv</code>å‡½æ•°ä¸­ã€‚</p>
<h3 id="netlinkå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ"><a href="#netlinkå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ" class="headerlink" title="netlinkå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ"></a>netlinkå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ</h3><p><strong>ä¸‹é¢çš„æµç¨‹åˆ†æä¼šç»“åˆç€ç”¨æˆ·æ€çš„åŠ¨æ€é“¾æ¥åº“ç»“åˆèµ·æ¥åˆ†æ</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_stable_table_and_set</span><span class="params">(struct mnl_socket* nl, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> * table_name = name;</span><br><span class="line">    <span class="keyword">char</span> * set_name = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> family = NFPROTO_IPV4;</span><br><span class="line">    <span class="keyword">uint32_t</span> set_id = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a table for the sets to be associated with</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nftnl_table</span> * <span class="title">table</span> =</span> nftnl_table_alloc();</span><br><span class="line">    nftnl_table_set_str(table, NFTNL_TABLE_NAME, table_name);</span><br><span class="line">    nftnl_table_set_u32(table, NFTNL_TABLE_FLAGS, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nftnl_set</span> * <span class="title">set_stable</span> =</span>  nftnl_set_alloc();</span><br><span class="line">    set_name = <span class="string">&quot;set_stable&quot;</span>;</span><br><span class="line">    nftnl_set_set_str(set_stable, NFTNL_SET_TABLE, table_name);</span><br><span class="line">    nftnl_set_set_str(set_stable, NFTNL_SET_NAME, set_name);</span><br><span class="line">    nftnl_set_set_u32(set_stable, NFTNL_SET_KEY_LEN, <span class="number">1</span>);</span><br><span class="line">    nftnl_set_set_u32(set_stable, NFTNL_SET_FAMILY, family);</span><br><span class="line">    nftnl_set_set_u32(set_stable, NFTNL_SET_ID, set_id++);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// expressions</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nftnl_expr</span> * <span class="title">exprs</span>[128];</span></span><br><span class="line">    <span class="keyword">int</span> exprid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// serialize</span></span><br><span class="line">    <span class="keyword">char</span> buf[MNL_SOCKET_BUFFER_SIZE*<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mnl_nlmsg_batch</span> * <span class="title">batch</span> =</span> mnl_nlmsg_batch_start(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">int</span> seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    nftnl_batch_begin(mnl_nlmsg_batch_current(batch), seq++);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> * <span class="title">nlh</span>;</span></span><br><span class="line">    <span class="keyword">int</span> table_seq = seq;</span><br><span class="line"></span><br><span class="line">    nlh = nftnl_table_nlmsg_build_hdr(mnl_nlmsg_batch_current(batch),</span><br><span class="line">NFT_MSG_NEWTABLE, family, NLM_F_CREATE|NLM_F_ACK, seq++);</span><br><span class="line">    nftnl_table_nlmsg_build_payload(nlh, table);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add set_stable</span></span><br><span class="line">    nlh = nftnl_set_nlmsg_build_hdr(mnl_nlmsg_batch_current(batch),</span><br><span class="line">                                    NFT_MSG_NEWSET, family,</span><br><span class="line">                                    NLM_F_CREATE|NLM_F_ACK, seq++);</span><br><span class="line">    nftnl_set_nlmsg_build_payload(nlh, set_stable);</span><br><span class="line">    nftnl_set_free(set_stable);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    nftnl_batch_end(mnl_nlmsg_batch_current(batch), seq++);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mnl_socket_open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] setting stable %s and set\n&quot;</span>, table_name);</span><br><span class="line">    <span class="keyword">if</span> (mnl_socket_sendto(nl, mnl_nlmsg_batch_head(batch),</span><br><span class="line">mnl_nlmsg_batch_size(batch)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mnl_socket_send&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç æ˜¯ <a href="https://196082.github.io/2023/09/06/CVE-2022-32250/">CVE-2022-32250å¤ç°</a> æ–‡ç« ä¸­expä»£ç ä¸­å¯¹netlinkå‘é€è¯·æ±‚æ—¶æ‰€ä½¿ç”¨åˆ°çš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nfnetlink_rcv</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> nlmsg_hdr(skb);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;len &lt; NLMSG_HDRLEN ||</span><br><span class="line">	    nlh-&gt;nlmsg_len &lt; NLMSG_HDRLEN ||</span><br><span class="line">	    skb-&gt;len &lt; nlh-&gt;nlmsg_len)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!netlink_net_capable(skb, CAP_NET_ADMIN)) &#123;</span><br><span class="line">		netlink_ack(skb, nlh, -EPERM, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nlh-&gt;nlmsg_type == NFNL_MSG_BATCH_BEGIN)</span><br><span class="line">		nfnetlink_rcv_skb_batch(skb, nlh);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		netlink_rcv_skb(skb, nfnetlink_rcv_msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯åšä¸Šä¸€äº›æ£€æµ‹ï¼Œåœ¨å¼€å¤´æ£€æµ‹é•¿åº¦æ˜¯å¦åˆæ³•ï¼Œéšåæ£€æµ‹æ˜¯å¦å…·æœ‰<code>CAP_NET_ADMIN</code>æƒé™ï¼Œæœ€åä¼šæ ¹æ®<code>nlh-&gt;nlmsg_type</code>ä½¿ç”¨ä¸åŒçš„å‡½æ•°è¿›è¡Œå¤„ç†ã€‚è¿™é‡Œç®€å•è¿½è¸ªä¸€ä¸‹è¿™ä¸ª<code>nlmsg_type</code>çš„ç”±æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXPORT_SYMBOL struct mnl_nlmsg_batch *<span class="title">mnl_nlmsg_batch_start</span><span class="params">(<span class="keyword">void</span> *buf,</span></span></span><br><span class="line"><span class="params"><span class="function">							    <span class="keyword">size_t</span> limit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mnl_nlmsg_batch</span> *<span class="title">b</span>;</span></span><br><span class="line"></span><br><span class="line">	b = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct mnl_nlmsg_batch));</span><br><span class="line">	<span class="keyword">if</span> (b == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	b-&gt;buf = buf;</span><br><span class="line">	b-&gt;limit = limit;</span><br><span class="line">	b-&gt;buflen = <span class="number">0</span>;</span><br><span class="line">	b-&gt;cur = buf;</span><br><span class="line">	b-&gt;overflow = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå‰é¢ä¼šå…ˆé€šè¿‡<code>mnl_nlmsg_batch_start</code>å‡½æ•°ç”³è¯·ä¸€ä¸ªbatchã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mnl_nlmsg_batch</span> &#123;</span></span><br><span class="line">	<span class="comment">/* the buffer that is used to store the batch. */</span></span><br><span class="line">	<span class="keyword">void</span> *buf;</span><br><span class="line">	<span class="keyword">size_t</span> limit;</span><br><span class="line">	<span class="keyword">size_t</span> buflen;</span><br><span class="line">	<span class="comment">/* the current netlink message in the batch. */</span></span><br><span class="line">	<span class="keyword">void</span> *cur;</span><br><span class="line">	<span class="keyword">bool</span> overflow;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">EXPORT_SYMBOL <span class="keyword">void</span> *<span class="title">mnl_nlmsg_batch_current</span><span class="params">(struct mnl_nlmsg_batch *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> b-&gt;cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éšåé€šè¿‡<code>mnl_nlmsg_batch_current</code>å‡½æ•°è¿”å›curç»™<code>nftnl_batch_begin</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nftnl_batch_build_hdr</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">uint16_t</span> type, <span class="keyword">uint32_t</span> seq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfg</span>;</span></span><br><span class="line"></span><br><span class="line">	nlh = mnl_nlmsg_put_header(buf);</span><br><span class="line">	nlh-&gt;nlmsg_type = type;</span><br><span class="line">	nlh-&gt;nlmsg_flags = NLM_F_REQUEST;</span><br><span class="line">	nlh-&gt;nlmsg_seq = seq;</span><br><span class="line"></span><br><span class="line">	nfg = mnl_nlmsg_put_extra_header(nlh, <span class="keyword">sizeof</span>(*nfg));</span><br><span class="line">	nfg-&gt;nfgen_family = AF_UNSPEC;</span><br><span class="line">	nfg-&gt;version = NFNETLINK_V0;</span><br><span class="line">	nfg-&gt;res_id = NFNL_SUBSYS_NFTABLES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nftnl_batch_begin</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">uint32_t</span> seq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	nftnl_batch_build_hdr(buf, NFNL_MSG_BATCH_BEGIN, seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œä¼šå¯¹nlhèµ‹å€¼ä¸º<code>NFNL_MSG_BATCH_BEGIN</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> &#123;</span></span><br><span class="line">	__u32		nlmsg_len;	<span class="comment">/* Length of message including header */</span></span><br><span class="line">	__u16		nlmsg_type;	<span class="comment">/* Message content */</span></span><br><span class="line">	__u16		nlmsg_flags;	<span class="comment">/* Additional flags */</span></span><br><span class="line">	__u32		nlmsg_seq;	<span class="comment">/* Sequence number */</span></span><br><span class="line">	__u32		nlmsg_pid;	<span class="comment">/* Sending process port ID */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>nlmsghdr</code>çš„å®šä¹‰å¦‚ä¸Šã€‚</p>
<p>æ‰€ä»¥æ ¹æ®ç”¨æˆ·æ€ä¼ å…¥ç»™å†…æ ¸çš„nlhæ¥çœ‹ä¼šè¿›å…¥åˆ°<code>nfnetlink_rcv_skb_batch</code>å‡½æ•°ä¸­è¿›è¡Œä¸‹ä¸€æ­¥æµç¨‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nfnetlink_rcv_skb_batch</span><span class="params">(struct sk_buff *skb, struct nlmsghdr *nlh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> min_len = nlmsg_total_size(<span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span> =</span> (<span class="keyword">void</span> *)nlh + min_len;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">cda</span>[<span class="title">NFNL_BATCH_MAX</span> + 1];</span></span><br><span class="line">	<span class="keyword">int</span> attrlen = nlh-&gt;nlmsg_len - min_len;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfgenmsg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> msglen, err;</span><br><span class="line">	u32 gen_id = <span class="number">0</span>;</span><br><span class="line">	u16 res_id;</span><br><span class="line"></span><br><span class="line">	msglen = NLMSG_ALIGN(nlh-&gt;nlmsg_len);</span><br><span class="line">	<span class="keyword">if</span> (msglen &gt; skb-&gt;len)</span><br><span class="line">		msglen = skb-&gt;len;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (skb-&gt;len &lt; NLMSG_HDRLEN + <span class="keyword">sizeof</span>(struct nfgenmsg))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_deprecated(cda, NFNL_BATCH_MAX, attr, attrlen,</span><br><span class="line">				   nfnl_batch_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		netlink_ack(skb, nlh, err, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (cda[NFNL_BATCH_GENID])</span><br><span class="line">		gen_id = ntohl(nla_get_be32(cda[NFNL_BATCH_GENID]));</span><br><span class="line"></span><br><span class="line">	nfgenmsg = nlmsg_data(nlh);</span><br><span class="line">	skb_pull(skb, msglen);</span><br><span class="line">	<span class="comment">/* Work around old nft using host byte order */</span></span><br><span class="line">	<span class="keyword">if</span> (nfgenmsg-&gt;res_id == NFNL_SUBSYS_NFTABLES)</span><br><span class="line">		res_id = NFNL_SUBSYS_NFTABLES;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		res_id = ntohs(nfgenmsg-&gt;res_id);</span><br><span class="line"></span><br><span class="line">	nfnetlink_rcv_batch(skb, nlh, res_id, gen_id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå‰é¢è¿›è¡Œä¸€äº›é¢„å¤„ç†ï¼Œå¯¹å‚æ•°åšæ£€éªŒèµ‹å€¼ç­‰æ“ä½œï¼Œæœ€ååˆ¤æ–­<code>nfgenmsg-&gt;res_id</code>çš„å€¼ã€‚è¿™é‡Œåˆ‡æ¢åˆ°ç”¨æˆ·æ€ç»§ç»­çœ‹<code>nfgenmsg</code>ç»“æ„çš„ç”±æ¥ï¼Œä¸éš¾çœ‹åˆ°åœ¨å‰é¢çš„<code>nftnl_batch_build_hdr</code>å‡½æ•°ä¸­å°±æœ‰å¯¹è¿™ä¸ªç»“æ„ä½“çš„ä½¿ç”¨ï¼Œå¹¶ä¸”æœ€ç»ˆå¯¹å…¶çš„<code>res_id</code>èµ‹å€¼ä¸º<code>NFNL_SUBSYS_NFTABLES</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXPORT_SYMBOL struct nlmsghdr *<span class="title">mnl_nlmsg_put_header</span><span class="params">(<span class="keyword">void</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> len = MNL_ALIGN(<span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> buf;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(buf, <span class="number">0</span>, len);</span><br><span class="line">	nlh-&gt;nlmsg_len = len;</span><br><span class="line">	<span class="keyword">return</span> nlh;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EXPORT_SYMBOL <span class="keyword">void</span> *<span class="title">mnl_nlmsg_put_extra_header</span><span class="params">(struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">					       <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *ptr = (<span class="keyword">char</span> *)nlh + nlh-&gt;nlmsg_len;</span><br><span class="line">	<span class="keyword">size_t</span> len = MNL_ALIGN(size);</span><br><span class="line">	nlh-&gt;nlmsg_len += len;</span><br><span class="line">	<span class="built_in">memset</span>(ptr, <span class="number">0</span>, len);</span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æ ¹æ®è¿™é‡Œæ¥çœ‹ï¼Œ<code>nfgenmsg</code>ç»“æ„ä½“å°±æ˜¯ç´§é‚»ç€<code>nlmsghdr</code>çš„ï¼ˆå…¶å®æ ¹æ®å‰é¢çš„å†…å­˜è¡¨ç°ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œå› ä¸º<code>skb-&gt;data</code>æ˜¯ç›´æ¥ç”±<code>kmsg-&gt;msg_iter</code>æ‹·è´è¿‡å»çš„ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">nlmsg_data</span><span class="params">(<span class="keyword">const</span> struct nlmsghdr *nlh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span> *) nlh + NLMSG_HDRLEN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”å†…æ ¸ä¸­åœ¨è·å–<code>nfgenmsg</code>ç»“æ„ä½“ä¹Ÿæ˜¯ç›´æ¥æ‹¿åˆ°nlhåœ°å€åŠ ä¸Šå…¶å¤§å°çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* No enum here, otherwise __stringify() trick of MODULE_ALIAS_NFNL_SUBSYS()</span></span><br><span class="line"><span class="comment"> * won&#x27;t work anymore */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_NONE 		0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_CTNETLINK		1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_CTNETLINK_EXP	2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_QUEUE		3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_ULOG		4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_OSF			5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_IPSET		6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_ACCT		7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_CTNETLINK_TIMEOUT	8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_CTHELPER		9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_NFTABLES		10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_NFT_COMPAT		11</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_COUNT		12</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯å„ç±»å­ç³»ç»Ÿå®å®šä¹‰çš„å€¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nfnetlink_rcv_batch</span><span class="params">(struct sk_buff *skb, struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">				u16 subsys_id, u32 genid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">oskb</span> =</span> skb;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> sock_net(skb-&gt;sk);</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnetlink_subsystem</span> *<span class="title">ss</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnl_callback</span> *<span class="title">nc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> <span class="title">extack</span>;</span></span><br><span class="line">	LIST_HEAD(err_list);</span><br><span class="line">	u32 status;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (subsys_id &gt;= NFNL_SUBSYS_COUNT)</span><br><span class="line">		<span class="keyword">return</span> netlink_ack(skb, nlh, -EINVAL, <span class="literal">NULL</span>);</span><br><span class="line">replay:</span><br><span class="line">	status = <span class="number">0</span>;</span><br><span class="line">replay_abort:</span><br><span class="line">	skb = netlink_skb_clone(oskb, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!skb)</span><br><span class="line">		<span class="keyword">return</span> netlink_ack(oskb, nlh, -ENOMEM, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	nfnl_lock(subsys_id);</span><br><span class="line">	ss = nfnl_dereference_protected(subsys_id);</span><br><span class="line">	<span class="comment">// ...... check subsystem</span></span><br><span class="line"></span><br><span class="line">	nfnl_unlock(subsys_id);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (skb-&gt;len &gt;= nlmsg_total_size(<span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">int</span> msglen, type;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">memset</span>(&amp;extack, <span class="number">0</span>, <span class="keyword">sizeof</span>(extack));</span><br><span class="line">		nlh = nlmsg_hdr(skb);</span><br><span class="line">		err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_len &lt; NLMSG_HDRLEN ||</span><br><span class="line">		    skb-&gt;len &lt; nlh-&gt;nlmsg_len ||</span><br><span class="line">		    nlmsg_len(nlh) &lt; <span class="keyword">sizeof</span>(struct nfgenmsg)) &#123;</span><br><span class="line">			nfnl_err_reset(&amp;err_list);</span><br><span class="line">			status |= NFNL_BATCH_FAILURE;</span><br><span class="line">			<span class="keyword">goto</span> done;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Only requests are handled by the kernel */</span></span><br><span class="line">		<span class="keyword">if</span> (!(nlh-&gt;nlmsg_flags &amp; NLM_F_REQUEST)) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> ack;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		type = nlh-&gt;nlmsg_type;</span><br><span class="line">		<span class="keyword">if</span> (type == NFNL_MSG_BATCH_BEGIN) &#123;</span><br><span class="line">			<span class="comment">/* Malformed: Batch begin twice */</span></span><br><span class="line">			nfnl_err_reset(&amp;err_list);</span><br><span class="line">			status |= NFNL_BATCH_FAILURE;</span><br><span class="line">			<span class="keyword">goto</span> done;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == NFNL_MSG_BATCH_END) &#123;</span><br><span class="line">			status |= NFNL_BATCH_DONE;</span><br><span class="line">			<span class="keyword">goto</span> done;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type &lt; NLMSG_MIN_TYPE) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> ack;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* We only accept a batch with messages for the same</span></span><br><span class="line"><span class="comment">		 * subsystem.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (NFNL_SUBSYS_ID(type) != subsys_id) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> ack;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		nc = nfnetlink_find_client(type, ss);</span><br><span class="line">		<span class="keyword">if</span> (!nc) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> ack;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">int</span> min_len = nlmsg_total_size(<span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line">			u8 cb_id = NFNL_MSG_TYPE(nlh-&gt;nlmsg_type);</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">cda</span>[<span class="title">NFNL_MAX_ATTR_COUNT</span> + 1];</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span> =</span> (<span class="keyword">void</span> *)nlh + min_len;</span><br><span class="line">			<span class="keyword">int</span> attrlen = nlh-&gt;nlmsg_len - min_len;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Sanity-check NFTA_MAX_ATTR */</span></span><br><span class="line">			<span class="keyword">if</span> (ss-&gt;cb[cb_id].attr_count &gt; NFNL_MAX_ATTR_COUNT) &#123;</span><br><span class="line">				err = -ENOMEM;</span><br><span class="line">				<span class="keyword">goto</span> ack;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			err = nla_parse_deprecated(cda,</span><br><span class="line">						   ss-&gt;cb[cb_id].attr_count,</span><br><span class="line">						   attr, attrlen,</span><br><span class="line">						   ss-&gt;cb[cb_id].policy, <span class="literal">NULL</span>);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">goto</span> ack;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (nc-&gt;call_batch) &#123;</span><br><span class="line">				err = nc-&gt;call_batch(net, net-&gt;nfnl, skb, nlh,</span><br><span class="line">						     (<span class="keyword">const</span> struct nlattr **)cda,</span><br><span class="line">						     &amp;extack);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* The lock was released to autoload some module, we</span></span><br><span class="line"><span class="comment">			 * have to abort and start from scratch using the</span></span><br><span class="line"><span class="comment">			 * original skb.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">				status |= NFNL_BATCH_REPLAY;</span><br><span class="line">				<span class="keyword">goto</span> done;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">ack:</span><br><span class="line">		<span class="comment">// ...... out</span></span><br><span class="line">	&#125;</span><br><span class="line">done:</span><br><span class="line">	<span class="comment">// ...... out</span></span><br><span class="line"></span><br><span class="line">	nfnl_err_deliver(&amp;err_list, oskb);</span><br><span class="line">	kfree_skb(skb);</span><br><span class="line">	module_put(ss-&gt;owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆåˆ¤æ–­<code>subsys_id</code>çš„åˆæ³•æ€§ï¼Œéšåé€šè¿‡<code>nfnl_dereference_protected</code>å‡½æ•°æ‰¾åˆ°å¯¹åº”çš„å­ç³»ç»Ÿã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnetlink_subsystem</span> <span class="title">nf_tables_subsys</span> =</span> &#123;</span><br><span class="line">	.name		= <span class="string">&quot;nf_tables&quot;</span>,</span><br><span class="line">	.subsys_id	= NFNL_SUBSYS_NFTABLES,</span><br><span class="line">	.cb_count	= NFT_MSG_MAX,</span><br><span class="line">	.cb		= nf_tables_cb,</span><br><span class="line">	.commit		= nf_tables_commit,</span><br><span class="line">	.<span class="built_in">abort</span>		= nf_tables_abort,</span><br><span class="line">	.cleanup	= nf_tables_cleanup,</span><br><span class="line">	.valid_genid	= nf_tables_valid_genid,</span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>éšååˆ¤æ–­skbä¸­çš„nlmsgçš„æ•°é‡ï¼Œéšåå¯¹nlhçš„é•¿åº¦åšåˆ¤æ–­ï¼Œå†ç„¶åå¯¹nlhçš„typeåšåˆ¤æ–­ï¼Œå› ä¸ºåœ¨å‰é¢æ‰§è¡Œäº†<code>skb_pull</code>çš„ç¼˜æ•…ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½å†æ˜¯<code>NFNL_MSG_BATCH_BEGIN</code>äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *__skb_pull(struct sk_buff *skb, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span><br><span class="line">&#123;</span><br><span class="line">	skb-&gt;len -= len;</span><br><span class="line">	BUG_ON(skb-&gt;len &lt; skb-&gt;data_len);</span><br><span class="line">	<span class="keyword">return</span> skb-&gt;data += len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">skb_pull_inline</span><span class="params">(struct sk_buff *skb, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> unlikely(len &gt; skb-&gt;len) ? <span class="literal">NULL</span> : __skb_pull(skb, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">skb_pull</span><span class="params">(struct sk_buff *skb, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> skb_pull_inline(skb, len);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(skb_pull);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šè®©dataå¾€åé¢çš„æ•°æ®ç§»åŠ¨ï¼Œæ‰€ä»¥æ‰ä¼šæœ‰è¿™æ ·ä¸€ä¸ªåˆ¤æ–­ã€‚éšåè°ƒç”¨<code>nfnetlink_find_client</code>å‡½æ•°åˆ°æ¶ˆæ¯çš„ç›®æ ‡å¯¹è±¡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> struct nfnl_callback *</span></span><br><span class="line"><span class="function"><span class="title">nfnetlink_find_client</span><span class="params">(u16 type, <span class="keyword">const</span> struct nfnetlink_subsystem *ss)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 cb_id = NFNL_MSG_TYPE(type);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cb_id &gt;= ss-&gt;cb_count)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;ss-&gt;cb[cb_id];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯æ ¹æ®typeå’Œå­ç³»ç»ŸæŸ¥æ‰¾çš„ï¼Œå­ç³»ç»Ÿå·²ç»æ‰¾åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦å…³æ³¨typeæ€ä¹ˆæ¥çš„ã€‚æ¥ä¸‹æ¥å›åˆ°ç”¨æˆ·æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nftnl_table</span> * <span class="title">table</span> =</span> nftnl_table_alloc();</span><br><span class="line">nftnl_table_set_str(table, NFTNL_TABLE_NAME, table_name);</span><br><span class="line">nftnl_table_set_u32(table, NFTNL_TABLE_FLAGS, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line">mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> * <span class="title">nlh</span>;</span></span><br><span class="line"><span class="keyword">int</span> table_seq = seq;</span><br><span class="line">nlh = nftnl_table_nlmsg_build_hdr(mnl_nlmsg_batch_current(batch),</span><br><span class="line">NFT_MSG_NEWTABLE, family, NLM_F_CREATE|NLM_F_ACK, seq++);</span><br><span class="line">nftnl_table_nlmsg_build_payload(nlh, table);</span><br><span class="line"><span class="comment">// ......</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçœ‹å…¶ä¸­ä¸€ä¸ªnlhçš„ç”Ÿæˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXPORT_SYMBOL <span class="keyword">bool</span> <span class="title">mnl_nlmsg_batch_next</span><span class="params">(struct mnl_nlmsg_batch *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> b-&gt;cur;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (b-&gt;buflen + nlh-&gt;nlmsg_len &gt; b-&gt;limit) &#123;</span><br><span class="line">		b-&gt;overflow = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	b-&gt;cur = b-&gt;buf + b-&gt;buflen + nlh-&gt;nlmsg_len;</span><br><span class="line">	b-&gt;buflen += nlh-&gt;nlmsg_len;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ„æ€å°±ä¼šæŠŠcuræŒ‡é’ˆä¸‹ç§»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct nlmsghdr *<span class="title">nftnl_nlmsg_build_hdr</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">uint16_t</span> cmd, <span class="keyword">uint16_t</span> family,</span></span></span><br><span class="line"><span class="params"><span class="function">				     <span class="keyword">uint16_t</span> type, <span class="keyword">uint32_t</span> seq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfh</span>;</span></span><br><span class="line"></span><br><span class="line">	nlh = mnl_nlmsg_put_header(buf);</span><br><span class="line">	nlh-&gt;nlmsg_type = (NFNL_SUBSYS_NFTABLES &lt;&lt; <span class="number">8</span>) | cmd;</span><br><span class="line">	nlh-&gt;nlmsg_flags = NLM_F_REQUEST | type;</span><br><span class="line">	nlh-&gt;nlmsg_seq = seq;</span><br><span class="line"></span><br><span class="line">	nfh = mnl_nlmsg_put_extra_header(nlh, <span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line">	nfh-&gt;nfgen_family = family;</span><br><span class="line">	nfh-&gt;version = NFNETLINK_V0;</span><br><span class="line">	nfh-&gt;res_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nlh;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nftnl_nlmsg_build_hdr);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nftnl_table_nlmsg_build_hdr	nftnl_nlmsg_build_hdr</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¹Ÿå°±ä¼šç”Ÿæˆä¸€ä¸ªnlhå’Œä¸€ä¸ª<code>nfgenmsg</code>ã€‚æ‰€ä»¥ä¹Ÿå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°å…¶typeæ˜¯æœ‰è¿™é‡ŒcmdæŒ‡å®šçš„ï¼Œå¯¹äºè¿™é‡Œæ¥è¯´ä¹Ÿå°±æ˜¯<code>NFT_MSG_NEWTABLE</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnl_callback</span> <span class="title">nf_tables_cb</span>[<span class="title">NFT_MSG_MAX</span>] =</span> &#123;</span><br><span class="line">	[NFT_MSG_NEWTABLE] = &#123;</span><br><span class="line">		.call_batch	= nf_tables_newtable,</span><br><span class="line">		.attr_count	= NFTA_TABLE_MAX,</span><br><span class="line">		.policy		= nft_table_policy,</span><br><span class="line">	&#125;,</span><br><span class="line">	[NFT_MSG_GETTABLE] = &#123;</span><br><span class="line">		.call_rcu	= nf_tables_gettable,</span><br><span class="line">		.attr_count	= NFTA_TABLE_MAX,</span><br><span class="line">		.policy		= nft_table_policy,</span><br><span class="line">	&#125;,</span><br><span class="line">	[NFT_MSG_DELTABLE] = &#123;</span><br><span class="line">		.call_batch	= nf_tables_deltable,</span><br><span class="line">		.attr_count	= NFTA_TABLE_MAX,</span><br><span class="line">		.policy		= nft_table_policy,</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ç›®æ ‡å®¢æˆ·ç«¯å°±å¦‚ä¸Šè¿°å½¢å¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">nf_tables_msg_types</span> &#123;</span></span><br><span class="line">	NFT_MSG_NEWTABLE,</span><br><span class="line">	NFT_MSG_GETTABLE,</span><br><span class="line">	NFT_MSG_DELTABLE,</span><br><span class="line">	NFT_MSG_NEWCHAIN,</span><br><span class="line">	NFT_MSG_GETCHAIN,</span><br><span class="line">	NFT_MSG_DELCHAIN,</span><br><span class="line">	NFT_MSG_NEWRULE,</span><br><span class="line">	NFT_MSG_GETRULE,</span><br><span class="line">	NFT_MSG_DELRULE,</span><br><span class="line">	NFT_MSG_NEWSET,</span><br><span class="line">	NFT_MSG_GETSET,</span><br><span class="line">	NFT_MSG_DELSET,</span><br><span class="line">	NFT_MSG_NEWSETELEM,</span><br><span class="line">	NFT_MSG_GETSETELEM,</span><br><span class="line">	NFT_MSG_DELSETELEM,</span><br><span class="line">	NFT_MSG_NEWGEN,</span><br><span class="line">	NFT_MSG_GETGEN,</span><br><span class="line">	NFT_MSG_TRACE,</span><br><span class="line">	NFT_MSG_NEWOBJ,</span><br><span class="line">	NFT_MSG_GETOBJ,</span><br><span class="line">	NFT_MSG_DELOBJ,</span><br><span class="line">	NFT_MSG_GETOBJ_RESET,</span><br><span class="line">	NFT_MSG_NEWFLOWTABLE,</span><br><span class="line">	NFT_MSG_GETFLOWTABLE,</span><br><span class="line">	NFT_MSG_DELFLOWTABLE,</span><br><span class="line">	NFT_MSG_MAX,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯å…¶æšä¸¾ç±»å‹ã€‚å›åˆ°å†…æ ¸ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nc-&gt;call_batch(net, net-&gt;nfnl, skb, nlh,</span><br><span class="line">               (<span class="keyword">const</span> struct nlattr **)cda,</span><br><span class="line">               &amp;extack);</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆä¼šåœ¨è¿™é‡Œè°ƒç”¨å…¶å›è°ƒå‡½æ•°ã€‚</p>
<h2 id="nftablesç›¸å…³æ“ä½œåŠå†…æ ¸å®ç°"><a href="#nftablesç›¸å…³æ“ä½œåŠå†…æ ¸å®ç°" class="headerlink" title="nftablesç›¸å…³æ“ä½œåŠå†…æ ¸å®ç°"></a>nftablesç›¸å…³æ“ä½œåŠå†…æ ¸å®ç°</h2><h3 id="é…ç½®è¡¨"><a href="#é…ç½®è¡¨" class="headerlink" title="é…ç½®è¡¨"></a>é…ç½®è¡¨</h3><p>åœ¨nftablesä¸­æƒ³è¦é…ç½®è¡¨çš„æ“ä½œå¾ˆç®€å•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nft add table ip filter</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šå‘½ä»¤å³å¯æ·»åŠ ä¸€ä¸ªè¡¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newtable</span><span class="params">(struct net *net, struct sock *nlsk,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfmsg</span> =</span> nlmsg_data(nlh);</span><br><span class="line">	u8 genmask = nft_genmask_next(net);</span><br><span class="line">	<span class="keyword">int</span> family = nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	u32 flags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	lockdep_assert_held(&amp;net-&gt;nft.commit_mutex);</span><br><span class="line">	attr = nla[NFTA_TABLE_NAME];</span><br><span class="line">	table = nft_table_lookup(net, attr, family, genmask);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (PTR_ERR(table) != -ENOENT)</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">		nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, <span class="literal">NULL</span>, nla);</span><br><span class="line">		<span class="keyword">return</span> nf_tables_updtable(&amp;ctx);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_TABLE_FLAGS]) &#123;</span><br><span class="line">		flags = ntohl(nla_get_be32(nla[NFTA_TABLE_FLAGS]));</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; ~NFT_TABLE_F_DORMANT)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = -ENOMEM;</span><br><span class="line">	table = kzalloc(<span class="keyword">sizeof</span>(*table), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (table == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_kzalloc;</span><br><span class="line"></span><br><span class="line">	table-&gt;name = nla_strdup(attr, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (table-&gt;name == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_strdup;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_TABLE_USERDATA]) &#123;</span><br><span class="line">		table-&gt;udata = nla_memdup(nla[NFTA_TABLE_USERDATA], GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (table-&gt;udata == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> err_table_udata;</span><br><span class="line"></span><br><span class="line">		table-&gt;udlen = nla_len(nla[NFTA_TABLE_USERDATA]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = rhltable_init(&amp;table-&gt;chains_ht, &amp;nft_chain_ht_params);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> err_chain_ht;</span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;table-&gt;chains);</span><br><span class="line">	INIT_LIST_HEAD(&amp;table-&gt;sets);</span><br><span class="line">	INIT_LIST_HEAD(&amp;table-&gt;objects);</span><br><span class="line">	INIT_LIST_HEAD(&amp;table-&gt;flowtables);</span><br><span class="line">	table-&gt;family = family;</span><br><span class="line">	table-&gt;flags = flags;</span><br><span class="line">	table-&gt;handle = ++table_handle;</span><br><span class="line"></span><br><span class="line">	nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, <span class="literal">NULL</span>, nla);</span><br><span class="line">	err = nft_trans_table_add(&amp;ctx, NFT_MSG_NEWTABLE);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_trans;</span><br><span class="line"></span><br><span class="line">	list_add_tail_rcu(&amp;table-&gt;<span class="built_in">list</span>, &amp;net-&gt;nft.tables);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// error exit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°é¦–å…ˆä¼šè°ƒç”¨<code>nft_table_lookup</code>å‡½æ•°æ¥æ‰¾å·²å­˜åœ¨çš„è¡¨ï¼Œå…¶å‚æ•°åˆ†åˆ«æœ‰<code>net</code>ã€<code>attr</code>ã€<code>family</code>ã€<code>genmask</code>ã€‚è¿™é‡Œçš„netå°±æ˜¯<code>init_net</code>å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå…¨å±€å˜é‡ã€‚è€Œè¿™é‡Œçš„<code>attr</code>ç”±<code>nla[NFTA_TABLE_NAME]</code>å–å‡ºã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  &lt;------- NLA_HDRLEN ------&gt; &lt;-- NLA_ALIGN(payload)--&gt;</span></span><br><span class="line"><span class="comment"> * +---------------------+- - -+- - - - - - - - - -+- - -+</span></span><br><span class="line"><span class="comment"> * |        Header       | Pad |     Payload       | Pad |</span></span><br><span class="line"><span class="comment"> * |   (struct nlattr)   | ing |                   | ing |</span></span><br><span class="line"><span class="comment"> * +---------------------+- - -+- - - - - - - - - -+- - -+</span></span><br><span class="line"><span class="comment"> *  &lt;-------------- nlattr-&gt;nla_len --------------&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> &#123;</span></span><br><span class="line">	__u16           nla_len;</span><br><span class="line">	__u16           nla_type;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ç¤ºæ„å›¾å¯ä»¥çœ‹å‡ºçš„æ˜¯<code>nalttr</code>ç”±<code>header</code>ã€<code>payload</code>ã€<code>pading</code>ä¸‰éƒ¨åˆ†ç»„æˆï¼Œè¿™é‡Œçš„<code>nlaattr-&gt;nla_len</code>è¡¨ç¤ºçš„é•¿åº¦ä¸ºæ€»é•¿åº¦ï¼Œå¹¶ä¸”åœ¨ç»“æ„ä½“ä¸­æ˜¯çœ‹ä¸åˆ°æœ‰ä»€ä¹ˆæˆå‘˜è¡¨ç¤º<code>payload</code>éƒ¨åˆ†çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">err = nla_parse_deprecated(cda,</span><br><span class="line">						   ss-&gt;cb[cb_id].attr_count,</span><br><span class="line">						   attr, attrlen,</span><br><span class="line">						   ss-&gt;cb[cb_id].policy, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹è°ƒç”¨å…³ç³»å¯ä»¥å¾ˆæ¸…æ¥šå‘ç°nlaç”±å¤–å±‚å‡½æ•°<code>nfnetlink_rcv_batch</code>ä¸­çš„ä¸Šè¿°å‡½æ•°å¾—æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __nla_parse(struct nlattr **tb, <span class="keyword">int</span> maxtype,</span><br><span class="line">		<span class="keyword">const</span> struct nlattr *head, <span class="keyword">int</span> len,</span><br><span class="line">		<span class="keyword">const</span> struct nla_policy *policy, <span class="keyword">unsigned</span> <span class="keyword">int</span> validate,</span><br><span class="line">		struct netlink_ext_ack *extack)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> __nla_validate_parse(head, len, maxtype, policy, validate,</span><br><span class="line">				    extack, tb, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__nla_parse);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">nla_parse_deprecated</span><span class="params">(struct nlattr **tb, <span class="keyword">int</span> maxtype,</span></span></span><br><span class="line"><span class="params"><span class="function">				       <span class="keyword">const</span> struct nlattr *head, <span class="keyword">int</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">				       <span class="keyword">const</span> struct nla_policy *policy,</span></span></span><br><span class="line"><span class="params"><span class="function">				       struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> __nla_parse(tb, maxtype, head, len, policy,</span><br><span class="line">			   NL_VALIDATE_LIBERAL, extack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __nla_validate_parse(<span class="keyword">const</span> struct nlattr *head, <span class="keyword">int</span> len, <span class="keyword">int</span> maxtype,</span><br><span class="line">				<span class="keyword">const</span> struct nla_policy *policy,</span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">int</span> validate,</span><br><span class="line">				struct netlink_ext_ack *extack,</span><br><span class="line">				struct nlattr **tb, <span class="keyword">unsigned</span> <span class="keyword">int</span> depth)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nla</span>;</span></span><br><span class="line">	<span class="keyword">int</span> rem;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (depth &gt;= MAX_POLICY_RECURSION_DEPTH) &#123;</span><br><span class="line">		NL_SET_ERR_MSG(extack,</span><br><span class="line">			       <span class="string">&quot;allowed policy recursion depth exceeded&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tb)</span><br><span class="line">		<span class="built_in">memset</span>(tb, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct nlattr *) * (maxtype + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">	nla_for_each_attr(nla, head, len, rem) &#123;</span><br><span class="line">		u16 type = nla_type(nla);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (type == <span class="number">0</span> || type &gt; maxtype) &#123;</span><br><span class="line">			<span class="keyword">if</span> (validate &amp; NL_VALIDATE_MAXTYPE) &#123;</span><br><span class="line">				NL_SET_ERR_MSG_ATTR(extack, nla,</span><br><span class="line">						    <span class="string">&quot;Unknown attribute type&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> -EINVAL;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (policy) &#123;</span><br><span class="line">			<span class="keyword">int</span> err = validate_nla(nla, maxtype, policy,</span><br><span class="line">					       validate, extack, depth);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> err;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (tb)</span><br><span class="line">			tb[type] = (struct nlattr *)nla;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(rem &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">		pr_warn_ratelimited(<span class="string">&quot;netlink: %d bytes leftover after parsing attributes in process `%s&#x27;.\n&quot;</span>,</span><br><span class="line">				    rem, current-&gt;comm);</span><br><span class="line">		NL_SET_ERR_MSG(extack, <span class="string">&quot;bytes leftover after parsing attributes&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (validate &amp; NL_VALIDATE_TRAILING)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†æå‘ç°æœ€ç»ˆå¾—åˆ°çš„nlaä¹Ÿå°±æ˜¯ç”±<code>attr</code>ç»è¿‡æ£€éªŒäº†åˆæ³•æ€§ä¹‹åå¾—åˆ°çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> min_len = nlmsg_total_size(<span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span> =</span> (<span class="keyword">void</span> *)nlh + min_len;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æœ€ç»ˆå¯ä»¥å¾—çŸ¥ï¼Œå…¶å®æ‹¿åˆ°çš„å°±æ˜¯payloadæ®µï¼Œé‚£ä¹ˆç°åœ¨å›åˆ°ç”¨æˆ·æ€æ¥æŸ¥çœ‹è¿™ç©¶ç«Ÿæ˜¯æ€ä¹ˆæ¥çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nftnl_table_nlmsg_build_payload(nlh, table);</span><br></pre></td></tr></table></figure>

<p>ä¸éš¾çœ‹åˆ°åœ¨ç”¨æˆ·æ€ä»£ç ä¸­å­˜åœ¨è¿™æ ·ä¸€æ¡è¯­å¥ï¼Œæ¥å¯¹nlhçš„payloadæ®µè¿›è¡Œè®¾ç½®ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nftnl_set_nlmsg_build_payload</span><span class="params">(struct nlmsghdr *nlh, struct nftnl_set *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_TABLE))</span><br><span class="line">		mnl_attr_put_strz(nlh, NFTA_SET_TABLE, s-&gt;table);</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_NAME))</span><br><span class="line">		mnl_attr_put_strz(nlh, NFTA_SET_NAME, s-&gt;name);</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_FLAGS))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_FLAGS, htonl(s-&gt;set_flags));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_KEY_TYPE))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_KEY_TYPE, htonl(s-&gt;key_type));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_KEY_LEN))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_KEY_LEN, htonl(s-&gt;key_len));</span><br><span class="line">	<span class="comment">/* These are only used to map matching -&gt; action (1:1) */</span></span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_DATA_TYPE))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_DATA_TYPE, htonl(s-&gt;data_type));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_DATA_LEN))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_DATA_LEN, htonl(s-&gt;data_len));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_OBJ_TYPE))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_OBJ_TYPE, htonl(s-&gt;obj_type));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_ID))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_ID, htonl(s-&gt;id));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_POLICY))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_POLICY, htonl(s-&gt;policy));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_DESC_SIZE))</span><br><span class="line">		nftnl_set_nlmsg_build_desc_payload(nlh, s);</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_TIMEOUT))</span><br><span class="line">		mnl_attr_put_u64(nlh, NFTA_SET_TIMEOUT, htobe64(s-&gt;timeout));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_GC_INTERVAL))</span><br><span class="line">		mnl_attr_put_u32(nlh, NFTA_SET_GC_INTERVAL, htonl(s-&gt;gc_interval));</span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_SET_USERDATA))</span><br><span class="line">		mnl_attr_put(nlh, NFTA_SET_USERDATA, s-&gt;user.len, s-&gt;user.data);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nftnl_set_nlmsg_build_payload);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®ä¸åŒçš„<code>s-&gt;flags</code>æ¥è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œè¿™é‡Œå…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªsæ˜¯æ€ä¹ˆæ¥çš„å§ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nftnl_table</span> * <span class="title">table</span> =</span> nftnl_table_alloc();</span><br><span class="line">nftnl_table_set_str(table, NFTNL_TABLE_NAME, table_name);</span><br><span class="line">nftnl_table_set_u32(table, NFTNL_TABLE_FLAGS, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„så°±æ˜¯åœ¨è¿™é‡Œåˆ›å»ºçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nftnl_table_set_data</span><span class="params">(struct nftnl_table *t, <span class="keyword">uint16_t</span> attr,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">uint32_t</span> data_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	nftnl_assert_attr_exists(attr, NFTNL_TABLE_MAX);</span><br><span class="line">	nftnl_assert_validate(data, nftnl_table_validate, attr, data_len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (attr) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFTNL_TABLE_NAME:</span><br><span class="line">		<span class="keyword">if</span> (t-&gt;flags &amp; (<span class="number">1</span> &lt;&lt; NFTNL_TABLE_NAME))</span><br><span class="line">			xfree(t-&gt;name);</span><br><span class="line"></span><br><span class="line">		t-&gt;name = strdup(data);</span><br><span class="line">		<span class="keyword">if</span> (!t-&gt;name)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFTNL_TABLE_FLAGS:</span><br><span class="line">		t-&gt;table_flags = *((<span class="keyword">uint32_t</span> *)data);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFTNL_TABLE_FAMILY:</span><br><span class="line">		t-&gt;family = *((<span class="keyword">uint32_t</span> *)data);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFTNL_TABLE_USE:</span><br><span class="line">		t-&gt;use = *((<span class="keyword">uint32_t</span> *)data);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	t-&gt;flags |= (<span class="number">1</span> &lt;&lt; attr);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nftnl_table_set_data);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nftnl_table_set_str</span><span class="params">(struct nftnl_table *t, <span class="keyword">uint16_t</span> attr, <span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> nftnl_table_set_data(t, attr, str, <span class="built_in">strlen</span>(str) + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nftnl_table_set_str);</span><br></pre></td></tr></table></figure>

<p>ä»¥è®¾ç½®strä¸ºä¾‹ï¼ˆå…¶å®è®¾ç½®å…¶ä»–çš„ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼‰ï¼Œæœ€ç»ˆä¼šè°ƒç”¨çš„<code>nftnl_table_set_data</code>å‡½æ•°ï¼Œå‡½æ•°å†…éƒ¨å®ç°çš„å°±æ˜¯æ ¹æ®ä¸åŒçš„å±æ€§è¿›è¡Œä¸åŒçš„æ“ä½œæœ€ç»ˆç»™<code>struct nftnl_table</code>ç»“æ„ä½“è®¾ç½®ä¸Šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">nftnl_table_attr</span> &#123;</span></span><br><span class="line">	NFTNL_TABLE_NAME	= <span class="number">0</span>,</span><br><span class="line">	NFTNL_TABLE_FAMILY,</span><br><span class="line">	NFTNL_TABLE_FLAGS,</span><br><span class="line">	NFTNL_TABLE_USE,</span><br><span class="line">	__NFTNL_TABLE_MAX</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">nftnl_set_attr</span> &#123;</span></span><br><span class="line">	NFTNL_SET_TABLE,</span><br><span class="line">	NFTNL_SET_NAME,</span><br><span class="line">	NFTNL_SET_FLAGS,</span><br><span class="line">	NFTNL_SET_KEY_TYPE,</span><br><span class="line">	NFTNL_SET_KEY_LEN,</span><br><span class="line">	NFTNL_SET_DATA_TYPE,</span><br><span class="line">	NFTNL_SET_DATA_LEN,</span><br><span class="line">	NFTNL_SET_FAMILY,</span><br><span class="line">	NFTNL_SET_ID,</span><br><span class="line">	NFTNL_SET_POLICY,</span><br><span class="line">	NFTNL_SET_DESC_SIZE,</span><br><span class="line">	NFTNL_SET_TIMEOUT,</span><br><span class="line">	NFTNL_SET_GC_INTERVAL,</span><br><span class="line">	NFTNL_SET_USERDATA,</span><br><span class="line">	NFTNL_SET_OBJ_TYPE,</span><br><span class="line">	__NFTNL_SET_MAX</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå›åˆ°<code>nftnl_set_nlmsg_build_payload</code>å‡½æ•°ä¸­ï¼Œæ ¹æ®è¿™é‡Œçš„å®šä¹‰æœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>mnl_attr_put_strz</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXPORT_SYMBOL <span class="keyword">void</span> <span class="title">mnl_attr_put</span><span class="params">(struct nlmsghdr *nlh, <span class="keyword">uint16_t</span> type,</span></span></span><br><span class="line"><span class="params"><span class="function">								<span class="keyword">size_t</span> len, <span class="keyword">const</span> <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span> =</span> mnl_nlmsg_get_payload_tail(nlh);</span><br><span class="line">	<span class="keyword">uint16_t</span> payload_len = MNL_ALIGN(<span class="keyword">sizeof</span>(struct nlattr)) + len;</span><br><span class="line">	<span class="keyword">int</span> pad;</span><br><span class="line"></span><br><span class="line">	attr-&gt;nla_type = type;</span><br><span class="line">	attr-&gt;nla_len = payload_len;</span><br><span class="line">	<span class="built_in">memcpy</span>(mnl_attr_get_payload(attr), data, len);</span><br><span class="line">	pad = MNL_ALIGN(len) - len;</span><br><span class="line">	<span class="keyword">if</span> (pad &gt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">memset</span>(mnl_attr_get_payload(attr) + len, <span class="number">0</span>, pad);</span><br><span class="line"></span><br><span class="line">	nlh-&gt;nlmsg_len += MNL_ALIGN(payload_len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">EXPORT_SYMBOL <span class="keyword">void</span> <span class="title">mnl_attr_put_strz</span><span class="params">(struct nlmsghdr *nlh, <span class="keyword">uint16_t</span> type,</span></span></span><br><span class="line"><span class="params"><span class="function">									 <span class="keyword">const</span> <span class="keyword">char</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mnl_attr_put(nlh, type, <span class="built_in">strlen</span>(data) + <span class="number">1</span>, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå³å¯çœ‹åˆ°attrç”±<code>mnl_nlmsg_get_payload_tail</code>å‡½æ•°å¾—åˆ°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXPORT_SYMBOL <span class="keyword">void</span> *<span class="title">mnl_nlmsg_get_payload_tail</span><span class="params">(<span class="keyword">const</span> struct nlmsghdr *nlh)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)nlh + MNL_ALIGN(nlh-&gt;nlmsg_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ˜¯å–å‡º<code>nlh</code>å¤´éƒ¨ä¹‹åçš„<code>payload</code>éƒ¨åˆ†ã€‚</p>
<p>è€Œåœ¨è¿›è¡Œmemcpyæ—¶è°ƒç”¨çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXPORT_SYMBOL <span class="keyword">void</span> *<span class="title">mnl_attr_get_payload</span><span class="params">(<span class="keyword">const</span> struct nlattr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)attr + MNL_ATTR_HDRLEN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ˜¯å–å‡º<code>nlattr</code>çš„å¤´éƒ¨ä¹‹åpayloadï¼Œæ‰€ä»¥è¿™é‡Œç›´è§‚æ¥çœ‹æœ‰ä¸¤å±‚payloadéƒ¨åˆ†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct nft_table *<span class="title">nft_table_lookup</span><span class="params">(<span class="keyword">const</span> struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">					  <span class="keyword">const</span> struct nlattr *nla,</span></span></span><br><span class="line"><span class="params"><span class="function">					  u8 family, u8 genmask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	list_for_each_entry_rcu(table, &amp;net-&gt;nft.tables, <span class="built_in">list</span>,</span><br><span class="line">				lockdep_is_held(&amp;net-&gt;nft.commit_mutex)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!nla_strcmp(nla, table-&gt;name) &amp;&amp;</span><br><span class="line">		    table-&gt;family == family &amp;&amp;</span><br><span class="line">		    nft_active_genmask(table, genmask))</span><br><span class="line">			<span class="keyword">return</span> table;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå›åˆ°å†…æ ¸æ€ï¼Œè¿™é‡Œçš„nlaå°±æ˜¯ç±»ä¼¼å¦‚ä¸‹ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">my_nlattr</span> &#123;</span></span><br><span class="line">  __u16           nla_len;</span><br><span class="line">	__u16           nla_type;</span><br><span class="line">  <span class="keyword">auto</span> 						data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>éšåè¿™é‡Œä¼šæ ¹æ®<code>family</code>ã€<code>name</code>ä»¥åŠ<code>genmask</code>æ¥åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿåœ¨netä¸­æ‰¾åˆ°tableï¼Œå¦‚æœèƒ½å¤Ÿæ‰¾åˆ°tableï¼Œé‚£è¯æ˜å·²ç»å­˜åœ¨è¿™ä¸ªtableäº†ï¼Œé‚£ä¹ˆè¦åšçš„å°±æ˜¯æ›´æ–°è¡¨ï¼Œè¿™é‡Œæµ…æµ…è¯´ä¸€ä¸‹æ›´æ–°çš„æµç¨‹ä»¥åŠç›®çš„æ˜¯ä»€ä¹ˆå§ã€‚</p>
<p>åœ¨<code>nfnetlink_rev_batch</code>å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°çš„æ˜¯åœ¨æœ€åçš„doneåˆ†æ”¯ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (status &amp; NFNL_BATCH_REPLAY) &#123;</span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == NFNL_BATCH_DONE) &#123;</span><br><span class="line">		err = ss-&gt;commit(net, oskb);</span><br><span class="line">		<span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">			status |= NFNL_BATCH_REPLAY;</span><br><span class="line">			<span class="keyword">goto</span> done;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (err) &#123;</span><br><span class="line">			ss-&gt;<span class="built_in">abort</span>(net, oskb, NFNL_ABORT_NONE);</span><br><span class="line">			netlink_ack(oskb, nlmsg_hdr(oskb), err, <span class="literal">NULL</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (ss-&gt;cleanup)</span><br><span class="line">		ss-&gt;cleanup(net);</span><br><span class="line"></span><br><span class="line">	nfnl_err_deliver(&amp;err_list, oskb);</span><br><span class="line">	kfree_skb(skb);</span><br><span class="line">	module_put(ss-&gt;owner);</span><br></pre></td></tr></table></figure>

<p>ä¼šæ ¹æ®ä¸åŒçš„statusæ¥è¿›å…¥åˆ°ä¸åŒçš„åˆ†æ”¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nftnl_batch_end</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">uint32_t</span> seq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	nftnl_batch_build_hdr(buf, NFNL_MSG_BATCH_END, seq);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nftnl_batch_end);</span><br></pre></td></tr></table></figure>

<p>å¯¹äºæˆ‘ä»¬æ¥è¯´æ­£å¸¸ç»“æŸçš„æ—¶å€™ä¼šå¯¹åŠ ä¸Š<code>NFNL_MSG_BATCH_END</code>æ ‡è¯†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type = nlh-&gt;nlmsg_type;</span><br><span class="line"><span class="keyword">if</span> (type == NFNL_MSG_BATCH_BEGIN) &#123;</span><br><span class="line">  <span class="comment">/* Malformed: Batch begin twice */</span></span><br><span class="line">  nfnl_err_reset(&amp;err_list);</span><br><span class="line">  status |= NFNL_BATCH_FAILURE;</span><br><span class="line">  <span class="keyword">goto</span> done;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == NFNL_MSG_BATCH_END) &#123;</span><br><span class="line">  status |= NFNL_BATCH_DONE;</span><br><span class="line">  <span class="keyword">goto</span> done;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type &lt; NLMSG_MIN_TYPE) &#123;</span><br><span class="line">  err = -EINVAL;</span><br><span class="line">  <span class="keyword">goto</span> ack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>nfnetlink_rev_batch</code>å‡½æ•°ä¸­ä¼šæ ¹æ®ä¸åŒçš„typeä¿®æ”¹è°ƒstatusï¼Œæ‰€ä»¥æ­£å¸¸ç»“æŸæ—¶ä¼šè¿›å…¥åˆ°<code>status == NFNL_BATCH_DONE</code>åˆ†æ”¯ä¸­ï¼Œå¹¶æ‰§è¡Œ<code>ss-&gt;commit</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_commit</span><span class="params">(struct net *net, struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>, *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans_elem</span> *<span class="title">te</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (list_empty(&amp;net-&gt;nft.commit_list)) &#123;</span><br><span class="line">		mutex_unlock(&amp;net-&gt;nft.commit_mutex);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 0. Validate ruleset, otherwise roll back for error reporting. */</span></span><br><span class="line">	<span class="keyword">if</span> (nf_tables_validate(net) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">	err = nft_flow_rule_offload_commit(net);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 1.  Allocate space for next generation rules_gen_X[] */</span></span><br><span class="line">	list_for_each_entry_safe (trans, next, &amp;net-&gt;nft.commit_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (trans-&gt;msg_type == NFT_MSG_NEWRULE ||</span><br><span class="line">		    trans-&gt;msg_type == NFT_MSG_DELRULE) &#123;</span><br><span class="line">			chain = trans-&gt;ctx.chain;</span><br><span class="line"></span><br><span class="line">			ret = nf_tables_commit_chain_prepare(net, chain);</span><br><span class="line">			<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				nf_tables_commit_chain_prepare_cancel(net);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* step 2.  Make rules_gen_X visible to packet path */</span></span><br><span class="line">	list_for_each_entry (table, &amp;net-&gt;nft.tables, <span class="built_in">list</span>) &#123;</span><br><span class="line">		list_for_each_entry (chain, &amp;table-&gt;chains, <span class="built_in">list</span>)</span><br><span class="line">			nf_tables_commit_chain(net, chain);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Bump generation counter, invalidate any dump in progress.</span></span><br><span class="line"><span class="comment">	 * Cannot fail after this point.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">while</span> (++net-&gt;nft.base_seq == <span class="number">0</span>)</span><br><span class="line">		;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* step 3. Start new generation, rules_gen_X now in use. */</span></span><br><span class="line">	net-&gt;nft.gencursor = nft_gencursor_next(net);</span><br><span class="line"></span><br><span class="line">	list_for_each_entry_safe (trans, next, &amp;net-&gt;nft.commit_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (trans-&gt;msg_type) &#123;</span><br><span class="line">		<span class="keyword">case</span> NFT_MSG_NEWTABLE:</span><br><span class="line">			<span class="keyword">if</span> (nft_trans_table_update(trans)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!nft_trans_table_enable(trans)) &#123;</span><br><span class="line">					nf_tables_table_disable(</span><br><span class="line">						net, trans-&gt;ctx.table);</span><br><span class="line">					trans-&gt;ctx.table-&gt;flags |=</span><br><span class="line">						NFT_TABLE_F_DORMANT;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				nft_clear(net, trans-&gt;ctx.table);</span><br><span class="line">			&#125;</span><br><span class="line">			nf_tables_table_notify(&amp;trans-&gt;ctx, NFT_MSG_NEWTABLE);</span><br><span class="line">			nft_trans_destroy(trans);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> NFT_MSG_DELTABLE:</span><br><span class="line">			<span class="comment">// ......</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nft_commit_notify(net, NETLINK_CB(skb).portid);</span><br><span class="line">	nf_tables_gen_notify(net, skb, NFT_MSG_NEWGEN);</span><br><span class="line">	nf_tables_commit_release(net);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿™é‡Œä¼šå¯¹<code>net-&gt;nft.commit_list</code>å­˜åœ¨å‡ æ¬¡éå†ï¼Œä¸»è¦çœ‹åé¢ä¼šå¯¹å½“å‰<code>trans</code>æ‰€å±äºçš„æ“ä½œè¿›è¡Œå¤„ç†ï¼Œå½“å‰çš„æ“ä½œä¹Ÿå°±æ˜¯<code>NFT_MSG_NEW_TABLE</code>æ“ä½œï¼Œä¼šåˆ¤æ–­å½“å‰<code>trans</code>æ˜¯å¦æ›´æ–°ï¼Œä»¥åŠå½“å‰è¡¨æ˜¯å¦<code>enable</code>ï¼Œå¦‚æœæ˜¯æœªå¯ç”¨çŠ¶æ€åˆ™ä¼šè¿›å…¥åˆ°<code>nf_tables_table_disable</code>å‡½æ•°ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_table_disable</span><span class="params">(struct net *net, struct nft_table *table, u32 cnt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	u32 i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	list_for_each_entry (chain, &amp;table-&gt;chains, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!nft_is_active_next(net, chain))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (!nft_is_base_chain(chain))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cnt &amp;&amp; i++ == cnt)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		nf_tables_unregister_hook(net, table, chain);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nf_tables_table_disable</span><span class="params">(struct net *net, struct nft_table *table)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	nft_table_disable(net, table, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šå°†æ‰€æœ‰æœªæ¿€æ´»çš„å¹¶ä¸”ä¸ºéå¸¸è§„çš„è¯¥è¡¨ä¸‹æ‰€æœ‰é“¾è„±ç¦»hookï¼ˆå³æ— æ³•åœ¨è§¦å‘ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">trans-&gt;ctx.table-&gt;flags |=</span><br><span class="line">						NFT_TABLE_F_DORMANT;</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”æœ€åç»™è¯¥tableæ ‡è®°ä¸ºä¼‘çœ çŠ¶æ€ã€‚ä¸‹é¢å›åˆ°<code>nf_tables_newtable</code>å‡½æ•°ä¸­ï¼Œè¿™é‡Œæ›´æ–°å¤„ç†çš„ç¬¬ä¸€æ­¥å°±æ˜¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_ctx_init</span><span class="params">(struct nft_ctx *ctx, struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">const</span> struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">			 u8 family, struct nft_table *table,</span></span></span><br><span class="line"><span class="params"><span class="function">			 struct nft_chain *chain,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">const</span> struct nlattr *<span class="keyword">const</span> *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ctx-&gt;net = net;</span><br><span class="line">	ctx-&gt;family = family;</span><br><span class="line">	ctx-&gt;level = <span class="number">0</span>;</span><br><span class="line">	ctx-&gt;table = table;</span><br><span class="line">	ctx-&gt;chain = chain;</span><br><span class="line">	ctx-&gt;nla = nla;</span><br><span class="line">	ctx-&gt;portid = NETLINK_CB(skb).portid;</span><br><span class="line">	ctx-&gt;report = nlmsg_report(nlh);</span><br><span class="line">	ctx-&gt;flags = nlh-&gt;nlmsg_flags;</span><br><span class="line">	ctx-&gt;seq = nlh-&gt;nlmsg_seq;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨<code>nft_ctx_init</code>å‡½æ•°å°†æ‰€æœ‰å†…å®¹èµ‹å€¼åˆ°<code>ctx</code>ä¸­å»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_updtable</span><span class="params">(struct nft_ctx *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	u32 flags;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ctx-&gt;nla[NFTA_TABLE_FLAGS])</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	flags = ntohl(nla_get_be32(ctx-&gt;nla[NFTA_TABLE_FLAGS]));</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~NFT_TABLE_F_DORMANT)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags == ctx-&gt;table-&gt;flags)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	trans = nft_trans_alloc(ctx, NFT_MSG_NEWTABLE,</span><br><span class="line">				<span class="keyword">sizeof</span>(struct nft_trans_table));</span><br><span class="line">	<span class="keyword">if</span> (trans == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((flags &amp; NFT_TABLE_F_DORMANT) &amp;&amp;</span><br><span class="line">	    !(ctx-&gt;table-&gt;flags &amp; NFT_TABLE_F_DORMANT)) &#123;</span><br><span class="line">		nft_trans_table_enable(trans) = <span class="literal">false</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(flags &amp; NFT_TABLE_F_DORMANT) &amp;&amp;</span><br><span class="line">		   ctx-&gt;table-&gt;flags &amp; NFT_TABLE_F_DORMANT) &#123;</span><br><span class="line">		ctx-&gt;table-&gt;flags &amp;= ~NFT_TABLE_F_DORMANT;</span><br><span class="line">		ret = nf_tables_table_enable(ctx-&gt;net, ctx-&gt;table);</span><br><span class="line">		<span class="keyword">if</span> (ret &gt;= <span class="number">0</span>)</span><br><span class="line">			nft_trans_table_enable(trans) = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			ctx-&gt;table-&gt;flags |= NFT_TABLE_F_DORMANT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	nft_trans_table_update(trans) = <span class="literal">true</span>;</span><br><span class="line">	list_add_tail(&amp;trans-&gt;<span class="built_in">list</span>, &amp;ctx-&gt;net-&gt;nft.commit_list);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">	nft_trans_destroy(trans);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éšåè°ƒç”¨<code>nf_tables_updtable</code>å‡½æ•°ï¼Œé€šè¿‡åˆ¤æ–­ç”¨æˆ·æ€ä¼ å…¥çš„flagså’Œå†…æ ¸tableæ‰€æœ‰ç”¨çš„flagsæ¥åˆ¤æ–­æ˜¯å¦è®©è¯¥tableä¼‘çœ æˆ–æ˜¯å¯ç”¨ã€‚</p>
<p>æ¥ç€å›åˆ°<code>nf_tables_newtable</code>å‡½æ•°æµç¨‹ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„tableï¼Œå°±æ˜¯é€šè¿‡<code>kzalloc</code>ç”³è¯·tableéšåå¯¹å…¶è¿›è¡Œæˆå‘˜åˆå§‹åŒ–ï¼Œå¹¶ä¸”åˆå§‹åŒ–å®ƒçš„é“¾çš„å“ˆå¸Œè¡¨<code>chains_ht</code>ï¼Œæœ€åæ·»åŠ åˆ°<code>net-&gt;nft.tables</code>ä¸­å³å¯ã€‚</p>
<h3 id="é…ç½®é“¾"><a href="#é…ç½®é“¾" class="headerlink" title="é…ç½®é“¾"></a>é…ç½®é“¾</h3><p>æœ‰äº†å‰é¢é…ç½®è¡¨çš„åŸºç¡€ï¼Œå†æ¥çœ‹é…ç½®é“¾ä¼šç›¸å¯¹ç®€å•è®¸å¤š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newchain</span><span class="params">(struct net *net, struct sock *nlsk,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nlattr *<span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfmsg</span> =</span> nlmsg_data(nlh);</span><br><span class="line">	u8 genmask = nft_genmask_next(net);</span><br><span class="line">	<span class="keyword">int</span> family = nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	u8 policy = NF_ACCEPT;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	u64 handle = <span class="number">0</span>;</span><br><span class="line">	u32 flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	lockdep_assert_held(&amp;net-&gt;nft.commit_mutex);</span><br><span class="line"></span><br><span class="line">	table = nft_table_lookup(net, nla[NFTA_CHAIN_TABLE], family, genmask);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_TABLE]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	chain = <span class="literal">NULL</span>;</span><br><span class="line">	attr = nla[NFTA_CHAIN_NAME];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_HANDLE]) &#123;</span><br><span class="line">		handle = be64_to_cpu(nla_get_be64(nla[NFTA_CHAIN_HANDLE]));</span><br><span class="line">		chain = nft_chain_lookup_byhandle(table, handle, genmask);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_HANDLE]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">		&#125;</span><br><span class="line">		attr = nla[NFTA_CHAIN_HANDLE];</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nla[NFTA_CHAIN_NAME]) &#123;</span><br><span class="line">		chain = nft_chain_lookup(net, table, attr, genmask);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (PTR_ERR(chain) != -ENOENT) &#123;</span><br><span class="line">				NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">			&#125;</span><br><span class="line">			chain = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!nla[NFTA_CHAIN_ID]) &#123;</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_POLICY]) &#123;</span><br><span class="line">		<span class="keyword">if</span> (chain != <span class="literal">NULL</span> &amp;&amp; !nft_is_base_chain(chain)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_POLICY]);</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (chain == <span class="literal">NULL</span> &amp;&amp; nla[NFTA_CHAIN_HOOK] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_POLICY]);</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		policy = ntohl(nla_get_be32(nla[NFTA_CHAIN_POLICY]));</span><br><span class="line">		<span class="keyword">switch</span> (policy) &#123;</span><br><span class="line">		<span class="keyword">case</span> NF_DROP:</span><br><span class="line">		<span class="keyword">case</span> NF_ACCEPT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_FLAGS])</span><br><span class="line">		flags = ntohl(nla_get_be32(nla[NFTA_CHAIN_FLAGS]));</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (chain)</span><br><span class="line">		flags = chain-&gt;flags;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~NFT_CHAIN_FLAGS)</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">	nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, chain, nla);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chain != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">		flags |= chain-&gt;flags &amp; NFT_CHAIN_BASE;</span><br><span class="line">		<span class="keyword">return</span> nf_tables_updchain(&amp;ctx, genmask, policy, flags, attr,</span><br><span class="line">					  extack);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nf_tables_addchain(&amp;ctx, family, genmask, policy, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆé€šè¿‡<code>nft_table_lookup</code>å‡½æ•°æ¥æ‰¾åˆ°tableï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥é€€å‡ºã€‚</p>
<p>éšåå­˜åœ¨ä¸¤ç§æ–¹å¼æ¥æ‰¾åˆ°chainï¼Œç¬¬ä¸€ç§æ˜¯ç›´æ¥é€šè¿‡handleæ¥è¿›è¡Œå¯¹æ¯”æ‰¾åˆ°ï¼Œç¬¬äºŒç§åˆ™æ˜¯é€šè¿‡åå­—åœ¨tableçš„å“ˆå¸Œè¡¨ä¸­æ‰¾åˆ°ã€‚</p>
<p>åœ¨æ‰¾åˆ°ä¹‹ååŸºæœ¬å°±æ˜¯é“¾å’Œå‚æ•°åšåˆ¤æ–­ï¼Œä»¥åŠå¯¹å¸¸è§„é“¾çš„ä¸€ç³»åˆ—å¤„ç†ã€‚</p>
<p>æœ€ç»ˆåœ¨<code>nf_tables_addchain</code>å‡½æ•°æ·»åŠ <code>chain</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_addchain</span><span class="params">(struct nft_ctx *ctx, u8 family, u8 genmask,</span></span></span><br><span class="line"><span class="params"><span class="function">			      u8 policy, u32 flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">const</span> *<span class="title">nla</span> =</span> ctx-&gt;nla;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span> =</span> ctx-&gt;table;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_base_chain</span> *<span class="title">basechain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_stats</span> __<span class="title">percpu</span> *<span class="title">stats</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> ctx-&gt;net;</span><br><span class="line">	<span class="keyword">char</span> name[NFT_NAME_MAXLEN];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule</span> **<span class="title">rules</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (table-&gt;use == UINT_MAX)</span><br><span class="line">		<span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_HOOK]) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain_hook</span> <span class="title">hook</span>;</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; NFT_CHAIN_BINDING)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">		err = nft_chain_parse_hook(net, nla, &amp;hook, family, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		basechain = kzalloc(<span class="keyword">sizeof</span>(*basechain), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (basechain == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			nft_chain_release_hook(&amp;hook);</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">		chain = &amp;basechain-&gt;chain;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nla[NFTA_CHAIN_COUNTERS]) &#123;</span><br><span class="line">			stats = nft_stats_alloc(nla[NFTA_CHAIN_COUNTERS]);</span><br><span class="line">			<span class="keyword">if</span> (IS_ERR(stats)) &#123;</span><br><span class="line">				nft_chain_release_hook(&amp;hook);</span><br><span class="line">				kfree(basechain);</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(stats);</span><br><span class="line">			&#125;</span><br><span class="line">			rcu_assign_pointer(basechain-&gt;stats, stats);</span><br><span class="line">			static_branch_inc(&amp;nft_counters_enabled);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = nft_basechain_init(basechain, family, &amp;hook, flags);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			nft_chain_release_hook(&amp;hook);</span><br><span class="line">			kfree(basechain);</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; NFT_CHAIN_BASE)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; NFT_CHAIN_HW_OFFLOAD)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">		chain = kzalloc(<span class="keyword">sizeof</span>(*chain), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (chain == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">		chain-&gt;flags = flags;</span><br><span class="line">	&#125;</span><br><span class="line">	ctx-&gt;chain = chain;</span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;chain-&gt;rules);</span><br><span class="line">	chain-&gt;handle = nf_tables_alloc_handle(table);</span><br><span class="line">	chain-&gt;table = table;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_NAME]) &#123;</span><br><span class="line">		chain-&gt;name = nla_strdup(nla[NFTA_CHAIN_NAME], GFP_KERNEL);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; NFT_CHAIN_BINDING)) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			<span class="keyword">goto</span> err_destroy_chain;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">snprintf</span>(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;__chain%llu&quot;</span>, ++chain_id);</span><br><span class="line">		chain-&gt;name = kstrdup(name, GFP_KERNEL);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!chain-&gt;name) &#123;</span><br><span class="line">		err = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err_destroy_chain;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_USERDATA]) &#123;</span><br><span class="line">		chain-&gt;udata = nla_memdup(nla[NFTA_CHAIN_USERDATA], GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (chain-&gt;udata == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			err = -ENOMEM;</span><br><span class="line">			<span class="keyword">goto</span> err_destroy_chain;</span><br><span class="line">		&#125;</span><br><span class="line">		chain-&gt;udlen = nla_len(nla[NFTA_CHAIN_USERDATA]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rules = nf_tables_chain_alloc_rules(chain, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (!rules) &#123;</span><br><span class="line">		err = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err_destroy_chain;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*rules = <span class="literal">NULL</span>;</span><br><span class="line">	rcu_assign_pointer(chain-&gt;rules_gen_0, rules);</span><br><span class="line">	rcu_assign_pointer(chain-&gt;rules_gen_1, rules);</span><br><span class="line"></span><br><span class="line">	err = nf_tables_register_hook(net, table, chain);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_destroy_chain;</span><br><span class="line"></span><br><span class="line">	trans = nft_trans_chain_add(ctx, NFT_MSG_NEWCHAIN);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(trans)) &#123;</span><br><span class="line">		err = PTR_ERR(trans);</span><br><span class="line">		<span class="keyword">goto</span> err_unregister_hook;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nft_trans_chain_policy(trans) = NFT_CHAIN_POLICY_UNSET;</span><br><span class="line">	<span class="keyword">if</span> (nft_is_base_chain(chain))</span><br><span class="line">		nft_trans_chain_policy(trans) = policy;</span><br><span class="line"></span><br><span class="line">	err = nft_chain_add(table, chain);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		nft_trans_destroy(trans);</span><br><span class="line">		<span class="keyword">goto</span> err_unregister_hook;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	table-&gt;use++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err_unregister_hook:</span><br><span class="line">	nf_tables_unregister_hook(net, table, chain);</span><br><span class="line">err_destroy_chain:</span><br><span class="line">	nf_tables_chain_destroy(ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦é€šè¿‡ç”¨æˆ·æ€æ˜¯å¦ä¼ é€’hookæ¥åˆ†ä¸¤ç§æƒ…å†µæ¥åˆ†åˆ«åˆ›å»ºåŸºæœ¬é“¾å’Œå¸¸è§„é“¾ã€‚</p>
<p>åç»­åˆ™æ˜¯å¯¹å…¶è¿›è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–åŒ…æ‹¬ç”Ÿæˆruleså †å—ã€‚</p>
<h3 id="é…ç½®è§„åˆ™"><a href="#é…ç½®è§„åˆ™" class="headerlink" title="é…ç½®è§„åˆ™"></a>é…ç½®è§„åˆ™</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newrule</span><span class="params">(struct net *net, struct sock *nlsk,</span></span></span><br><span class="line"><span class="params"><span class="function">			     struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">			     struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfmsg</span> =</span> nlmsg_data(nlh);</span><br><span class="line">	u8 genmask = nft_genmask_next(net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_info</span> *<span class="title">info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> family = nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_flow_rule</span> *<span class="title">flow</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule</span> *<span class="title">rule</span>, *<span class="title">old_rule</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_userdata</span> *<span class="title">udata</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tmp</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size, i, n, ulen = <span class="number">0</span>, usize = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> err, rem;</span><br><span class="line">	u64 handle, pos_handle;</span><br><span class="line"></span><br><span class="line">	lockdep_assert_held(&amp;net-&gt;nft.commit_mutex);</span><br><span class="line"></span><br><span class="line">	table = nft_table_lookup(net, nla[NFTA_RULE_TABLE], family, genmask);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_TABLE]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_RULE_CHAIN]) &#123;</span><br><span class="line">		chain = nft_chain_lookup(net, table, nla[NFTA_RULE_CHAIN],</span><br><span class="line">					 genmask);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_CHAIN]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (nft_chain_is_bound(chain))</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nla[NFTA_RULE_CHAIN_ID]) &#123;</span><br><span class="line">		chain = nft_chain_lookup_byid(net, nla[NFTA_RULE_CHAIN_ID]);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_CHAIN_ID]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_RULE_HANDLE]) &#123;</span><br><span class="line">		handle = be64_to_cpu(nla_get_be64(nla[NFTA_RULE_HANDLE]));</span><br><span class="line">		rule = __nft_rule_lookup(chain, handle);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(rule)) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_HANDLE]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(rule);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_HANDLE]);</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			old_rule = rule;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(nlh-&gt;nlmsg_flags &amp; NLM_F_CREATE) ||</span><br><span class="line">		    nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		handle = nf_tables_alloc_handle(table);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (chain-&gt;use == UINT_MAX)</span><br><span class="line">			<span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nla[NFTA_RULE_POSITION]) &#123;</span><br><span class="line">			pos_handle = be64_to_cpu(nla_get_be64(nla[NFTA_RULE_POSITION]));</span><br><span class="line">			old_rule = __nft_rule_lookup(chain, pos_handle);</span><br><span class="line">			<span class="keyword">if</span> (IS_ERR(old_rule)) &#123;</span><br><span class="line">				NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_POSITION]);</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(old_rule);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nla[NFTA_RULE_POSITION_ID]) &#123;</span><br><span class="line">			old_rule = nft_rule_lookup_byid(net, nla[NFTA_RULE_POSITION_ID]);</span><br><span class="line">			<span class="keyword">if</span> (IS_ERR(old_rule)) &#123;</span><br><span class="line">				NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_POSITION_ID]);</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(old_rule);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, chain, nla);</span><br><span class="line"></span><br><span class="line">	n = <span class="number">0</span>;</span><br><span class="line">	size = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_RULE_EXPRESSIONS]) &#123;</span><br><span class="line">		info = kvmalloc_array(NFT_RULE_MAXEXPRS,</span><br><span class="line">				      <span class="keyword">sizeof</span>(struct nft_expr_info),</span><br><span class="line">				      GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!info)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">		nla_for_each_nested(tmp, nla[NFTA_RULE_EXPRESSIONS], rem) &#123;</span><br><span class="line">			err = -EINVAL;</span><br><span class="line">			<span class="keyword">if</span> (nla_type(tmp) != NFTA_LIST_ELEM)</span><br><span class="line">				<span class="keyword">goto</span> err1;</span><br><span class="line">			<span class="keyword">if</span> (n == NFT_RULE_MAXEXPRS)</span><br><span class="line">				<span class="keyword">goto</span> err1;</span><br><span class="line">			err = nf_tables_expr_parse(&amp;ctx, tmp, &amp;info[n]);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">goto</span> err1;</span><br><span class="line">			size += info[n].ops-&gt;size;</span><br><span class="line">			n++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* Check for overflow of dlen field */</span></span><br><span class="line">	err = -EFBIG;</span><br><span class="line">	<span class="keyword">if</span> (size &gt;= <span class="number">1</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line">		<span class="keyword">goto</span> err1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_RULE_USERDATA]) &#123;</span><br><span class="line">		ulen = nla_len(nla[NFTA_RULE_USERDATA]);</span><br><span class="line">		<span class="keyword">if</span> (ulen &gt; <span class="number">0</span>)</span><br><span class="line">			usize = <span class="keyword">sizeof</span>(struct nft_userdata) + ulen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = -ENOMEM;</span><br><span class="line">	rule = kzalloc(<span class="keyword">sizeof</span>(*rule) + size + usize, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (rule == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err1;</span><br><span class="line"></span><br><span class="line">	nft_activate_next(net, rule);</span><br><span class="line"></span><br><span class="line">	rule-&gt;handle = handle;</span><br><span class="line">	rule-&gt;dlen   = size;</span><br><span class="line">	rule-&gt;udata  = ulen ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ulen) &#123;</span><br><span class="line">		udata = nft_userdata(rule);</span><br><span class="line">		udata-&gt;len = ulen - <span class="number">1</span>;</span><br><span class="line">		nla_memcpy(udata-&gt;data, nla[NFTA_RULE_USERDATA], ulen);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    expr = nft_expr_first(rule);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		err = nf_tables_newexpr(&amp;ctx, &amp;info[i], expr);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, info[i].attr);</span><br><span class="line">			<span class="keyword">goto</span> err2;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (info[i].ops-&gt;validate)</span><br><span class="line">			nft_validate_state_update(net, NFT_VALIDATE_NEED);</span><br><span class="line"></span><br><span class="line">		info[i].ops = <span class="literal">NULL</span>;</span><br><span class="line">		expr = nft_expr_next(expr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE) &#123;</span><br><span class="line">		trans = nft_trans_rule_add(&amp;ctx, NFT_MSG_NEWRULE, rule);</span><br><span class="line">		<span class="keyword">if</span> (trans == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			err = -ENOMEM;</span><br><span class="line">			<span class="keyword">goto</span> err2;</span><br><span class="line">		&#125;</span><br><span class="line">		err = nft_delrule(&amp;ctx, old_rule);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			nft_trans_destroy(trans);</span><br><span class="line">			<span class="keyword">goto</span> err2;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		trans = nft_trans_rule_add(&amp;ctx, NFT_MSG_NEWRULE, rule);</span><br><span class="line">		<span class="keyword">if</span> (!trans) &#123;</span><br><span class="line">			err = -ENOMEM;</span><br><span class="line">			<span class="keyword">goto</span> err2;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_APPEND) &#123;</span><br><span class="line">			<span class="keyword">if</span> (old_rule)</span><br><span class="line">				list_add_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;chain-&gt;rules);</span><br><span class="line">		 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (old_rule)</span><br><span class="line">				list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				list_add_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;chain-&gt;rules);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	kvfree(info);</span><br><span class="line">	chain-&gt;use++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (net-&gt;nft.validate_state == NFT_VALIDATE_DO)</span><br><span class="line">		<span class="keyword">return</span> nft_table_validate(net, table);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chain-&gt;flags &amp; NFT_CHAIN_HW_OFFLOAD) &#123;</span><br><span class="line">		flow = nft_flow_rule_create(net, rule);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(flow))</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(flow);</span><br><span class="line"></span><br><span class="line">		nft_trans_flow_rule(trans) = flow;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err2:</span><br><span class="line">	nf_tables_rule_release(&amp;ctx, rule);</span><br><span class="line">err1:</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (info[i].ops) &#123;</span><br><span class="line">			module_put(info[i].ops-&gt;type-&gt;owner);</span><br><span class="line">			<span class="keyword">if</span> (info[i].ops-&gt;type-&gt;release_ops)</span><br><span class="line">				info[i].ops-&gt;type-&gt;release_ops(info[i].ops);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	kvfree(info);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>nft_ctx_init</code>å‡½æ•°è°ƒç”¨å¾€å‰ä¸»è¦åšçš„æ˜¯æ‰¾åˆ°å·²å­˜åœ¨çš„tableå’Œchainä»¥åŠrule</p>
<p>åœ¨<code>nft_ctx_init</code>å‡½æ•°è°ƒåä¹‹åä¼šæ ¹æ®ç”¨æˆ·æ€æ˜¯å¦è®¾ç½®äº†<code>nla[NFTA_RULE_EXPRESSIONS]</code>æ¥é€‰æ‹©æ˜¯å¦ç»™sizeåŠ ä¸Šæ‰€æœ‰expressionçš„sizeï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°çš„æ˜¯å¯¹sizeåšè¿ç®—çš„æ˜¯<code>info[n].ops-&gt;size</code>ï¼Œæ‰€ä»¥è¿™é‡Œåˆ†æä¸€ä¸‹infoçš„æ¥æºã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_expr_parse</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">const</span> struct nlattr *nla,</span></span></span><br><span class="line"><span class="params"><span class="function">				struct nft_expr_info *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">type</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">NFTA_EXPR_MAX</span> + 1];</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(tb, NFTA_EXPR_MAX, nla,</span><br><span class="line">					  nft_expr_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	type = nft_expr_type_get(ctx-&gt;net, ctx-&gt;family, tb[NFTA_EXPR_NAME]);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(type))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(type);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tb[NFTA_EXPR_DATA]) &#123;</span><br><span class="line">		err = nla_parse_nested_deprecated(info-&gt;tb, type-&gt;maxattr,</span><br><span class="line">						  tb[NFTA_EXPR_DATA],</span><br><span class="line">						  type-&gt;policy, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> err1;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		<span class="built_in">memset</span>(info-&gt;tb, <span class="number">0</span>, <span class="keyword">sizeof</span>(info-&gt;tb[<span class="number">0</span>]) * (type-&gt;maxattr + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (type-&gt;select_ops != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		ops = type-&gt;select_ops(ctx,</span><br><span class="line">				       (<span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> *)info-&gt;tb);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(ops)) &#123;</span><br><span class="line">			err = PTR_ERR(ops);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">			<span class="keyword">if</span> (err == -EAGAIN)</span><br><span class="line">				<span class="keyword">if</span> (nft_expr_type_request_module(ctx-&gt;net,</span><br><span class="line">								 ctx-&gt;family,</span><br><span class="line">								 tb[NFTA_EXPR_NAME]) != -EAGAIN)</span><br><span class="line">					err = -ENOENT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">goto</span> err1;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		ops = type-&gt;ops;</span><br><span class="line"></span><br><span class="line">	info-&gt;attr = nla;</span><br><span class="line">	info-&gt;ops = ops;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err1:</span><br><span class="line">	module_put(type-&gt;owner);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯<code>info-&gt;ops</code>æ‰€èµ‹å€¼çš„opsæ˜¯ç”±typeæ‰€å†³å®šçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> struct nft_expr_type *<span class="title">nft_expr_type_get</span><span class="params">(struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">						     u8 family,</span></span></span><br><span class="line"><span class="params"><span class="function">						     struct nlattr *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">type</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	type = __nft_expr_type_get(family, nla);</span><br><span class="line">	<span class="keyword">if</span> (type != <span class="literal">NULL</span> &amp;&amp; try_module_get(type-&gt;owner))</span><br><span class="line">		<span class="keyword">return</span> type;</span><br><span class="line"></span><br><span class="line">	lockdep_nfnl_nft_mutex_not_held();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">	<span class="keyword">if</span> (type == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (nft_expr_type_request_module(net, family, nla) == -EAGAIN)</span><br><span class="line">			<span class="keyword">return</span> ERR_PTR(-EAGAIN);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nft_request_module(net, <span class="string">&quot;nft-expr-%.*s&quot;</span>,</span><br><span class="line">				       nla_len(nla),</span><br><span class="line">				       (<span class="keyword">char</span> *)nla_data(nla)) == -EAGAIN)</span><br><span class="line">			<span class="keyword">return</span> ERR_PTR(-EAGAIN);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œtypeæ˜¯ç”±ä¸Šè¿°å‡½æ•°äº§ç”Ÿçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *__<span class="title">nft_expr_type_get</span>(<span class="title">u8</span> <span class="title">family</span>,</span></span><br><span class="line"><span class="class">						       <span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nla</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">type</span>, *<span class="title">candidate</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	list_for_each_entry(type, &amp;nf_tables_expressions, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!nla_strcmp(nla, type-&gt;name)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!type-&gt;family &amp;&amp; !candidate)</span><br><span class="line">				candidate = type;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (type-&gt;family == family)</span><br><span class="line">				candidate = type;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> candidate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¸»è¦æ˜¯é€šè¿‡åå­—è¿›è¡Œå­—ç¬¦ä¸²åˆ¤æ–­æ¥æ‰¾åˆ°å¯¹åº”çš„typeçš„ï¼Œæ‰€ä»¥å›åˆ°ç”¨æˆ·æ€æ¥çœ‹å…¶æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exprs[exprid] = nftnl_expr_alloc(<span class="string">&quot;lookup&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct nftnl_expr *<span class="title">nftnl_expr_alloc</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftnl_expr</span> *<span class="title">expr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">expr_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">	ops = nftnl_expr_ops_lookup(name);</span><br><span class="line">	<span class="keyword">if</span> (ops == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	expr = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(struct nftnl_expr) + ops-&gt;alloc_len);</span><br><span class="line">	<span class="keyword">if</span> (expr == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Manually set expression name attribute */</span></span><br><span class="line">	expr-&gt;flags |= (<span class="number">1</span> &lt;&lt; NFTNL_EXPR_NAME);</span><br><span class="line">	expr-&gt;ops = ops;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> expr;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nftnl_expr_alloc);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¾æ—§æ˜¯é€šè¿‡åå­—å¯»æ‰¾åˆ°opsã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct expr_ops *<span class="title">nftnl_expr_ops_lookup</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (expr_ops[i] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(expr_ops[i]-&gt;name, name) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> expr_ops[i];</span><br><span class="line"></span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">expr_ops</span> *<span class="title">expr_ops</span>[] =</span> &#123;</span><br><span class="line">	&amp;expr_ops_bitwise,</span><br><span class="line">	&amp;expr_ops_byteorder,</span><br><span class="line">	&amp;expr_ops_cmp,</span><br><span class="line">	&amp;expr_ops_counter,</span><br><span class="line">	&amp;expr_ops_ct,</span><br><span class="line">	&amp;expr_ops_dup,</span><br><span class="line">	&amp;expr_ops_exthdr,</span><br><span class="line">	&amp;expr_ops_fwd,</span><br><span class="line">	&amp;expr_ops_immediate,</span><br><span class="line">	&amp;expr_ops_limit,</span><br><span class="line">	&amp;expr_ops_log,</span><br><span class="line">	&amp;expr_ops_lookup,</span><br><span class="line">	&amp;expr_ops_masq,</span><br><span class="line">	&amp;expr_ops_match,</span><br><span class="line">	&amp;expr_ops_meta,</span><br><span class="line">	&amp;expr_ops_ng,</span><br><span class="line">	&amp;expr_ops_nat,</span><br><span class="line">	&amp;expr_ops_notrack,</span><br><span class="line">	&amp;expr_ops_payload,</span><br><span class="line">	&amp;expr_ops_range,</span><br><span class="line">	&amp;expr_ops_redir,</span><br><span class="line">	&amp;expr_ops_reject,</span><br><span class="line">	&amp;expr_ops_rt,</span><br><span class="line">	&amp;expr_ops_queue,</span><br><span class="line">	&amp;expr_ops_quota,</span><br><span class="line">	&amp;expr_ops_target,</span><br><span class="line">	&amp;expr_ops_dynset,</span><br><span class="line">	&amp;expr_ops_hash,</span><br><span class="line">	&amp;expr_ops_fib,</span><br><span class="line">	&amp;expr_ops_objref,</span><br><span class="line">	<span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„opsæœ‰ä»¥ä¸Šè¿™ä¹ˆå¤šç±»ï¼Œè¿™é‡Œä»¥å¼€å¤´çš„<code>lookup</code>ä¸ºä¾‹ï¼Œå›åˆ°å†…æ ¸æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">nft_basic_types</span>[] =</span> &#123;</span><br><span class="line">	&amp;nft_imm_type,</span><br><span class="line">	&amp;nft_cmp_type,</span><br><span class="line">	&amp;nft_lookup_type,</span><br><span class="line">	&amp;nft_bitwise_type,</span><br><span class="line">	&amp;nft_byteorder_type,</span><br><span class="line">	&amp;nft_payload_type,</span><br><span class="line">	&amp;nft_dynset_type,</span><br><span class="line">	&amp;nft_range_type,</span><br><span class="line">	&amp;nft_meta_type,</span><br><span class="line">	&amp;nft_rt_type,</span><br><span class="line">	&amp;nft_exthdr_type,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸ä¹Ÿå…·æœ‰å¾ˆå¤šexpressionç±»å‹ï¼Œä»å‰é¢æ¥çœ‹è¿™é‡ŒåŒ¹é…çš„typeåˆ™ä¸º<code>nft_lookup_type</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_lookup_type</span> __<span class="title">read_mostly</span> =</span> &#123;</span><br><span class="line">	.name		= <span class="string">&quot;lookup&quot;</span>,</span><br><span class="line">	.ops		= &amp;nft_lookup_ops,</span><br><span class="line">	.policy		= nft_lookup_policy,</span><br><span class="line">	.maxattr	= NFTA_LOOKUP_MAX,</span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå…¶<code>select_ops</code>ä¸ºç©ºï¼Œæ‰€ä»¥æœ€ç»ˆå¾—åˆ°çš„opså³ä¸º<code>nft_lookup_ops</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_lookup_ops</span> =</span> &#123;</span><br><span class="line">	.type		= &amp;nft_lookup_type,</span><br><span class="line">	.size		= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_lookup)),</span><br><span class="line">	.eval		= nft_lookup_eval,</span><br><span class="line">	.init		= nft_lookup_init,</span><br><span class="line">	.activate	= nft_lookup_activate,</span><br><span class="line">	.deactivate	= nft_lookup_deactivate,</span><br><span class="line">	.destroy	= nft_lookup_destroy,</span><br><span class="line">	.dump		= nft_lookup_dump,</span><br><span class="line">	.validate	= nft_lookup_validate,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆä»è¿™é‡Œå¾—åˆ°sizeå¹¶åŠ èµ·æ¥ï¼Œå›åˆ°<code>nf_tables_newrule</code>ï¼Œæ¥ç€ä¼šåˆ¤æ–­æœ‰æ— ç”¨æˆ·æ•°æ®ï¼Œå¦‚æœæœ‰çš„è¯åœ¨ç”³è¯·ruleæ—¶ä¹Ÿä¼šè¿å¸¦åŠ ä¸Šã€‚ç´§æ¥ç€å°±æ˜¯å¯¹ruleçš„ä¸€ç³»åˆ—åˆå§‹åŒ–æ“ä½œã€‚</p>
<p>æœ€ååˆ¤æ–­æ–°åˆ›å»ºçš„ruleæ˜¯å¦ä¸ºreplaceæ—§çš„ruleï¼Œå¦‚æœä¸æ˜¯åˆ™åˆ¤æ–­å…¶æ˜¯æ’åœ¨æœ€åè¿˜æ˜¯å¼€å§‹ã€‚</p>
<h3 id="é…ç½®é›†åˆ"><a href="#é…ç½®é›†åˆ" class="headerlink" title="é…ç½®é›†åˆ"></a>é…ç½®é›†åˆ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newset</span><span class="params">(struct net *net, struct sock *nlsk,</span></span></span><br><span class="line"><span class="params"><span class="function">			    struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">			    <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">			    struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfmsg</span> =</span> nlmsg_data(nlh);</span><br><span class="line">	u8 genmask = nft_genmask_next(net);</span><br><span class="line">	<span class="keyword">int</span> family = nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set</span> *<span class="title">set</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	<span class="keyword">char</span> *name;</span><br><span class="line">	u64 size;</span><br><span class="line">	u64 timeout;</span><br><span class="line">	u32 ktype, dtype, flags, policy, gc_int, objtype;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *udata;</span><br><span class="line">	u16 udlen;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_TABLE] == <span class="literal">NULL</span> ||</span><br><span class="line">	    nla[NFTA_SET_NAME] == <span class="literal">NULL</span> ||</span><br><span class="line">	    nla[NFTA_SET_KEY_LEN] == <span class="literal">NULL</span> ||</span><br><span class="line">	    nla[NFTA_SET_ID] == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">	ktype = NFT_DATA_VALUE;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_KEY_TYPE] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		ktype = ntohl(nla_get_be32(nla[NFTA_SET_KEY_TYPE]));</span><br><span class="line">		<span class="keyword">if</span> ((ktype &amp; NFT_DATA_RESERVED_MASK) == NFT_DATA_RESERVED_MASK)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	desc.klen = ntohl(nla_get_be32(nla[NFTA_SET_KEY_LEN]));</span><br><span class="line">	<span class="keyword">if</span> (desc.klen == <span class="number">0</span> || desc.klen &gt; NFT_DATA_VALUE_MAXLEN)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	flags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_FLAGS] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		flags = ntohl(nla_get_be32(nla[NFTA_SET_FLAGS]));</span><br><span class="line">		<span class="keyword">if</span> (flags &amp; ~(NFT_SET_ANONYMOUS | NFT_SET_CONSTANT |</span><br><span class="line">			      NFT_SET_INTERVAL | NFT_SET_TIMEOUT |</span><br><span class="line">			      NFT_SET_MAP | NFT_SET_EVAL |</span><br><span class="line">			      NFT_SET_OBJECT | NFT_SET_CONCAT))</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">		<span class="comment">/* Only one of these operations is supported */</span></span><br><span class="line">		<span class="keyword">if</span> ((flags &amp; (NFT_SET_MAP | NFT_SET_OBJECT)) ==</span><br><span class="line">			     (NFT_SET_MAP | NFT_SET_OBJECT))</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">		<span class="keyword">if</span> ((flags &amp; (NFT_SET_EVAL | NFT_SET_OBJECT)) ==</span><br><span class="line">			     (NFT_SET_EVAL | NFT_SET_OBJECT))</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dtype = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_DATA_TYPE] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; NFT_SET_MAP))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		dtype = ntohl(nla_get_be32(nla[NFTA_SET_DATA_TYPE]));</span><br><span class="line">		<span class="keyword">if</span> ((dtype &amp; NFT_DATA_RESERVED_MASK) == NFT_DATA_RESERVED_MASK &amp;&amp;</span><br><span class="line">		    dtype != NFT_DATA_VERDICT)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (dtype != NFT_DATA_VERDICT) &#123;</span><br><span class="line">			<span class="keyword">if</span> (nla[NFTA_SET_DATA_LEN] == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">return</span> -EINVAL;</span><br><span class="line">			desc.dlen = ntohl(nla_get_be32(nla[NFTA_SET_DATA_LEN]));</span><br><span class="line">			<span class="keyword">if</span> (desc.dlen == <span class="number">0</span> || desc.dlen &gt; NFT_DATA_VALUE_MAXLEN)</span><br><span class="line">				<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125; <span class="keyword">else</span></span><br><span class="line">			desc.dlen = <span class="keyword">sizeof</span>(struct nft_verdict);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; NFT_SET_MAP)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_OBJ_TYPE] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; NFT_SET_OBJECT))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		objtype = ntohl(nla_get_be32(nla[NFTA_SET_OBJ_TYPE]));</span><br><span class="line">		<span class="keyword">if</span> (objtype == NFT_OBJECT_UNSPEC ||</span><br><span class="line">		    objtype &gt; NFT_OBJECT_MAX)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; NFT_SET_OBJECT)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		objtype = NFT_OBJECT_UNSPEC;</span><br><span class="line"></span><br><span class="line">	timeout = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_TIMEOUT] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; NFT_SET_TIMEOUT))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		err = nf_msecs_to_jiffies64(nla[NFTA_SET_TIMEOUT], &amp;timeout);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line">	gc_int = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_GC_INTERVAL] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; NFT_SET_TIMEOUT))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		gc_int = ntohl(nla_get_be32(nla[NFTA_SET_GC_INTERVAL]));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	policy = NFT_SET_POL_PERFORMANCE;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_POLICY] != <span class="literal">NULL</span>)</span><br><span class="line">		policy = ntohl(nla_get_be32(nla[NFTA_SET_POLICY]));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_DESC] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		err = nf_tables_set_desc_parse(&amp;desc, nla[NFTA_SET_DESC]);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_EXPR])</span><br><span class="line">		desc.expr = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	table = nft_table_lookup(net, nla[NFTA_SET_TABLE], family, genmask);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_SET_TABLE]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, <span class="literal">NULL</span>, nla);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> = nft_set_lookup(table, nla[NFTA_SET_NAME], genmask);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(<span class="built_in">set</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (PTR_ERR(<span class="built_in">set</span>) != -ENOENT) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_SET_NAME]);</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(<span class="built_in">set</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, nla[NFTA_SET_NAME]);</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(nlh-&gt;nlmsg_flags &amp; NLM_F_CREATE))</span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">	ops = nft_select_set_ops(&amp;ctx, nla, &amp;desc, policy);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(ops))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(ops);</span><br><span class="line"></span><br><span class="line">	udlen = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_USERDATA])</span><br><span class="line">		udlen = nla_len(nla[NFTA_SET_USERDATA]);</span><br><span class="line"></span><br><span class="line">	size = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (ops-&gt;privsize != <span class="literal">NULL</span>)</span><br><span class="line">		size = ops-&gt;privsize(nla, &amp;desc);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> = kvzalloc(<span class="keyword">sizeof</span>(*<span class="built_in">set</span>) + size + udlen, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">set</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	name = nla_strdup(nla[NFTA_SET_NAME], GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!name) &#123;</span><br><span class="line">		err = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err_set_name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = nf_tables_set_alloc_name(&amp;ctx, <span class="built_in">set</span>, name);</span><br><span class="line">	kfree(name);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_set_alloc_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_EXPR]) &#123;</span><br><span class="line">		expr = nft_set_elem_expr_alloc(&amp;ctx, <span class="built_in">set</span>, nla[NFTA_SET_EXPR]);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(expr)) &#123;</span><br><span class="line">			err = PTR_ERR(expr);</span><br><span class="line">			<span class="keyword">goto</span> err_set_alloc_name;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	udata = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span> (udlen) &#123;</span><br><span class="line">		udata = <span class="built_in">set</span>-&gt;data + size;</span><br><span class="line">		nla_memcpy(udata, nla[NFTA_SET_USERDATA], udlen);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	INIT_LIST_HEAD(&amp;<span class="built_in">set</span>-&gt;bindings);</span><br><span class="line">	<span class="built_in">set</span>-&gt;table = table;</span><br><span class="line">	write_pnet(&amp;<span class="built_in">set</span>-&gt;net, net);</span><br><span class="line">	<span class="built_in">set</span>-&gt;ops   = ops;</span><br><span class="line">	<span class="built_in">set</span>-&gt;ktype = ktype;</span><br><span class="line">	<span class="built_in">set</span>-&gt;klen  = desc.klen;</span><br><span class="line">	<span class="built_in">set</span>-&gt;dtype = dtype;</span><br><span class="line">	<span class="built_in">set</span>-&gt;objtype = objtype;</span><br><span class="line">	<span class="built_in">set</span>-&gt;dlen  = desc.dlen;</span><br><span class="line">	<span class="built_in">set</span>-&gt;expr = expr;</span><br><span class="line">	<span class="built_in">set</span>-&gt;flags = flags;</span><br><span class="line">	<span class="built_in">set</span>-&gt;size  = desc.size;</span><br><span class="line">	<span class="built_in">set</span>-&gt;policy = policy;</span><br><span class="line">	<span class="built_in">set</span>-&gt;udlen  = udlen;</span><br><span class="line">	<span class="built_in">set</span>-&gt;udata  = udata;</span><br><span class="line">	<span class="built_in">set</span>-&gt;timeout = timeout;</span><br><span class="line">	<span class="built_in">set</span>-&gt;gc_int = gc_int;</span><br><span class="line">	<span class="built_in">set</span>-&gt;handle = nf_tables_alloc_handle(table);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span>-&gt;field_count = desc.field_count;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; desc.field_count; i++)</span><br><span class="line">		<span class="built_in">set</span>-&gt;field_len[i] = desc.field_len[i];</span><br><span class="line"></span><br><span class="line">	err = ops-&gt;init(<span class="built_in">set</span>, &amp;desc, nla);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_set_init;</span><br><span class="line"></span><br><span class="line">	err = nft_trans_set_add(&amp;ctx, NFT_MSG_NEWSET, <span class="built_in">set</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_set_trans;</span><br><span class="line"></span><br><span class="line">	list_add_tail_rcu(&amp;<span class="built_in">set</span>-&gt;<span class="built_in">list</span>, &amp;table-&gt;sets);</span><br><span class="line">	table-&gt;use++;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_set_trans:</span><br><span class="line">	ops-&gt;destroy(<span class="built_in">set</span>);</span><br><span class="line">err_set_init:</span><br><span class="line">	<span class="keyword">if</span> (expr)</span><br><span class="line">		nft_expr_destroy(&amp;ctx, expr);</span><br><span class="line">err_set_alloc_name:</span><br><span class="line">	kfree(<span class="built_in">set</span>-&gt;name);</span><br><span class="line">err_set_name:</span><br><span class="line">	kvfree(<span class="built_in">set</span>);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ ·çš„<code>nft_ctx_init</code>åœ¨è¿™ä¸ªå‡½æ•°ä¹‹å‰ä¸»è¦åšçš„äº‹æƒ…æ˜¯åˆå§‹åŒ–ä¸€äº›å˜é‡å¹¶ä¸”æ‰¾åˆ°å¯¹åº”çš„tableã€‚</p>
<p>éšåç›´æ¥é€šè¿‡<code>nft_set_lookup</code>å‡½æ•°æ‰¾åˆ°setï¼Œå¦‚æœå·²å­˜åœ¨setåˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœæœªå­˜åœ¨åˆ™ç»§ç»­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> struct nft_set_ops *</span></span><br><span class="line"><span class="function"><span class="title">nft_select_set_ops</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="keyword">const</span> struct nft_set_desc *desc,</span></span></span><br><span class="line"><span class="params"><span class="function">		   <span class="keyword">enum</span> nft_set_policies policy)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ops</span> *<span class="title">ops</span>, *<span class="title">bops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_estimate</span> <span class="title">est</span>, <span class="title">best</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_type</span> *<span class="title">type</span>;</span></span><br><span class="line">	u32 flags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	lockdep_assert_held(&amp;ctx-&gt;net-&gt;nft.commit_mutex);</span><br><span class="line">	lockdep_nfnl_nft_mutex_not_held();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_FLAGS] != <span class="literal">NULL</span>)</span><br><span class="line">		flags = ntohl(nla_get_be32(nla[NFTA_SET_FLAGS]));</span><br><span class="line"></span><br><span class="line">	bops	    = <span class="literal">NULL</span>;</span><br><span class="line">	best.size   = ~<span class="number">0</span>;</span><br><span class="line">	best.lookup = ~<span class="number">0</span>;</span><br><span class="line">	best.space  = ~<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(nft_set_types); i++) &#123;</span><br><span class="line">		type = nft_set_types[i];</span><br><span class="line">		ops = &amp;type-&gt;ops;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!nft_set_ops_candidate(type, flags))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (!ops-&gt;estimate(desc, flags, &amp;est))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (policy) &#123;</span><br><span class="line">		<span class="keyword">case</span> NFT_SET_POL_PERFORMANCE:</span><br><span class="line">			<span class="keyword">if</span> (est.lookup &lt; best.lookup)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">if</span> (est.lookup == best.lookup &amp;&amp;</span><br><span class="line">			    est.space &lt; best.space)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">case</span> NFT_SET_POL_MEMORY:</span><br><span class="line">			<span class="keyword">if</span> (!desc-&gt;size) &#123;</span><br><span class="line">				<span class="keyword">if</span> (est.space &lt; best.space)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">if</span> (est.space == best.space &amp;&amp;</span><br><span class="line">				    est.lookup &lt; best.lookup)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (est.size &lt; best.size || !bops) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		bops = ops;</span><br><span class="line">		best = est;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bops != <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> bops;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-EOPNOTSUPP);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆé€šè¿‡<code>nft_select_set_ops</code>å‡½æ•°æ¥æ‰¾åˆ°ops</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_type</span> *<span class="title">nft_set_types</span>[] =</span> &#123;</span><br><span class="line">	&amp;nft_set_hash_fast_type,</span><br><span class="line">	&amp;nft_set_hash_type,</span><br><span class="line">	&amp;nft_set_rhash_type,</span><br><span class="line">	&amp;nft_set_bitmap_type,</span><br><span class="line">	&amp;nft_set_rbtree_type,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_X86_64) &amp;&amp; !defined(CONFIG_UML)</span></span><br><span class="line">	&amp;nft_set_pipapo_avx2_type,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&amp;nft_set_pipapo_type,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨ä»¥ä¸Šç§ç±»çš„set typeï¼Œåœ¨è¿™é‡Œæ‰¾åˆ°å¯¹åº”çš„opsä¹‹åè¿›è¡Œè¿”å›æœ€åå†åˆå§‹åŒ–setã€‚</p>
<p>ä¸è¿‡è¿™é‡Œä¸å‰é¢ä¸åŒçš„æ˜¯ï¼Œåœ¨å†™å…¥åå­—çš„æ—¶å€™å¦‚æœä¹‹å‰å­˜åœ¨çš„è¯ä¼šç›´æ¥é‡Šæ”¾å†…å­˜å¹¶è¿”å›é”™è¯¯ã€‚</p>
<h3 id="é…ç½®è¡¨è¾¾å¼"><a href="#é…ç½®è¡¨è¾¾å¼" class="headerlink" title="é…ç½®è¡¨è¾¾å¼"></a>é…ç½®è¡¨è¾¾å¼</h3><p>è¡¨è¾¾å¼åœ¨ä¸¤å¤„å†…éƒ½å­˜åœ¨ä¸€æ˜¯åœ¨ç”³è¯·è§„åˆ™æ—¶ï¼Œå…¶æ¬¡å°±æ˜¯ç”³è¯·é›†åˆæ—¶ã€‚</p>
<p>ç”³è¯·è§„åˆ™æ—¶å¥½ç†è§£åœ¨ç”³è¯·åˆ°ruleä¹‹åç›´æ¥è°ƒç”¨<code>nf_tables_newexpr</code>å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newexpr</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">const</span> struct nft_expr_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">			     struct nft_expr *expr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> *<span class="title">ops</span> =</span> info-&gt;ops;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	expr-&gt;ops = ops;</span><br><span class="line">	<span class="keyword">if</span> (ops-&gt;init) &#123;</span><br><span class="line">		err = ops-&gt;init(ctx, expr, (<span class="keyword">const</span> struct nlattr **)info-&gt;tb);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> err1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err1:</span><br><span class="line">	expr-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¢å¯¹ä¸åŒç±»å‹è¡¨è¾¾å¼ä¼šè¿›å…¥åˆ°ä¸åŒçš„initå‡½æ•°ä¸­ï¼Œè¿™é‡Œä¸è¿‡å¤šåˆ†æäº†ã€‚</p>
<p>å†å°±æ˜¯åœ¨ç”³è¯·é›†åˆæ—¶ä¼šç”³è¯·è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_EXPR]) &#123;</span><br><span class="line">    expr = nft_set_elem_expr_alloc(&amp;ctx, <span class="built_in">set</span>, nla[NFTA_SET_EXPR]);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(expr)) &#123;</span><br><span class="line">        err = PTR_ERR(expr);</span><br><span class="line">        <span class="keyword">goto</span> err_set_alloc_name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ç”¨æˆ·æ€ä¼ å…¥æ—¶å­˜åœ¨expressionåˆ™ä¼šè°ƒç”¨<code>nft_set_elem_expr_alloc</code>è¿›è¡Œåˆ›å»ºã€‚</p>
<hr>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://wiki.nftables.org/wiki-nftables/index.php/Main_Page" >https://wiki.nftables.org/wiki-nftables/index.php/Main_Page<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/xinghuo123/p/13797589.html" >https://www.cnblogs.com/xinghuo123/p/13797589.html<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/netfilter/">netfilter</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/nftables/">nftables</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/netlink/">netlink</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2024/08/27/CVE-2022-34918/"
                                   title="CVE-2022-34918"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">CVE-2022-34918</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2024/06/03/Linux-Rootkit%E7%8E%B0%E4%BB%A3%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/"
                                   title="Linux Rootkitç°ä»£æŠ€æœ¯åˆ†æ"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Linux Rootkitç°ä»£æŠ€æœ¯åˆ†æ</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netlink%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6"><span class="nav-text">Netlinké€šä¿¡æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">ç”¨æˆ·æ€æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E6%80%81Netlink-socket-API"><span class="nav-text">å†…æ ¸æ€Netlink socket API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netlink%E5%86%85%E6%A0%B8%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="nav-text">Netlinkå†…æ ¸æ¥æ”¶æ¶ˆæ¯</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Netlink%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">Netlinkåˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sock%E5%B1%82%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-text">sockå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#netlink%E5%B1%82%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-text">netlinkå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nftables%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E5%8F%8A%E5%86%85%E6%A0%B8%E5%AE%9E%E7%8E%B0"><span class="nav-text">nftablesç›¸å…³æ“ä½œåŠå†…æ ¸å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%A1%A8"><span class="nav-text">é…ç½®è¡¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%93%BE"><span class="nav-text">é…ç½®é“¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99"><span class="nav-text">é…ç½®è§„åˆ™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%9B%86%E5%90%88"><span class="nav-text">é…ç½®é›†åˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">é…ç½®è¡¨è¾¾å¼</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2026
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">345.9k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netlink%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6"><span class="nav-text">Netlinké€šä¿¡æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">ç”¨æˆ·æ€æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E6%80%81Netlink-socket-API"><span class="nav-text">å†…æ ¸æ€Netlink socket API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netlink%E5%86%85%E6%A0%B8%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="nav-text">Netlinkå†…æ ¸æ¥æ”¶æ¶ˆæ¯</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Netlink%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">Netlinkåˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sock%E5%B1%82%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-text">sockå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#netlink%E5%B1%82%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-text">netlinkå±‚æ¥æ”¶è¯·æ±‚æµç¨‹åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nftables%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E5%8F%8A%E5%86%85%E6%A0%B8%E5%AE%9E%E7%8E%B0"><span class="nav-text">nftablesç›¸å…³æ“ä½œåŠå†…æ ¸å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%A1%A8"><span class="nav-text">é…ç½®è¡¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%93%BE"><span class="nav-text">é…ç½®é“¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99"><span class="nav-text">é…ç½®è§„åˆ™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%9B%86%E5%90%88"><span class="nav-text">é…ç½®é›†åˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">é…ç½®è¡¨è¾¾å¼</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
