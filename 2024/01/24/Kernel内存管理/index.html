<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            Kernelå†…å­˜ç®¡ç† |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/ufo.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/ufo.ico"},"menu":{"home":"/","archives":"/archives","tags":"/tags","categories":"/categories"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"æµ…æµ…æ›´æ–°åšå®¢ä¸€ä¸‹å§~","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":true,"img_link":"/images/reward.jpg","text":"æ¿€åŠ±ç‰›é©¬ï¼ŒåŠ é€Ÿåˆ›ä½œï¼","icon":"fa-solid fa-mug-hot"},"img_align":"center"},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®º"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"feed":{"type":"atom","path":"atom.xml","limit":20},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Kernelå†…å­˜ç®¡ç†
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-01-24 17:11:09</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Jan 24 2024 17:10:57 GMT+0800">2024-01-24 17:10:57</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/buddy-system/">buddy system</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">å†…å­˜ç®¡ç†</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>17.3k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>82 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…¶å®è¿™ä¸€ç¯‡æ‰“ç®—çš„æ˜¯å†™<code>syz-fuzzer</code>éƒ¨åˆ†çš„æºç åˆ†ææˆ–è€…æ˜¯<code>Linux Rootkit</code>è¿™ä¸¤ç¯‡ä¸­çš„ä¸€ç¯‡ï¼Œä½†æ˜¯åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­è¾ƒä¸ºè¯¦ç»†çš„åˆ†æäº†slubçš„åˆ†é…æµç¨‹ï¼ŒåŠ ä¸Šä¹Ÿæœ‰å‡ ä½å¸ˆå‚…è¯´æˆ‘çš„åšå®¢ç¼ºå°‘åŸºç¡€çŸ¥è¯†ï¼Œè¿™ä¹Ÿå°±è®©æˆ‘æƒ³è¦ä¸æŠŠä¹Ÿè¿™ç¯‡æ–‡ç« ç»™å†™äº†ã€‚è¿™é‡Œè¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆæˆ‘ä¸æ„¿æ„å†™è¿™äº›åŸºç¡€çš„åŸå› ï¼Œåœ¨å­¦æ ¡æœŸé—´æˆ‘ä¸æ„¿æ„å†™çš„ä¸»è¦åŸå› æ˜¯æˆ‘æƒ³è¦ä¸æ–­çš„å­¦ä¹ æ–°ä¸œè¥¿ï¼ˆå¯ä»¥çœ‹åˆ°æˆ‘å‰é¢ç©è¿‡ä»€ä¹ˆqemuï¼Œchromeä¹‹ç±»çš„ï¼‰ï¼Œéšåä¼šè¿‡ä¸€éåŸºç¡€ä½†æ˜¯å†™ä¸‹æ¥å°±ä¼šæœ‰ç‚¹è´¹åŠ›ä¸è®¨å¥½çš„æ„Ÿè§‰ã€‚å®ä¹ ä¹‹åä¸ºä»€ä¹ˆä¸å†™çš„ä¸»è¦åŸå› æ˜¯ï¼Œå†™åŸºç¡€æ˜¯ä¸èƒ½å½“ä½œè¿™ä¸€å‘¨å¹²çš„äº‹å†™è¿›å‘¨æŠ¥çš„ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ä¸Šç­æœŸé—´æˆ‘å¤ç°äº†å¾ˆå¤šCVEå…¶å®åœ¨é‚£ä¹ˆå¤šç¯‡ä¸­ä¹Ÿç©¿æ’äº†è®¸å¤šçš„åŸºç¡€çŸ¥è¯†ï¼Œ<del>å¯¹èµ„æœ¬å®¶çš„æ— å£°æŠµæŠ—äº†å±äºæ˜¯</del>ã€‚</p>
<p>å½“ç„¶ï¼Œè™½ç„¶å‰é¢ç†ç”±é‚£ä¹ˆå¤šä½†æ˜¯æœ€ä¸¥é‡çš„ä¸€ä¸ªé—®é¢˜è¿˜æ˜¯ï¼Œæ²¡äººçœ‹æˆ‘åšå®¢ğŸ˜­ï¼Œè¿™ä¹Ÿæ˜¯è®©æˆ‘ä¸€ç›´çŠ¯æ‡’çš„åŸå› ï¼ˆä¸è¿‡ç•™ç€è‡ªå·±çœ‹ä¹Ÿæ˜¯å¾ˆå¥½çš„ï¼‰ã€‚</p>
<p><img   src="/images/OrsvS6GTMgPLx5E.png" ></p>
<h2 id="struct-page"><a href="#struct-page" class="headerlink" title="struct page"></a>struct page</h2><p>åœ¨å‰é¢çš„å¾ˆå¤šæ–‡ç« ä¸­éƒ½æåˆ°è¿‡<code>page</code>ç»“æ„ä½“ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‹¿å‡ºæ¥è¯¦ç»†è§£é‡Šè¿‡ï¼Œè¿™é‡Œä¹Ÿè¯¦ç»†çš„é˜è¿°ä¸€ä¸‹å§ã€‚åœ¨ <a class="link"   target="_blank" rel="noopener" href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/" >å‘pipe_bufferè¯´yesï¼<i class="fas fa-external-link-alt"></i></a> æ–‡ç« ä¸­æˆ‘ä»¬æ˜¯ä½¿ç”¨<code>off by null</code>å¯¼è‡´ä¸¤ä¸ª<code>pipe_buffer-&gt;page</code>æŒ‡é’ˆæŒ‡å‘äº†åŒä¸€ä¸ªpageç»“æ„ä½“ï¼Œè€Œpageç»“æ„ä½“åœ¨ Linux Kernel ä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªç‰©ç†é¡µæ¡†åŒæ ·æ¯ä¸ªç‰©ç†é¡µæ¡†ä¹Ÿä¼šå¯¹åº”ä¸€ä¸ªpageç»“æ„ä½“ï¼Œæ­£æ˜¯å› ä¸ºå‰é¢çš„å¯¹åº”å…³ç³»å­˜åœ¨æˆ‘ä»¬æ‰èƒ½å¤Ÿè®©åé¢çš„<code>pipe_buffer</code>ç»“æ„ä½“å»å é¢†å¯¹åº”çš„ç‰©ç†é¡µæ¡†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;		<span class="comment">/* Atomic flags, some possibly</span></span><br><span class="line"><span class="comment">					 * updated asynchronously */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Five words (20/40 bytes) are available in this union.</span></span><br><span class="line"><span class="comment">	 * WARNING: bit 0 of the first word is used for PageTail(). That</span></span><br><span class="line"><span class="comment">	 * means the other users of this union MUST NOT use the bit to</span></span><br><span class="line"><span class="comment">	 * avoid collision and false-positive PageTail().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* Page cache and anonymous pages */</span></span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * @lru: Pageout list, eg. active_list protected by</span></span><br><span class="line"><span class="comment">			 * lruvec-&gt;lru_lock.  Sometimes used as a generic list</span></span><br><span class="line"><span class="comment">			 * by the page owner.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">/* Or, for the Unevictable &quot;LRU list&quot; slot */</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">					<span class="comment">/* Always even, to negate PageTail */</span></span><br><span class="line">					<span class="keyword">void</span> *__filler;</span><br><span class="line">					<span class="comment">/* Count page&#x27;s or folio&#x27;s mlocks */</span></span><br><span class="line">					<span class="keyword">unsigned</span> <span class="keyword">int</span> mlock_count;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* Or, free page */</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">buddy_list</span>;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">pcp_list</span>;</span></span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="comment">/* See page-flags.h for PAGE_MAPPING_FLAGS */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="keyword">pgoff_t</span> index;		<span class="comment">/* Our offset within mapping. */</span></span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">long</span> share;	<span class="comment">/* share count for fsdax */</span></span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * @private: Mapping-private opaque data.</span></span><br><span class="line"><span class="comment">			 * Usually used for buffer_heads if PagePrivate.</span></span><br><span class="line"><span class="comment">			 * Used for swp_entry_t if PageSwapCache.</span></span><br><span class="line"><span class="comment">			 * Indicates order in the buddy system if PageBuddy.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* page_pool used by netstack */</span></span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * @pp_magic: magic value to avoid recycling non</span></span><br><span class="line"><span class="comment">			 * page_pool allocated pages.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> pp_magic;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">page_pool</span> *<span class="title">pp</span>;</span></span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> _pp_mapping_pad;</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> dma_addr;</span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="comment">/**</span></span><br><span class="line"><span class="comment">				 * dma_addr_upper: might require a 64-bit</span></span><br><span class="line"><span class="comment">				 * value on 32-bit architectures.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">long</span> dma_addr_upper;</span><br><span class="line">				<span class="comment">/**</span></span><br><span class="line"><span class="comment">				 * For frag page support, not supported in</span></span><br><span class="line"><span class="comment">				 * 32-bit architectures with 64-bit DMA.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				<span class="keyword">atomic_long_t</span> pp_frag_count;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* Tail pages of compound page */</span></span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> compound_head;	<span class="comment">/* Bit zero is set */</span></span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* ZONE_DEVICE pages */</span></span><br><span class="line">			<span class="comment">/** @pgmap: Points to the hosting device page map. */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">dev_pagemap</span> *<span class="title">pgmap</span>;</span></span><br><span class="line">			<span class="keyword">void</span> *zone_device_data;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * ZONE_DEVICE private pages are counted as being</span></span><br><span class="line"><span class="comment">			 * mapped so the next 3 words hold the mapping, index,</span></span><br><span class="line"><span class="comment">			 * and private fields from the source anonymous or</span></span><br><span class="line"><span class="comment">			 * page cache page while the page is migrated to device</span></span><br><span class="line"><span class="comment">			 * private memory.</span></span><br><span class="line"><span class="comment">			 * ZONE_DEVICE MEMORY_DEVICE_FS_DAX pages also</span></span><br><span class="line"><span class="comment">			 * use the mapping, index, and private fields when</span></span><br><span class="line"><span class="comment">			 * pmem backed DAX files are mapped.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** @rcu_head: You can use this to free a page by RCU. */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span>		<span class="comment">/* This union is 4 bytes in size. */</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If the page can be mapped to userspace, encodes the number</span></span><br><span class="line"><span class="comment">		 * of times this page is referenced by a page table.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">atomic_t</span> _mapcount;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If the page is neither PageSlab nor mappable to userspace,</span></span><br><span class="line"><span class="comment">		 * the value stored here may help determine what this page</span></span><br><span class="line"><span class="comment">		 * is used for.  See page-flags.h for a list of page types</span></span><br><span class="line"><span class="comment">		 * which are currently stored here.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> page_type;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Usage count. *DO NOT USE DIRECTLY*. See page_ref.h */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> _refcount;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On machines where all RAM is mapped into kernel address space,</span></span><br><span class="line"><span class="comment">	 * we can simply calculate the virtual address. On machines with</span></span><br><span class="line"><span class="comment">	 * highmem some memory is mapped into kernel virtual memory</span></span><br><span class="line"><span class="comment">	 * dynamically, so we need a place to store that address.</span></span><br><span class="line"><span class="comment">	 * Note that this field could be 16 bits on x86 ... ;)</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Architectures with slow multiplication can define</span></span><br><span class="line"><span class="comment">	 * WANT_PAGE_VIRTUAL in asm/page.h</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(WANT_PAGE_VIRTUAL)</span></span><br><span class="line">	<span class="keyword">void</span> *<span class="keyword">virtual</span>;			<span class="comment">/* Kernel virtual address (NULL if</span></span><br><span class="line"><span class="comment">					   not kmapped, ie. highmem) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WANT_PAGE_VIRTUAL */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KMSAN</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * KMSAN metadata for this page:</span></span><br><span class="line"><span class="comment">	 *  - shadow page: every bit indicates whether the corresponding</span></span><br><span class="line"><span class="comment">	 *    bit of the original page is initialized (0) or not (1);</span></span><br><span class="line"><span class="comment">	 *  - origin page: every 4 bytes contain an id of the stack trace</span></span><br><span class="line"><span class="comment">	 *    where the uninitialized value was created.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">kmsan_shadow</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">kmsan_origin</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LAST_CPUPID_NOT_IN_PAGE_FLAGS</span></span><br><span class="line">	<span class="keyword">int</span> _last_cpupid;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; _struct_page_alignment;</span><br></pre></td></tr></table></figure>

<p>åœ¨å†…æ ¸ä¸­pageç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸Šï¼Œè¿™é‡Œä¸ä¼šå°†å…¨éƒ¨æˆå‘˜çš„å«ä¹‰è¿›è¡Œè§£é‡Šåªä¼šè§£é‡Šè¾ƒä¸ºé‡è¦æˆ–æ˜¯åæ–‡ä¸­éœ€è¦çš„ã€‚</p>
<h3 id="flagsï¼šæ ‡å¿—ä½"><a href="#flagsï¼šæ ‡å¿—ä½" class="headerlink" title="flagsï¼šæ ‡å¿—ä½"></a>flagsï¼šæ ‡å¿—ä½</h3><p>è¿™ä¸ªæˆå‘˜çš„å«ä¹‰å¾ˆæ˜æ˜¾ï¼Œç”¨äºè¡¨ç¤ºè¯¥é¡µå¤„äºä»€ä¹ˆæ ·çš„çŠ¶æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">pageflags</span> &#123;</span></span><br><span class="line">	PG_locked,		<span class="comment">/* Page is locked. Don&#x27;t touch. */</span></span><br><span class="line">	PG_writeback,		<span class="comment">/* Page is under writeback */</span></span><br><span class="line">	PG_referenced,</span><br><span class="line">	PG_uptodate,</span><br><span class="line">	PG_dirty,</span><br><span class="line">	PG_lru,</span><br><span class="line">	PG_head,		<span class="comment">/* Must be in bit 6 */</span></span><br><span class="line">	PG_waiters,		<span class="comment">/* Page has waiters, check its waitqueue. Must be bit #7 and in the same byte as &quot;PG_locked&quot; */</span></span><br><span class="line">	PG_active,</span><br><span class="line">	PG_workingset,</span><br><span class="line">	PG_error,</span><br><span class="line">	PG_slab,</span><br><span class="line">	PG_owner_priv_1,	<span class="comment">/* Owner use. If pagecache, fs may use*/</span></span><br><span class="line">	PG_arch_1,</span><br><span class="line">	PG_reserved,</span><br><span class="line">	PG_private,		<span class="comment">/* If pagecache, has fs-private data */</span></span><br><span class="line">	PG_private_2,		<span class="comment">/* If pagecache, has fs aux data */</span></span><br><span class="line">	PG_mappedtodisk,	<span class="comment">/* Has blocks allocated on-disk */</span></span><br><span class="line">	PG_reclaim,		<span class="comment">/* To be reclaimed asap */</span></span><br><span class="line">	PG_swapbacked,		<span class="comment">/* Page is backed by RAM/swap */</span></span><br><span class="line">	PG_unevictable,		<span class="comment">/* Page is &quot;unevictable&quot;  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line">	PG_mlocked,		<span class="comment">/* Page is vma mlocked */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_USES_PG_UNCACHED</span></span><br><span class="line">	PG_uncached,		<span class="comment">/* Page has been mapped as uncached */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_FAILURE</span></span><br><span class="line">	PG_hwpoison,		<span class="comment">/* hardware poisoned page. Don&#x27;t touch */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_PAGE_IDLE_FLAG) &amp;&amp; defined(CONFIG_64BIT)</span></span><br><span class="line">	PG_young,</span><br><span class="line">	PG_idle,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_USES_PG_ARCH_X</span></span><br><span class="line">	PG_arch_2,</span><br><span class="line">	PG_arch_3,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	__NR_PAGEFLAGS,</span><br><span class="line"></span><br><span class="line">	PG_readahead = PG_reclaim,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Depending on the way an anonymous folio can be mapped into a page</span></span><br><span class="line"><span class="comment">	 * table (e.g., single PMD/PUD/CONT of the head page vs. PTE-mapped</span></span><br><span class="line"><span class="comment">	 * THP), PG_anon_exclusive may be set only for the head page or for</span></span><br><span class="line"><span class="comment">	 * tail pages of an anonymous folio. For now, we only expect it to be</span></span><br><span class="line"><span class="comment">	 * set on tail pages for PTE-mapped THP.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	PG_anon_exclusive = PG_mappedtodisk,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Filesystems */</span></span><br><span class="line">	PG_checked = PG_owner_priv_1,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* SwapBacked */</span></span><br><span class="line">	PG_swapcache = PG_owner_priv_1,	<span class="comment">/* Swap page: swp_entry_t in private */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Two page bits are conscripted by FS-Cache to maintain local caching</span></span><br><span class="line"><span class="comment">	 * state.  These bits are set on pages belonging to the netfs&#x27;s inodes</span></span><br><span class="line"><span class="comment">	 * when those inodes are being locally cached.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	PG_fscache = PG_private_2,	<span class="comment">/* page backed by cache */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* XEN */</span></span><br><span class="line">	<span class="comment">/* Pinned in Xen as a read-only pagetable page. */</span></span><br><span class="line">	PG_pinned = PG_owner_priv_1,</span><br><span class="line">	<span class="comment">/* Pinned as part of domain save (see xen_mm_pin_all()). */</span></span><br><span class="line">	PG_savepinned = PG_dirty,</span><br><span class="line">	<span class="comment">/* Has a grant mapping of another (foreign) domain&#x27;s page. */</span></span><br><span class="line">	PG_foreign = PG_owner_priv_1,</span><br><span class="line">	<span class="comment">/* Remapped by swiotlb-xen. */</span></span><br><span class="line">	PG_xen_remapped = PG_owner_priv_1,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* non-lru isolated movable page */</span></span><br><span class="line">	PG_isolated = PG_reclaim,</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Only valid for buddy pages. Used to track pages that are reported */</span></span><br><span class="line">	PG_reported = PG_uptodate,</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line">	<span class="comment">/* For self-hosted memmap pages */</span></span><br><span class="line">	PG_vmemmap_self_hosted = PG_owner_priv_1,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Flags only valid for compound pages.  Stored in first tail page&#x27;s</span></span><br><span class="line"><span class="comment">	 * flags word.  Cannot use the first 8 flags or any flag marked as</span></span><br><span class="line"><span class="comment">	 * PF_ANY.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* At least one page in this folio has the hwpoison flag set */</span></span><br><span class="line">	PG_has_hwpoisoned = PG_error,</span><br><span class="line">	PG_hugetlb = PG_active,</span><br><span class="line">	PG_large_rmappable = PG_workingset, <span class="comment">/* anon or file-backed */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„æšä¸¾ç±»å‹å˜é‡å°±å¯¹åº”äº†ä¸€ä¸ªé¡µçš„ä¸åŒçŠ¶æ€ã€‚</p>
<blockquote>
<p><code>PG_locked</code>ï¼šè¡¨ç¤ºè¯¥é¡µå·²è¢«ä¸Šé”ï¼Œè¯´æ˜æ­¤æ—¶è¯¥é¡µæ­£åœ¨è¢«ä½¿ç”¨</p>
<p><code>PG_referenced</code>ï¼šè¯¥é¡µåˆšåˆšè¢«è®¿é—®è¿‡ï¼Œè¯¥æ ‡å¿—ä½ä¸ <code>PG_reclaim</code> æ ‡å¿—ä½å…±åŒè¢«ç”¨äºåŒ¿åä¸æ–‡ä»¶å¤‡ä»½ç¼“å­˜çš„é¡µé¢å›æ”¶</p>
<p><code>PG_uptodate</code>ï¼šè¯¥é¡µå¤„åœ¨æœ€æ–°çŠ¶æ€ï¼Œå½“å¯¹è¯¥é¡µå®Œæˆä¸€æ¬¡è¯»å–æ—¶ï¼Œè¯¥é¡µä¾¿å˜æ›´ä¸º up-to-date çŠ¶æ€ï¼Œé™¤éå‘ç”Ÿäº†ç£ç›˜ IO é”™è¯¯</p>
<p><code>PG_dirty</code>ï¼šè¯¥é¡µä¸ºè„é¡µï¼Œå³è¯¥é¡µçš„å†…å®¹å·²è¢«ä¿®æ”¹ï¼Œåº”å½“å°½å¿«å°†å†…å®¹å†™å›ç£ç›˜ä¸Š</p>
<p><code>PG_lru</code>ï¼šè¯¥é¡µå¤„åœ¨ä¸€ä¸ª LRU é“¾è¡¨ä¸Š</p>
<p><code>PG_active</code>ï¼šè¯¥é¡µé¢ä½äºæ´»è·ƒ lru é“¾è¡¨ä¸­</p>
<p><code>PG_workingset</code>ï¼šè¯¥é¡µä½äºæŸä¸ªè¿›ç¨‹çš„å·¥ä½œé›†ï¼ˆå³ä¸€ä¸ªè¿›ç¨‹åŒæ—¶ä½¿ç”¨çš„å†…å­˜æ•°é‡ï¼Œä¾‹å¦‚ä¸€ä¸ªè¿›ç¨‹å¯èƒ½åˆ†é…äº†114514MBå†…å­˜ï¼Œä½†æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªä½¿ç”¨å…¶ä¸­çš„1919MBï¼Œè¿™å°±æ˜¯å·¥ä½œé›†ï¼‰ä¸­</p>
<p><code>PG_waiters</code>ï¼šæœ‰è¿›ç¨‹åœ¨ç­‰å¾…è¯¥é¡µé¢</p>
<p><code>PG_error</code>ï¼šè¯¥é¡µåœ¨ I&#x2F;O è¿‡ç¨‹ä¸­å‡ºç°äº†å·®é”™</p>
<p><code>PG_slab</code>ï¼šè¯¥é¡µç”± slab ä½¿ç”¨</p>
<p><code>PG_owner_priv_1</code>ï¼šè¯¥é¡µç”±å…¶æ‰€æœ‰è€…ä½¿ç”¨ï¼Œè‹¥æ˜¯ä½œä¸º pagecache é¡µé¢ï¼Œåˆ™å¯èƒ½æ˜¯è¢«æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨</p>
<p><code>PG_arch_1</code>ï¼šè¯¥æ ‡å¿—ä½ä¸ä½“ç³»ç»“æ„ç›¸å…³è”</p>
<p><code>PG_reserved</code>ï¼šè¯¥é¡µè¢«ä¿ç•™ï¼Œä¸èƒ½å¤Ÿè¢« swap outï¼ˆå†…æ ¸ä¼šå°†ä¸æ´»è·ƒçš„é¡µäº¤æ¢åˆ°ç£ç›˜ä¸Šï¼‰</p>
<p><code>PG_private</code> ï¼šè¯¥é¡µæ‹¥æœ‰ç§æœ‰æ•°æ®ï¼ˆprivate å­—æ®µï¼‰</p>
<p><code>PG_writeback</code>ï¼šè¯¥é¡µæ­£åœ¨è¢«å†™åˆ°ç£ç›˜ä¸Š</p>
<p><code>PG_head</code>ï¼šåœ¨å†…æ ¸ä¸­æœ‰æ—¶éœ€è¦å°†å¤šä¸ªé¡µç»„æˆä¸€ä¸ª compound pagesï¼Œè€Œè®¾ç½®è¯¥çŠ¶æ€æ—¶è¡¨æ˜è¯¥é¡µæ˜¯ compound pages çš„ç¬¬ä¸€ä¸ªé¡µ</p>
<p><code>PG_mappedtodisk</code>ï¼šè¯¥é¡µè¢«æ˜ å°„åˆ°ç¡¬ç›˜ä¸­</p>
<p><code>PG_reclaim</code>ï¼šè¯¥é¡µå¯ä»¥è¢«å›æ”¶</p>
<p><code>PG_swapbacked</code>ï¼šè¯¥é¡µçš„åå¤‡å­˜å‚¨å™¨ä¸º swap&#x2F;RAM</p>
<p><code>PG_unevictable</code>ï¼šè¯¥é¡µä¸å¯è¢«å›æ”¶ï¼ˆè¢«é”ï¼‰ï¼Œä¸”ä¼šå‡ºç°åœ¨ <code>LRU_UNEVICTABLE</code> é“¾è¡¨ä¸­</p>
<p><code>PG_mlocked</code>ï¼šè¯¥é¡µè¢«å¯¹åº”çš„ vma ä¸Šé”ï¼ˆé€šå¸¸æ˜¯ç³»ç»Ÿè°ƒç”¨ mlockï¼‰</p>
<p><code>PG_uncached</code>ï¼šè¯¥é¡µè¢«è®¾ç½®ä¸ºä¸å¯ç¼“å­˜</p>
<p><code>PG_hwpoison</code>ï¼šç¡¬ä»¶ç›¸å…³çš„æ ‡å¿—ä½</p>
<p><code>PG_arch_2</code>ï¼š64ä½ä¸‹çš„ä½“ç³»ç»“æ„ç›¸å…³æ ‡å¿—ä½</p>
</blockquote>
<p><code>flags</code>æ ‡å¿—ä½è¿˜å­˜åœ¨å¤ç”¨çš„æƒ…å†µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * page-&gt;flags layout:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There are five possibilities for how page-&gt;flags get laid out.  The first</span></span><br><span class="line"><span class="comment"> * pair is for the normal case without sparsemem. The second pair is for</span></span><br><span class="line"><span class="comment"> * sparsemem when there is plenty of space for node and section information.</span></span><br><span class="line"><span class="comment"> * The last is when there is insufficient space in page-&gt;flags and a separate</span></span><br><span class="line"><span class="comment"> * lookup is necessary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * No sparsemem or sparsemem vmemmap: |       NODE     | ZONE |             ... | FLAGS |</span></span><br><span class="line"><span class="comment"> *      &quot; plus space for last_cpupid: |       NODE     | ZONE | LAST_CPUPID ... | FLAGS |</span></span><br><span class="line"><span class="comment"> * classic sparse with space for node:| SECTION | NODE | ZONE |             ... | FLAGS |</span></span><br><span class="line"><span class="comment"> *      &quot; plus space for last_cpupid: | SECTION | NODE | ZONE | LAST_CPUPID ... | FLAGS |</span></span><br><span class="line"><span class="comment"> * classic sparse no space for node:  | SECTION |     ZONE    | ... | FLAGS |</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><code>flags</code>å­—æ®µä¼šä¸ºäº†èŠ‚çœå†…å­˜ä¸å…¶ä»–ç»“æ„å…±ç”¨ç©ºé—´ï¼Œå…·ä½“åˆ’åˆ†å½¢å¼ä¸å†…æ ¸é…ç½®çš„å†…å­˜æ¨¡å‹æœ‰å…³ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢è®²èµ·è¯æ°›å›´äº†äº”ç§ï¼Œå…¶å®æ˜¯ä¸‰å¤§ç§ã€‚</p>
<p>ç¬¬ä¸€ç§ï¼š<strong>ésparseå†…å­˜æ¨¡å¼</strong></p>
<p><img   src="/images/8J9pm3n1eZuTKi6.png" ></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½ä½ç”¨ä½œè¯¥ page çš„ flagï¼Œé«˜ä½åˆ†åˆ«æ ‡è¯†å…¶å½’å±çš„ zoneï¼Œ node idï¼ˆé NUMA ç³»ç»Ÿä¸­ä¸º0ï¼‰ï¼Œä¸­é—´å‰©ä½™çš„ä½ä¿ç•™ã€‚</p>
<p>ç¬¬äºŒç§ï¼š<strong>sparseå†…å­˜æ¨¡å¼</strong></p>
<p><img   src="/images/CETbQSKwV8er5OR.png" ></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç›¸æ¯”èµ·ç¬¬ä¸€ç§å½¢å¼å¤šäº†ä¸€ä¸ª SECTION å­—æ®µæ ‡è¯†å…¶å½’å±çš„ <code>mem_section</code>ã€‚</p>
<p>ç¬¬ä¸‰ç§ï¼š<strong>æ²¡æœ‰Nodeçš„sparseå†…å­˜æ¨¡å¼</strong></p>
<p>å³åœ¨ç¬¬äºŒç§çš„åŸºç¡€ä¸Šå»æ‰nodeå­—æ®µã€‚è¿™ä¸€æ¨¡å¼ä¸»è¦é€‚ç”¨äºéNUMAç³»ç»Ÿï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å–æ¶ˆäº†NODEç»“æ„ã€‚</p>
<h3 id="lruï¼šé“¾è¡¨èŠ‚ç‚¹"><a href="#lruï¼šé“¾è¡¨èŠ‚ç‚¹" class="headerlink" title="lruï¼šé“¾è¡¨èŠ‚ç‚¹"></a>lruï¼šé“¾è¡¨èŠ‚ç‚¹</h3><p>lruå¤§å®¶åº”è¯¥éƒ½æ˜¯è¾ƒä¸ºç†Ÿæ‚‰çš„ï¼Œåœ¨æ“ä½œç³»ç»Ÿè¯¾ä¸Šå­¦ä¹ è¿‡é¡µé¢ç½®æ¢ç®—æ³•ã€‚</p>
<p><img   src="/images/QbuxcXTWdzMari5.png" ></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œpageç»“æ„ä½“ç”±lruç»„ç»‡æˆé“¾è¡¨ã€‚</p>
<h3 id="slabï¼šç›¸å…³ç»“æ„ä½“"><a href="#slabï¼šç›¸å…³ç»“æ„ä½“" class="headerlink" title="slabï¼šç›¸å…³ç»“æ„ä½“"></a>slabï¼šç›¸å…³ç»“æ„ä½“</h3><p>åœ¨ä½ç‰ˆæœ¬çš„pageç»“æ„ä½“ä¸­ä¸“é—¨æœ‰ä¸€ä¸ªåŒ¿åå˜é‡ç”¨æ¥å­˜æ”¾äºslabç›¸å…³çš„æˆå‘˜çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* slab, slob and slub */</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* Partial pages */</span></span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line">					<span class="keyword">int</span> pages;	<span class="comment">/* Nr of pages left */</span></span><br><span class="line">					<span class="keyword">int</span> pobjects;	<span class="comment">/* Approximate count */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">					<span class="keyword">short</span> <span class="keyword">int</span> pages;</span><br><span class="line">					<span class="keyword">short</span> <span class="keyword">int</span> pobjects;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span> <span class="comment">/* not slob */</span></span><br><span class="line">			<span class="comment">/* Double-word boundary */</span></span><br><span class="line">			<span class="keyword">void</span> *freelist;		<span class="comment">/* first free object */</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="keyword">void</span> *s_mem;	<span class="comment">/* slab: first object */</span></span><br><span class="line">				<span class="keyword">unsigned</span> <span class="keyword">long</span> counters;		<span class="comment">/* SLUB */</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span>			<span class="comment">/* SLUB */</span></span><br><span class="line">					<span class="keyword">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line">					<span class="keyword">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line">					<span class="keyword">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br></pre></td></tr></table></figure>

<p>å…³äºslabçš„å†…å®¹å°±ä¸å¤šèµ˜è¿°äº†ï¼Œå¯ä»¥çœ‹å‰ä¸€ç¯‡æ–‡ç«  <a class="link"   target="_blank" rel="noopener" href="https://cv196082.gitee.io/2023/11/23/Pspray-Timing-Side-Channel-based-Linux-Kernel-Heap-Exploitation-Technique/" >Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique<i class="fas fa-external-link-alt"></i></a> ã€‚</p>
<h3 id="mapcountï¼šæ˜ å°„è®¡æ•°"><a href="#mapcountï¼šæ˜ å°„è®¡æ•°" class="headerlink" title="_mapcountï¼šæ˜ å°„è®¡æ•°"></a>_mapcountï¼šæ˜ å°„è®¡æ•°</h3><p>è®°å½•è¯¥é¡µè¢«é¡µè¡¨æ˜ å°„çš„æ¬¡æ•°ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰å…¶ç‹¬ç«‹çš„é¡µè¡¨ï¼Œæ•…å¯ä»¥ç†è§£ä¸ºè¯¥å€¼è®°å½•äº†è¯¥é¡µè¢«å¤šå°‘ä¸ªè¿›ç¨‹å…±äº«ï¼Œå…¶åˆå§‹å€¼ä¸º -1ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œè‹¥æ˜¯è¯¥é¡µæ²¡æœ‰è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œåˆ™ä¸º page_type å­—æ®µ</p>
<h3 id="refcountï¼šå¼•ç”¨è®¡æ•°"><a href="#refcountï¼šå¼•ç”¨è®¡æ•°" class="headerlink" title="_refcountï¼šå¼•ç”¨è®¡æ•°"></a>_refcountï¼šå¼•ç”¨è®¡æ•°</h3><p>å¼•ç”¨è®¡æ•°ç›¸æ¯”åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰çš„ï¼Œè¯¥å­—æ®µç”¨ä½œè¯¥é¡µé¢åœ¨å†…æ ¸ä¸­çš„å¼•ç”¨è®¡æ•°å™¨ï¼Œåˆå§‹æ—¶é¡µé¢ä¸ºç©ºé—²çŠ¶æ€ï¼Œè¯¥è®¡æ•°å™¨ä¸º 0ï¼Œæ¯å½“è¯¥é¡µé¢è¢«åˆ†é…å¼•ç”¨æ—¶è®¡æ•°å™¨ä¼š + 1ï¼Œè¢«å…¶ä»–é¡µé¢è¿›è¡Œå¼•ç”¨æ—¶ä¹Ÿä¼š + 1ã€‚å½“å¼•ç”¨è®¡æ•°å™¨ä¸º 0 æ—¶è¡¨ç¤ºè¯¥é¡µé¢ä¸ºç©ºé—²çŠ¶æ€æˆ–å³å°†è¦è¢«é‡Šæ”¾ï¼Œè‹¥å¤§äº 0 åˆ™è¡¨ç¤ºæ­£åœ¨è¢«ä½¿ç”¨ï¼Œæš‚æ—¶ä¸ä¼šé‡Šæ”¾ã€‚</p>
<p>å†…æ ¸ä¸­æä¾›äº†ä¸¤ä¸ªå‡½æ•° <code>get_page()</code>ä¸ <code>put_page()</code> æ¥è¿›è¡Œå¼•ç”¨è®¡æ•°çš„å¢å‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">put_page</span><span class="params">(struct page *page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">folio</span> *<span class="title">folio</span> =</span> page_folio(page);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For some devmap managed pages we need to catch refcount transition</span></span><br><span class="line"><span class="comment">	 * from 2 to 1:</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (put_devmap_managed_page(&amp;folio-&gt;page))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	folio_put(folio);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¼šè°ƒç”¨<code>folio_put</code>å‡½æ•°æ¥æ£€æµ‹æ˜¯å¦å¼•ç”¨è®¡æ•°ä¸º0ç„¶åæ˜¯å¦é‡Šæ”¾è¯¥é¡µã€‚</p>
<h3 id="virtualï¼šè™šæ‹Ÿåœ°å€"><a href="#virtualï¼šè™šæ‹Ÿåœ°å€" class="headerlink" title="virtualï¼šè™šæ‹Ÿåœ°å€"></a>virtualï¼šè™šæ‹Ÿåœ°å€</h3><p>è¯¥å­—æ®µä¸ºè¯¥ç‰©ç†é¡µæ¡†å¯¹åº”çš„çš„è™šæ‹Ÿåœ°å€</p>
<p><img   src="/images/q6jTAJkU9XuCHWV.png" ></p>
<p>æ¯ä¸€ä¸ª struct page å¯¹åº”ä¸€ä¸ªç‰©ç†é¡µæ¡†ï¼Œé‚£ä¹ˆè¿™ä¸ª virtual å­—æ®µå…¶å®å°±æ˜¯ä¸Šå›¾çš„åå‘æ˜ å°„ã€‚</p>
<h2 id="ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct-pageå­˜å‚¨æ–¹å¼"><a href="#ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct-pageå­˜å‚¨æ–¹å¼" class="headerlink" title="ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct pageå­˜å‚¨æ–¹å¼"></a>ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct pageå­˜å‚¨æ–¹å¼</h2><p><img   src="/images/wLzFuCB5n1DAIY7.png" ></p>
<p>Linux æä¾›äº†ä¸Šå›¾ä¸­çš„ä¸‰ç§å†…å­˜æ¨¡å‹ï¼Œå†…å­˜æ¨¡å‹åœ¨ç¼–è¯‘æ—¶å°±ä¼šè¢«ç¡®å®šä¸‹æ¥ï¼Œç›®å‰æœ€ä¸ºå¸¸ç”¨çš„æ˜¯<code>Sparse Memory</code>æ¨¡å‹ã€‚</p>
<h3 id="Flat-Memory"><a href="#Flat-Memory" class="headerlink" title="Flat Memory"></a>Flat Memory</h3><p>å¹³æ»‘å†…å­˜æ¨¡å‹ã€‚ç‰©ç†å†…å­˜åœ°å€è¿ç»­ï¼Œæœ‰ä¸€ä¸ª<strong>å…¨å±€å˜é‡</strong> <code>mem_map</code> ç”±ä¸€ä¸ªå¤§çš„<code>struct page</code>æ•°ç»„ç›´æ¥å¯¹åº”ç°æœ‰çš„ç‰©ç†å†…å­˜</p>
<h3 id="Discontiguous-Memory"><a href="#Discontiguous-Memory" class="headerlink" title="Discontiguous Memory"></a>Discontiguous Memory</h3><p>éè¿ç»­æ€§å†…å­˜æ¨¡å‹ï¼Œå¯¹äºæ¯ä¸€æ®µè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œéƒ½æœ‰ä¸€ä¸ª <code>pglist_data</code> ç»“æ„ä½“è¿›è¡Œå¯¹åº”ï¼Œå…¶æˆå‘˜ <code>node_mem_map</code> ä¸ºä¸€ä¸ª<code>struct page</code>æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª page ç»“æ„ä½“æ•°ç»„ï¼Œç”±è¯¥ç»“æ„ä½“å¯¹åº”åˆ°è¯¥æ®µè¿ç»­ç‰©ç†å†…å­˜ã€‚æœ‰ä¸€ä¸ª<strong>å…¨å±€å˜é‡</strong> <code>node_data</code> ä¸ºä¸€ä¸ª<code>pglist_data</code>æŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­å­˜æ”¾ç€æŒ‡å‘æ¯ä¸€ä¸ª<code>pglist_data</code>çš„æŒ‡é’ˆï¼Œè¯¥æ•°ç»„çš„å¤§å°ä¸º <code>MAX_NUMNODES</code>ã€‚ä¸»è¦é’ˆå¯¹å†…å­˜ä¸­å­˜åœ¨ç©ºæ´çš„æƒ…å†µã€‚</p>
<h3 id="Sparse-Memory"><a href="#Sparse-Memory" class="headerlink" title="Sparse Memory"></a>Sparse Memory</h3><p>ç¦»æ•£å†…å­˜æ¨¡å‹ï¼Œåœ¨ä¸€ä¸ª<code>mem_section</code>ç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ª <code>section_mem_map</code> æˆå‘˜æŒ‡å‘ä¸€ä¸ª<code>struct page</code>æ•°ç»„å¯¹åº”ä¸€æ®µè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå³å°†å†…å­˜æŒ‰ç…§ section ä¸ºå•ä½è¿›è¡Œåˆ†æ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * This is, logically, a pointer to an array of struct</span></span><br><span class="line"><span class="comment">	 * pages.  However, it is stored with some other magic.</span></span><br><span class="line"><span class="comment">	 * (see sparse.c::sparse_init_one_section())</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Additionally during early boot we encode node id of</span></span><br><span class="line"><span class="comment">	 * the location of the section here to guide allocation.</span></span><br><span class="line"><span class="comment">	 * (see sparse.c::memory_present())</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Making it a UL at least makes someone do a cast</span></span><br><span class="line"><span class="comment">	 * before using it wrong.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> section_mem_map;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_section_usage</span> *<span class="title">usage</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If SPARSEMEM, pgdat doesn&#x27;t have page_ext pointer. We use</span></span><br><span class="line"><span class="comment">	 * section. (see page_ext.h about this.)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page_ext</span> *<span class="title">page_ext</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pad;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * WARNING: mem_section must be a power-of-2 in size for the</span></span><br><span class="line"><span class="comment">	 * calculation and use of SECTION_ROOT_MASK to make sense.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å­˜åœ¨ä¸€ä¸ªå…¨å±€æŒ‡é’ˆæ•°ç»„ <code>mem_section</code> ï¼ˆä¸ç»“æ„ä½“åŒåï¼‰å­˜æ”¾æ‰€æœ‰çš„ <code>mem_section</code> æŒ‡é’ˆï¼ŒæŒ‡å‘ç†è®ºä¸Šæ”¯æŒçš„å†…å­˜ç©ºé—´ï¼Œæ¯ä¸ª section å¯¹åº”çš„ç‰©ç†å†…å­˜ä¸ä¸€å®šå­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ­¤æ—¶è¯¥ section çš„æŒ‡é’ˆä¸º NULLã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> **<span class="title">mem_section</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> <span class="title">mem_section</span>[<span class="title">NR_SECTION_ROOTS</span>][<span class="title">SECTIONS_PER_ROOT</span>]</span></span><br><span class="line"><span class="class">	____<span class="title">cacheline_internodealigned_in_smp</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>è‹¥æœªå¼€å¯<code>CONFIG_SPARSEMEM_EXTREME</code>ç¼–è¯‘é€‰é¡¹åˆ™ mem_section ä¸ºä¸€ä¸ªå¸¸è§„çš„<strong>äºŒç»´æ•°ç»„</strong>ï¼Œå¦åˆ™ä¸ºä¸€ä¸ª<strong>äºŒçº§æŒ‡é’ˆ</strong>ï¼Œå…¶æ‰€æŒ‡å‘ç©ºé—´å†…å­˜åŠ¨æ€åˆ†é…ã€‚</p>
<p><img   src="/images/RN47OEoaM31xQhA.png" ></p>
<p>è¿™ç§æ¨¡å‹æ”¯æŒå†…å­˜çš„çƒ­æ‹”æ’ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„åˆ°çš„æ˜¯ï¼Œåœ¨<code>struct mem_section</code>ç»“æ„ä½“ä¸­çš„<code>section_mem_map</code>æˆå‘˜çš„å®šä¹‰å¹¶éæ˜¯<code>struct page*</code>è€Œæ˜¯<code>unsigned long</code>ç±»å‹çš„ï¼Œå…¶è®°å½•çš„å…¶å®æ˜¯ page æ•°ç»„ä¸PFNä¹‹é—´çš„å·®å€¼<code>section_mem_map = page_arr_addr - PFN_start</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_SPARSEMEM)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note: section&#x27;s mem_map is encoded to reflect its start_pfn.</span></span><br><span class="line"><span class="comment"> * section[i].section_mem_map == mem_map&#x27;s address - start_pfn;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(pg)					\</span></span><br><span class="line"><span class="meta">(&#123;	const struct page *__pg = (pg);				\</span></span><br><span class="line"><span class="meta">	int __sec = page_to_section(__pg);			\</span></span><br><span class="line"><span class="meta">	(unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec)));	\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)				\</span></span><br><span class="line"><span class="meta">(&#123;	unsigned long __pfn = (pfn);			\</span></span><br><span class="line"><span class="meta">	struct mem_section *__sec = __pfn_to_section(__pfn);	\</span></span><br><span class="line"><span class="meta">	__section_mem_map_addr(__sec) + __pfn;		\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_FLATMEM/SPARSEMEM */</span></span></span><br></pre></td></tr></table></figure>

<p>åœ¨å†…æ ¸ä¸­ä¹Ÿæä¾›äº† PFN å’Œ page ä¹‹é—´è½¬åŒ–çš„ä¸¤ä¸ªå®å®šä¹‰ï¼Œè¿™é‡Œè¯¦ç»†åˆ†æä¸€ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(pg)					\</span></span><br><span class="line"><span class="meta">(&#123;	const struct page *__pg = (pg);				\</span></span><br><span class="line"><span class="meta">	int __sec = page_to_section(__pg);			\</span></span><br><span class="line"><span class="meta">	(unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec)));	\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆçœ‹pageåˆ°PFNçš„è¿‡ç¨‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">page_to_section</span><span class="params">(<span class="keyword">const</span> struct page *page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (page-&gt;flags &gt;&gt; SECTIONS_PGSHIFT) &amp; SECTIONS_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šä½¿ç”¨<code>page_to_setion</code>å‡½æ•°ï¼Œå…¶å‡½æ•°å†…éƒ¨å®ç°æ˜¯é€šè¿‡<code>page-&gt;flags</code>è·å–åˆ°pageæ‰€å±çš„sectionæ ‡å·ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> *__<span class="title">nr_to_section</span>(<span class="title">unsigned</span> <span class="title">long</span> <span class="title">nr</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> root = SECTION_NR_TO_ROOT(nr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(root &gt;= NR_SECTION_ROOTS))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line">	<span class="keyword">if</span> (!mem_section || !mem_section[root])</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> &amp;mem_section[root][nr &amp; SECTION_ROOT_MASK];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éšåé€šè¿‡è°ƒç”¨<code>__nr_to_section</code>å‡½æ•°è·å¾—å¯¹åº”<code>mem_section</code>ç»“æ„ä½“çš„åœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTIONS_PER_ROOT       (PAGE_SIZE / sizeof (struct mem_section))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTIONS_PER_ROOT	1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_NR_TO_ROOT(sec)	((sec) / SECTIONS_PER_ROOT)</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé»˜è®¤å¼€å¯<code>CONFIG_SPARSEMEM_EXTREME</code>ï¼Œæ­¤æ—¶<code>SECTIONS_PER_ROOT</code>å«ä¹‰ä¸ºä¸€é¡µä¸­<code>struct mem_section</code>çš„æ•°é‡ï¼Œæ‰€ä»¥<code>SECTION_NR_TO_ROOT</code>å®å¾—åˆ°çš„æ˜¯å¯¹åº”çš„é¡µä¸‹è¡¨ï¼Œæœ€åé€šè¿‡<code>nr &amp; SECTION_ROOT_MASK</code>è·å¾—åœ¨è¯¥é¡µä¸‹çš„<code>mem_section</code>æ•°ç»„ä¸‹æ ‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">section_mem_map_addr</span>(<span class="keyword">struct</span> <span class="title">mem_section</span> *<span class="title">section</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">map</span> = section-&gt;section_mem_map;</span><br><span class="line">	<span class="built_in">map</span> &amp;= SECTION_MAP_MASK;</span><br><span class="line">	<span class="keyword">return</span> (struct page *)<span class="built_in">map</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹‹åé€šè¿‡<code>__section_mem_map_addr</code>è·å–<code>mem_section</code>ç»“æ„ä½“ä¸­<code>section_mem_map</code>æˆå‘˜ï¼Œæœ€åä¸pageç»“æ„ä½“çš„åœ°å€åšå·®è¿ç®—ä¾¿èƒ½è·å¾—å…¶PFNï¼Œæ ¹æ®å‰é¢çš„æ¡ä»¶å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„è¿ç®—å†™æ³•å…¶å®æ˜¯<code>(page_addr - page_arr_addr) + PFN_start = PFN</code>ã€‚</p>
<p>æ¥ä¸‹çœ‹ä¸€ä¸‹<code>__pfn_to_page</code>äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)				\</span></span><br><span class="line"><span class="meta">(&#123;	unsigned long __pfn = (pfn);			\</span></span><br><span class="line"><span class="meta">	struct mem_section *__sec = __pfn_to_section(__pfn);	\</span></span><br><span class="line"><span class="meta">	__section_mem_map_addr(__sec) + __pfn;		\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_SECTION_SHIFT	(SECTION_SIZE_BITS - PAGE_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">pfn_to_section_nr</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> pfn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> pfn &gt;&gt; PFN_SECTION_SHIFT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> *__<span class="title">pfn_to_section</span>(<span class="title">unsigned</span> <span class="title">long</span> <span class="title">pfn</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">return</span> __nr_to_section(pfn_to_section_nr(pfn));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆè°ƒç”¨<code>__pfn_to_section</code>å‡½æ•°æ¥è·å¾—PFNå¯¹åº”çš„<code>mem_section</code>ã€‚é¦–å…ˆé€šè¿‡è°ƒç”¨<code>pfn_to_section_nr</code>å‡½æ•°è·å–å¯¹åº”sectionçš„ç´¢å¼•ã€‚å¯ä»¥çœ‹åˆ°å‡½æ•°ä¸­ä½¿ç”¨åˆ°äº†<code>PFN_SECTION_SHIFT</code>ï¼Œè€Œå…¶å®šä¹‰ä¸º<code>SECTION_SIZE_BITS</code>å‡å»<code>PAGE_SHIFT</code>ï¼Œå…¶ä¸­<code>SECTION_SIZE_BITS</code>çš„å«ä¹‰ä¸ºä¸€ä¸ªsectionæ‰€å çš„ä½æ•°ï¼Œåé¢åˆ™æ˜¯å¾ˆç†Ÿæ‚‰çš„ä¸€ä¸ªé¡µçš„ä½æ•°ï¼Œæ‰€ä»¥<code>PFN_SECTION_SHIFT</code>å«ä¹‰ä¸ºä¸€ä¸ªsectionä¸­é¡µçš„æ•°é‡ã€‚</p>
<p>è€Œ<code>pfn_to_section_nr</code>å‡½æ•°å†…éƒ¨å®ç°ä¸ºä½¿ç”¨é¡µæ¡†å·å‘å³ç§»ä½ä¸€ä¸ªsectionä¸­é¡µçš„æ•°é‡æœ€ç»ˆå¾—åˆ°çš„æ˜¯å½“å‰é¡µåœ¨sectionä¸­çš„æ ‡å·ã€‚</p>
<p>éšåè°ƒç”¨<code>__nr_to_section</code>å‡½æ•°è·å–å¯¹åº”<code>mem_section</code>åœ°å€ï¼Œæœ€åä½¿ç”¨<code>__section_mem_map_addr</code>å‡½æ•°è·å–åˆ°<code>section_mem_map</code>æˆå‘˜å†ä¸é¡µæ¡†å·åšåŠ æ³•ï¼Œæ ¹æ®å‰é¢çš„æ¡ä»¶è¿™é‡Œæœ€ç»ˆè¿ç®—çš„å†™æ³•å¯ä»¥å†™ä½œ<code>(PFN - PFN_start) + page_arr_addr = page_addr </code>ã€‚</p>
<p><strong>æœ€åï¼ŒåŸºäºSparse Memory å†…å­˜æ¨¡å‹ä¸Šå¼•å…¥äº† vmemmap çš„æ¦‚å¿µï¼Œæ˜¯ç›®å‰ Linux æœ€å¸¸ç”¨çš„å†…å­˜æ¨¡å‹ä¹‹ä¸€ã€‚</strong></p>
<p><img   src="/images/mnAUkENCoRwjtpq.png" ></p>
<p>åœ¨å¼€å¯äº†<code>vmemmap</code>ä¹‹åï¼Œæ‰€æœ‰çš„<code>mem_section</code>ä¸­çš„ page éƒ½æŠ½è±¡åˆ°ä¸€ä¸ªè™šæ‹Ÿæ•°ç»„<code>vmemmap</code>ä¸­ï¼Œè¿™æ ·åœ¨è¿›è¡Œ<code>struct page *</code>å’Œ pfn è½¬æ¢æ—¶ï¼Œç›´æ¥ä½¿ç”¨<code>vmemmap</code>æ•°ç»„å³å¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_SPARSEMEM_VMEMMAP)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* memmap is virtually contiguous.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)	(vmemmap + (pfn))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(page)	(unsigned long)((page) - vmemmap)</span></span><br></pre></td></tr></table></figure>

<h2 id="struct-zone"><a href="#struct-zone" class="headerlink" title="struct zone"></a>struct zone</h2><p>åœ¨ Linux ä¸‹å°†ä¸€ä¸ªèŠ‚ç‚¹å†…ä¸åŒç”¨é€”çš„å†…å­˜åŒºåŸŸåˆ’åˆ†ä¸ºä¸åŒçš„åŒºå³<code>zone</code>ï¼Œå¯¹åº”ç»“æ„ä½“ <code>struct zone</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Read-mostly fields */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* zone watermarks, access with *_wmark_pages(zone) macros */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> _watermark[NR_WMARK];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> watermark_boost;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_reserved_highatomic;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We don&#x27;t know if the memory that we&#x27;re going to allocate will be</span></span><br><span class="line"><span class="comment">	 * freeable or/and it will be released eventually, so to avoid totally</span></span><br><span class="line"><span class="comment">	 * wasting several GB of ram we must reserve some of the lower zone</span></span><br><span class="line"><span class="comment">	 * memory (otherwise we risk to run OOM on the lower zones despite</span></span><br><span class="line"><span class="comment">	 * there being tons of freeable ram on the higher zones).  This array is</span></span><br><span class="line"><span class="comment">	 * recalculated at runtime if the sysctl_lowmem_reserve_ratio sysctl</span></span><br><span class="line"><span class="comment">	 * changes.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">long</span> lowmem_reserve[MAX_NR_ZONES];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="keyword">int</span> node;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span>	*<span class="title">zone_pgdat</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span>	__<span class="title">percpu</span> *<span class="title">per_cpu_pageset</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_zonestat</span>	__<span class="title">percpu</span> *<span class="title">per_cpu_zonestats</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * the high and batch values are copied to individual pagesets for</span></span><br><span class="line"><span class="comment">	 * faster access</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">int</span> pageset_high;</span><br><span class="line">	<span class="keyword">int</span> pageset_batch;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SPARSEMEM</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Flags for a pageblock_nr_pages block. See pageblock-flags.h.</span></span><br><span class="line"><span class="comment">	 * In SPARSEMEM, this map is stored in struct mem_section</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		*pageblock_flags;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_SPARSEMEM */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* zone_start_pfn == zone_start_paddr &gt;&gt; PAGE_SHIFT */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		zone_start_pfn;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * spanned_pages is the total pages spanned by the zone, including</span></span><br><span class="line"><span class="comment">	 * holes, which is calculated as:</span></span><br><span class="line"><span class="comment">	 * 	spanned_pages = zone_end_pfn - zone_start_pfn;</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * present_pages is physical pages existing within the zone, which</span></span><br><span class="line"><span class="comment">	 * is calculated as:</span></span><br><span class="line"><span class="comment">	 *	present_pages = spanned_pages - absent_pages(pages in holes);</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * present_early_pages is present pages existing within the zone</span></span><br><span class="line"><span class="comment">	 * located on memory available since early boot, excluding hotplugged</span></span><br><span class="line"><span class="comment">	 * memory.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * managed_pages is present pages managed by the buddy system, which</span></span><br><span class="line"><span class="comment">	 * is calculated as (reserved_pages includes pages allocated by the</span></span><br><span class="line"><span class="comment">	 * bootmem allocator):</span></span><br><span class="line"><span class="comment">	 *	managed_pages = present_pages - reserved_pages;</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * cma pages is present pages that are assigned for CMA use</span></span><br><span class="line"><span class="comment">	 * (MIGRATE_CMA).</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * So present_pages may be used by memory hotplug or memory power</span></span><br><span class="line"><span class="comment">	 * management logic to figure out unmanaged pages by checking</span></span><br><span class="line"><span class="comment">	 * (present_pages - managed_pages). And managed_pages should be used</span></span><br><span class="line"><span class="comment">	 * by page allocator and vm scanner to calculate all kinds of watermarks</span></span><br><span class="line"><span class="comment">	 * and thresholds.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Locking rules:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * zone_start_pfn and spanned_pages are protected by span_seqlock.</span></span><br><span class="line"><span class="comment">	 * It is a seqlock because it has to be read outside of zone-&gt;lock,</span></span><br><span class="line"><span class="comment">	 * and it is done in the main allocator path.  But, it is written</span></span><br><span class="line"><span class="comment">	 * quite infrequently.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The span_seq lock is declared along with zone-&gt;lock because it is</span></span><br><span class="line"><span class="comment">	 * frequently read in proximity to zone-&gt;lock.  It&#x27;s good to</span></span><br><span class="line"><span class="comment">	 * give them a chance of being in the same cacheline.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Write access to present_pages at runtime should be protected by</span></span><br><span class="line"><span class="comment">	 * mem_hotplug_begin/done(). Any reader who can&#x27;t tolerant drift of</span></span><br><span class="line"><span class="comment">	 * present_pages should use get_online_mems() to get a stable value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span>		managed_pages;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		spanned_pages;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		present_pages;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_MEMORY_HOTPLUG)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		present_early_pages;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		cma_pages;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Number of isolated pageblock. It is used to solve incorrect</span></span><br><span class="line"><span class="comment">	 * freepage counting problem due to racy retrieving migratetype</span></span><br><span class="line"><span class="comment">	 * of pageblock. Protected by zone-&gt;lock.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nr_isolate_pageblock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line">	<span class="comment">/* see spanned/present_pages for more description */</span></span><br><span class="line">	<span class="keyword">seqlock_t</span>		span_seqlock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> initialized;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write-intensive fields used from the page allocator */</span></span><br><span class="line">	CACHELINE_PADDING(_pad1_);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* free areas of different sizes */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">free_area</span>	<span class="title">free_area</span>[<span class="title">MAX_ORDER</span> + 1];</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_UNACCEPTED_MEMORY</span></span><br><span class="line">	<span class="comment">/* Pages to be accepted. All pages on the list are MAX_ORDER */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">unaccepted_pages</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* zone flags, see below */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Primarily protects free_area */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span>		lock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write-intensive fields used by compaction and vmstats. */</span></span><br><span class="line">	CACHELINE_PADDING(_pad2_);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When free pages are below this point, additional steps are taken</span></span><br><span class="line"><span class="comment">	 * when reading the number of free pages to avoid per-cpu counter</span></span><br><span class="line"><span class="comment">	 * drift allowing watermarks to be breached</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> percpu_drift_mark;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line">	<span class="comment">/* pfn where compaction free scanner should start */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		compact_cached_free_pfn;</span><br><span class="line">	<span class="comment">/* pfn where compaction migration scanner should start */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		compact_cached_migrate_pfn[ASYNC_AND_SYNC];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		compact_init_migrate_pfn;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		compact_init_free_pfn;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On compaction failure, 1&lt;&lt;compact_defer_shift compactions</span></span><br><span class="line"><span class="comment">	 * are skipped before trying again. The number attempted since</span></span><br><span class="line"><span class="comment">	 * last failure is tracked with compact_considered.</span></span><br><span class="line"><span class="comment">	 * compact_order_failed is the minimum compaction failed order.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		compact_considered;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		compact_defer_shift;</span><br><span class="line">	<span class="keyword">int</span>			compact_order_failed;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line">	<span class="comment">/* Set to true when the PG_migrate_skip bits should be cleared */</span></span><br><span class="line">	<span class="keyword">bool</span>			compact_blockskip_flush;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span>			contiguous;</span><br><span class="line"></span><br><span class="line">	CACHELINE_PADDING(_pad3_);</span><br><span class="line">	<span class="comment">/* Zone statistics */</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span>		vm_stat[NR_VM_ZONE_STAT_ITEMS];</span><br><span class="line">	<span class="keyword">atomic_long_t</span>		vm_numa_event[NR_VM_NUMA_EVENT_ITEMS];</span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure>

<h3 id="watermarkï¼šæ°´ä½çº¿"><a href="#watermarkï¼šæ°´ä½çº¿" class="headerlink" title="_watermarkï¼šæ°´ä½çº¿"></a>_watermarkï¼šæ°´ä½çº¿</h3><p>æ¯ä¸€ä¸ª zone éƒ½æœ‰ç€å…¶å¯¹åº”çš„ä¸‰æ¡£â€œæ°´ä½çº¿â€ï¼š <code>WMARK_MIN</code>ã€<code>WMARK_LOW</code>ã€<code>WMARK_HIGH</code>ï¼Œå­˜æ”¾åœ¨ _watermark æ•°ç»„ä¸­ï¼Œåœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œåˆ†é…å™¨ï¼ˆä¾‹å¦‚ buddy systemï¼‰ä¼šæ ¹æ®å½“å‰ zone ä¸­ç©ºä½™å†…å­˜æ‰€å¤„åœ¨çš„â€œæ°´ä½çº¿â€æ¥åˆ¤æ–­å½“å‰çš„å†…å­˜çŠ¶å†µã€‚åœ¨è¿›è¡Œå†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œå¦‚æœåˆ†é…å™¨ï¼ˆæ¯”å¦‚buddy allocatorï¼‰å‘ç°å½“å‰ç©ºä½™å†…å­˜çš„å€¼ä½äºâ€lowâ€ä½†é«˜äºâ€minâ€ï¼Œè¯´æ˜ç°åœ¨å†…å­˜é¢ä¸´ä¸€å®šçš„å‹åŠ›ï¼Œé‚£ä¹ˆåœ¨æ­¤æ¬¡å†…å­˜åˆ†é…å®Œæˆåï¼Œkswapdå°†è¢«å”¤é†’ï¼Œä»¥æ‰§è¡Œå†…å­˜å›æ”¶æ“ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†…å­˜åˆ†é…è™½ç„¶ä¼šè§¦å‘å†…å­˜å›æ”¶ï¼Œä½†ä¸å­˜åœ¨è¢«å†…å­˜å›æ”¶æ‰€é˜»å¡çš„é—®é¢˜ï¼Œä¸¤è€…çš„æ‰§è¡Œå…³ç³»æ˜¯å¼‚æ­¥çš„ï¼ˆä¹‹å‰çš„kswapdå®ç°æ˜¯å‘¨æœŸæ€§è§¦å‘ï¼‰ã€‚â€lowâ€å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªè­¦æˆ’æ°´ä½çº¿ï¼Œè€Œâ€highâ€åˆ™æ˜¯ä¸€ä¸ªå®‰å…¨çš„æ°´ä½çº¿ã€‚</p>
<p><img   src="/images/8OuZhEfjHIy9AeL.png" ></p>
<h3 id="lowmem-reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜"><a href="#lowmem-reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜" class="headerlink" title="lowmem_reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜"></a>lowmem_reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜</h3><p>åœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œè‹¥å½“å‰çš„ zone æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜äº†ï¼Œåˆ™ä¼šå‘ä¸‹ä¸€ä¸ª zone ç´¢è¦å†…å­˜ï¼Œé‚£ä¹ˆè¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šæ¥è‡ª higher zones çš„å†…å­˜åˆ†é…è¯·æ±‚å¯èƒ½è€—å°½ lower zones çš„å†…å­˜ï¼Œä½†è¿™æ ·åˆ†é…çš„å†…å­˜æœªå¿…æ˜¯å¯é‡Šæ”¾çš„ï¼ˆfreeableï¼‰ï¼Œäº¦æˆ–è€…&#x2F;ä¸”æœ€ç»ˆä¸ä¸€å®šä¼šè¢«é‡Šæ”¾ï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´ lower zones çš„å†…å­˜æå‰è€—å°½ï¼Œè€Œ higher zones å´ä»ä¿ç•™æœ‰å¤§é‡çš„å†…å­˜</p>
<p>ä¸ºäº†é¿å…è¿™æ ·çš„ä¸€ç§æƒ…å†µçš„å‘ç”Ÿï¼Œ<code>lowmem_reserve</code> å­—æ®µç”¨ä»¥å£°æ˜ä¸ºè¯¥ zone ä¿ç•™çš„å†…å­˜ï¼Œè¿™ä¸€å—å†…å­˜åˆ«çš„ zone æ˜¯ä¸èƒ½åŠ¨çš„</p>
<h3 id="nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node"><a href="#nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node" class="headerlink" title="nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node"></a>nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node</h3><p>åªæœ‰åœ¨<code>CONFIG_NUMA</code>å³å¼€å¯NUMAæ—¶è¯¥å­—æ®µæ‰ä¼šè¢«å¯ç”¨ï¼Œç”¨æ¥æ ‡è¯†è¯¥zoneæ‰€å±çš„nodeã€‚</p>
<p><img   src="/images/uwbo53W2Mjh1gOm.png" ></p>
<h3 id="zone-pgdatï¼šzone-æ‰€å±çš„-pglist-data-èŠ‚ç‚¹"><a href="#zone-pgdatï¼šzone-æ‰€å±çš„-pglist-data-èŠ‚ç‚¹" class="headerlink" title="zone_pgdatï¼šzone æ‰€å±çš„ pglist_data èŠ‚ç‚¹"></a>zone_pgdatï¼šzone æ‰€å±çš„ pglist_data èŠ‚ç‚¹</h3><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone æ‰€å±çš„ pglist_data èŠ‚ç‚¹</p>
<h3 id="per-cpu-pagesetï¼šzone-ä¸ºæ¯ä¸ª-CPU-åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ"><a href="#per-cpu-pagesetï¼šzone-ä¸ºæ¯ä¸ª-CPU-åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ" class="headerlink" title="per_cpu_pagesetï¼šzone ä¸ºæ¯ä¸ª CPU åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ"></a>per_cpu_pagesetï¼šzone ä¸ºæ¯ä¸ª CPU åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ</h3><p>ä¼—æ‰€å‘¨çŸ¥ä¼´éšç€å¤š CPU çš„å¼•å…¥ï¼Œæ¡ä»¶ç«äº‰å°±æ˜¯ä¸€ä¸ªä¸å¯å¿½è§†çš„é—®é¢˜ï¼Œå½“å¤šä¸ª CPU éœ€è¦å¯¹ä¸€ä¸ª zone è¿›è¡Œæ“ä½œæ—¶ï¼Œé¢‘ç¹çš„åŠ é”&#x2F;è§£é”æ“ä½œåˆ™æ¯«æ— ç–‘é—®ä¼šé€ æˆå¤§é‡çš„å¼€é”€ï¼Œå› æ­¤ zone å¼•å…¥äº† <code>per_cpu_pageset</code> ç»“æ„ä½“æˆå‘˜ï¼Œå³ä¸ºæ¯ä¸€ä¸ª CPU éƒ½å‡†å¤‡ä¸€ä¸ªå•ç‹¬çš„é¡µé¢ä»“åº“ï¼Œå› æ­¤å…¶å®ç°æ–¹å¼æ˜¯å®ç°ä¸ºä¸€ä¸ª <code>percpu</code> å˜é‡ã€‚åœ¨ä¸€å¼€å§‹æ—¶<code>buddy system</code>ä¼šå°†é¡µé¢æ”¾ç½®åˆ°å„ä¸ª CPU è‡ªå·±ç‹¬ç«‹çš„é¡µé¢ä»“åº“ä¸­ï¼Œéœ€è¦è¿›è¡Œåˆ†é…æ—¶ CPU ä¼˜å…ˆä»è‡ªå·±çš„é¡µé¢ä»“åº“ä¸­åˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> &#123;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> lock;	<span class="comment">/* Protects lists field */</span></span><br><span class="line">	<span class="keyword">int</span> count;		<span class="comment">/* number of pages in the list */</span></span><br><span class="line">	<span class="keyword">int</span> high;		<span class="comment">/* high watermark, emptying needed */</span></span><br><span class="line">	<span class="keyword">int</span> batch;		<span class="comment">/* chunk size for buddy add/remove */</span></span><br><span class="line">	<span class="keyword">short</span> free_factor;	<span class="comment">/* batch scaling factor during free */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="keyword">short</span> expire;		<span class="comment">/* When 0, remote pagesets are drained */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Lists of pages, one per migrate type stored on the pcp-lists */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lists</span>[<span class="title">NR_PCP_LISTS</span>];</span></span><br><span class="line">&#125; ____cacheline_aligned_in_smp;</span><br></pre></td></tr></table></figure>

<p>è¯¥ç»“æ„ä½“ä¼šè¢«å­˜æ”¾åœ¨æ¯ä¸ª CPU è‡ªå·±ç‹¬ç«‹çš„ <code>.data..percpu</code> æ®µä¸­ã€‚</p>
<h3 id="vm-statï¼šç»Ÿè®¡æ•°æ®"><a href="#vm-statï¼šç»Ÿè®¡æ•°æ®" class="headerlink" title="vm_statï¼šç»Ÿè®¡æ•°æ®"></a>vm_statï¼šç»Ÿè®¡æ•°æ®</h3><p>è¯¥æ•°ç»„ç”¨æ¥è¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼ŒæŒ‰ç…§æšä¸¾ç±»å‹ <code>zone_stat_item</code> åˆ†ä¸ºå¤šä¸ªæ•°ç»„ï¼Œä»¥ç»Ÿè®¡ä¸åŒç±»å‹çš„æ•°æ®ï¼ˆæ¯”å¦‚è¯´ <code>NR_FREE_PAGES</code> è¡¨ç¤º zone ä¸­çš„ç©ºé—²é¡µé¢1æ•°é‡ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_stat_item</span> &#123;</span></span><br><span class="line">	<span class="comment">/* First 128 byte cacheline (assuming 64 bit words) */</span></span><br><span class="line">	NR_FREE_PAGES,</span><br><span class="line">	NR_ZONE_LRU_BASE, <span class="comment">/* Used only for compaction and reclaim retry */</span></span><br><span class="line">	NR_ZONE_INACTIVE_ANON = NR_ZONE_LRU_BASE,</span><br><span class="line">	NR_ZONE_ACTIVE_ANON,</span><br><span class="line">	NR_ZONE_INACTIVE_FILE,</span><br><span class="line">	NR_ZONE_ACTIVE_FILE,</span><br><span class="line">	NR_ZONE_UNEVICTABLE,</span><br><span class="line">	NR_ZONE_WRITE_PENDING,	<span class="comment">/* Count of dirty, writeback and unstable pages */</span></span><br><span class="line">	NR_MLOCK,		<span class="comment">/* mlock()ed pages found and moved off LRU */</span></span><br><span class="line">	<span class="comment">/* Second 128 byte cacheline */</span></span><br><span class="line">	NR_BOUNCE,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_ZSMALLOC)</span></span><br><span class="line">	NR_ZSPAGES,		<span class="comment">/* allocated in zsmalloc */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	NR_FREE_CMA_PAGES,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_UNACCEPTED_MEMORY</span></span><br><span class="line">	NR_UNACCEPTED,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	NR_VM_ZONE_STAT_ITEMS &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="free-areaï¼šbuddy-system-æŒ‰ç…§-order-ç®¡ç†çš„é¡µé¢"><a href="#free-areaï¼šbuddy-system-æŒ‰ç…§-order-ç®¡ç†çš„é¡µé¢" class="headerlink" title="free_areaï¼šbuddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢"></a>free_areaï¼šbuddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</h3><p>è¯¥å­—æ®µç”¨ä»¥å­˜å‚¨<code>buddy system</code>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢ï¼Œä¸ºä¸€ä¸ª <code>free_area</code> ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nr_free;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨ free_area ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«çš„ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„</p>
<p><img   src="/images/sOwdI5YMNUjLSib.png" ></p>
<p>free_area ä¸­å¹¶éåªæœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸åŒçš„â€œè¿ç§»ç±»å‹â€ï¼ˆmigrate typeï¼‰è¿›è¡Œåˆ†å¼€å­˜æ”¾ï¼Œè¿™æ˜¯ç”±äºé¡µé¢è¿ç§»æœºåˆ¶çš„å­˜åœ¨ã€‚</p>
<p><img   src="/images/sbNImKo6tBS5GUe.png" ></p>
<h3 id="åç»­æˆå‘˜"><a href="#åç»­æˆå‘˜" class="headerlink" title="åç»­æˆå‘˜"></a>åç»­æˆå‘˜</h3><p><strong>zone_start_pfnï¼šzone çš„èµ·å§‹ç‰©ç†PFN</strong></p>
<p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone çš„èµ·å§‹ç‰©ç†é¡µå¸§å·ã€‚</p>
<p><strong>spanned_pagesï¼šzone å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„ pages æ€»æ•°ï¼ˆåŒ…æ‹¬ç©ºæ´ï¼‰</strong></p>
<p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„ pages æ€»æ•°, <strong>åŒ…æ‹¬ç©ºæ´</strong></p>
<p><strong>present_pagesï¼š zone ä¸­å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°</strong></p>
<p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯† zone ä¸­å®é™…å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°</p>
<p><strong>managed_pagesï¼šzone ä¸­ buddy system ç®¡ç†çš„é¡µé¢æ•°é‡</strong></p>
<p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯† zone ä¸­ buddy system ç®¡ç†çš„é¡µé¢æ•°é‡</p>
<p><strong>flagsï¼šæ ‡å¿—ä½</strong></p>
<p>è¯¥ zone çš„æ ‡å¿—ä½ï¼Œç”¨ä»¥æ ‡è¯†å…¶æ‰€å¤„çš„çŠ¶æ€</p>
<h3 id="é¡µé¢è¿ç§»æœºåˆ¶"><a href="#é¡µé¢è¿ç§»æœºåˆ¶" class="headerlink" title="é¡µé¢è¿ç§»æœºåˆ¶"></a>é¡µé¢è¿ç§»æœºåˆ¶</h3><p>é¡µé¢è¿ç§»ä¸»è¦ç”¨ä»¥è§£å†³å†…æ ¸ç©ºé—´ä¸­çš„ç¢ç‰‡é—®é¢˜ï¼Œåœ¨é•¿æœŸçš„è¿è¡Œä¹‹åå†…å­˜å½“ä¸­ç©ºé—²é¡µé¢çš„åˆ†å¸ƒå¯èƒ½æ˜¯é›¶æ•£çš„ï¼Œè¿™ä¾¿å¯¼è‡´äº†å†…æ ¸æœ‰å¯èƒ½æ— æ³•æ˜ å°„åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜ï¼Œå› æ­¤éœ€è¦è¿›è¡Œé¡µé¢è¿ç§»å³å°†æ—§çš„é¡µé¢è¿ç§»åˆ°æ–°çš„ä½ç½®ï¼Œç›¸ä¿¡å¤§å®¶åœ¨æ“ä½œç³»ç»Ÿè¯¾éƒ½å­¦ä¹ è¿‡çš„ã€‚</p>
<p>ä½†å¹¶éæ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯èƒ½å¤Ÿéšæ„è¿ç§»çš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ buddy system å½“ä¸­è¿˜éœ€è¦å°†é¡µé¢æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">migratetype</span> &#123;</span></span><br><span class="line">	MIGRATE_UNMOVABLE,</span><br><span class="line">	MIGRATE_MOVABLE,</span><br><span class="line">	MIGRATE_RECLAIMABLE,</span><br><span class="line">	MIGRATE_PCPTYPES,	<span class="comment">/* the number of types on the pcp lists */</span></span><br><span class="line">	MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * MIGRATE_CMA migration type is designed to mimic the way</span></span><br><span class="line"><span class="comment">	 * ZONE_MOVABLE works.  Only movable pages can be allocated</span></span><br><span class="line"><span class="comment">	 * from MIGRATE_CMA pageblocks and page allocator never</span></span><br><span class="line"><span class="comment">	 * implicitly change migration type of MIGRATE_CMA pageblock.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The way to use it is to change migratetype of a range of</span></span><br><span class="line"><span class="comment">	 * pageblocks to MIGRATE_CMA which can be done by</span></span><br><span class="line"><span class="comment">	 * __free_pageblock_cma() function.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	MIGRATE_CMA,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">	MIGRATE_ISOLATE,	<span class="comment">/* can&#x27;t allocate from here */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	MIGRATE_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿ç§»ç±»å‹ç”±ä¸Šé¢çš„æšä¸¾ç±»å‹å®šä¹‰ã€‚</p>
<ul>
<li>MIGRATE_UNMOVABLEï¼šè¿™ç±»å‹é¡µé¢åœ¨å†…å­˜å½“ä¸­æœ‰ç€å›ºå®šçš„ä½ç½®ï¼Œä¸èƒ½ç§»åŠ¨</li>
<li>MIGRATE_MOVABLEï¼šè¿™ç±»é¡µé¢å¯ä»¥éšæ„ç§»åŠ¨ï¼Œä¾‹å¦‚ç”¨æˆ·ç©ºé—´çš„é¡µé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶æ•°æ®åæ”¹å˜é¡µè¡¨æ˜ å°„å³å¯</li>
<li>MIGRATE_RECLAIMABLEï¼šè¿™ç±»é¡µé¢ä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†æ˜¯å¯ä»¥åˆ é™¤ï¼Œä¾‹å¦‚æ˜ å°„è‡ªæ–‡ä»¶çš„é¡µ</li>
<li>MIGRATE_PCPTYPESï¼š<code>per_cpu_pageset</code>ï¼Œå³æ¯ CPU é¡µå¸§ç¼“å­˜ï¼Œå…¶è¿ç§»ä»…é™äºåŒä¸€èŠ‚ç‚¹å†…</li>
<li>MIGRATE_ISOLATEï¼šä¸èƒ½ä»è¯¥é“¾è¡¨åˆ†é…é¡µé¢ï¼Œè¯¥é“¾è¡¨ç”¨äºè·¨ NUMA èŠ‚ç‚¹è¿›è¡Œé¡µé¢ç§»åŠ¨ï¼Œå°†é¡µé¢ç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µé¢æœ€ä¸ºé¢‘ç¹çš„ CPU æ‰€å¤„èŠ‚ç‚¹</li>
<li>MIGRATE_TYPESï¼šè¡¨ç¤ºè¿ç§»ç±»å‹çš„æ•°ç›®ï¼Œå¹¶ä¸å­˜åœ¨è¿™ä¸€é“¾è¡¨</li>
</ul>
<h3 id="zoneåˆ†ç±»"><a href="#zoneåˆ†ç±»" class="headerlink" title="zoneåˆ†ç±»"></a>zoneåˆ†ç±»</h3><p>åœ¨ Linux kernel å½“ä¸­ï¼Œæˆ‘ä»¬æ ¹æ®å†…å­˜åŒºæ®µçš„ä¸åŒç”¨é€”ï¼Œå°†å…¶åˆ’åˆ†ä¸ºä¸åŒçš„ zone</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ZONE_DMA and ZONE_DMA32 are used when there are peripherals not able</span></span><br><span class="line"><span class="comment">	 * to DMA to all of the addressable memory (ZONE_NORMAL).</span></span><br><span class="line"><span class="comment">	 * On architectures where this area covers the whole 32 bit address</span></span><br><span class="line"><span class="comment">	 * space ZONE_DMA32 is used. ZONE_DMA is left for the ones with smaller</span></span><br><span class="line"><span class="comment">	 * DMA addressing constraints. This distinction is important as a 32bit</span></span><br><span class="line"><span class="comment">	 * DMA mask is assumed when ZONE_DMA32 is defined. Some 64-bit</span></span><br><span class="line"><span class="comment">	 * platforms may need both zones as they support peripherals with</span></span><br><span class="line"><span class="comment">	 * different DMA addressing limitations.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">	ZONE_DMA,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DMA32</span></span><br><span class="line">	ZONE_DMA32,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Normal addressable memory is in ZONE_NORMAL. DMA operations can be</span></span><br><span class="line"><span class="comment">	 * performed on pages in ZONE_NORMAL if the DMA devices support</span></span><br><span class="line"><span class="comment">	 * transfers to all addressable memory.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ZONE_NORMAL,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * A memory area that is only addressable by the kernel through</span></span><br><span class="line"><span class="comment">	 * mapping portions into its own address space. This is for example</span></span><br><span class="line"><span class="comment">	 * used by i386 to allow the kernel to address the memory beyond</span></span><br><span class="line"><span class="comment">	 * 900MB. The kernel will set up special mappings (page</span></span><br><span class="line"><span class="comment">	 * table entries on i386) for each page that the kernel needs to</span></span><br><span class="line"><span class="comment">	 * access.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ZONE_HIGHMEM,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ZONE_MOVABLE is similar to ZONE_NORMAL, except that it contains</span></span><br><span class="line"><span class="comment">	 * movable pages with few exceptional cases described below. Main use</span></span><br><span class="line"><span class="comment">	 * cases for ZONE_MOVABLE are to make memory offlining/unplug more</span></span><br><span class="line"><span class="comment">	 * likely to succeed, and to locally limit unmovable allocations - e.g.,</span></span><br><span class="line"><span class="comment">	 * to increase the number of THP/huge pages. Notable special cases are:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * 1. Pinned pages: (long-term) pinning of movable pages might</span></span><br><span class="line"><span class="comment">	 *    essentially turn such pages unmovable. Therefore, we do not allow</span></span><br><span class="line"><span class="comment">	 *    pinning long-term pages in ZONE_MOVABLE. When pages are pinned and</span></span><br><span class="line"><span class="comment">	 *    faulted, they come from the right zone right away. However, it is</span></span><br><span class="line"><span class="comment">	 *    still possible that address space already has pages in</span></span><br><span class="line"><span class="comment">	 *    ZONE_MOVABLE at the time when pages are pinned (i.e. user has</span></span><br><span class="line"><span class="comment">	 *    touches that memory before pinning). In such case we migrate them</span></span><br><span class="line"><span class="comment">	 *    to a different zone. When migration fails - pinning fails.</span></span><br><span class="line"><span class="comment">	 * 2. memblock allocations: kernelcore/movablecore setups might create</span></span><br><span class="line"><span class="comment">	 *    situations where ZONE_MOVABLE contains unmovable allocations</span></span><br><span class="line"><span class="comment">	 *    after boot. Memory offlining and allocations fail early.</span></span><br><span class="line"><span class="comment">	 * 3. Memory holes: kernelcore/movablecore setups might create very rare</span></span><br><span class="line"><span class="comment">	 *    situations where ZONE_MOVABLE contains memory holes after boot,</span></span><br><span class="line"><span class="comment">	 *    for example, if we have sections that are only partially</span></span><br><span class="line"><span class="comment">	 *    populated. Memory offlining and allocations fail early.</span></span><br><span class="line"><span class="comment">	 * 4. PG_hwpoison pages: while poisoned pages can be skipped during</span></span><br><span class="line"><span class="comment">	 *    memory offlining, such pages cannot be allocated.</span></span><br><span class="line"><span class="comment">	 * 5. Unmovable PG_offline pages: in paravirtualized environments,</span></span><br><span class="line"><span class="comment">	 *    hotplugged memory blocks might only partially be managed by the</span></span><br><span class="line"><span class="comment">	 *    buddy (e.g., via XEN-balloon, Hyper-V balloon, virtio-mem). The</span></span><br><span class="line"><span class="comment">	 *    parts not manged by the buddy are unmovable PG_offline pages. In</span></span><br><span class="line"><span class="comment">	 *    some cases (virtio-mem), such pages can be skipped during</span></span><br><span class="line"><span class="comment">	 *    memory offlining, however, cannot be moved/allocated. These</span></span><br><span class="line"><span class="comment">	 *    techniques might use alloc_contig_range() to hide previously</span></span><br><span class="line"><span class="comment">	 *    exposed pages from the buddy again (e.g., to implement some sort</span></span><br><span class="line"><span class="comment">	 *    of memory unplug in virtio-mem).</span></span><br><span class="line"><span class="comment">	 * 6. ZERO_PAGE(0), kernelcore/movablecore setups might create</span></span><br><span class="line"><span class="comment">	 *    situations where ZERO_PAGE(0) which is allocated differently</span></span><br><span class="line"><span class="comment">	 *    on different platforms may end up in a movable zone. ZERO_PAGE(0)</span></span><br><span class="line"><span class="comment">	 *    cannot be migrated.</span></span><br><span class="line"><span class="comment">	 * 7. Memory-hotplug: when using memmap_on_memory and onlining the</span></span><br><span class="line"><span class="comment">	 *    memory to the MOVABLE zone, the vmemmap pages are also placed in</span></span><br><span class="line"><span class="comment">	 *    such zone. Such pages cannot be really moved around as they are</span></span><br><span class="line"><span class="comment">	 *    self-stored in the range, but they are treated as movable when</span></span><br><span class="line"><span class="comment">	 *    the range they describe is about to be offlined.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * In general, no unmovable allocations that degrade memory offlining</span></span><br><span class="line"><span class="comment">	 * should end up in ZONE_MOVABLE. Allocators (like alloc_contig_range())</span></span><br><span class="line"><span class="comment">	 * have to expect that migrating pages in ZONE_MOVABLE can fail (even</span></span><br><span class="line"><span class="comment">	 * if has_unmovable_pages() states that there are no unmovable pages,</span></span><br><span class="line"><span class="comment">	 * there can be false negatives).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ZONE_MOVABLE,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DEVICE</span></span><br><span class="line">	ZONE_DEVICE,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	__MAX_NR_ZONES</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>ZONE_DMAï¼šç›´æ¥å†…å­˜è®¿é—®åŒºåŸŸï¼Œä½¿ç”¨ DMA å†…å­˜æƒ…å†µ :æœ‰äº›è®¾å¤‡æ¶æ„æ¯”è¾ƒè€ , æ— æ³•ç›´æ¥è®¿é—®æ•´ä¸ªå†…å­˜ , éœ€è¦ä½¿ç”¨ DMA ç›´æ¥å†…å­˜è®¿é—®åŒºåŸŸ ;</li>
<li>ZONE_DMA32ï¼šå¯¹åº”çš„æ˜¯64ä½ç³»ç»Ÿ , DMA32åŒºåŸŸã€‚å¯ä»¥æ”¯æŒä¸¤ç§è®¾å¤‡çš„è®¿é—®ï¼Œåªèƒ½ç›´æ¥è®¿é—® 16 MB ä»¥ä¸‹çš„å†…å­˜è®¾å¤‡ï¼›åªèƒ½ç›´æ¥è®¿é—® 4 GB ä»¥ä¸‹çš„å†…å­˜è®¾å¤‡ã€‚</li>
<li>ZONE_NORMALï¼šæ™®é€šå†…å­˜åŒºåŸŸï¼Œè¯¥å†…å­˜åŒºåŸŸ å¯ä»¥ ç›´æ¥æ˜ å°„åˆ° â€œ å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ â€œã€‚</li>
<li>ZONE_HIGHMEMï¼šé«˜ç«¯å†…å­˜åŒºåŸŸï¼Œè¿™æ˜¯32ä½æ¶æ„ä¸­çš„æ¦‚å¿µï¼Œ<code>DMA</code> å’Œ <code>DMA32</code> åˆç§°ä¸ºâ€ä½ç«¯å†…å­˜åŒºåŸŸâ€ã€‚</li>
<li>ZONE_MOVABLEï¼šâ€å¯ç§»åŠ¨åŒºåŸŸâ€ , è¿™æ˜¯ä¸ºäº†é˜²æ­¢â€å†…å­˜ç¢ç‰‡â€çš„ä¼ªå†…å­˜åŒºã€‚</li>
<li>ZONE_DEVICEï¼šâ€è®¾å¤‡åŒºåŸŸâ€, è¿™æ˜¯ä¸ºäº†æ”¯æŒâ€å†…å­˜çƒ­æ’æ‹”â€è€Œè®¾ç½®çš„å†…å­˜åŒºåŸŸ , æ¯ä¸ªè®¾å¤‡åŒºåŸŸä½¿ç”¨ zone ç»“æ„ä½“è¡¨ç¤ºã€‚</li>
</ul>
<p>å¤§è‡´æ€»ç»“ä¸€ä¸‹ï¼Œä¸‹é¢å…ˆçœ‹X86-32</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Start address</th>
<th>End address</th>
</tr>
</thead>
<tbody><tr>
<td>ZONE_DMA</td>
<td>0MB</td>
<td>16MB</td>
</tr>
<tr>
<td>ZONE_NORMAL</td>
<td>16MB</td>
<td>896MB</td>
</tr>
<tr>
<td>ZONE_HIGHMEM</td>
<td>896MB</td>
<td>â€¦</td>
</tr>
</tbody></table>
<p>X86-64</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Start address</th>
<th>End address</th>
</tr>
</thead>
<tbody><tr>
<td>ZONE_DMA</td>
<td>0MB</td>
<td>16MB</td>
</tr>
<tr>
<td>ZONE_DMA32</td>
<td>16MB</td>
<td>4GB</td>
</tr>
<tr>
<td>ZONE_NORMAL</td>
<td>4GB</td>
<td>â€¦</td>
</tr>
</tbody></table>
<h2 id="struct-pglist-data"><a href="#struct-pglist-data" class="headerlink" title="struct pglist_data"></a>struct pglist_data</h2><p>zoneä¸Šä¸€å±‚åˆ™æ˜¯èŠ‚ç‚¹ï¼ŒLinuxå°†å†…å­˜æ§åˆ¶å™¨ä½œä¸ºèŠ‚ç‚¹åˆ’åˆ†çš„ä¾æ®ï¼Œå¯¹äº UMA æ¶æ„è€Œè¨€åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå¯¹äº NUMA æ¶æ„è€Œè¨€é€šå¸¸æœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œå¯¹äºåŒä¸€ä¸ªå†…å­˜æ§åˆ¶å™¨ä¸‹çš„ CPU è€Œè¨€å…¶å¯¹åº”çš„èŠ‚ç‚¹ç§°ä¹‹ä¸ºæœ¬åœ°å†…å­˜ï¼Œä¸åŒå¤„ç†å™¨ä¹‹é—´é€šè¿‡æ€»çº¿è¿›è¡Œè¿›ä¸€æ­¥çš„è¿æ¥ã€‚</p>
<p><img   src="/images/hAopSNYg23VeWzq.png" ></p>
<p>ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨<code>pglist_data</code>ç»“æ„è¿›è¡Œæè¿°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * node_zones contains just the zones for THIS node. Not all of the</span></span><br><span class="line"><span class="comment">	 * zones may be populated, but it is the full list. It is referenced by</span></span><br><span class="line"><span class="comment">	 * this node&#x27;s node_zonelists as well as other node&#x27;s node_zonelists.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zone</span> <span class="title">node_zones</span>[<span class="title">MAX_NR_ZONES</span>];</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * node_zonelists contains references to all zones in all nodes.</span></span><br><span class="line"><span class="comment">	 * Generally the first zones will be references to this node&#x27;s</span></span><br><span class="line"><span class="comment">	 * node_zones.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> <span class="title">node_zonelists</span>[<span class="title">MAX_ZONELISTS</span>];</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> nr_zones; <span class="comment">/* number of populated zones in this node */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FLATMEM	<span class="comment">/* means !SPARSEMEM */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">node_mem_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page_ext</span> *<span class="title">node_page_ext</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_MEMORY_HOTPLUG) || defined(CONFIG_DEFERRED_STRUCT_PAGE_INIT)</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Must be held any time you expect node_start_pfn,</span></span><br><span class="line"><span class="comment">	 * node_present_pages, node_spanned_pages or nr_zones to stay constant.</span></span><br><span class="line"><span class="comment">	 * Also synchronizes pgdat-&gt;first_deferred_pfn during deferred page</span></span><br><span class="line"><span class="comment">	 * init.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * pgdat_resize_lock() and pgdat_resize_unlock() are provided to</span></span><br><span class="line"><span class="comment">	 * manipulate node_size_lock without checking for CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line"><span class="comment">	 * or CONFIG_DEFERRED_STRUCT_PAGE_INIT.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Nests above zone-&gt;lock and zone-&gt;span_seqlock</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> node_size_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_start_pfn;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_present_pages; <span class="comment">/* total number of physical pages */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> node_spanned_pages; <span class="comment">/* total size of physical page</span></span><br><span class="line"><span class="comment">					     range, including holes */</span></span><br><span class="line">	<span class="keyword">int</span> node_id;</span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> kswapd_wait;</span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> pfmemalloc_wait;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* workqueues for throttling reclaim for different reasons. */</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> reclaim_wait[NR_VMSCAN_THROTTLE];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">atomic_t</span> nr_writeback_throttled;<span class="comment">/* nr of writeback-throttled tasks */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_reclaim_start;	<span class="comment">/* nr pages written while throttled</span></span><br><span class="line"><span class="comment">					 * when throttling started. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">kswapd_lock</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kswapd</span>;</span>	<span class="comment">/* Protected by kswapd_lock */</span></span><br><span class="line">	<span class="keyword">int</span> kswapd_order;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">kswapd_highest_zoneidx</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> kswapd_failures;		<span class="comment">/* Number of &#x27;reclaimed == 0&#x27; runs */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line">	<span class="keyword">int</span> kcompactd_max_order;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">kcompactd_highest_zoneidx</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> kcompactd_wait;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kcompactd</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> proactive_compact_trigger;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * This is a per-node reserve of pages that are not available</span></span><br><span class="line"><span class="comment">	 * to userspace allocations.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		totalreserve_pages;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * node reclaim becomes active if more unmapped pages exist.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		min_unmapped_pages;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		min_slab_pages;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_NUMA */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write-intensive fields used by page reclaim */</span></span><br><span class="line">	CACHELINE_PADDING(_pad1_);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If memory initialisation on large machines is deferred then this</span></span><br><span class="line"><span class="comment">	 * is the first PFN that needs to be initialised.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> first_deferred_pfn;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_DEFERRED_STRUCT_PAGE_INIT */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRANSPARENT_HUGEPAGE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">deferred_split</span> <span class="title">deferred_split_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA_BALANCING</span></span><br><span class="line">	<span class="comment">/* start time in ms of current promote rate limit period */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nbp_rl_start;</span><br><span class="line">	<span class="comment">/* number of promote candidate pages at start time of current rate limit period */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nbp_rl_nr_cand;</span><br><span class="line">	<span class="comment">/* promote threshold in ms */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nbp_threshold;</span><br><span class="line">	<span class="comment">/* start time in ms of current promote threshold adjustment period */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nbp_th_start;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * number of promote candidate pages at start time of current promote</span></span><br><span class="line"><span class="comment">	 * threshold adjustment period</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nbp_th_nr_cand;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* Fields commonly accessed by the page reclaim scanner */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">NOTE:</span> THIS IS UNUSED IF MEMCG IS ENABLED.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Use mem_cgroup_lruvec() to look up lruvecs.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lruvec</span>		__<span class="title">lruvec</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LRU_GEN</span></span><br><span class="line">	<span class="comment">/* kswap mm walk data */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lru_gen_mm_walk</span> <span class="title">mm_walk</span>;</span></span><br><span class="line">	<span class="comment">/* lru_gen_folio list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lru_gen_memcg</span> <span class="title">memcg_lru</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	CACHELINE_PADDING(_pad2_);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Per-node vmstats */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_nodestat</span> __<span class="title">percpu</span> *<span class="title">per_cpu_nodestats</span>;</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span>		vm_stat[NR_VM_NODE_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memory_tier</span> __<span class="title">rcu</span> *<span class="title">memtier</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_FAILURE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memory_failure_stats</span> <span class="title">mf_stats</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">pg_data_t</span>;</span><br></pre></td></tr></table></figure>

<h3 id="æˆå‘˜æè¿°"><a href="#æˆå‘˜æè¿°" class="headerlink" title="æˆå‘˜æè¿°"></a>æˆå‘˜æè¿°</h3><ul>
<li><strong>node_zones</strong>: node çš„ zone åˆ—è¡¨ï¼ŒèŠ‚ç‚¹ä¸­æœ€é‡è¦çš„å­—æ®µ <code>node_zones</code> ä½œä¸ºä¸€ä¸ª zone ç»“æ„ä½“æ•°ç»„ è®°å½•äº†æœ¬èŠ‚ç‚¹ä¸Šæ‰€æœ‰çš„ zoneï¼Œå…¶ä¸­æœ‰æ•ˆçš„ zone çš„ä¸ªæ•°ç”±èŠ‚ç‚¹ç»“æ„ä½“çš„ <code>nr_zones</code> å­—æ®µæŒ‡å‡ºã€‚</li>
<li><strong>node_zonelists</strong>: å†…å­˜åˆ†é…æ—¶å¤‡ç”¨ zone çš„æœç´¢é¡ºåºï¼Œè¯¥å­—æ®µç”¨ä»¥ç¡®å®šå†…å­˜åˆ†é…æ—¶å¯¹å¤‡ç”¨çš„ zone çš„æœç´¢é¡ºåºï¼Œåœ¨æœ¬èŠ‚ç‚¹å¸¸è§„å†…å­˜åˆ†é…å¤±è´¥æ—¶ä¼šæ²¿ç€è¿™ä¸ªæ•°ç»„è¿›è¡Œæœç´¢ï¼Œå…¶ä¸­åŒ…å«çš„ zone å¯ä»¥æ˜¯éæœ¬èŠ‚ç‚¹çš„ zoneã€‚</li>
</ul>
<p>å…¶ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span>	<span class="comment">/* Pointer to actual zone */</span></span><br><span class="line">	<span class="keyword">int</span> zone_idx;		<span class="comment">/* zone_idx(zoneref-&gt;zone) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> _<span class="title">zonerefs</span>[<span class="title">MAX_ZONES_PER_ZONELIST</span> + 1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>node_start_pfn</strong>: node çš„èµ·å§‹é¡µæ¡†æ ‡å·ï¼Œè¯¥å­—æ®µè®°å½•äº†è¯¥èŠ‚ç‚¹ä¸Šçš„ç‰©ç†å†…å­˜èµ·å§‹é¡µæ¡†æ ‡å·ã€‚</li>
<li><strong>node_present_pages</strong>: nodeä¸­ç‰©ç†é¡µçš„æ€»æ•°é‡ã€‚</li>
<li><strong>node_spanned_pages</strong>: è¯¥å­—æ®µè®°å½•äº†èŠ‚ç‚¹ä¸ŠåŒ…æ‹¬ç©ºæ´åœ¨å†…çš„é¡µå¸§ä¸ºå•ä½çš„è¯¥èŠ‚ç‚¹å†…å­˜çš„æ€»é•¿åº¦ã€‚</li>
<li><strong>node_id</strong>: è¯¥å­—æ®µè®°å½•äº†è¯¥èŠ‚ç‚¹åœ¨ç³»ç»Ÿä¸­çš„æ ‡å·ï¼Œä» 0 å¼€å§‹ã€‚</li>
</ul>
<h3 id="nodeå­˜å‚¨æ–¹å¼"><a href="#nodeå­˜å‚¨æ–¹å¼" class="headerlink" title="nodeå­˜å‚¨æ–¹å¼"></a>nodeå­˜å‚¨æ–¹å¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> *<span class="title">node_data</span>[<span class="title">MAX_NUMNODES</span>] __<span class="title">read_mostly</span>;</span></span><br><span class="line">EXPORT_SYMBOL(node_data);</span><br></pre></td></tr></table></figure>

<p>åœ¨å†…æ ¸ä¸­å®šä¸€ä¸ªåä¸º<code>node_data</code>çš„<code>pglist_data</code>æ•°ç»„ï¼Œè¯¥æ•°ç»„ä¿å­˜ç€ç³»ç»Ÿä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</p>
<p><img   src="/images/KcHILforOySi8YR.png" ></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ numactl --hardware</span><br><span class="line">available: 1 nodes (0)</span><br><span class="line">node 0 cpus: 0 1</span><br><span class="line">node 0 size: 3904 MB</span><br><span class="line">node 0 free: 313 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0 </span><br><span class="line">  0:  10 </span><br><span class="line">âœ  ~ </span><br></pre></td></tr></table></figure>

<p>åœ¨Linuxä¸­å¯ä»¥ç”¨ä¸Šè¿°å‘½ä»¤æŸ¥çœ‹å­˜åœ¨å¤šå°‘nodeã€‚</p>
<h3 id="nodeçŠ¶æ€"><a href="#nodeçŠ¶æ€" class="headerlink" title="nodeçŠ¶æ€"></a>nodeçŠ¶æ€</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nodemask_t</span> node_states[NR_NODE_STATES] __read_mostly = &#123;</span><br><span class="line">	[N_POSSIBLE] = NODE_MASK_ALL,</span><br><span class="line">	[N_ONLINE] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_NUMA</span></span><br><span class="line">	[N_NORMAL_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">	[N_HIGH_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	[N_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line">	[N_CPU] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	<span class="comment">/* NUMA */</span></span></span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(node_states);</span><br></pre></td></tr></table></figure>

<p>åœ¨Linuxä¸­å­˜åœ¨ä¸Šé¢è¿™æ ·ä¸€ä¸ªå…¨å±€æ•°ç»„ç”¨ä»¥è¡¨ç¤ºæ ‡è¯†å¯¹åº”æ ‡å·çš„èŠ‚ç‚¹çŠ¶æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span> DECLARE_BITMAP(bits, MAX_NUMNODES); &#125; <span class="keyword">nodemask_t</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>nodemask_t</code>æ˜¯ä¸€ä¸ªä½å›¾ç±»å‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">node_states</span> &#123;</span></span><br><span class="line">	N_POSSIBLE,		<span class="comment">/* The node could become online at some point */</span></span><br><span class="line">	N_ONLINE,		<span class="comment">/* The node is online */</span></span><br><span class="line">	N_NORMAL_MEMORY,	<span class="comment">/* The node has regular memory */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">	N_HIGH_MEMORY,		<span class="comment">/* The node has regular or high memory */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	N_HIGH_MEMORY = N_NORMAL_MEMORY,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	N_MEMORY,		<span class="comment">/* The node has memory(regular, high, movable) */</span></span><br><span class="line">	N_CPU,		<span class="comment">/* The node has one or more cpus */</span></span><br><span class="line">	N_GENERIC_INITIATOR,	<span class="comment">/* The node has one or more Generic Initiators */</span></span><br><span class="line">	NR_NODE_STATES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªçŠ¶æ€ç”±ä¸€ä¸ªæšä¸¾ç±»å‹ <code>node_states</code> å®šä¹‰ã€‚</p>
<h2 id="buddy-systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"><a href="#buddy-systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼" class="headerlink" title="buddy systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"></a>buddy systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼</h2><p>åœ¨ä¸Šé¢ç®€å•æåˆ°äº†è¿™ä¸€zoneä¸­çš„æˆå‘˜ï¼Œå…¶ä½œç”¨ä¸»è¦ç”¨äºå­˜å‚¨<code>buddy system</code>æŒ‰ç…§orderç®¡ç†çš„é¡µé¢ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">free_area</span>	<span class="title">free_area</span>[<span class="title">MAX_ORDER</span> + 1];</span></span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>MAX_ORDER</code>çš„å€¼ä¸º10æ‰€ä»¥å…¶æ•°ç»„å®šä¹‰ä¸º11ã€‚</p>
<p>åœ¨<code>buddy system</code>ä¸­æŒ‰ç…§ç©ºé—²é¡µé¢çš„è¿ç»­å¤§å°è¿›è¡Œåˆ†é˜¶ç®¡ç†ï¼Œè¿™é‡Œçš„ order çš„å®é™…å«ä¹‰ä¸ºè¿ç»­çš„ç©ºé—²é¡µé¢çš„å¤§å°ï¼Œä¸è¿‡å•ä½ä¸æ˜¯é¡µé¢æ•°ï¼Œè€Œæ˜¯ä»‹ï¼Œå³å¯¹äºæ¯ä¸ªä¸‹æ ‡è€Œè¨€ï¼Œå…¶ä¸­æ‰€å­˜å‚¨çš„é¡µé¢å¤§å°ä¸ºï¼š<code>2^order</code>ã€‚</p>
<p>åœ¨<code>free_area</code>ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œåœ¨å‰æ–‡ä¸­æœ‰è¯¦ç»†ä»‹ç»ã€‚è¿™é‡Œç®€å•è¯´ä¸€ä¸‹<code>free_area</code>ç»“æ„ä½“ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		nr_free;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>nr_free</code>æˆå‘˜å¾ˆæ˜æ˜¾å°±æ˜¯ç”¨äºè®°å½•äº†åœ¨å½“å‰<code>free_area</code>ä¸­çš„ç©ºé—²é¡µé¢å—çš„æ•°é‡ï¼Œå¯¹äº<code>free_area[0]</code>ä»¥å¤–çš„<code>free_area</code>è€Œè¨€å…¶å•ä½å¹¶éæ˜¯å•ä¸ªé¡µæ¡†ï¼Œè€Œæ˜¯ä»¥å†…å­˜å—ä¸ºå•ä½ã€‚</p>
<p>è€Œ<code>free_list</code>æˆå‘˜åˆ™æ˜¯ä¸º<code>list_head</code>çš„é“¾è¡¨ç»“æ„å…¶é€šè¿‡pageç»“æ„ä½“çš„<code>lru</code>å­—æ®µå°†pageç»“æ„ä½“è¿æ¥æˆåŒå‘é“¾è¡¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line">&#125; _struct_page_alignment;</span><br></pre></td></tr></table></figure>

<p>page ç»“æ„ä½“ä¸­çš„ <code>lru</code> è¿™ä¸€å­—æ®µçš„ç±»å‹ä¸º <code>struct list_head</code>ï¼Œè¿™æ˜¯å†…æ ¸ç¼–ç¨‹ä¸­é€šç”¨çš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œ<code>free_list</code>ä¸<code>lru</code>é“¾è¡¨éƒ½ä½¿ç”¨è¯¥å­—æ®µå°†é¡µç»“æ„ä½“ç»„ç»‡ä¸ºåŒå‘é“¾è¡¨ï¼Œå³ä¸€ä¸ªé¡µæ˜¯ä¸å¯èƒ½åŒæ—¶å‡ºç°åœ¨<code>lru</code>é“¾è¡¨ä¸<code>buddy system</code>ä¸­çš„ã€‚</p>
<p>å¹¶ä¸”å¯ä»¥æ˜ç¡®çœ‹åˆ°è¿™é‡Œæ˜¯æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»çš„ï¼Œå…·ä½“å‰é¢æåˆ°è¿‡è¿™é‡Œä¸è¯¦ç»†å†™äº†ã€‚</p>
<h2 id="buddy-systemé¡µåˆ†é…"><a href="#buddy-systemé¡µåˆ†é…" class="headerlink" title="buddy systemé¡µåˆ†é…"></a>buddy systemé¡µåˆ†é…</h2><h3 id="GFP-get-free-page-æ ‡è¯†ä½"><a href="#GFP-get-free-page-æ ‡è¯†ä½" class="headerlink" title="GFP (get free page) æ ‡è¯†ä½"></a>GFP (get free page) æ ‡è¯†ä½</h3><p>åœ¨ kernel memory allocation ä¸­æˆ‘ä»¬ç»å¸¸èƒ½è§åˆ° <code>gfp_t</code> ç±»å‹ï¼Œå…¶è¡¨ç¤ºåˆ†é…æ—¶çš„æ ‡å¿—ä½ã€‚</p>
<ul>
<li>å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦: å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ä¸»è¦æè¿°ä»å“ªäº›å†…å­˜ç®¡ç†åŒºæ¥åˆ†é…å†…å­˜</li>
</ul>
<table>
<thead>
<tr>
<th>flag</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>__GFP_DMA</td>
<td>ä»ZONE_DMAåŒºä¸­åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td>__GFP_HIGNMEM</td>
<td>ä»ZONE_HIGHMEMåŒºä¸­åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td>__GFP_DMA32</td>
<td>ä»ZONE_DMA32åŒºä¸­åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td>__GFP_MOVABLE</td>
<td>å†…å­˜è§„æ•´æ—¶å¯ä»¥è¿ç§»æˆ–å›æ”¶é¡µé¢</td>
</tr>
</tbody></table>
<ul>
<li>ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦: ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦ä¸»è¦è¡¨ç¤ºåˆ†é…å‡ºæ¥çš„é¡µé¢å…·æœ‰çš„è¿ç§»å±æ€§</li>
</ul>
<table>
<thead>
<tr>
<th>flag</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>__GFP_RECLAIMABLE</td>
<td>åˆ†é…çš„å†…å­˜é¡µé¢å¯ä»¥å›æ”¶</td>
</tr>
<tr>
<td>__GFP_WRITE</td>
<td>ç”³è¯·çš„é¡µé¢ä¼šè¢«å¼„æˆè„é¡µ</td>
</tr>
<tr>
<td>__GFP_HARDWALL</td>
<td>å¼ºåˆ¶ä½¿ç”¨cpusetå†…å­˜åˆ†é…ç­–ç•¥</td>
</tr>
<tr>
<td>__GFP_THISNODE</td>
<td>åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜</td>
</tr>
<tr>
<td>__GFP_ACCOUNT</td>
<td>kmemcgä¼šè®°å½•åˆ†é…è¿‡ç¨‹</td>
</tr>
</tbody></table>
<ul>
<li>æ°´ä½ä¿®é¥°ç¬¦: ä¸æ°´ä½çº¿ç›¸å…³çš„æ ‡å¿—ä½</li>
</ul>
<table>
<thead>
<tr>
<th>flag</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>__GFP_ATOMIC</td>
<td>é«˜ä¼˜å…ˆçº§åˆ†é…å†…å­˜ï¼Œåˆ†é…å™¨å¯ä»¥åˆ†é…æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„é¢„ç•™å†…å­˜</td>
</tr>
<tr>
<td>__GFP_HIGH</td>
<td>åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­ä¸å¯ä»¥ç¡çœ æˆ–æ‰§è¡Œé¡µé¢å›æ”¶åŠ¨ä½œ</td>
</tr>
<tr>
<td>__GFP_MEMALLOC</td>
<td>å…è®¸è®¿é—®æ‰€æœ‰çš„å†…å­˜</td>
</tr>
<tr>
<td>__GFP_NOMEMALLOC</td>
<td>ä¸å…è®¸è®¿é—®æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„ç³»ç»Ÿé¢„ç•™å†…å­˜</td>
</tr>
</tbody></table>
<ul>
<li>é¡µé¢å›æ”¶ä¿®é¥°ç¬¦: ä¸é¡µé¢å›æ”¶ç›¸å…³çš„æ ‡å¿—ä½</li>
</ul>
<table>
<thead>
<tr>
<th>flag</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>__GFP_IO</td>
<td>å¯åŠ¨ç‰©ç†I&#x2F;Oä¼ è¾“</td>
</tr>
<tr>
<td>__GFP_FS</td>
<td>å…è®¸è°ƒç”¨åº•å±‚FSæ–‡ä»¶ç³»ç»Ÿã€‚å¯é¿å…åˆ†é…å™¨é€’å½’åˆ°å¯èƒ½å·²ç»æŒæœ‰é”çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ é¿å…æ­»é”</td>
</tr>
<tr>
<td>__GFP_DIRECT_RECLAIM</td>
<td>åˆ†é…å†…å­˜è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨ç›´æ¥å†…å­˜å›æ”¶</td>
</tr>
<tr>
<td>__GFP_KSWAPD_RECLAIM</td>
<td>å†…å­˜åˆ°è¾¾ä½æ°´ä½æ—¶å”¤é†’kswapdçº¿ç¨‹å¼‚æ­¥å›æ”¶å†…å­˜</td>
</tr>
<tr>
<td>__GFP_RECLAIM</td>
<td>è¡¨ç¤ºæ˜¯å¦å¯ä»¥ç›´æ¥å†…å­˜å›æ”¶æˆ–è€…ä½¿ç”¨kswapdçº¿ç¨‹è¿›è¡Œå›æ”¶</td>
</tr>
<tr>
<td>__GFP_RETRY_MAYFAIL</td>
<td>åˆ†é…å†…å­˜å¯ä»¥å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†æ˜¯åœ¨ç”³è¯·è¿‡ç¨‹ä¸­ä¼šå›æ”¶ä¸€äº›ä¸å¿…è¦çš„å†…å­˜ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿå—ç›Š</td>
</tr>
<tr>
<td>__GFP_NOFAIL</td>
<td>å†…å­˜åˆ†é…å¤±è´¥åæ— é™åˆ¶çš„é‡å¤å°è¯•ï¼ŒçŸ¥é“åˆ†é…æˆåŠŸ</td>
</tr>
<tr>
<td>__GFP_NORETRY</td>
<td>ç›´æ¥é¡µé¢å›æ”¶æˆ–è€…å†…å­˜è§„æ•´åè¿˜æ˜¯æ— æ³•åˆ†é…å†…å­˜æ—¶ï¼Œä¸å¯ç”¨retryåå¤å°è¯•åˆ†é…å†…å­˜ï¼Œç›´æ¥è¿”å›NULL</td>
</tr>
</tbody></table>
<ul>
<li>è¡Œä¸ºä¿®é¥°ç¬¦: ä¸åˆ†é…æ—¶çš„è¡Œä¸ºç›¸å…³çš„æ ‡å¿—ä½</li>
</ul>
<table>
<thead>
<tr>
<th>flag</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>__GFP_NOWARN</td>
<td>å…³é—­å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­çš„WARNING</td>
</tr>
<tr>
<td>__GFP_COMP</td>
<td>åˆ†é…çš„å†…å­˜é¡µé¢å°†è¢«ç»„åˆæˆå¤åˆé¡µcompound page</td>
</tr>
<tr>
<td>__GFP_ZERO</td>
<td>è¿”å›ä¸€ä¸ªå…¨éƒ¨å¡«å……ä¸º0çš„é¡µé¢</td>
</tr>
</tbody></table>
<ul>
<li>ç»„åˆç±»å‹æ ‡å¿—: å‰é¢æè¿°çš„ä¿®é¥°ç¬¦ç§è¿‡äºç¹å¤šï¼Œå› æ­¤linuxå®šä¹‰äº†ä¸€äº›ç»„åˆçš„ç±»å‹æ ‡å¿—ï¼Œä¾›å¼€å‘è€…ä½¿ç”¨</li>
</ul>
<table>
<thead>
<tr>
<th>flag</th>
<th>element</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>GFP_ATOMIC</td>
<td>__GFP_HIGH|__GFP_ATOMIC|__GFP_KSWAPD_RECLAIM</td>
<td>åˆ†é…è¿‡ç¨‹ä¸èƒ½ä¼‘çœ ï¼Œåˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™å†…å­˜</td>
</tr>
<tr>
<td>GFP_KERNEL</td>
<td>__GFP_RECLAIM|__GFP_IO|__GFP_FS</td>
<td>åˆ†é…å†…å­˜æ—¶å¯ä»¥è¢«é˜»å¡(å³ä¼‘çœ )</td>
</tr>
<tr>
<td>GFP_KERNEL_ACCOUNT</td>
<td>GFP_KERNEL|__GFP_ACCOUNT</td>
<td>å’ŒGFP_KERNELä½œç”¨ä¸€æ ·ï¼Œä½†æ˜¯åˆ†é…çš„è¿‡ç¨‹ä¼šè¢«kmemcgè®°å½•</td>
</tr>
<tr>
<td>GFP_NOWAIT</td>
<td>__GFP_KSWAPD_RECLAIM</td>
<td>åˆ†é…è¿‡ç¨‹ä¸­ä¸å…è®¸å› ç›´æ¥å†…å­˜å›æ”¶è€Œå¯¼è‡´åœé¡¿</td>
</tr>
<tr>
<td>GFP_NOIO</td>
<td>__GFP_RECLAIM</td>
<td>ä¸éœ€è¦å¯åŠ¨ä»»ä½•çš„I&#x2F;Oæ“ä½œ</td>
</tr>
<tr>
<td>GFP_NOFS</td>
<td>__GFP_RECLAIM |__GFP_IO</td>
<td>ä¸ä¼šæœ‰è®¿é—®ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ</td>
</tr>
<tr>
<td>GFP_USER</td>
<td>__GFP_RECLAIM|__GFP_IO|__GFP_FS|__GFP_HARDWALL</td>
<td>ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹åˆ†é…å†…å­˜</td>
</tr>
<tr>
<td>GFP_DMA</td>
<td>__GFP_DMA</td>
<td>ä»ZONE_DMAåŒºåˆ†é…å†…å­˜</td>
</tr>
<tr>
<td>GFP_DMA32</td>
<td>__GFP_DMA32</td>
<td>ä»ZONE_DMA32åŒºåˆ†é…å†…å­˜</td>
</tr>
<tr>
<td>GFP_HIGHUSER</td>
<td>GFP_USER|__GFP_HIGHMEM</td>
<td>ç”¨æˆ·è¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¼˜å…ˆä½¿ç”¨ZONE_HIGHMEMï¼Œ ä¸”è¿™äº›é¡µé¢ä¸å…è®¸è¿ç§»</td>
</tr>
<tr>
<td>GFP_HIGHUSER_MOVABLE</td>
<td>GFP_HIGHUSER|__GFP_MOVABLE</td>
<td>å’ŒGFP_HIGHUSERç±»ä¼¼ï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è¿ç§»</td>
</tr>
<tr>
<td>GFP_TRANSHUGE_LIGHT</td>
<td>(GFP_HIGHUSER_MOVABLE|__GFP_COMP|__GFP_NOMEMALLOC|__GFP_NOWARN)&amp; ~__GFP_RECLAIM</td>
<td>é€æ˜å¤§é¡µçš„å†…å­˜åˆ†é…ï¼Œ lightè¡¨ç¤ºä¸è¿›è¡Œå†…å­˜å‹ç¼©å’Œå›æ”¶</td>
</tr>
<tr>
<td>GFP_TRANSHUGE</td>
<td>GFP_TRANSHUGE_LIGHT|__GFP_DIRECT_RECLAIM</td>
<td>å’ŒGFP_TRANSHUGE_LIGHTç±»ä¼¼ï¼Œé€šå¸¸khugepagedä½¿ç”¨è¯¥æ ‡å¿—</td>
</tr>
</tbody></table>
<h2 id="alloc-contextç»“æ„ä½“"><a href="#alloc-contextç»“æ„ä½“" class="headerlink" title="alloc_contextç»“æ„ä½“"></a>alloc_contextç»“æ„ä½“</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> *<span class="title">zonelist</span>;</span></span><br><span class="line">	<span class="keyword">nodemask_t</span> *nodemask;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">preferred_zoneref</span>;</span></span><br><span class="line">	<span class="keyword">int</span> migratetype;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * highest_zoneidx represents highest usable zone index of</span></span><br><span class="line"><span class="comment">	 * the allocation request. Due to the nature of the zone,</span></span><br><span class="line"><span class="comment">	 * memory on lower zone than the highest_zoneidx will be</span></span><br><span class="line"><span class="comment">	 * protected by lowmem_reserve[highest_zoneidx].</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * highest_zoneidx is also used by reclaim/compaction to limit</span></span><br><span class="line"><span class="comment">	 * the target zone since higher zone than this index cannot be</span></span><br><span class="line"><span class="comment">	 * usable for this allocation request.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">highest_zoneidx</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> spread_dirty_pages;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€ä¸ªåˆ†é…è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬å•æ¬¡å†…å­˜åˆ†é…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<p>è¿™é‡Œä¸»è¦å…³æ³¨çš„æ˜¯å…¶ä¸­çš„ä¸€ä¸ªæˆå‘˜<code>zonelist</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> _<span class="title">zonerefs</span>[<span class="title">MAX_ZONES_PER_ZONELIST</span> + 1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¯¥æˆå‘˜è¡¨ç¤ºåœ¨è¿™ä¸€æ¬¡çš„åˆ†é…ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è¦æ“ä½œçš„ zone çš„åˆ—è¡¨ï¼Œå…¶ä¸ºä¸€ä¸ª <code>zonelist</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ã€‚å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸ºä¸€ä¸ª <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span>	<span class="comment">/* Pointer to actual zone */</span></span><br><span class="line">	<span class="keyword">int</span> zone_idx;		<span class="comment">/* zone_idx(zoneref-&gt;zone) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è€Œè¿™ä¸ªç»“æ„ä½“åœ¨ä¸Šæ–‡ä¸­æè¿‡ï¼ŒåŒ…å«äº†ä¸€ä¸ª zone çš„æŒ‡é’ˆä»¥åŠä¸€ä¸ª indexã€‚</p>
<p>éšåå†çœ‹<code>alloc_context</code>ç»“æ„ä½“ä¸­çš„<code>preferred_zoneref</code>æˆå‘˜ï¼Œè¯¥æˆå‘˜ä¸ºä¸€ä¸ª <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“ï¼Œè¡¨ç¤ºä¼˜å…ˆç”¨æ¥è¿›è¡Œåˆ†é…çš„ zoneã€‚</p>
<p>æœ€ååˆ™æ˜¯<code>spread_dirty_pages</code>æˆå‘˜ï¼Œè¡¨ç¤ºæ­¤æ¬¡åˆ†é…æ˜¯å¦å¯èƒ½äº§ç”Ÿè„é¡µï¼ˆéœ€è¦è¿›è¡Œå†™å›ï¼‰ï¼Œé€šå¸¸åˆ†é…éœ€è¦å†™å…¥çš„é¡µä¼šå‡ºç°ã€‚</p>
<h2 id="alloc-pageså‡½æ•°"><a href="#alloc-pageså‡½æ•°" class="headerlink" title="__alloc_pageså‡½æ•°"></a>__alloc_pageså‡½æ•°</h2><p>æ­¤å‡½æ•°ä¸º<code>buddy system</code>åˆ†é…é¡µé¢çš„æ ¸å¿ƒå‡½æ•°ï¼Œæ‰€æœ‰çš„é¡µé¢åˆ†é… API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">alloc_pages</span>(<span class="title">gfp_t</span> <span class="title">gfp</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>, <span class="title">int</span> <span class="title">preferred_nid</span>,</span></span><br><span class="line"><span class="class">							<span class="title">nodemask_t</span> *<span class="title">nodemask</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags = ALLOC_WMARK_LOW;</span><br><span class="line">	<span class="keyword">gfp_t</span> alloc_gfp; <span class="comment">/* The gfp_t that was actually used for allocation */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> <span class="title">ac</span> =</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * There are several places where we assume that the order value is sane</span></span><br><span class="line"><span class="comment">	 * so bail out early if the request is out of bound.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON_ONCE_GFP(order &gt; MAX_ORDER, gfp))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	gfp &amp;= gfp_allowed_mask;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Apply scoped allocation constraints. This is mainly about GFP_NOFS</span></span><br><span class="line"><span class="comment">	 * resp. GFP_NOIO which has to be inherited for all allocation requests</span></span><br><span class="line"><span class="comment">	 * from a particular context which has been marked by</span></span><br><span class="line"><span class="comment">	 * memalloc_no&#123;fs,io&#125;_&#123;save,restore&#125;. And PF_MEMALLOC_PIN which ensures</span></span><br><span class="line"><span class="comment">	 * movable zones are not used during allocation.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	gfp = current_gfp_context(gfp);</span><br><span class="line">	alloc_gfp = gfp;</span><br><span class="line">	<span class="keyword">if</span> (!prepare_alloc_pages(gfp, order, preferred_nid, nodemask, &amp;ac,</span><br><span class="line">			&amp;alloc_gfp, &amp;alloc_flags))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Forbid the first pass from falling back to types that fragment</span></span><br><span class="line"><span class="comment">	 * memory until all local zones are considered.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* First allocation attempt */</span></span><br><span class="line">	page = get_page_from_freelist(alloc_gfp, order, alloc_flags, &amp;ac);</span><br><span class="line">	<span class="keyword">if</span> (likely(page))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	alloc_gfp = gfp;</span><br><span class="line">	ac.spread_dirty_pages = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Restore the original nodemask if it was potentially replaced with</span></span><br><span class="line"><span class="comment">	 * &amp;cpuset_current_mems_allowed to optimize the fast-path attempt.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ac.nodemask = nodemask;</span><br><span class="line"></span><br><span class="line">	page = __alloc_pages_slowpath(alloc_gfp, order, &amp;ac);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">if</span> (memcg_kmem_online() &amp;&amp; (gfp &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;</span><br><span class="line">	    unlikely(__memcg_kmem_charge_page(page, gfp, order) != <span class="number">0</span>)) &#123;</span><br><span class="line">		__free_pages(page, order);</span><br><span class="line">		page = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	trace_mm_page_alloc(page, order, alloc_gfp, ac.migratetype);</span><br><span class="line">	kmsan_alloc_page(page, order, alloc_gfp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__alloc_pages);</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°éœ€è¦ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>gfp</code>åˆ†é…è¡Œä¸ºå‚æ•°ã€<code>order</code>åˆ†é…çš„ç‰©ç†é¡µæ¡†çš„é˜¶ã€<code>preferred_nid</code>é€‰å–çš„èŠ‚ç‚¹idã€<code>nodemask</code>åˆ†é…æ—¶å¯ä¾›å€™é€‰çš„nodeæ©ç ã€‚</p>
<p>å› ä¸ºåœ¨å‰é¢çš„æ–‡ç« ä¸­å·²ç»æåˆ°è¿‡äº†å†…å­˜åˆ†é…ï¼Œä¸è¿‡åªæ˜¯ä»slabä¸­åˆ†é…æˆ‘ä»¬ä¹Ÿå¤§æ¦‚æ¸…æ¥šå†…å­˜åˆ†é…å‡½æ•°ä¸€èˆ¬çš„æµç¨‹ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–ã€‚é¦–å…ˆï¼Œæ£€æŸ¥å‚æ•°åˆæ³•æ€§ï¼Œå¹¶åšåˆ†é…å‰å‡†å¤‡å·¥ä½œã€‚éšåè¿›è¡Œå¿«é€Ÿåˆ†é…ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ç»“æœã€‚æœ€åï¼Œè‹¥å¿«é€Ÿåˆ†é…å¤±è´¥ï¼Œåˆ™è¿›è¡Œæ…¢é€Ÿåˆ†é…ã€‚</p>
<p>æ¥ä¸‹æ¥å°±ç»§ç»­ç»†è‡´çš„å¼€å§‹åˆ†æå‡½æ•°äº†ï¼Œè¿›å…¥å‡½æ•°ä¼šå…ˆæ£€éªŒ<code>order</code>æ˜¯å¦è¶…è¿‡äº†<code>MAX_ORDER</code>ã€‚éšåä¼šè¿›å…¥åˆ°<code>prepare_alloc_pages</code>å‡½æ•°è¿›è¡Œåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">prepare_alloc_pages</span><span class="params">(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">int</span> preferred_nid, <span class="keyword">nodemask_t</span> *nodemask,</span></span></span><br><span class="line"><span class="params"><span class="function">		struct alloc_context *ac, <span class="keyword">gfp_t</span> *alloc_gfp,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">int</span> *alloc_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ac-&gt;highest_zoneidx = gfp_zone(gfp_mask);</span><br><span class="line">	ac-&gt;zonelist = node_zonelist(preferred_nid, gfp_mask);</span><br><span class="line">	ac-&gt;nodemask = nodemask;</span><br><span class="line">	ac-&gt;migratetype = gfp_migratetype(gfp_mask);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cpusets_enabled()) &#123;</span><br><span class="line">		*alloc_gfp |= __GFP_HARDWALL;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * When we are in the interrupt context, it is irrelevant</span></span><br><span class="line"><span class="comment">		 * to the current task context. It means that any node ok.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (in_task() &amp;&amp; !ac-&gt;nodemask)</span><br><span class="line">			ac-&gt;nodemask = &amp;cpuset_current_mems_allowed;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			*alloc_flags |= ALLOC_CPUSET;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	might_alloc(gfp_mask);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (should_fail_alloc_page(gfp_mask, order))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	*alloc_flags = gfp_to_alloc_flags_cma(gfp_mask, *alloc_flags);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Dirty zone balancing only done in the fast path */</span></span><br><span class="line">	ac-&gt;spread_dirty_pages = (gfp_mask &amp; __GFP_WRITE);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The preferred zone is used for statistics but crucially it is</span></span><br><span class="line"><span class="comment">	 * also used as the starting point for the zonelist iterator. It</span></span><br><span class="line"><span class="comment">	 * may get reset for allocations that ignore memory policies.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">					ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè°ƒç”¨<code>node_zonelist</code>å‡½æ•°ä»<code>preferred_nid</code>å‚æ•°æŒ‡å®šçš„nodeä¸­è·å–ä¸€ä¸ª<code>zonelist</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NODE_DATA(nid)		(node_data[nid])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct zonelist *<span class="title">node_zonelist</span><span class="params">(<span class="keyword">int</span> nid, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> NODE_DATA(nid)-&gt;node_zonelists + gfp_zonelist(flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›è¡Œ cpuset ç›¸å…³åˆ¤æ–­ä¸æ ‡å¿—ä½è®¾ç½®ï¼Œè‹¥æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡åˆ™ç›´æ¥å°† nodemask è®¾ä¸º <code>cpuset_current_mems_allowed</code>ã€‚</p>
<p>æœ€åè°ƒç”¨ <code>first_zones_zonelist()</code> è®¾ç½®<code>preferred zone</code>ï¼Œå¤§æ¦‚æ˜¯åœ¨<code>zonelist</code>ä¸­<code>nodemask</code>æ‰€åŒ…å«çš„zoneä¸­ <code>highest_zoneidx</code> ä»¥ä¸‹çš„ç¬¬ä¸€ä¸ª zoneã€‚</p>
<p>æ€»çš„æ¥è¯´è¿™ä¸ªå‡½æ•°ä¸»è¦åšçš„äº‹å°±æ˜¯åˆ†é…å‰çš„ä¸€äº›å‡†å¤‡çš„å·¥ä½œï¼ŒåŒ…æ‹¬åˆå§‹åŒ– <code>alloc_context</code> ç»“æ„ä½“ã€è·å– zone æ•°ç»„ç­‰ã€‚</p>
<h3 id="get-page-from-freelistå‡½æ•°"><a href="#get-page-from-freelistå‡½æ•°" class="headerlink" title="get_page_from_freelistå‡½æ•°"></a>get_page_from_freelistå‡½æ•°</h3><p>æ ¹æ®<code>__alloc_pages</code>å‡½æ•°çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥è¿›å…¥çš„å°±æ˜¯<code>get_page_from_freelist</code>å‡½æ•°äº†ï¼Œè€Œè¿™ä¸€å‡½æ•°å°±æ˜¯å‰é¢æåˆ°çš„å¿«é€Ÿåˆ†é…è·¯å¾„äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct page *</span></span><br><span class="line"><span class="function"><span class="title">get_page_from_freelist</span><span class="params">(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">int</span> alloc_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">						<span class="keyword">const</span> struct alloc_context *ac)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">z</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> *<span class="title">last_pgdat</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">bool</span> last_pgdat_dirty_ok = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">bool</span> no_fallback;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Scan zonelist, looking for a zone with enough free.</span></span><br><span class="line"><span class="comment">	 * See also cpuset_node_allowed() comment in kernel/cgroup/cpuset.c.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	no_fallback = alloc_flags &amp; ALLOC_NOFRAGMENT;</span><br><span class="line">	z = ac-&gt;preferred_zoneref;</span><br><span class="line">	for_next_zone_zonelist_nodemask(zone, z, ac-&gt;highest_zoneidx,</span><br><span class="line">					ac-&gt;nodemask) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> mark;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cpusets_enabled() &amp;&amp;</span><br><span class="line">			(alloc_flags &amp; ALLOC_CPUSET) &amp;&amp;</span><br><span class="line">			!__cpuset_zone_allowed(zone, gfp_mask))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * When allocating a page cache page for writing, we</span></span><br><span class="line"><span class="comment">		 * want to get it from a node that is within its dirty</span></span><br><span class="line"><span class="comment">		 * limit, such that no single node holds more than its</span></span><br><span class="line"><span class="comment">		 * proportional share of globally allowed dirty pages.</span></span><br><span class="line"><span class="comment">		 * The dirty limits take into account the node&#x27;s</span></span><br><span class="line"><span class="comment">		 * lowmem reserves and high watermark so that kswapd</span></span><br><span class="line"><span class="comment">		 * should be able to balance it without having to</span></span><br><span class="line"><span class="comment">		 * write pages from its LRU list.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">XXX:</span> For now, allow allocations to potentially</span></span><br><span class="line"><span class="comment">		 * exceed the per-node dirty limit in the slowpath</span></span><br><span class="line"><span class="comment">		 * (spread_dirty_pages unset) before going into reclaim,</span></span><br><span class="line"><span class="comment">		 * which is important when on a NUMA setup the allowed</span></span><br><span class="line"><span class="comment">		 * nodes are together not big enough to reach the</span></span><br><span class="line"><span class="comment">		 * global limit.  The proper fix for these situations</span></span><br><span class="line"><span class="comment">		 * will require awareness of nodes in the</span></span><br><span class="line"><span class="comment">		 * dirty-throttling and the flusher threads.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (ac-&gt;spread_dirty_pages) &#123;</span><br><span class="line">			<span class="keyword">if</span> (last_pgdat != zone-&gt;zone_pgdat) &#123;</span><br><span class="line">				last_pgdat = zone-&gt;zone_pgdat;</span><br><span class="line">				last_pgdat_dirty_ok = node_dirty_ok(zone-&gt;zone_pgdat);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!last_pgdat_dirty_ok)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (no_fallback &amp;&amp; nr_online_nodes &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">		    zone != ac-&gt;preferred_zoneref-&gt;zone) &#123;</span><br><span class="line">			<span class="keyword">int</span> local_nid;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If moving to a remote node, retry but allow</span></span><br><span class="line"><span class="comment">			 * fragmenting fallbacks. Locality is more important</span></span><br><span class="line"><span class="comment">			 * than fragmentation avoidance.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			local_nid = zone_to_nid(ac-&gt;preferred_zoneref-&gt;zone);</span><br><span class="line">			<span class="keyword">if</span> (zone_to_nid(zone) != local_nid) &#123;</span><br><span class="line">				alloc_flags &amp;= ~ALLOC_NOFRAGMENT;</span><br><span class="line">				<span class="keyword">goto</span> retry;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Detect whether the number of free pages is below high</span></span><br><span class="line"><span class="comment">		 * watermark.  If so, we will decrease pcp-&gt;high and free</span></span><br><span class="line"><span class="comment">		 * PCP pages in free path to reduce the possibility of</span></span><br><span class="line"><span class="comment">		 * premature page reclaiming.  Detection is done here to</span></span><br><span class="line"><span class="comment">		 * avoid to do that in hotter free path.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (test_bit(ZONE_BELOW_HIGH, &amp;zone-&gt;flags))</span><br><span class="line">			<span class="keyword">goto</span> check_alloc_wmark;</span><br><span class="line"></span><br><span class="line">		mark = high_wmark_pages(zone);</span><br><span class="line">		<span class="keyword">if</span> (zone_watermark_fast(zone, order, mark,</span><br><span class="line">					ac-&gt;highest_zoneidx, alloc_flags,</span><br><span class="line">					gfp_mask))</span><br><span class="line">			<span class="keyword">goto</span> try_this_zone;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			set_bit(ZONE_BELOW_HIGH, &amp;zone-&gt;flags);</span><br><span class="line"></span><br><span class="line">check_alloc_wmark:</span><br><span class="line">		mark = wmark_pages(zone, alloc_flags &amp; ALLOC_WMARK_MASK);</span><br><span class="line">		<span class="keyword">if</span> (!zone_watermark_fast(zone, order, mark,</span><br><span class="line">				       ac-&gt;highest_zoneidx, alloc_flags,</span><br><span class="line">				       gfp_mask)) &#123;</span><br><span class="line">			<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (has_unaccepted_memory()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (try_to_accept_memory(zone, order))</span><br><span class="line">					<span class="keyword">goto</span> try_this_zone;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Watermark failed for this zone, but see if we can</span></span><br><span class="line"><span class="comment">			 * grow this zone if it contains deferred pages.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (deferred_pages_enabled()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (_deferred_grow_zone(zone, order))</span><br><span class="line">					<span class="keyword">goto</span> try_this_zone;</span><br><span class="line">			&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="comment">/* Checked here to keep the fast path fast */</span></span><br><span class="line">			BUILD_BUG_ON(ALLOC_NO_WATERMARKS &lt; NR_WMARK);</span><br><span class="line">			<span class="keyword">if</span> (alloc_flags &amp; ALLOC_NO_WATERMARKS)</span><br><span class="line">				<span class="keyword">goto</span> try_this_zone;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!node_reclaim_enabled() ||</span><br><span class="line">			    !zone_allows_reclaim(ac-&gt;preferred_zoneref-&gt;zone, zone))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">			ret = node_reclaim(zone-&gt;zone_pgdat, gfp_mask, order);</span><br><span class="line">			<span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">			<span class="keyword">case</span> NODE_RECLAIM_NOSCAN:</span><br><span class="line">				<span class="comment">/* did not scan */</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">case</span> NODE_RECLAIM_FULL:</span><br><span class="line">				<span class="comment">/* scanned but unreclaimable */</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="comment">/* did we reclaim enough */</span></span><br><span class="line">				<span class="keyword">if</span> (zone_watermark_ok(zone, order, mark,</span><br><span class="line">					ac-&gt;highest_zoneidx, alloc_flags))</span><br><span class="line">					<span class="keyword">goto</span> try_this_zone;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">try_this_zone:</span><br><span class="line">		page = rmqueue(ac-&gt;preferred_zoneref-&gt;zone, zone, order,</span><br><span class="line">				gfp_mask, alloc_flags, ac-&gt;migratetype);</span><br><span class="line">		<span class="keyword">if</span> (page) &#123;</span><br><span class="line">			prep_new_page(page, order, gfp_mask, alloc_flags);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If this is a high-order atomic allocation then check</span></span><br><span class="line"><span class="comment">			 * if the pageblock should be reserved for the future</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (unlikely(alloc_flags &amp; ALLOC_HIGHATOMIC))</span><br><span class="line">				reserve_highatomic_pageblock(page, zone);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> page;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (has_unaccepted_memory()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (try_to_accept_memory(zone, order))</span><br><span class="line">					<span class="keyword">goto</span> try_this_zone;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line">			<span class="comment">/* Try again if zone has deferred pages */</span></span><br><span class="line">			<span class="keyword">if</span> (deferred_pages_enabled()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (_deferred_grow_zone(zone, order))</span><br><span class="line">					<span class="keyword">goto</span> try_this_zone;</span><br><span class="line">			&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * It&#x27;s possible on a UMA machine to get through all zones that are</span></span><br><span class="line"><span class="comment">	 * fragmented. If avoiding fragmentation, reset and try again.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (no_fallback) &#123;</span><br><span class="line">		alloc_flags &amp;= ~ALLOC_NOFRAGMENT;</span><br><span class="line">		<span class="keyword">goto</span> retry;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°çš„æµç¨‹å¤§ä½“å¦‚ä¸‹ï¼Œä½¿ç”¨<code>for_next_zone_zonelist_nodemask</code>å®è¿­ä»£éå†åˆ†é…ä¸Šä¸‹æ–‡ä¸­çš„<code>zonelist</code>ä¸­çš„<code>zoneref</code>æ•°ç»„å¯¹åº”çš„zone</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> for_next_zone_zonelist_nodemask(zone, z, highidx, nodemask) \</span></span><br><span class="line"><span class="meta">	for (zone = z-&gt;zone;	\</span></span><br><span class="line"><span class="meta">		zone;							\</span></span><br><span class="line"><span class="meta">		z = next_zones_zonelist(++z, highidx, nodemask),	\</span></span><br><span class="line"><span class="meta">			zone = zonelist_zone(z))</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>next_zones_zonelist</code>å‡½æ•°è¿”å›çš„æ˜¯åœ¨<code>nodemask</code>çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„ï¼ˆä½äºæˆ–ä½äºï¼‰<code>highest_zoneidx</code> çš„ä¸‹ä¸€ä¸ª zoneã€‚</p>
<p>æ¥ä¸‹æ¥è¿›å…¥å¾ªç¯ä½“å†…éƒ¨ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦å¼€å¯cpusetå¹¶æ£€æŸ¥å½“å‰ zone æ˜¯å¦æ»¡è¶³ cpuset çš„è¦æ±‚ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zoneã€‚</p>
<p>æ£€æŸ¥å½“å‰ zone å¯¹åº” node çš„è„é¡µæ•°é‡æ˜¯å¦è¶…å‡ºé™åˆ¶ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zoneã€‚</p>
<p>è‹¥<code>alloc_flags</code>åŒ…å«<code>ALLOC_NOFRAGMENT</code>ä½†æ˜¯å½“å‰ zone é<code>preferred zone</code>ã€ä¸”å¯¹åº” node éƒ¨ä½<code>local node</code>ï¼Œåˆ™æ¸…é™¤è¯¥æ ‡å¿—ä½åé‡æ–°å¼€å§‹åˆ†é…ï¼Œå› ä¸º locality æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦ã€‚</p>
<p>åé¢åˆ™æ˜¯å¯¹æ°´ä½çº¿çš„ä¸€äº›åˆ¤æ–­ï¼Œé¦–å…ˆæ˜¯è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°ï¼Œè‹¥æ˜¯è®¾ç½®äº† <code>ALLOC_NO_WATERMARKS</code> åˆ™ç›´æ¥åˆ°ä¸‹ä¸€æ­¥è¿›è¡Œåˆ†é…ï¼Œè‹¥æ°´ä½çº¿æ£€æŸ¥æœªé€šè¿‡ï¼Œè°ƒç”¨ <code>node_reclaim()</code> è¿›è¡Œé¡µé¢å›æ”¶ï¼Œè‹¥å›æ”¶åé¡µé¢è¿˜æ˜¯ä¸è¶³ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zoneã€‚</p>
<p>åœ¨ç»å†äº†å‰é¢çš„forå¾ªç¯ä¹‹åæœ€ç»ˆè°ƒç”¨<code>rmqueue</code>å‡½æ•°è¿›è¡Œæ­£å¼çš„å†…å­˜åˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span></span><br><span class="line"><span class="function">struct page *<span class="title">rmqueue</span><span class="params">(struct zone *preferred_zone,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct zone *zone, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">gfp_t</span> gfp_flags, <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">int</span> migratetype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We most definitely don&#x27;t want callers attempting to</span></span><br><span class="line"><span class="comment">	 * allocate greater than order-1 page units with __GFP_NOFAIL.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	WARN_ON_ONCE((gfp_flags &amp; __GFP_NOFAIL) &amp;&amp; (order &gt; <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (likely(pcp_allowed_order(order))) &#123;</span><br><span class="line">		page = rmqueue_pcplist(preferred_zone, zone, order,</span><br><span class="line">				       migratetype, alloc_flags);</span><br><span class="line">		<span class="keyword">if</span> (likely(page))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	page = rmqueue_buddy(preferred_zone, zone, order, alloc_flags,</span><br><span class="line">							migratetype);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="comment">/* Separate test+clear to avoid unnecessary atomics */</span></span><br><span class="line">	<span class="keyword">if</span> ((alloc_flags &amp; ALLOC_KSWAPD) &amp;&amp;</span><br><span class="line">	    unlikely(test_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags))) &#123;</span><br><span class="line">		clear_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags);</span><br><span class="line">		wakeup_kswapd(zone, <span class="number">0</span>, <span class="number">0</span>, zone_idx(zone));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON_PAGE(page &amp;&amp; bad_range(zone, page), page);</span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°è¿›å…¥ä¹‹åä¼šé¦–å…ˆéªŒè¯ç”³è¯·çš„<code>order</code>æ˜¯å¦æ»¡è¶³é€šè¿‡pcpç”³è¯·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">pcp_allowed_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (order &lt;= PAGE_ALLOC_COSTLY_ORDER)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRANSPARENT_HUGEPAGE</span></span><br><span class="line">	<span class="keyword">if</span> (order == pageblock_order)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„pcpæŒ‡çš„æ˜¯<code>per-cpu pageset</code>ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹<code>per-cpu pageset</code>çš„æ¦‚å¿µï¼ˆåœ¨è€ç‰ˆæœ¬çš„Linuxå†…æ ¸ä¸­è¿™çš„orderä¸€èˆ¬åªå…è®¸ä¸º0æ—¶ä»pcpä¸­ç”³è¯·ï¼Œå‘ç°åœ¨æ–°ç‰ˆæœ¬çš„å†…æ ¸ä¸­å¥½åƒæ˜¯å°äºç­‰äº3å³å¯ï¼‰ï¼Œåœ¨Linuxç³»ç»Ÿä¸­ï¼Œå­˜åœ¨å¾ˆå¤šé˜¶ä¸º0çš„ç”³è¯·è¯·æ±‚ï¼Œå¦‚æœæ¯ä¸€æ¬¡çš„ç”³è¯·è¯·æ±‚éƒ½éœ€è¦è·å–<code>zone-&gt;lock</code>çš„è¯ï¼Œåœ¨è¶Šå¤šçš„cpuæ ¸å¿ƒçš„æƒ…å†µä¸‹å°±ä¼šå‡ºç°è¶Šå¤šçš„é”çš„ç«äº‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒLinuxé‡‡ç”¨çš„åŠæ³•å°±æ˜¯ä½¿ç”¨<code>per-cpu pageset</code>å³pcpï¼Œå…¶ä¼šä¸€æ¬¡æ€§æ‹¿å¾ˆå¤šé¡µå­˜æ”¾åœ¨cpuä¸­ï¼Œå¹¶ä¸”é‡Šæ”¾çš„é¡µä¹Ÿä¼šç»§ç»­å­˜æ”¾åœ¨è¿™é‡Œï¼Œç­‰é‡Šæ”¾çš„é¡µæ»¡äº†æ‰ä¼šä¸€å¹¶æ”¾å›åˆ°zoneä¸­ï¼ˆæˆ‘çš„ç†è§£å°±æ˜¯ä¸€ä¸ªcacheï¼‰ã€‚</p>
<p>åœ¨é€šè¿‡orderçš„æ£€éªŒä¹‹åå°±ä¼šè¿›å…¥å†…éƒ¨è°ƒç”¨<code>rmqueue_pcplist</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct page *<span class="title">rmqueue_pcplist</span><span class="params">(struct zone *preferred_zone,</span></span></span><br><span class="line"><span class="params"><span class="function">			struct zone *zone, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">int</span> migratetype, <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> *<span class="title">pcp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> __maybe_unused UP_flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* spin_trylock may fail due to a parallel drain or IRQ reentrancy. */</span></span><br><span class="line">	pcp_trylock_prepare(UP_flags);</span><br><span class="line">	pcp = pcp_spin_trylock(zone-&gt;per_cpu_pageset);</span><br><span class="line">	<span class="keyword">if</span> (!pcp) &#123;</span><br><span class="line">		pcp_trylock_finish(UP_flags);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On allocation, reduce the number of pages that are batch freed.</span></span><br><span class="line"><span class="comment">	 * See nr_pcp_free() where free_factor is increased for subsequent</span></span><br><span class="line"><span class="comment">	 * frees.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	pcp-&gt;free_count &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">list</span> = &amp;pcp-&gt;lists[order_to_pindex(migratetype, order)];</span><br><span class="line">	page = __rmqueue_pcplist(zone, order, migratetype, alloc_flags, pcp, <span class="built_in">list</span>);</span><br><span class="line">	pcp_spin_unlock(pcp);</span><br><span class="line">	pcp_trylock_finish(UP_flags);</span><br><span class="line">	<span class="keyword">if</span> (page) &#123;</span><br><span class="line">		__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="number">1</span> &lt;&lt; order);</span><br><span class="line">		zone_statistics(preferred_zone, zone, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>rmqueue_pcplist</code>å‡½æ•°çš„åŸºæœ¬æµç¨‹å°±æ˜¯é¦–å…ˆè·å–æ‰pcpï¼Œéšåé€šè¿‡<code>order</code>å’Œè¿ç§»ç±»å‹é€‰æ‹©å¯¹åº”çš„listï¼ˆå½“ç„¶åœ¨è€ç‰ˆæœ¬çš„Linuxå†…æ ¸ä¸­æ˜¯ä¸éœ€è¦orderçš„ï¼‰ï¼Œéšåè°ƒç”¨<code>__rmqueue_pcplist</code>å‡½æ•°çœŸæ­£ç”³è¯·é¡µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_pcplist</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class">			<span class="title">int</span> <span class="title">migratetype</span>,</span></span><br><span class="line"><span class="class">			<span class="title">unsigned</span> <span class="title">int</span> <span class="title">alloc_flags</span>,</span></span><br><span class="line"><span class="class">			<span class="keyword">struct</span> <span class="title">per_cpu_pages</span> *<span class="title">pcp</span>,</span></span><br><span class="line"><span class="class">			<span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">list</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (list_empty(<span class="built_in">list</span>)) &#123;</span><br><span class="line">			<span class="keyword">int</span> batch = nr_pcp_alloc(pcp, zone, order);</span><br><span class="line">			<span class="keyword">int</span> alloced;</span><br><span class="line"></span><br><span class="line">			alloced = rmqueue_bulk(zone, order,</span><br><span class="line">					batch, <span class="built_in">list</span>,</span><br><span class="line">					migratetype, alloc_flags);</span><br><span class="line"></span><br><span class="line">			pcp-&gt;count += alloced &lt;&lt; order;</span><br><span class="line">			<span class="keyword">if</span> (unlikely(list_empty(<span class="built_in">list</span>)))</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		page = list_first_entry(<span class="built_in">list</span>, struct page, pcp_list);</span><br><span class="line">		list_del(&amp;page-&gt;pcp_list);</span><br><span class="line">		pcp-&gt;count -= <span class="number">1</span> &lt;&lt; order;</span><br><span class="line">	&#125; <span class="keyword">while</span> (check_new_pages(page, order));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>__rmqueue_pcplist</code>å‡½æ•°çš„é€»è¾‘æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œé¦–å…ˆä¼šåˆ¤æ–­<code>list</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è°ƒç”¨<code>rmqueue_bulk</code>å‡½æ•°ä»<code>zone</code>å–é¡µåˆ°pcpä¸­ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ç›´æ¥å–é¡µé¢éšåé€šè¿‡<code>check_new_pages</code>å‡½æ•°è¿›è¡Œæ£€æµ‹ï¼Œé€šè¿‡åˆ™ç›´æ¥è¿”å›é¡µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rmqueue_bulk</span><span class="params">(struct zone *zone, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">long</span> count, struct list_head *<span class="built_in">list</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">int</span> migratetype, <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	spin_lock_irqsave(&amp;zone-&gt;lock, flags);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> __rmqueue(zone, order, migratetype,</span><br><span class="line">								alloc_flags);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(page == <span class="literal">NULL</span>))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Split buddy pages returned by expand() are received here in</span></span><br><span class="line"><span class="comment">		 * physical page order. The page is added to the tail of</span></span><br><span class="line"><span class="comment">		 * caller&#x27;s list. From the callers perspective, the linked list</span></span><br><span class="line"><span class="comment">		 * is ordered by page number under some conditions. This is</span></span><br><span class="line"><span class="comment">		 * useful for IO devices that can forward direction from the</span></span><br><span class="line"><span class="comment">		 * head, thus also in the physical page order. This is useful</span></span><br><span class="line"><span class="comment">		 * for IO devices that can merge IO requests if the physical</span></span><br><span class="line"><span class="comment">		 * pages are ordered properly.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		list_add_tail(&amp;page-&gt;pcp_list, <span class="built_in">list</span>);</span><br><span class="line">		<span class="keyword">if</span> (is_migrate_cma(get_pcppage_migratetype(page)))</span><br><span class="line">			__mod_zone_page_state(zone, NR_FREE_CMA_PAGES,</span><br><span class="line">					      -(<span class="number">1</span> &lt;&lt; order));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	__mod_zone_page_state(zone, NR_FREE_PAGES, -(i &lt;&lt; order));</span><br><span class="line">	spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç®€å•çœ‹ä¸€ä¸‹<code>rmqueue_bulk</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šè¿›è¡Œ<code>batch</code>æ¬¡å¾ªç¯é€šè¿‡<code>__rmqueue</code>å‡½æ•°ç”³è¯·pageå¹¶å‘é“¾è¡¨ä¸­åŠ å…¥ã€‚è¿™é‡Œå‡½æ•°å†…éƒ¨çš„<code>__rmqueue</code>å‡½æ•°ç•™åœ¨åé¢ä¸€å¹¶æ¢³ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline</span></span><br><span class="line"><span class="function">struct page *<span class="title">rmqueue_buddy</span><span class="params">(struct zone *preferred_zone, struct zone *zone,</span></span></span><br><span class="line"><span class="params"><span class="function">			   <span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">			   <span class="keyword">int</span> migratetype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		page = <span class="literal">NULL</span>;</span><br><span class="line">		spin_lock_irqsave(&amp;zone-&gt;lock, flags);</span><br><span class="line">		<span class="keyword">if</span> (alloc_flags &amp; ALLOC_HIGHATOMIC)</span><br><span class="line">			page = __rmqueue_smallest(zone, order, MIGRATE_HIGHATOMIC);</span><br><span class="line">		<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">			page = __rmqueue(zone, order, migratetype, alloc_flags);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If the allocation fails, allow OOM handling access</span></span><br><span class="line"><span class="comment">			 * to HIGHATOMIC reserves as failing now is worse than</span></span><br><span class="line"><span class="comment">			 * failing a high-order atomic allocation in the</span></span><br><span class="line"><span class="comment">			 * future.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (!page &amp;&amp; (alloc_flags &amp; ALLOC_OOM))</span><br><span class="line">				page = __rmqueue_smallest(zone, order, MIGRATE_HIGHATOMIC);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">				spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		__mod_zone_freepage_state(zone, -(<span class="number">1</span> &lt;&lt; order),</span><br><span class="line">					  get_pcppage_migratetype(page));</span><br><span class="line">		spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line">	&#125; <span class="keyword">while</span> (check_new_pages(page, order));</span><br><span class="line"></span><br><span class="line">	__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="number">1</span> &lt;&lt; order);</span><br><span class="line">	zone_statistics(preferred_zone, zone, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå›åˆ°<code>rmqueue</code>å‡½æ•°çš„æµç¨‹ï¼Œå¦‚æœç”³è¯·çš„<code>order</code>ä¸èƒ½ç›´æ¥é€šè¿‡pcpè¿›è¡Œç”³è¯·æ˜¯åˆ™ä¼šè¿›å…¥<code>rmqueue_buddy</code>å‡½æ•°ä¸­ã€‚å‡½æ•°å†…éƒ¨å…¶ä¼šæ ¹æ®ä¸åŒçš„<code>alloc_flags</code>é€šè¿‡ä¸åŒçš„å‡½æ•°è¿›è¡Œåˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">rmqueue</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>, <span class="title">int</span> <span class="title">migratetype</span>,</span></span><br><span class="line"><span class="class">						<span class="title">unsigned</span> <span class="title">int</span> <span class="title">alloc_flags</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_CMA)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Balance movable allocations between regular and CMA areas by</span></span><br><span class="line"><span class="comment">		 * allocating from CMA when over half of the zone&#x27;s free memory</span></span><br><span class="line"><span class="comment">		 * is in the CMA area.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (alloc_flags &amp; ALLOC_CMA &amp;&amp;</span><br><span class="line">		    zone_page_state(zone, NR_FREE_CMA_PAGES) &gt;</span><br><span class="line">		    zone_page_state(zone, NR_FREE_PAGES) / <span class="number">2</span>) &#123;</span><br><span class="line">			page = __rmqueue_cma_fallback(zone, order);</span><br><span class="line">			<span class="keyword">if</span> (page)</span><br><span class="line">				<span class="keyword">return</span> page;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">retry:</span><br><span class="line">	page = __rmqueue_smallest(zone, order, migratetype);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!page)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (alloc_flags &amp; ALLOC_CMA)</span><br><span class="line">			page = __rmqueue_cma_fallback(zone, order);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!page &amp;&amp; __rmqueue_fallback(zone, order, migratetype,</span><br><span class="line">								alloc_flags))</span><br><span class="line">			<span class="keyword">goto</span> retry;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹<code>__rmqueue</code>å‡½æ•°ï¼Œå¯ä»¥å‘ç°å…¶å†…éƒ¨å®é™…è°ƒç”¨çš„è¿˜æ˜¯<code>__rmqueue_smallest</code>å‡½æ•°è¿›è¡Œåˆ†é…çš„ï¼Œä¸è¿‡å‰é¢ä¼šåˆ¤æ–­æ˜¯å¦åˆ†é…CMAï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>__rmqueue_cma_fallback</code>è¿›è¡Œåˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_cma_fallback</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>,</span></span><br><span class="line"><span class="class">					<span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">return</span> __rmqueue_smallest(zone, order, MIGRATE_CMA);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_cma_fallback</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>,</span></span><br><span class="line"><span class="class">					<span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>) &#123;</span> <span class="keyword">return</span> <span class="literal">NULL</span>; &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>çœ‹å…¶å®šä¹‰å…¶å®ä¹Ÿåªæ˜¯ä¿®æ”¹äº†è¿ç§»ç±»å‹ä¹‹åè°ƒç”¨<code>__rmqueue_smallest</code>å‡½æ•°ï¼Œè€Œæ•´ä¸ª<code>buddy system</code>æœ€æ ¸å¿ƒçš„å‡½æ•°å°±æ˜¯<code>__rmqueue_smallest</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_smallest</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class">						<span class="title">int</span> <span class="title">migratetype</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> current_order;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> *<span class="title">area</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Find a page of the appropriate size in the preferred list */</span></span><br><span class="line">	<span class="keyword">for</span> (current_order = order; current_order &lt;= MAX_ORDER; ++current_order) &#123;</span><br><span class="line">		area = &amp;(zone-&gt;free_area[current_order]);</span><br><span class="line">		page = get_page_from_free_area(area, migratetype);</span><br><span class="line">		<span class="keyword">if</span> (!page)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		del_page_from_free_list(page, zone, current_order);</span><br><span class="line">		expand(zone, page, order, current_order, migratetype);</span><br><span class="line">		set_pcppage_migratetype(page, migratetype);</span><br><span class="line">		trace_mm_page_alloc_zone_locked(page, order, migratetype,</span><br><span class="line">				pcp_allowed_order(order) &amp;&amp;</span><br><span class="line">				migratetype &lt; MIGRATE_PCPTYPES);</span><br><span class="line">		<span class="keyword">return</span> page;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¸Œæœ›å„ä½è¿˜è®°å¾—åœ¨å‰æ–‡<code>struct zone</code>æ®µçš„å†…å®¹ï¼Œè¿™é‡Œç”¨æ–‡å­—ç»™å¤§å®¶ç®€è¦çš„å›å¿†ä¸€ä¸‹ï¼Œå¦‚æœè®°ä¸èµ·æ¥æœ€å¥½å¯ä»¥ç‚¹æ—è¾¹çš„å¤§çº²çœ‹çœ‹å›¾ç‰‡ã€‚åœ¨zoneä¸­å­˜åœ¨<code>free_area</code>å­—æ®µç”¨ä»¥å­˜å‚¨<code>buddy system</code>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢ï¼Œä¸ºä¸€ä¸ª <code>free_area</code> ç»“æ„ä½“æ•°ç»„ï¼Œè€Œå…¶ç´¢å¼•å°±æ˜¯é¡µæ‰€å¯¹åº”çš„<code>order</code>ã€‚å¹¶ä¸”<code>free_area</code>æœ¬èº«å°±æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå†…éƒ¨å­˜åœ¨ä¸€ä¸ª<code>free_list</code>æˆå‘˜å…¶ç´¢å¼•å¯¹åº”çš„æ˜¯ä¸åŒçš„è¿ç§»ç±»å‹ã€‚</p>
<p>åœ¨ç»è¿‡ç®€å•çš„å›å¿†ä¹‹åæˆ‘ä»¬ç»§ç»­çœ‹<code>__rmqueue_smallest</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šä»ä¼ å…¥çš„<code>order</code>å¼€å§‹è¿›è¡Œå¾ªç¯ï¼Œå¹¶ä¸”é€šè¿‡<code>order</code>åœ¨zoneä¸­æ‰¾åˆ°å¯¹åº”çš„<code>free_area</code>ï¼Œéšåé€šè¿‡è¿ç§»ç±»å‹è·å–åˆ°å¯¹åº”çš„é¡µã€‚åœ¨è·å–åˆ°å¯¹åº”çš„é¡µä¹‹åå°±ä¼šè¿›è¡Œæ–­é“¾æ“ä½œï¼Œè¿™é‡Œé‡ç‚¹çœ‹ä¸€ä¸‹<code>expand</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">expand</span><span class="params">(struct zone *zone, struct page *page,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">int</span> low, <span class="keyword">int</span> high, <span class="keyword">int</span> migratetype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> size = <span class="number">1</span> &lt;&lt; high;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (high &gt; low) &#123;</span><br><span class="line">		high--;</span><br><span class="line">		size &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">		VM_BUG_ON_PAGE(bad_range(zone, &amp;page[size]), &amp;page[size]);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Mark as guard pages (or page), that will allow to</span></span><br><span class="line"><span class="comment">		 * merge back to allocator when buddy will be freed.</span></span><br><span class="line"><span class="comment">		 * Corresponding page table entries will not be touched,</span></span><br><span class="line"><span class="comment">		 * pages will stay not present in virtual address space</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (set_page_guard(zone, &amp;page[size], high, migratetype))</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		add_to_free_list(&amp;page[size], zone, high, migratetype);</span><br><span class="line">		set_buddy_order(&amp;page[size], high);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å‘ç°<code>current_order</code>å¤§äºä¼ å…¥çš„<code>order</code>æ—¶ä¼šè¿›å…¥å¾ªç¯ï¼Œå¯¹å¤§çš„order-1éšåå°†sizeå‡åŠï¼Œéšåå°†ååŠæ®µå­˜å…¥åˆ°é“¾è¡¨ä¸­å¹¶è®¾ç½®æ–°çš„orderå³è¿™é‡Œçš„highï¼Œå‰åŠæ®µçš„pageç»§ç»­é‡å¤ä»¥ä¸Šæ“ä½œç›´åˆ°high &#x3D;&#x3D; lowã€‚</p>
<h3 id="alloc-pages-slowpathå‡½æ•°"><a href="#alloc-pages-slowpathå‡½æ•°" class="headerlink" title="__alloc_pages_slowpathå‡½æ•°"></a>__alloc_pages_slowpathå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_slowpath</span>(<span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class">						<span class="keyword">struct</span> <span class="title">alloc_context</span> *<span class="title">ac</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">bool</span> can_direct_reclaim = gfp_mask &amp; __GFP_DIRECT_RECLAIM;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> costly_order = order &gt; PAGE_ALLOC_COSTLY_ORDER;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> did_some_progress;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">compact_priority</span> <span class="title">compact_priority</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">compact_result</span> <span class="title">compact_result</span>;</span></span><br><span class="line">	<span class="keyword">int</span> compaction_retries;</span><br><span class="line">	<span class="keyword">int</span> no_progress_loops;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpuset_mems_cookie;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> zonelist_iter_cookie;</span><br><span class="line">	<span class="keyword">int</span> reserve_flags;</span><br><span class="line"></span><br><span class="line">restart:</span><br><span class="line">	compaction_retries = <span class="number">0</span>;</span><br><span class="line">	no_progress_loops = <span class="number">0</span>;</span><br><span class="line">	compact_priority = DEF_COMPACT_PRIORITY;</span><br><span class="line">	cpuset_mems_cookie = read_mems_allowed_begin();</span><br><span class="line">	zonelist_iter_cookie = zonelist_iter_begin();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The fast path uses conservative alloc_flags to succeed only until</span></span><br><span class="line"><span class="comment">	 * kswapd needs to be woken up, and to avoid the cost of setting up</span></span><br><span class="line"><span class="comment">	 * alloc_flags precisely. So we do that now.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	alloc_flags = gfp_to_alloc_flags(gfp_mask, order);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We need to recalculate the starting point for the zonelist iterator</span></span><br><span class="line"><span class="comment">	 * because we might have used different nodemask in the fast path, or</span></span><br><span class="line"><span class="comment">	 * there was a cpuset modification and we are retrying - otherwise we</span></span><br><span class="line"><span class="comment">	 * could end up iterating over non-eligible zones endlessly.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">					ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line">	<span class="keyword">if</span> (!ac-&gt;preferred_zoneref-&gt;zone)</span><br><span class="line">		<span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Check for insane configurations where the cpuset doesn&#x27;t contain</span></span><br><span class="line"><span class="comment">	 * any suitable zone to satisfy the request - e.g. non-movable</span></span><br><span class="line"><span class="comment">	 * GFP_HIGHUSER allocations from MOVABLE nodes only.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (cpusets_insane_config() &amp;&amp; (gfp_mask &amp; __GFP_HARDWALL)) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">z</span> =</span> first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">					ac-&gt;highest_zoneidx,</span><br><span class="line">					&amp;cpuset_current_mems_allowed);</span><br><span class="line">		<span class="keyword">if</span> (!z-&gt;zone)</span><br><span class="line">			<span class="keyword">goto</span> nopage;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)</span><br><span class="line">		wake_all_kswapds(order, gfp_mask, ac);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The adjusted alloc_flags might result in immediate success, so try</span></span><br><span class="line"><span class="comment">	 * that first</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);</span><br><span class="line">	<span class="keyword">if</span> (page)</span><br><span class="line">		<span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For costly allocations, try direct compaction first, as it&#x27;s likely</span></span><br><span class="line"><span class="comment">	 * that we have enough base pages and don&#x27;t need to reclaim. For non-</span></span><br><span class="line"><span class="comment">	 * movable high-order allocations, do that as well, as compaction will</span></span><br><span class="line"><span class="comment">	 * try prevent permanent fragmentation by migrating from blocks of the</span></span><br><span class="line"><span class="comment">	 * same migratetype.</span></span><br><span class="line"><span class="comment">	 * Don&#x27;t try this for allocations that are allowed to ignore</span></span><br><span class="line"><span class="comment">	 * watermarks, as the ALLOC_NO_WATERMARKS attempt didn&#x27;t yet happen.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (can_direct_reclaim &amp;&amp;</span><br><span class="line">			(costly_order ||</span><br><span class="line">			   (order &gt; <span class="number">0</span> &amp;&amp; ac-&gt;migratetype != MIGRATE_MOVABLE))</span><br><span class="line">			&amp;&amp; !gfp_pfmemalloc_allowed(gfp_mask)) &#123;</span><br><span class="line">		page = __alloc_pages_direct_compact(gfp_mask, order,</span><br><span class="line">						alloc_flags, ac,</span><br><span class="line">						INIT_COMPACT_PRIORITY,</span><br><span class="line">						&amp;compact_result);</span><br><span class="line">		<span class="keyword">if</span> (page)</span><br><span class="line">			<span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Checks for costly allocations with __GFP_NORETRY, which</span></span><br><span class="line"><span class="comment">		 * includes some THP page fault allocations</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (costly_order &amp;&amp; (gfp_mask &amp; __GFP_NORETRY)) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If allocating entire pageblock(s) and compaction</span></span><br><span class="line"><span class="comment">			 * failed because all zones are below low watermarks</span></span><br><span class="line"><span class="comment">			 * or is prohibited because it recently failed at this</span></span><br><span class="line"><span class="comment">			 * order, fail immediately unless the allocator has</span></span><br><span class="line"><span class="comment">			 * requested compaction and reclaim retry.</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * Reclaim is</span></span><br><span class="line"><span class="comment">			 *  - potentially very expensive because zones are far</span></span><br><span class="line"><span class="comment">			 *    below their low watermarks or this is part of very</span></span><br><span class="line"><span class="comment">			 *    bursty high order allocations,</span></span><br><span class="line"><span class="comment">			 *  - not guaranteed to help because isolate_freepages()</span></span><br><span class="line"><span class="comment">			 *    may not iterate over freed pages as part of its</span></span><br><span class="line"><span class="comment">			 *    linear scan, and</span></span><br><span class="line"><span class="comment">			 *  - unlikely to make entire pageblocks free on its</span></span><br><span class="line"><span class="comment">			 *    own.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (compact_result == COMPACT_SKIPPED ||</span><br><span class="line">			    compact_result == COMPACT_DEFERRED)</span><br><span class="line">				<span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Looks like reclaim/compaction is worth trying, but</span></span><br><span class="line"><span class="comment">			 * sync compaction could be very expensive, so keep</span></span><br><span class="line"><span class="comment">			 * using async compaction.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			compact_priority = INIT_COMPACT_PRIORITY;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line">	<span class="comment">/* Ensure kswapd doesn&#x27;t accidentally go to sleep as long as we loop */</span></span><br><span class="line">	<span class="keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)</span><br><span class="line">		wake_all_kswapds(order, gfp_mask, ac);</span><br><span class="line"></span><br><span class="line">	reserve_flags = __gfp_pfmemalloc_flags(gfp_mask);</span><br><span class="line">	<span class="keyword">if</span> (reserve_flags)</span><br><span class="line">		alloc_flags = gfp_to_alloc_flags_cma(gfp_mask, reserve_flags) |</span><br><span class="line">					  (alloc_flags &amp; ALLOC_KSWAPD);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reset the nodemask and zonelist iterators if memory policies can be</span></span><br><span class="line"><span class="comment">	 * ignored. These allocations are high priority and system rather than</span></span><br><span class="line"><span class="comment">	 * user oriented.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!(alloc_flags &amp; ALLOC_CPUSET) || reserve_flags) &#123;</span><br><span class="line">		ac-&gt;nodemask = <span class="literal">NULL</span>;</span><br><span class="line">		ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">					ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Attempt with potentially adjusted zonelist and alloc_flags */</span></span><br><span class="line">	page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);</span><br><span class="line">	<span class="keyword">if</span> (page)</span><br><span class="line">		<span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Caller is not willing to reclaim, we can&#x27;t balance anything */</span></span><br><span class="line">	<span class="keyword">if</span> (!can_direct_reclaim)</span><br><span class="line">		<span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Avoid recursion of direct reclaim */</span></span><br><span class="line">	<span class="keyword">if</span> (current-&gt;flags &amp; PF_MEMALLOC)</span><br><span class="line">		<span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Try direct reclaim and then allocating */</span></span><br><span class="line">	page = __alloc_pages_direct_reclaim(gfp_mask, order, alloc_flags, ac,</span><br><span class="line">							&amp;did_some_progress);</span><br><span class="line">	<span class="keyword">if</span> (page)</span><br><span class="line">		<span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Try direct compaction and then allocating */</span></span><br><span class="line">	page = __alloc_pages_direct_compact(gfp_mask, order, alloc_flags, ac,</span><br><span class="line">					compact_priority, &amp;compact_result);</span><br><span class="line">	<span class="keyword">if</span> (page)</span><br><span class="line">		<span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Do not loop if specifically requested */</span></span><br><span class="line">	<span class="keyword">if</span> (gfp_mask &amp; __GFP_NORETRY)</span><br><span class="line">		<span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Do not retry costly high order allocations unless they are</span></span><br><span class="line"><span class="comment">	 * __GFP_RETRY_MAYFAIL</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (costly_order &amp;&amp; !(gfp_mask &amp; __GFP_RETRY_MAYFAIL))</span><br><span class="line">		<span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (should_reclaim_retry(gfp_mask, order, ac, alloc_flags,</span><br><span class="line">				 did_some_progress &gt; <span class="number">0</span>, &amp;no_progress_loops))</span><br><span class="line">		<span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * It doesn&#x27;t make any sense to retry for the compaction if the order-0</span></span><br><span class="line"><span class="comment">	 * reclaim is not able to make any progress because the current</span></span><br><span class="line"><span class="comment">	 * implementation of the compaction depends on the sufficient amount</span></span><br><span class="line"><span class="comment">	 * of free memory (see __compaction_suitable)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (did_some_progress &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">			should_compact_retry(ac, order, alloc_flags,</span><br><span class="line">				compact_result, &amp;compact_priority,</span><br><span class="line">				&amp;compaction_retries))</span><br><span class="line">		<span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Deal with possible cpuset update races or zonelist updates to avoid</span></span><br><span class="line"><span class="comment">	 * a unnecessary OOM kill.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac) ||</span><br><span class="line">	    check_retry_zonelist(zonelist_iter_cookie))</span><br><span class="line">		<span class="keyword">goto</span> restart;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Reclaim has failed us, start killing things */</span></span><br><span class="line">	page = __alloc_pages_may_oom(gfp_mask, order, ac, &amp;did_some_progress);</span><br><span class="line">	<span class="keyword">if</span> (page)</span><br><span class="line">		<span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Avoid allocations with no watermarks from looping endlessly */</span></span><br><span class="line">	<span class="keyword">if</span> (tsk_is_oom_victim(current) &amp;&amp;</span><br><span class="line">	    (alloc_flags &amp; ALLOC_OOM ||</span><br><span class="line">	     (gfp_mask &amp; __GFP_NOMEMALLOC)))</span><br><span class="line">		<span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Retry as long as the OOM killer is making progress */</span></span><br><span class="line">	<span class="keyword">if</span> (did_some_progress) &#123;</span><br><span class="line">		no_progress_loops = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">goto</span> retry;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">nopage:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Deal with possible cpuset update races or zonelist updates to avoid</span></span><br><span class="line"><span class="comment">	 * a unnecessary OOM kill.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac) ||</span><br><span class="line">	    check_retry_zonelist(zonelist_iter_cookie))</span><br><span class="line">		<span class="keyword">goto</span> restart;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Make sure that __GFP_NOFAIL request doesn&#x27;t leak out and make sure</span></span><br><span class="line"><span class="comment">	 * we always retry</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (gfp_mask &amp; __GFP_NOFAIL) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * All existing users of the __GFP_NOFAIL are blockable, so warn</span></span><br><span class="line"><span class="comment">		 * of any new users that actually require GFP_NOWAIT</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (WARN_ON_ONCE_GFP(!can_direct_reclaim, gfp_mask))</span><br><span class="line">			<span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * PF_MEMALLOC request from this context is rather bizarre</span></span><br><span class="line"><span class="comment">		 * because we cannot reclaim anything and only can loop waiting</span></span><br><span class="line"><span class="comment">		 * for somebody to do a work for us</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		WARN_ON_ONCE_GFP(current-&gt;flags &amp; PF_MEMALLOC, gfp_mask);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * non failing costly orders are a hard requirement which we</span></span><br><span class="line"><span class="comment">		 * are not prepared for much so let&#x27;s warn about these users</span></span><br><span class="line"><span class="comment">		 * so that we can identify them and convert them to something</span></span><br><span class="line"><span class="comment">		 * else.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		WARN_ON_ONCE_GFP(costly_order, gfp_mask);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Help non-failing allocations by giving some access to memory</span></span><br><span class="line"><span class="comment">		 * reserves normally used for high priority non-blocking</span></span><br><span class="line"><span class="comment">		 * allocations but do not use ALLOC_NO_WATERMARKS because this</span></span><br><span class="line"><span class="comment">		 * could deplete whole memory reserves which would just make</span></span><br><span class="line"><span class="comment">		 * the situation worse.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		page = __alloc_pages_cpuset_fallback(gfp_mask, order, ALLOC_MIN_RESERVE, ac);</span><br><span class="line">		<span class="keyword">if</span> (page)</span><br><span class="line">			<span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">		cond_resched();</span><br><span class="line">		<span class="keyword">goto</span> retry;</span><br><span class="line">	&#125;</span><br><span class="line">fail:</span><br><span class="line">	warn_alloc(gfp_mask, ac-&gt;nodemask,</span><br><span class="line">			<span class="string">&quot;page allocation failure: order:%u&quot;</span>, order);</span><br><span class="line">got_pg:</span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›¸ä¿¡å„ä½éƒ½åœ¨æ“ä½œç³»ç»Ÿè¯¾ç¨‹ä¸Šå­¦ä¹ è¿‡é¡µè¿ç§»æœºåˆ¶ï¼Œåœ¨è¿™é‡Œä¹Ÿç®€å•è¯´ä¸€ä¸‹å†…æ ¸ä¸­çš„<code>Memory compaction</code>æœºåˆ¶ï¼Œå°±æ˜¯æ•´ç†å†…å­˜ç¢ç‰‡ï¼Œå¯¹é›¶æ•£çš„å†…å­˜é¡µè¿›è¡Œè¿ç§»ï¼Œä»è€Œå°†é›¶æ•£çš„ç©ºé—²å†…å­˜é¡µå˜æˆå¤§å—çš„ç©ºé—²å†…å­˜ï¼Œä¸è¿‡è¿™é‡Œåªæ•´ç†å¯ä»¥ç§»åŠ¨çš„ç¢ç‰‡ã€‚</p>
<p><img   src="/images/q7T6EjtIb9PVFY3.png" ></p>
<p>ç°åœ¨å¼€å§‹åˆ†æä¸€ä¸‹æ•´ä¸ªå‡½æ•°çš„æµç¨‹å§ï¼Œé¦–å…ˆä½¿ç”¨åŸæœ‰çš„ gfp_flag é‡æ–°è®¾ç½® alloc_flagï¼Œå¹¶é‡æ–°è®¡ç®—<code>preferred zone</code>ï¼Œè‹¥è®¾ç½®äº† <code>ALLOC_KSWAPD</code> åˆ™è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶ã€‚</p>
<p>éšåç›´æ¥é‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p>
<p>æ¥ä¸‹æ¥è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œcompactionï¼Œè¯¥å‡½æ•°å†…éƒ¨åœ¨æ•´ç†å®Œåä¼šé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p>
<p>éšåè¿›å…¥retryåˆ†æ”¯è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶ã€‚</p>
<p>è°ƒæ•´ zonelist ä¸<code>alloc_flag</code>ï¼Œä¹‹åå†æ¬¡å°è¯•å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p>
<p>è‹¥ gfp_flag ä¸­æ²¡æœ‰ <code>__GFP_DIRECT_RECLAIM</code> æˆ–æ˜¯è¿›ç¨‹ PCB çš„ flag ä¸­æœ‰ <code>PF_MEMALLOC</code>ï¼Œç›´æ¥è·³è½¬åˆ°nopageåˆ†æ”¯ã€‚</p>
<p>éšåè°ƒç”¨ <code>__alloc_pages_direct_reclaim()</code> è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆå†…éƒ¨è°ƒç”¨ <code>__perform_reclaim()</code>ï¼‰ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p>
<p>ç„¶åè°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compaction ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p>
<p>å¦‚æœè®¾ç½®äº† <code>__GFP_NORETRY</code> ï¼Œæˆ–æ˜¯è¯¥æ¬¡å†…å­˜åˆ†é…å¼€é”€è¾ƒé«˜ï¼ˆ<code>order &gt; PAGE_ALLOC_COSTLY_ORDER</code>ï¼‰ä¸”æœªè®¾ç½® <code>__GFP_RETRY_MAYFAIL</code>ï¼Œç›´æ¥è·³åˆ°nopageæ ‡ç­¾ã€‚</p>
<p>è°ƒç”¨ <code>should_reclaim_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°å›æ”¶ï¼Œè‹¥æ˜¯åˆ™è·³å›retryæ ‡ç­¾ã€‚</p>
<p>è°ƒç”¨ <code>should_compact_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è¿›è¡Œ compactionï¼Œè‹¥æ˜¯åˆ™è·³å›retryæ ‡ç­¾ã€‚</p>
<p>è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´å³restartæ ‡ç­¾ã€‚</p>
<p>åœ¨å‰é¢çš„æ£€æµ‹éƒ½æ²¡è·³è½¬åˆ™è°ƒç”¨ <code>__alloc_pages_may_oom()</code> å°è¯• kill ä¸€äº›è¿›ç¨‹æ¥é‡Šæ”¾å†…å­˜ï¼Œè¯¥å‡½æ•°å†…é¦–å…ˆè¿˜æ˜¯ä¼šå…ˆè¿›è¡Œä¸€æ¬¡å¿«é€Ÿåˆ†é…ï¼Œä¹‹åæ‰æ˜¯è°ƒç”¨ <code>out_of_memory()</code> æ¥æ€æ‰æœ€é€‚åˆçš„è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œæœ€åè‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_cpuset_fallback</span>(<span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class">			      <span class="title">unsigned</span> <span class="title">int</span> <span class="title">alloc_flags</span>,</span></span><br><span class="line"><span class="class">			      <span class="title">const</span> <span class="keyword">struct</span> <span class="title">alloc_context</span> *<span class="title">ac</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	page = get_page_from_freelist(gfp_mask, order,</span><br><span class="line">			alloc_flags|ALLOC_CPUSET, ac);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * fallback to ignore cpuset restriction if our nodes</span></span><br><span class="line"><span class="comment">	 * are depleted</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!page)</span><br><span class="line">		page = get_page_from_freelist(gfp_mask, order,</span><br><span class="line">				alloc_flags, ac);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ä¸­ä¼šä¸¤æ¬¡èµ°å¿«é€Ÿè·¯å¾„è¿›è¡Œåˆ†é…ï¼Œåœ¨ç¬¬ä¸€æ¬¡ä¼šé¢å¤–é™„åŠ ä¸Š <code>ALLOC_CPUSET</code> çš„ flagã€‚</p>
<p>ç»§ç»­çœ‹<code>__alloc_pages_slowpath</code>å‡½æ•°æµç¨‹ï¼Œå¦‚æœæŠŠå½“å‰è¿›ç¨‹æ€æ‰äº†ï¼Œè·³åˆ°nopageæ ‡ç­¾ï¼Œå¦‚æœæ€è¿›ç¨‹å–å¾—äº†æˆæ•ˆï¼Œè·³å›retryæ ‡ç­¾ã€‚</p>
<p>æœ€åè¿›å…¥nopageæ ‡ç­¾è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´å³restartæ ‡ç­¾ã€‚</p>
<p>è‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è¿›è¡Œä¸€ç³»åˆ—çš„è­¦å‘Šï¼Œå¹¶è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œè‹¥æœªæˆåŠŸåˆ™è·³å›retryæ ‡ç­¾ã€‚æœ€åå°±æ˜¯è¿”å›ç»“æœäº†ã€‚</p>
<p><img   src="/images/eCg12KJIZuw9aon.png" ></p>
<p>ä¸Šé¢æ˜¯å·çš„å›¾ï¼Œå…¶å®é€šè¿‡å›¾èƒ½å¤Ÿæ›´æ¸…æ™°çš„ç†æ¸…æ¥šslow pathçš„é€»è¾‘ã€‚</p>
<h2 id="ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°"><a href="#ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°" class="headerlink" title="ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°"></a>ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_node</span>(<span class="title">int</span> <span class="title">nid</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	VM_BUG_ON(nid &lt; <span class="number">0</span> || nid &gt;= MAX_NUMNODES);</span><br><span class="line">	warn_if_node_offline(nid, gfp_mask);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> __alloc_pages(gfp_mask, order, nid, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct page *<span class="title">alloc_pages_node</span><span class="params">(<span class="keyword">int</span> nid, <span class="keyword">gfp_t</span> gfp_mask,</span></span></span><br><span class="line"><span class="params"><span class="function">						<span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (nid == NUMA_NO_NODE)</span><br><span class="line">		nid = numa_mem_id();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> __alloc_pages_node(nid, gfp_mask, order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct page *<span class="title">alloc_pages</span><span class="params">(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> alloc_pages_node(numa_node_id(), gfp_mask, order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> __get_free_pages(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">	page = alloc_pages(gfp_mask &amp; ~__GFP_HIGHMEM, order);</span><br><span class="line">	<span class="keyword">if</span> (!page)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page_address(page);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__get_free_pages);</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>__alloc_pages</code>ä¸Šå±‚æœ‰è¿™æ ·ä¸€äº›åˆ†é…å‡½æ•°ï¼Œåªä¸è¿‡è¿”å›çš„å†…å®¹ä¸ä¸€æ ·ï¼Œåœ¨<code>__get_free_pages</code>å‡½æ•°è¿”å›çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œ<code>alloc_pages</code>å‡½æ•°è¿”å›çš„æ˜¯<code>page</code>ç»“æ„ä½“æŒ‡é’ˆã€‚</p>
<h2 id="free-one-pageå‡½æ•°"><a href="#free-one-pageå‡½æ•°" class="headerlink" title="__free_one_pageå‡½æ•°"></a>__free_one_pageå‡½æ•°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Freeing function for a buddy system allocator.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The concept of a buddy system is to maintain direct-mapped table</span></span><br><span class="line"><span class="comment"> * (containing bit values) for memory blocks of various &quot;orders&quot;.</span></span><br><span class="line"><span class="comment"> * The bottom level table contains the map for the smallest allocatable</span></span><br><span class="line"><span class="comment"> * units of memory (here, pages), and each level above it describes</span></span><br><span class="line"><span class="comment"> * pairs of units from the levels below, hence, &quot;buddies&quot;.</span></span><br><span class="line"><span class="comment"> * At a high level, all that happens here is marking the table entry</span></span><br><span class="line"><span class="comment"> * at the bottom level available, and propagating the changes upward</span></span><br><span class="line"><span class="comment"> * as necessary, plus some accounting needed to play nicely with other</span></span><br><span class="line"><span class="comment"> * parts of the VM system.</span></span><br><span class="line"><span class="comment"> * At each level, we keep a list of pages, which are heads of continuous</span></span><br><span class="line"><span class="comment"> * free pages of length of (1 &lt;&lt; order) and marked with PageBuddy.</span></span><br><span class="line"><span class="comment"> * Page&#x27;s order is recorded in page_private(page) field.</span></span><br><span class="line"><span class="comment"> * So when we are allocating or freeing one, we can derive the state of the</span></span><br><span class="line"><span class="comment"> * other.  That is, if we allocate a small block, and both were</span></span><br><span class="line"><span class="comment"> * free, the remainder of the region must be split into blocks.</span></span><br><span class="line"><span class="comment"> * If a block is freed, and its buddy is also free, then this</span></span><br><span class="line"><span class="comment"> * triggers coalescing into a block of larger size.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * -- nyc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __free_one_page(struct page *page,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> pfn,</span><br><span class="line">		struct zone *zone, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span><br><span class="line">		<span class="keyword">int</span> migratetype, <span class="keyword">fpi_t</span> fpi_flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">capture_control</span> *<span class="title">capc</span> =</span> task_capc(zone);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> buddy_pfn = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> combined_pfn;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">buddy</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> to_tail;</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON(!zone_is_initialized(zone));</span><br><span class="line">	VM_BUG_ON_PAGE(page-&gt;flags &amp; PAGE_FLAGS_CHECK_AT_PREP, page);</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON(migratetype == <span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">if</span> (likely(!is_migrate_isolate(migratetype)))</span><br><span class="line">		__mod_zone_freepage_state(zone, <span class="number">1</span> &lt;&lt; order, migratetype);</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON_PAGE(pfn &amp; ((<span class="number">1</span> &lt;&lt; order) - <span class="number">1</span>), page);</span><br><span class="line">	VM_BUG_ON_PAGE(bad_range(zone, page), page);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (order &lt; MAX_ORDER) &#123;</span><br><span class="line">		<span class="keyword">if</span> (compaction_capture(capc, page, order, migratetype)) &#123;</span><br><span class="line">			__mod_zone_freepage_state(zone, -(<span class="number">1</span> &lt;&lt; order),</span><br><span class="line">								migratetype);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		buddy = find_buddy_page_pfn(page, pfn, order, &amp;buddy_pfn);</span><br><span class="line">		<span class="keyword">if</span> (!buddy)</span><br><span class="line">			<span class="keyword">goto</span> done_merging;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (unlikely(order &gt;= pageblock_order)) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * We want to prevent merge between freepages on pageblock</span></span><br><span class="line"><span class="comment">			 * without fallbacks and normal pageblock. Without this,</span></span><br><span class="line"><span class="comment">			 * pageblock isolation could cause incorrect freepage or CMA</span></span><br><span class="line"><span class="comment">			 * accounting or HIGHATOMIC accounting.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">int</span> buddy_mt = get_pfnblock_migratetype(buddy, buddy_pfn);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (migratetype != buddy_mt</span><br><span class="line">					&amp;&amp; (!migratetype_is_mergeable(migratetype) ||</span><br><span class="line">						!migratetype_is_mergeable(buddy_mt)))</span><br><span class="line">				<span class="keyword">goto</span> done_merging;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Our buddy is free or it is CONFIG_DEBUG_PAGEALLOC guard page,</span></span><br><span class="line"><span class="comment">		 * merge with it and move up one order.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (page_is_guard(buddy))</span><br><span class="line">			clear_page_guard(zone, buddy, order, migratetype);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			del_page_from_free_list(buddy, zone, order);</span><br><span class="line">		combined_pfn = buddy_pfn &amp; pfn;</span><br><span class="line">		page = page + (combined_pfn - pfn);</span><br><span class="line">		pfn = combined_pfn;</span><br><span class="line">		order++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">done_merging:</span><br><span class="line">	set_buddy_order(page, order);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fpi_flags &amp; FPI_TO_TAIL)</span><br><span class="line">		to_tail = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (is_shuffle_order(order))</span><br><span class="line">		to_tail = shuffle_pick_tail();</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		to_tail = buddy_merge_likely(pfn, buddy_pfn, page, order);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (to_tail)</span><br><span class="line">		add_to_free_list_tail(page, zone, order, migratetype);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		add_to_free_list(page, zone, order, migratetype);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Notify page reporting subsystem of freed page */</span></span><br><span class="line">	<span class="keyword">if</span> (!(fpi_flags &amp; FPI_SKIP_REPORT_NOTIFY))</span><br><span class="line">		page_reporting_notify_free(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ï¼Œä¸»è¦ä½œç”¨æ˜¯å°†ç‰¹å®šé¡µé¢é‡Šæ”¾åˆ°ç‰¹å®š zone ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ <code>one page</code> ä¸æ˜¯ä¸€å¼ é¡µæ¡†è€Œæ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼ˆå¯èƒ½æœ‰å¤šå¼ é¡µï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾é¡µé¢çš„åŸºæœ¬å‡½æ•°ï¼Œæ•…æˆ‘ä»¬éœ€è¦æä¾›å¾…é‡Šæ”¾é¡µé¢çš„é¡µç»“æ„ä½“ï¼ˆstruct pageï¼‰ã€é¡µæ¡†å·ã€é¡µé¢å—çš„é˜¶ï¼ˆorderï¼‰ã€ç›®æ ‡ zoneã€è¿ç§»ç±»å‹ç­‰ä¿¡æ¯â€”â€”è¿™äº›ä¿¡æ¯é€šå¸¸ç”±ä¸Šå±‚å°è£…å‡½æ•°æä¾›ï¼Œè¿™ä¸ªå‡½æ•°æ‰€åšçš„åªæ˜¯ç®€å•åœ°å°†é¡µæŒ‚å›å¯¹åº”é“¾è¡¨å¹¶æ£€æŸ¥åˆå¹¶çš„æ“ä½œã€‚è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢é‡Šæ”¾çš„æ ¸å¿ƒå‡½æ•°ï¼Œæ‰€æœ‰çš„é¡µé¢é‡Šæ”¾ API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…ã€‚</p>
<p>æˆ‘ä»¬å°†ä¸å¾…é‡Šæ”¾é¡µé¢å‡‘æˆä¸€å¯¹çš„å†…å­˜å—ç§°ä¸º buddyï¼Œæ‰€è°“å‡‘æˆä¸€å¯¹ä¾¿æ˜¯è¿™ä¸¤ä¸ªå†…å­˜å—åœ¨ç‰©ç†ä¸Šè¿ç»­ï¼Œä¸”èƒ½å‡‘æˆä¸€ä¸ªæ›´é«˜ä¸€é˜¶çš„å¤§å†…å­˜å—ï¼Œç”±æ­¤ç§°ä¹‹ä¸ºä¸€å¯¹ buddiesã€‚</p>
<p>æ¥ä¸‹æ¥å¼€å§‹åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„åŸºæœ¬æµç¨‹ï¼š</p>
<p>é¦–å…ˆè¿™é‡Œé€šè¿‡<code>find_buddy_page_pfn</code>å‡½æ•°å¯»æ‰¾å¹¶æ£€æŸ¥buddyã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct page *<span class="title">find_buddy_page_pfn</span><span class="params">(struct page *page,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">long</span> pfn, <span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">long</span> *buddy_pfn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> __buddy_pfn = __find_buddy_pfn(pfn, order);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">buddy</span>;</span></span><br><span class="line"></span><br><span class="line">	buddy = page + (__buddy_pfn - pfn);</span><br><span class="line">	<span class="keyword">if</span> (buddy_pfn)</span><br><span class="line">		*buddy_pfn = __buddy_pfn;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (page_is_buddy(page, buddy, order))</span><br><span class="line">		<span class="keyword">return</span> buddy;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šæ ¹æ®å¾…é‡Šæ”¾å †å—çš„pfnå’Œorderå¯»æ‰¾åˆ°buddyçš„pfnï¼Œéšåé€šè¿‡è®¡ç®—æˆ–å¾—åˆ°buddyçš„pageæŒ‡é’ˆï¼Œéšåè°ƒç”¨<code>page_is_buddy</code>æ¥åˆ¤æ–­æ˜¯å¦æ»¡è¶³buddyæ¡ä»¶ã€‚ä¸»è¦æ˜¯ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>buddy ä¸åœ¨ç©ºæ´ä¸­</li>
<li>buddy åœ¨ buddy system ä¸­ï¼ˆå³ buddy ä¹Ÿæ˜¯ç©ºé—²å†…å­˜å—ï¼‰</li>
<li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy åœ¨åŒä¸€ä¸ª zone ä¸­</li>
<li>å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy æœ‰ç€åŒæ ·çš„é˜¶ï¼ˆorderï¼‰</li>
</ul>
<p>éšåè¿›è¡Œåˆ¤æ–­å¦‚æœorderè¾¾åˆ°äº†<code>pageblock_order</code>é‚£ä¹ˆå°±æ„å‘³ç€å¸¸è§„çš„<code>pageblock</code>å¯èƒ½ä¼šä¸ç‹¬ç«‹çš„<code>pageblock</code>è¿›è¡Œåˆå¹¶ï¼Œä¸ºäº†é¢„é˜²è¿™ä¸€ç°è±¡ï¼Œå†…æ ¸åœ¨è¿™é‡Œå­˜åœ¨ä¸€å¤„åˆ¤æ–­ï¼Œå³<code>if (unlikely(order &gt;= pageblock_order)) &#123;</code>è¿™é‡Œä¼šåˆ¤æ–­æ‰€é€‰æ‹©çš„buddyæ˜¯å¦ä¸ºmergeableï¼Œå¦‚æœæ˜¯å¯ä»¥ç»§ç»­å¢åŠ orderï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥è¿›å…¥åˆ°<code>done_merging</code>æ ‡ç­¾ã€‚</p>
<p>å¾ªç¯æœ€åéªŒè¯æ­¤buddy æ˜¯å¦ä¸º guard pageï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ <code>clear_page_guard()</code> æ¸…é™¤è¿™ä¸ªå±æ€§è®©å…¶å˜æˆç©ºé—²é¡µé¢ï¼Œè¿™é‡Œæ¸…é™¤çš„æ“ä½œæ˜¯é€šè¿‡å°† page ç»“æ„ä½“çš„ private å­—æ®µç½® 0 å®ç°çš„ï¼›è‹¥å¦ï¼Œåˆ™è¯´æ˜æ˜¯å¸¸è§„çš„ç©ºé—²é¡µé¢ï¼Œè°ƒç”¨ <code>del_page_from_free_list()</code> å°†å…¶è„±é“¾ã€‚</p>
<p>ç»è¿‡å‰é¢çš„æ“ä½œåæˆ‘ä»¬çš„æ–°çš„é«˜é˜¶å†…å­˜å—å°±å®Œæˆåˆæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ°å¾ªç¯å¼€å¤´é‡æ–°å¯»æ‰¾è¿™ä¸ªåˆæˆçš„æ–°å†…å­˜å—çš„ buddyï¼Œè¿™ä¸ªå¾ªç¯ä¸€ç›´æŒç»­åˆ° <code>max_order</code> ï¼ˆä¸€èˆ¬æ˜¯10ï¼‰ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯çš„é¡µæ¡†å·çš„è®¡ç®—æ–¹å¼æ˜¯ <code>buddy_pfn &amp; pfn</code>ï¼Œä¹‹ååšæŒ‡é’ˆè¿ç®— <code>page + (combined_pfn - pfn)</code> æ‰¾åˆ°å¯¹åº”çš„ page ç»“æ„ä½“ã€‚</p>
<p>æœ€åè¿›å…¥åˆ°<code>done_merging</code>æ ‡ç­¾ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯è°ƒç”¨ <code>set_buddy_order()</code> åœ¨ page ç»“æ„ä½“çš„ private å­—æ®µå­˜æ”¾è¯¥å†…å­˜å—çš„ orderï¼Œè‹¥æ˜¯è®¾ç½®äº† <code>FPI_TO_TAIL</code> flagï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸º trueï¼›å¦åˆ™ï¼Œè‹¥å†…å­˜å—çš„ <code>order &gt;= SHUFFLE_ORDER</code>ï¼ˆ<code>MAX_ORDER - 1</code>ï¼‰ï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸ºéšæœºç»“æœï¼ˆ<code>shuffle_pick_tail()</code>ï¼‰ï¼›å¦åˆ™ç½®ä¸ºè°ƒç”¨ <code>buddy_merge_likely()</code> çš„ç»“æœï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²ï¼Œè‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢ã€‚è‹¥ <code>to_tail</code> ä¸ºçœŸï¼Œåˆ™è°ƒç”¨ <code>add_to_free_list_tail()</code> å°†è¯¥ç©ºé—²é¡µæ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ï¼Œå¦åˆ™è°ƒç”¨ <code>add_to_free_list()</code> æ·»åŠ åˆ°é“¾è¡¨å¼€å¤´ã€‚</p>
<h2 id="ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°"><a href="#ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°" class="headerlink" title="ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°"></a>ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __free_pages_ok(struct page *page, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span><br><span class="line">			    <span class="keyword">fpi_t</span> fpi_flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">	<span class="keyword">int</span> migratetype;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pfn = page_to_pfn(page);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span> =</span> page_zone(page);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!free_pages_prepare(page, order, fpi_flags))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Calling get_pfnblock_migratetype() without spin_lock_irqsave() here</span></span><br><span class="line"><span class="comment">	 * is used to avoid calling get_pfnblock_migratetype() under the lock.</span></span><br><span class="line"><span class="comment">	 * This will reduce the lock holding time.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	migratetype = get_pfnblock_migratetype(page, pfn);</span><br><span class="line"></span><br><span class="line">	spin_lock_irqsave(&amp;zone-&gt;lock, flags);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(has_isolate_pageblock(zone) ||</span><br><span class="line">		is_migrate_isolate(migratetype))) &#123;</span><br><span class="line">		migratetype = get_pfnblock_migratetype(page, pfn);</span><br><span class="line">	&#125;</span><br><span class="line">	__free_one_page(page, pfn, zone, order, migratetype, fpi_flags);</span><br><span class="line">	spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">	__count_vm_events(PGFREE, <span class="number">1</span> &lt;&lt; order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">free_the_page</span><span class="params">(struct page *page, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (pcp_allowed_order(order))		<span class="comment">/* Via pcp? */</span></span><br><span class="line">		free_unref_page(page, order);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		__free_pages_ok(page, order, FPI_NONE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __free_pages(struct page *page, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* get PageHead before we drop reference */</span></span><br><span class="line">	<span class="keyword">int</span> head = PageHead(page);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (put_page_testzero(page))</span><br><span class="line">		free_the_page(page, order);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (!head)</span><br><span class="line">		<span class="keyword">while</span> (order-- &gt; <span class="number">0</span>)</span><br><span class="line">			free_the_page(page + (<span class="number">1</span> &lt;&lt; order), order);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__free_pages);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (addr != <span class="number">0</span>) &#123;</span><br><span class="line">		VM_BUG_ON(!virt_addr_valid((<span class="keyword">void</span> *)addr));</span><br><span class="line">		__free_pages(virt_to_page((<span class="keyword">void</span> *)addr), order);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EXPORT_SYMBOL(free_pages);</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰é¡µé¢é‡Šæ”¾çš„å‡½æ•°å…¶å®éƒ½æ˜¯å¯¹ <code>__free_one_page()</code> çš„å°è£…ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼Œå‰é¢æ˜¯å…¶ä¸­ä¸€æ¡è·¯çš„è·¯å¾„ã€‚</p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ğŸ™ğŸ™ğŸ™ï¼Œè¿™æ®µæ—¶é—´å®åœ¨æ˜¯è¿‡äºæ‡’ç‹—äº†ï¼Œè¿™æ˜¯ä¸€ç¯‡2023å¹´11æœˆ29å·åˆ›å»ºçš„æ–‡ç« ï¼Œä¸€ç›´æ‹–åˆ°ä»Šå¤©æ‰å†™å®Œå¹¶å‘å‡ºæ¥ï¼Œè™½ç„¶è¿™æ®µæ—¶é—´ç¡®å®æ—¶ä¸æ—¶ä¼šæœ‰ä¸€äº›äº‹ä¸è¿‡ä¹Ÿä¸ä¼šè€½è¯¯å¤ªå¤šæ—¶é—´ï¼Œè¯´åˆ°åº•æ˜¯æˆ‘çŠ¯æ‡’æœ‰æ—¶é—´ä¸æƒ³å†™ï¼Œå…¶å®å°±ç®—æ™šä¸Šå»ç©æ¸¸æˆä¹Ÿæ˜¯èƒ½æ—©æ—©å†™å®Œäº†çš„ï¼Œä¸åšæ‡’ç‹—äº†ï¼</p>
<p>åç»­å…³äºsyzkallerçš„æ–‡ç« å¯èƒ½ä¼šç¼“ä¸€æ®µæ—¶é—´å†ç»§ç»­å†™äº†ï¼Œå› ä¸ºè‡ªå·±çš„fuzzåŸºç¡€å…¶å®ä¸æ˜¯å¾ˆæ‰å®ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—å…ˆå»å­¦å­¦æ€æ ·è‡ªå·±å»å®ç°ä¸€ä¸ªfuzzå†å»çœ‹ï¼Œå¦‚æœç›´æ¥çœ‹å°±ç®—æŠŠé€»è¾‘ç†æ¸…æ¥šäº†ä¹Ÿæ²¡æ³•è‡ªå·±åŠ¨æ‰‹æ”¹è¿›ä¹‹ç±»çš„ã€‚</p>
<p>æ‰€ä»¥åç»­çš„æ›´æ–°å¤§æ¦‚ç‡æ˜¯<code>Linux Rootkit</code>ï¼Œç”¨æˆ·æ€fuzzå®ç°ï¼Œä»0å¼€å§‹å†™æ“ä½œç³»ç»Ÿç­‰ã€‚</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/buddy-system/">buddy system</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">å†…å­˜ç®¡ç†</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                
                    

<div class="reward-author-container border-box flex-center">
    <div class="reward-btn border-box flex-center tooltip tooltip-img"
            data-tooltip-img-url="/images/reward.jpg"
            data-tooltip-img-trigger="click"
            data-tooltip-img-style="top: -6px;"
    >
        <i class="fa-solid fa-mug-hot"></i>&nbsp;æ¿€åŠ±ç‰›é©¬ï¼ŒåŠ é€Ÿåˆ›ä½œï¼
    </div>
</div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2024/02/16/Linux-Rootkit/"
                                   title="Linux Rootkitå…¥é—¨"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Linux Rootkitå…¥é—¨</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/11/23/Pspray-Timing-Side-Channel-based-Linux-Kernel-Heap-Exploitation-Technique/"
                                   title="Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®º',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-page"><span class="nav-text">struct page</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#flags%EF%BC%9A%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="nav-text">flagsï¼šæ ‡å¿—ä½</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lru%EF%BC%9A%E9%93%BE%E8%A1%A8%E8%8A%82%E7%82%B9"><span class="nav-text">lruï¼šé“¾è¡¨èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#slab%EF%BC%9A%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">slabï¼šç›¸å…³ç»“æ„ä½“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mapcount%EF%BC%9A%E6%98%A0%E5%B0%84%E8%AE%A1%E6%95%B0"><span class="nav-text">_mapcountï¼šæ˜ å°„è®¡æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#refcount%EF%BC%9A%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0"><span class="nav-text">_refcountï¼šå¼•ç”¨è®¡æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#virtual%EF%BC%9A%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80"><span class="nav-text">virtualï¼šè™šæ‹Ÿåœ°å€</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8B%E7%9A%84struct-page%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct pageå­˜å‚¨æ–¹å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Flat-Memory"><span class="nav-text">Flat Memory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Discontiguous-Memory"><span class="nav-text">Discontiguous Memory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sparse-Memory"><span class="nav-text">Sparse Memory</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-zone"><span class="nav-text">struct zone</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#watermark%EF%BC%9A%E6%B0%B4%E4%BD%8D%E7%BA%BF"><span class="nav-text">_watermarkï¼šæ°´ä½çº¿</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lowmem-reserve%EF%BC%9Azone%E8%87%AA%E8%BA%AB%E7%9A%84%E4%BF%9D%E7%95%99%E5%86%85%E5%AD%98"><span class="nav-text">lowmem_reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node%EF%BC%9ANUMA%E4%B8%AD%E6%A0%87%E8%AF%86%E6%89%80%E5%B1%9Enode"><span class="nav-text">nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zone-pgdat%EF%BC%9Azone-%E6%89%80%E5%B1%9E%E7%9A%84-pglist-data-%E8%8A%82%E7%82%B9"><span class="nav-text">zone_pgdatï¼šzone æ‰€å±çš„ pglist_data èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#per-cpu-pageset%EF%BC%9Azone-%E4%B8%BA%E6%AF%8F%E4%B8%AA-CPU-%E5%88%92%E5%88%86%E4%B8%80%E4%B8%AA%E7%8B%AC%E7%AB%8B%E7%9A%84%E2%80%9D%E9%A1%B5%E9%9D%A2%E4%BB%93%E5%BA%93%E2%80%9C"><span class="nav-text">per_cpu_pagesetï¼šzone ä¸ºæ¯ä¸ª CPU åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vm-stat%EF%BC%9A%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE"><span class="nav-text">vm_statï¼šç»Ÿè®¡æ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#free-area%EF%BC%9Abuddy-system-%E6%8C%89%E7%85%A7-order-%E7%AE%A1%E7%90%86%E7%9A%84%E9%A1%B5%E9%9D%A2"><span class="nav-text">free_areaï¼šbuddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%BB%AD%E6%88%90%E5%91%98"><span class="nav-text">åç»­æˆå‘˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E9%9D%A2%E8%BF%81%E7%A7%BB%E6%9C%BA%E5%88%B6"><span class="nav-text">é¡µé¢è¿ç§»æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zone%E5%88%86%E7%B1%BB"><span class="nav-text">zoneåˆ†ç±»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-pglist-data"><span class="nav-text">struct pglist_data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E5%91%98%E6%8F%8F%E8%BF%B0"><span class="nav-text">æˆå‘˜æè¿°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">nodeå­˜å‚¨æ–¹å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node%E7%8A%B6%E6%80%81"><span class="nav-text">nodeçŠ¶æ€</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#buddy-system%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%84%E7%BB%87%E5%BD%A2%E5%BC%8F"><span class="nav-text">buddy systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#buddy-system%E9%A1%B5%E5%88%86%E9%85%8D"><span class="nav-text">buddy systemé¡µåˆ†é…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GFP-get-free-page-%E6%A0%87%E8%AF%86%E4%BD%8D"><span class="nav-text">GFP (get free page) æ ‡è¯†ä½</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alloc-context%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">alloc_contextç»“æ„ä½“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alloc-pages%E5%87%BD%E6%95%B0"><span class="nav-text">__alloc_pageså‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#get-page-from-freelist%E5%87%BD%E6%95%B0"><span class="nav-text">get_page_from_freelistå‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#alloc-pages-slowpath%E5%87%BD%E6%95%B0"><span class="nav-text">__alloc_pages_slowpathå‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E5%B1%82%E5%B0%81%E8%A3%85%E7%9A%84%E5%88%86%E9%85%8D%E5%87%BD%E6%95%B0"><span class="nav-text">ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#free-one-page%E5%87%BD%E6%95%B0"><span class="nav-text">__free_one_pageå‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E5%B1%82%E5%B0%81%E8%A3%85%E7%9A%84%E9%87%8A%E6%94%BE%E5%87%BD%E6%95%B0"><span class="nav-text">ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-text">åè®°</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2024
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">335.6k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-page"><span class="nav-text">struct page</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#flags%EF%BC%9A%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="nav-text">flagsï¼šæ ‡å¿—ä½</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lru%EF%BC%9A%E9%93%BE%E8%A1%A8%E8%8A%82%E7%82%B9"><span class="nav-text">lruï¼šé“¾è¡¨èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#slab%EF%BC%9A%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">slabï¼šç›¸å…³ç»“æ„ä½“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mapcount%EF%BC%9A%E6%98%A0%E5%B0%84%E8%AE%A1%E6%95%B0"><span class="nav-text">_mapcountï¼šæ˜ å°„è®¡æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#refcount%EF%BC%9A%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0"><span class="nav-text">_refcountï¼šå¼•ç”¨è®¡æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#virtual%EF%BC%9A%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80"><span class="nav-text">virtualï¼šè™šæ‹Ÿåœ°å€</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E4%B8%8B%E7%9A%84struct-page%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct pageå­˜å‚¨æ–¹å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Flat-Memory"><span class="nav-text">Flat Memory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Discontiguous-Memory"><span class="nav-text">Discontiguous Memory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sparse-Memory"><span class="nav-text">Sparse Memory</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-zone"><span class="nav-text">struct zone</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#watermark%EF%BC%9A%E6%B0%B4%E4%BD%8D%E7%BA%BF"><span class="nav-text">_watermarkï¼šæ°´ä½çº¿</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lowmem-reserve%EF%BC%9Azone%E8%87%AA%E8%BA%AB%E7%9A%84%E4%BF%9D%E7%95%99%E5%86%85%E5%AD%98"><span class="nav-text">lowmem_reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node%EF%BC%9ANUMA%E4%B8%AD%E6%A0%87%E8%AF%86%E6%89%80%E5%B1%9Enode"><span class="nav-text">nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zone-pgdat%EF%BC%9Azone-%E6%89%80%E5%B1%9E%E7%9A%84-pglist-data-%E8%8A%82%E7%82%B9"><span class="nav-text">zone_pgdatï¼šzone æ‰€å±çš„ pglist_data èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#per-cpu-pageset%EF%BC%9Azone-%E4%B8%BA%E6%AF%8F%E4%B8%AA-CPU-%E5%88%92%E5%88%86%E4%B8%80%E4%B8%AA%E7%8B%AC%E7%AB%8B%E7%9A%84%E2%80%9D%E9%A1%B5%E9%9D%A2%E4%BB%93%E5%BA%93%E2%80%9C"><span class="nav-text">per_cpu_pagesetï¼šzone ä¸ºæ¯ä¸ª CPU åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vm-stat%EF%BC%9A%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE"><span class="nav-text">vm_statï¼šç»Ÿè®¡æ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#free-area%EF%BC%9Abuddy-system-%E6%8C%89%E7%85%A7-order-%E7%AE%A1%E7%90%86%E7%9A%84%E9%A1%B5%E9%9D%A2"><span class="nav-text">free_areaï¼šbuddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E7%BB%AD%E6%88%90%E5%91%98"><span class="nav-text">åç»­æˆå‘˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B5%E9%9D%A2%E8%BF%81%E7%A7%BB%E6%9C%BA%E5%88%B6"><span class="nav-text">é¡µé¢è¿ç§»æœºåˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zone%E5%88%86%E7%B1%BB"><span class="nav-text">zoneåˆ†ç±»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#struct-pglist-data"><span class="nav-text">struct pglist_data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E5%91%98%E6%8F%8F%E8%BF%B0"><span class="nav-text">æˆå‘˜æè¿°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">nodeå­˜å‚¨æ–¹å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node%E7%8A%B6%E6%80%81"><span class="nav-text">nodeçŠ¶æ€</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#buddy-system%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%84%E7%BB%87%E5%BD%A2%E5%BC%8F"><span class="nav-text">buddy systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#buddy-system%E9%A1%B5%E5%88%86%E9%85%8D"><span class="nav-text">buddy systemé¡µåˆ†é…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GFP-get-free-page-%E6%A0%87%E8%AF%86%E4%BD%8D"><span class="nav-text">GFP (get free page) æ ‡è¯†ä½</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alloc-context%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">alloc_contextç»“æ„ä½“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alloc-pages%E5%87%BD%E6%95%B0"><span class="nav-text">__alloc_pageså‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#get-page-from-freelist%E5%87%BD%E6%95%B0"><span class="nav-text">get_page_from_freelistå‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#alloc-pages-slowpath%E5%87%BD%E6%95%B0"><span class="nav-text">__alloc_pages_slowpathå‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E5%B1%82%E5%B0%81%E8%A3%85%E7%9A%84%E5%88%86%E9%85%8D%E5%87%BD%E6%95%B0"><span class="nav-text">ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#free-one-page%E5%87%BD%E6%95%B0"><span class="nav-text">__free_one_pageå‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E5%B1%82%E5%B0%81%E8%A3%85%E7%9A%84%E9%87%8A%E6%94%BE%E5%87%BD%E6%95%B0"><span class="nav-text">ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="nav-text">åè®°</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
