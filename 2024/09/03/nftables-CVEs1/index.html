<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            nftables CVEå¤ç°ç³»åˆ—ã€ä¸€ã€‘ |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/ufo.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.jpg","logo":"/images/ling.jpg","favicon":"/images/ufo.ico"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.jpg">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        nftables CVEå¤ç°ç³»åˆ—ã€ä¸€ã€‘
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.jpg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-09-03 15:24:32</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Tue Sep 03 2024 18:44:39 GMT+0800">2024-09-03 18:44:39</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                            <li class="category-item">&nbsp;<i class="icon fas fa-angle-right"></i>&nbsp;<a href="/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/">CVEå¤ç°</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/nft-set-pipapo-type/">nft_set_pipapo_type</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/nft-rule-expr-deactivate/">nft_rule_expr_deactivate</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>11.6k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>62 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CVEå¤ç°è¿˜æ˜¯è¦è¶çƒ­å¤ç°ï¼Œä¸è¦å› ä¸ºå…¶ä»–äº‹è€½è¯¯äº†TvTï¼Œæ¯•ç«ŸæŒ–æ´æ˜¯é‡ä¸­ä¹‹é‡ç‰¹åˆ«æ˜¯å¯¹ç°åœ¨çš„æˆ‘æ¥è¯´ï¼Œä¸€ä¸ªæ´éƒ½æ²¡æœ‰TvTã€‚</p>
<p>ä¸çŸ¥é“ç®—æ˜¯è¿æ°”å¥½è¿˜æ˜¯è¿æ°”ä¸å¥½ï¼Œåœ¨å¤ç°CVE-2023-4004çš„æ—¶å€™å‘ç°äº†å¦å¤–ä¸€ä¸ªæ¼æ´ï¼Œåœ¨ä¸€é€šåˆ†æä¹‹åæ¬£å–œè‹¥ç‹‚å‘ç°ç¡®å®å¯ä»¥ç”¨æ¥ææƒï¼Œä½†æ˜¯åœ¨æƒ³ææ˜ç™½è¿™ä¸€è¡Œä¸ºçš„æ—¶å€™æœç´¢å‘ç°å·²ç»æœ‰äº†CVEäº†ä¹Ÿå°±æ˜¯CVE-2024-1085ï¼Œé‚£è¿™ä¸ªCVEçš„å¤ç°å°±æ”¾åœ¨åé¢ä¸€ç¯‡æ–‡ç« å§ã€‚</p>
<p>åœ¨è¿™ä¸ªCVEå¤ç°ç³»åˆ—å°±ä¸ä¼šå†å†™expï¼Œå¦‚æœä¸æ˜¯ç‰¹åˆ«æ–°é¢–çš„åˆ©ç”¨æ–¹å¼ä¹Ÿä¸ä¼šè¿‡å¤šä»‹ç»äº†ï¼Œè¿™é‡Œä¸»è¦åˆ†ææ¼æ´æˆå› ä»¥åŠæ¢³ç†ç³»ç»Ÿé€»è¾‘ã€‚</p>
<p>æœ¬æ¥æ‰“ç®—å¤ç°ä¸‰ä¸ªCVEæ— å¥ˆç¯‡å¹…è¿‡é•¿ï¼Œæ¼æ´çš„ç»†èŠ‚æŒºå¤šçš„ï¼Œæ‰€ä»¥åªèƒ½å®¹çº³ä¸¤ç¯‡ã€‚</p>
<h2 id="CVE-2023-4004"><a href="#CVE-2023-4004" class="headerlink" title="CVE-2023-4004"></a>CVE-2023-4004</h2><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p>åœ¨æƒ³è¦å½»åº•ææ˜ç™½è¿™ä¸ªæ¼æ´ä¹‹å‰å¯èƒ½è¿˜éœ€è¦è¡¥é½ä¸€ç‚¹å‰ä¸¤ç¯‡æ–‡ç« ç¼ºå°‘çš„ä¸€äº›å‰ç½®çŸ¥è¯†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">bindings</span>;</span></span><br><span class="line">	<span class="keyword">refcount_t</span>			refs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span>		*<span class="title">table</span>;</span></span><br><span class="line">	<span class="keyword">possible_net_t</span>			net;</span><br><span class="line">	<span class="keyword">char</span>				*name;</span><br><span class="line">	u64				handle;</span><br><span class="line">	u32				ktype;</span><br><span class="line">	u32				dtype;</span><br><span class="line">	u32				objtype;</span><br><span class="line">	u32				size;</span><br><span class="line">	u8				field_len[NFT_REG32_COUNT];</span><br><span class="line">	u8				field_count;</span><br><span class="line">	u32				use;</span><br><span class="line">	<span class="keyword">atomic_t</span>			nelems;</span><br><span class="line">	u32				ndeact;</span><br><span class="line">	u64				timeout;</span><br><span class="line">	u32				gc_int;</span><br><span class="line">	u16				policy;</span><br><span class="line">	u16				udlen;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>			*udata;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">pending_update</span>;</span></span><br><span class="line">	<span class="comment">/* runtime data below here */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ops</span>	*<span class="title">ops</span> ____<span class="title">cacheline_aligned</span>;</span></span><br><span class="line">	u16				flags:<span class="number">13</span>,</span><br><span class="line">					dead:<span class="number">1</span>,</span><br><span class="line">					genmask:<span class="number">2</span>;</span><br><span class="line">	u8				klen;</span><br><span class="line">	u8				dlen;</span><br><span class="line">	u8				num_exprs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span>			*<span class="title">exprs</span>[<span class="title">NFT_SET_EXPR_MAX</span>];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">catchall_list</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>			data[]</span><br><span class="line">		__attribute__((aligned(__alignof__(u64))));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¸Šé¢æ˜¯seté›†åˆçš„ç»“æ„ä½“å®šä¹‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newset</span><span class="params">(struct net *net, struct sock *nlsk,</span></span></span><br><span class="line"><span class="params"><span class="function">			    struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">			    <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">			    struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="keyword">if</span> (nla[NFTA_SET_DESC] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		err = nf_tables_set_desc_parse(&amp;desc, nla[NFTA_SET_DESC]);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (desc.field_count &gt; <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!(flags &amp; NFT_SET_CONCAT))</span><br><span class="line">				<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; NFT_SET_CONCAT) &#123;</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; NFT_SET_CONCAT) &#123;</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">	<span class="built_in">set</span>-&gt;field_count = desc.field_count;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; desc.field_count; i++)</span><br><span class="line">		<span class="built_in">set</span>-&gt;field_len[i] = desc.field_len[i];</span><br><span class="line">    </span><br><span class="line">    err = ops-&gt;init(<span class="built_in">set</span>, &amp;desc, nla);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_set_init;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨åé¢å…³äºelementçš„inertæ—¶ä¼šé‡åˆ°setä¸­çš„æˆå‘˜<code>field_count</code>å’Œ<code>field_len</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_set_desc_parse</span><span class="params">(struct nft_set_desc *desc,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">const</span> struct nlattr *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">da</span>[<span class="title">NFTA_SET_DESC_MAX</span> + 1];</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(da, NFTA_SET_DESC_MAX, nla,</span><br><span class="line">					  nft_set_desc_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (da[NFTA_SET_DESC_SIZE] != <span class="literal">NULL</span>)</span><br><span class="line">		desc-&gt;size = ntohl(nla_get_be32(da[NFTA_SET_DESC_SIZE]));</span><br><span class="line">	<span class="keyword">if</span> (da[NFTA_SET_DESC_CONCAT])</span><br><span class="line">		err = nft_set_desc_concat(desc, da[NFTA_SET_DESC_CONCAT]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰é¢é€šè¿‡<code>nla_parse_nested_deprecated</code>å°†nlaè§£æåˆ°daä¸­ï¼Œå¹¶æ‰§è¡Œ<code>nft_set_desc_concat</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_set_desc_concat_parse</span><span class="params">(<span class="keyword">const</span> struct nlattr *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">				     struct nft_set_desc *desc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">NFTA_SET_FIELD_MAX</span> + 1];</span></span><br><span class="line">	u32 len;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (desc-&gt;field_count &gt;= ARRAY_SIZE(desc-&gt;field_len))</span><br><span class="line">		<span class="keyword">return</span> -E2BIG;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(tb, NFTA_SET_FIELD_MAX, attr,</span><br><span class="line">					  nft_concat_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!tb[NFTA_SET_FIELD_LEN])</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	len = ntohl(nla_get_be32(tb[NFTA_SET_FIELD_LEN]));</span><br><span class="line">	<span class="keyword">if</span> (!len || len &gt; U8_MAX)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	desc-&gt;field_len[desc-&gt;field_count++] = len;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_set_desc_concat</span><span class="params">(struct nft_set_desc *desc,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">const</span> struct nlattr *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">	u32 num_regs = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> rem, err, i;</span><br><span class="line"></span><br><span class="line">	nla_for_each_nested(attr, nla, rem) &#123;</span><br><span class="line">		<span class="keyword">if</span> (nla_type(attr) != NFTA_LIST_ELEM)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		err = nft_set_desc_concat_parse(attr, desc);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; desc-&gt;field_count; i++)</span><br><span class="line">		num_regs += DIV_ROUND_UP(desc-&gt;field_len[i], <span class="keyword">sizeof</span>(u32));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (num_regs &gt; NFT_REG32_COUNT)</span><br><span class="line">		<span class="keyword">return</span> -E2BIG;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯è¿™é‡Œçš„<code>desc-&gt;field_count</code>æ˜¯æ ¹æ®å¾ªç¯æ¬¡æ•°æ¥å†³å®šçš„ï¼Œé‚£ä¹ˆå…ˆåˆ†æä¸€ä¸‹èƒ½å¤Ÿå¾ªç¯å¤šå°‘æ¬¡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nla_data - head of payload</span></span><br><span class="line"><span class="comment"> * @nla: netlink attribute</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">nla_data</span><span class="params">(<span class="keyword">const</span> struct nlattr *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">char</span> *) nla + NLA_HDRLEN;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nla_len - length of payload</span></span><br><span class="line"><span class="comment"> * @nla: netlink attribute</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">nla_len</span><span class="params">(<span class="keyword">const</span> struct nlattr *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> nla-&gt;nla_len - NLA_HDRLEN;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nla_next - next netlink attribute in attribute stream</span></span><br><span class="line"><span class="comment"> * @nla: netlink attribute</span></span><br><span class="line"><span class="comment"> * @remaining: number of bytes remaining in attribute stream</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns the next netlink attribute in the attribute stream and</span></span><br><span class="line"><span class="comment"> * decrements remaining by the size of the current attribute.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct nlattr *<span class="title">nla_next</span><span class="params">(<span class="keyword">const</span> struct nlattr *nla, <span class="keyword">int</span> *remaining)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> totlen = NLA_ALIGN(nla-&gt;nla_len);</span><br><span class="line"></span><br><span class="line">	*remaining -= totlen;</span><br><span class="line">	<span class="keyword">return</span> (struct nlattr *) ((<span class="keyword">char</span> *) nla + totlen);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nla_ok - check if the netlink attribute fits into the remaining bytes</span></span><br><span class="line"><span class="comment"> * @nla: netlink attribute</span></span><br><span class="line"><span class="comment"> * @remaining: number of bytes remaining in attribute stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">nla_ok</span><span class="params">(<span class="keyword">const</span> struct nlattr *nla, <span class="keyword">int</span> remaining)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> remaining &gt;= (<span class="keyword">int</span>) <span class="keyword">sizeof</span>(*nla) &amp;&amp;</span><br><span class="line">	       nla-&gt;nla_len &gt;= <span class="keyword">sizeof</span>(*nla) &amp;&amp;</span><br><span class="line">	       nla-&gt;nla_len &lt;= remaining;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nla_for_each_attr - iterate over a stream of attributes</span></span><br><span class="line"><span class="comment"> * @pos: loop counter, set to current attribute</span></span><br><span class="line"><span class="comment"> * @head: head of attribute stream</span></span><br><span class="line"><span class="comment"> * @len: length of attribute stream</span></span><br><span class="line"><span class="comment"> * @rem: initialized to len, holds bytes currently remaining in stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nla_for_each_attr(pos, head, len, rem) \</span></span><br><span class="line"><span class="meta">	for (pos = head, rem = len; \</span></span><br><span class="line"><span class="meta">	     nla_ok(pos, rem); \</span></span><br><span class="line"><span class="meta">	     pos = nla_next(pos, &amp;(rem)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * nla_for_each_nested - iterate over nested attributes</span></span><br><span class="line"><span class="comment"> * @pos: loop counter, set to current attribute</span></span><br><span class="line"><span class="comment"> * @nla: attribute containing the nested attributes</span></span><br><span class="line"><span class="comment"> * @rem: initialized to len, holds bytes currently remaining in stream</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nla_for_each_nested(pos, nla, rem) \</span></span><br><span class="line"><span class="meta">	nla_for_each_attr(pos, nla_data(nla), nla_len(nla), rem)</span></span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¿™é‡Œæ ¹æ®è¿™é‡Œçš„å®å®šä¹‰å¯ä»¥çœ‹åˆ°æœ€ç»ˆforå¾ªç¯è¯­å¥æ˜¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(attr = (nla + NLA_HDRLEN), rem = (nla-&gt;nla_len - NLA_HDRLEN); (rem &gt;= <span class="number">4</span>) &amp;&amp; (attr-&gt;nla_len &gt;= <span class="number">4</span>) &amp;&amp; (attr-&gt;nla_len) &lt; rem); pos = nla_next(pos, &amp;(rem)))</span><br></pre></td></tr></table></figure>

<p>ç»“åˆä¸Šä¸‹æ–‡å¯ä»¥å¾—å‡ºè¿™é‡Œ<code>desc-&gt;field_count</code>æ˜¯ç”±<code>NFTA_LIST_ELEM</code>æ•°é‡æ‰€å†³å®šçš„ã€‚å¹¶ä¸”è¿™é‡Œçš„<code>field_len</code>ä¹Ÿæ˜¯æœ‰åšç›¸åº”é™åˆ¶çš„ã€‚</p>
<p>è¿™é‡Œå†ä¸€æ¬¡å›åˆ°ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°çš„<code>nft_add_set_elem</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_add_set_elem</span><span class="params">(struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			    <span class="keyword">const</span> struct nlattr *attr, u32 nlmsg_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr_array</span>[<span class="title">NFT_SET_EXPR_MAX</span>] =</span> &#123;&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nla</span>[<span class="title">NFTA_SET_ELEM_MAX</span> + 1];</span></span><br><span class="line">	u8 genmask = nft_genmask_next(ctx-&gt;net);</span><br><span class="line">	u32 flags = <span class="number">0</span>, size = <span class="number">0</span>, num_exprs = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext_tmpl</span> <span class="title">tmpl</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext</span> *<span class="title">ext</span>, *<span class="title">ext2</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_elem</span> <span class="title">elem</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_binding</span> *<span class="title">binding</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_object</span> *<span class="title">obj</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_userdata</span> *<span class="title">udata</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_data_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">nft_registers</span> <span class="title">dreg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	u64 timeout;</span><br><span class="line">	u64 expiration;</span><br><span class="line">	<span class="keyword">int</span> err, i;</span><br><span class="line">	u8 ulen;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    elem.priv = nft_set_elem_init(<span class="built_in">set</span>, &amp;tmpl, elem.key.val.data,</span><br><span class="line">				      elem.key_end.val.data, elem.data.val.data,</span><br><span class="line">				      timeout, expiration, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(elem.priv)) &#123;</span><br><span class="line">		err = PTR_ERR(elem.priv);</span><br><span class="line">		<span class="keyword">goto</span> err_parse_data;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    err = nft_setelem_insert(ctx-&gt;net, <span class="built_in">set</span>, &amp;elem, &amp;ext2, flags);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		<span class="keyword">if</span> (err == -EEXIST) &#123;</span><br><span class="line">			<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_DATA) ^</span><br><span class="line">			    nft_set_ext_exists(ext2, NFT_SET_EXT_DATA) ||</span><br><span class="line">			    nft_set_ext_exists(ext, NFT_SET_EXT_OBJREF) ^</span><br><span class="line">			    nft_set_ext_exists(ext2, NFT_SET_EXT_OBJREF))</span><br><span class="line">				<span class="keyword">goto</span> err_element_clash;</span><br><span class="line">			<span class="keyword">if</span> ((nft_set_ext_exists(ext, NFT_SET_EXT_DATA) &amp;&amp;</span><br><span class="line">			     nft_set_ext_exists(ext2, NFT_SET_EXT_DATA) &amp;&amp;</span><br><span class="line">			     <span class="built_in">memcmp</span>(nft_set_ext_data(ext),</span><br><span class="line">				    nft_set_ext_data(ext2), <span class="built_in">set</span>-&gt;dlen) != <span class="number">0</span>) ||</span><br><span class="line">			    (nft_set_ext_exists(ext, NFT_SET_EXT_OBJREF) &amp;&amp;</span><br><span class="line">			     nft_set_ext_exists(ext2, NFT_SET_EXT_OBJREF) &amp;&amp;</span><br><span class="line">			     *nft_set_ext_obj(ext) != *nft_set_ext_obj(ext2)))</span><br><span class="line">				<span class="keyword">goto</span> err_element_clash;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!(nlmsg_flags &amp; NLM_F_EXCL))</span><br><span class="line">				err = <span class="number">0</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == -ENOTEMPTY) &#123;</span><br><span class="line">			<span class="comment">/* ENOTEMPTY reports overlapping between this element</span></span><br><span class="line"><span class="comment">			 * and an existing one.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			err = -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">goto</span> err_element_clash;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°é€šè¿‡<code>nft_set_elem_init</code>å‡½æ•°ç”³è¯·çš„elementå…¶å®ç»™åˆ°çš„æ˜¯<code>elem.priv</code>ä¸­çš„ï¼Œæœ€åè°ƒç”¨<code>nft_setelem_insert</code>å°†å…¶æ’å…¥åˆ°setä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_setelem_insert</span><span class="params">(<span class="keyword">const</span> struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nft_set_elem *elem,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct nft_set_ext **ext, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; NFT_SET_ELEM_CATCHALL)</span><br><span class="line">		ret = nft_setelem_catchall_insert(net, <span class="built_in">set</span>, elem, ext);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ret = <span class="built_in">set</span>-&gt;ops-&gt;insert(net, <span class="built_in">set</span>, elem, ext);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…ˆåˆ¤æ–­æ˜¯å¦è®¾ç½®äº†<code>NFT_SET_ELEM_CATCHALL</code>æ ‡å¿—ä½ï¼Œè¿™ä¸ªä¼šåœ¨åé¢çš„CVEå¤ç°ä¸­è¯¦ç»†è§£é‡Šï¼Œè¿™é‡Œä¸ä¼šå‡ºç°è¿™ä¸€æ ‡å¿—ä½æ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨<code>set-&gt;ops-&gt;insert</code>å‡½æ•°ã€‚</p>
<h3 id="nft-pipapo-init"><a href="#nft-pipapo-init" class="headerlink" title="nft_pipapo_init"></a>nft_pipapo_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_type</span> <span class="title">nft_set_pipapo_type</span> =</span> &#123;</span><br><span class="line">	.features	= NFT_SET_INTERVAL | NFT_SET_MAP | NFT_SET_OBJECT |</span><br><span class="line">			  NFT_SET_TIMEOUT,</span><br><span class="line">	.ops		= &#123;</span><br><span class="line">		.lookup		= nft_pipapo_lookup,</span><br><span class="line">		.insert		= nft_pipapo_insert,</span><br><span class="line">		.activate	= nft_pipapo_activate,</span><br><span class="line">		.deactivate	= nft_pipapo_deactivate,</span><br><span class="line">		.flush		= nft_pipapo_flush,</span><br><span class="line">		.remove		= nft_pipapo_remove,</span><br><span class="line">		.walk		= nft_pipapo_walk,</span><br><span class="line">		.get		= nft_pipapo_get,</span><br><span class="line">		.privsize	= nft_pipapo_privsize,</span><br><span class="line">		.estimate	= nft_pipapo_estimate,</span><br><span class="line">		.init		= nft_pipapo_init,</span><br><span class="line">		.destroy	= nft_pipapo_destroy,</span><br><span class="line">		.gc_init	= nft_pipapo_gc_init,</span><br><span class="line">		.commit		= nft_pipapo_commit,</span><br><span class="line">		.<span class="built_in">abort</span>		= nft_pipapo_abort,</span><br><span class="line">		.elemsize	= offsetof(struct nft_pipapo_elem, ext),</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…·æœ‰æ¼æ´çš„setç±»å‹ä¸ºä¸Šè¿°ç±»å‹ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°çš„æ˜¯åœ¨<code>nf_tables_newset</code>å‡½æ•°åœ¨å®Œæˆå¯¹setæˆå‘˜çš„èµ‹å€¼æ“ä½œä¹‹åå°±ä¼šè°ƒç”¨<code>ops-&gt;init(set, &amp;desc, nla)</code>æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œå…³æ³¨ä»–çš„initå³<code>nft_pipapo_init</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_pipapo_init</span><span class="params">(<span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			   <span class="keyword">const</span> struct nft_set_desc *desc,</span></span></span><br><span class="line"><span class="params"><span class="function">			   <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo</span> *<span class="title">priv</span> =</span> nft_set_priv(<span class="built_in">set</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_match</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_field</span> *<span class="title">f</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err, i, field_count;</span><br><span class="line"></span><br><span class="line">	field_count = desc-&gt;field_count ? : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (field_count &gt; NFT_PIPAPO_MAX_FIELDS)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	m = kmalloc(<span class="keyword">sizeof</span>(*priv-&gt;match) + <span class="keyword">sizeof</span>(*f) * field_count,</span><br><span class="line">		    GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!m)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	m-&gt;field_count = field_count;</span><br><span class="line">	m-&gt;bsize_max = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	m-&gt;scratch = alloc_percpu(<span class="keyword">unsigned</span> <span class="keyword">long</span> *);</span><br><span class="line">	<span class="keyword">if</span> (!m-&gt;scratch) &#123;</span><br><span class="line">		err = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> out_scratch;</span><br><span class="line">	&#125;</span><br><span class="line">	for_each_possible_cpu(i)</span><br><span class="line">		*per_cpu_ptr(m-&gt;scratch, i) = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NFT_PIPAPO_ALIGN</span></span><br><span class="line">	m-&gt;scratch_aligned = alloc_percpu(<span class="keyword">unsigned</span> <span class="keyword">long</span> *);</span><br><span class="line">	<span class="keyword">if</span> (!m-&gt;scratch_aligned) &#123;</span><br><span class="line">		err = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> out_free;</span><br><span class="line">	&#125;</span><br><span class="line">	for_each_possible_cpu(i)</span><br><span class="line">		*per_cpu_ptr(m-&gt;scratch_aligned, i) = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	rcu_head_init(&amp;m-&gt;rcu);</span><br><span class="line"></span><br><span class="line">	nft_pipapo_for_each_field(f, i, m) &#123;</span><br><span class="line">		<span class="keyword">int</span> len = desc-&gt;field_len[i] ? : <span class="built_in">set</span>-&gt;klen;</span><br><span class="line"></span><br><span class="line">		f-&gt;bb = NFT_PIPAPO_GROUP_BITS_INIT;</span><br><span class="line">		f-&gt;groups = len * NFT_PIPAPO_GROUPS_PER_BYTE(f);</span><br><span class="line"></span><br><span class="line">		priv-&gt;width += round_up(len, <span class="keyword">sizeof</span>(u32));</span><br><span class="line"></span><br><span class="line">		f-&gt;bsize = <span class="number">0</span>;</span><br><span class="line">		f-&gt;rules = <span class="number">0</span>;</span><br><span class="line">		NFT_PIPAPO_LT_ASSIGN(f, <span class="literal">NULL</span>);</span><br><span class="line">		f-&gt;mt = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Create an initial clone of matching data for next insertion */</span></span><br><span class="line">	priv-&gt;clone = pipapo_clone(m);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(priv-&gt;clone)) &#123;</span><br><span class="line">		err = PTR_ERR(priv-&gt;clone);</span><br><span class="line">		<span class="keyword">goto</span> out_free;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	priv-&gt;dirty = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	rcu_assign_pointer(priv-&gt;match, m);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_free:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NFT_PIPAPO_ALIGN</span></span><br><span class="line">	free_percpu(m-&gt;scratch_aligned);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	free_percpu(m-&gt;scratch);</span><br><span class="line">out_scratch:</span><br><span class="line">	kfree(m);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä½¿ç”¨<code>nft_set_priv</code>å‡½æ•°å»é™¤setçš„dataæ®µå½“ä½œ<code>nft_pipapo</code>ç»“æ„ä½“ä½¿ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct nft_pipapo - Representation of a set</span></span><br><span class="line"><span class="comment"> * @match:	Currently in-use matching data</span></span><br><span class="line"><span class="comment"> * @clone:	Copy where pending insertions and deletions are kept</span></span><br><span class="line"><span class="comment"> * @width:	Total bytes to be matched for one packet, including padding</span></span><br><span class="line"><span class="comment"> * @dirty:	Working copy has pending insertions or deletions</span></span><br><span class="line"><span class="comment"> * @last_gc:	Timestamp of last garbage collection run, jiffies</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_match</span> __<span class="title">rcu</span> *<span class="title">match</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_match</span> *<span class="title">clone</span>;</span></span><br><span class="line">	<span class="keyword">int</span> width;</span><br><span class="line">	<span class="keyword">bool</span> dirty;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> last_gc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°æœ‰å…³äºè¯¥ç»“æ„ä½“æˆå‘˜çš„æè¿°ï¼Œè¾ƒä¸ºé‡è¦ä»¥åŠè§çš„è¾ƒå¤šçš„æ˜¯cloneæˆå‘˜ï¼Œä»–ç”¨äºæš‚æ—¶å­˜æ”¾è¦è¢«insertè·å¾—deleteçš„elementã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">nft_set_priv</span><span class="params">(<span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">void</span> *)<span class="built_in">set</span>-&gt;data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éšåä¸ºmåˆ›å»ºå†…å­˜ï¼Œå¯ä»¥çœ‹åˆ°åˆ›å»ºå†…å­˜çš„å¤§å°ç”±<code>nft_pipapo_match</code>ç»“æ„ä½“æœ¬èº«ä»¥åŠå‰é¢çš„<code>field_count</code>å†³å®šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct nft_pipapo_match - Data used for lookup and matching</span></span><br><span class="line"><span class="comment"> * @field_count		Amount of fields in set</span></span><br><span class="line"><span class="comment"> * @scratch:		Preallocated per-CPU maps for partial matching results</span></span><br><span class="line"><span class="comment"> * @scratch_aligned:	Version of @scratch aligned to NFT_PIPAPO_ALIGN bytes</span></span><br><span class="line"><span class="comment"> * @bsize_max:		Maximum lookup table bucket size of all fields, in longs</span></span><br><span class="line"><span class="comment"> * @rcu			Matching data is swapped on commits</span></span><br><span class="line"><span class="comment"> * @f:			Fields, with lookup and mapping tables</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_match</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> field_count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NFT_PIPAPO_ALIGN</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> * __percpu *scratch_aligned;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> * __percpu *scratch;</span><br><span class="line">	<span class="keyword">size_t</span> bsize_max;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_field</span> <span class="title">f</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç®€å•çœ‹ä¸€ä¸‹è¿™ä¸ªç»“æ„ä½“ï¼Œå¯ä»¥å‘ç°åé¢å°±æ˜¯ä¸€ä¸ªç»“æ„ä¸º<code>nft_pipapo_field</code>åŠ¨æ€æ•°ç»„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> nft_pipapo_for_each_field(field, index, match)		\</span></span><br><span class="line"><span class="meta">	for ((field) = (match)-&gt;f, (index) = 0;			\</span></span><br><span class="line"><span class="meta">	     (index) <span class="meta-string">&lt; (match)-&gt;</span>field_count;			\</span></span><br><span class="line"><span class="meta">	     (index)++, (field)++)</span></span><br></pre></td></tr></table></figure>

<p>æ¥ç€å°±æ˜¯å¯¹è¯¥ç»“æ„ä½“ä¹Ÿå°±æ˜¯mçš„èµ‹å€¼åˆå§‹åŒ–ï¼Œè¾ƒä¸ºé‡è¦çš„æ˜¯åç»­ä¼šè¿›å…¥åˆ°ä¸Šè¿°å¾ªç¯ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct nft_pipapo_field - Lookup, mapping tables and related data for a field</span></span><br><span class="line"><span class="comment"> * @groups:	Amount of bit groups</span></span><br><span class="line"><span class="comment"> * @rules:	Number of inserted rules</span></span><br><span class="line"><span class="comment"> * @bsize:	Size of each bucket in lookup table, in longs</span></span><br><span class="line"><span class="comment"> * @bb:		Number of bits grouped together in lookup table buckets</span></span><br><span class="line"><span class="comment"> * @lt:		Lookup table: &#x27;groups&#x27; rows of buckets</span></span><br><span class="line"><span class="comment"> * @lt_aligned:	Version of @lt aligned to NFT_PIPAPO_ALIGN bytes</span></span><br><span class="line"><span class="comment"> * @mt:		Mapping table: one bucket per rule</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_field</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> groups;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> rules;</span><br><span class="line">	<span class="keyword">size_t</span> bsize;</span><br><span class="line">	<span class="keyword">int</span> bb;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NFT_PIPAPO_ALIGN</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *lt_aligned;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *lt;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">nft_pipapo_map_bucket</span> *<span class="title">mt</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¯¥å¾ªç¯ä¸­ä¸»è¦æ˜¯å¯¹ä¸Šè¿°ç»“æ„ä½“èµ‹å€¼æ“ä½œã€‚è¿™é‡Œä¸»è¦å¯¹bbåšäº†èµ‹å€¼ä¸º8ï¼Œç„¶åå°±æ˜¯groupsèµ‹å€¼ä¸ºlenï¼Œwitdhåˆ™æ˜¯èµ‹å€¼ä¸ºlenå¯¹4å‘ä¸Šå–æ•´çš„å€æ•°ã€‚</p>
<p>æœ€åé€šè¿‡<code>pipapo_clone</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„<code>nft_pipapo_match</code>ç»“æ„èµ‹å€¼ç»™<code>((struct nft_pipapo *)set-&gt;data)-&gt;clone</code>æˆå‘˜ï¼Œæœ€åç›´æ¥å°†mèµ‹å€¼ç»™<code>((struct nft_pipapo *)set-&gt;data)-&gt;match</code>æˆå‘˜ã€‚</p>
<h3 id="nft-pipapo-insert"><a href="#nft-pipapo-insert" class="headerlink" title="nft_pipapo_insert"></a>nft_pipapo_insert</h3><p>å‰é¢ä¸»è¦å…³æ³¨äº†setçš„ç”³è¯·åŠåˆå§‹è¿‡ç¨‹è¿™é‡Œæ¥å…³æ³¨ä¸€ä¸ªelementæ˜¯æ€ä¹ˆè¢«é“¾åˆ°setä¸­çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_pipapo_insert</span><span class="params">(<span class="keyword">const</span> struct net *net, <span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">const</span> struct nft_set_elem *elem,</span></span></span><br><span class="line"><span class="params"><span class="function">			     struct nft_set_ext **ext2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext</span> *<span class="title">ext</span> =</span> nft_set_elem_ext(<span class="built_in">set</span>, elem-&gt;priv);</span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">nft_pipapo_map_bucket</span> <span class="title">rulemap</span>[<span class="title">NFT_PIPAPO_MAX_FIELDS</span>];</span></span><br><span class="line">	<span class="keyword">const</span> u8 *start = (<span class="keyword">const</span> u8 *)elem-&gt;key.val.data, *end;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_elem</span> *<span class="title">e</span> =</span> elem-&gt;priv, *dup;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo</span> *<span class="title">priv</span> =</span> nft_set_priv(<span class="built_in">set</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_match</span> *<span class="title">m</span> =</span> priv-&gt;clone;</span><br><span class="line">	u8 genmask = nft_genmask_next(net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_field</span> *<span class="title">f</span>;</span></span><br><span class="line">	<span class="keyword">const</span> u8 *start_p, *end_p;</span><br><span class="line">	<span class="keyword">int</span> i, bsize_max, err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_KEY_END))</span><br><span class="line">		end = (<span class="keyword">const</span> u8 *)nft_set_ext_key_end(ext)-&gt;data;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		end = start;</span><br><span class="line"></span><br><span class="line">	dup = pipapo_get(net, <span class="built_in">set</span>, start, genmask);</span><br><span class="line">	<span class="keyword">if</span> (!IS_ERR(dup)) &#123;</span><br><span class="line">		<span class="comment">/* Check if we already have the same exact entry */</span></span><br><span class="line">		<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_data</span> *<span class="title">dup_key</span>, *<span class="title">dup_end</span>;</span></span><br><span class="line"></span><br><span class="line">		dup_key = nft_set_ext_key(&amp;dup-&gt;ext);</span><br><span class="line">		<span class="keyword">if</span> (nft_set_ext_exists(&amp;dup-&gt;ext, NFT_SET_EXT_KEY_END))</span><br><span class="line">			dup_end = nft_set_ext_key_end(&amp;dup-&gt;ext);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			dup_end = dup_key;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">memcmp</span>(start, dup_key-&gt;data, <span class="keyword">sizeof</span>(*dup_key-&gt;data)) &amp;&amp;</span><br><span class="line">		    !<span class="built_in">memcmp</span>(end, dup_end-&gt;data, <span class="keyword">sizeof</span>(*dup_end-&gt;data))) &#123;</span><br><span class="line">			*ext2 = &amp;dup-&gt;ext;</span><br><span class="line">			<span class="keyword">return</span> -EEXIST;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> -ENOTEMPTY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (PTR_ERR(dup) == -ENOENT) &#123;</span><br><span class="line">		<span class="comment">/* Look for partially overlapping entries */</span></span><br><span class="line">		dup = pipapo_get(net, <span class="built_in">set</span>, end, nft_genmask_next(net));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (PTR_ERR(dup) != -ENOENT) &#123;</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(dup))</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(dup);</span><br><span class="line">		*ext2 = &amp;dup-&gt;ext;</span><br><span class="line">		<span class="keyword">return</span> -ENOTEMPTY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Validate */</span></span><br><span class="line">	start_p = start;</span><br><span class="line">	end_p = end;</span><br><span class="line">	nft_pipapo_for_each_field(f, i, m) &#123;</span><br><span class="line">		<span class="keyword">if</span> (f-&gt;rules &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)NFT_PIPAPO_RULE0_MAX)</span><br><span class="line">			<span class="keyword">return</span> -ENOSPC;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">memcmp</span>(start_p, end_p,</span><br><span class="line">			   f-&gt;groups / NFT_PIPAPO_GROUPS_PER_BYTE(f)) &gt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		start_p += NFT_PIPAPO_GROUPS_PADDED_SIZE(f);</span><br><span class="line">		end_p += NFT_PIPAPO_GROUPS_PADDED_SIZE(f);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Insert */</span></span><br><span class="line">	priv-&gt;dirty = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	bsize_max = m-&gt;bsize_max;</span><br><span class="line"></span><br><span class="line">	nft_pipapo_for_each_field(f, i, m) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">		rulemap[i].to = f-&gt;rules;</span><br><span class="line"></span><br><span class="line">		ret = <span class="built_in">memcmp</span>(start, end,</span><br><span class="line">			     f-&gt;groups / NFT_PIPAPO_GROUPS_PER_BYTE(f));</span><br><span class="line">		<span class="keyword">if</span> (!ret)</span><br><span class="line">			ret = pipapo_insert(f, start, f-&gt;groups * f-&gt;bb);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			ret = pipapo_expand(f, start, end, f-&gt;groups * f-&gt;bb);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (f-&gt;bsize &gt; bsize_max)</span><br><span class="line">			bsize_max = f-&gt;bsize;</span><br><span class="line"></span><br><span class="line">		rulemap[i].n = ret;</span><br><span class="line"></span><br><span class="line">		start += NFT_PIPAPO_GROUPS_PADDED_SIZE(f);</span><br><span class="line">		end += NFT_PIPAPO_GROUPS_PADDED_SIZE(f);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!*get_cpu_ptr(m-&gt;scratch) || bsize_max &gt; m-&gt;bsize_max) &#123;</span><br><span class="line">		put_cpu_ptr(m-&gt;scratch);</span><br><span class="line"></span><br><span class="line">		err = pipapo_realloc_scratch(m, bsize_max);</span><br><span class="line">		<span class="keyword">if</span> (err)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		m-&gt;bsize_max = bsize_max;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		put_cpu_ptr(m-&gt;scratch);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*ext2 = &amp;e-&gt;ext;</span><br><span class="line"></span><br><span class="line">	pipapo_map(m, rulemap, e);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>åœ¨çœ‹è¿™é‡Œä»£ç çš„æ—¶å€™æœ€å¥½ç»“åˆå‰æ–‡ä¸­çš„<code>nft_add_set_elem</code>é…åˆç€çœ‹ï¼Œè¿™é‡Œçš„å‚æ•°elemå¹¶ä¸æ˜¯çœŸæ­£çš„elementè€Œåªæ˜¯åœ¨æ ˆä¸Šçš„ç»“æ„ï¼Œè¿™é‡ŒçœŸæ­£çš„elementæ˜¯elem-&gt;privã€‚</strong></p>
<p>å‡½æ•°å¼€å¤´é¦–å…ˆæ˜¯é€šè¿‡<code>nft_set_elem_ext</code>å‡½æ•°æ‹¿å‡ºçœŸæ˜¯elemä¸­çš„extæ®µï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ®µ<code>keyã€key_endã€data</code>ç­‰éƒ½åœ¨æ­¤æ®µä¸­ã€‚</p>
<p>éšååˆ›å»ºä¸€ä¸ªç»“æ„ä¸º<code>nft_pipapo_map_bucket</code>çš„æ•°ç»„ï¼Œè¿™ä¸ªç»“æ„å¾ˆçœ¼ç†Ÿå› ä¸ºåœ¨å‰é¢çš„<code>nft_pipapo_field</code>ç»“æ„ä½“ä¸­ä¹Ÿçœ‹åˆ°è¿‡æ­¤ç»“æ„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * union nft_pipapo_map_bucket - Bucket of mapping table</span></span><br><span class="line"><span class="comment"> * @to:		First rule number (in next field) this rule maps to</span></span><br><span class="line"><span class="comment"> * @n:		Number of rules (in next field) this rule maps to</span></span><br><span class="line"><span class="comment"> * @e:		If there&#x27;s no next field, pointer to element this rule maps to</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">nft_pipapo_map_bucket</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BITS_PER_LONG == 64</span></span><br><span class="line">		<span class="keyword">static_assert</span>(NFT_PIPAPO_MAP_TOBITS &lt;= <span class="number">32</span>);</span><br><span class="line">		u32 to;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">static_assert</span>(NFT_PIPAPO_MAP_NBITS &lt;= <span class="number">32</span>);</span><br><span class="line">		u32 n;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> to:NFT_PIPAPO_MAP_TOBITS;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span>  n:NFT_PIPAPO_MAP_NBITS;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_elem</span> *<span class="title">e</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ªæˆå‘˜ç»“æ„æ­£å¥½ä¸º<code>nft_pipapo_elem</code>ï¼Œä¸éš¾çŒœåˆ°è¿™ä¸ªç»“æ„ä½“å°±æ˜¯æœ€ç»ˆç”¨äºå­˜æ”¾elementçš„ç»“æ„ä½“ã€‚</p>
<p>æ¥ç€ä»æ ˆä¸Šçš„elemå–å‡ºkeyèµ‹å€¼ç»™startï¼Œæ¥ç€å°†çœŸå®çš„elementèµ‹å€¼ç»™eï¼Œéšåå’Œå‰é¢çš„initç±»ä¼¼ï¼Œå–å‡ºsetä¸­çš„dataå­—æ®µå½“ä½œ<code>nft_pipapo</code>ä½¿ç”¨ã€‚</p>
<p>æ¥ç€ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>key_end</code>å¦‚æœæœ‰åˆ™å–å‡ºï¼Œå¦‚æœæ²¡æœ‰åˆ™ç›´æ¥å°†endæŒ‡å‘startã€‚</p>
<p>éšåå°±æ˜¯å¯¹keyçš„åˆ¤æ–­æ˜¯å¦ä»¥åŠå­˜åœ¨ä¹‹ç±»çš„ï¼Œæœ€åçš„forå¾ªç¯æ‰æ˜¯çœŸæ­£çš„æ’å…¥è¿‡ç¨‹ã€‚</p>
<p>é¦–å…ˆä¼šè®©<code>rulemap[i].to</code>ç­‰äº<code>f-&gt;rules</code>ï¼Œè¿™é‡Œçš„ç®€å•ä»‹ç»ä¸€ä¸‹ä¸Šé¢çš„ç»“æ„ä½“ä¸­ï¼Œtoçš„å«ä¹‰ä¸ºä¸‹ä¸€ä¸ªruleçš„æ ‡å·ï¼Œnè¡¨ç¤ºçš„æ˜¯ä¸‹ä¸€ä¸ªruleçš„ä¸ªæ•°ï¼ˆåé¢çœ‹åˆ°äº†ä¸Šé¢å…¶å®å¹¶ä¸æ˜¯ç»“æ„ä½“æ˜¯unionå“ˆï¼‰ã€‚çŸ¥é“äº†è¿™ä¸¤ä¸ªæ˜¯å¹²ä»€ä¹ˆçš„å†å»çœ‹insertå°±ä¼šå¾ˆå¥½ç†è§£äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pipapo_insert</span><span class="params">(struct nft_pipapo_field *f, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *k,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">int</span> mask_bits)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rule = f-&gt;rules++, group, ret, bit_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ret = pipapo_resize(f, f-&gt;rules - <span class="number">1</span>, f-&gt;rules);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (group = <span class="number">0</span>; group &lt; f-&gt;groups; group++) &#123;</span><br><span class="line">		<span class="keyword">int</span> i, v;</span><br><span class="line">		u8 mask;</span><br><span class="line"></span><br><span class="line">		v = k[group / (BITS_PER_BYTE / f-&gt;bb)];</span><br><span class="line">		v &amp;= GENMASK(BITS_PER_BYTE - bit_offset - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">		v &gt;&gt;= (BITS_PER_BYTE - bit_offset) - f-&gt;bb;</span><br><span class="line"></span><br><span class="line">		bit_offset += f-&gt;bb;</span><br><span class="line">		bit_offset %= BITS_PER_BYTE;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mask_bits &gt;= (group + <span class="number">1</span>) * f-&gt;bb) &#123;</span><br><span class="line">			<span class="comment">/* Not masked */</span></span><br><span class="line">			pipapo_bucket_set(f, rule, group, v);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mask_bits &lt;= group * f-&gt;bb) &#123;</span><br><span class="line">			<span class="comment">/* Completely masked */</span></span><br><span class="line">			<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NFT_PIPAPO_BUCKETS(f-&gt;bb); i++)</span><br><span class="line">				pipapo_bucket_set(f, rule, group, i);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* The mask limit falls on this group */</span></span><br><span class="line">			mask = GENMASK(f-&gt;bb - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">			mask &gt;&gt;= mask_bits - group * f-&gt;bb;</span><br><span class="line">			<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NFT_PIPAPO_BUCKETS(f-&gt;bb); i++) &#123;</span><br><span class="line">				<span class="keyword">if</span> ((i &amp; ~mask) == (v &amp; ~mask))</span><br><span class="line">					pipapo_bucket_set(f, rule, group, i);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pipapo_lt_bits_adjust(f);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¢å¤§å¤šæ˜¯å¯¹æ•°æ®åšå¤„ç†æˆ‘ä»¬æš‚æ—¶å…ˆä¸å…³å¿ƒï¼Œä¸»è¦çœ‹å…¶ä¸­çš„<code>pipapo_resize</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†ltå’Œmtæ ¹æ®å½“å‰çš„ruleæ•°é‡è¿›è¡Œé‡æ–°ç”³è¯·ï¼Œå› ä¸ºåœ¨å‰é¢initæ—¶è¿™ä¿©éƒ½ä¸º0ï¼Œå³ä¾¿æ˜¯åœ¨cloneä¹‹åä¹Ÿæ˜¯å¦‚æ­¤ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå…ˆåœ¨å‡½æ•°å¼€å¤´é‡æ–°åˆ†é…ã€‚æœ€åä¸­é—´åˆ™æ˜¯æ ¹æ®maskbitè¿›è¡Œå¤„ç†ï¼Œæœ€åè¿”å›1ï¼Œè¿™é‡Œè¿”å›çš„1æ˜¯ç»™åˆ°äº†<code>rulemap[i].n</code>çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pipapo_expand</span><span class="params">(struct nft_pipapo_field *f,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">const</span> u8 *start, <span class="keyword">const</span> u8 *end, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> step, masks = <span class="number">0</span>, bytes = DIV_ROUND_UP(len, BITS_PER_BYTE);</span><br><span class="line">	u8 base[NFT_PIPAPO_MAX_BYTES];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(base, start, bytes);</span><br><span class="line">	<span class="keyword">while</span> (<span class="built_in">memcmp</span>(base, end, bytes) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">		step = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (pipapo_step_diff(base, step, bytes)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (pipapo_step_after_end(base, end, step, bytes))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			step++;</span><br><span class="line">			<span class="keyword">if</span> (step &gt;= len) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!masks) &#123;</span><br><span class="line">					pipapo_insert(f, base, <span class="number">0</span>);</span><br><span class="line">					masks = <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = pipapo_insert(f, base, len - step);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		masks++;</span><br><span class="line">		pipapo_base_sum(base, step, bytes);</span><br><span class="line">	&#125;</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> masks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåœ¨ç®€å•çœ‹ä¸€ä¸‹expandï¼Œè¿™ç§æƒ…å†µå°±æ˜¯startå’Œendä¸ä¸€è‡´æ—¶ä¼šäº§ç”Ÿçš„ï¼Œè¿™è¡¨æ˜è¿™ä¸ªfieldä¸­å­˜åœ¨å¤šæ¡è§„åˆ™ï¼Œæœ€ç»ˆè¿”å›masksã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pipapo_map</span><span class="params">(struct nft_pipapo_match *m,</span></span></span><br><span class="line"><span class="params"><span class="function">		       <span class="keyword">union</span> nft_pipapo_map_bucket <span class="built_in">map</span>[NFT_PIPAPO_MAX_FIELDS],</span></span></span><br><span class="line"><span class="params"><span class="function">		       struct nft_pipapo_elem *e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_field</span> *<span class="title">f</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>, f = m-&gt;f; i &lt; m-&gt;field_count - <span class="number">1</span>; i++, f++) &#123;</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="built_in">map</span>[i].n; j++) &#123;</span><br><span class="line">			f-&gt;mt[<span class="built_in">map</span>[i].to + j].to = <span class="built_in">map</span>[i + <span class="number">1</span>].to;</span><br><span class="line">			f-&gt;mt[<span class="built_in">map</span>[i].to + j].n = <span class="built_in">map</span>[i + <span class="number">1</span>].n;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Last field: map to ext instead of mapping to next field */</span></span><br><span class="line">	<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="built_in">map</span>[i].n; j++)</span><br><span class="line">		f-&gt;mt[<span class="built_in">map</span>[i].to + j].e = e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±æ˜¯è¿™é‡Œæ¯”è¾ƒé‡è¦çš„<code>pipapo_map</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šæ ¹æ®å‰é¢çš„ç»“æœå¯¹<code>f-&gt;mt</code>èµ‹å€¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">field_count = <span class="number">2</span>;</span><br><span class="line">f1-&gt;rules = <span class="number">0</span>;</span><br><span class="line">f2-&gt;rules = <span class="number">0</span>;</span><br><span class="line">rulemap = [</span><br><span class="line">    &#123;to:<span class="number">0</span>, n:<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;to:<span class="number">0</span>, n:<span class="number">1</span>&#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">â†“â†“â†“â†“â†“â†“    å˜ä¸º</span><br><span class="line"></span><br><span class="line">f1-&gt;rules = <span class="number">1</span>;</span><br><span class="line">f2-&gt;rules = <span class="number">1</span>;</span><br><span class="line">f1-&gt;mt = [</span><br><span class="line">    &#123;to:<span class="number">0</span>, n:<span class="number">1</span>&#125;</span><br><span class="line">];</span><br><span class="line">f2-&gt;mt = [</span><br><span class="line">    &#123;e: element&#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">field_count = <span class="number">3</span>;</span><br><span class="line">f1-&gt;rules = <span class="number">0</span>;</span><br><span class="line">f2-&gt;rules = <span class="number">0</span>;</span><br><span class="line">f3-&gt;rules = <span class="number">0</span>;</span><br><span class="line">rulemap = [</span><br><span class="line">    &#123;to:<span class="number">0</span>, n:<span class="number">2</span>&#125;,</span><br><span class="line">    &#123;to:<span class="number">2</span>, n:<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;to:<span class="number">3</span>, n:<span class="number">2</span>&#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">â†“â†“â†“â†“â†“â†“    å˜ä¸º</span><br><span class="line"></span><br><span class="line">f1-&gt;rules = <span class="number">2</span>;</span><br><span class="line">f2-&gt;rules = <span class="number">1</span>;</span><br><span class="line">f3-&gt;rules = <span class="number">2</span>;</span><br><span class="line">f1-&gt;mt = [</span><br><span class="line">    &#123;to:<span class="number">2</span>, n:<span class="number">1</span>&#125;,</span><br><span class="line">    &#123;to:<span class="number">2</span>, n:<span class="number">1</span>&#125;</span><br><span class="line">];</span><br><span class="line">f2-&gt;mt = [</span><br><span class="line">    &#123;to:<span class="number">3</span>, n:<span class="number">2</span>&#125;;</span><br><span class="line">];</span><br><span class="line">f3-&gt;mt = [</span><br><span class="line">    &#123;e: element&#125;,</span><br><span class="line">    &#123;e: element&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆä¼šå½¢æˆå¦‚ä¸Šå½¢å¼ï¼Œç›®å‰elementå­˜åœ¨äºsetçš„è¿™æ ·ä¸€æ¡é“¾ä¸­<code>((struct nft_pipapo *)set-&gt;data)-&gt;clone-&gt;f-&gt;mt[i].e</code>ä¸­ï¼Œåœ¨å¼€å¤´æˆ‘ä»¬ä¹Ÿè¯´äº†cloneæˆå‘˜ä»£è¡¨çš„æ˜¯ä¸´æ—¶å­˜æ”¾çš„ï¼Œæ‰€ä»¥æœ€åè¿˜ä¼šé€šè¿‡commitæäº¤è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> NFT_MSG_NEWSETELEM:</span><br><span class="line">        te = (struct nft_trans_elem *)trans-&gt;data;</span><br><span class="line"></span><br><span class="line">        nft_setelem_activate(net, te-&gt;<span class="built_in">set</span>, &amp;te-&gt;elem);</span><br><span class="line">        nf_tables_setelem_notify(&amp;trans-&gt;ctx, te-&gt;<span class="built_in">set</span>,</span><br><span class="line">                     &amp;te-&gt;elem,</span><br><span class="line">                     NFT_MSG_NEWSETELEM);</span><br><span class="line">        <span class="keyword">if</span> (te-&gt;<span class="built_in">set</span>-&gt;ops-&gt;commit &amp;&amp;</span><br><span class="line">            list_empty(&amp;te-&gt;<span class="built_in">set</span>-&gt;pending_update)) &#123;</span><br><span class="line">            list_add_tail(&amp;te-&gt;<span class="built_in">set</span>-&gt;pending_update,</span><br><span class="line">                      &amp;set_update_list);</span><br><span class="line">        &#125;</span><br><span class="line">        nft_trans_destroy(trans);</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>æœ€åæ¥åˆ°<code>nf_tables_commit</code>å‡½æ•°è¿™é‡Œä¸»è¦æ˜¯å¯¹transå’Œelementè¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œä¸»è¦å°±æ˜¯å°†setåŠ å…¥åˆ°æ›´æ–°åˆ—è¡¨ä¸­ï¼Œå¯¹transå¤„ç†å°±ä¸è¿‡å¤šæåŠå¯¹elementå¤„ç†ä¼šåœ¨å¤ç°å‰é¢æåˆ°çš„CVE-2024-1085è¯¦ç»†åˆ†æã€‚å‡½æ•°æœ€åä¼šè°ƒç”¨<code>nft_set_commit_update</code>å‡½æ•°å¯¹è¿™é‡ŒåŠ å…¥æ›´æ–°åˆ—è¡¨çš„è¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_set_commit_update</span><span class="params">(struct list_head *set_update_list)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set</span> *<span class="title">set</span>, *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">	list_for_each_entry_safe(<span class="built_in">set</span>, next, set_update_list, pending_update) &#123;</span><br><span class="line">		list_del_init(&amp;<span class="built_in">set</span>-&gt;pending_update);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">set</span>-&gt;ops-&gt;commit)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">set</span>-&gt;ops-&gt;commit(<span class="built_in">set</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åè¿™é‡Œåˆä¸€æ¬¡ä¼šè°ƒç”¨opsä¸­çš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_pipapo_commit</span><span class="params">(<span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo</span> *<span class="title">priv</span> =</span> nft_set_priv(<span class="built_in">set</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_match</span> *<span class="title">new_clone</span>, *<span class="title">old</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (time_after_eq(jiffies, priv-&gt;last_gc + nft_set_gc_interval(<span class="built_in">set</span>)))</span><br><span class="line">		pipapo_gc(<span class="built_in">set</span>, priv-&gt;clone);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!priv-&gt;dirty)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	new_clone = pipapo_clone(priv-&gt;clone);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(new_clone))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	priv-&gt;dirty = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	old = rcu_access_pointer(priv-&gt;match);</span><br><span class="line">	rcu_assign_pointer(priv-&gt;match, priv-&gt;clone);</span><br><span class="line">	<span class="keyword">if</span> (old)</span><br><span class="line">		call_rcu(&amp;old-&gt;rcu, pipapo_reclaim_match);</span><br><span class="line"></span><br><span class="line">	priv-&gt;clone = new_clone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¸»è¦å¹²çš„äº‹å°±æ˜¯å°†cloneç§»åˆ°matchæˆå‘˜ä¸Šï¼Œæœ€åè°ƒç”¨<code>pipapo_reclaim_match</code>å»freeæ‰cloneæˆå‘˜ã€‚</p>
<h3 id="nft-del-setelem"><a href="#nft-del-setelem" class="headerlink" title="nft_del_setelem"></a>nft_del_setelem</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_del_setelem</span><span class="params">(struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			   <span class="keyword">const</span> struct nlattr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nla</span>[<span class="title">NFTA_SET_ELEM_MAX</span> + 1];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext_tmpl</span> <span class="title">tmpl</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_elem</span> <span class="title">elem</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext</span> *<span class="title">ext</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	u32 flags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(nla, NFTA_SET_ELEM_MAX, attr,</span><br><span class="line">					  nft_set_elem_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	err = nft_setelem_parse_flags(<span class="built_in">set</span>, nla[NFTA_SET_ELEM_FLAGS], &amp;flags);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nla[NFTA_SET_ELEM_KEY] &amp;&amp; !(flags &amp; NFT_SET_ELEM_CATCHALL))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nft_setelem_valid_key_end(<span class="built_in">set</span>, nla, flags))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	nft_set_ext_prepare(&amp;tmpl);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags != <span class="number">0</span>) &#123;</span><br><span class="line">		err = nft_set_ext_add(&amp;tmpl, NFT_SET_EXT_FLAGS);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_KEY]) &#123;</span><br><span class="line">		err = nft_setelem_parse_key(ctx, <span class="built_in">set</span>, &amp;elem.key.val,</span><br><span class="line">					    nla[NFTA_SET_ELEM_KEY]);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		err = nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_KEY, <span class="built_in">set</span>-&gt;klen);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> fail_elem;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_SET_ELEM_KEY_END]) &#123;</span><br><span class="line">		err = nft_setelem_parse_key(ctx, <span class="built_in">set</span>, &amp;elem.key_end.val,</span><br><span class="line">					    nla[NFTA_SET_ELEM_KEY_END]);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> fail_elem;</span><br><span class="line"></span><br><span class="line">		err = nft_set_ext_add_length(&amp;tmpl, NFT_SET_EXT_KEY_END, <span class="built_in">set</span>-&gt;klen);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> fail_elem_key_end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = -ENOMEM;</span><br><span class="line">	elem.priv = nft_set_elem_init(<span class="built_in">set</span>, &amp;tmpl, elem.key.val.data,</span><br><span class="line">				      elem.key_end.val.data, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">				      GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(elem.priv)) &#123;</span><br><span class="line">		err = PTR_ERR(elem.priv);</span><br><span class="line">		<span class="keyword">goto</span> fail_elem_key_end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ext = nft_set_elem_ext(<span class="built_in">set</span>, elem.priv);</span><br><span class="line">	<span class="keyword">if</span> (flags)</span><br><span class="line">		*nft_set_ext_flags(ext) = flags;</span><br><span class="line"></span><br><span class="line">	trans = nft_trans_elem_alloc(ctx, NFT_MSG_DELSETELEM, <span class="built_in">set</span>);</span><br><span class="line">	<span class="keyword">if</span> (trans == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> fail_trans;</span><br><span class="line"></span><br><span class="line">	err = nft_setelem_deactivate(ctx-&gt;net, <span class="built_in">set</span>, &amp;elem, flags);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> fail_ops;</span><br><span class="line"></span><br><span class="line">	nft_setelem_data_deactivate(ctx-&gt;net, <span class="built_in">set</span>, &amp;elem);</span><br><span class="line"></span><br><span class="line">	nft_trans_elem(trans) = elem;</span><br><span class="line">	nft_trans_commit_list_add_tail(ctx-&gt;net, trans);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fail_ops:</span><br><span class="line">	kfree(trans);</span><br><span class="line">fail_trans:</span><br><span class="line">	kfree(elem.priv);</span><br><span class="line">fail_elem_key_end:</span><br><span class="line">	nft_data_release(&amp;elem.key_end.val, NFT_DATA_VALUE);</span><br><span class="line">fail_elem:</span><br><span class="line">	nft_data_release(&amp;elem.key.val, NFT_DATA_VALUE);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå’Œaddæœ‰ç‚¹å­åƒï¼Œä¹Ÿæ˜¯ä¼šåœ¨nlaä¸­æ‹¿å€¼åªæ˜¯æ²¡é‚£ä¹ˆå¤šï¼Œè¿™é‡Œä¼šå–å‡ºkeyå’Œkey_endæ¥å’Œå·²å­˜åœ¨çš„è¿›è¡Œæ¯”è¾ƒã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_set_flush</span><span class="params">(struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>, u8 genmask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_iter</span> <span class="title">iter</span> =</span> &#123;</span><br><span class="line">		.genmask	= genmask,</span><br><span class="line">		.fn		= nft_setelem_flush,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span>-&gt;ops-&gt;walk(ctx, <span class="built_in">set</span>, &amp;iter);</span><br><span class="line">	<span class="keyword">if</span> (!iter.err)</span><br><span class="line">		iter.err = nft_set_catchall_flush(ctx, <span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> iter.err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_delsetelem</span><span class="params">(struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">const</span> struct nfnl_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> *<span class="title">extack</span> =</span> info-&gt;extack;</span><br><span class="line">	u8 genmask = nft_genmask_next(info-&gt;net);</span><br><span class="line">	u8 family = info-&gt;nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> info-&gt;net;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set</span> *<span class="title">set</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	<span class="keyword">int</span> rem, err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	table = nft_table_lookup(net, nla[NFTA_SET_ELEM_LIST_TABLE], family,</span><br><span class="line">				 genmask, NETLINK_CB(skb).portid);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_SET_ELEM_LIST_TABLE]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span> = nft_set_lookup(table, nla[NFTA_SET_ELEM_LIST_SET], genmask);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(<span class="built_in">set</span>))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(<span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!list_empty(&amp;<span class="built_in">set</span>-&gt;bindings) &amp;&amp;</span><br><span class="line">	    (<span class="built_in">set</span>-&gt;flags &amp; (NFT_SET_CONSTANT | NFT_SET_ANONYMOUS)))</span><br><span class="line">		<span class="keyword">return</span> -EBUSY;</span><br><span class="line"></span><br><span class="line">	nft_ctx_init(&amp;ctx, net, skb, info-&gt;nlh, family, table, <span class="literal">NULL</span>, nla);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nla[NFTA_SET_ELEM_LIST_ELEMENTS])</span><br><span class="line">		<span class="keyword">return</span> nft_set_flush(&amp;ctx, <span class="built_in">set</span>, genmask);</span><br><span class="line"></span><br><span class="line">	nla_for_each_nested(attr, nla[NFTA_SET_ELEM_LIST_ELEMENTS], rem) &#123;</span><br><span class="line">		err = nft_del_setelem(&amp;ctx, <span class="built_in">set</span>, attr);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥é€‰æ‹©ç›´æ¥å·æ‡’ä¸è®¾ç½®<code>NFTA_SET_ELEM_LIST_ELEMENTS</code>ç„¶åèµ°<code>nft_set_flush</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_set_flush</span><span class="params">(struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>, u8 genmask)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_iter</span> <span class="title">iter</span> =</span> &#123;</span><br><span class="line">		.genmask	= genmask,</span><br><span class="line">		.fn		= nft_setelem_flush,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">set</span>-&gt;ops-&gt;walk(ctx, <span class="built_in">set</span>, &amp;iter);</span><br><span class="line">	<span class="keyword">if</span> (!iter.err)</span><br><span class="line">		iter.err = nft_set_catchall_flush(ctx, <span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> iter.err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šç›´æ¥è°ƒç”¨<code>set-&gt;ops-&gt;walk</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_pipapo_walk</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			    struct nft_set_iter *iter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo</span> *<span class="title">priv</span> =</span> nft_set_priv(<span class="built_in">set</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> read_pnet(&amp;<span class="built_in">set</span>-&gt;net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_match</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_field</span> *<span class="title">f</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i, r;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	<span class="keyword">if</span> (iter-&gt;genmask == nft_genmask_cur(net))</span><br><span class="line">		m = rcu_dereference(priv-&gt;match);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		m = priv-&gt;clone;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!m))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>, f = m-&gt;f; i &lt; m-&gt;field_count - <span class="number">1</span>; i++, f++)</span><br><span class="line">		;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (r = <span class="number">0</span>; r &lt; f-&gt;rules; r++) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_elem</span> *<span class="title">e</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_elem</span> <span class="title">elem</span>;</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (r &lt; f-&gt;rules - <span class="number">1</span> &amp;&amp; f-&gt;mt[r + <span class="number">1</span>].e == f-&gt;mt[r].e)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (iter-&gt;count &lt; iter-&gt;skip)</span><br><span class="line">			<span class="keyword">goto</span> cont;</span><br><span class="line"></span><br><span class="line">		e = f-&gt;mt[r].e;</span><br><span class="line">		<span class="keyword">if</span> (nft_set_elem_expired(&amp;e-&gt;ext))</span><br><span class="line">			<span class="keyword">goto</span> cont;</span><br><span class="line"></span><br><span class="line">		elem.priv = e;</span><br><span class="line"></span><br><span class="line">		iter-&gt;err = iter-&gt;fn(ctx, <span class="built_in">set</span>, iter, &amp;elem);</span><br><span class="line">		<span class="keyword">if</span> (iter-&gt;err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">cont:</span><br><span class="line">		iter-&gt;count++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“åˆå‰é¢çš„åˆ†æå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°è¿™é‡Œä¼šæ‹¿åˆ°elementç»™åˆ°<code>elem.priv</code>ã€‚æœ€åè°ƒç”¨<code>iter-&gt;fn</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_setelem_flush</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">			     struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">const</span> struct nft_set_iter *iter,</span></span></span><br><span class="line"><span class="params"><span class="function">			     struct nft_set_elem *elem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	trans = nft_trans_alloc_gfp(ctx, NFT_MSG_DELSETELEM,</span><br><span class="line">				    <span class="keyword">sizeof</span>(struct nft_trans_elem), GFP_ATOMIC);</span><br><span class="line">	<span class="keyword">if</span> (!trans)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">set</span>-&gt;ops-&gt;flush(ctx-&gt;net, <span class="built_in">set</span>, elem-&gt;priv)) &#123;</span><br><span class="line">		err = -ENOENT;</span><br><span class="line">		<span class="keyword">goto</span> err1;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">set</span>-&gt;ndeact++;</span><br><span class="line"></span><br><span class="line">	nft_setelem_data_deactivate(ctx-&gt;net, <span class="built_in">set</span>, elem);</span><br><span class="line">	nft_trans_elem_set(trans) = <span class="built_in">set</span>;</span><br><span class="line">	nft_trans_elem(trans) = *elem;</span><br><span class="line">	nft_trans_commit_list_add_tail(ctx-&gt;net, trans);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err1:</span><br><span class="line">	kfree(trans);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¤§éƒ¨åˆ†å°±ä¸ç”¨å¤šæï¼Œå°±æ˜¯åˆ›å»ºtranså‡†å¤‡commitï¼Œè¿™é‡Œæœ‰ä¸ªå¯¹<code>set-&gt;ops-&gt;flush</code>çš„åˆ¤æ–­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_pipapo_activate</span><span class="params">(<span class="keyword">const</span> struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">const</span> struct nft_set_elem *elem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_elem</span> *<span class="title">e</span>;</span></span><br><span class="line"></span><br><span class="line">	e = pipapo_get(net, <span class="built_in">set</span>, (<span class="keyword">const</span> u8 *)elem-&gt;key.val.data, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(e))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	nft_set_elem_change_active(net, <span class="built_in">set</span>, &amp;e-&gt;ext);</span><br><span class="line">	nft_set_elem_clear_busy(&amp;e-&gt;ext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">nft_pipapo_flush</span><span class="params">(<span class="keyword">const</span> struct net *net, <span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">void</span> *elem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_elem</span> *<span class="title">e</span> =</span> elem;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pipapo_deactivate(net, <span class="built_in">set</span>, (<span class="keyword">const</span> u8 *)nft_set_ext_key(&amp;e-&gt;ext),</span><br><span class="line">				 &amp;e-&gt;ext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šä¿®æ”¹elementçš„æ´»è·ƒçŠ¶æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> NFT_MSG_DELSETELEM:</span><br><span class="line">        te = (struct nft_trans_elem *)trans-&gt;data;</span><br><span class="line"></span><br><span class="line">        nf_tables_setelem_notify(&amp;trans-&gt;ctx, te-&gt;<span class="built_in">set</span>,</span><br><span class="line">                     &amp;te-&gt;elem,</span><br><span class="line">                     NFT_MSG_DELSETELEM);</span><br><span class="line">        nft_setelem_remove(net, te-&gt;<span class="built_in">set</span>, &amp;te-&gt;elem);</span><br><span class="line">        <span class="keyword">if</span> (!nft_setelem_is_catchall(te-&gt;<span class="built_in">set</span>, &amp;te-&gt;elem)) &#123;</span><br><span class="line">            atomic_dec(&amp;te-&gt;<span class="built_in">set</span>-&gt;nelems);</span><br><span class="line">            te-&gt;<span class="built_in">set</span>-&gt;ndeact--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (te-&gt;<span class="built_in">set</span>-&gt;ops-&gt;commit &amp;&amp;</span><br><span class="line">            list_empty(&amp;te-&gt;<span class="built_in">set</span>-&gt;pending_update)) &#123;</span><br><span class="line">            list_add_tail(&amp;te-&gt;<span class="built_in">set</span>-&gt;pending_update,</span><br><span class="line">                      &amp;set_update_list);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>å‰é¢çš„é€»è¾‘æ¯”è¾ƒç®€å•è¿™é‡Œç›´æ¥çœ‹commitçš„å†…å®¹ï¼Œè¿™é‡Œä¸»è¦çœ‹<code>nft_setelem_remove</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_setelem_remove</span><span class="params">(<span class="keyword">const</span> struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">const</span> struct nft_set_elem *elem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (nft_setelem_is_catchall(<span class="built_in">set</span>, elem))</span><br><span class="line">		nft_setelem_catchall_remove(net, <span class="built_in">set</span>, elem);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">set</span>-&gt;ops-&gt;remove(net, <span class="built_in">set</span>, elem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬å¹¶ä¸æ˜¯<code>catchall</code>ç±»å‹çš„ï¼ˆçœ‹åˆ°è¿™ä¸ªå°±çƒ¦ï¼ï¼ï¼ï¼‰æ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨<code>set-&gt;ops-&gt;remove</code>ã€‚</p>
<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_pipapo_remove</span><span class="params">(<span class="keyword">const</span> struct net *net, <span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nft_set_elem *elem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo</span> *<span class="title">priv</span> =</span> nft_set_priv(<span class="built_in">set</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_match</span> *<span class="title">m</span> =</span> priv-&gt;clone;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_elem</span> *<span class="title">e</span> =</span> elem-&gt;priv;</span><br><span class="line">	<span class="keyword">int</span> rules_f0, first_rule = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">const</span> u8 *data;</span><br><span class="line"></span><br><span class="line">	data = (<span class="keyword">const</span> u8 *)nft_set_ext_key(&amp;e-&gt;ext);</span><br><span class="line"></span><br><span class="line">	e = pipapo_get(net, <span class="built_in">set</span>, data, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(e))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((rules_f0 = pipapo_rules_same_key(m-&gt;f, first_rule))) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">union</span> <span class="title">nft_pipapo_map_bucket</span> <span class="title">rulemap</span>[<span class="title">NFT_PIPAPO_MAX_FIELDS</span>];</span></span><br><span class="line">		<span class="keyword">const</span> u8 *match_start, *match_end;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_pipapo_field</span> *<span class="title">f</span>;</span></span><br><span class="line">		<span class="keyword">int</span> i, start, rules_fx;</span><br><span class="line"></span><br><span class="line">		match_start = data;</span><br><span class="line">		match_end = (<span class="keyword">const</span> u8 *)nft_set_ext_key_end(&amp;e-&gt;ext)-&gt;data;</span><br><span class="line"></span><br><span class="line">		start = first_rule;</span><br><span class="line">		rules_fx = rules_f0;</span><br><span class="line"></span><br><span class="line">		nft_pipapo_for_each_field(f, i, m) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!pipapo_match_field(f, start, rules_fx,</span><br><span class="line">						match_start, match_end))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			rulemap[i].to = start;</span><br><span class="line">			rulemap[i].n = rules_fx;</span><br><span class="line"></span><br><span class="line">			rules_fx = f-&gt;mt[start].n;</span><br><span class="line">			start = f-&gt;mt[start].to;</span><br><span class="line"></span><br><span class="line">			match_start += NFT_PIPAPO_GROUPS_PADDED_SIZE(f);</span><br><span class="line">			match_end += NFT_PIPAPO_GROUPS_PADDED_SIZE(f);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (i == m-&gt;field_count) &#123;</span><br><span class="line">			priv-&gt;dirty = <span class="literal">true</span>;</span><br><span class="line">			pipapo_drop(m, rulemap);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		first_rule += rules_f0;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„æ¼æ´å°±å‘ç”Ÿåœ¨<code>nft_pipapo_remove</code>å‡½æ•°ä¸­ï¼Œæ‰€ä»¥åœ¨åˆ†æè¿™ä¸ªå‡½æ•°çš„åŒæ—¶å°±ä¸€èµ·æŠŠæ¼æ´ç»™åˆ†æäº†ã€‚</p>
<p>é¦–å…ˆå‡½æ•°å¼€å¤´ä½¿ç”¨<code>pipapo_get</code>å‡½æ•°é€šè¿‡keyæ‹¿åˆ°å¯¹åº”çš„elementï¼Œç„¶åè¿›å…¥åˆ°å¾ªç¯ä¸­ï¼Œ<strong>æ³¨æ„çš„æ˜¯è¿™é‡Œä¼šç›´æ¥å¼ºåˆ¶æ‹¿key_endä½†æ˜¯åœ¨å‰é¢insertçš„æ—¶å€™key_endæ˜¯å¯æœ‰å¯æ— çš„ï¼Œå¦‚æœæ²¡æœ‰çš„è¯key_endä¼šç›´æ¥ç­‰äºkey</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">pipapo_match_field</span><span class="params">(struct nft_pipapo_field *f,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">int</span> first_rule, <span class="keyword">int</span> rule_count,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">const</span> u8 *start, <span class="keyword">const</span> u8 *end)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 right[NFT_PIPAPO_MAX_BYTES] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	u8 left[NFT_PIPAPO_MAX_BYTES] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	pipapo_get_boundaries(f, first_rule, rule_count, left, right);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> !<span class="built_in">memcmp</span>(start, left,</span><br><span class="line">		       f-&gt;groups / NFT_PIPAPO_GROUPS_PER_BYTE(f)) &amp;&amp;</span><br><span class="line">	       !<span class="built_in">memcmp</span>(end, right, f-&gt;groups / NFT_PIPAPO_GROUPS_PER_BYTE(f));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ˜¯æ°¸è¿œä¸ä¼šè¿”å›trueä¹Ÿå°±æ˜¯ä¼šç›´æ¥breakï¼Œæ— æ³•å°†ç›®æ ‡elementç»™ä¸¢å¼ƒæ‰ï¼Œä¹Ÿå°±ä¼šé€ æˆUAFï¼</p>
<h3 id="commit-releaseè¯¦ç»†åˆ†æ"><a href="#commit-releaseè¯¦ç»†åˆ†æ" class="headerlink" title="commit_releaseè¯¦ç»†åˆ†æ"></a>commit_releaseè¯¦ç»†åˆ†æ</h3><p>å¯ä»¥çœ‹åˆ°åœ¨å‰é¢ä¼šåˆ›å»ºtransé€å…¥åˆ°commitä¸­å»ï¼Œå¹¶ä¸”æœ€åä¼šè°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nft_trans_commit_list_add_tail(ctx-&gt;net, trans);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_trans_commit_list_add_tail</span><span class="params">(struct net *net, struct nft_trans *trans)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftables_pernet</span> *<span class="title">nft_net</span> =</span> nft_pernet(net);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (trans-&gt;msg_type) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWSET:</span><br><span class="line">		<span class="keyword">if</span> (!nft_trans_set_update(trans) &amp;&amp;</span><br><span class="line">		    nft_set_is_anonymous(nft_trans_set(trans)))</span><br><span class="line">			list_add_tail(&amp;trans-&gt;binding_list, &amp;nft_net-&gt;binding_list);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWCHAIN:</span><br><span class="line">		<span class="keyword">if</span> (!nft_trans_chain_update(trans) &amp;&amp;</span><br><span class="line">		    nft_chain_binding(nft_trans_chain(trans)))</span><br><span class="line">			list_add_tail(&amp;trans-&gt;binding_list, &amp;nft_net-&gt;binding_list);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	list_add_tail(&amp;trans-&gt;<span class="built_in">list</span>, &amp;nft_net-&gt;commit_list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¼šå°†transæ·»åŠ åˆ°<code>&amp;nft_net-&gt;commit_list</code>åŒå‘é“¾è¡¨ä¸­å»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nft_set_commit_update(&amp;set_update_list);</span><br><span class="line"></span><br><span class="line">nft_commit_notify(net, NETLINK_CB(skb).portid);</span><br><span class="line">nf_tables_gen_notify(net, skb, NFT_MSG_NEWGEN);</span><br><span class="line">nf_tables_commit_audit_log(&amp;adl, nft_net-&gt;base_seq);</span><br><span class="line">nf_tables_commit_release(net);</span><br></pre></td></tr></table></figure>

<p>ä¸­é—´å‡ ä¸ªå‡½æ•°æš‚æ—¶æ²¡æœ‰é‡åˆ°ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰è¯¦ç»†åˆ†æä»–ä»¬çš„å«ä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦çœ‹ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªï¼Œè¿™æ®µä»£ç æ˜¯<code>nf_tables_commit</code>å‡½æ•°æœ€åçš„å‡ è¡Œä»£ç ï¼Œç¬¬ä¸€å‡½æ•°æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œåœ¨å‰é¢ä¹Ÿæ˜¯åˆ†æè¿‡äº†å…¶å†…éƒ¨ä¼šè°ƒç”¨<code>set-&gt;ops-&gt;commit</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nf_tables_commit_release</span><span class="params">(struct net *net)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftables_pernet</span> *<span class="title">nft_net</span> =</span> nft_pernet(net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* all side effects have to be made visible.</span></span><br><span class="line"><span class="comment">	 * For example, if a chain named &#x27;foo&#x27; has been deleted, a</span></span><br><span class="line"><span class="comment">	 * new transaction must not find it anymore.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Memory reclaim happens asynchronously from work queue</span></span><br><span class="line"><span class="comment">	 * to prevent expensive synchronize_rcu() in commit phase.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (list_empty(&amp;nft_net-&gt;commit_list)) &#123;</span><br><span class="line">		nf_tables_module_autoload_cleanup(net);</span><br><span class="line">		mutex_unlock(&amp;nft_net-&gt;commit_mutex);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	trans = list_last_entry(&amp;nft_net-&gt;commit_list,</span><br><span class="line">				struct nft_trans, <span class="built_in">list</span>);</span><br><span class="line">	get_net(trans-&gt;ctx.net);</span><br><span class="line">	WARN_ON_ONCE(trans-&gt;put_net);</span><br><span class="line"></span><br><span class="line">	trans-&gt;put_net = <span class="literal">true</span>;</span><br><span class="line">	spin_lock(&amp;nf_tables_destroy_list_lock);</span><br><span class="line">	list_splice_tail_init(&amp;nft_net-&gt;commit_list, &amp;nf_tables_destroy_list);</span><br><span class="line">	spin_unlock(&amp;nf_tables_destroy_list_lock);</span><br><span class="line"></span><br><span class="line">	nf_tables_module_autoload_cleanup(net);</span><br><span class="line">	schedule_work(&amp;trans_destroy_work);</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;nft_net-&gt;commit_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé‡ç‚¹å…³æ³¨æœ€åä¸€è¡Œä»£ç è°ƒç”¨çš„å‡½æ•°å³<code>nf_tables_commit_release</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°å°¾éƒ¨é€šè¿‡<code>list_splice_tail_init</code>å‡½æ•°å°†<code>&amp;nft_net-&gt;commit_list</code>æ·»åŠ è‡³<code>&amp;nf_tables_destroy_list</code>ä¸­å»äº†ã€‚</p>
<p>æœ€åæ³¨æ„æœ€åè¿™é‡Œä¼šè°ƒç”¨<code>schedule_work</code>å‡½æ•°å°†<code>trans_destroy_work</code>æäº¤è‡³ä»»åŠ¡é˜Ÿåˆ—ä¸­å»</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nf_tables_trans_destroy_work</span><span class="params">(struct work_struct *w)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">DECLARE_WORK</span><span class="params">(trans_destroy_work, nf_tables_trans_destroy_work)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nf_tables_trans_destroy_work</span><span class="params">(struct work_struct *w)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>, *<span class="title">next</span>;</span></span><br><span class="line">	LIST_HEAD(head);</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;nf_tables_destroy_list_lock);</span><br><span class="line">	list_splice_init(&amp;nf_tables_destroy_list, &amp;head);</span><br><span class="line">	spin_unlock(&amp;nf_tables_destroy_list_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (list_empty(&amp;head))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	synchronize_rcu();</span><br><span class="line"></span><br><span class="line">	list_for_each_entry_safe(trans, next, &amp;head, <span class="built_in">list</span>) &#123;</span><br><span class="line">		nft_trans_list_del(trans);</span><br><span class="line">		nft_commit_release(trans);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨å…¶å†…éƒ¨åˆ™æ˜¯å°†<code>&amp;nf_tables_destroy_list</code>èµ‹å€¼ç»™äº†headå¹¶åœ¨åé¢å¾ªç¯è°ƒç”¨äº†<code>nft_commit_release</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_commit_release</span><span class="params">(struct nft_trans *trans)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (trans-&gt;msg_type) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_DELTABLE:</span><br><span class="line">		nf_tables_table_destroy(&amp;trans-&gt;ctx);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWCHAIN:</span><br><span class="line">		free_percpu(nft_trans_chain_stats(trans));</span><br><span class="line">		kfree(nft_trans_chain_name(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_DELCHAIN:</span><br><span class="line">		nf_tables_chain_destroy(&amp;trans-&gt;ctx);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_DELRULE:</span><br><span class="line">		nf_tables_rule_destroy(&amp;trans-&gt;ctx, nft_trans_rule(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_DELSET:</span><br><span class="line">		nft_set_destroy(&amp;trans-&gt;ctx, nft_trans_set(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_DELSETELEM:</span><br><span class="line">		nf_tables_set_elem_destroy(&amp;trans-&gt;ctx,</span><br><span class="line">					   nft_trans_elem_set(trans),</span><br><span class="line">					   nft_trans_elem(trans).priv);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_DELOBJ:</span><br><span class="line">		nft_obj_destroy(&amp;trans-&gt;ctx, nft_trans_obj(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_DELFLOWTABLE:</span><br><span class="line">		<span class="keyword">if</span> (nft_trans_flowtable_update(trans))</span><br><span class="line">			nft_flowtable_hooks_destroy(&amp;nft_trans_flowtable_hooks(trans));</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			nf_tables_flowtable_destroy(nft_trans_flowtable(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (trans-&gt;put_net)</span><br><span class="line">		put_net(trans-&gt;ctx.net);</span><br><span class="line"></span><br><span class="line">	kfree(trans);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°±æ˜¯çœŸæ­£å¤„ç†deleteçš„ä½ç½®äº†ï¼Œè¿™é‡Œä»¥setelemä¸ºä¾‹ï¼Œä¼šè°ƒç”¨<code>nf_tables_set_elem_destroy</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_tables_set_elem_destroy</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>, <span class="keyword">void</span> *elem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ext</span> *<span class="title">ext</span> =</span> nft_set_elem_ext(<span class="built_in">set</span>, elem);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_set_ext_exists(ext, NFT_SET_EXT_EXPRESSIONS))</span><br><span class="line">		nft_set_elem_expr_destroy(ctx, nft_set_ext_expr(ext));</span><br><span class="line"></span><br><span class="line">	kfree(elem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆåœ¨è¿™é‡Œè°ƒç”¨äº†<code>kfree(elem)</code>ã€‚</p>
<h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºelementçš„å¤§å°æ˜¯ç”¨æˆ·æ€å¯æ§çš„ï¼Œæ‰€ä»¥åœ¨æœ‰UAFçš„åŠ æŒä¸‹å¯ä»¥å¾ˆè½»æ¾çš„è¿›è¡Œåˆ©ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_object</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rhlist_head</span>		<span class="title">rhlhead</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_object_hash_key</span>	<span class="title">key</span>;</span></span><br><span class="line">	u32				genmask:<span class="number">2</span>,</span><br><span class="line">					use:<span class="number">30</span>;</span><br><span class="line">	u64				handle;</span><br><span class="line">	u16				udlen;</span><br><span class="line">	u8				*udata;</span><br><span class="line">	<span class="comment">/* runtime data below here */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_object_ops</span>	*<span class="title">ops</span> ____<span class="title">cacheline_aligned</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>			data[]</span><br><span class="line">		__attribute__((aligned(__alignof__(u64))));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åŸä½œè€…æ˜¯åˆ©ç”¨UAFç„¶åä½¿ç”¨å †å–·tableæ¥å æ®ä½ç½®å¹¶è½¬åŒ–ä¸ºtableçš„UAFæ¥ç€ä½¿ç”¨objæ¥å ç”¨ä½ç½®ï¼Œé€šè¿‡<code>get_table</code>æ¥æ³„éœ²å‡ºobjä¸­çš„opsï¼Œæœ€åä¿®æ”¹opsæ¥åŠ«æŒripï¼Œæœ€åä½¿ç”¨ropææƒã€‚</p>
<h2 id="CVE-2023-4015"><a href="#CVE-2023-4015" class="headerlink" title="CVE-2023-4015"></a>CVE-2023-4015</h2><h3 id="å‰ç½®çŸ¥è¯†-1"><a href="#å‰ç½®çŸ¥è¯†-1" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><p>æ²¡é”™ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªéœ€è¦ä¸€ç‚¹ç‚¹å‰ç½®çŸ¥è¯†æ‰èƒ½å®Œå…¨ææ¸…æ¥šçš„æ¼æ´ã€‚TvT</p>
<p>åœ¨ä¸Šé¢é‚£ä¸ªcveçš„æ—¶å€™å¯èƒ½æœ‰äººä¼šæœ‰ç–‘æƒ‘commitåˆ°åº•æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨çš„å‘¢ï¼Ÿ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nfnetlink_rcv_batch</span><span class="params">(struct sk_buff *skb, struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">				u16 subsys_id, u32 genid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">oskb</span> =</span> skb;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> sock_net(skb-&gt;sk);</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnetlink_subsystem</span> *<span class="title">ss</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnl_callback</span> *<span class="title">nc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> <span class="title">extack</span>;</span></span><br><span class="line">	LIST_HEAD(err_list);</span><br><span class="line">	u32 status;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">int</span> min_len = nlmsg_total_size(<span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">nfnl_net</span> *<span class="title">nfnlnet</span> =</span> nfnl_pernet(net);</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">cda</span>[<span class="title">NFNL_MAX_ATTR_COUNT</span> + 1];</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span> =</span> (<span class="keyword">void</span> *)nlh + min_len;</span><br><span class="line">			u8 cb_id = NFNL_MSG_TYPE(nlh-&gt;nlmsg_type);</span><br><span class="line">			<span class="keyword">int</span> attrlen = nlh-&gt;nlmsg_len - min_len;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">nfnl_info</span> <span class="title">info</span> =</span> &#123;</span><br><span class="line">				.net	= net,</span><br><span class="line">				.sk	= nfnlnet-&gt;nfnl,</span><br><span class="line">				.nlh	= nlh,</span><br><span class="line">				.nfmsg	= nlmsg_data(nlh),</span><br><span class="line">				.extack	= &amp;extack,</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Sanity-check NFTA_MAX_ATTR */</span></span><br><span class="line">			<span class="keyword">if</span> (ss-&gt;cb[cb_id].attr_count &gt; NFNL_MAX_ATTR_COUNT) &#123;</span><br><span class="line">				err = -ENOMEM;</span><br><span class="line">				<span class="keyword">goto</span> ack;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			err = nla_parse_deprecated(cda,</span><br><span class="line">						   ss-&gt;cb[cb_id].attr_count,</span><br><span class="line">						   attr, attrlen,</span><br><span class="line">						   ss-&gt;cb[cb_id].policy, <span class="literal">NULL</span>);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">goto</span> ack;</span><br><span class="line"></span><br><span class="line">			err = nc-&gt;call(skb, &amp;info, (<span class="keyword">const</span> struct nlattr **)cda);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* The lock was released to autoload some module, we</span></span><br><span class="line"><span class="comment">			 * have to abort and start from scratch using the</span></span><br><span class="line"><span class="comment">			 * original skb.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">				status |= NFNL_BATCH_REPLAY;</span><br><span class="line">				<span class="keyword">goto</span> done;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">ack:</span><br><span class="line">		<span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_ACK || err) &#123;</span><br><span class="line">			<span class="comment">/* Errors are delivered once the full batch has been</span></span><br><span class="line"><span class="comment">			 * processed, this avoids that the same error is</span></span><br><span class="line"><span class="comment">			 * reported several times when replaying the batch.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (err == -ENOMEM ||</span><br><span class="line">			    nfnl_err_add(&amp;err_list, nlh, err, &amp;extack) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">/* We failed to enqueue an error, reset the</span></span><br><span class="line"><span class="comment">				 * list of errors and send OOM to userspace</span></span><br><span class="line"><span class="comment">				 * pointing to the batch header.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				nfnl_err_reset(&amp;err_list);</span><br><span class="line">				netlink_ack(oskb, nlmsg_hdr(oskb), -ENOMEM,</span><br><span class="line">					    <span class="literal">NULL</span>);</span><br><span class="line">				status |= NFNL_BATCH_FAILURE;</span><br><span class="line">				<span class="keyword">goto</span> done;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/* We don&#x27;t stop processing the batch on errors, thus,</span></span><br><span class="line"><span class="comment">			 * userspace gets all the errors that the batch</span></span><br><span class="line"><span class="comment">			 * triggers.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (err)</span><br><span class="line">				status |= NFNL_BATCH_FAILURE;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		msglen = NLMSG_ALIGN(nlh-&gt;nlmsg_len);</span><br><span class="line">		<span class="keyword">if</span> (msglen &gt; skb-&gt;len)</span><br><span class="line">			msglen = skb-&gt;len;</span><br><span class="line">		skb_pull(skb, msglen);</span><br><span class="line">	&#125;</span><br><span class="line">done:</span><br><span class="line">	<span class="keyword">if</span> (status &amp; NFNL_BATCH_REPLAY) &#123;</span><br><span class="line">		ss-&gt;<span class="built_in">abort</span>(net, oskb, NFNL_ABORT_AUTOLOAD);</span><br><span class="line">		nfnl_err_reset(&amp;err_list);</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">		module_put(ss-&gt;owner);</span><br><span class="line">		<span class="keyword">goto</span> replay;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == NFNL_BATCH_DONE) &#123;</span><br><span class="line">		err = ss-&gt;commit(net, oskb);</span><br><span class="line">		<span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">			status |= NFNL_BATCH_REPLAY;</span><br><span class="line">			<span class="keyword">goto</span> done;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (err) &#123;</span><br><span class="line">			ss-&gt;<span class="built_in">abort</span>(net, oskb, NFNL_ABORT_NONE);</span><br><span class="line">			netlink_ack(oskb, nlmsg_hdr(oskb), err, <span class="literal">NULL</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">enum</span> nfnl_abort_action abort_action;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (status &amp; NFNL_BATCH_FAILURE)</span><br><span class="line">			abort_action = NFNL_ABORT_NONE;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			abort_action = NFNL_ABORT_VALIDATE;</span><br><span class="line"></span><br><span class="line">		err = ss-&gt;<span class="built_in">abort</span>(net, oskb, abort_action);</span><br><span class="line">		<span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">			nfnl_err_reset(&amp;err_list);</span><br><span class="line">			kfree_skb(skb);</span><br><span class="line">			module_put(ss-&gt;owner);</span><br><span class="line">			status |= NFNL_BATCH_FAILURE;</span><br><span class="line">			<span class="keyword">goto</span> replay_abort;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nfnl_err_deliver(&amp;err_list, oskb);</span><br><span class="line">	kfree_skb(skb);</span><br><span class="line">	module_put(ss-&gt;owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°åœ¨<a href="https://196082.github.io/2024/08/17/nftables/">nftableså­ç³»ç»Ÿæµ…åˆ†æ</a>å¤§æ¦‚ä»‹ç»è¿‡ï¼Œä¸è¿‡åœ¨é‚£ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»çš„æ˜¯å¦‚ä½•æ‰¾åˆ°å¯¹åº”çš„å­ç³»ç»Ÿçš„è¿‡ç¨‹ï¼Œä¸‹é¢çš„å†…å®¹æ˜¯æ²¡æ€ä¹ˆä»‹ç»ã€‚å¯ä»¥çœ‹åˆ°doneåˆ†æ”¯ä¸­å½“statusä¸º<code>NFNL_BATCH_DONE</code>æ—¶å°±ä¼šè°ƒç”¨commitäº†ï¼Œå¦‚æœcommitå‘ç”Ÿé”™è¯¯å°±ä¼šè°ƒç”¨abortï¼Œæˆ–è€…æ˜¯statusä¸ä»…ä¸º<code>NFNL_BATCH_DONE</code>åˆ™ä¼šè¿›å…¥elseåˆ†æ”¯è°ƒç”¨abortã€‚</p>
<h3 id="å¸¸è§ç»“æ„ä½“"><a href="#å¸¸è§ç»“æ„ä½“" class="headerlink" title="å¸¸è§ç»“æ„ä½“"></a>å¸¸è§ç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	struct nft_table - nf_tables table</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *	@list: used internally</span></span><br><span class="line"><span class="comment"> *	@chains_ht: chains in the table</span></span><br><span class="line"><span class="comment"> *	@chains: same, for stable walks</span></span><br><span class="line"><span class="comment"> *	@sets: sets in the table</span></span><br><span class="line"><span class="comment"> *	@objects: stateful objects in the table</span></span><br><span class="line"><span class="comment"> *	@flowtables: flow tables in the table</span></span><br><span class="line"><span class="comment"> *	@hgenerator: handle generator state</span></span><br><span class="line"><span class="comment"> *	@handle: table handle</span></span><br><span class="line"><span class="comment"> *	@use: number of chain references to this table</span></span><br><span class="line"><span class="comment"> *	@flags: table flag (see enum nft_table_flags)</span></span><br><span class="line"><span class="comment"> *	@genmask: generation mask</span></span><br><span class="line"><span class="comment"> *	@afinfo: address family info</span></span><br><span class="line"><span class="comment"> *	@name: name of the table</span></span><br><span class="line"><span class="comment"> *	@validate_state: internal, set when transaction adds jumps</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rhltable</span>			<span class="title">chains_ht</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">chains</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">sets</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">objects</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">flowtables</span>;</span></span><br><span class="line">	u64				hgenerator;</span><br><span class="line">	u64				handle;</span><br><span class="line">	u32				use;</span><br><span class="line">	u16				family:<span class="number">6</span>,</span><br><span class="line">					flags:<span class="number">8</span>,</span><br><span class="line">					genmask:<span class="number">2</span>;</span><br><span class="line">	u32				nlpid;</span><br><span class="line">	<span class="keyword">char</span>				*name;</span><br><span class="line">	u16				udlen;</span><br><span class="line">	u8				*udata;</span><br><span class="line">	u8				validate_state;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šæ˜¯<code>nft_table</code>ç»“æ„ä½“ï¼Œè¿™é‡Œå…³æ³¨å…¶useæˆå‘˜ï¼Œå…¶å«ä¹‰ä¸ºæœ‰å¤šå°‘chainå¼•ç”¨æ­¤tableã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	struct nft_chain - nf_tables chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *	@rules: list of rules in the chain</span></span><br><span class="line"><span class="comment"> *	@list: used internally</span></span><br><span class="line"><span class="comment"> *	@rhlhead: used internally</span></span><br><span class="line"><span class="comment"> *	@table: table that this chain belongs to</span></span><br><span class="line"><span class="comment"> *	@handle: chain handle</span></span><br><span class="line"><span class="comment"> *	@use: number of jump references to this chain</span></span><br><span class="line"><span class="comment"> *	@flags: bitmask of enum nft_chain_flags</span></span><br><span class="line"><span class="comment"> *	@name: name of the chain</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span>		__<span class="title">rcu</span> *<span class="title">blob_gen_0</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span>		__<span class="title">rcu</span> *<span class="title">blob_gen_1</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">rules</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rhlist_head</span>		<span class="title">rhlhead</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span>		*<span class="title">table</span>;</span></span><br><span class="line">	u64				handle;</span><br><span class="line">	u32				use;</span><br><span class="line">	u8				flags:<span class="number">5</span>,</span><br><span class="line">					bound:<span class="number">1</span>,</span><br><span class="line">					genmask:<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">char</span>				*name;</span><br><span class="line">	u16				udlen;</span><br><span class="line">	u8				*udata;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Only used during control plane commit phase: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span>		*<span class="title">blob_next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>nft_chain</code>ç»“æ„ä½“ä¸­çš„useæˆå‘˜çš„å«ä¹‰ä¸ºæœ‰å¤šå°‘æ¡è½¬åˆ°äº†æ­¤chainã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_addchain</span><span class="params">(struct nft_ctx *ctx, u8 family, u8 genmask,</span></span></span><br><span class="line"><span class="params"><span class="function">			      u8 policy, u32 flags,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> * <span class="title">const</span> *<span class="title">nla</span> =</span> ctx-&gt;nla;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span> =</span> ctx-&gt;table;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_base_chain</span> *<span class="title">basechain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> ctx-&gt;net;</span><br><span class="line">	<span class="keyword">char</span> name[NFT_NAME_MAXLEN];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span> *<span class="title">blob</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// .......</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nft_use_inc(&amp;table-&gt;use)) &#123;</span><br><span class="line">		err = -EMFILE;</span><br><span class="line">		<span class="keyword">goto</span> err_use;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä¸ºchainçš„æ·»åŠ å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°æ¯æ·»åŠ ä¸€ä¸ªchainå°±ä¼šå¢åŠ ä¸€æ¬¡tableçš„useæˆå‘˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newrule</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct nfnl_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftables_pernet</span> *<span class="title">nft_net</span> =</span> nft_pernet(info-&gt;net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> *<span class="title">extack</span> =</span> info-&gt;extack;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size, i, n, ulen = <span class="number">0</span>, usize = <span class="number">0</span>;</span><br><span class="line">	u8 genmask = nft_genmask_next(info-&gt;net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule</span> *<span class="title">rule</span>, *<span class="title">old_rule</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_info</span> *<span class="title">expr_info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	u8 family = info-&gt;nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_flow_rule</span> *<span class="title">flow</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> info-&gt;net;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_userdata</span> *<span class="title">udata</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	u64 handle, pos_handle;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tmp</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err, rem;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">	err = -ENOMEM;</span><br><span class="line">	rule = kzalloc(<span class="keyword">sizeof</span>(*rule) + size + usize, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (rule == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_release_expr;</span><br><span class="line"></span><br><span class="line">	nft_activate_next(net, rule);</span><br><span class="line"></span><br><span class="line">	rule-&gt;handle = handle;</span><br><span class="line">	rule-&gt;dlen   = size;</span><br><span class="line">	rule-&gt;udata  = ulen ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ulen) &#123;</span><br><span class="line">		udata = nft_userdata(rule);</span><br><span class="line">		udata-&gt;len = ulen - <span class="number">1</span>;</span><br><span class="line">		nla_memcpy(udata-&gt;data, nla[NFTA_RULE_USERDATA], ulen);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	expr = nft_expr_first(rule);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		err = nf_tables_newexpr(&amp;ctx, &amp;expr_info[i], expr);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			NL_SET_BAD_ATTR(extack, expr_info[i].attr);</span><br><span class="line">			<span class="keyword">goto</span> err_release_rule;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (expr_info[i].ops-&gt;validate)</span><br><span class="line">			nft_validate_state_update(table, NFT_VALIDATE_NEED);</span><br><span class="line"></span><br><span class="line">		expr_info[i].ops = <span class="literal">NULL</span>;</span><br><span class="line">		expr = nft_expr_next(expr);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chain-&gt;flags &amp; NFT_CHAIN_HW_OFFLOAD) &#123;</span><br><span class="line">		flow = nft_flow_rule_create(net, rule);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(flow)) &#123;</span><br><span class="line">			err = PTR_ERR(flow);</span><br><span class="line">			<span class="keyword">goto</span> err_release_rule;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nft_use_inc(&amp;chain-&gt;use)) &#123;</span><br><span class="line">		err = -EMFILE;</span><br><span class="line">		<span class="keyword">goto</span> err_release_rule;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// .......</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_destroy_flow_rule:</span><br><span class="line">	nft_use_dec_restore(&amp;chain-&gt;use);</span><br><span class="line">	<span class="keyword">if</span> (flow)</span><br><span class="line">		nft_flow_rule_destroy(flow);</span><br><span class="line">err_release_rule:</span><br><span class="line">	nft_rule_expr_deactivate(&amp;ctx, rule, NFT_TRANS_PREPARE_ERROR);</span><br><span class="line">	nf_tables_rule_destroy(&amp;ctx, rule);</span><br><span class="line">err_release_expr:</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (expr_info[i].ops) &#123;</span><br><span class="line">			module_put(expr_info[i].ops-&gt;type-&gt;owner);</span><br><span class="line">			<span class="keyword">if</span> (expr_info[i].ops-&gt;type-&gt;release_ops)</span><br><span class="line">				expr_info[i].ops-&gt;type-&gt;release_ops(expr_info[i].ops);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	kvfree(expr_info);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä¸ºruleçš„ç”³è¯·å‡½æ•°å¯ä»¥çœ‹åˆ°è™½ç„¶åœ¨å†…æ ¸æ³¨é‡Šä¸­å†™çš„useæˆå‘˜çš„å«ä¹‰ä¸ºè·³è½¬åˆ°æ­¤chainçš„ä¸ªæ•°ä½†æ˜¯å®é™…ç”³è¯·ä¸€ä¸ªruleä¹Ÿä¼šå¯¹useè¿›è¡ŒåŠ ä¸€æ“ä½œã€‚</p>
<p>è¿™é‡Œå†å…³æ³¨ä¸€ä¸‹æ³¨é‡Šæ‰€å†™çš„è·³è½¬å§ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_immediate_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nft_expr *expr,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_immediate_expr</span> *<span class="title">priv</span> =</span> nft_expr_priv(expr);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_data_desc</span> <span class="title">desc</span> =</span> &#123;</span><br><span class="line">		.size	= <span class="keyword">sizeof</span>(priv-&gt;data),</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tb[NFTA_IMMEDIATE_DREG] == <span class="literal">NULL</span> ||</span><br><span class="line">	    tb[NFTA_IMMEDIATE_DATA] == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	desc.type = nft_reg_to_type(tb[NFTA_IMMEDIATE_DREG]);</span><br><span class="line">	err = nft_data_init(ctx, &amp;priv-&gt;data, &amp;desc, tb[NFTA_IMMEDIATE_DATA]);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	priv-&gt;dlen = desc.len;</span><br><span class="line"></span><br><span class="line">	err = nft_parse_register_store(ctx, tb[NFTA_IMMEDIATE_DREG],</span><br><span class="line">				       &amp;priv-&gt;dreg, &amp;priv-&gt;data, desc.type,</span><br><span class="line">				       desc.len);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err1;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (priv-&gt;dreg == NFT_REG_VERDICT) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span> =</span> priv-&gt;data.verdict.chain;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (priv-&gt;data.verdict.code) &#123;</span><br><span class="line">		<span class="keyword">case</span> NFT_JUMP:</span><br><span class="line">		<span class="keyword">case</span> NFT_GOTO:</span><br><span class="line">			err = nf_tables_bind_chain(ctx, chain);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> err;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err1:</span><br><span class="line">	nft_data_release(&amp;priv-&gt;data, desc.type);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç æ˜¯immediateç±»å‹çš„exprçš„åˆå§‹åŒ–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nft_data_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, struct nft_data *data,</span></span></span><br><span class="line"><span class="params"><span class="function">		  struct nft_data_desc *desc, <span class="keyword">const</span> struct nlattr *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">NFTA_DATA_MAX</span> + 1];</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON_ONCE(!desc-&gt;size))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(tb, NFTA_DATA_MAX, nla,</span><br><span class="line">					  nft_data_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tb[NFTA_DATA_VALUE]) &#123;</span><br><span class="line">		<span class="keyword">if</span> (desc-&gt;type != NFT_DATA_VALUE)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		err = nft_value_init(ctx, data, desc, tb[NFTA_DATA_VALUE]);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (tb[NFTA_DATA_VERDICT] &amp;&amp; ctx != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (desc-&gt;type != NFT_DATA_VERDICT)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		err = nft_verdict_init(ctx, data, desc, tb[NFTA_DATA_VERDICT]);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(nft_data_init);</span><br></pre></td></tr></table></figure>

<p>éšåè°ƒç”¨<code>nft_data_init</code>å‡½æ•°å¯¹exprçš„dataæ®µåšåˆå§‹åŒ–ï¼Œå› ä¸ºè¿™é‡Œæ˜¯åšè·³è½¬æ“ä½œæ‰€ä»¥tbçš„ç´¢å¼•ä¸º<code>NFTA_DATA_VERDICT</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_verdict_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, struct nft_data *data,</span></span></span><br><span class="line"><span class="params"><span class="function">			    struct nft_data_desc *desc, <span class="keyword">const</span> struct nlattr *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 genmask = nft_genmask_next(ctx-&gt;net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">NFTA_VERDICT_MAX</span> + 1];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = nla_parse_nested_deprecated(tb, NFTA_VERDICT_MAX, nla,</span><br><span class="line">					  nft_verdict_policy, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!tb[NFTA_VERDICT_CODE])</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* zero padding hole for memcmp */</span></span><br><span class="line">	<span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="keyword">sizeof</span>(*data));</span><br><span class="line">	data-&gt;verdict.code = ntohl(nla_get_be32(tb[NFTA_VERDICT_CODE]));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (data-&gt;verdict.code) &#123;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">switch</span> (data-&gt;verdict.code &amp; NF_VERDICT_MASK) &#123;</span><br><span class="line">		<span class="keyword">case</span> NF_ACCEPT:</span><br><span class="line">		<span class="keyword">case</span> NF_DROP:</span><br><span class="line">		<span class="keyword">case</span> NF_QUEUE:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		fallthrough;</span><br><span class="line">	<span class="keyword">case</span> NFT_CONTINUE:</span><br><span class="line">	<span class="keyword">case</span> NFT_BREAK:</span><br><span class="line">	<span class="keyword">case</span> NFT_RETURN:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_JUMP:</span><br><span class="line">	<span class="keyword">case</span> NFT_GOTO:</span><br><span class="line">		<span class="keyword">if</span> (tb[NFTA_VERDICT_CHAIN]) &#123;</span><br><span class="line">			chain = nft_chain_lookup(ctx-&gt;net, ctx-&gt;table,</span><br><span class="line">						 tb[NFTA_VERDICT_CHAIN],</span><br><span class="line">						 genmask);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (tb[NFTA_VERDICT_CHAIN_ID]) &#123;</span><br><span class="line">			chain = nft_chain_lookup_byid(ctx-&gt;net, ctx-&gt;table,</span><br><span class="line">						      tb[NFTA_VERDICT_CHAIN_ID],</span><br><span class="line">						      genmask);</span><br><span class="line">			<span class="keyword">if</span> (IS_ERR(chain))</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(chain))</span><br><span class="line">			<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">		<span class="keyword">if</span> (nft_is_base_chain(chain))</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">		<span class="keyword">if</span> (nft_chain_is_bound(chain))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (desc-&gt;flags &amp; NFT_DATA_DESC_SETELEM &amp;&amp;</span><br><span class="line">		    chain-&gt;flags &amp; NFT_CHAIN_BINDING)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (!nft_use_inc(&amp;chain-&gt;use))</span><br><span class="line">			<span class="keyword">return</span> -EMFILE;</span><br><span class="line"></span><br><span class="line">		data-&gt;verdict.chain = chain;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	desc-&gt;len = <span class="keyword">sizeof</span>(data-&gt;verdict);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆæ˜¯è§£æcodeï¼Œè¿™é‡Œå°±æ˜¯jumpæˆ–gotoï¼Œéšåä¼šé€šè¿‡chainçš„idæˆ–è€…åå­—æ‰¾åˆ°å¯¹åº”çš„chainï¼Œéšååˆ¤æ–­chainæ˜¯å¦ä¸ºbase chainï¼Œchainæ˜¯å¦ä¸ºbindingå¹¶ä¸”å·²ç»boundäº†ï¼Œç„¶ååˆå¯¹descåšåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ ‡å¿—ä½<code>NFT_DATA_DESC_SETELEM</code>ï¼Œæœ€åå¯¹ç›®æ ‡chainçš„useæˆå‘˜åŠ ä¸€æ“ä½œï¼Œå¹¶ä¸”å°†ç›®æ ‡chainæ”¾åˆ°<code>expr-&gt;data-&gt;verdict.chain</code>ä¸­å»ã€‚</p>
<p>å›åˆ°<code>nft_immediate_init</code>å‡½æ•°ï¼Œä¼šè°ƒç”¨<code>nft_parse_register_store</code>å‡½æ•°ï¼Œè¿™é‡Œåªéœ€è¦è®¾ç½®<code>NFTA_IMMEDIATE_DREG</code>ä¸º<code>NFT_REG_VERDICT</code>å³å¯è¿›å…¥åˆ°åç»­ifåˆ†æ”¯ï¼Œå¹¶ä¸”åœ¨<code>nft_parse_register_store</code>åªä¼šå¯¹gotoæˆ–jumpæ˜¯å¦æ„æˆæ­»å¾ªç¯åšåˆ¤æ–­ã€‚</p>
<p>ç»§ç»­çœ‹<code>nft_immediate_init</code>å‡½æ•°ï¼Œåœ¨è¿›å…¥åˆ°æœ€åçš„ifåˆ†æ”¯ä¸­åå›å…ˆæ‹¿åˆ°ç›®æ ‡chainï¼Œç„¶åå¦‚æœæ˜¯gotoæˆ–æ˜¯jumpåˆ™ä¼šè¿›å…¥<code>nf_tables_bind_chain</code>å¯¹chainè¿›è¡Œç»‘å®šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_tables_bind_chain</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, struct nft_chain *chain)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!nft_chain_binding(chain))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_chain_binding(ctx-&gt;chain))</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chain-&gt;bound)</span><br><span class="line">		<span class="keyword">return</span> -EBUSY;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nft_use_inc(&amp;chain-&gt;use))</span><br><span class="line">		<span class="keyword">return</span> -EMFILE;</span><br><span class="line"></span><br><span class="line">	chain-&gt;bound = <span class="literal">true</span>;</span><br><span class="line">	nft_chain_trans_bind(ctx, chain);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿™é‡Œå¦‚æœæ˜¯ç›®æ ‡chainä¸å¸¦æœ‰bindingæ ‡å¿—ä½åˆ™ç›´æ¥é€€å‡ºï¼Œæ¥ç€å¦‚æœå½“å‰chainå¸¦æœ‰bindingä¹Ÿä¼šç›´æ¥é€€å‡ºï¼Œéšåå°±æ˜¯æ£€æŸ¥ç›®æ ‡chainæ˜¯å¦å·²ç»ç»‘å®šï¼Œéšåå¯¹ç›®æ ‡chainçš„useæˆå‘˜åŠ ä¸€æ“ä½œå¹¶ä¸”å°†å…¶æ ‡è®°ä¸ºå·²ç»‘å®šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">chain1-&gt;flags no NFT_CHAIN_BINDING;</span><br><span class="line">chain2-&gt;flags = NFT_CHAIN_BINDING;</span><br><span class="line"></span><br><span class="line">å½“ chain1 =&gt; chain2 æ—¶ï¼š</span><br><span class="line">  chain1-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;use = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">chain1-&gt;flags = NFT_CHAIN_BINDING;</span><br><span class="line">chain2-&gt;flags no NFT_CHAIN_BINDING;</span><br><span class="line"></span><br><span class="line">å½“ chain1 =&gt; chain2 æ—¶ï¼š</span><br><span class="line">  chain1-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;use = <span class="number">1</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">chain1-&gt;flags no NFT_CHAIN_BINDING;</span><br><span class="line">chain2-&gt;flags no NFT_CHAIN_BINDING;</span><br><span class="line"></span><br><span class="line">å½“ chain1 =&gt; chain2 æ—¶ï¼š</span><br><span class="line">  chain1-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;use = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šè¿°åˆ†æå¯ä»¥çœ‹åˆ°å¦‚æœè®©chain1å»å¼•ç”¨chain2åˆ™ä¼šå¼•èµ·ä¸Šè¿°æ•ˆæœã€‚</p>
<h3 id="nft-rule-expr-deactivate"><a href="#nft-rule-expr-deactivate" class="headerlink" title="nft_rule_expr_deactivate"></a>nft_rule_expr_deactivate</h3><p>åœ¨åˆ é™¤ä¸€ä¸ªruleæ—¶æœ€ç»ˆä¼šè°ƒç”¨<code>nft_rule_expr_deactivate</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nft_rule_expr_deactivate</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, struct nft_rule *rule,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">enum</span> nft_trans_phase phase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>;</span></span><br><span class="line"></span><br><span class="line">	expr = nft_expr_first(rule);</span><br><span class="line">	<span class="keyword">while</span> (nft_expr_more(rule, expr)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (expr-&gt;ops-&gt;deactivate)</span><br><span class="line">			expr-&gt;ops-&gt;deactivate(ctx, expr, phase);</span><br><span class="line"></span><br><span class="line">		expr = nft_expr_next(expr);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šé¦–å…ˆæ‹¿åˆ°ruleä¸­çš„ç¬¬ä¸€ä¸ªexprç„¶åè¿›è¡Œå¾ªç¯ç›´åˆ°æ‹¿å®Œruleä¸­çš„æ‰€æœ‰exprã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_immediate_deactivate</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">				     <span class="keyword">const</span> struct nft_expr *expr,</span></span></span><br><span class="line"><span class="params"><span class="function">				     <span class="keyword">enum</span> nft_trans_phase phase)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_immediate_expr</span> *<span class="title">priv</span> =</span> nft_expr_priv(expr);</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_data</span> *<span class="title">data</span> =</span> &amp;priv-&gt;data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">chain_ctx</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule</span> *<span class="title">rule</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (priv-&gt;dreg == NFT_REG_VERDICT) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (data-&gt;verdict.code) &#123;</span><br><span class="line">		<span class="keyword">case</span> NFT_JUMP:</span><br><span class="line">		<span class="keyword">case</span> NFT_GOTO:</span><br><span class="line">			chain = data-&gt;verdict.chain;</span><br><span class="line">			<span class="keyword">if</span> (!nft_chain_binding(chain))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			chain_ctx = *ctx;</span><br><span class="line">			chain_ctx.chain = chain;</span><br><span class="line"></span><br><span class="line">			list_for_each_entry(rule, &amp;chain-&gt;rules, <span class="built_in">list</span>)</span><br><span class="line">				nft_rule_expr_deactivate(&amp;chain_ctx, rule, phase);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">switch</span> (phase) &#123;</span><br><span class="line">			<span class="keyword">case</span> NFT_TRANS_PREPARE_ERROR:</span><br><span class="line">				nf_tables_unbind_chain(ctx, chain);</span><br><span class="line">				fallthrough;</span><br><span class="line">			<span class="keyword">case</span> NFT_TRANS_PREPARE:</span><br><span class="line">				nft_deactivate_next(ctx-&gt;net, chain);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				nft_chain_del(chain);</span><br><span class="line">				chain-&gt;bound = <span class="literal">false</span>;</span><br><span class="line">				nft_use_dec(&amp;chain-&gt;table-&gt;use);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (phase == NFT_TRANS_COMMIT)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nft_data_release(&amp;priv-&gt;data, nft_dreg_to_type(priv-&gt;dreg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°opsä¸­çš„å‡½æ•°å³ä¸º<code>nft_immediate_deactivate</code>å‡½æ•°ã€‚é¦–å…ˆå‡½æ•°å†…éƒ¨è¿›å…¥ifåˆ†æ”¯ä¹‹åå›å…ˆæ‹¿åˆ°ç›®æ ‡chainï¼Œç„¶åå¦‚æœç›®æ ‡chainä¸ä¸ºbindingåˆ™ç›´æ¥breakå‡ºè¿™ä¸ªswitchï¼Œéšåä¼šé€šè¿‡<code>list_for_each_entry</code>å¾ªç¯é€’å½’çš„æ²¿ç€gotoæˆ–jumpçš„ç›®æ ‡é“¾å»deactivateç›®æ ‡chainçš„ruleã€‚</p>
<p>éšåæ ¹æ®ä¸åŒç±»å‹è¿›å…¥åˆ°ä¸åŒåˆ†æ”¯ï¼Œå½“ç±»å‹ä¸º<code>NFT_TRANS_PREPARE_ERROR</code>æ—¶ä¼šå…ˆè§£ç»‘å®šç›®æ ‡chainï¼Œç„¶åè®¾ç½®ç›®æ ‡chainä¸ºdeactivateã€‚</p>
<p>å¦‚æœç±»å‹ä¸º<code>NFT_TRANS_PREPARE</code>åˆ™ä¸ä¼šè§£ç»‘å®šåªä¼šå°†ç›®æ ‡chainè®¾ç½®ä¸ºdeactivateã€‚</p>
<p>æœ€åå°±æ˜¯å…¶ä½™ç±»å‹çš„è¯ï¼Œä¼šç›´æ¥å°†ç›®æ ‡chainç»™delæ‰ï¼Œæ¥ç€å¯¹tableçš„useæˆå‘˜å‡ä¸€æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nft_data_release</span><span class="params">(<span class="keyword">const</span> struct nft_data *data, <span class="keyword">enum</span> nft_data_types type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (type &lt; NFT_DATA_VERDICT)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">switch</span> (type) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFT_DATA_VERDICT:</span><br><span class="line">		<span class="keyword">return</span> nft_verdict_uninit(data);</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		WARN_ON(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(nft_data_release);</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ³¨æ„çš„æ˜¯åœ¨å‡½æ•°æœ«å°¾ä¼šè°ƒç”¨<code>nft_data_release</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨ä¹Ÿå°±æ˜¯å¯¹ç›®æ ‡chainçš„useç»™å‡ä¸€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">chain1-&gt;flags no NFT_CHAIN_BINDING;</span><br><span class="line">chain2-&gt;flags = NFT_CHAIN_BINDING;</span><br><span class="line">chain2-&gt;bound = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">å½“ chain1 =&gt; chain2 æ—¶ï¼š</span><br><span class="line">  chain1-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;bound = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">chain1-&gt;flags = NFT_CHAIN_BINDING;</span><br><span class="line">chain2-&gt;flags no NFT_CHAIN_BINDING;</span><br><span class="line">chain2-&gt;bound = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">å½“ chain1 =&gt; chain2 æ—¶ï¼š</span><br><span class="line">  chain1-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;bound = <span class="literal">true</span>;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">chain1-&gt;flags no NFT_CHAIN_BINDING;</span><br><span class="line">chain2-&gt;flags no NFT_CHAIN_BINDING;</span><br><span class="line">choun2-&gt;bound = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">å½“ chain1 =&gt; chain2 æ—¶ï¼š</span><br><span class="line">  chain1-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;use = <span class="number">1</span></span><br><span class="line">  chain2-&gt;bound = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>



<h3 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>æ¼æ´å‘ç”Ÿåœ¨<code>nf_tables_newrule</code>å‡½æ•°å†…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">err_destroy_flow_rule:</span><br><span class="line">	nft_use_dec_restore(&amp;chain-&gt;use);</span><br><span class="line">	<span class="keyword">if</span> (flow)</span><br><span class="line">		nft_flow_rule_destroy(flow);</span><br><span class="line">err_release_rule:</span><br><span class="line">	nft_rule_expr_deactivate(&amp;ctx, rule, NFT_TRANS_PREPARE_ERROR);</span><br><span class="line">	nf_tables_rule_destroy(&amp;ctx, rule);</span><br><span class="line">err_release_expr:</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (expr_info[i].ops) &#123;</span><br><span class="line">			module_put(expr_info[i].ops-&gt;type-&gt;owner);</span><br><span class="line">			<span class="keyword">if</span> (expr_info[i].ops-&gt;type-&gt;release_ops)</span><br><span class="line">				expr_info[i].ops-&gt;type-&gt;release_ops(expr_info[i].ops);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	kvfree(expr_info);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯åœ¨å‘ç”Ÿä¸æ­£å¸¸é€€å‡ºçš„æ—¶å€™ä¼šè°ƒç”¨<code>nft_rule_expr_deactivate</code>å‡½æ•°ï¼Œå³ä¸Šé¢åˆ†æçš„å‡½æ•°ã€‚</p>
<p>å¯ä»¥çŸ¥é“çš„æ˜¯è¿™ä¸ªå‡½æ•°ä¼šè‡´ä½¿<code>chain2-&gt;use - 1</code>ã€‚</p>
<p>å›åˆ°å‰ç½®çŸ¥è¯†<code>nfnetlink_rcv_batch</code>ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨<code>nf_tables_newrule</code>å‘ç”Ÿäº†ä¸æ­£ç¡®é€€å‡ºå¯¼è‡´ä¼šç»™<code>err = ss-&gt;call(...)</code>è¿”å›è´Ÿæ•°ï¼Œæœ€ç»ˆstatusä¸ä¼šç­‰äº<code>NFNL_BATCH_DONE</code>ï¼Œæœ€ç»ˆä¼šç›´æ¥è°ƒç”¨abortã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __nf_tables_abort(struct net *net, <span class="keyword">enum</span> nfnl_abort_action action)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftables_pernet</span> *<span class="title">nft_net</span> =</span> nft_pernet(net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>, *<span class="title">next</span>;</span></span><br><span class="line">	LIST_HEAD(set_update_list);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans_elem</span> *<span class="title">te</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (action == NFNL_ABORT_VALIDATE &amp;&amp;</span><br><span class="line">	    nf_tables_validate(net) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EAGAIN;</span><br><span class="line"></span><br><span class="line">	list_for_each_entry_safe_reverse(trans, next, &amp;nft_net-&gt;commit_list,</span><br><span class="line">					 <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (trans-&gt;msg_type) &#123;</span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line">		<span class="keyword">case</span> NFT_MSG_NEWRULE:</span><br><span class="line">			<span class="keyword">if</span> (nft_trans_rule_bound(trans)) &#123;</span><br><span class="line">				nft_trans_destroy(trans);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			nft_use_dec_restore(&amp;trans-&gt;ctx.chain-&gt;use);</span><br><span class="line">			list_del_rcu(&amp;nft_trans_rule(trans)-&gt;<span class="built_in">list</span>);</span><br><span class="line">			nft_rule_expr_deactivate(&amp;trans-&gt;ctx,</span><br><span class="line">						 nft_trans_rule(trans),</span><br><span class="line">						 NFT_TRANS_ABORT);</span><br><span class="line">			<span class="keyword">if</span> (trans-&gt;ctx.chain-&gt;flags &amp; NFT_CHAIN_HW_OFFLOAD)</span><br><span class="line">				nft_flow_rule_destroy(nft_trans_flow_rule(trans));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nft_set_abort_update(&amp;set_update_list);</span><br><span class="line"></span><br><span class="line">	synchronize_rcu();</span><br><span class="line"></span><br><span class="line">	list_for_each_entry_safe_reverse(trans, next,</span><br><span class="line">					 &amp;nft_net-&gt;commit_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">		nft_trans_list_del(trans);</span><br><span class="line">		nf_tables_abort_release(trans);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (action == NFNL_ABORT_AUTOLOAD)</span><br><span class="line">		nf_tables_module_autoload(net);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		nf_tables_module_autoload_cleanup(net);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬åœ¨å‰é¢çš„åˆ†æè¿‡ç¨‹ä¸­ä¼šçœ‹åˆ°åœ¨å½“chain2çš„flagsä¸º<code>NFT_CHAIN_BINDING</code>æ—¶chain2çš„boundä¼šç­‰äºfalseï¼Œå½“chain2å†…éƒ¨æœ‰æ‰€ä¾å°±ä¸ä¼šè¿›å…¥ifåˆ†ä¹‹å†…ï¼Œè€Œæ˜¯è¿›å…¥åé¢çš„åˆ†æ”¯ï¼Œå¯æ˜¯åé¢ä¼šåˆä¸€æ¬¡çš„è°ƒç”¨<code>nft_rule_expr_deactivate</code>å‡½æ•°ï¼Œæ­¤æ—¶ï¼Œå¦‚æœchain2æœ‰gotoåˆ°chain3çš„ruleçš„è¯åˆ™ä¼šå¯¼è‡´chain3çš„useæˆå‘˜å‡ºç°ä¸‹æº¢çš„æƒ…å†µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">chain1 =&gt; chain2 =&gt; chain3;</span><br><span class="line">chain2-&gt;rule-&gt;expr0 =&gt; chain3		[OK];</span><br><span class="line">chain1-&gt;rule-&gt;expr1 =&gt; chain2		[OK];</span><br><span class="line"></span><br><span class="line">æ­¤æ—¶å„chainçŠ¶æ€:</span><br><span class="line">	chain1-&gt;use = <span class="number">0</span>;</span><br><span class="line">	chain2-&gt;use = <span class="number">2</span>;</span><br><span class="line">	chain2-&gt;bound = <span class="literal">true</span>;</span><br><span class="line">	chain3-&gt;use = <span class="number">1</span>;</span><br><span class="line">	chain3-&gt;bound = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chain1-&gt;rule-&gt;expr2 =&gt; chain2		[ERR]; <span class="comment">// ä¼šè°ƒç”¨ä¸€æ¬¡ nf_tables_rule_destroy å‡½æ•°ä¼šå°† chain2-&gt;use--</span></span><br><span class="line"></span><br><span class="line">æ­¤æ—¶å„chainçŠ¶æ€:</span><br><span class="line">	chain1-&gt;use = <span class="number">0</span>;</span><br><span class="line">	chain2-&gt;use = <span class="number">0</span>;</span><br><span class="line">	chain3-&gt;use = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nf_tables_abort; <span class="comment">// å› ä¸ºæ­¤æ—¶åªæœ‰chain2çš„ruleèƒ½å¤Ÿèµ°åˆ° case NFT_MSG_NEWRULE: åˆ†æ”¯ã€‚</span></span><br><span class="line"></span><br><span class="line">æ­¤æ—¶å„chainçŠ¶æ€:</span><br><span class="line">	chain1-&gt;use = <span class="number">0</span>;</span><br><span class="line">	chain2-&gt;use = <span class="number">0</span>;</span><br><span class="line">	chain3-&gt;use = <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šå°±æ˜¯æ•´ä¸ªè¿‡ç¨‹ä¸­å„ä¸ªchainçš„ruleå˜åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nf_tables_abort_release</span><span class="params">(struct nft_trans *trans)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> (trans-&gt;msg_type) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWTABLE:</span><br><span class="line">		nf_tables_table_destroy(&amp;trans-&gt;ctx);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWCHAIN:</span><br><span class="line">		<span class="keyword">if</span> (nft_trans_chain_update(trans))</span><br><span class="line">			nft_hooks_destroy(&amp;nft_trans_chain_hooks(trans));</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			nf_tables_chain_destroy(&amp;trans-&gt;ctx);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWRULE:</span><br><span class="line">		nf_tables_rule_destroy(&amp;trans-&gt;ctx, nft_trans_rule(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWSET:</span><br><span class="line">		nft_set_destroy(&amp;trans-&gt;ctx, nft_trans_set(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWSETELEM:</span><br><span class="line">		nft_set_elem_destroy(nft_trans_elem_set(trans),</span><br><span class="line">				     nft_trans_elem(trans).priv, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWOBJ:</span><br><span class="line">		nft_obj_destroy(&amp;trans-&gt;ctx, nft_trans_obj(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_MSG_NEWFLOWTABLE:</span><br><span class="line">		<span class="keyword">if</span> (nft_trans_flowtable_update(trans))</span><br><span class="line">			nft_hooks_destroy(&amp;nft_trans_flowtable_hooks(trans));</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			nf_tables_flowtable_destroy(nft_trans_flowtable(trans));</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	kfree(trans);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆèµ°åˆ°<code>nf_tables_abort_release</code>å‡½æ•°ï¼Œä¼šåœ¨<code>NFT_MSG_NEWCHAIN</code>åˆ†æ”¯ä¸­è°ƒç”¨<code>nf_tables_chain_destroy</code>å‡½æ•°ï¼Œæœ€ç»ˆä¼šå°†chain1ã€chain2ç»™freeæ‰ï¼Œchain3åˆ™ä¿ç•™å¹¶ä¸”å…¶useæˆå‘˜ä¸º-1ï¼Œå¦‚æœæ­¤æ—¶å†æ¬¡åˆ›å»ºä¸€ä¸ªchainå¼•ç”¨chain3é‚£ä¹ˆchain3çš„useæˆå‘˜ä¼šå˜ä¸º0ï¼Œæœ€åè°ƒç”¨<code>nf_tables_delchain</code>å³å¯å®ç°uafã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_tables_chain_destroy</span><span class="params">(struct nft_ctx *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span> =</span> ctx-&gt;chain;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_hook</span> *<span class="title">hook</span>, *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(chain-&gt;use &gt; <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* no concurrent access possible anymore */</span></span><br><span class="line">	nf_tables_chain_free_chain_rules(chain);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_is_base_chain(chain)) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_base_chain</span> *<span class="title">basechain</span> =</span> nft_base_chain(chain);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nft_base_chain_netdev(ctx-&gt;family, basechain-&gt;ops.hooknum)) &#123;</span><br><span class="line">			list_for_each_entry_safe(hook, next,</span><br><span class="line">						 &amp;basechain-&gt;hook_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">				list_del_rcu(&amp;hook-&gt;<span class="built_in">list</span>);</span><br><span class="line">				kfree_rcu(hook, rcu);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		module_put(basechain-&gt;type-&gt;owner);</span><br><span class="line">		<span class="keyword">if</span> (rcu_access_pointer(basechain-&gt;stats)) &#123;</span><br><span class="line">			static_branch_dec(&amp;nft_counters_enabled);</span><br><span class="line">			free_percpu(rcu_dereference_raw(basechain-&gt;stats));</span><br><span class="line">		&#125;</span><br><span class="line">		kfree(chain-&gt;name);</span><br><span class="line">		kfree(chain-&gt;udata);</span><br><span class="line">		kfree(basechain);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		kfree(chain-&gt;name);</span><br><span class="line">		kfree(chain-&gt;udata);</span><br><span class="line">		kfree(chain);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå…¶è¢«æ¼æ´ä¿®æ”¹ä¸º-1æ‰€ä»¥ä¸€å¼€å§‹æ‰æ˜¯æ²¡æœ‰è¢«freeæ‰çš„ã€‚</p>
<h3 id="åˆ©ç”¨åˆ†æ-1"><a href="#åˆ©ç”¨åˆ†æ-1" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>ç°çŠ¶æ˜¯chain4 &#x3D;&gt; chain3(freed)æ‰€ä»¥åªèƒ½é€šè¿‡chain4å»è®¿é—®chain3çš„å†…å­˜</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_getrule</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct nfnl_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">			     <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> *<span class="title">extack</span> =</span> info-&gt;extack;</span><br><span class="line">	u8 genmask = nft_genmask_cur(info-&gt;net);</span><br><span class="line">	u8 family = info-&gt;nfmsg-&gt;nfgen_family;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_rule</span> *<span class="title">rule</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> info-&gt;net;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb2</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> reset = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_DUMP) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">netlink_dump_control</span> <span class="title">c</span> =</span> &#123;</span><br><span class="line">			.start= nf_tables_dump_rules_start,</span><br><span class="line">			.dump = nf_tables_dump_rules,</span><br><span class="line">			.done = nf_tables_dump_rules_done,</span><br><span class="line">			.<span class="keyword">module</span> = THIS_MODULE,</span><br><span class="line">			.data = (<span class="keyword">void</span> *)nla,</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> nft_netlink_dump_start_rcu(info-&gt;sk, skb, info-&gt;nlh, &amp;c);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	table = nft_table_lookup(net, nla[NFTA_RULE_TABLE], family, genmask, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_TABLE]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	chain = nft_chain_lookup(net, table, nla[NFTA_RULE_CHAIN], genmask);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_CHAIN]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rule = nft_rule_lookup(chain, nla[NFTA_RULE_HANDLE]);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(rule)) &#123;</span><br><span class="line">		NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_HANDLE]);</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(rule);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	skb2 = alloc_skb(NLMSG_GOODSIZE, GFP_ATOMIC);</span><br><span class="line">	<span class="keyword">if</span> (!skb2)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (NFNL_MSG_TYPE(info-&gt;nlh-&gt;nlmsg_type) == NFT_MSG_GETRULE_RESET)</span><br><span class="line">		reset = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	err = nf_tables_fill_rule_info(skb2, net, NETLINK_CB(skb).portid,</span><br><span class="line">				       info-&gt;nlh-&gt;nlmsg_seq, NFT_MSG_NEWRULE, <span class="number">0</span>,</span><br><span class="line">				       family, table, chain, rule, <span class="number">0</span>, reset);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_fill_rule_info;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nfnetlink_unicast(skb2, net, NETLINK_CB(skb).portid);</span><br><span class="line"></span><br><span class="line">err_fill_rule_info:</span><br><span class="line">	kfree_skb(skb2);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä½¿ç”¨<code>getrule</code>ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>nf_tables_fill_rule_info</code>å‡½æ•°å»å¡«å……ruleä¿¡æ¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_fill_rule_info</span><span class="params">(struct sk_buff *skb, struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">				    u32 portid, u32 seq, <span class="keyword">int</span> event,</span></span></span><br><span class="line"><span class="params"><span class="function">				    u32 flags, <span class="keyword">int</span> family,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">const</span> struct nft_table *table,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">const</span> struct nft_chain *chain,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">const</span> struct nft_rule *rule, u64 handle,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">bool</span> reset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>, *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">list</span>;</span></span><br><span class="line">	u16 type = nfnl_msg_type(NFNL_SUBSYS_NFTABLES, event);</span><br><span class="line"></span><br><span class="line">	nlh = nfnl_msg_put(skb, portid, seq, type, flags, family, NFNETLINK_V0,</span><br><span class="line">			   nft_base_seq(net));</span><br><span class="line">	<span class="keyword">if</span> (!nlh)</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla_put_string(skb, NFTA_RULE_TABLE, table-&gt;name))</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	<span class="keyword">if</span> (nla_put_string(skb, NFTA_RULE_CHAIN, chain-&gt;name))</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	<span class="keyword">if</span> (nla_put_be64(skb, NFTA_RULE_HANDLE, cpu_to_be64(rule-&gt;handle),</span><br><span class="line">			 NFTA_RULE_PAD))</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (event != NFT_MSG_DELRULE &amp;&amp; handle) &#123;</span><br><span class="line">		<span class="keyword">if</span> (nla_put_be64(skb, NFTA_RULE_POSITION, cpu_to_be64(handle),</span><br><span class="line">				 NFTA_RULE_PAD))</span><br><span class="line">			<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (chain-&gt;flags &amp; NFT_CHAIN_HW_OFFLOAD)</span><br><span class="line">		nft_flow_rule_stats(chain, rule);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">list</span> = nla_nest_start_noflag(skb, NFTA_RULE_EXPRESSIONS);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">list</span> == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	nft_rule_for_each_expr(expr, next, rule) &#123;</span><br><span class="line">		<span class="keyword">if</span> (nft_expr_dump(skb, NFTA_LIST_ELEM, expr, reset) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	&#125;</span><br><span class="line">	nla_nest_end(skb, <span class="built_in">list</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rule-&gt;udata) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_userdata</span> *<span class="title">udata</span> =</span> nft_userdata(rule);</span><br><span class="line">		<span class="keyword">if</span> (nla_put(skb, NFTA_RULE_USERDATA, udata-&gt;len + <span class="number">1</span>,</span><br><span class="line">			    udata-&gt;data) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nlmsg_end(skb, nlh);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">nla_put_failure:</span><br><span class="line">	nlmsg_trim(skb, nlh);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™é‡Œä¼šè°ƒç”¨<code>nft_expr_dump</code>å‡½æ•°è·å¾—exprã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_fill_expr_info</span><span class="params">(struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">const</span> struct nft_expr *expr, <span class="keyword">bool</span> reset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (nla_put_string(skb, NFTA_EXPR_NAME, expr-&gt;ops-&gt;type-&gt;name))</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (expr-&gt;ops-&gt;dump) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">data</span> =</span> nla_nest_start_noflag(skb,</span><br><span class="line">							    NFTA_EXPR_DATA);</span><br><span class="line">		<span class="keyword">if</span> (data == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">		<span class="keyword">if</span> (expr-&gt;ops-&gt;dump(skb, expr, reset) &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">		nla_nest_end(skb, data);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> skb-&gt;len;</span><br><span class="line"></span><br><span class="line">nla_put_failure:</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nft_expr_dump</span><span class="params">(struct sk_buff *skb, <span class="keyword">unsigned</span> <span class="keyword">int</span> attr,</span></span></span><br><span class="line"><span class="params"><span class="function">		  <span class="keyword">const</span> struct nft_expr *expr, <span class="keyword">bool</span> reset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nest</span>;</span></span><br><span class="line"></span><br><span class="line">	nest = nla_nest_start_noflag(skb, attr);</span><br><span class="line">	<span class="keyword">if</span> (!nest)</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	<span class="keyword">if</span> (nf_tables_fill_expr_info(skb, expr, reset) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	nla_nest_end(skb, nest);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">nla_put_failure:</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ€åä¼šè°ƒç”¨opsçš„dumpã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nft_data_dump</span><span class="params">(struct sk_buff *skb, <span class="keyword">int</span> attr, <span class="keyword">const</span> struct nft_data *data,</span></span></span><br><span class="line"><span class="params"><span class="function">		  <span class="keyword">enum</span> nft_data_types type, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nest</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	nest = nla_nest_start_noflag(skb, attr);</span><br><span class="line">	<span class="keyword">if</span> (nest == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (type) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFT_DATA_VALUE:</span><br><span class="line">		err = nft_value_dump(skb, data, len);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFT_DATA_VERDICT:</span><br><span class="line">		err = nft_verdict_dump(skb, NFTA_DATA_VERDICT, &amp;data-&gt;verdict);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		WARN_ON(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nla_nest_end(skb, nest);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(nft_data_dump);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_immediate_dump</span><span class="params">(struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="keyword">const</span> struct nft_expr *expr, <span class="keyword">bool</span> reset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_immediate_expr</span> *<span class="title">priv</span> =</span> nft_expr_priv(expr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_dump_register(skb, NFTA_IMMEDIATE_DREG, priv-&gt;dreg))</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nft_data_dump(skb, NFTA_IMMEDIATE_DATA, &amp;priv-&gt;data,</span><br><span class="line">			     nft_dreg_to_type(priv-&gt;dreg), priv-&gt;dlen);</span><br><span class="line"></span><br><span class="line">nla_put_failure:</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ€ç»ˆä¼šèµ°åˆ°<code>nft_verdict_dump</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nft_verdict_dump</span><span class="params">(struct sk_buff *skb, <span class="keyword">int</span> type, <span class="keyword">const</span> struct nft_verdict *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nest</span>;</span></span><br><span class="line"></span><br><span class="line">	nest = nla_nest_start_noflag(skb, type);</span><br><span class="line">	<span class="keyword">if</span> (!nest)</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla_put_be32(skb, NFTA_VERDICT_CODE, htonl(v-&gt;code)))</span><br><span class="line">		<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (v-&gt;code) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFT_JUMP:</span><br><span class="line">	<span class="keyword">case</span> NFT_GOTO:</span><br><span class="line">		<span class="keyword">if</span> (nla_put_string(skb, NFTA_VERDICT_CHAIN,</span><br><span class="line">				   v-&gt;chain-&gt;name))</span><br><span class="line">			<span class="keyword">goto</span> nla_put_failure;</span><br><span class="line">	&#125;</span><br><span class="line">	nla_nest_end(skb, nest);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">nla_put_failure:</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åå¯ä»¥æ‹¿åˆ°chainçš„nameï¼ŒåŸä½œè€…æ˜¯é€šè¿‡å †å–·<code>struct nft_expr</code>ï¼Œé€šè¿‡å…¶opsæ‹¿åˆ°å†…æ ¸åŸºåœ°å€ï¼Œåœ¨é€šè¿‡å¯¹å–·<code>struct nft_rule</code>æ‹¿åˆ°å†…æ ¸å †åœ°å€ï¼Œæœ€ç»ˆé€šè¿‡æ§åˆ¶<code>table-&gt;udata</code>å»ä¿®æ”¹æ‰ã€‚</p>
<p>å…³äºå¦‚ä½•æ§åˆ¶RIPè¿™é‡Œåˆéœ€è¦ä¸€ç‚¹ç‚¹å‰ç½®çŸ¥è¯†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span>		__<span class="title">rcu</span> *<span class="title">blob_gen_0</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span>		__<span class="title">rcu</span> *<span class="title">blob_gen_1</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">rules</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rhlist_head</span>		<span class="title">rhlhead</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span>		*<span class="title">table</span>;</span></span><br><span class="line">	u64				handle;</span><br><span class="line">	u32				use;</span><br><span class="line">	u8				flags:<span class="number">5</span>,</span><br><span class="line">					bound:<span class="number">1</span>,</span><br><span class="line">					genmask:<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">char</span>				*name;</span><br><span class="line">	u16				udlen;</span><br><span class="line">	u8				*udata;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Only used during control plane commit phase: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span>		*<span class="title">blob_next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨çœ‹åˆ°<code>nft_chain</code>ç»“æ„ä½“ä¸­è¿˜å­˜åœ¨<code>blob_next</code>æˆå‘˜<code>blob_gen_0</code>ä»¥åŠ<code>blob_gen_0</code>æˆå‘˜å«äººéš¾ä»¥ç†è§£</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_commit</span><span class="params">(struct net *net, struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nftables_pernet</span> *<span class="title">nft_net</span> =</span> nft_pernet(net);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>, *<span class="title">next</span>;</span></span><br><span class="line">	LIST_HEAD(set_update_list);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans_elem</span> *<span class="title">te</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> base_seq;</span><br><span class="line">	LIST_HEAD(adl);</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 1.  Allocate space for next generation rules_gen_X[] */</span></span><br><span class="line">	list_for_each_entry_safe(trans, next, &amp;nft_net-&gt;commit_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">		ret = nf_tables_commit_audit_alloc(&amp;adl, trans-&gt;ctx.table);</span><br><span class="line">		<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">			nf_tables_commit_chain_prepare_cancel(net);</span><br><span class="line">			nf_tables_commit_audit_free(&amp;adl);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (trans-&gt;msg_type == NFT_MSG_NEWRULE ||</span><br><span class="line">		    trans-&gt;msg_type == NFT_MSG_DELRULE) &#123;</span><br><span class="line">			chain = trans-&gt;ctx.chain;</span><br><span class="line"></span><br><span class="line">			ret = nf_tables_commit_chain_prepare(net, chain);</span><br><span class="line">			<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				nf_tables_commit_chain_prepare_cancel(net);</span><br><span class="line">				nf_tables_commit_audit_free(&amp;adl);</span><br><span class="line">				<span class="keyword">return</span> ret;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* step 2.  Make rules_gen_X visible to packet path */</span></span><br><span class="line">	list_for_each_entry(table, &amp;nft_net-&gt;tables, <span class="built_in">list</span>) &#123;</span><br><span class="line">		list_for_each_entry(chain, &amp;table-&gt;chains, <span class="built_in">list</span>)</span><br><span class="line">			nf_tables_commit_chain(net, chain);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">  </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ³¨æ„åˆ°è¿™é‡Œä¼šåœ¨è¿›å…¥åé¢çš„switchä¹‹å‰å¯¹newruleä¸€ç‚¹æ“ä½œï¼Œå…·ä½“æ“ä½œå› ä¸ºç¯‡å¹…é—®é¢˜å°±ä¸è¿‡å¤šä»‹ç»ï¼Œå¤§æ¦‚å°±æ˜¯å‰é¢çš„forå¾ªç¯æ˜¯å°†æ–°ç”Ÿæˆçš„ruleæ”¾åˆ°è¿™é‡Œï¼Œåé¢åˆ™æ˜¯æ”¾åˆ°å¦å¤–ä¸¤ä¸ªç»“æ„ä½“ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">nft_do_chain</span><span class="params">(struct nft_pktinfo *pkt, <span class="keyword">void</span> *priv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span> =</span> priv, *basechain = chain;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> nft_net(pkt);</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>, *<span class="title">last</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_dp</span> *<span class="title">rule</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_regs</span> <span class="title">regs</span> =</span> &#123;&#125;;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> stackptr = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_jumpstack</span> <span class="title">jumpstack</span>[<span class="title">NFT_JUMP_STACK_SIZE</span>];</span></span><br><span class="line">	<span class="keyword">bool</span> genbit = READ_ONCE(net-&gt;nft.gencursor);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span> *<span class="title">blob</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_traceinfo</span> <span class="title">info</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">do_chain:</span><br><span class="line">	<span class="keyword">if</span> (genbit)</span><br><span class="line">		blob = rcu_dereference(chain-&gt;blob_gen_1);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		blob = rcu_dereference(chain-&gt;blob_gen_0);</span><br><span class="line"></span><br><span class="line">	rule = (struct nft_rule_dp *)blob-&gt;data;</span><br><span class="line">next_rule:</span><br><span class="line">	regs.verdict.code = NFT_CONTINUE;</span><br><span class="line">	<span class="keyword">for</span> (; !rule-&gt;is_last ; rule = nft_rule_next(rule)) &#123;</span><br><span class="line">		nft_rule_dp_for_each_expr(expr, last, rule) &#123;</span><br><span class="line">			<span class="keyword">if</span> (expr-&gt;ops == &amp;nft_cmp_fast_ops)</span><br><span class="line">				nft_cmp_fast_eval(expr, &amp;regs);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (expr-&gt;ops == &amp;nft_cmp16_fast_ops)</span><br><span class="line">				nft_cmp16_fast_eval(expr, &amp;regs);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (expr-&gt;ops == &amp;nft_bitwise_fast_ops)</span><br><span class="line">				nft_bitwise_fast_eval(expr, &amp;regs);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (expr-&gt;ops != &amp;nft_payload_fast_ops ||</span><br><span class="line">				 !nft_payload_fast_eval(expr, &amp;regs, pkt))</span><br><span class="line">				expr_call_ops_eval(expr, &amp;regs, pkt);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (regs.verdict.code != NFT_CONTINUE)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line">EXPORT_SYMBOL_GPL(nft_do_chain);</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°<code>nft_do_chain</code>ä¼šåœ¨è¯„ä¼°æ•°æ®åŒ…çš„æ—¶å€™è°ƒç”¨ï¼Œè¿™é‡Œä¼šä»<code>blob_gen_0</code>ä¸­æ‹¿åˆ°blobæœ€ç»ˆæ‹¿åˆ°ruleå’Œexprï¼Œç„¶åæ ¹æ®opsè°ƒç”¨å¯¹åº”çš„å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expr_call_ops_eval</span><span class="params">(<span class="keyword">const</span> struct nft_expr *expr,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct nft_regs *regs,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct nft_pktinfo *pkt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_RETPOLINE</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> e;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nf_skip_indirect_calls())</span><br><span class="line">		<span class="keyword">goto</span> indirect_call;</span><br><span class="line"></span><br><span class="line">	e = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)expr-&gt;ops-&gt;eval;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> X(e, fun) \</span></span><br><span class="line"><span class="meta">	do &#123; <span class="meta-keyword">if</span> ((e) == (unsigned long)(fun)) \</span></span><br><span class="line"><span class="meta">		return fun(expr, regs, pkt); &#125; while (0)</span></span><br><span class="line"></span><br><span class="line">	X(e, nft_payload_eval);</span><br><span class="line">	X(e, nft_cmp_eval);</span><br><span class="line">	X(e, nft_counter_eval);</span><br><span class="line">	X(e, nft_meta_get_eval);</span><br><span class="line">	X(e, nft_lookup_eval);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_NFT_CT)</span></span><br><span class="line">	X(e, nft_ct_get_fast_eval);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	X(e, nft_range_eval);</span><br><span class="line">	X(e, nft_immediate_eval);</span><br><span class="line">	X(e, nft_byteorder_eval);</span><br><span class="line">	X(e, nft_dynset_eval);</span><br><span class="line">	X(e, nft_rt_get_eval);</span><br><span class="line">	X(e, nft_bitwise_eval);</span><br><span class="line">	X(e, nft_objref_eval);</span><br><span class="line">	X(e, nft_objref_map_eval);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span>  X</span></span><br><span class="line">indirect_call:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_RETPOLINE */</span></span></span><br><span class="line">	expr-&gt;ops-&gt;eval(expr, regs, pkt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¿™é‡ŒåŸä½œè€…çš„æ€è·¯å°±æ˜¯æ§åˆ¶åˆ°blobå³å¯æ§åˆ¶RIPäº†ã€‚</p>
<hr>
<p>å‚è€ƒé“¾æ¥:</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/google/security-research/blob/master/pocs/linux/kernelctf/CVE-2023-4004_lts_cos_mitigation/docs/exploit.md#rop-detail" >https://github.com/google/security-research/blob/master/pocs/linux/kernelctf/CVE-2023-4004_lts_cos_mitigation/docs/exploit.md#rop-detail<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/google/security-research/blob/master/pocs/linux/kernelctf/CVE-2023-4015_lts/docs/exploit.md" >https://github.com/google/security-research/blob/master/pocs/linux/kernelctf/CVE-2023-4015_lts/docs/exploit.md<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/nft-set-pipapo-type/">nft_set_pipapo_type</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/nft-rule-expr-deactivate/">nft_rule_expr_deactivate</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2024/09/07/nftables-CVEs2/"
                                   title="nftables CVEå¤ç°ç³»åˆ—ã€äºŒã€‘"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">nftables CVEå¤ç°ç³»åˆ—ã€äºŒã€‘</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2024/08/27/CVE-2022-34918/"
                                   title="CVE-2022-34918"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">CVE-2022-34918</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2023-4004"><span class="nav-text">CVE-2023-4004</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">å‰ç½®çŸ¥è¯†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nft-pipapo-init"><span class="nav-text">nft_pipapo_init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nft-pipapo-insert"><span class="nav-text">nft_pipapo_insert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nft-del-setelem"><span class="nav-text">nft_del_setelem</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#commit-release%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="nav-text">commit_releaseè¯¦ç»†åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">åˆ©ç”¨åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2023-4015"><span class="nav-text">CVE-2023-4015</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-1"><span class="nav-text">å‰ç½®çŸ¥è¯†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">å¸¸è§ç»“æ„ä½“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nft-rule-expr-deactivate"><span class="nav-text">nft_rule_expr_deactivate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90-1"><span class="nav-text">åˆ©ç”¨åˆ†æ</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">335.6k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2023-4004"><span class="nav-text">CVE-2023-4004</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">å‰ç½®çŸ¥è¯†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nft-pipapo-init"><span class="nav-text">nft_pipapo_init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nft-pipapo-insert"><span class="nav-text">nft_pipapo_insert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nft-del-setelem"><span class="nav-text">nft_del_setelem</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#commit-release%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90"><span class="nav-text">commit_releaseè¯¦ç»†åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">åˆ©ç”¨åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2023-4015"><span class="nav-text">CVE-2023-4015</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-1"><span class="nav-text">å‰ç½®çŸ¥è¯†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">å¸¸è§ç»“æ„ä½“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nft-rule-expr-deactivate"><span class="nav-text">nft_rule_expr_deactivate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90-1"><span class="nav-text">åˆ©ç”¨åˆ†æ</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
