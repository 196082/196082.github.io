<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            syzkaller: syz-manageræºç åˆ†æ |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/ufo.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/ufo.ico"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        syzkaller: syz-manageræºç åˆ†æ
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-11-17 11:40:06</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Jun 12 2024 20:51:32 GMT+0800">2024-06-12 20:51:32</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/fuzzing/">fuzzing</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/fuzzing/">fuzzing</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/syzkaller/">syzkaller</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>7.6k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>39 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™ç¯‡æ–‡ç« çš„å‰è¨€ä¸»è¦æä¸€ä¸‹å‰æ®µæ—¶é—´åœ¨å¼ºç½‘æ‹Ÿæ€ä¸­çš„pwnï¼Œé¦–å…ˆæ˜¯å†…æ ¸pwnã€‚</p>
<p>å…¶å®å¾ˆç®€å•å°±æ˜¯ä¸€ä¸ªç®€å•ç‰ˆçš„<code>off by null</code>ã€‚ä½†æ˜¯æˆ‘çŠ¯è ¢äº†ï¼Œåœ¨å †å–·<code>pipe_buffer</code>æ—¶è®¡ç®—é”™è¯¯å¯¼è‡´å †å–·å¤±è´¥ä»¥è‡³äºåœ¨å¼€å§‹æ”¾å¼ƒäº†ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œè½¬è€Œä½¿ç”¨<code>msg_msg</code>å½¢æˆåŒå‘é“¾è¡¨é€ æˆUAFï¼Œå¯æƒœçš„æ˜¯æ­¤æ–¹æ³•å› ä¸º<code>off by null</code>çš„é™åˆ¶ä½¿å¾—å…¶ç”³è¯·çš„å †å—åº”è¯¥æ˜¯ä»<code>kmalloc-192</code>æˆ–ä»¥ä¸‹ç”³è¯·ï¼Œæ‰€ä»¥å¾ˆå¤šå¯ä»¥å †å–·æ¥å†™å…¥çš„ç»“æ„ä½“æ— æ³•ä½¿ç”¨ï¼Œå¦‚æœç»§ç»­ä½¿ç”¨<code>msg_msgseg</code>ç»“æ„ä½“æ¥å®ç°ä»»æ„å†™ä¹Ÿä¼šå› ä¸ºå…¶å­˜åœ¨ä¸€ä¸ª<code>next</code>æŒ‡é’ˆå¯¼è‡´æ— æ³•<code>free</code>ã€‚æœ€åè¿™é“é¢˜ä¾æ—§æ˜¯é€šè¿‡æ„é€ å¤šçº§ç®¡é“è§£å‡ºã€‚</p>
<p>è¿™é‡Œé‡ç‚¹æä¸€ä¸‹é‚£ä¸€é“å †é¢˜ï¼ˆåšå®Œå†…æ ¸å‡Œæ™¨å››ç‚¹äº†ï¼Œè¿™é“é¢˜æ²¡åšï¼‰ã€‚ç®€å•æè¿°ä¸€ä¸‹æ¼æ´ï¼Œé¦–å…ˆå…¶<code>edit</code>å‡½æ•°ä¸­å­˜åœ¨<code>off by null</code>ï¼Œç„¶åè¿˜å¯ä»¥åœ¨<code>create</code>å‡½æ•°ä¸­ä¸€ç›´ç”³è¯·å †å—ï¼Œä¸è¿‡è¿™é‡Œé™åˆ¶å¤§å°ä¸º 0~0x78 ï¼Œæ‰€æœ‰çš„å †å—èŒƒå›´éƒ½åœ¨<code>fastbin</code>å†…ã€‚ç„¶åä¼°æ‘¸ç€è¿™é¢˜çš„åˆ©ç”¨æ–¹æ³•åº”è¯¥å’Œ<code>top chunk</code>æœ‰å…³ï¼Œä½†æ˜¯ä»”ç»†çœ‹äº†ä¸€ä¸‹<code>house of force</code>å‘ç°æ¡ä»¶å¹¶ä¸æ»¡è¶³ï¼Œåœ¨æ¯”èµ›å¿«ç»“æŸæ—¶çœ‹äº†ä¸€ä¸‹æºç å‘ç°äº†ä»¥å¾€ä¸çŸ¥é“çš„æœºåˆ¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">use_top:</span><br><span class="line"></span><br><span class="line">victim = av-&gt;top;</span><br><span class="line">size = chunksize (victim);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): corrupted top size&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">&#123;</span><br><span class="line">  remainder_size = size - nb;</span><br><span class="line">  remainder = chunk_at_offset (victim, nb);</span><br><span class="line">  av-&gt;top = remainder;</span><br><span class="line">  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">  check_malloced_chunk (av, victim, nb);</span><br><span class="line">  <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">  alloc_perturb (p, bytes);</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">         here for all block sizes.  */</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">&#123;</span><br><span class="line">  malloc_consolidate (av);</span><br><span class="line">  <span class="comment">/* restore original bin index */</span></span><br><span class="line">  <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">  <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">    alloc_perturb (p, bytes);</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç æ˜¯<code>_int_malloc</code>å‡½æ•°ä¸­çš„ç‰‡æ®µï¼Œè¿™ä¸ªç‰‡æ®µæ˜¯ä½¿ç”¨<code>top chunk</code>è¿›è¡Œåˆ†é…æ—¶çš„ç‰‡æ®µï¼Œé¦–å…ˆæ˜¯ç”³è¯·çš„å¤§å°åŠ ä¸Š16è¦å°äº<code>top chunk</code>çš„å¤§å°æ—¶è¿›å…¥åˆ°ç¬¬ä¸€ä¸ªåˆ†æ”¯ä¸­ï¼Œè¿™ä¸ªåˆ†æ”¯æ‰€åšçš„äº‹æƒ…çš„å¯¹<code>top chunk</code>è¿›è¡Œåˆ‡å‰²ã€‚</p>
<p>ç„¶åç›´æ¥çœ‹æœ€æœ«çš„è¿™ä¸€ä¸ªåˆ†æ”¯ï¼Œè¿™ä¸ªåˆ†æ”¯æ˜¯å‰ä¸¤ä¸ªéƒ½ä¸æ»¡è¶³æ—¶ä¼šè¿›å…¥ä¹Ÿå°±æ˜¯æ— æ³•ä»ç°æœ‰çš„<code>av</code>ä¸­å¾—åˆ°ç©ºé—´äº†ä¾¿å¼€å§‹ä½¿ç”¨<code>sysmalloc</code>è¿›è¡Œåˆ†é…ã€‚</p>
<p>ä¸­é—´çš„åˆ†æ”¯é¦–å…ˆä¼šæ£€æŸ¥<code>fastbin</code>ä¸­æ˜¯å¦å­˜åœ¨å †å—éšåè¿›å…¥åˆ°<code>malloc_consolidate</code>å‡½æ•°ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_consolidate</span><span class="params">(mstate av)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="keyword">int</span>             nextinuse;</span><br><span class="line"></span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  unsorted_bin = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">    then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">    placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">    until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">    reused anyway.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">  fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    p = atomic_exchange_acq (fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (misaligned_chunk (p)))</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;malloc_consolidate(): &quot;</span></span><br><span class="line">			     <span class="string">&quot;unaligned fastbin chunk detected&quot;</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = fastbin_index (chunksize (p));</span><br><span class="line">	  <span class="keyword">if</span> ((&amp;fastbin (av, idx)) != fb)</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	check_inuse_chunk(av, p);</span><br><span class="line">	nextp = REVEAL_PTR (p-&gt;fd);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">	size = chunksize (p);</span><br><span class="line">	nextchunk = chunk_at_offset(p, size);</span><br><span class="line">	nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">	  prevsize = prev_size (p);</span><br><span class="line">	  size += prevsize;</span><br><span class="line">	  p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);</span><br><span class="line">	  unlink_chunk (av, p);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">	  nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">	    size += nextsize;</span><br><span class="line">	    unlink_chunk (av, nextchunk);</span><br><span class="line">	  &#125; <span class="keyword">else</span></span><br><span class="line">	    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">	  unsorted_bin-&gt;fd = p;</span><br><span class="line">	  first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">	    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  set_head(p, size | PREV_INUSE);</span><br><span class="line">	  p-&gt;bk = unsorted_bin;</span><br><span class="line">	  p-&gt;fd = first_unsorted;</span><br><span class="line">	  set_foot(p, size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">	  size += nextsize;</span><br><span class="line">	  set_head(p, size | PREV_INUSE);</span><br><span class="line">	  av-&gt;top = p;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°çš„æ‰€åšçš„äº‹æƒ…å°±æ˜¾è€Œæ˜“è§äº†ï¼Œå°±æ˜¯ä»<code>fastbin</code>ä¸­å–å‡ºå †å—è¿›è¡Œåˆå¹¶æ”¾å…¥åˆ°<code>unsorted bin</code>ä¸­ã€‚åç»­åˆ©ç”¨å°±ä¸è¯¦ç»†æäº†ï¼ˆå› ä¸ºæˆ‘ä¹Ÿæ²¡çœ‹äº†ï¼‰ä½†æ˜¯ä¼°è®¡å°±æ˜¯é€šè¿‡<code>off by null</code>æ‰“<code>unlink</code>å®ç°ä»»æ„åœ°å€å†™ã€‚</p>
<p>ä¸‹é¢å›å½’æ­£é¢˜å¼€å§‹<code>syzkaller</code>çš„åˆ†æï¼Œé¦–å…ˆå…¶å·¥ä½œåŸç†åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æè¿‡ï¼Œè¿™é‡Œå°±ä¸å†é‡æäº†ã€‚å‰ä¸€ç¯‡æ–‡ç« æåˆ°<code>syzkaller</code>åˆ†ä¸ºäº†ä¸‰å¤§ç»„ä»¶ï¼Œå…¶å®é€šè¿‡å›¾å°±èƒ½çœ‹å‡ºæ¥<code>syz-fuzzer</code>å’Œ<code>syz-executor</code>éƒ½æ˜¯ä½äºè™šæ‹Ÿæœºä¸­çš„ï¼Œè€Œ<code>syz-manager</code>ä½äºHostä¸»æœºä¸­ã€‚</p>
<p>è¿™é‡Œç›´æ¥åˆ†æå‡½æ•°ï¼Œåœ¨åˆ†æå‡½æ•°çš„è¿‡ç¨‹ä¸­å°†æœ‰ç”¨çš„ç»“æ„ä½“å†è¿›ä¸€æ­¥åˆ†æã€‚</p>
<h2 id="RunManagerå‡½æ•°"><a href="#RunManagerå‡½æ•°" class="headerlink" title="RunManagerå‡½æ•°"></a>RunManagerå‡½æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> prog.GitRevision == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;bad syz-manager build: build with make, run bin/syz-manager&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	flag.Parse()</span><br><span class="line">	log.EnableLogCaching(<span class="number">1000</span>, <span class="number">1</span>&lt;&lt;<span class="number">20</span>)</span><br><span class="line">	cfg, err := mgrconfig.LoadFile(*flagConfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	RunManager(cfg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆçœ‹<code>syz-manager</code>çš„<code>main</code>å‡½æ•°ï¼Œå…¶ä¼šè¯»å–ä¼ å…¥çš„é…ç½®æ–‡ä»¶ç„¶åç›´æ¥è°ƒç”¨<code>RunManager</code>å‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunManager</span><span class="params">(cfg *mgrconfig.Config)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> vmPool *vm.Pool</span><br><span class="line">	<span class="keyword">if</span> cfg.Type != <span class="string">&quot;none&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> err error</span><br><span class="line">		vmPool, err = vm.Create(cfg, *flagDebug)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆæ˜¯åˆå§‹åŒ–<code>VM pool</code>ä½¿ç”¨<code>vm.Create</code>å‡½æ•°è¿›è¡Œåˆ›å»ºã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Create</span><span class="params">(cfg *mgrconfig.Config, debug <span class="keyword">bool</span>)</span> <span class="params">(*Pool, error)</span></span> &#123;</span><br><span class="line">	typ, ok := vmimpl.Types[vmType(cfg.Type)]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unknown instance type &#x27;%v&#x27;&quot;</span>, cfg.Type)</span><br><span class="line">	&#125;</span><br><span class="line">	env := &amp;vmimpl.Env&#123;</span><br><span class="line">		Name:      cfg.Name,</span><br><span class="line">		OS:        cfg.TargetOS,</span><br><span class="line">		Arch:      cfg.TargetVMArch,</span><br><span class="line">		Workdir:   cfg.Workdir,</span><br><span class="line">		Image:     cfg.Image,</span><br><span class="line">		SSHKey:    cfg.SSHKey,</span><br><span class="line">		SSHUser:   cfg.SSHUser,</span><br><span class="line">		Timeouts:  cfg.Timeouts,</span><br><span class="line">		Debug:     debug,</span><br><span class="line">		Config:    cfg.VM,</span><br><span class="line">		KernelSrc: cfg.KernelSrc,</span><br><span class="line">	&#125;</span><br><span class="line">	impl, err := typ.Ctor(env)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;Pool&#123;</span><br><span class="line">		impl:     impl,</span><br><span class="line">		workdir:  env.Workdir,</span><br><span class="line">		template: cfg.WorkdirTemplate,</span><br><span class="line">		timeouts: cfg.Timeouts,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦åšçš„äº‹æƒ…æ˜¯ï¼Œé¦–å…ˆè·å–VMç±»å‹ï¼Œéšåå°è£…envç»“æ„ä½“ï¼Œæœ€åè°ƒç”¨<code>VM Pool</code>æ„é€ å‡½æ•°å¹¶è¿”å›ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">	impl        vmimpl.Pool</span><br><span class="line">	workdir     <span class="keyword">string</span></span><br><span class="line">	template    <span class="keyword">string</span></span><br><span class="line">	timeouts    targets.Timeouts</span><br><span class="line">	activeCount <span class="keyword">int32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç®€å•æä¸€ä¸‹Poolç»“æ„ä½“ï¼Œç±»ä¼¼äºçº¿ç¨‹æ± çš„æ¦‚å¿µï¼Œåœ¨<code>syz-manager</code>ä½¿ç”¨ä¸€ä¸ªVMæ± ä¹Ÿå°±æ˜¯Poolç»“æ„ä½“æ¥ç®¡ç†<code>Guest VM</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pool represents a set of test machines (VMs, physical devices, etc) of particular type.</span></span><br><span class="line">type Pool interface &#123;</span><br><span class="line">	<span class="comment">// Count returns total number of VMs in the pool.</span></span><br><span class="line">	Count() <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create creates and boots a new VM instance.</span></span><br><span class="line">	Create(workdir <span class="built_in">string</span>, index <span class="keyword">int</span>) (Instance, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶æ¥å£å®ç°åˆä¸¤ä¸ªå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿”å›å½“å‰æ± å­é‡Œæ‰€æœ‰çš„VMæ•°é‡ï¼Œç¬¬äºŒä¸ªæ˜¯åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå¹¶ä¸”è¿”å›è¿™ä¸ªå®ä¾‹ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">crashdir := filepath.Join(cfg.Workdir, <span class="string">&quot;crashes&quot;</span>)</span><br><span class="line">osutil.MkdirAll(crashdir)</span><br><span class="line"></span><br><span class="line">reporter, err := report.NewReporter(cfg)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å›åˆ°<code>RunManager</code>å‡½æ•°ä¸­ï¼Œè¿™é‡Œä¸»è¦åšçš„äº‹æƒ…æ˜¯åˆ›å»ºä¸€ä¸ª<code>crashes</code>ç›®å½•ï¼Œç„¶åç”Ÿæˆä¸€ä¸ª<code>reporter</code>å®ä¾‹ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Report <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Title contains a representative description of the first oops.</span></span><br><span class="line">	Title <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Alternative titles, used for better deduplication.</span></span><br><span class="line">	<span class="comment">// If two crashes have a non-empty intersection of Title/AltTitles, they are considered the same bug.</span></span><br><span class="line">	AltTitles []<span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Bug type (e.g. hang, memory leak, etc).</span></span><br><span class="line">	Type Type</span><br><span class="line">	<span class="comment">// The indicative function name.</span></span><br><span class="line">	Frame <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Report contains whole oops text.</span></span><br><span class="line">	Report []<span class="keyword">byte</span></span><br><span class="line">	<span class="comment">// Output contains whole raw console output as passed to Reporter.Parse.</span></span><br><span class="line">	Output []<span class="keyword">byte</span></span><br><span class="line">	<span class="comment">// StartPos/EndPos denote region of output with oops message(s).</span></span><br><span class="line">	StartPos <span class="keyword">int</span></span><br><span class="line">	EndPos   <span class="keyword">int</span></span><br><span class="line">	<span class="comment">// SkipPos is position in output where parsing for the next report should start.</span></span><br><span class="line">	SkipPos <span class="keyword">int</span></span><br><span class="line">	<span class="comment">// Suppressed indicates whether the report should not be reported to user.</span></span><br><span class="line">	Suppressed <span class="keyword">bool</span></span><br><span class="line">	<span class="comment">// Corrupted indicates whether the report is truncated of corrupted in some other way.</span></span><br><span class="line">	Corrupted <span class="keyword">bool</span></span><br><span class="line">	<span class="comment">// CorruptedReason contains reason why the report is marked as corrupted.</span></span><br><span class="line">	CorruptedReason <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Recipients is a list of RecipientInfo with Email, Display Name, and type.</span></span><br><span class="line">	Recipients vcs.Recipients</span><br><span class="line">	<span class="comment">// GuiltyFile is the source file that we think is to blame for the crash  (filled in by Symbolize).</span></span><br><span class="line">	GuiltyFile <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// reportPrefixLen is length of additional prefix lines that we added before actual crash report.</span></span><br><span class="line">	reportPrefixLen <span class="keyword">int</span></span><br><span class="line">	<span class="comment">// symbolized is set if the report is symbolized.</span></span><br><span class="line">	symbolized <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Report</code>ç»“æ„ä½“ç”¨æ¥è¡¨ç¤ºå•æ¬¡æ‰§è¡Œçš„ç»“æœï¼ŒåŒ…æ‹¬æ˜¯å¦äº§ç”Ÿäº†<code>crash</code>ã€<code>Oops</code>çš„ä¿¡æ¯ç­‰ç­‰ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">mgr := &amp;Manager&#123;</span><br><span class="line">  cfg:              cfg,</span><br><span class="line">  vmPool:           vmPool,</span><br><span class="line">  target:           cfg.Target,</span><br><span class="line">  sysTarget:        cfg.SysTarget,</span><br><span class="line">  reporter:         reporter,</span><br><span class="line">  crashdir:         crashdir,</span><br><span class="line">  startTime:        time.Now(),</span><br><span class="line">  stats:            &amp;Stats&#123;haveHub: cfg.HubClient != <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">  crashTypes:       <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">  corpus:           <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]CorpusItem),</span><br><span class="line">  disabledHashes:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">  memoryLeakFrames: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">  dataRaceFrames:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">  fresh:            <span class="literal">true</span>,</span><br><span class="line">  vmStop:           <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>),</span><br><span class="line">  hubReproQueue:    <span class="built_in">make</span>(<span class="keyword">chan</span> *Crash, <span class="number">10</span>),</span><br><span class="line">  needMoreRepros:   <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">chan</span> <span class="keyword">bool</span>),</span><br><span class="line">  reproRequest:     <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">chan</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">  usedFiles:        <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]time.Time),</span><br><span class="line">  saturatedCalls:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mgr.preloadCorpus()</span><br><span class="line">mgr.initStats() <span class="comment">// Initializes prometheus variables.</span></span><br><span class="line">mgr.initHTTP()  <span class="comment">// Creates HTTP server.</span></span><br><span class="line">mgr.collectUsedFiles()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create RPC server for fuzzers.</span></span><br><span class="line">mgr.serv, err = startRPCServer(mgr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Fatalf(<span class="string">&quot;failed to create rpc server: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg.DashboardAddr != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">  mgr.dash, err = dashapi.New(cfg.DashboardClient, cfg.DashboardAddr, cfg.DashboardKey)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;failed to create dashapi connection: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !cfg.AssetStorage.IsEmpty() &#123;</span><br><span class="line">  mgr.assetStorage, err = asset.StorageFromConfig(cfg.AssetStorage, mgr.dash)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;failed to init asset storage: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿç€å‡½æ•°æµç¨‹å¾€ä¸‹èµ°ï¼Œé¦–å…ˆè¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ª<code>Manager</code>å®ä¾‹ï¼Œç„¶åä¸‹é¢å››ä¸ªå‡½æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯:</p>
<p><code>mgr.preloadCorpus()</code>: æ£€æŸ¥ <code>corpus.db</code> æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰å¹¶è½½å…¥ <code>sys/linux/test</code> ç›®å½•ä¸‹çš„æµ‹è¯•ç”¨æ¨¡æ¿</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Create an io_uring instance</span><br><span class="line">r0 = syz_io_uring_setup(<span class="number">0xF00</span>, &amp;AUTO=&#123;<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="string">&quot;000000000000000000000000&quot;</span>, [<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>], [<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>]&#125;, &amp;AUTO=&lt;r1=&gt;<span class="number">0x0</span>, &amp;AUTO=&lt;r2=&gt;<span class="number">0x0</span>)</span><br><span class="line"># Set IORING_CQ_EVENTFD_DISABLED. Has no side-effect <span class="keyword">for</span> the test,</span><br><span class="line"><span class="meta"># only tests syz_memcpy_off().</span></span><br><span class="line">syz_memcpy_off$IO_URING_METADATA_FLAGS(r1, <span class="number">0x114</span>, &amp;AUTO=<span class="number">0x1</span>, <span class="number">0x0</span>, AUTO)</span><br><span class="line"># Write an openat2 operation to the submission <span class="built_in">queue</span></span><br><span class="line">syz_io_uring_submit(r1, r2, &amp;AUTO=@IORING_OP_OPENAT2=&#123;AUTO, <span class="number">0x0</span>, AUTO, <span class="number">0xffffffffffffff9c</span>, &amp;AUTO=&#123;<span class="number">0x42</span>, <span class="number">0x0</span>, <span class="number">0x0</span>&#125;, &amp;AUTO=<span class="string">&#x27;./file1\x00&#x27;</span>, AUTO, AUTO, <span class="number">0x12345</span>, &#123;AUTO, <span class="number">0x0</span>, <span class="string">&quot;0000000000000000000000000000000000000000&quot;</span>&#125;&#125;)</span><br><span class="line"># Notify the kernel about the submission <span class="keyword">and</span> wait until completion</span><br><span class="line">io_uring_enter(r0, <span class="number">0x1</span>, <span class="number">0x1</span>, <span class="number">0x1</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)</span><br><span class="line"># Get the resulting fd from the completion <span class="built_in">queue</span></span><br><span class="line">r3 = syz_io_uring_complete(r1)</span><br><span class="line"># Close the file</span><br><span class="line">close(r3)</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šæ˜¯<code>sys/linux/test/io_uring</code>æ¨¡æ¿</p>
<p><code>mgr.initStates()</code>: æ³¨å†Œä¸€ä¸ª prometheus ç›‘è§†å™¨ï¼ˆä¸€ä¸ªå¼€æºçš„ç›‘è§†&amp;é¢„è­¦å·¥å…·åŒ…ï¼‰</p>
<p> <code>mgr.initHTTP()</code>: åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨å¹¶æ³¨å†Œä¸€ç³»åˆ—çš„ç›®å½•</p>
<p><code>mgr.collectUsedFiles()</code>: æ£€æŸ¥æ‰€éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p>
<p>éšåé€šè¿‡<code>startRPCServer</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª<code>RPC</code>æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨ç”¨äºHostä¸<code>Guest VMs</code>è¿›è¡Œé€šä¿¡ã€‚æœ€ååˆå§‹åŒ–<code>dashboard</code>ç›¸å…³å†…å®¹ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Manager <span class="keyword">struct</span> &#123;</span><br><span class="line">	cfg            *mgrconfig.Config</span><br><span class="line">	vmPool         *vm.Pool</span><br><span class="line">	target         *prog.Target</span><br><span class="line">	sysTarget      *targets.Target</span><br><span class="line">	reporter       *report.Reporter</span><br><span class="line">	crashdir       <span class="keyword">string</span></span><br><span class="line">	serv           *RPCServer</span><br><span class="line">	corpusDB       *db.DB</span><br><span class="line">	startTime      time.Time</span><br><span class="line">	firstConnect   time.Time</span><br><span class="line">	fuzzingTime    time.Duration</span><br><span class="line">	stats          *Stats</span><br><span class="line">	crashTypes     <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line">	vmStop         <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">	checkResult    *rpctype.CheckArgs</span><br><span class="line">	fresh          <span class="keyword">bool</span></span><br><span class="line">	numFuzzing     <span class="keyword">uint32</span></span><br><span class="line">	numReproducing <span class="keyword">uint32</span></span><br><span class="line"></span><br><span class="line">	dash *dashapi.Dashboard</span><br><span class="line"></span><br><span class="line">	mu                    sync.Mutex</span><br><span class="line">	phase                 <span class="keyword">int</span></span><br><span class="line">	targetEnabledSyscalls <span class="keyword">map</span>[*prog.Syscall]<span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	candidates       []rpctype.Candidate <span class="comment">// untriaged inputs from corpus and hub</span></span><br><span class="line">	disabledHashes   <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">	corpus           <span class="keyword">map</span>[<span class="keyword">string</span>]CorpusItem</span><br><span class="line">	seeds            [][]<span class="keyword">byte</span></span><br><span class="line">	newRepros        [][]<span class="keyword">byte</span></span><br><span class="line">	lastMinCorpus    <span class="keyword">int</span></span><br><span class="line">	memoryLeakFrames <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line">	dataRaceFrames   <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line">	saturatedCalls   <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	needMoreRepros <span class="keyword">chan</span> <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">	hubReproQueue  <span class="keyword">chan</span> *Crash</span><br><span class="line">	reproRequest   <span class="keyword">chan</span> <span class="keyword">chan</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// For checking that files that we are using are not changing under us.</span></span><br><span class="line">	<span class="comment">// Maps file name to modification time.</span></span><br><span class="line">	usedFiles <span class="keyword">map</span>[<span class="keyword">string</span>]time.Time</span><br><span class="line"></span><br><span class="line">	modules            []host.KernelModule</span><br><span class="line">	coverFilter        <span class="keyword">map</span>[<span class="keyword">uint32</span>]<span class="keyword">uint32</span></span><br><span class="line">	coverFilterBitmap  []<span class="keyword">byte</span></span><br><span class="line">	modulesInitialized <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	assetStorage *asset.Storage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°å°±æ˜¯<code>Manager</code>ç»“æ„ä½“ï¼Œè¿™é‡Œåªè¯´å‡ ä¸ªé‡è¦çš„æˆå‘˜ï¼š</p>
<ul>
<li><code>cfg</code>: åŸºæœ¬è®¾ç½®ä¿¡æ¯ï¼Œå­˜æ”¾åœ¨ä¸€ä¸ªjsonæ–‡ä»¶ä¸­</li>
<li><code>vmPool</code>: æ‰€ç”¨çš„<code>vm Pool</code></li>
<li><code>reporter</code>: ç”¨ä»¥æŠ¥å‘Š<code>crash</code></li>
<li><code>serv</code>: <code>RPC server</code>ç”¨äºä¸<code>Guest VM</code>é€šä¿¡</li>
<li><code>corpusDB</code>: ç”¨äºå­˜æ”¾è¯­æ–™çš„æ•°æ®åº“</li>
<li><code>targetEnabledSyscalls</code>: æµ‹è¯•ç”¨ä¾‹æ‰€å…è®¸ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨</li>
<li><code>candidates</code>: å¾…æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹</li>
<li><code>corpus</code>: è¯­æ–™åº“</li>
<li><code>seeds</code>: ç”¨æ¥å¯¹è¯­æ–™åº“å˜å¼‚çš„ç§å­</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> lastTime := time.Now(); ; &#123;</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">    now := time.Now()</span><br><span class="line">    diff := now.Sub(lastTime)</span><br><span class="line">    lastTime = now</span><br><span class="line">    mgr.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> mgr.firstConnect.IsZero() &#123;</span><br><span class="line">      mgr.mu.Unlock()</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    mgr.fuzzingTime += diff * time.Duration(atomic.LoadUint32(&amp;mgr.numFuzzing))</span><br><span class="line">    executed := mgr.stats.execTotal.get()</span><br><span class="line">    crashes := mgr.stats.crashes.get()</span><br><span class="line">    corpusCover := mgr.stats.corpusCover.get()</span><br><span class="line">    corpusSignal := mgr.stats.corpusSignal.get()</span><br><span class="line">    maxSignal := mgr.stats.maxSignal.get()</span><br><span class="line">    triageQLen := <span class="built_in">len</span>(mgr.candidates)</span><br><span class="line">    mgr.mu.Unlock()</span><br><span class="line">    numReproducing := atomic.LoadUint32(&amp;mgr.numReproducing)</span><br><span class="line">    numFuzzing := atomic.LoadUint32(&amp;mgr.numFuzzing)</span><br><span class="line"></span><br><span class="line">    log.Logf(<span class="number">0</span>, <span class="string">&quot;VMs %v, executed %v, cover %v, signal %v/%v, crashes %v, repro %v, triageQLen %v&quot;</span>,</span><br><span class="line">             numFuzzing, executed, corpusCover, corpusSignal, maxSignal, crashes, numReproducing, triageQLen)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šæ–°èµ·ä¸€ä¸ªå†™æˆè¿›è¡Œæ•°æ®è®°å½•çš„å·¥ä½œï¼Œå‡½æ•°å†…éƒ¨å°±æ˜¯ä¸€ä¸ªforå¾ªç¯å¹¶ä¸”æ²¡æœ‰åœæ­¢çš„ï¼Œå…¶ä½œç”¨å°±æ˜¯æ¯éš”åç§’è¿›è¡Œä¸€æ¬¡è¿›åº¦é‡‡é›†å¹¶è¾“å‡ºæ—¥å¿—ï¼Œä¸»è¦æ˜¯é‡‡é›†æ‰§è¡Œä¿¡æ¯ã€è¯­æ–™è¦†ç›–ç‡ã€crashes ä¿¡æ¯ç­‰ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> *flagBench != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">  mgr.initBench()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> mgr.dash != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="keyword">go</span> mgr.dashboardReporter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">osutil.HandleInterrupts(vm.Shutdown)</span><br><span class="line"><span class="keyword">if</span> mgr.vmPool == <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Logf(<span class="number">0</span>, <span class="string">&quot;no VMs started (type=none)&quot;</span>)</span><br><span class="line">  log.Logf(<span class="number">0</span>, <span class="string">&quot;you are supposed to start syz-fuzzer manually as:&quot;</span>)</span><br><span class="line">  log.Logf(<span class="number">0</span>, <span class="string">&quot;syz-fuzzer -manager=manager.ip:%v [other flags as necessary]&quot;</span>, mgr.serv.port)</span><br><span class="line">  &lt;-vm.Shutdown</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">mgr.vmLoop()</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œè¿™é‡Œä¼šå…ˆåˆ¤æ–­<code>flagBench</code>æ˜¯å¦ä¸ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå¦‚æœä¸ä¸ºç©ºå­—ç¬¦ä¸²åˆ™è°ƒç”¨<code>initBench</code>å‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	flagConfig = flag.String(<span class="string">&quot;config&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;configuration file&quot;</span>)</span><br><span class="line">	flagDebug  = flag.Bool(<span class="string">&quot;debug&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;dump all VM output to console&quot;</span>)</span><br><span class="line">	flagBench  = flag.String(<span class="string">&quot;bench&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;write execution statistics into this file periodically&quot;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>flagBench</code>æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä½¿ç”¨çš„æ˜¯<code>golang</code>çš„flagåŒ…è§£æå‘½ä»¤è¡Œã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">initBench</span><span class="params">()</span></span> &#123;</span><br><span class="line">	f, err := os.OpenFile(*flagBench, os.O_WRONLY|os.O_CREATE|os.O_EXCL, osutil.DefaultFilePerm)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;failed to open bench file: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			time.Sleep(time.Minute)</span><br><span class="line">			vals := mgr.stats.all()</span><br><span class="line">			mgr.mu.Lock()</span><br><span class="line">			<span class="keyword">if</span> mgr.firstConnect.IsZero() &#123;</span><br><span class="line">				mgr.mu.Unlock()</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			mgr.minimizeCorpus()</span><br><span class="line">			vals[<span class="string">&quot;corpus&quot;</span>] = <span class="keyword">uint64</span>(<span class="built_in">len</span>(mgr.corpus))</span><br><span class="line">			vals[<span class="string">&quot;uptime&quot;</span>] = <span class="keyword">uint64</span>(time.Since(mgr.firstConnect)) / <span class="number">1e9</span></span><br><span class="line">			vals[<span class="string">&quot;fuzzing&quot;</span>] = <span class="keyword">uint64</span>(mgr.fuzzingTime) / <span class="number">1e9</span></span><br><span class="line">			vals[<span class="string">&quot;candidates&quot;</span>] = <span class="keyword">uint64</span>(<span class="built_in">len</span>(mgr.candidates))</span><br><span class="line">			mgr.mu.Unlock()</span><br><span class="line"></span><br><span class="line">			data, err := json.MarshalIndent(vals, <span class="string">&quot;&quot;</span>, <span class="string">&quot;  &quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;failed to serialize bench data&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> _, err := f.Write(<span class="built_in">append</span>(data, <span class="string">&#x27;\n&#x27;</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;failed to write bench data&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>initBench</code>ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œè¿™ä¸ªåç¨‹ä¼šæ¯éš”ä¸€åˆ†é’Ÿå¾ªç¯ä¸€æ¬¡ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯è°ƒç”¨<code>minimizeCorpus</code>å°†è¯­æ–™åº“è¿›è¡Œæœ€å°åŒ–ï¼Œæƒ³<code>bench</code>å‚æ•°æŒ‡å®šçš„æ–‡ä»¶å†™å…¥è¯­æ–™åº“é•¿åº¦ã€å¯åŠ¨æ—¶é—´ã€fuzzing æ—¶é—´ã€‚</p>
<p>å›åˆ°<code>RunManager</code>å‡½æ•°ä¸­ï¼Œæ¥ä¸‹æ¥åˆä¼šè°ƒç”¨<code>dashboardReporter</code>å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œè¿™é‡Œçš„ä½œç”¨å°±æ˜¯æ¯éš”ä¸€åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡<code>syz-manager</code>çš„çŠ¶æ€ã€‚</p>
<p>æœ€åæ£€æŸ¥ä¸€ä¸‹<code>VM Pool</code>å¹¶è°ƒç”¨<code>vmloop</code>å‡½æ•°ã€‚</p>
<h2 id="vmloopå‡½æ•°"><a href="#vmloopå‡½æ•°" class="headerlink" title="vmloopå‡½æ•°"></a>vmloopå‡½æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Manager needs to be refactored (#605).</span></span><br><span class="line"><span class="comment">// nolint: gocyclo, gocognit, funlen</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">vmLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.Logf(<span class="number">0</span>, <span class="string">&quot;booting test machines...&quot;</span>)</span><br><span class="line">	log.Logf(<span class="number">0</span>, <span class="string">&quot;wait for the connection from test machine...&quot;</span>)</span><br><span class="line">	instancesPerRepro := <span class="number">3</span></span><br><span class="line">	vmCount := mgr.vmPool.Count()</span><br><span class="line">	maxReproVMs := vmCount - mgr.cfg.FuzzingVMs</span><br><span class="line">	<span class="keyword">if</span> instancesPerRepro &gt; maxReproVMs &amp;&amp; maxReproVMs &gt; <span class="number">0</span> &#123;</span><br><span class="line">		instancesPerRepro = maxReproVMs</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°é¦–å…ˆå¯¹VMè¿›è¡Œåˆ†ç»„ï¼Œä¸€å…±åˆ†ä¸ºä¸¤ç»„ï¼Œä¸€ç»„è´Ÿè´£<code>fuzzing</code>ï¼Œä¸€ç»„è´Ÿè´£å¤ç°<code>crash</code>( maxReproVMs )ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">instances := SequentialResourcePool(vmCount, <span class="number">10</span>*time.Second*mgr.cfg.Timeouts.Scale)</span><br><span class="line">runDone := <span class="built_in">make</span>(<span class="keyword">chan</span> *RunResult, <span class="number">1</span>)</span><br><span class="line">pendingRepro := <span class="built_in">make</span>(<span class="keyword">map</span>[*Crash]<span class="keyword">bool</span>)</span><br><span class="line">reproducing := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line"><span class="keyword">var</span> reproQueue []*Crash</span><br><span class="line">reproDone := <span class="built_in">make</span>(<span class="keyword">chan</span> *ReproResult, <span class="number">1</span>)</span><br><span class="line">stopPending := <span class="literal">false</span></span><br><span class="line">shutdown := vm.Shutdown</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ä¼šè°ƒç”¨<code>SequentialResourcePool</code>å‡½æ•°æ–°å»ºä¸€ä¸ª<code>ResourcePool</code>é˜Ÿåˆ—ï¼Œä¸»è¦è´Ÿè´£å¯¹ç©ºé—²çš„VMçš„ä½¿ç”¨é¡ºåºè¿›è¡Œè°ƒæ§ã€‚</p>
<p>éšåä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—çš„å˜é‡ï¼š</p>
<ul>
<li><code>runDone</code>ï¼šä¿å­˜ fuzzing ç»“æœä¸º crash çš„ Crash é˜Ÿåˆ—</li>
<li><code>pendingRepro</code>ï¼šæ ‡è¯†å¾…å¤ç°çš„ Crash</li>
<li><code>reproducing</code>ï¼šæ ‡è¯†æŸä¸ªç±»å‹ Crash æ˜¯å¦å‡†å¤‡è¢«å¤ç°</li>
<li><code>reproQueue</code>ï¼šCrash çš„å¤ç°é˜Ÿåˆ—</li>
<li><code>reproDone</code>ï¼šCrash çš„å¤ç°ç»“æœ</li>
<li><code>stopPending</code>ï¼šç­‰å¾…åœæ­¢æ ‡å¿—ä½</li>
<li><code>shutdown</code>ï¼šå·¥ä½œç»ˆæ­¢æ ‡å¿—ä½</li>
</ul>
<p>æœ€åè¿›å…¥åˆ°ä¸€ä¸ªå¤§å¾ªç¯ä¸­ï¼Œè€Œè¿™ä¸ªå¤§å¾ªç¯æ‰æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„<code>fuzzing</code>è°ƒæ§æµç¨‹ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> shutdown != <span class="literal">nil</span> || instances.Len() != vmCount &#123;</span><br><span class="line">		mgr.mu.Lock()</span><br><span class="line">		phase := mgr.phase</span><br><span class="line">		mgr.mu.Unlock()</span><br><span class="line">  </span><br><span class="line">  	<span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§å¾ªç¯ç»ˆæ­¢å¾ªç¯çš„æ¡ä»¶æ˜¯<code>shutdown != nil</code>æˆ–è€…<code>ResourcePool</code>ä¸­çš„VMæ•°é‡ä¸æ€»æ•°é‡ä¸ç›¸ç­‰ï¼Œè¿›å…¥å¾ªç¯åé¦–å…ˆåšçš„äº‹å°±æ˜¯è·å–å½“å‰æ‰€è¿›è¡Œçš„é˜¶æ®µã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> crash := <span class="keyword">range</span> pendingRepro &#123;</span><br><span class="line">  <span class="keyword">if</span> reproducing[crash.Title] &#123;</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">delete</span>(pendingRepro, crash)</span><br><span class="line">  <span class="keyword">if</span> !mgr.needRepro(crash) &#123;</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">  &#125;</span><br><span class="line">  log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: add to repro queue &#x27;%v&#x27;&quot;</span>, crash.Title)</span><br><span class="line">  reproducing[crash.Title] = <span class="literal">true</span></span><br><span class="line">  reproQueue = <span class="built_in">append</span>(reproQueue, crash)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç´§æ¥ç€è¿›å…¥åˆ°å†…å±‚å°å¾ªç¯ï¼Œè¿™é‡Œä¼šéå†<code>reproducing</code>ä¸­çš„<code>crash</code>ï¼Œå¦‚æœæ²¡æœ‰è¢«å¤ç°è¿‡åˆ™ä»<code>pendingRepro</code>ä¸­åˆ é™¤ï¼Œéšåè°ƒç”¨<code>mgr.needRepro</code>æ¥çœ‹<code>crash</code>æ˜¯å¦éœ€è¦è¢«å¤ç°ï¼Œåé¢æ ‡è®°è¯¥æ ‡é¢˜çš„<code>crash</code>ä¸ºå·²å¤ç°ï¼Œæœ€ååŠ å…¥åˆ°å¤ç°çš„é˜Ÿåˆ—ä¸­ã€‚</p>
<p>è¿™é‡Œçš„<code>crash.Title</code>ä¸ºOopsçš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œä»ä¸Šé¢çš„é€»è¾‘å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸€æ¬¡åªèƒ½å¤ç°åŒç±»<code>crash</code>ä¸­çš„ä¸€ä¸ªã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: phase=%v shutdown=%v instances=%v/%v %+v repro: pending=%v reproducing=%v queued=%v&quot;</span>,</span><br><span class="line">         phase, shutdown == <span class="literal">nil</span>, instances.Len(), vmCount, instances.Snapshot(),</span><br><span class="line">         <span class="built_in">len</span>(pendingRepro), <span class="built_in">len</span>(reproducing), <span class="built_in">len</span>(reproQueue))</span><br><span class="line"></span><br><span class="line">canRepro := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> phase &gt;= phaseTriagedHub &amp;&amp; <span class="built_in">len</span>(reproQueue) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">  (<span class="keyword">int</span>(atomic.LoadUint32(&amp;mgr.numReproducing))+<span class="number">1</span>)*instancesPerRepro &lt;= maxReproVMs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å…ˆè¾“å‡ºä¸€æ®µæ—¥å¿—ï¼Œéšåå®šä¹‰äº†ä¸€ä¸ªé—­åŒ…å‡½æ•°<code>canRepro</code>ï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½å°±æ˜¯åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿè¿›è¡Œ<code>crash</code>å¤ç°è¿”å›çš„æ˜¯boolç±»å‹ã€‚</p>
<p>é¦–å…ˆä¼šåˆ¤æ–­å½“å‰é˜¶æ®µæ˜¯å¦å·²ç»è¶…è¿‡äº†<code>phaseTriagedHub</code>é˜¶æ®µï¼Œéšååˆ¤æ–­<code>reproQueue</code>ä¹Ÿå°±æ˜¯å¤ç°é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œæœ€ååˆ¤æ–­åŠ ä¸Šè¯¥crashåç”¨äºå¤ç°çš„VMæ˜¯å¦å°äºç­‰äº<code>maxReproVMs</code>ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> shutdown != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> canRepro() &#123;</span><br><span class="line">    vmIndexes := instances.Take(instancesPerRepro)</span><br><span class="line">    <span class="keyword">if</span> vmIndexes == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    last := <span class="built_in">len</span>(reproQueue) - <span class="number">1</span></span><br><span class="line">    crash := reproQueue[last]</span><br><span class="line">    reproQueue[last] = <span class="literal">nil</span></span><br><span class="line">    reproQueue = reproQueue[:last]</span><br><span class="line">    atomic.AddUint32(&amp;mgr.numReproducing, <span class="number">1</span>)</span><br><span class="line">    log.Logf(<span class="number">0</span>, <span class="string">&quot;loop: starting repro of &#x27;%v&#x27; on instances %+v&quot;</span>, crash.Title, vmIndexes)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      reproDone &lt;- mgr.runRepro(crash, vmIndexes, instances.Put)</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> !canRepro() &#123;</span><br><span class="line">    idx := instances.TakeOne()</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: starting instance %v&quot;</span>, *idx)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      crash, err := mgr.runInstance(*idx)</span><br><span class="line">      runDone &lt;- &amp;RunResult&#123;*idx, crash, err&#125;</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆä¼šåˆ¤æ–­<code>shutdown</code>ï¼Œç„¶åè¿›å…¥é“ä¸¤ä¸ªå°å¾ªç¯ä¸­ã€‚é¦–å…ˆçœ‹ç¬¬ä¸€ä¸ªå°å¾ªç¯ï¼Œæ´—è¡£æ­Œå¾ªç¯çš„è¿›å…¥æ¡ä»¶å°±æ˜¯èƒ½å¤Ÿè¿›è¡Œ<code>crash</code>å¤ç°ã€‚</p>
<p>è¿™é‡Œé¦–å…ˆä»èµ„æºæ± ä¸­å–å‡ºä¸€ä¸ª<code>vmIndexes</code>ï¼Œå¦‚æœè¿”å›çš„æ˜¯<code>nil</code>åˆ™ç›´æ¥é€€å‡ºå¾ªç¯ã€‚éšåä»<code>reproQueue</code>ä¸­å–å‡ºä¸€ä¸ª<code>crash</code>ï¼Œéšåæ›´æ–°<code>mgr.numReproducing</code>è®¡æ•°ã€‚éšåæ–°å¼€å¯ä¸€ä¸ªå†™æˆè°ƒç”¨<code>mgr.runRepro</code>å¯¹<code>crash</code>è¿›è¡Œå¤ç°ï¼Œå¹¶å°†è¿”å›å€¼è¾“å…¥åˆ°<code>reproDone</code>é˜Ÿåˆ—ä¸­ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">runRepro</span><span class="params">(crash *Crash, vmIndexes []<span class="keyword">int</span>, putInstances <span class="keyword">func</span>(...<span class="keyword">int</span>)</span>) *<span class="title">ReproResult</span></span> &#123;</span><br><span class="line">	features := mgr.checkResult.Features</span><br><span class="line">	res, stats, err := repro.Run(crash.Output, mgr.cfg, features, mgr.reporter, mgr.vmPool, vmIndexes)</span><br><span class="line">	ret := &amp;ReproResult&#123;</span><br><span class="line">		instances: vmIndexes,</span><br><span class="line">		report0:   crash.Report,</span><br><span class="line">		repro:     res,</span><br><span class="line">		stats:     stats,</span><br><span class="line">		err:       err,</span><br><span class="line">		hub:       crash.hub,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; res != <span class="literal">nil</span> &amp;&amp; mgr.cfg.StraceBin != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// We need only one instance to get strace output, release the rest.</span></span><br><span class="line">		putInstances(vmIndexes[<span class="number">1</span>:]...)</span><br><span class="line">		<span class="keyword">defer</span> putInstances(vmIndexes[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> straceAttempts = <span class="number">2</span></span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= straceAttempts; i++ &#123;</span><br><span class="line">			strace := repro.RunStrace(res, mgr.cfg, mgr.reporter, mgr.vmPool, vmIndexes[<span class="number">0</span>])</span><br><span class="line">			sameBug := strace.IsSameBug(res)</span><br><span class="line">			log.Logf(<span class="number">0</span>, <span class="string">&quot;strace run attempt %d/%d for &#x27;%s&#x27;: same bug %v, error %v&quot;</span>,</span><br><span class="line">				i, straceAttempts, res.Report.Title, sameBug, strace.Error)</span><br><span class="line">			<span class="comment">// We only want to save strace output if it resulted in the same bug.</span></span><br><span class="line">			<span class="comment">// Otherwise, it will be hard to reproduce on syzbot and will confuse users.</span></span><br><span class="line">			<span class="keyword">if</span> sameBug &#123;</span><br><span class="line">				ret.strace = strace</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		putInstances(vmIndexes...)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦åšçš„äº‹æƒ…å…¶å®å°±æ˜¯ç›´æ¥è°ƒç”¨äº†<code>repro.Run</code>å‡½æ•°ï¼Œå¹¶ä¸”åœ¨åé¢è¿›è¡Œäº†ä¸€ä¸‹æ£€æŸ¥ä¹‹åå°†vmé‡æ–°æ”¾å›èµ„æºæ± ä¸­ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(crashLog []<span class="keyword">byte</span>, cfg *mgrconfig.Config, features *host.Features, reporter *report.Reporter,</span></span></span><br><span class="line"><span class="params"><span class="function">	vmPool *vm.Pool, vmIndexes []<span class="keyword">int</span>)</span> <span class="params">(*Result, *Stats, error)</span></span> &#123;</span><br><span class="line">	ctx, err := prepareCtx(crashLog, cfg, features, reporter, <span class="built_in">len</span>(vmIndexes))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		ctx.createInstances(cfg, vmPool)</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="comment">// Prepare VMs in advance.</span></span><br><span class="line">	<span class="keyword">for</span> _, idx := <span class="keyword">range</span> vmIndexes &#123;</span><br><span class="line">		ctx.bootRequests &lt;- idx</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Wait until all VMs are really released.</span></span><br><span class="line">	<span class="keyword">defer</span> wg.Wait()</span><br><span class="line">	<span class="keyword">return</span> ctx.run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œé¦–å…ˆè°ƒç”¨äº†<code>prepareCtx</code>å‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareCtx</span><span class="params">(crashLog []<span class="keyword">byte</span>, cfg *mgrconfig.Config, features *host.Features, reporter *report.Reporter,</span></span></span><br><span class="line"><span class="params"><span class="function">	VMs <span class="keyword">int</span>)</span> <span class="params">(*context, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> VMs == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;no VMs provided&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	entries := cfg.Target.ParseLog(crashLog)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(entries) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, ErrNoPrograms</span><br><span class="line">	&#125;</span><br><span class="line">	crashStart := <span class="built_in">len</span>(crashLog)</span><br><span class="line">	crashTitle, crashType := <span class="string">&quot;&quot;</span>, crash.UnknownType</span><br><span class="line">	<span class="keyword">if</span> rep := reporter.Parse(crashLog); rep != <span class="literal">nil</span> &#123;</span><br><span class="line">		crashStart = rep.StartPos</span><br><span class="line">		crashTitle = rep.Title</span><br><span class="line">		crashType = rep.Type</span><br><span class="line">	&#125;</span><br><span class="line">	testTimeouts := []time.Duration&#123;</span><br><span class="line">		<span class="number">3</span> * cfg.Timeouts.Program, <span class="comment">// to catch simpler crashes (i.e. no races and no hangs)</span></span><br><span class="line">		<span class="number">20</span> * cfg.Timeouts.Program,</span><br><span class="line">		cfg.Timeouts.NoOutputRunningTime, <span class="comment">// to catch &quot;no output&quot;, races and hangs</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> crashTitle == <span class="string">&quot;&quot;</span>:</span><br><span class="line">		crashTitle = <span class="string">&quot;no output/lost connection&quot;</span></span><br><span class="line">		<span class="comment">// Lost connection can be detected faster,</span></span><br><span class="line">		<span class="comment">// but theoretically if it&#x27;s caused by a race it may need the largest timeout.</span></span><br><span class="line">		<span class="comment">// No output can only be reproduced with the max timeout.</span></span><br><span class="line">		<span class="comment">// As a compromise we use the smallest and the largest timeouts.</span></span><br><span class="line">		testTimeouts = []time.Duration&#123;testTimeouts[<span class="number">0</span>], testTimeouts[<span class="number">2</span>]&#125;</span><br><span class="line">	<span class="keyword">case</span> crashType == crash.MemoryLeak:</span><br><span class="line">		<span class="comment">// Memory leaks can&#x27;t be detected quickly because of expensive setup and scanning.</span></span><br><span class="line">		testTimeouts = testTimeouts[<span class="number">1</span>:]</span><br><span class="line">	<span class="keyword">case</span> crashType == crash.Hang:</span><br><span class="line">		testTimeouts = testTimeouts[<span class="number">2</span>:]</span><br><span class="line">	&#125;</span><br><span class="line">	ctx := &amp;context&#123;</span><br><span class="line">		target:       cfg.SysTarget,</span><br><span class="line">		reporter:     reporter,</span><br><span class="line">		crashTitle:   crashTitle,</span><br><span class="line">		crashType:    crashType,</span><br><span class="line">		crashStart:   crashStart,</span><br><span class="line">		entries:      entries,</span><br><span class="line">		instances:    <span class="built_in">make</span>(<span class="keyword">chan</span> *reproInstance, VMs),</span><br><span class="line">		bootRequests: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, VMs),</span><br><span class="line">		testTimeouts: testTimeouts,</span><br><span class="line">		startOpts:    createStartOptions(cfg, features, crashType),</span><br><span class="line">		stats:        <span class="built_in">new</span>(Stats),</span><br><span class="line">		timeouts:     cfg.Timeouts,</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.reproLogf(<span class="number">0</span>, <span class="string">&quot;%v programs, %v VMs, timeouts %v&quot;</span>, <span class="built_in">len</span>(entries), VMs, testTimeouts)</span><br><span class="line">	<span class="keyword">return</span> ctx, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°å†…éƒ¨ä¸»è¦åšçš„äº‹å°±æ˜¯ä¸€äº›æ£€æµ‹ç„¶ååˆå§‹åŒ–ctxï¼Œå‡½æ•°ç»“æŸä¹‹åå®šä¹‰å¯ä¸€ä¸ª<code>sync.WaitGroup</code>ç±»å‹çš„å˜é‡ã€‚éšååˆ›å»ºä¸€ä¸ªæ–°çš„åç¨‹è°ƒç”¨<code>ctx.createInstances</code>å‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *context)</span> <span class="title">createInstances</span><span class="params">(cfg *mgrconfig.Config, vmPool *vm.Pool)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	<span class="keyword">for</span> vmIndex := <span class="keyword">range</span> ctx.bootRequests &#123;</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">		vmIndex := vmIndex</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> inst *instance.ExecProgInstance</span><br><span class="line">			maxTry := <span class="number">3</span></span><br><span class="line">			<span class="keyword">for</span> try := <span class="number">0</span>; try &lt; maxTry; try++ &#123;</span><br><span class="line">				<span class="keyword">select</span> &#123;</span><br><span class="line">				<span class="keyword">case</span> &lt;-vm.Shutdown:</span><br><span class="line">					try = maxTry</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				<span class="keyword">default</span>:</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">var</span> err error</span><br><span class="line">				inst, err = instance.CreateExecProgInstance(vmPool, vmIndex, cfg,</span><br><span class="line">					ctx.reporter, &amp;instance.OptionalConfig&#123;Logf: ctx.reproLogf&#125;)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					ctx.reproLogf(<span class="number">0</span>, <span class="string">&quot;failed to init instance: %v, attempt %d/%d&quot;</span>,</span><br><span class="line">						err, try+<span class="number">1</span>, maxTry)</span><br><span class="line">					time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> inst != <span class="literal">nil</span> &#123;</span><br><span class="line">				ctx.instances &lt;- &amp;reproInstance&#123;execProg: inst, index: vmIndex&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">	wg.Wait()</span><br><span class="line">	<span class="comment">// Clean up.</span></span><br><span class="line">	<span class="built_in">close</span>(ctx.instances)</span><br><span class="line">	<span class="keyword">for</span> inst := <span class="keyword">range</span> ctx.instances &#123;</span><br><span class="line">		inst.execProg.Close()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°ä¸­ï¼Œå¾ªç¯è·å–<code>vmIndex</code>ï¼Œå¹¶ä¸”å¼€å¯æ–°çš„åç¨‹ï¼Œåœ¨æ–°çš„åç¨‹ä¸­è°ƒç”¨<code>instance.CreateExecProgInstance</code>å‡½æ•°åˆ›å»ºVMå¹¶æ‹·è´<code>crash</code>ç¨‹åºï¼Œå¦‚æœå¤±è´¥åˆ™ä¼‘çœ åç§’å¦‚æœæˆåŠŸåˆ™å°†ç»“æœè¾“å‡ºåˆ°<code>ctx.instances</code>ä¸­ï¼Œè¿™é‡Œçš„æœ€å¤šå°è¯•æ¬¡æ•°ä¸º<code>maxTry</code>ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateExecProgInstance</span><span class="params">(vmPool *vm.Pool, vmIndex <span class="keyword">int</span>, mgrCfg *mgrconfig.Config,</span></span></span><br><span class="line"><span class="params"><span class="function">	reporter *report.Reporter, opt *OptionalConfig)</span> <span class="params">(*ExecProgInstance, error)</span></span> &#123;</span><br><span class="line">	vmInst, err := vmPool.Create(vmIndex)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to create VM: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	ret, err := SetupExecProg(vmInst, mgrCfg, reporter, opt)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		vmInst.Close()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>CreateExecProgInstance</code>å‡½æ•°çš„å®ç°å°±æ˜¯é€šè¿‡<code>vmPool.Create</code>åˆ›å»ºå¯åŠ¨è™šæ‹Ÿæœºä¹‹åè°ƒç”¨<code>SetupExecProg</code>å‡½æ•°æ‹·è´è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *context)</span> <span class="title">run</span><span class="params">()</span> <span class="params">(*Result, *Stats, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Indicate that we no longer need VMs.</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="built_in">close</span>(ctx.bootRequests)</span><br><span class="line"></span><br><span class="line">	res, err := ctx.repro()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">		ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;repro crashed as (corrupted=%v):\n%s&quot;</span>,</span><br><span class="line">			ctx.report.Corrupted, ctx.report.Report)</span><br><span class="line">		<span class="comment">// Try to rerun the repro if the report is corrupted.</span></span><br><span class="line">		<span class="keyword">for</span> attempts := <span class="number">0</span>; ctx.report.Corrupted &amp;&amp; attempts &lt; <span class="number">3</span>; attempts++ &#123;</span><br><span class="line">			ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;report is corrupted, running repro again&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> res.CRepro &#123;</span><br><span class="line">				_, err = ctx.testCProg(res.Prog, res.Duration, res.Opts)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				_, err = ctx.testProg(res.Prog, res.Duration, res.Opts)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;final repro crashed as (corrupted=%v):\n%s&quot;</span>,</span><br><span class="line">			ctx.report.Corrupted, ctx.report.Report)</span><br><span class="line">		res.Report = ctx.report</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res, ctx.stats, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å›åˆ°å‰é¢çš„<code>RUN</code>å‡½æ•°ï¼Œæœ€åä¼šè°ƒç”¨åˆ°<code>ctx.run()</code>ï¼Œè¿›å…¥åˆ°ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°ä¸­ï¼Œè€Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­åˆ™æ˜¯è°ƒç”¨<code>ctx.repro()</code>æ­£å¼è¿›è¡Œå¤ç°çš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *context)</span> <span class="title">repro</span><span class="params">()</span> <span class="params">(*Result, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Cut programs that were executed after crash.</span></span><br><span class="line">	<span class="keyword">for</span> i, ent := <span class="keyword">range</span> ctx.entries &#123;</span><br><span class="line">		<span class="keyword">if</span> ent.Start &gt; ctx.crashStart &#123;</span><br><span class="line">			ctx.entries = ctx.entries[:i]</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reproStart := time.Now()</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;reproducing took %s&quot;</span>, time.Since(reproStart))</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	res, err := ctx.extractProg(ctx.entries)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> res == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">			res.Opts.Repro = <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	res, err = ctx.minimizeProg(res)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Try extracting C repro without simplifying options first.</span></span><br><span class="line">	res, err = ctx.extractC(res)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Simplify options and try extracting C repro.</span></span><br><span class="line">	<span class="keyword">if</span> !res.CRepro &#123;</span><br><span class="line">		res, err = ctx.simplifyProg(res)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Simplify C related options.</span></span><br><span class="line">	<span class="keyword">if</span> res.CRepro &#123;</span><br><span class="line">		res, err = ctx.simplifyC(res)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆä¼šå»é™¤æ‰å‘ç”Ÿ<code>crash</code>ä¹‹åæ‰§è¡Œçš„ç¨‹åºï¼Œéšåè°ƒç”¨<code>ctx.extractProg</code>è·å–è§¦å‘<code>crash</code>çš„é›†åˆï¼Œæ¥ç€è°ƒç”¨<code>ctx.minimizeProg</code>å°è¯•æœ€å°åŒ–ç¨‹åºé›†åˆï¼Œè°ƒç”¨<code>ctx.extractC</code>å‡½æ•°å°è¯•åœ¨ä¸ç®€åŒ–é…ç½®çš„æƒ…å†µä¸‹æå–<code>C repro</code>ï¼Œç„¶åè°ƒç”¨<code>ctx.simplifyProg</code>ç®€åŒ–é…ç½®å¹¶å°è¯•æå–<code>C repro</code>ï¼Œæœ€åè°ƒç”¨<code>ctx.simplifyC</code>ç®€åŒ–Cç›¸å…³é…ç½®ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *context)</span> <span class="title">extractProg</span><span class="params">(entries []*prog.LogEntry)</span> <span class="params">(*Result, error)</span></span> &#123;</span><br><span class="line">	ctx.reproLogf(<span class="number">2</span>, <span class="string">&quot;extracting reproducer from %v programs&quot;</span>, <span class="built_in">len</span>(entries))</span><br><span class="line">	start := time.Now()</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		ctx.stats.ExtractProgTime = time.Since(start)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Extract last program on every proc.</span></span><br><span class="line">	procs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line">	<span class="keyword">for</span> i, ent := <span class="keyword">range</span> entries &#123;</span><br><span class="line">		procs[ent.Proc] = i</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> indices []<span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> _, idx := <span class="keyword">range</span> procs &#123;</span><br><span class="line">		indices = <span class="built_in">append</span>(indices, idx)</span><br><span class="line">	&#125;</span><br><span class="line">	sort.Ints(indices)</span><br><span class="line">	<span class="keyword">var</span> lastEntries []*prog.LogEntry</span><br><span class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(indices) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">		lastEntries = <span class="built_in">append</span>(lastEntries, entries[indices[i]])</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, timeout := <span class="keyword">range</span> ctx.testTimeouts &#123;</span><br><span class="line">		<span class="comment">// Execute each program separately to detect simple crashes caused by a single program.</span></span><br><span class="line">		<span class="comment">// Programs are executed in reverse order, usually the last program is the guilty one.</span></span><br><span class="line">		res, err := ctx.extractProgSingle(lastEntries, timeout)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">			ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="built_in">len</span>(res.Prog.Calls))</span><br><span class="line">			<span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Don&#x27;t try bisecting if there&#x27;s only one entry.</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(entries) == <span class="number">1</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Execute all programs and bisect the log to find multiple guilty programs.</span></span><br><span class="line">		res, err = ctx.extractProgBisect(entries, timeout)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">			ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="built_in">len</span>(res.Prog.Calls))</span><br><span class="line">			<span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx.reproLogf(<span class="number">0</span>, <span class="string">&quot;failed to extract reproducer&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°å¼€å§‹ä½ç½®é¦–å…ˆå°†ç¨‹åºé€†åºï¼Œéšåè°ƒç”¨<code>ctx.extractProgSingle</code>é€ä¸ªè¿è¡Œå•ä¸ªç¨‹åºï¼Œå¦‚æœé‡åˆ°<code>crash</code>åˆ™ç«‹åˆ»è¿”å›ï¼ˆä¸€èˆ¬æ¥è¯´éƒ½æ˜¯æœ€åä¸€ä¸ªç¨‹åºå¼•èµ·çš„ï¼‰ã€‚å¦‚æœæ²¡èƒ½æ‰¾åˆ°åˆ™ä¼šè¿›å…¥åˆ°ä¸‹é¢çš„åˆ¤æ–­ä¸­ï¼Œå¦‚æœç¨‹åºä¸ªæ•°ä¸ä¸º1åˆ™ä¼šè¿›å…¥åˆ°<code>ctx.extractProgBisect</code>å‡½æ•°è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾æ‰¾å‡º<code>crash</code>ç¨‹åºé›†åˆã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> !canRepro() &#123;</span><br><span class="line">  idx := instances.TakeOne()</span><br><span class="line">  <span class="keyword">if</span> idx == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: starting instance %v&quot;</span>, *idx)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    crash, err := mgr.runInstance(*idx)</span><br><span class="line">    runDone &lt;- &amp;RunResult&#123;*idx, crash, err&#125;</span><br><span class="line">  &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨çœ‹å‰é¢çš„ä¸¤ä¸ªå°å¾ªç¯ä¸­çš„ç¬¬äºŒä¸ªå¾ªç¯ï¼Œç¬¬äºŒä¸ªå¾ªç¯çš„æ¡ä»¶ä¸ºä¸èƒ½è¿›è¡Œ<code>crash</code>å¤ç°ï¼Œæ‰€ä»¥è¿™é‡Œè¿›å…¥åç¨‹å°†å‰©ä½™çš„VMè°ƒåº¦å»fuzzå¹¶å°†ç»“æœè¾“å‡ºåˆ°<code>runDone</code>ä¸­å»ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">runInstance</span><span class="params">(index <span class="keyword">int</span>)</span> <span class="params">(*Crash, error)</span></span> &#123;</span><br><span class="line">	mgr.checkUsedFiles()</span><br><span class="line">	instanceName := fmt.Sprintf(<span class="string">&quot;vm-%d&quot;</span>, index)</span><br><span class="line"></span><br><span class="line">	rep, vmInfo, err := mgr.runInstanceInner(index, instanceName)</span><br><span class="line"></span><br><span class="line">	machineInfo := mgr.serv.shutdownInstance(instanceName)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(vmInfo) != <span class="number">0</span> &#123;</span><br><span class="line">		machineInfo = <span class="built_in">append</span>(<span class="built_in">append</span>(vmInfo, <span class="string">&#x27;\n&#x27;</span>), machineInfo...)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Error that is not a VM crash.</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// No crash.</span></span><br><span class="line">	<span class="keyword">if</span> rep == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	crash := &amp;Crash&#123;</span><br><span class="line">		vmIndex:     index,</span><br><span class="line">		hub:         <span class="literal">false</span>,</span><br><span class="line">		Report:      rep,</span><br><span class="line">		machineInfo: machineInfo,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> crash, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°å®é™…è°ƒç”¨çš„æ˜¯<code>mgr.runInstanceInner</code>å‡½æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">runInstanceInner</span><span class="params">(index <span class="keyword">int</span>, instanceName <span class="keyword">string</span>)</span> <span class="params">(*report.Report, []<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	inst, err := mgr.vmPool.Create(index)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to create instance: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> inst.Close()</span><br><span class="line"></span><br><span class="line">	fwdAddr, err := inst.Forward(mgr.serv.port)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to setup port forwarding: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fuzzerBin, err := inst.Copy(mgr.cfg.FuzzerBin)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to copy binary: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If ExecutorBin is provided, it means that syz-executor is already in the image,</span></span><br><span class="line">	<span class="comment">// so no need to copy it.</span></span><br><span class="line">	executorBin := mgr.sysTarget.ExecutorBin</span><br><span class="line">	<span class="keyword">if</span> executorBin == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		executorBin, err = inst.Copy(mgr.cfg.ExecutorBin)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to copy binary: %w&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fuzzerV := <span class="number">0</span></span><br><span class="line">	procs := mgr.cfg.Procs</span><br><span class="line">	<span class="keyword">if</span> *flagDebug &#123;</span><br><span class="line">		fuzzerV = <span class="number">100</span></span><br><span class="line">		procs = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Run the fuzzer binary.</span></span><br><span class="line">	start := time.Now()</span><br><span class="line">	atomic.AddUint32(&amp;mgr.numFuzzing, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">defer</span> atomic.AddUint32(&amp;mgr.numFuzzing, ^<span class="keyword">uint32</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">	args := &amp;instance.FuzzerCmdArgs&#123;</span><br><span class="line">		Fuzzer:    fuzzerBin,</span><br><span class="line">		Executor:  executorBin,</span><br><span class="line">		Name:      instanceName,</span><br><span class="line">		OS:        mgr.cfg.TargetOS,</span><br><span class="line">		Arch:      mgr.cfg.TargetArch,</span><br><span class="line">		FwdAddr:   fwdAddr,</span><br><span class="line">		Sandbox:   mgr.cfg.Sandbox,</span><br><span class="line">		Procs:     procs,</span><br><span class="line">		Verbosity: fuzzerV,</span><br><span class="line">		Cover:     mgr.cfg.Cover,</span><br><span class="line">		Debug:     *flagDebug,</span><br><span class="line">		Test:      <span class="literal">false</span>,</span><br><span class="line">		Runtest:   <span class="literal">false</span>,</span><br><span class="line">		Optional: &amp;instance.OptionalFuzzerArgs&#123;</span><br><span class="line">			Slowdown:   mgr.cfg.Timeouts.Slowdown,</span><br><span class="line">			RawCover:   mgr.cfg.RawCover,</span><br><span class="line">			SandboxArg: mgr.cfg.SandboxArg,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	cmd := instance.FuzzerCmd(args)</span><br><span class="line">	outc, errc, err := inst.Run(mgr.cfg.Timeouts.VMRunningTime, mgr.vmStop, cmd)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to run fuzzer: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> vmInfo []<span class="keyword">byte</span></span><br><span class="line">	rep := inst.MonitorExecution(outc, errc, mgr.reporter, vm.ExitTimeout)</span><br><span class="line">	<span class="keyword">if</span> rep == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// This is the only &quot;OK&quot; outcome.</span></span><br><span class="line">		log.Logf(<span class="number">0</span>, <span class="string">&quot;%s: running for %v, restarting&quot;</span>, instanceName, time.Since(start))</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		vmInfo, err = inst.Info()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			vmInfo = []<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">&quot;error getting VM info: %v\n&quot;</span>, err))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rep, vmInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆè°ƒç”¨<code>mgr.vmPool.Create</code>åˆ›å»ºVMï¼Œéšåè°ƒç”¨<code>inst.Forward</code>è¿›è¡ŒTCPè½¬å‘ï¼Œç„¶åé€šè¿‡<code>inst.Copy</code>æ‹·è´<code>syz-fuzzer</code>å’Œ<code>syz-executor</code>åˆ°VMæ–‡ä»¶ç³»ç»Ÿä¸‹ã€‚éšåè°ƒç”¨<code>instance.FuzzerCmd</code>å‡½æ•°ç”Ÿæˆå‘½ä»¤è¡Œåè°ƒç”¨<code>inst.Run</code>å‡½æ•°å¯åŠ¨<code>syz-fuzzer</code>ï¼Œéšåè°ƒç”¨<code>inst.MonitorExecution</code>ç›‘è§†VMè¿è¡Œï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯é€šè¿‡è·å–<code>kernel oops</code>æ¥åˆ¤æ–­æ˜¯å¦å‡ºç°äº†<code>crash</code>ã€‚</p>
<p>è¿™é‡Œæä¸€ä¸‹vmå®ä¾‹ï¼Œåœ¨<code>syz-manaer</code>ä¸­çš„vmå®ä¾‹å…¶å®æ˜¯å¦‚ä¸‹ç»“æ„ä½“è¡¨ç¤ºçš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Instance <span class="keyword">struct</span> &#123;</span><br><span class="line">	impl     vmimpl.Instance</span><br><span class="line">	workdir  <span class="keyword">string</span></span><br><span class="line">	timeouts targets.Timeouts</span><br><span class="line">	index    <span class="keyword">int</span></span><br><span class="line">	onClose  <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶éœ€è¦å®šä¹‰ä¸€äº›<code>interface</code>æ¥å£</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Instance <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Copy copies a hostSrc file into VM and returns file name in VM.</span></span><br><span class="line">	Copy(hostSrc <span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Forward sets up forwarding from within VM to the given tcp</span></span><br><span class="line">	<span class="comment">// port on the host and returns the address to use in VM.</span></span><br><span class="line">	Forward(port <span class="keyword">int</span>) (<span class="keyword">string</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Run runs cmd inside of the VM (think of ssh cmd).</span></span><br><span class="line">	<span class="comment">// outc receives combined cmd and kernel console output.</span></span><br><span class="line">	<span class="comment">// errc receives either command Wait return error or vmimpl.ErrTimeout.</span></span><br><span class="line">	<span class="comment">// Command is terminated after timeout. Send on the stop chan can be used to terminate it earlier.</span></span><br><span class="line">	Run(timeout time.Duration, stop &lt;-<span class="keyword">chan</span> <span class="keyword">bool</span>, command <span class="keyword">string</span>) (outc &lt;-<span class="keyword">chan</span> []<span class="keyword">byte</span>, errc &lt;-<span class="keyword">chan</span> error, err error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Diagnose retrieves additional debugging info from the VM</span></span><br><span class="line">	<span class="comment">// (e.g. by sending some sys-rq&#x27;s or SIGABORT&#x27;ing a Go program).</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Optionally returns (some or all) of the info directly. If wait == true,</span></span><br><span class="line">	<span class="comment">// the caller must wait for the VM to output info directly to its log.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// rep describes the reason why Diagnose was called.</span></span><br><span class="line">	Diagnose(rep *report.Report) (diagnosis []<span class="keyword">byte</span>, wait <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Close stops and destroys the VM.</span></span><br><span class="line">	Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  <code>Copy()</code>ï¼šå°†ä¸€ä¸ªæ¥è‡ªå®¿ä¸»æœºçš„æ–‡ä»¶æ‹·è´è‡³è™šæ‹Ÿæœºä¸­ï¼Œè¿”å›è™šæ‹Ÿæœºä¸­çš„æ–‡ä»¶å</p>
<p>  <code>Forward()</code>ï¼šè®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œå¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€</p>
<p>  <code>Run()</code>ï¼šåœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤</p>
<p>  <code>Diagnose()</code>ï¼šåœ¨è™šæ‹Ÿæœºä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</p>
<p>  <code>Close()</code>ï¼šåœæ­¢å¹¶é”€æ¯è™šæ‹Ÿæœº</p>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸åŒçš„<code>guest VM</code>æ‰€å®ç°çš„<code>interface</code>æ˜¯ä¸åŒçš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">vmLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">	<span class="keyword">for</span> shutdown != <span class="literal">nil</span> || instances.Len() != vmCount &#123;</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line">		<span class="keyword">var</span> stopRequest <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">		<span class="keyword">if</span> !stopPending &amp;&amp; canRepro() &#123;</span><br><span class="line">			stopRequest = mgr.vmStop</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	wait:</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-instances.Freed:</span><br><span class="line">			<span class="comment">// An instance has been released.</span></span><br><span class="line">		<span class="keyword">case</span> stopRequest &lt;- <span class="literal">true</span>:</span><br><span class="line">			log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: issued stop request&quot;</span>)</span><br><span class="line">			stopPending = <span class="literal">true</span></span><br><span class="line">		<span class="keyword">case</span> res := &lt;-runDone:</span><br><span class="line">			log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: instance %v finished, crash=%v&quot;</span>, res.idx, res.crash != <span class="literal">nil</span>)</span><br><span class="line">			<span class="keyword">if</span> res.err != <span class="literal">nil</span> &amp;&amp; shutdown != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Logf(<span class="number">0</span>, <span class="string">&quot;%v&quot;</span>, res.err)</span><br><span class="line">			&#125;</span><br><span class="line">			stopPending = <span class="literal">false</span></span><br><span class="line">			instances.Put(res.idx)</span><br><span class="line">			<span class="comment">// On shutdown qemu crashes with &quot;qemu: terminating on signal 2&quot;,</span></span><br><span class="line">			<span class="comment">// which we detect as &quot;lost connection&quot;. Don&#x27;t save that as crash.</span></span><br><span class="line">			<span class="keyword">if</span> shutdown != <span class="literal">nil</span> &amp;&amp; res.crash != <span class="literal">nil</span> &#123;</span><br><span class="line">				needRepro := mgr.saveCrash(res.crash)</span><br><span class="line">				<span class="keyword">if</span> needRepro &#123;</span><br><span class="line">					log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: add pending repro for &#x27;%v&#x27;&quot;</span>, res.crash.Title)</span><br><span class="line">					pendingRepro[res.crash] = <span class="literal">true</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> res := &lt;-reproDone:</span><br><span class="line">			atomic.AddUint32(&amp;mgr.numReproducing, ^<span class="keyword">uint32</span>(<span class="number">0</span>))</span><br><span class="line">			crepro := <span class="literal">false</span></span><br><span class="line">			title := <span class="string">&quot;&quot;</span></span><br><span class="line">			<span class="keyword">if</span> res.repro != <span class="literal">nil</span> &#123;</span><br><span class="line">				crepro = res.repro.CRepro</span><br><span class="line">				title = res.repro.Report.Title</span><br><span class="line">			&#125;</span><br><span class="line">			log.Logf(<span class="number">0</span>, <span class="string">&quot;loop: repro on %+v finished &#x27;%v&#x27;, repro=%v crepro=%v desc=&#x27;%v&#x27;&quot;</span>,</span><br><span class="line">				res.instances, res.report0.Title, res.repro != <span class="literal">nil</span>, crepro, title)</span><br><span class="line">			<span class="keyword">if</span> res.err != <span class="literal">nil</span> &#123;</span><br><span class="line">				reportReproError(res.err)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">delete</span>(reproducing, res.report0.Title)</span><br><span class="line">			<span class="keyword">if</span> res.repro == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> !res.hub &#123;</span><br><span class="line">					mgr.saveFailedRepro(res.report0, res.stats)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				mgr.saveRepro(res)</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> &lt;-shutdown:</span><br><span class="line">			log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: shutting down...&quot;</span>)</span><br><span class="line">			shutdown = <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">case</span> crash := &lt;-mgr.hubReproQueue:</span><br><span class="line">			log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: get repro from hub&quot;</span>)</span><br><span class="line">			pendingRepro[crash] = <span class="literal">true</span></span><br><span class="line">		<span class="keyword">case</span> reply := &lt;-mgr.needMoreRepros:</span><br><span class="line">			reply &lt;- phase &gt;= phaseTriagedHub &amp;&amp;</span><br><span class="line">				<span class="built_in">len</span>(reproQueue)+<span class="built_in">len</span>(pendingRepro)+<span class="built_in">len</span>(reproducing) == <span class="number">0</span></span><br><span class="line">			<span class="keyword">goto</span> wait</span><br><span class="line">		<span class="keyword">case</span> reply := &lt;-mgr.reproRequest:</span><br><span class="line">			repros := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line">			<span class="keyword">for</span> title := <span class="keyword">range</span> reproducing &#123;</span><br><span class="line">				repros[title] = <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">			reply &lt;- repros</span><br><span class="line">			<span class="keyword">goto</span> wait</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥æœ€åé˜¶æ®µï¼Œç­‰å¾…å¤„ç†ä¸åŒçš„<code>channel</code>æ•°æ®ï¼Œè¿™é‡Œé€<code>case</code>åˆ†æã€‚</p>
<p>é¦–å…ˆç¬¬ä¸€ä¸ªçš„è§¦å‘æ¡ä»¶ä¸º<code>instances.Freed</code>å³å½“ç©ºé—´çš„VMè¢«<code>Put</code>è¿”å›èµ„æºæ± æ—¶åˆ™ä¼šå‘è¯¥<code>channel</code>é€å…¥ä¸€ä¸ª<code>true</code>ï¼Œè¿›å…¥å…¶ä»£ç å—ï¼Œä½†æ˜¯å¹¶æ²¡åšä»€ä¹ˆäº‹æƒ…ã€‚</p>
<p>ç¬¬äºŒä¸ªçš„æ¡ä»¶å¯ä»¥æ³¨æ„åˆ°å‰é¢çš„èµ‹å€¼æ“ä½œ<code>stopRequest</code>å…¶å®å°±æ˜¯<code>mgr.vmStop</code>ï¼Œè€Œè¿™ä¸ª<code>channel</code>ä¼šåœ¨VM instanceçš„<code>RUN</code>å‡½æ•°ä¸­ä½¿ç”¨ã€‚</p>
<p>ç¬¬ä¸‰ä¸ªçš„æ¡ä»¶ä¸º<code>res := &lt;-runDone</code>å½“<code>runDone</code>ä¸­æœ‰æ•°æ®æ—¶è¿›å…¥ï¼Œå…¶æœ‰æ•°æ®ä»£è¡¨çš„æ˜¯æœ‰<code>crash</code>äº§ç”Ÿäº†ï¼Œè¿™é‡Œä¸»è¦åšçš„äº‹å°±æ˜¯å°†<code>crash</code>åŠ å…¥åˆ°<code>pendingRepro</code>ä¸­ã€‚</p>
<p>ç¬¬å››ä¸ªçš„æ¡ä»¶å°±æ˜¯å¤ç°æ—¶å‡ºç°ç»“æœï¼Œè¿™é‡Œä¸»è¦åšçš„äº‹æƒ…æ˜¯ï¼Œä»<code>reproducing</code>åˆ é™¤å¯¹åº”çš„<code>crash</code>ï¼Œéšåä¿å­˜å¤ç°ç»“æœã€‚</p>
<p>ç¬¬äº”ä¸ªæ¡ä»¶å°±æ˜¯å­˜åœ¨ç»ˆæ­¢ä¿¡å·ã€‚</p>
<p>ç¬¬å…­ä¸ªåˆ™æ˜¯<code>hubReproQueue</code>ä¹Ÿå¯èƒ½ä¼ æ¥<code>crash</code>ï¼Œå¦‚æœä¼ æ¥äº†<code>crash</code>åˆ™å°†å…¶åŠ å…¥åˆ°<code>pendingRepro</code>ä¸­ã€‚</p>
<p>ç¬¬ä¸ƒä¸ªæ ¹æ®<code>mgr.needMoreRepros</code>å­—é¢æ„æ€å°±æ˜¯éœ€è¦æ›´å¤šçš„<code>repros</code>ï¼Œå…¶å†…éƒ¨ä»£ç å°±æ˜¯åˆ¤æ–­å½“å‰é˜¶æ®µä»¥åŠç­‰å¾…å¤ç°ã€å¤ç°é˜Ÿåˆ—ã€å¤ç°ä¸­çš„æ•°é‡æ˜¯å¦ä¸º0å¹¶å°†æœ€åçš„ç»“æœè¿”å›åˆ°<code>channel</code>ä¸­å¹¶åœ¨æ­¤è¿è¡Œ<code>wait</code>é‡æ–°ç­‰å¾…ã€‚</p>
<p>æœ€å<code>mgr.reproRequest</code>æ„ä¸ºä¸»åŠ¨è¯·æ±‚å¤ç°ï¼Œè¿™é‡Œä¼šæ‹·è´<code>reproducing</code>çš„ä½å›¾å¹¶è¿”å›åˆ°<code>channel</code>ä¸­æœ€åè·³è½¬<code>wait</code>é‡æ–°ç­‰å¾…ã€‚</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/fuzzing/">fuzzing</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/syzkaller/">syzkaller</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/11/23/Pspray-Timing-Side-Channel-based-Linux-Kernel-Heap-Exploitation-Technique/"
                                   title="Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/11/10/syzkaller%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"
                                   title="syzkalleråŸºæœ¬ä½¿ç”¨"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">syzkalleråŸºæœ¬ä½¿ç”¨</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RunManager%E5%87%BD%E6%95%B0"><span class="nav-text">RunManagerå‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vmloop%E5%87%BD%E6%95%B0"><span class="nav-text">vmloopå‡½æ•°</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">335.6k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RunManager%E5%87%BD%E6%95%B0"><span class="nav-text">RunManagerå‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vmloop%E5%87%BD%E6%95%B0"><span class="nav-text">vmloopå‡½æ•°</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
