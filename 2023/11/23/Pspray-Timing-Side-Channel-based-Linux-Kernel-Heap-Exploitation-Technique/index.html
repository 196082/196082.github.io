<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/rocket-lunch.svg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/rocket-lunch.svg"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-11-23 17:05:25</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Nov 29 2023 18:14:05 GMT+0800">2023-11-29 18:14:05</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E5%A0%86%E5%96%B7%E5%B0%84/">å †å–·å°„</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB/">ä¾§ä¿¡é“æ”»å‡»</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/slab%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">slabæºç åˆ†æ</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>8.3k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>39 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿‘æœŸåœ¨å·¥ä½œä¸Šé‡åˆ°çš„å†…æ ¸å¾ˆå°‘ï¼Œä»¥è‡³äºæˆ‘éƒ½å¿«å¿˜è®°äº†æˆ‘æ˜¯ç©å†…æ ¸çš„äº†ã€‚è¿™ç¯‡æ–‡ç« éœ€è¦ä¸€ç‚¹<code>slub allocator</code>çš„åŸºç¡€ï¼Œæ‰€ä»¥ä¸ºä»€ä¹ˆæˆ‘ä»¥å‰è¦å·æ‡’ä¸å†™<code>slub allocator</code>å•Šï¼ï¼ï¼å½“ç„¶è¿™äº›åŸºç¡€åœ¨ä»¥å‰éƒ½æ˜¯é»˜è®¤å¤§å®¶éƒ½å·²ç»å­¦ä¹ è¿‡çš„äº†ï¼Œåœ¨è¿™é‡Œè™½ç„¶å¯ä»¥ä¸€æ ·è¿™æ ·ï¼Œä½†æ˜¯æˆ‘è§‰å¾—å¦‚æœå†ä¸åˆ†æä»¥åå¯èƒ½å°±æ²¡å¤šå°‘æ—¶é—´å†™è¿™ç±»åˆ†æç»†è‡´çš„æ–‡ç« äº†ã€‚</p>
<h2 id="slub-allocatoråŸºæœ¬ç»“æ„"><a href="#slub-allocatoråŸºæœ¬ç»“æ„" class="headerlink" title="slub allocatoråŸºæœ¬ç»“æ„"></a>slub allocatoråŸºæœ¬ç»“æ„</h2><p><img   src="/images/ivPnbsjHyI94m5z.png" ></p>
<p>ä¸Šé¢è¿™å¼ overviewå¤§å®¶åº”è¯¥éƒ½æŒºç†Ÿæ‚‰çš„ã€‚</p>
<p>äº†è§£è¿‡Linux kernelå†…å­˜ç®¡ç†çš„æœ‹å‹åº”è¯¥çŸ¥é“<code>slab allocator</code>ä¸»è¦æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼š</p>
<ol>
<li>slab  æœ€åˆçš„ç‰ˆæœ¬ï¼Œæœºåˆ¶å¤æ‚ï¼Œæ•ˆç‡ä½</li>
<li>slob  ç”¨äºåµŒå…¥å¼åœºæ™¯çš„æç®€ç‰ˆæœ¬</li>
<li>slub  ä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼Œç°åœ¨å¸¸ç”¨</li>
</ol>
<p>æ‰€ä»¥åé¢å‡å·²slubä¸ºä¾‹ã€‚</p>
<h3 id="slab"><a href="#slab" class="headerlink" title="slab"></a>slab</h3><p>Linux kernel ä¸­ç”¨ä»¥ç»Ÿç­¹æ‰€æœ‰å†…å­˜çš„ä¾ç„¶æ˜¯<code>buddy system</code>ï¼Œ<code>slub allocator</code>ä¹Ÿä¸ä¾‹å¤–ï¼Œå…¶è´Ÿè´£å‘<code>buddy system</code>è¯·æ±‚å†…å­˜ååˆ†å‰²ç»™å¤šä¸ªå° object åå†è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼Œå•æ¬¡å‘<code>buddy system</code>æ‰€è¯·æ±‚çš„ä¸€ä»½è¿ç»­å†…å­˜é¡µä¾¿ç§°ä¹‹ä¸ºä¸€å¼  slabï¼Œåœ¨å†…æ ¸ä¸­å¯¹åº” <code>slab</code> ç»“æ„ä½“ï¼Œæœ¬è´¨ä¸Šæ˜¯å¤ç”¨ page ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> __page_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_SLAB)</span></span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_SLUB)</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">next</span>;</span></span><br><span class="line">					<span class="keyword">int</span> slabs;	<span class="comment">/* Nr of slabs left */</span></span><br><span class="line">				&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="comment">/* Double-word boundary */</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">					<span class="keyword">void</span> *freelist;		<span class="comment">/* first free object */</span></span><br><span class="line">					<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">						<span class="keyword">unsigned</span> <span class="keyword">long</span> counters;</span><br><span class="line">						<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">							<span class="keyword">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line">							<span class="keyword">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line">							<span class="keyword">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">						&#125;;</span><br><span class="line">					&#125;;</span><br><span class="line">				&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> system_has_freelist_aba</span></span><br><span class="line">				<span class="keyword">freelist_aba_t</span> freelist_counter;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> __unused;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;Unexpected slab allocator configured&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">atomic_t</span> __page_refcount;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹å‰é¢çš„æˆå‘˜ï¼š</p>
<ul>
<li><code>slab_cache</code>: è¯¥slabå¯¹åº”çš„å†…å­˜æ± </li>
<li><code>freelist</code>: slabä¸Šç©ºé—²çš„ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œå½¢å¼ä¸ºå•å‘é“¾è¡¨ä»¥NULLç»“å°¾</li>
<li><code>slab_list</code>: æŒ‰ç…§å…¶ç”¨é€”è¿æ¥å¤šä¸ªslabsåŒå‘é“¾è¡¨</li>
<li><code>inuse</code>: å·²è¢«ä½¿ç”¨çš„å¯¹è±¡æ•°é‡</li>
<li><code>objects</code>: è¯¥slabä¸Šçš„å¯¹è±¡æ€»æ•°</li>
<li><code>frozen</code>: æ˜¯å¦è¢«å†»ç»“ï¼Œå³å…¶å·²ç»å½’å±äºç‰¹å®šçš„CPU</li>
</ul>
<blockquote>
<p>  è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ <strong>counters æˆå‘˜ç›´æ¥æ¶µç›–äº† inuse &amp; objects &amp; frozen</strong>ï¼Œåé¢ä¼šæœ‰å¤§é‡çš„ç›´æ¥é€šè¿‡ counters æˆå‘˜è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œ<strong>å®é™…ä¸Šå°±æ˜¯èµ‹å€¼äº† inuse &amp; objects &amp; frozen</strong></p>
</blockquote>
<p>å’Œpageç»“æ„ä½“ç±»ä¼¼ï¼Œè¿™é‡Œslabä¹Ÿæ˜¯å¯¹åº”ä¸€å¼ slabå†…å­˜é¡µï¼Œå¯ä»¥é€šè¿‡<code>page_to_pfn</code>å‡½æ•°ç­‰å¯ä»¥ç›´æ¥å®Œæˆslabç»“æ„ä½“åˆ°å†…å­˜é¡µè™šæ‹Ÿåœ°å€çš„è½¬åŒ–ï¼Œå½“ç„¶åè¿‡æ¥ä¹Ÿå¯ä»¥ä»ä¸€ä¸ªç©ºé—²ç©ºé—´çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ°å…¶å¯¹åº”çš„slabç»“æ„ä½“ã€‚</p>
<p><img   src="/images/cBXCGF4Z18VLMzl.png" ></p>
<h3 id="kmem-cache"><a href="#kmem-cache" class="headerlink" title="kmem_cache"></a>kmem_cache</h3><p><code>kmem_cache</code>æƒ³å¿…å„ä½è¾ƒä¸ºç†Ÿæ‚‰ï¼Œå…¶ç”¨äºåˆ†é…ç‰¹å®šå¤§å°å¯¹è±¡çš„å†…å­˜æ± ï¼Œæ‰€æœ‰çš„<code>kmem_cache</code>æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶å­˜æ”¾äºä¸€ä¸ªç”¨äºå­˜æ”¾é€šç”¨<code>kmem_cache</code>çš„æ•°ç»„<code>kmem_caches</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *</span></span><br><span class="line"><span class="class"><span class="title">kmalloc_caches</span>[<span class="title">NR_KMALLOC_TYPES</span>][<span class="title">KMALLOC_SHIFT_HIGH</span> + 1] __<span class="title">ro_after_init</span> =</span></span><br><span class="line">&#123; <span class="comment">/* initialization for https://bugs.llvm.org/show_bug.cgi?id=42570 */</span> &#125;;</span><br><span class="line">EXPORT_SYMBOL(kmalloc_caches);</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢çœ‹ä¸€ä¸‹<code>kmem_cache</code>çš„å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLUB_TINY</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* Used for retrieving partial slabs, etc. */</span></span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;	<span class="comment">/* The size of an object including metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> object_size;<span class="comment">/* The size of an object without metadata */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reciprocal_value</span> <span class="title">reciprocal_size</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset;	<span class="comment">/* Free pointer offset */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial;</span><br><span class="line">	<span class="comment">/* Number of per cpu partial slabs to keep around */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial_slabs;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> allocflags;	<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line">	<span class="keyword">int</span> refcount;		<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line">	<span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;		<span class="comment">/* Offset to metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> align;		<span class="comment">/* Alignment */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> red_left_pad;	<span class="comment">/* Left redzone padding size */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;	<span class="comment">/* Name (only for display!) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>	<span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">/* For sysfs */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN_GENERIC</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HARDENED_USERCOPY</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿™é‡Œç¬¬ä¸€ä¸ªæˆå‘˜<code>cpu_slab</code>å…¶ä¸º<code>__percpu</code>å˜é‡æŒ‡å‘ä¸€ä¸ª<code>kmem_cache_cpu</code>ç»“æ„ä½“ï¼Œå³å½“å‰CPUç‹¬å çš„å†…å­˜æ± ã€‚<code>min_partial</code>æŒ‡çš„æ˜¯<code>node partial</code>é“¾è¡¨ä¸Šslabçš„æœ€å¤§æ•°é‡ã€‚<code>cpu_partial_slabs</code>æŒ‡çš„æ˜¯<code>cpu partial</code>é“¾è¡¨ä¸Šslabçš„æœ€å¤§æ•°é‡ã€‚<code>size</code>ä¸€ä¸ªå¯¹è±¡çš„å®é™…å¤§å°ã€‚<code>object_size</code>å¯¹è±¡æ‰€æœ‰æ•°æ®çš„å¤§å°ã€‚<code>offset</code>å³ç©ºé—²å¯¹è±¡é“¾è¡¨æŒ‡é’ˆå¯¹äºå…¶å¯¹è±¡çš„åç§»ã€‚<code>min</code>ä¸€ä¸ªslabä¸Šæœ€å°‘çš„å¯¹è±¡æ•°é‡ã€‚<code>allocflags</code>å‘<code>buddy system</code>ç”³è¯·é¡µé¢æ—¶æ‰€ä½¿ç”¨çš„<code>gfp flag</code>ã€‚<code>ctor</code>å¯¹è±¡çš„æ„é€ å‡½æ•°ã€‚</p>
<p><code>random_seq</code>: ç”¨äºåœ¨ slab åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist ä¸Šç©ºé—²å¯¹è±¡çš„è¿æ¥é¡ºåºã€‚</p>
<p><code>useroffset</code>: ç”¨æˆ·ç©ºé—´èƒ½è¯»å†™çš„èµ·å§‹åç§»ï¼Œåé¢çš„å°±æ—¶ç”¨æˆ·ç©ºé—´èƒ½è¯»å†™çš„å¤§å°ã€‚</p>
<p><code>node</code>: ä¸€ä¸ª <code>kmem_cache_node</code> æ•°ç»„ï¼Œå¯¹åº”å¤šä¸ªä¸åŒ node çš„åå¤‡å†…å­˜æ± </p>
<p><img   src="/images/D4idvgzLAaqIBQM.png" ></p>
<p>å…³äºå…¶åˆå¹¶å’Œç±»å‹ä¹‹ç±»çš„å‰é¢çš„æ–‡ç« æåˆ°è¿‡ï¼Œå¯ä»¥å»çœ‹çœ‹ <a class="link"   target="_blank" rel="noopener" href="https://cv196082.gitee.io/2023/10/15/CVE-2022-0185/" >CVE-2022-0185å¤ç°<i class="fas fa-external-link-alt"></i></a> ã€‚</p>
<h3 id="kmem-cache-cpu"><a href="#kmem-cache-cpu" class="headerlink" title="kmem_cache_cpu"></a>kmem_cache_cpu</h3><p>å½“ä¸€ä¸ªè¿›ç¨‹è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œé¦–å…ˆä¼šå°è¯•å‘å½“å‰CPUçš„ç‹¬å å†…å­˜æ± è¿›è¡Œåˆ†é…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="keyword">void</span> **freelist;	<span class="comment">/* Pointer to next available object */</span></span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;	<span class="comment">/* Globally unique transaction id */</span></span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">freelist_aba_t</span> freelist_tid;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span>	<span class="comment">/* The slab from which we are allocating */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">partial</span>;</span>	<span class="comment">/* Partially allocated frozen slabs */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">local_lock_t</span> lock;	<span class="comment">/* Protects the fields above */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_STATS</span></span><br><span class="line">	<span class="keyword">unsigned</span> stat[NR_SLUB_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è€Œè¿™é‡Œçš„<code>kmem_cache_cpu</code>ç»“æ„ä½“ä»£è¡¨çš„å°±æ˜¯æ¯ä¸ªCPUç‹¬å çš„å†…å­˜æ± ã€‚è¿™é‡Œçš„ç»“æ„ä½“æ¯”è¾ƒç®€å•ä¸”çœ¼ç†Ÿï¼Œé¦–å…ˆå°±æ˜¯<code>freelist</code>å«ä¹‰ä¸€æ ·æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„å¯¹è±¡ã€‚<code>slab</code>æŒ‡å‘å½“å‰ç”¨äºåˆ†é…çš„slabã€‚<code>partial</code>æŒ‡å‘çš„æ˜¯<code>percpu partial list</code>é“¾è¡¨ã€‚</p>
<p><img   src="/images/xSLqghNZ23nCMiz.png" ></p>
<h3 id="kmem-cache-node"><a href="#kmem-cache-node" class="headerlink" title="kmem_cache_node"></a>kmem_cache_node</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line"> <span class="comment">// ... ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> list_lock;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_partial;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line">	<span class="keyword">atomic_long_t</span> nr_slabs;</span><br><span class="line">	<span class="keyword">atomic_long_t</span> total_objects;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶å«ä¹‰ä¸ºæ¯ä¸ªnodeçš„åå¤‡å†…å­˜æ± ï¼Œå½“<code>percpu</code>çš„å†…å­˜æ± åˆ†é…å®Œæ¯•ä¹‹åå°±ä¼šæƒ³nodeçš„åå¤‡å†…å­˜æ± è¿›è¡Œå†…å­˜ç”³è¯·ã€‚</p>
<p>è¿™é‡Œçš„<code>partial</code>æˆå‘˜åŒå‰é¢çš„ä¸€è‡´ï¼Œ<code>nr_partial</code>å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯<code>partial</code>çš„æ•°é‡ã€‚è¿™é‡Œçš„<code>full</code>æˆå‘˜è¿æ¥çš„æ˜¯<code>slab page</code>ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½å·²ç»è¢«ä½¿ç”¨çš„slabå¦å¤–ä¸¤ä¸ªè®¡æ•°çš„ä¹Ÿå¾ˆå¥½ç†è§£äº†ã€‚</p>
<p><img   src="/images/ECDOVtxAyiwd1UZ.png" ></p>
<h2 id="å¯¹è±¡çš„åˆ†é…"><a href="#å¯¹è±¡çš„åˆ†é…" class="headerlink" title="å¯¹è±¡çš„åˆ†é…"></a>å¯¹è±¡çš„åˆ†é…</h2><h3 id="slab-alloc-node"><a href="#slab-alloc-node" class="headerlink" title="slab_alloc_node"></a>slab_alloc_node</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __fastpath_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s, struct list_lru *lru,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">size_t</span> orig_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">obj_cgroup</span> *<span class="title">objcg</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">bool</span> init = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	s = slab_pre_alloc_hook(s, lru, &amp;objcg, <span class="number">1</span>, gfpflags);</span><br><span class="line">	<span class="keyword">if</span> (!s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	object = kfence_alloc(s, orig_size, gfpflags);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(object))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	object = __slab_alloc_node(s, gfpflags, node, addr, orig_size);</span><br><span class="line"></span><br><span class="line">	maybe_wipe_obj_freeptr(s, object);</span><br><span class="line">	init = slab_want_init_on_alloc(gfpflags, s);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When init equals &#x27;true&#x27;, like for kzalloc() family, only</span></span><br><span class="line"><span class="comment">	 * @orig_size bytes might be zeroed instead of s-&gt;object_size</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	slab_post_alloc_hook(s, objcg, gfpflags, <span class="number">1</span>, &amp;object, init, orig_size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ˜¯é€šè¿‡<code>slab_pre_alloc_hook</code>å‡½æ•°è¿›è¡Œæ£€æµ‹æ ‡è¯†ä½ï¼Œéšåè°ƒç”¨<code>kfence_alloc</code>è¿›è¡Œå†…å­˜é”™è¯¯æ£€æµ‹ï¼Œæ¥ä¸‹æ¥è°ƒç”¨<code>__slab_alloc_node</code>å‡½æ•°è¿›è¡ŒçœŸæ­£çš„å†…å­˜åˆ†é…ï¼Œæœ€åä¸¤ä¸ªå‡½æ•°åˆ™æ˜¯å°†å¯¹è±¡åŸæœ¬ç”¨äºå­˜æ”¾<code>next object</code>çš„ä½ç½®å†™ä¸º0ï¼Œæœ€ååˆ™æ˜¯çœ‹æ ‡è¯†ä½æ˜¯å¦æœ‰<code>__GFP_ZERO</code>ï¼Œè‹¥æ˜¯æœ‰åˆ™è°ƒç”¨<code>slab_post_alloc_hook</code>å°†å †å—ä¸Šçš„æ•°æ®æ¸…é›¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *__slab_alloc_node(struct kmem_cache *s,</span><br><span class="line">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">size_t</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line"></span><br><span class="line">redo:</span><br><span class="line">	c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">	tid = READ_ONCE(c-&gt;tid);</span><br><span class="line">	barrier();</span><br><span class="line">	object = c-&gt;freelist;</span><br><span class="line">	slab = c-&gt;slab;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!USE_LOCKLESS_FAST_PATH() ||</span><br><span class="line">	    unlikely(!object || !slab || !node_match(slab, node))) &#123;</span><br><span class="line">		object = __slab_alloc(s, gfpflags, node, addr, c, orig_size);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!__update_cpu_freelist_fast(s, object, next_object, tid))) &#123;</span><br><span class="line">			note_cmpxchg_failure(<span class="string">&quot;slab_alloc&quot;</span>, s, tid);</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125;</span><br><span class="line">		prefetch_freepointer(s, next_object);</span><br><span class="line">		stat(s, ALLOC_FASTPATH);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿™é‡Œè·å–<code>percpu</code>ä¸Šçš„<code>kmem_cache_cpu</code>ï¼Œç„¶åè·å¾—å…¶<code>freelist</code>ä»¥åŠ<code>slab</code>ã€‚è‹¥ slab æˆ– freelist ä¸ºç©º &#x2F; slab ä¸ node ä¸åŒ¹é…ï¼Œåˆ™è°ƒç”¨ <code>__slab_alloc()</code> åˆ†é…ä¸€å¼ æ–° slab å¹¶ä»å…¶ä¸­è·å–ä¸€ä¸ªç©ºé—²å¯¹è±¡ã€‚</p>
<p>è¿™é‡Œå…ˆè€ƒè™‘æ¡ä»¶æˆç«‹çš„æƒ…å†µé‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>get_freepointer_safe</code>è·å–åˆ°å½“å‰ç©ºé—²å¯¹è±¡çš„ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œæ¥ä¸‹æ¥è°ƒç”¨<code>__update_cpu_freelist_fast</code>å‡½æ•°è¿›è¡Œæ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†æŠ¢å ï¼Œå¦‚æœæ˜¯åˆ™è·³å›redoé‡æ–°è·å–<code>kmem_cache_cpu</code>ã€‚æœ€åé€šè¿‡<code>prefetch_freepointer</code>å°†å·²åˆ†é…å¯¹è±¡çš„åœ°å€è½½å…¥ç¼“å­˜ä¸­ï¼Œä¹‹åè¿”å›åˆ†é…æˆåŠŸçš„å¯¹è±¡ã€‚</p>
<p>å‰é¢ä¸»è¦è¯´çš„æ˜¯å½“<code>slab</code>å’Œ<code>freelist</code>å­˜åœ¨æ—¶çš„æƒ…å†µï¼Œä¸‹é¢ä¸»è¦æä¸€ä¸‹ifåˆ†æ”¯å†…çš„å†…å®¹ã€‚è¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨äº†<code>__slab_alloc</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__slab_alloc(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node,</span><br><span class="line">			  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, struct kmem_cache_cpu *c, <span class="keyword">unsigned</span> <span class="keyword">int</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *p;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We may have been preempted and rescheduled on a different</span></span><br><span class="line"><span class="comment">	 * cpu before disabling preemption. Need to reload cpu area</span></span><br><span class="line"><span class="comment">	 * pointer.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	c = slub_get_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	p = ___slab_alloc(s, gfpflags, node, addr, c, orig_size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span></span><br><span class="line">	slub_put_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸»è¦æ˜¯å¯¹<code>___slab_alloc</code>å‡½æ•°çš„wrapper</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *___slab_alloc(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node,</span><br><span class="line">			  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, struct kmem_cache_cpu *c, <span class="keyword">unsigned</span> <span class="keyword">int</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *freelist;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">partial_context</span> <span class="title">pc</span>;</span></span><br><span class="line"></span><br><span class="line">	stat(s, ALLOC_SLOWPATH);</span><br><span class="line"></span><br><span class="line">reread_slab:</span><br><span class="line"></span><br><span class="line">	slab = READ_ONCE(c-&gt;slab);</span><br><span class="line">	<span class="keyword">if</span> (!slab) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * if the node is not online or has no normal memory, just</span></span><br><span class="line"><span class="comment">		 * ignore the node constraint</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(node != NUMA_NO_NODE &amp;&amp;</span><br><span class="line">			     !node_isset(node, slab_nodes)))</span><br><span class="line">			node = NUMA_NO_NODE;</span><br><span class="line">		<span class="keyword">goto</span> new_slab;</span><br><span class="line">	&#125;</span><br><span class="line">redo:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!node_match(slab, node))) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * same as above but node_match() being false already</span></span><br><span class="line"><span class="comment">		 * implies node != NUMA_NO_NODE</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (!node_isset(node, slab_nodes)) &#123;</span><br><span class="line">			node = NUMA_NO_NODE;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			stat(s, ALLOC_NODE_MISMATCH);</span><br><span class="line">			<span class="keyword">goto</span> deactivate_slab;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * By rights, we should be searching for a slab page that was</span></span><br><span class="line"><span class="comment">	 * PFMEMALLOC but right now, we are losing the pfmemalloc</span></span><br><span class="line"><span class="comment">	 * information when the page leaves the per-cpu allocator</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags)))</span><br><span class="line">		<span class="keyword">goto</span> deactivate_slab;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* must check again c-&gt;slab in case we got preempted and it changed */</span></span><br><span class="line">	local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;</span><br><span class="line">		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">		<span class="keyword">goto</span> reread_slab;</span><br><span class="line">	&#125;</span><br><span class="line">	freelist = c-&gt;freelist;</span><br><span class="line">	<span class="keyword">if</span> (freelist)</span><br><span class="line">		<span class="keyword">goto</span> load_freelist;</span><br><span class="line"></span><br><span class="line">	freelist = get_freelist(s, slab);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!freelist) &#123;</span><br><span class="line">		c-&gt;slab = <span class="literal">NULL</span>;</span><br><span class="line">		c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line">		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">		stat(s, DEACTIVATE_BYPASS);</span><br><span class="line">		<span class="keyword">goto</span> new_slab;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	stat(s, ALLOC_REFILL);</span><br><span class="line"></span><br><span class="line">load_freelist:</span><br><span class="line"></span><br><span class="line">	lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * freelist is pointing to the list of objects to be used.</span></span><br><span class="line"><span class="comment">	 * slab is pointing to the slab from which the objects are obtained.</span></span><br><span class="line"><span class="comment">	 * That slab must be frozen for per cpu allocations to work.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	VM_BUG_ON(!c-&gt;slab-&gt;frozen);</span><br><span class="line">	c-&gt;freelist = get_freepointer(s, freelist);</span><br><span class="line">	c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line">	local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">	<span class="keyword">return</span> freelist;</span><br><span class="line"></span><br><span class="line">deactivate_slab:</span><br><span class="line"></span><br><span class="line">	local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">	<span class="keyword">if</span> (slab != c-&gt;slab) &#123;</span><br><span class="line">		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">		<span class="keyword">goto</span> reread_slab;</span><br><span class="line">	&#125;</span><br><span class="line">	freelist = c-&gt;freelist;</span><br><span class="line">	c-&gt;slab = <span class="literal">NULL</span>;</span><br><span class="line">	c-&gt;freelist = <span class="literal">NULL</span>;</span><br><span class="line">	c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line">	local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">	deactivate_slab(s, slab, freelist);</span><br><span class="line"></span><br><span class="line">new_slab:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (slub_percpu_partial(c)) &#123;</span><br><span class="line">		local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(c-&gt;slab)) &#123;</span><br><span class="line">			local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">			<span class="keyword">goto</span> reread_slab;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!slub_percpu_partial(c))) &#123;</span><br><span class="line">			local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">			<span class="comment">/* we were preempted and partial list got empty */</span></span><br><span class="line">			<span class="keyword">goto</span> new_objects;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		slab = c-&gt;slab = slub_percpu_partial(c);</span><br><span class="line">		slub_set_percpu_partial(c, slab);</span><br><span class="line">		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">		stat(s, CPU_PARTIAL_ALLOC);</span><br><span class="line">		<span class="keyword">goto</span> redo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">new_objects:</span><br><span class="line"></span><br><span class="line">	pc.flags = gfpflags;</span><br><span class="line">	pc.slab = &amp;slab;</span><br><span class="line">	pc.orig_size = orig_size;</span><br><span class="line">	freelist = get_partial(s, node, &amp;pc);</span><br><span class="line">	<span class="keyword">if</span> (freelist)</span><br><span class="line">		<span class="keyword">goto</span> check_new_slab;</span><br><span class="line"></span><br><span class="line">	slub_put_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">	slab = new_slab(s, gfpflags, node);</span><br><span class="line">	c = slub_get_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!slab)) &#123;</span><br><span class="line">		slab_out_of_memory(s, gfpflags, node);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	stat(s, ALLOC_SLAB);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kmem_cache_debug(s)) &#123;</span><br><span class="line">		freelist = alloc_single_from_new_slab(s, slab, orig_size);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!freelist))</span><br><span class="line">			<span class="keyword">goto</span> new_objects;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)</span><br><span class="line">			set_track(s, freelist, TRACK_ALLOC, addr);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> freelist;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * No other reference to the slab yet so we can</span></span><br><span class="line"><span class="comment">	 * muck around with it freely without cmpxchg</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	freelist = slab-&gt;freelist;</span><br><span class="line">	slab-&gt;freelist = <span class="literal">NULL</span>;</span><br><span class="line">	slab-&gt;inuse = slab-&gt;objects;</span><br><span class="line">	slab-&gt;frozen = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	inc_slabs_node(s, slab_nid(slab), slab-&gt;objects);</span><br><span class="line"></span><br><span class="line">check_new_slab:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kmem_cache_debug(s)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * For debug caches here we had to go through</span></span><br><span class="line"><span class="comment">		 * alloc_single_from_partial() so just store the tracking info</span></span><br><span class="line"><span class="comment">		 * and return the object</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)</span><br><span class="line">			set_track(s, freelist, TRACK_ALLOC, addr);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> freelist;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags))) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * For !pfmemalloc_match() case we don&#x27;t load freelist so that</span></span><br><span class="line"><span class="comment">		 * we don&#x27;t make further mismatched allocations easier.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		deactivate_slab(s, slab, get_freepointer(s, freelist));</span><br><span class="line">		<span class="keyword">return</span> freelist;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">retry_load_slab:</span><br><span class="line"></span><br><span class="line">	local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(c-&gt;slab)) &#123;</span><br><span class="line">		<span class="keyword">void</span> *flush_freelist = c-&gt;freelist;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">flush_slab</span> =</span> c-&gt;slab;</span><br><span class="line"></span><br><span class="line">		c-&gt;slab = <span class="literal">NULL</span>;</span><br><span class="line">		c-&gt;freelist = <span class="literal">NULL</span>;</span><br><span class="line">		c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line"></span><br><span class="line">		local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">		deactivate_slab(s, flush_slab, flush_freelist);</span><br><span class="line"></span><br><span class="line">		stat(s, CPUSLAB_FLUSH);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">goto</span> retry_load_slab;</span><br><span class="line">	&#125;</span><br><span class="line">	c-&gt;slab = slab;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">goto</span> load_freelist;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>___slab_alloc</code>å‡½æ•°æ‰æ˜¯å…¶æ ¸å¿ƒå‡½æ•°ï¼Œé¦–å…ˆæ˜¯<code>reread_slab</code>æ ‡ç­¾ä¸­ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>slab</code>å¦‚æœä¸å­˜åœ¨åˆ™è·³è½¬åˆ°<code>new_slab</code>ã€‚</p>
<p>åœ¨<code>new_slab</code>ä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨<code>percpu partial slab</code>ï¼Œå¦‚æœå­˜åœ¨åˆ™å°†åˆ™å°†é“¾è¡¨ä¸­å–å‡ºä¸€ä¸ª<code>slab</code>ç»™åˆ°<code>percpu slab</code>éšåè·³è¿›<code>redo</code>ã€‚</p>
<p>åœ¨<code>redo</code>æ ‡ç­¾ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­slabæ˜¯å¦å’Œ<code>node</code>ä»¥åŠåˆ†é…æ ‡è¯†ä½åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…åˆ™è·³è½¬è‡³<code>deactivate_slab</code>æ ‡ç­¾ï¼Œç´§æ¥ç€éªŒè¯å½“å‰çš„slabæ˜¯å¦æ˜¯åŸæ¥cpuçš„slabï¼Œå¦‚æœä¸æ˜¯åˆ™è¡¨ç¤ºå‘ç”Ÿäº†æŠ¢å è·³è½¬åˆ°<code>reread_slab</code>æ ‡ç­¾ä¸­ã€‚éšåè·å–<code>freelist</code>è‹¥<code>freelist</code>ä¸ä¸ºç©ºåˆ™è·³è½¬åˆ°<code>load_freelist</code>ä¸­ï¼Œè‹¥ä¸ºç©ºåˆ™è°ƒç”¨<code>get_freelist</code>å‡½æ•°è·å–slabçš„<code>freelist</code>å¦‚æœä»ç„¶ä¸ºç©ºï¼Œåˆ™å°†<code>percpu slab</code>çš„<code>freelist</code>è®¾ç½®ä¸ºNULLéšåè·³è½¬åˆ°ä¸‹ä¸€ä¸ªtidï¼Œå¹¶é‡æ–°è¿›å…¥<code>new_slab</code>æ ‡ç­¾è·å–<code>slab</code>ã€‚</p>
<p>éšåçœ‹<code>load_freelist</code>æ ‡ç­¾ï¼Œè¿™ä¸€æ®µå°±æ¯”è¾ƒç®€å•ç†è§£äº†ï¼Œå°±æ˜¯å°†<code>freelist</code>çš„<code>next</code>æŒ‡é’ˆèµ‹å€¼ç»™<code>percpu freelist</code>ï¼Œç„¶åè·å¾—ä¸‹ä¸€ä¸ªtidéšåè¿”å›<code>freelist</code>ã€‚å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>get_freepointer</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>freelist_ptr_decode</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr_decode</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">					<span class="keyword">freeptr_t</span> ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *decoded;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	decoded = (<span class="keyword">void</span> *)(ptr.v ^ s-&gt;random ^ swab(ptr_addr));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	decoded = (<span class="keyword">void</span> *)ptr.v;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> decoded;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®€å•è§‚å¯Ÿè¿™ä¸ªå‡½æ•°å¯ä»¥å‘ç°å³ä¾¿æ˜¯å¼€å¯äº†<code>Hardened freelist</code>ä¿æŠ¤çš„æƒ…å†µä¸‹<code>slab-&gt;freelist</code>éƒ½æ˜¯æ²¡æœ‰åŠ å¯†çš„ï¼ŒåŠ å¯†çš„åªæ˜¯å¯¹è±¡ä¸Šçš„å†…å®¹ã€‚</p>
<p>å›åˆ°å‰é¢çš„æµç¨‹è¿›å…¥åˆ°<code>deactivate_slab</code>æ ‡ç­¾ä¸­ï¼Œè¿™é‡Œé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å°†<code>percpu</code>çš„<code>freelist</code>å’Œ<code>slab</code>è®¾ç½®ä¸ºNULLå¹¶ä¸”è·å–åˆ°ä¸‹ä¸€ä¸ªtidä¹‹åç›´æ¥è°ƒç”¨<code>deactivate_slab</code>å‡½æ•°ï¼Œå¯¹æ•´å¼ slabè¿›è¡Œ<code>deactivate</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deactivate_slab</span><span class="params">(struct kmem_cache *s, struct slab *slab,</span></span></span><br><span class="line"><span class="params"><span class="function">			    <span class="keyword">void</span> *freelist)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">slab_modes</span> &#123;</span> M_NONE, M_PARTIAL, M_FREE, M_FULL_NOLIST &#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span> =</span> get_node(s, slab_nid(slab));</span><br><span class="line">	<span class="keyword">int</span> free_delta = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">slab_modes</span> <span class="title">mode</span> =</span> M_NONE;</span><br><span class="line">	<span class="keyword">void</span> *nextfree, *freelist_iter, *freelist_tail;</span><br><span class="line">	<span class="keyword">int</span> tail = DEACTIVATE_TO_HEAD;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> <span class="title">new</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> <span class="title">old</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (slab-&gt;freelist) &#123;</span><br><span class="line">		stat(s, DEACTIVATE_REMOTE_FREES);</span><br><span class="line">		tail = DEACTIVATE_TO_TAIL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Stage one: Count the objects on cpu&#x27;s freelist as free_delta and</span></span><br><span class="line"><span class="comment">	 * remember the last object in freelist_tail for later splicing.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	freelist_tail = <span class="literal">NULL</span>;</span><br><span class="line">	freelist_iter = freelist;</span><br><span class="line">	<span class="keyword">while</span> (freelist_iter) &#123;</span><br><span class="line">		nextfree = get_freepointer(s, freelist_iter);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If &#x27;nextfree&#x27; is invalid, it is possible that the object at</span></span><br><span class="line"><span class="comment">		 * &#x27;freelist_iter&#x27; is already corrupted.  So isolate all objects</span></span><br><span class="line"><span class="comment">		 * starting at &#x27;freelist_iter&#x27; by skipping them.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (freelist_corrupted(s, slab, &amp;freelist_iter, nextfree))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		freelist_tail = freelist_iter;</span><br><span class="line">		free_delta++;</span><br><span class="line"></span><br><span class="line">		freelist_iter = nextfree;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Stage two: Unfreeze the slab while splicing the per-cpu</span></span><br><span class="line"><span class="comment">	 * freelist to the head of slab&#x27;s freelist.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Ensure that the slab is unfrozen while the list presence</span></span><br><span class="line"><span class="comment">	 * reflects the actual number of objects during unfreeze.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * We first perform cmpxchg holding lock and insert to list</span></span><br><span class="line"><span class="comment">	 * when it succeed. If there is mismatch then the slab is not</span></span><br><span class="line"><span class="comment">	 * unfrozen and number of objects in the slab may have changed.</span></span><br><span class="line"><span class="comment">	 * Then release lock and retry cmpxchg again.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">redo:</span><br><span class="line"></span><br><span class="line">	old.freelist = READ_ONCE(slab-&gt;freelist);</span><br><span class="line">	old.counters = READ_ONCE(slab-&gt;counters);</span><br><span class="line">	VM_BUG_ON(!old.frozen);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Determine target state of the slab */</span></span><br><span class="line">	<span class="keyword">new</span>.counters = old.counters;</span><br><span class="line">	<span class="keyword">if</span> (freelist_tail) &#123;</span><br><span class="line">		<span class="keyword">new</span>.inuse -= free_delta;</span><br><span class="line">		set_freepointer(s, freelist_tail, old.freelist);</span><br><span class="line">		<span class="keyword">new</span>.freelist = freelist;</span><br><span class="line">	&#125; <span class="keyword">else</span></span><br><span class="line">		<span class="keyword">new</span>.freelist = old.freelist;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span>.frozen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">new</span>.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial) &#123;</span><br><span class="line">		mode = M_FREE;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">new</span>.freelist) &#123;</span><br><span class="line">		mode = M_PARTIAL;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Taking the spinlock removes the possibility that</span></span><br><span class="line"><span class="comment">		 * acquire_slab() will see a slab that is frozen</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		spin_lock_irqsave(&amp;n-&gt;list_lock, flags);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mode = M_FULL_NOLIST;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!slab_update_freelist(s, slab,</span><br><span class="line">				old.freelist, old.counters,</span><br><span class="line">				<span class="keyword">new</span>.freelist, <span class="keyword">new</span>.counters,</span><br><span class="line">				<span class="string">&quot;unfreezing slab&quot;</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mode == M_PARTIAL)</span><br><span class="line">			spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">		<span class="keyword">goto</span> redo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mode == M_PARTIAL) &#123;</span><br><span class="line">		add_partial(n, slab, tail);</span><br><span class="line">		spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">		stat(s, tail);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode == M_FREE) &#123;</span><br><span class="line">		stat(s, DEACTIVATE_EMPTY);</span><br><span class="line">		discard_slab(s, slab);</span><br><span class="line">		stat(s, FREE_SLAB);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode == M_FULL_NOLIST) &#123;</span><br><span class="line">		stat(s, DEACTIVATE_FULL);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç®€å•æä¸€ä¸‹<code>deacticate_slab</code>å‡½æ•°çš„é€»è¾‘ï¼Œéå†<code>freelist</code>æ£€æŸ¥æ˜¯å¦è¢«ç ´åï¼Œæ”¾å¼ƒè¢«ç ´åçš„éƒ¨åˆ†ï¼Œå°†<code>slab-&gt;freelist</code>è®¾ä¸ºåŸ<code>kmem_cache_cpu-&gt;freelist</code>ï¼Œè‹¥slabä¸ŠåŸæœ‰freelistä¸ä¸º NULL åˆ™å†æ¥åˆ°åé¢ï¼Œè®¾ç½® slab çš„ countersï¼Œå…¶ä¸­å°† <code>frozen</code> è®¾ä¸º 0ï¼Œè‹¥ slab ä¸Šçš„å¯¹è±¡å…¨éƒ¨ç©ºé—²ä¸” node çš„ partial slab æ•°é‡å¤§äº <code>kmem_cache-&gt;min_partial</code>ï¼Œè°ƒç”¨ <code>discard_slab()</code> å°† slab é‡Šæ”¾ï¼Œè‹¥ slab ä¸Šå­˜åœ¨ç©ºé—²å¯¹è±¡ï¼Œè°ƒç”¨ <code>add_partial()</code> å°†å…¶åŠ å…¥ node çš„ partial é“¾è¡¨ã€‚è¿™é‡Œçš„æ“ä½œåœ¨ <a class="link"   target="_blank" rel="noopener" href="https://cv196082.gitee.io/2023/10/27/CVE-2022-2588/" >CVE-2022-2588å¤ç°<i class="fas fa-external-link-alt"></i></a> é‡Œé¢çš„<code>CVE-2023-3269</code>ä¸­ä½¿ç”¨è¿‡ã€‚</p>
<p>æ¥ä¸‹æ¥è¿›å…¥<code>new_object</code>æ ‡ç­¾å†…ï¼Œè‹¥æ˜¯<code>percpu partial</code>é“¾è¡¨ä¹Ÿä¸ºç©ºï¼Œä¾¿ä¼šè¿›å…¥åˆ°è¿™ä¸ªæ ‡ç­¾å†…ã€‚è¿™é‡Œé¦–å…ˆä¼šåˆ†é…ä¸€ä¸ªæ–°çš„slabå¹¶è®¾ç½®<code>partial_context</code>ï¼Œè°ƒç”¨<code>get_partial</code>å°è¯•ä»å½“å‰nodeçš„<code>kmem_cache_node</code>çš„<code>partial</code>é“¾è¡¨ä¸­åˆ†é…ä¸€ä¸ªslabï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è·³è½¬åˆ°<code>check_new_slab</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">get_partial</span><span class="params">(struct kmem_cache *s, <span class="keyword">int</span> node, struct partial_context *pc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line">	<span class="keyword">int</span> searchnode = node;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (node == NUMA_NO_NODE)</span><br><span class="line">		searchnode = numa_mem_id();</span><br><span class="line"></span><br><span class="line">	object = get_partial_node(s, get_node(s, searchnode), pc);</span><br><span class="line">	<span class="keyword">if</span> (object || node != NUMA_NO_NODE)</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> get_any_partial(s, pc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¦‚æœnodeçš„ä¸º<code>NUMA_NO_NODE</code>åˆ™ä¼šè°ƒç”¨<code>get_any_partial</code>å°è¯•ä»å…¶ä»–çš„nodeçš„<code>kmem_cache_node</code>ä¸­åˆ†é…ã€‚å¦‚æœ<code>get_partial</code>å‡½æ•°æ²¡èƒ½ä»nodeçš„<code>kmem_cache_node</code>ä¸­è·å¾—slabçš„è¯åˆ™ä¼šè°ƒç”¨<code>new_slab</code>å‘<code>buddy system</code>ç”³è¯·ä¸€ä»½æ–°çš„slabã€‚</p>
<p>åœ¨æ‹¿åˆ°<code>slab</code>ä¹‹åç»§ç»­å¾€åé¢èµ°ä¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰<code>SLAB_DEBUG_FLAGS</code>æ ‡è¯†ä½ï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨<code>alloc_single_from_new_slab</code>å‡½æ•°ï¼Œä»æ–°åˆ†é…çš„<code>slab</code>ä¸­è·å–ä¸€ä¸ªå¯¹è±¡ä¹‹åæ”¾å›<code>partial</code>&#x2F;<code>full</code>ä¸­ï¼Œå¦‚æœå¤±è´¥åˆ™é€€å‡ºï¼ŒæˆåŠŸè¿”å›ã€‚è‹¥æ˜¯æ²¡æœ‰è®¾ç½®<code>SLAB_DEBUG_FLAGS</code>è¿™ä¸ªæ ‡è¯†ä½ï¼Œé‚£å°±è·å–slabçš„<code>freelist</code>éšåè°ƒç”¨<code>inc_slabs_node</code>å‡½æ•°ç»™nodeçš„å¼•ç”¨è®¡æ•°å¢åŠ ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹<code>check_new_slab</code>æ ‡ç­¾ï¼Œè¿™é‡Œé¢åšçš„äº‹æ¯”è¾ƒå°‘ï¼Œé¦–å…ˆåˆ™æ˜¯æ£€æŸ¥è¯¥<code>kmem_cache</code>æ˜¯å¦è®¾ç½®äº†<code>SLAB_DEBUG_FLAGS</code>æ ‡è¯†ä½ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦è®¾ç½®äº†<code>SLAB_STORE_USER</code>æ ‡è¯†ä½ï¼Œéšåè¿”å›<code>freelist</code>ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®åˆ™è°ƒç”¨<code>pfmemalloc_match</code>æ£€æŸ¥slabä¸åˆ†é…æ ‡è¯†ä½æ˜¯å¦ä¸åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…åˆ™è°ƒç”¨<code>deactivate_slab</code>ç¦ç”¨slabå¹¶è¿”å›<code>freelist</code>ã€‚</p>
<p>æœ€åå°±æ˜¯<code>retry_load_slab</code>æ ‡ç­¾ï¼Œè¿™é‡Œå°±æ˜¯å°è¯•åŠ è½½æ–°è·å¾—çš„slabï¼Œå¦‚æœ<code>percpu slab</code>ä¸ä¸ºNULLï¼Œé‚£ä¹ˆè¿™é‡Œå°±å°†å…¶å’Œ<code>freelist</code>è®¾ç½®ä¸ºNULLï¼Œéšåè°ƒç”¨<code>deactivate_slab</code>ç¦ç”¨slabå¹¶è·å–ä¸‹ä¸€ä¸ªtidï¼Œæœ€åå°†æ–°è·å¾—çš„slabè®¾ç½®åˆ°<code>percpu slab</code>éšåè·³è½¬åˆ°<code>load_freelist</code>åˆ†é…å¯¹è±¡å¹¶è¿”å›ã€‚</p>
<h3 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h3><p>å‰é¢ä¸»è¦æ˜¯slubç®—æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼Œä¸‹é¢æ¥å¯¹è±¡åˆ†é…æ›´ä¸Šçº§çš„å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline __alloc_size(<span class="number">1</span>) <span class="function"><span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_constant_p(size) &amp;&amp; size) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)</span><br><span class="line">			<span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"></span><br><span class="line">		index = kmalloc_index(size);</span><br><span class="line">		<span class="keyword">return</span> kmalloc_trace(</span><br><span class="line">				kmalloc_caches[kmalloc_type(flags, _RET_IP_)][index],</span><br><span class="line">				flags, size);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> __kmalloc(size, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°çš„é€»è¾‘å¾ˆç®€å•ï¼Œé¦–å…ˆçœ‹sizeä¸ºç¼–è¯‘é¢„çŸ¥çš„ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>__kmalloc</code>ã€‚å¦‚æœæ˜¯åˆ™è¿›å…¥å†…éƒ¨ï¼Œé¦–å…ˆä¼šåˆ¤æ–­sizeæ˜¯å¦å¤§äº<code>KMALLOC_MAX_CACHE_SIZE</code>å¦‚æœæ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>kmalloc_large</code>è¿›è¡Œåˆ†é…å¹¶è¿”å›ï¼Œå¦‚æœä¸æ˜¯åˆ™è°ƒç”¨<code>kmalloc_index</code>å‡½æ•°è·å–åˆ°ç´¢å¼•éšåä½¿ç”¨<code>kmalloc_trace</code>å‡½æ•°è¿›è¡Œåˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__kmalloc_large_node(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *ptr = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> order = get_order(size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(flags &amp; GFP_SLAB_BUG_MASK))</span><br><span class="line">		flags = kmalloc_fix_flags(flags);</span><br><span class="line"></span><br><span class="line">	flags |= __GFP_COMP;</span><br><span class="line">	page = alloc_pages_node(node, flags, order);</span><br><span class="line">	<span class="keyword">if</span> (page) &#123;</span><br><span class="line">		ptr = page_address(page);</span><br><span class="line">		mod_lruvec_page_state(page, NR_SLAB_UNRECLAIMABLE_B,</span><br><span class="line">				      PAGE_SIZE &lt;&lt; order);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ptr = kasan_kmalloc_large(ptr, size, flags);</span><br><span class="line">	<span class="comment">/* As ptr might get tagged, call kmemleak hook after KASAN. */</span></span><br><span class="line">	kmemleak_alloc(ptr, size, <span class="number">1</span>, flags);</span><br><span class="line">	kmsan_kmalloc_large(ptr, size, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">kmalloc_large</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *ret = __kmalloc_large_node(size, flags, NUMA_NO_NODE);</span><br><span class="line"></span><br><span class="line">	trace_kmalloc(_RET_IP_, ret, size, PAGE_SIZE &lt;&lt; get_order(size),</span><br><span class="line">		      flags, NUMA_NO_NODE);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kmalloc_large);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>kmalloc_large</code>æœ€ç»ˆä¼šè°ƒç”¨çš„æ˜¯<code>__kmalloc_large_node</code>å‡½æ•°è¿›è¡Œåˆ†é…ï¼Œå¯ä»¥çœ‹åˆ°å…¶ç›´æ¥è°ƒç”¨äº†<code>alloc_pages_node</code>å‘<code>buddy system</code>è¯·æ±‚å†…å­˜äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">unsigned</span> <span class="keyword">int</span> __kmalloc_index(<span class="keyword">size_t</span> size,</span><br><span class="line">						    <span class="keyword">bool</span> size_is_constant)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!size)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)</span><br><span class="line">		<span class="keyword">return</span> KMALLOC_SHIFT_LOW;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">32</span> &amp;&amp; size &gt; <span class="number">64</span> &amp;&amp; size &lt;= <span class="number">96</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">64</span> &amp;&amp; size &gt; <span class="number">128</span> &amp;&amp; size &lt;= <span class="number">192</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=          <span class="number">8</span>) <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">16</span>) <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">32</span>) <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=         <span class="number">64</span>) <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">128</span>) <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">256</span>) <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=        <span class="number">512</span>) <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=       <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">2</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">4</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=   <span class="number">8</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">16</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">32</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">64</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">128</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">17</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">256</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">18</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">512</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">19</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;=  <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">21</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!IS_ENABLED(CONFIG_PROFILE_ALL_BRANCHES) &amp;&amp; size_is_constant)</span><br><span class="line">		BUILD_BUG_ON_MSG(<span class="number">1</span>, <span class="string">&quot;unexpected size in kmalloc_index()&quot;</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		BUG();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Will never be reached. Needed because the compiler may complain */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> kmalloc_index(s) __kmalloc_index(s, true)</span></span><br></pre></td></tr></table></figure>

<p>è€Œ<code>kmalloc_index</code>å‡½æ•°å…¶å®å°±æ˜¯è°ƒç”¨<code>__kmalloc_index</code>ï¼Œå…¶å†…éƒ¨å®ç°ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•ç²—æš´ã€‚</p>
<p>å…³äº<code>kmalloc_type</code>å‡½æ•°åœ¨ <a class="link"   target="_blank" rel="noopener" href="https://cv196082.gitee.io/2023/10/15/CVE-2022-0185/" >CVE-2022-0185å¤ç°<i class="fas fa-external-link-alt"></i></a> æ–‡ç« ä¸­è¯¦ç»†åˆ†æè¿‡äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__kmem_cache_alloc_node(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags,</span><br><span class="line">			      <span class="keyword">int</span> node, <span class="keyword">size_t</span> orig_size,</span><br><span class="line">			      <span class="keyword">unsigned</span> <span class="keyword">long</span> caller)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> slab_alloc_node(s, <span class="literal">NULL</span>, gfpflags, node,</span><br><span class="line">			       caller, orig_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">kmalloc_trace</span><span class="params">(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *ret = __kmem_cache_alloc_node(s, gfpflags, NUMA_NO_NODE,</span><br><span class="line">					    size, _RET_IP_);</span><br><span class="line"></span><br><span class="line">	trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, gfpflags, NUMA_NO_NODE);</span><br><span class="line"></span><br><span class="line">	ret = kasan_kmalloc(s, ret, size, gfpflags);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kmalloc_trace);</span><br></pre></td></tr></table></figure>

<p><code>kmalloc_trace</code>å°±æ˜¯å¯¹<code>__kmem_cache_alloc_node</code>å‡½æ•°çš„è°ƒç”¨ï¼Œè€Œ<code>__kmem_cache_alloc_node</code>å…¶å®å°±æ˜¯å¯¹<code>slab_alloc_node</code>çš„wrapperï¼Œå‰é¢ä¹Ÿå·²ç»åˆ†æè¿‡<code>slab_alloc_node</code>äº†ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡ŒæŒ‡å®šäº†nodeä¸º<code>NUMA_NO_NODE</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__kmalloc(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> __do_kmalloc_node(size, flags, NUMA_NO_NODE, _RET_IP_);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__kmalloc);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>__kmalloc</code>ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨äº†<code>__do_kmalloc_node</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline</span><br><span class="line"><span class="keyword">void</span> *__do_kmalloc_node(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> caller)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE)) &#123;</span><br><span class="line">		ret = __kmalloc_large_node(size, flags, node);</span><br><span class="line">		trace_kmalloc(caller, ret, size,</span><br><span class="line">			      PAGE_SIZE &lt;&lt; get_order(size), flags, node);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s = kmalloc_slab(size, flags, caller);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))</span><br><span class="line">		<span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">	ret = __kmem_cache_alloc_node(s, flags, node, size, caller);</span><br><span class="line">	ret = kasan_kmalloc(s, ret, size, flags);</span><br><span class="line">	trace_kmalloc(caller, ret, size, s-&gt;size, flags, node);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„é€»è¾‘åœ¨å¼€å¤´ä½ç½®åŒä¸Šï¼Œå¦‚æœsizeå¤§äº<code>KMALLOC_MAX_CACHE_SIZE</code>é‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨<code>__kmalloc_large_node</code>è¿›è¡Œåˆ†é…ã€‚å¦‚æœå°äºçš„è¯åˆ™è´¤è°ƒç”¨<code>kmalloc_slab</code>å¯»æ‰¾åˆ°å¯¹åº”çš„<code>kmem_cache</code>ç„¶åè°ƒç”¨<code>__kmem_cache_alloc_node</code>è¿›è¡Œåˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *<span class="title">kmalloc_slab</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags, <span class="keyword">unsigned</span> <span class="keyword">long</span> caller)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">192</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!size)</span><br><span class="line">			<span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line">		index = size_index[size_index_elem(size)];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		index = fls(size - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> kmalloc_caches[kmalloc_type(flags, caller)][index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯»æ‰¾çš„æ–¹å¼ä¹Ÿå’Œå‰é¢çš„ååˆ†ç›¸ä¼¼ï¼Œ<code>size_index</code>å’Œ<code>size_index_elem</code>çš„å®ç°ä¹Ÿæ˜¯æ¯”è¾ƒç²—æš´ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> u8 size_index[<span class="number">24</span>] __ro_after_init = &#123;</span><br><span class="line">	<span class="number">3</span>,	<span class="comment">/* 8 */</span></span><br><span class="line">	<span class="number">4</span>,	<span class="comment">/* 16 */</span></span><br><span class="line">	<span class="number">5</span>,	<span class="comment">/* 24 */</span></span><br><span class="line">	<span class="number">5</span>,	<span class="comment">/* 32 */</span></span><br><span class="line">	<span class="number">6</span>,	<span class="comment">/* 40 */</span></span><br><span class="line">	<span class="number">6</span>,	<span class="comment">/* 48 */</span></span><br><span class="line">	<span class="number">6</span>,	<span class="comment">/* 56 */</span></span><br><span class="line">	<span class="number">6</span>,	<span class="comment">/* 64 */</span></span><br><span class="line">	<span class="number">1</span>,	<span class="comment">/* 72 */</span></span><br><span class="line">	<span class="number">1</span>,	<span class="comment">/* 80 */</span></span><br><span class="line">	<span class="number">1</span>,	<span class="comment">/* 88 */</span></span><br><span class="line">	<span class="number">1</span>,	<span class="comment">/* 96 */</span></span><br><span class="line">	<span class="number">7</span>,	<span class="comment">/* 104 */</span></span><br><span class="line">	<span class="number">7</span>,	<span class="comment">/* 112 */</span></span><br><span class="line">	<span class="number">7</span>,	<span class="comment">/* 120 */</span></span><br><span class="line">	<span class="number">7</span>,	<span class="comment">/* 128 */</span></span><br><span class="line">	<span class="number">2</span>,	<span class="comment">/* 136 */</span></span><br><span class="line">	<span class="number">2</span>,	<span class="comment">/* 144 */</span></span><br><span class="line">	<span class="number">2</span>,	<span class="comment">/* 152 */</span></span><br><span class="line">	<span class="number">2</span>,	<span class="comment">/* 160 */</span></span><br><span class="line">	<span class="number">2</span>,	<span class="comment">/* 168 */</span></span><br><span class="line">	<span class="number">2</span>,	<span class="comment">/* 176 */</span></span><br><span class="line">	<span class="number">2</span>,	<span class="comment">/* 184 */</span></span><br><span class="line">	<span class="number">2</span>	<span class="comment">/* 192 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">size_index_elem</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> bytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (bytes - <span class="number">1</span>) / <span class="number">8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¯¹è±¡çš„é‡Šæ”¾"><a href="#å¯¹è±¡çš„é‡Šæ”¾" class="headerlink" title="å¯¹è±¡çš„é‡Šæ”¾"></a>å¯¹è±¡çš„é‡Šæ”¾</h2><h3 id="do-slab-free"><a href="#do-slab-free" class="headerlink" title="do_slab_free"></a>do_slab_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> <span class="title">do_slab_free</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">				struct slab *slab, <span class="keyword">void</span> *head, <span class="keyword">void</span> *tail,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">int</span> cnt, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *tail_obj = tail ? : head;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line">	<span class="keyword">void</span> **freelist;</span><br><span class="line"></span><br><span class="line">redo:</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Determine the currently cpus per cpu slab.</span></span><br><span class="line"><span class="comment">	 * The cpu may change afterward. However that does not matter since</span></span><br><span class="line"><span class="comment">	 * data is retrieved via this pointer. If we are on the same cpu</span></span><br><span class="line"><span class="comment">	 * during the cmpxchg then the free will succeed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">	tid = READ_ONCE(c-&gt;tid);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Same with comment on barrier() in slab_alloc_node() */</span></span><br><span class="line">	barrier();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;</span><br><span class="line">		__slab_free(s, slab, head, tail_obj, cnt, addr);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (USE_LOCKLESS_FAST_PATH()) &#123;</span><br><span class="line">		freelist = READ_ONCE(c-&gt;freelist);</span><br><span class="line"></span><br><span class="line">		set_freepointer(s, tail_obj, freelist);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!__update_cpu_freelist_fast(s, freelist, head, tid))) &#123;</span><br><span class="line">			note_cmpxchg_failure(<span class="string">&quot;slab_free&quot;</span>, s, tid);</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Update the free list under the local lock */</span></span><br><span class="line">		local_lock(&amp;s-&gt;cpu_slab-&gt;lock);</span><br><span class="line">		c = this_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;</span><br><span class="line">			local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125;</span><br><span class="line">		tid = c-&gt;tid;</span><br><span class="line">		freelist = c-&gt;freelist;</span><br><span class="line"></span><br><span class="line">		set_freepointer(s, tail_obj, freelist);</span><br><span class="line">		c-&gt;freelist = head;</span><br><span class="line">		c-&gt;tid = next_tid(tid);</span><br><span class="line"></span><br><span class="line">		local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);</span><br><span class="line">	&#125;</span><br><span class="line">	stat(s, FREE_FASTPATH);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¾æ—§åˆ†ä¸ºä¸¤æ¡è·¯å¾„ï¼Œé¦–å…ˆä¼šæ¯”è¾ƒå¾…é‡Šæ”¾çš„å¯¹è±¡æ‰€å±äºçš„slabæ˜¯å¦æ˜¯<code>percpu slab</code>ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æŒ‚å›å»å³å¯ï¼Œéµå¾ªLIFOæœºåˆ¶ã€‚</p>
<p>å¦‚æœä¸æ˜¯åˆ™ä¼šè¿›å…¥åˆ°<code>__slab_free</code>å‡½æ•°ä¸­è¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __slab_free(struct kmem_cache *s, struct slab *slab,</span><br><span class="line">			<span class="keyword">void</span> *head, <span class="keyword">void</span> *tail, <span class="keyword">int</span> cnt,</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span> *prior;</span><br><span class="line">	<span class="keyword">int</span> was_frozen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> <span class="title">new</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> counters;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">	stat(s, FREE_SLOWPATH);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kfence_free(head))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_SLUB_TINY) || kmem_cache_debug(s)) &#123;</span><br><span class="line">		free_to_partial_list(s, slab, head, tail, cnt, addr);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (unlikely(n)) &#123;</span><br><span class="line">			spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">			n = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		prior = slab-&gt;freelist;</span><br><span class="line">		counters = slab-&gt;counters;</span><br><span class="line">		set_freepointer(s, tail, prior);</span><br><span class="line">		<span class="keyword">new</span>.counters = counters;</span><br><span class="line">		was_frozen = <span class="keyword">new</span>.frozen;</span><br><span class="line">		<span class="keyword">new</span>.inuse -= cnt;</span><br><span class="line">		<span class="keyword">if</span> ((!<span class="keyword">new</span>.inuse || !prior) &amp;&amp; !was_frozen) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (kmem_cache_has_cpu_partial(s) &amp;&amp; !prior) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * Slab was on no list before and will be</span></span><br><span class="line"><span class="comment">				 * partially empty</span></span><br><span class="line"><span class="comment">				 * We can defer the list move and instead</span></span><br><span class="line"><span class="comment">				 * freeze it.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				<span class="keyword">new</span>.frozen = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123; <span class="comment">/* Needs to be taken off a list */</span></span><br><span class="line"></span><br><span class="line">				n = get_node(s, slab_nid(slab));</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * Speculatively acquire the list_lock.</span></span><br><span class="line"><span class="comment">				 * If the cmpxchg does not succeed then we may</span></span><br><span class="line"><span class="comment">				 * drop the list_lock without any processing.</span></span><br><span class="line"><span class="comment">				 *</span></span><br><span class="line"><span class="comment">				 * Otherwise the list_lock will synchronize with</span></span><br><span class="line"><span class="comment">				 * other processors updating the list of slabs.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				spin_lock_irqsave(&amp;n-&gt;list_lock, flags);</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">while</span> (!slab_update_freelist(s, slab,</span><br><span class="line">		prior, counters,</span><br><span class="line">		head, <span class="keyword">new</span>.counters,</span><br><span class="line">		<span class="string">&quot;__slab_free&quot;</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (likely(!n)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (likely(was_frozen)) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * The list lock was not taken therefore no list</span></span><br><span class="line"><span class="comment">			 * activity can be necessary.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			stat(s, FREE_FROZEN);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">new</span>.frozen) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we just froze the slab then put it onto the</span></span><br><span class="line"><span class="comment">			 * per cpu partial list.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			put_cpu_partial(s, slab, <span class="number">1</span>);</span><br><span class="line">			stat(s, CPU_PARTIAL_FREE);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!<span class="keyword">new</span>.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial))</span><br><span class="line">		<span class="keyword">goto</span> slab_empty;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Objects left in the slab. If it was not on the partial list before</span></span><br><span class="line"><span class="comment">	 * then add it.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!kmem_cache_has_cpu_partial(s) &amp;&amp; unlikely(!prior)) &#123;</span><br><span class="line">		remove_full(s, n, slab);</span><br><span class="line">		add_partial(n, slab, DEACTIVATE_TO_TAIL);</span><br><span class="line">		stat(s, FREE_ADD_PARTIAL);</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">slab_empty:</span><br><span class="line">	<span class="keyword">if</span> (prior) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Slab on the partial list.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		remove_partial(n, slab);</span><br><span class="line">		stat(s, FREE_REMOVE_PARTIAL);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* Slab must be on the full list */</span></span><br><span class="line">		remove_full(s, n, slab);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">	stat(s, FREE_SLAB);</span><br><span class="line">	discard_slab(s, slab);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿˜æ˜¯<code>kfence</code>å’Œ<code>kmem_cache_debug</code>ç›¸å…³ï¼Œå¦‚æœè®¾ç½®äº†<code>SLAB_DEBUG_FLAGS</code>åˆ™ç›´æ¥è°ƒç”¨<code>free_to_partial_list</code>å‡½æ•°åè¿”å›å³å¯ã€‚</p>
<p>éšåè¿›å…¥å¾ªç¯ï¼Œè¿™é‡Œé¦–å…ˆå°†å¾…é‡Šæ”¾<code>freelist</code>æ‰€å±äºçš„slabçš„<code>freelist</code>å†™åˆ°å¸¦é‡Šæ”¾<code>freelist</code>å¯¹åº”çš„ä½ç½®ï¼Œè¿™é‡Œnewæ˜¯æ ˆä¸Šçš„ä¸´æ—¶slabç»“æ„ä½“ã€‚</p>
<p>ç„¶åè¿›è¡Œåˆ¤æ–­ï¼Œslabçš„æ‰€æœ‰å¯¹è±¡éƒ½æœªè¢«ä½¿ç”¨æˆ–è€…slabä¸Šæ²¡æœ‰ç©ºé—²çš„å¯¹è±¡å¹¶ä¸”slabæœªè¢«å†»ç»“ï¼Œåˆ™ä¼šè¿›å…¥åˆ†æ”¯ä¸­ã€‚è¿›å…¥åˆ†æ”¯ä¹‹åç»§ç»­åˆ¤æ–­ï¼Œé¦–å…ˆæŸ¥çœ‹æ˜¯å¦æœ‰<code>percpu partial slab</code>å¹¶ä¸”slabä¸Šæ²¡æœ‰ç©ºé—²çš„å¯¹è±¡ï¼Œå¦‚æœæˆç«‹åˆ™è®©è¯¥slabå†»ç»“ï¼Œå¦‚æœä¸æ˜¯åˆ™è·å–slabæ‰€å¯¹åº”çš„<code>kmem_cahce_node</code>ã€‚</p>
<p>ç»“æŸå¾ªç¯åï¼Œä¼šåˆ¤æ–­æ˜¯å¦æ‰¾åˆ°<code>kmem_cache_node</code>ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™è¿›å…¥åˆ†æ”¯ä¸­ï¼Œå¦‚æœslabå·²è¢«å†»ç»“ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸æ•¢ï¼Œè‹¥éœ€è¦è¢«å†»ç»“åˆ™è°ƒç”¨<code>put_cpu_partial</code>å‡½æ•°ç›´æ¥å°†slabæ”¾å…¥åˆ°<code>percpu partial</code>é“¾è¡¨ä¸­ï¼Œå®Œæˆé‡Šæ”¾å·¥ä½œã€‚</p>
<p>æ¥ä¸‹æ¥ä¼šåˆ¤æ–­ï¼Œslabçš„è¢«ä½¿ç”¨çš„å¯¹è±¡çš„æ•°é‡æ˜¯å¦ä¸º0å¹¶ä¸”<code>n-&gt;nr_partial == s-&gt;min_partial</code>çš„è¯å°±ä»£è¡¨è¯¥slabçš„æ‰€æœ‰çš„å¯¹è±¡éƒ½è¢«é‡Šæ”¾æ‰äº†å¹¶ä¸”nodeä¸Šçš„<code>partial slab</code>æ•°é‡å·²ç»è¶…è¿‡<code>min_partial</code>äº†ï¼Œè¿™æ—¶ä¼šè·³å…¥<code>slab_empty</code>æ ‡ç­¾ä¸­ã€‚åœ¨<code>slab_empty</code>æ ‡ç­¾çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­å½“å‰slabåŸå…ˆæ˜¯å¦æœ‰ç©ºé—²å¯¹è±¡ï¼Œç„¶åé€‰æ‹©ä»å¯¹åº”çš„åœ°æ–¹ç§»é™¤ï¼Œæœ€åè°ƒç”¨<code>discard_slab</code>å‡½æ•°ï¼Œé‡Šæ”¾è¯¥slabåˆ°å†…å­˜ä¸­ã€‚</p>
<p>å¦‚æœä¸æ»¡è¶³ä¼šåšä¸€äº›æ£€æŸ¥ï¼Œå¹¶ä¸”å¦‚æœä»¥å‰è¯¥slabä½äºfullä¹Ÿå°†è¢«ç§»åˆ°<code>partial</code>ä¸­ã€‚</p>
<h3 id="kfree"><a href="#kfree" class="headerlink" title="kfree"></a>kfree</h3><p>ä¸Šé¢æ˜¯é‡Šæ”¾å¯¹è±¡çš„æ ¸å¿ƒå‡½æ•°é€»è¾‘ï¼Œä¸‹é¢ä¸€æ ·æä¸€ä¸‹ä¸Šå±‚å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">folio</span> *<span class="title">folio</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line"></span><br><span class="line">	trace_kfree(_RET_IP_, object);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(object)))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	folio = virt_to_folio(object);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!folio_test_slab(folio))) &#123;</span><br><span class="line">		free_large_kmalloc(folio, (<span class="keyword">void</span> *)object);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	slab = folio_slab(folio);</span><br><span class="line">	s = slab-&gt;slab_cache;</span><br><span class="line">	__kmem_cache_free(s, (<span class="keyword">void</span> *)object, _RET_IP_);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kfree);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªé—å¿˜ä¸ç†Ÿæ‚‰çš„ç»“æ„ä½“<code>folio</code>ï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯ä¸€å—ç‰©ç†ï¼Œè™šæ‹Ÿï¼Œé€»è¾‘ä¸Šéƒ½æ˜¯è¿ç»­çš„å†…å­˜ï¼Œå…¶æœ¬è´¨æ˜¯å¤ç”¨pageç»“æ„ä½“ç„¶åå°†å…¶è½¬åŒ–ä¸ºäº†<code>folio</code>ç»“æ„ä½“ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°å‡½æ•°æœ€å…ˆä½¿ç”¨<code>virt_to_folio</code>å‡½æ•°å¾—åˆ°äº†<code>folio</code>ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct folio *<span class="title">virt_to_folio</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> virt_to_page(x);</span><br><span class="line">	<span class="keyword">return</span> page_folio(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆè°ƒç”¨<code>virt_to_page</code>å‡½æ•°ä»è™šæ‹Ÿåœ°å€æ‰¾åˆ°å…¶é¡µé¢ï¼Œéšåè°ƒç”¨<code>page_folio</code>å‡½æ•°ä»é¡µé¢è·å¾—<code>folio</code>ç»“æ„ä½“ã€‚</p>
<p>ç„¶åæ ¹æ®åå­—å°±èƒ½çœ‹å‡ºæ¥<code>free_large_kmalloc</code>ä¸»è¦ç”¨äºfreeå¤§çš„å¯¹è±¡ï¼Œè€Œå¤§çš„å¯¹è±¡æ˜¯ä»¥å¤åˆé¡µçš„å½¢å¼å­˜åœ¨çš„ï¼Œæ‰€ä»¥å¦‚æœæ˜¯å¤åˆé¡µåˆ™ä¼šè¿›å…¥åˆ°ifåˆ†æ”¯ä¸­ï¼Œå¦‚æœä¸æ˜¯åˆ™è¿›å…¥åˆ°ä¸‹é¢çš„å†…å®¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_large_kmalloc</span><span class="params">(struct folio *folio, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> order = folio_order(folio);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON_ONCE(order == <span class="number">0</span>))</span><br><span class="line">		pr_warn_once(<span class="string">&quot;object pointer: 0x%p\n&quot;</span>, object);</span><br><span class="line"></span><br><span class="line">	kmemleak_free(object);</span><br><span class="line">	kasan_kfree_large(object);</span><br><span class="line">	kmsan_kfree_large(object);</span><br><span class="line"></span><br><span class="line">	mod_lruvec_page_state(folio_page(folio, <span class="number">0</span>), NR_SLAB_UNRECLAIMABLE_B,</span><br><span class="line">			      -(PAGE_SIZE &lt;&lt; order));</span><br><span class="line">	__free_pages(folio_page(folio, <span class="number">0</span>), order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°åœ¨æœ€åç›´æ¥è°ƒç”¨äº†<code>__free_pages</code>å°†å¯¹è±¡è¿”å›ç»™äº†<code>buddy system</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __kmem_cache_free(struct kmem_cache *s, <span class="keyword">void</span> *x, <span class="keyword">unsigned</span> <span class="keyword">long</span> caller)</span><br><span class="line">&#123;</span><br><span class="line">	slab_free(s, virt_to_slab(x), x, <span class="literal">NULL</span>, &amp;x, <span class="number">1</span>, caller);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œé¢å¯¹æ™®é€šçš„å¯¹è±¡é‡Šæ”¾æ˜¯è°ƒç”¨çš„<code>__kmem_cache_free</code>å‡½æ•°å…¶å†…éƒ¨å…¶å®å°±æ˜¯è°ƒç”¨äº†<code>slab_free</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __fastpath_inline <span class="keyword">void</span> <span class="title">slab_free</span><span class="params">(struct kmem_cache *s, struct slab *slab,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">void</span> *head, <span class="keyword">void</span> *tail, <span class="keyword">void</span> **p, <span class="keyword">int</span> cnt,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	memcg_slab_free_hook(s, slab, p, cnt);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * With KASAN enabled slab_free_freelist_hook modifies the freelist</span></span><br><span class="line"><span class="comment">	 * to remove objects, whose reuse must be delayed.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (slab_free_freelist_hook(s, &amp;head, &amp;tail, &amp;cnt))</span><br><span class="line">		do_slab_free(s, slab, head, tail, cnt, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>slab_free</code>å‡½æ•°å†…éƒ¨æœ€ç»ˆä¹Ÿä¼šè°ƒç”¨åˆ°å‰é¢åˆ†æäº†<code>do_slab_free</code>å‡½æ•°ã€‚</p>
<h2 id="Psprayç®€å•ä»‹ç»"><a href="#Psprayç®€å•ä»‹ç»" class="headerlink" title="Psprayç®€å•ä»‹ç»"></a>Psprayç®€å•ä»‹ç»</h2><p>åœ¨å‰é¢åˆ†æ<code>slab_alloc_node</code>çš„å‡½æ•°ä¸­å‘ç°äº†å­˜åœ¨äº†ä¸¤æ¡è·¯ï¼Œä¸¤æ¡è·¯çš„åå­—åˆ†åˆ«ä¸º<code>fast path</code>å’Œ<code>slow path</code>ï¼Œè€Œè¿™ä¸€åˆ©ç”¨æ‰‹æ³•å°±æ˜¯åŸºäºä¸Šè¿°çš„ä»£ç å®Œæˆçš„ï¼Œè¿™æ˜¯ä¸€é¡¹åŸºäºæ—¶åºä¾§ä¿¡é“çš„æ¼æ´åˆ©ç”¨æŠ€æœ¯ï¼Œé€šè¿‡æ­¤æ–¹æ³•å¯ä»¥å¤§å¹…åº¦æé«˜å†…æ ¸æ¼æ´åˆ©ç”¨æˆåŠŸç‡ã€‚</p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨å†…æ ¸ä¸­æœ‰å¾ˆå¤š <del>åŠ¨ç‰©æœ‹å‹</del> ä¿æŠ¤æœºåˆ¶ï¼Œæ¯”å¦‚CFIï¼ŒKASLRç­‰è¯¸å¤šä¿æŠ¤ï¼Œä½¿å¾—æ”»å‡»è€…ååˆ†éš¾ä»¥å®Œæˆåˆ©ç”¨ã€‚è€Œä¸”ç°å¦‚ä»Šçš„å†…æ ¸åŠ å…¥äº†<code>shadow stack</code>å¹¶ä¸”è¿‘æœŸçˆ†å‡ºçš„è¯¸å¤šæ¼æ´ä¹Ÿéƒ½å’Œå †ç›¸å…³ï¼Œæ‰€ä»¥å†…æ ¸çš„å †åˆ©ç”¨ä¸€ç›´éƒ½æ˜¯å†…æ ¸æ¼æ´çš„ä¸»æµé—¨æ´¾ã€‚ä½†æ˜¯ç©è¿‡å †çš„åº”è¯¥éƒ½çŸ¥é“å†…æ ¸å­˜åœ¨ä¸€ç§æœºåˆ¶æ˜¯<code>slab freelist</code>éšæœºåŒ–ï¼Œè®©æ”»å‡»è€…æ— æ³•é¢„æµ‹åˆ°å³å°†ç”³è¯·çš„å †å—åœ¨ä½•å¤„ï¼Œè¿™ä¹Ÿå°±ä½¿å¾—æ›´åŠ éš¾ä»¥åˆ©ç”¨äº†ã€‚</p>
<p>è€Œä»Šå¤©ç»™å¤§å®¶ä»‹ç»çš„ä¸€ç§åˆ©ç”¨æ‰‹æ³•<code>Pspray</code>å¯ä»¥ç”¨æ¥å¾ˆå¥½çš„å¯¹æŠ—<code>slab freelist</code>çš„éšæœºåŒ–ã€‚</p>
<h2 id="ç°çŠ¶åˆ†æ"><a href="#ç°çŠ¶åˆ†æ" class="headerlink" title="ç°çŠ¶åˆ†æ"></a>ç°çŠ¶åˆ†æ</h2><p><img   src="/images/image-20231123153331621.png"  alt="image-20231123153331621"></p>
<p>ä¸Šå›¾ååˆ†ç®€å•æ˜äº†çš„ç»™å‡ºäº†åˆ†é…ä¸€ä¸ªå¯¹è±¡çš„æµç¨‹ã€‚</p>
<ol>
<li>å¦‚æœåœ¨<code>cpu freelist</code>ä¸­æœ‰åˆ™ç›´æ¥å–ï¼Œå¦‚æœæ²¡æœ‰è¿›å…¥ä¸‹ä¸€é˜¶æ®µ</li>
<li>è¿™é‡Œä»<code>cpu page freelist</code>ä¸­å–ï¼Œæ“ä½œä¸»è¦æ˜¯ç”¨<code>cpu page freelist</code>ç»™åˆ°<code>cpu freelist</code>ï¼Œå³<code>freelist</code>çš„åˆå§‹åŒ–</li>
<li>è¿™é‡Œä»<code>cpu partial list</code>ä¸­å–</li>
<li>è¿™é‡Œä»<code>node partial list</code>ä¸­å–</li>
<li>å…¨éƒ½æ²¡äº†å°±å‘<code>buddy system</code>ç”³è¯·</li>
</ol>
<p>ç„¶åå°±æ˜¯<code>Slab Freelist Random</code>æœºåˆ¶ï¼Œå½“å¼€å¯<code>CONFIG_SLAB_FREELIST_RANDOM</code>é€‰é¡¹æ—¶ä¼šå¼€å¯ä¿æŠ¤ï¼Œä¸»è¦å½¢å¼å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img   src="/images/image-20231123155055348.png"  alt="image-20231123155055348"></p>
<h3 id="Out-Of-Bounds"><a href="#Out-Of-Bounds" class="headerlink" title="Out Of Bounds"></a>Out Of Bounds</h3><p>åœ¨å †åˆ©ç”¨ä¸­æ—¶å¸¸ä¼šé‡åˆ°å †æº¢å‡ºçš„æ¼æ´ï¼Œä¸€èˆ¬æ¥è¯´æˆ‘ä»¬éƒ½æœŸæœ›èƒ½å¤Ÿå®ç°ä¸‹å›¾è¿™æ ·å †çš„å½¢å¼</p>
<p><img   src="/images/image-20231123155332029.png"  alt="image-20231123155332029"></p>
<p>ä½†æ˜¯äº‹ä¸æ„¿è¿ï¼Œå› ä¸ºåœ°å€éšæœºåŒ–çš„å­˜åœ¨å¤§æ¦‚ç‡ä¼šæˆä¸ºä¸‹å›¾è¿™æ ·</p>
<p><img   src="/images/image-20231123155423929.png"  alt="image-20231123155423929"></p>
<p>ä¸­é—´å¯èƒ½éš”ç€å…¶ä»–ç»“æ„ä½“ï¼Œä¸€ç±»çš„æƒ…å†µã€‚</p>
<p>åœ¨å¼€å¯ freelist éšæœºåŒ–ä¹‹åçš„æ¼æ´åˆ©ç”¨æˆåŠŸç‡å¦‚ä¸‹ï¼ŒåŸºäº Linux kernel ä½¿ç”¨ <code>Fisher-Yates shuffle</code> ç®—æ³•æ¥è¿›è¡ŒéšæœºåŒ–è¿™ä¸ªå‰æè®¡ç®—çš„ï¼Œå…¶ä¸­Nä¸ºä¸€å¼  slub ä¸Šçš„æ€»å¯¹è±¡æ•°ï¼ŒåŒæ—¶æˆ‘ä»¬å‡è®¾åœ¨åŒä¸€å¼  slab ä¸Šåˆ†é…äº† 1 ä¸ªæ¼æ´å¯¹è±¡ä¸kä¸ª victim å¯¹è±¡ï¼š</p>
<p><img   src="/images/image-20231123155859344.png"  alt="image-20231123155859344"></p>
<p>ï¼ˆä¸ä¼šå†™æ•°å­¦å…¬å¼ï¼‰</p>
<p>æ€»ä½“è€Œè¨€ï¼Œæˆ‘ä»¬ä»Nä¸ªç©ºé—²å¯¹è±¡ä¸­é€‰æ‹©kä¸ª victim å¯¹è±¡ ä¸ 1 ä¸ªæ¼æ´å¯¹è±¡ï¼Œåœ¨è¿›è¡Œåˆ©ç”¨æ—¶ victim å¯¹è±¡ä¸æ¼æ´å¯¹è±¡å¿…é¡»ç›¸é‚»ï¼Œå› æ­¤æˆ‘ä»¬ä»Nâˆ’1 ä¸ªå¯¹è±¡ä¸­å–å‡ºkä¸ªå¯¹è±¡ï¼ˆè¿˜æœ‰ä¸€ä¸ªä½œä¸ºæ¼æ´å¯¹è±¡ï¼‰ï¼Œå–·å°„çš„ victim å¯¹è±¡æ•°é‡å¯ä»¥ä» 0 åˆ° Nâˆ’1 ï¼Œå› æ­¤å¯¹äºå¸¦æœ‰ random slab freelist çš„ OOB åˆ©ç”¨è€Œè¨€çš„æˆåŠŸç‡è®¡ç®—å¦‚ä¸‹ï¼š</p>
<p><img   src="/images/image-20231123160048017.png"  alt="image-20231123160048017"></p>
<h3 id="Use-After-Free"><a href="#Use-After-Free" class="headerlink" title="Use After Free"></a>Use After Free</h3><p><img   src="/images/image-20231123160326552.png"  alt="image-20231123160326552"></p>
<p>UAF æ¼æ´çš„åˆ©ç”¨é€šå¸¸æ˜¯è¦å°†æ¼æ´å¯¹è±¡ä¸ victim å¯¹è±¡æ”¾åœ¨åŒä¸€å†…å­˜åœ°å€ï¼Œä¸Šå›¾å±•ç¤ºäº†å¯¹ CVE-2019-2215 çš„åˆ©ç”¨è¿‡ç¨‹ï¼Œé¦–å…ˆç”¨ <code>epoll_ctl()</code> åˆ†é…æ¼æ´å¯¹è±¡ï¼Œæ¥ä¸‹æ¥ç”¨ <code>ioctl()</code> é‡Šæ”¾æ¼æ´å¯¹è±¡ï¼Œéšåç”¨ <code>msgsnd()</code> å–å›åˆšåˆšé‡Šæ”¾çš„å¯¹è±¡ï¼Œæœ€åå†ç”¨ <code>close()</code> å°†è¯¥å¯¹è±¡é‡Šæ”¾</p>
<p><img   src="/images/image-20231123160510337.png"  alt="image-20231123160510337"></p>
<p>ä¸Šå›¾ä¸»è¦å±•ç¤ºäº†UAFçš„å¤±è´¥æ¡ˆä¾‹ï¼ŒUAFçš„æˆåŠŸç‡å¦‚ä¸‹</p>
<p><img   src="/images/image-20231123160657856.png"  alt="image-20231123160657856"></p>
<p>ä¸Šå¼ä¸­Aè¡¨ç¤ºçš„åˆ†é…çš„å¯¹è±¡æ•°é‡ï¼ŒNè¡¨ç¤ºä¸€å¼ slabæ‹¥æœ‰çš„å¯¹è±¡æ•°é‡ã€‚æ¼æ´åˆ©ç”¨å¤±è´¥çš„ä¸»è¦åŸå› æ˜¯å¯¹ slab ä¿¡æ¯çš„ç¼ºå¤±ï¼Œæœ¬æ–‡æ‰¾åˆ°äº†ä¸€ç§èƒ½å¤Ÿè·å– slab çš„éƒ¨åˆ†åˆ†é…ä¿¡æ¯çš„æ—¶åºä¾§ä¿¡é“æ–¹æ³•ï¼Œä»è€Œæé«˜åˆ©ç”¨æˆåŠŸæ¦‚ç‡ã€‚</p>
<h2 id="åˆ©ç”¨åŸç†åˆ†æ"><a href="#åˆ©ç”¨åŸç†åˆ†æ" class="headerlink" title="åˆ©ç”¨åŸç†åˆ†æ"></a>åˆ©ç”¨åŸç†åˆ†æ</h2><p>å¦‚å‰é¢çš„ä¸€å¼ å›¾æ‰€ç¤ºï¼ŒSLUB æœ‰äº”æ¡ä¸åŒæ·±åº¦çš„åˆ†é…è·¯å¾„ä»¥ä¼˜åŒ–æ€§èƒ½è¡¨ç°ï¼Œä¸ºäº†å¼„æ¸…ä¸åŒè·¯å¾„çš„è¡¨ç°ï¼Œä½œè€…é€šè¿‡ <code>msgsnd()</code> ç³»ç»Ÿè°ƒç”¨æµ‹è¯•äº†ä» <code>kmalloc()</code> çš„æ ¸å¿ƒå‡½æ•° <code>slab_alloc_node()</code> çš„å¼€å§‹åˆ°ç»“å°¾çš„æ€§èƒ½ï¼Œç»è¿‡å¤šè½®æµ‹è¯•å‘ç° <code>slow-path</code> ä¸å…¶ä»–è·¯å¾„ç›¸æ¯”å­˜åœ¨æ˜æ˜¾çš„è¡¨ç°å·®è·ï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡æµ‹é‡åˆ†é…æ—¶é—´å¾—çŸ¥å†…å­˜åˆ†é…æ‰€ç»å†çš„è·¯å¾„ã€‚</p>
<p><code>slow-path</code> ä»¥å¤–çš„åˆ†é…è·¯å¾„çš„åˆ†é…çŠ¶æ€éƒ½æ˜¯éš¾ä»¥ç¡®å®šçš„ï¼Œä½† <code>slow-path</code> çš„è¡Œä¸ºä¸å…¶ä»–è·¯å¾„ä¸åŒï¼Œæ­¤æ—¶å†…æ ¸ä¼šä»<code>buddy system</code>åˆ†é…ä¸€å¼ æ–° slabï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“å½“å‰çš„ slab åˆšè¢«åˆ†é…ä¸”ä»…åˆ†é…äº†ä¸€ä¸ªå¯¹è±¡</p>
<p>ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨æ—¶åºä¾§ä¿¡é“æ”»å‡»ï¼Œéœ€è¦æ‰¾åˆ°æ»¡è¶³è¿™æ ·ä¸‰ä¸ªæ¡ä»¶çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé¦–å…ˆæ˜¯æ™®é€šç”¨æˆ·å¯ä»¥ä½¿ç”¨ï¼Œå…¶æ¬¡åªåˆ†é…ä¸€ä¸ªå¯¹è±¡ï¼Œæœ€åé™¤äº†åˆ†é…å¯¹è±¡å¤–æ€§èƒ½å¼€é”€è¾ƒå°ã€‚</p>
<p><img   src="/images/image-20231123162356541.png"  alt="image-20231123162356541"></p>
<p>è¿™é‡ŒåŸä½œè€…æ‰¾åˆ°äº†æ»¡è¶³ä¸Šé¢ä¸‰ä¸ªæ¡ä»¶å¹¶ä¸”ä»æ¶µç›–<code>kmalloc-32</code>åˆ°<code>kmalloc-8192</code>çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p><img   src="/images/image-20231123162555768.png"  alt="image-20231123162555768"></p>
<p>è¿™é‡Œä½¿ç”¨<code>msgsnd</code>ç³»ç»Ÿè°ƒç”¨æµ‹è¯•å¾—åˆ°äº†å¦‚ä¸Šå›¾æ‰€ç¤ºçš„ç»“æœï¼Œå¯ä»¥çŸ¥é“çš„äº‹<code>fast path</code>å’Œ<code>medium path</code>ä¸€èˆ¬æ¥è¯´è¾ƒä¸ºéš¾ä»¥åŒºåˆ†ï¼Œä½†æ˜¯åœ¨<code>slow path</code>æ—¶ä¼šæœ‰å¾ˆæ˜æ˜¾çš„æ—¶é—´å·®ã€‚</p>
<p><img   src="/images/image-20231123162822451.png"  alt="image-20231123162822451"></p>
<p>ä¸Šå›¾å±•ç¤ºäº†åˆ©ç”¨<code>Pspray</code>çš„æµç¨‹ï¼š</p>
<ol>
<li>é¦–å…ˆä½¿ç”¨<code>Pspray</code>ç¡®å®šäº†<code>slow path</code>è¢«æ‰§è¡Œï¼Œæ­¤æ—¶æ„å‘³ç€å½“å‰çš„<code>cpu slab</code>æ˜¯æ–°å‘<code>buddy system</code>ç”³è¯·çš„slab</li>
<li>æ¥ä¸‹æ¥å †å–·N-1ä¸ªå¯¹è±¡ä½¿å…¶å®Œå…¨è¢«åˆ†é…</li>
<li>æ­¤æ—¶å¦‚æœå†æ¬¡ç”³è¯·ä¸€ä¸ªå¯¹è±¡åˆ™åˆå›è¿›å…¥åˆ°<code>slow path</code>ä¸­ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªå…¨éƒ¨ä¸ºç©ºçš„slab</li>
<li>ä¸éš¾æƒ³åˆ°çš„æ˜¯å¦‚æœæˆ‘ä»¬çš„<code>Vuln object</code>ä¸åœ¨é«˜åœ°å€é‚£ä¹ˆå°±ä¸€å®šå¯ä»¥å®Œæˆæ¼æ´åˆ©ç”¨</li>
</ol>
<p>æ­¤æ—¶åˆ©ç”¨çš„æˆåŠŸç‡ä¸º</p>
<p><img   src="/images/image-20231123163220066.png"  alt="image-20231123163220066"></p>
<p><img   src="/images/image-20231123163250150.png"  alt="image-20231123163250150"></p>
<p>åé¢çš„UAFçš„æµç¨‹å’Œä¸Šè¿°ç±»ä¼¼ï¼Œå¹¶ä¸”å…¶æˆåŠŸç‡ä¸º</p>
<p><img   src="/images/image-20231123163335334.png"  alt="image-20231123163335334"></p>
<h3 id="å®é™…æµ‹è¯•"><a href="#å®é™…æµ‹è¯•" class="headerlink" title="å®é™…æµ‹è¯•"></a>å®é™…æµ‹è¯•</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">    <span class="keyword">uint64_t</span> prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span> m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">    <span class="keyword">uint64_t</span> security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bind_cpu</span><span class="params">(<span class="keyword">int</span> core)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">rdtsc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;rdtsc;&quot;</span></span><br><span class="line">        <span class="string">&quot;shl rdx,32;&quot;</span></span><br><span class="line">        <span class="string">&quot;add rax,rdx;&quot;</span></span><br><span class="line">        <span class="string">&quot;leave;&quot;</span></span><br><span class="line">        <span class="string">&quot;ret;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msqid[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> exec_time[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msqid_ds</span> <span class="title">ds_buf</span>;</span></span><br><span class="line"></span><br><span class="line">    bind_cpu(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] FAILD to get %d msg_queue!\n&quot;</span>, i);</span><br><span class="line">            perror(<span class="string">&quot;FAILED to get msg_queue&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf = <span class="number">123456</span>;</span><br><span class="line">    ((struct msgbuf *)buf)-&gt;mtype = <span class="number">0xdeadbeef</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> begin, end;</span><br><span class="line"></span><br><span class="line">        begin = rdtsc();</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;buf, <span class="number">512</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] FAILD to send %d msg!\n&quot;</span>, i);</span><br><span class="line">            perror(<span class="string">&quot;FAILED to alloc msg_msg&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        end = rdtsc();</span><br><span class="line"></span><br><span class="line">        exec_time[i] = end - begin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msgrcv(msqid[i], buf, <span class="number">512</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0xdeadbeef</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] FAILD to read %d msg!\n&quot;</span>, i);</span><br><span class="line">            perror(<span class="string">&quot;FAILED to free msg_msg&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msgctl(msqid[i], IPC_RMID, &amp;ds_buf) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] FAILD to delete %d msg_queue!\n&quot;</span>, i);</span><br><span class="line">            perror(<span class="string">&quot;FAILED to free msg_queue&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] Execute time for no.%d msgsnd(): %ld\n&quot;</span>, i, exec_time[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä½¿ç”¨ctfé¢˜ç›®è¿›è¡Œäº†æµ‹è¯•ä¸€ä¸‹ï¼Œå‘ç°è¿˜æ˜¯å­˜åœ¨éå¸¸æ˜æ˜¾çš„æ—¶é—´å·®çš„ã€‚</p>
<p><img   src="/images/image-20231123165208062.png"  alt="image-20231123165208062"></p>
<p>æ€»çš„æ¥è¯´ï¼Œåˆ©ç”¨æ–¹æ³•è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæƒ³å¿…çœ‹å®Œäº†å¤§å®¶ä¹Ÿåº”è¯¥éƒ½æ˜ç™½äº†å¦‚ä½•åˆ©ç”¨æ­¤æ‰‹æ³•ã€‚</p>
<hr>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2023/09/16/PAPER-0X03-PSPRAY/" >https://arttnba3.cn/2023/09/16/PAPER-0X03-PSPRAY/<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://www.usenix.org/system/files/usenixsecurity23-lee-yoochan.pdf" >https://www.usenix.org/system/files/usenixsecurity23-lee-yoochan.pdf<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E5%A0%86%E5%96%B7%E5%B0%84/">å †å–·å°„</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB/">ä¾§ä¿¡é“æ”»å‡»</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/slab%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">slabæºç åˆ†æ</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2024/01/24/Kernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"
                                   title="Kernelå†…å­˜ç®¡ç†"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Kernelå†…å­˜ç®¡ç†</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/11/17/syzkaller%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901/"
                                   title="syzkaller: syz-manageræºç åˆ†æ"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">syzkaller: syz-manageræºç åˆ†æ</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#slub-allocator%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="nav-text">slub allocatoråŸºæœ¬ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#slab"><span class="nav-text">slab</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache"><span class="nav-text">kmem_cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache-cpu"><span class="nav-text">kmem_cache_cpu</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache-node"><span class="nav-text">kmem_cache_node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%86%E9%85%8D"><span class="nav-text">å¯¹è±¡çš„åˆ†é…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#slab-alloc-node"><span class="nav-text">slab_alloc_node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmalloc"><span class="nav-text">kmalloc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E9%87%8A%E6%94%BE"><span class="nav-text">å¯¹è±¡çš„é‡Šæ”¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#do-slab-free"><span class="nav-text">do_slab_free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kfree"><span class="nav-text">kfree</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pspray%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="nav-text">Psprayç®€å•ä»‹ç»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%B0%E7%8A%B6%E5%88%86%E6%9E%90"><span class="nav-text">ç°çŠ¶åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Out-Of-Bounds"><span class="nav-text">Out Of Bounds</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-After-Free"><span class="nav-text">Use After Free</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-text">åˆ©ç”¨åŸç†åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E6%B5%8B%E8%AF%95"><span class="nav-text">å®é™…æµ‹è¯•</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2026
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">345.9k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#slub-allocator%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="nav-text">slub allocatoråŸºæœ¬ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#slab"><span class="nav-text">slab</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache"><span class="nav-text">kmem_cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache-cpu"><span class="nav-text">kmem_cache_cpu</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache-node"><span class="nav-text">kmem_cache_node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%86%E9%85%8D"><span class="nav-text">å¯¹è±¡çš„åˆ†é…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#slab-alloc-node"><span class="nav-text">slab_alloc_node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmalloc"><span class="nav-text">kmalloc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E9%87%8A%E6%94%BE"><span class="nav-text">å¯¹è±¡çš„é‡Šæ”¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#do-slab-free"><span class="nav-text">do_slab_free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kfree"><span class="nav-text">kfree</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pspray%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D"><span class="nav-text">Psprayç®€å•ä»‹ç»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%B0%E7%8A%B6%E5%88%86%E6%9E%90"><span class="nav-text">ç°çŠ¶åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Out-Of-Bounds"><span class="nav-text">Out Of Bounds</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-After-Free"><span class="nav-text">Use After Free</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-text">åˆ©ç”¨åŸç†åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E6%B5%8B%E8%AF%95"><span class="nav-text">å®é™…æµ‹è¯•</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
