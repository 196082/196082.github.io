<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            netfilter |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/rocket-lunch.svg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/rocket-lunch.svg"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        netfilter
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2025-01-04 11:32:40</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Sat Jan 18 2025 18:32:15 GMT+0800">2025-01-18 18:32:15</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/netfilter/">netfilter</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>3.2k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>16 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸çŸ¥é“ç»§ç»­çœ‹nftablesæ˜¯ä¸æ˜¯ä¸€ä¸ªé”™è¯¯çš„å†³å®šï¼Œå› ä¸ºå¥½åƒè¿™ä¸ªå­ç³»ç»Ÿæœ€è¿‘çš„æ›´æ–°éƒ½åªæ˜¯ç”¨æˆ·æ€çš„å·¥å…·æ›´æ–°äº†ï¼Œå¹¶ä¸”åœ¨ä»Šå¹´ä¸‹åŠå¹´æ²¡æœ‰è§åˆ°æœ‰æ–°çš„ç›¸å…³CVEã€‚ä½†æ˜¯åœ¨ä¹‹å‰å¯¹æ­¤å­ç³»ç»Ÿè¿›è¡Œåˆ†æçš„æ—¶å€™åˆ†æçš„èŠ‚å¥æ˜¯éå¸¸çš„ç‰‡é¢çš„ï¼Œå¯¹äºå…¶ä¸­å¾ˆå¤šæ¨¡å—çš„å®ç°ç›®çš„éƒ½ä¸å¤ªæ¸…æ¥šï¼Œåœ¨ç»å†äº†è¿™å‡ ä¸ªæœˆç‰¹åˆ«æ˜¯å’Œæˆ‘çš„åŒäº‹äº¤æµå­¦ä¹ ä»¥åŠæˆ‘è‡ªå·±åˆå›è¿‡å¤´å»æŒ–äº†å‡ ä¸ªè·¯ç”±å™¨çš„æ´ä¹‹åæ„Ÿè§‰è‡ªå·±å¯¹å®¡è®¡ä»£ç åˆæœ‰äº†æ›´æ–°çš„è®¤è¯†ã€‚æ‰€ä»¥ï¼Œæˆ‘æœ€ç»ˆè¿˜æ˜¯è§‰å¾—å°†netfilterä»å¤´åˆ°å°¾åˆ†æä¸€è¾¹ï¼Œå³ä¾¿æ˜¯æ²¡æœ‰æ‰¾åˆ°æ¼æ´ä¹Ÿæ˜¯ä¸€æ¬¡ä¸é”™çš„å­¦ä¹ ç»å†ã€‚å¦‚æœåœ¨è¿™ä¸€éåˆ†æä¹‹åæˆ‘ä»æœªå‘ç°å¯ç–‘çš„ä»£ç å¯èƒ½å°±ä¼šé€‰æ‹©å»åˆ†æebpfæˆ–æ˜¯å…¶ä»–é—­æºçš„iotè®¾å¤‡äº†ã€‚</p>
<h2 id="netfilteråˆå§‹åŒ–åˆ†æ"><a href="#netfilteråˆå§‹åŒ–åˆ†æ" class="headerlink" title="netfilteråˆå§‹åŒ–åˆ†æ"></a>netfilteråˆå§‹åŒ–åˆ†æ</h2><p><img  
                       lazyload
                       alt="image"
                       data-src="/%5Cimages%5Cnf-hooks.png"
                       
                 ></p>
<p>æœ¬æ–‡çš„å†…å®¹åŸºæœ¬å›´ç»•ä¸Šå›¾å±•å¼€ï¼Œåº”è¯¥ä¼šæ¶µç›–ä¸Šå›¾çš„æ‰€æœ‰éƒ¨åˆ†ä»¥åŠä¸Šå›¾ä¸­ä¸å­˜åœ¨çš„éƒ¨åˆ†ã€‚</p>
<h3 id="HOOKåˆå§‹åŒ–"><a href="#HOOKåˆå§‹åŒ–" class="headerlink" title="HOOKåˆå§‹åŒ–"></a>HOOKåˆå§‹åŒ–</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">netfilter_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = register_pernet_subsys(&amp;netfilter_net_ops);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LWTUNNEL</span></span><br><span class="line">	ret = netfilter_lwtunnel_init();</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_lwtunnel_pernet;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	ret = netfilter_log_init();</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_log_pernet;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err_log_pernet:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LWTUNNEL</span></span><br><span class="line">	netfilter_lwtunnel_fini();</span><br><span class="line">err_lwtunnel_pernet:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	unregister_pernet_subsys(&amp;netfilter_net_ops);</span><br><span class="line">err:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå…³äºnetfilterçš„åˆå§‹åŒ–ååˆ†ç®€å•ï¼Œå…¶ä¸­æœ€é‡è¦çš„éƒ¨åˆ†å°±æ˜¯æ³¨å†Œäº†å­ç³»ç»Ÿã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __net_init</span><br><span class="line">__netfilter_net_init(struct nf_hook_entries __rcu **e, <span class="keyword">int</span> max)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> h;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (h = <span class="number">0</span>; h &lt; max; h++)</span><br><span class="line">		RCU_INIT_POINTER(e[h], <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __net_init <span class="title">netfilter_net_init</span><span class="params">(struct net *net)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__netfilter_net_init(net-&gt;nf.hooks_ipv4, ARRAY_SIZE(net-&gt;nf.hooks_ipv4));</span><br><span class="line">	__netfilter_net_init(net-&gt;nf.hooks_ipv6, ARRAY_SIZE(net-&gt;nf.hooks_ipv6));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_ARP</span></span><br><span class="line">	__netfilter_net_init(net-&gt;nf.hooks_arp, ARRAY_SIZE(net-&gt;nf.hooks_arp));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_BRIDGE</span></span><br><span class="line">	__netfilter_net_init(net-&gt;nf.hooks_bridge, ARRAY_SIZE(net-&gt;nf.hooks_bridge));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PROC_FS</span></span><br><span class="line">	net-&gt;nf.proc_netfilter = proc_net_mkdir(net, <span class="string">&quot;netfilter&quot;</span>,</span><br><span class="line">						net-&gt;proc_net);</span><br><span class="line">	<span class="keyword">if</span> (!net-&gt;nf.proc_netfilter) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!net_eq(net, &amp;init_net))</span><br><span class="line">			pr_err(<span class="string">&quot;cannot create netfilter proc entry&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨ç³»ç»Ÿçš„åˆå§‹åŒ–å‡½æ•°ä¸­å°±æ˜¯ç®€å•çš„åˆå§‹åŒ–äº†å„ä¸ªhookï¼Œå³å°†æ•°ç»„èµ‹å€¼ä¸ºnull</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">netns_nf</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined CONFIG_PROC_FS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">proc_dir_entry</span> *<span class="title">proc_netfilter</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_logger</span> __<span class="title">rcu</span> *<span class="title">nf_loggers</span>[<span class="title">NFPROTO_NUMPROTO</span>];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSCTL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ctl_table_header</span> *<span class="title">nf_log_dir_header</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LWTUNNEL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ctl_table_header</span> *<span class="title">nf_lwtnl_dir_header</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> __<span class="title">rcu</span> *<span class="title">hooks_ipv4</span>[<span class="title">NF_INET_NUMHOOKS</span>];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> __<span class="title">rcu</span> *<span class="title">hooks_ipv6</span>[<span class="title">NF_INET_NUMHOOKS</span>];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_ARP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> __<span class="title">rcu</span> *<span class="title">hooks_arp</span>[<span class="title">NF_ARP_NUMHOOKS</span>];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_BRIDGE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> __<span class="title">rcu</span> *<span class="title">hooks_bridge</span>[<span class="title">NF_INET_NUMHOOKS</span>];</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_NF_DEFRAG_IPV4)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> defrag_ipv4_users;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_NF_DEFRAG_IPV6)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> defrag_ipv6_users;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°å°±æ˜¯åœ¨netç»“æ„ä½“ä¸­ç”¨äºè¡¨ç¤ºnetfilterçš„ç»“æ„ä½“ï¼Œå¯ä»¥çœ‹åˆ°çš„æ˜¯é»˜è®¤æœ‰çš„æ˜¯ipv4ã€ipv4ä»¥åŠloggersè¿™ä¸‰ä¸ªæˆå‘˜ï¼Œåœ¨å¼€å¯ç›¸åº”é€‰é¡¹å°±ä¼šå¼€å¯ç›¸åº”çš„æˆå‘˜å¦‚arpçš„hookã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> &#123;</span></span><br><span class="line">	u16				num_hook_entries;</span><br><span class="line">	<span class="comment">/* padding */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entry</span>		<span class="title">hooks</span>[];</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* trailer: pointers to original orig_ops of each hook,</span></span><br><span class="line"><span class="comment">	 * followed by rcu_head and scratch space used for freeing</span></span><br><span class="line"><span class="comment">	 * the structure via call_rcu.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *   This is not part of struct nf_hook_entry since its only</span></span><br><span class="line"><span class="comment">	 *   needed in slow path (hook register/unregister):</span></span><br><span class="line"><span class="comment">	 * const struct nf_hook_ops     *orig_ops[]</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *   For the same reason, we store this at end -- its</span></span><br><span class="line"><span class="comment">	 *   only needed when a hook is deleted, not during</span></span><br><span class="line"><span class="comment">	 *   packet path processing:</span></span><br><span class="line"><span class="comment">	 * struct nf_hook_entries_rcu_head     head</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„æ³¨é‡Šè¯´æ˜çš„å¤§æ¦‚æ˜¯ï¼ˆæˆ‘è‹±æ–‡ä¸å¥½ï¼Œé€šè¿‡çœ‹æºç åˆ†æå‡ºæ¥çš„ï¼‰åé¢ä¼šåœ¨ç”³è¯·æ”¹ç»“æ„ä½“æ—¶ä¸º<code>orig_ops[]</code>å’Œ<code>head</code>ç•™ç©ºé—´ã€‚</p>
<p>ä¸Šè¿°ç»“æ„ä½“ä¸­çš„<code>num_hook_entries</code>çš„å«ä¹‰ä¹Ÿå°±æ˜¯åœ¨è¯¥hookç‚¹æœ‰å¤šå°‘entryã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> &#123;</span></span><br><span class="line">	<span class="comment">/* User fills in from here down. */</span></span><br><span class="line">	nf_hookfn		*hook;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net_device</span>	*<span class="title">dev</span>;</span></span><br><span class="line">	<span class="keyword">void</span>			*priv;</span><br><span class="line">	u8			pf;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">nf_hook_ops_type</span>	<span class="title">hook_ops_type</span>:</span><span class="number">8</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		hooknum;</span><br><span class="line">	<span class="comment">/* Hooks are ordered in ascending priority. */</span></span><br><span class="line">	<span class="keyword">int</span>			priority;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸€å‡½æ•°å°±ä¸­ç›®å‰éœ€è¦æ³¨æ„çš„æ˜¯pfæˆå‘˜æŒ‡ä»£çš„æ˜¯è¯¥hookçš„åè®®ï¼Œè¿˜æœ‰hooknumæˆå‘˜æŒ‡ä»£çš„æ˜¯æ‰€ä½äºçš„hookç‚¹ï¼Œåœ¨åç»­çš„æ³¨å†Œhookçš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªæˆå‘˜æ¥ç¡®å®šä½ç½®çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">nf_inet_hooks</span> &#123;</span></span><br><span class="line">	NF_INET_PRE_ROUTING,</span><br><span class="line">	NF_INET_LOCAL_IN,</span><br><span class="line">	NF_INET_FORWARD,</span><br><span class="line">	NF_INET_LOCAL_OUT,</span><br><span class="line">	NF_INET_POST_ROUTING,</span><br><span class="line">	NF_INET_NUMHOOKS,</span><br><span class="line">	NF_INET_INGRESS = NF_INET_NUMHOOKS,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„hooknumé¡»ä¸ºä»¥ä¸Šä¸­çš„ä¸€ä¸ªï¼Œè¿™ä¹ˆæ¥çœ‹å°±å¯ä»¥å¾ˆæ¸…æ™°çš„çŸ¥é“äº†<code>nf_hook_ops</code>ç»“æ„ä½“ä¸­æ¯”è¾ƒé‡è¦çš„æˆå‘˜çš„å«ä¹‰äº†ã€‚</p>
<h3 id="HOOKæ³¨å†Œè¿‡ç¨‹"><a href="#HOOKæ³¨å†Œè¿‡ç¨‹" class="headerlink" title="HOOKæ³¨å†Œè¿‡ç¨‹"></a>HOOKæ³¨å†Œè¿‡ç¨‹</h3><p>åœ¨nftableä¸­ï¼Œæ²¡æœ‰åˆå§‹åŒ–ç›¸åº”hookï¼Œå®ƒæ˜¯é€šè¿‡ç”¨æˆ·æŒ‡å®šbase chainåˆ°æŸä¸€ä¸ªhookç‚¹ä¸­ã€‚</p>
<p>ä½†æ˜¯åœ¨nftableä¸­æœ‰ä¸€ä¸ªåˆå§‹åŒ–opsçš„è¿‡ç¨‹ï¼ˆåœ¨æ­¤å¤„ä»…åˆå§‹åŒ–ä»¥ä¸‹éƒ¨åˆ†hookï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __init <span class="title">nft_chain_filter_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = nft_chain_filter_netdev_init();</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	nft_chain_filter_ipv4_init();</span><br><span class="line">	nft_chain_filter_ipv6_init();</span><br><span class="line">	nft_chain_filter_arp_init();</span><br><span class="line">	nft_chain_filter_inet_init();</span><br><span class="line">	nft_chain_filter_bridge_init();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°å‡½æ•°ä¼šå¯¹å‡ ç§åè®®è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">nft_do_chain_ipv4</span><span class="params">(<span class="keyword">void</span> *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">const</span> struct nf_hook_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pktinfo</span> <span class="title">pkt</span>;</span></span><br><span class="line"></span><br><span class="line">	nft_set_pktinfo(&amp;pkt, skb, state);</span><br><span class="line">	nft_set_pktinfo_ipv4(&amp;pkt);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nft_do_chain(&amp;pkt, priv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nft_chain_type</span> <span class="title">nft_chain_filter_ipv4</span> =</span> &#123;</span><br><span class="line">	.name		= <span class="string">&quot;filter&quot;</span>,</span><br><span class="line">	.type		= NFT_CHAIN_T_DEFAULT,</span><br><span class="line">	.family		= NFPROTO_IPV4,</span><br><span class="line">	.hook_mask	= (<span class="number">1</span> &lt;&lt; NF_INET_LOCAL_IN) |</span><br><span class="line">			  (<span class="number">1</span> &lt;&lt; NF_INET_LOCAL_OUT) |</span><br><span class="line">			  (<span class="number">1</span> &lt;&lt; NF_INET_FORWARD) |</span><br><span class="line">			  (<span class="number">1</span> &lt;&lt; NF_INET_PRE_ROUTING) |</span><br><span class="line">			  (<span class="number">1</span> &lt;&lt; NF_INET_POST_ROUTING),</span><br><span class="line">	.hooks		= &#123;</span><br><span class="line">		[NF_INET_LOCAL_IN]	= nft_do_chain_ipv4,</span><br><span class="line">		[NF_INET_LOCAL_OUT]	= nft_do_chain_ipv4,</span><br><span class="line">		[NF_INET_FORWARD]	= nft_do_chain_ipv4,</span><br><span class="line">		[NF_INET_PRE_ROUTING]	= nft_do_chain_ipv4,</span><br><span class="line">		[NF_INET_POST_ROUTING]	= nft_do_chain_ipv4,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_chain_filter_ipv4_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	nft_register_chain_type(&amp;nft_chain_filter_ipv4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä»¥ipv4ä½ä¾‹ï¼Œä¸Šé¢ä¼šæ‰§è¡Œ<code>nft_register_chain_type</code>å‡½æ•°å°†å‰é¢çš„ç»“æ„ä½“è¿›è¡Œæ³¨å†Œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nft_register_chain_type</span><span class="params">(<span class="keyword">const</span> struct nft_chain_type *ctype)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	nfnl_lock(NFNL_SUBSYS_NFTABLES);</span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(__nft_chain_type_get(ctype-&gt;family, ctype-&gt;type))) &#123;</span><br><span class="line">		nfnl_unlock(NFNL_SUBSYS_NFTABLES);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	chain_type[ctype-&gt;family][ctype-&gt;type] = ctype;</span><br><span class="line">	nfnl_unlock(NFNL_SUBSYS_NFTABLES);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(nft_register_chain_type);</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°çš„å®ç°å¦‚ä¸Šï¼Œä¸»è¦æ˜¯é€šè¿‡ç»“æ„ä½“çš„åè®®æ—ä»¥åŠç±»å‹è¿›è¡Œå®šä½ï¼Œå°†å…¶æ”¾å…¥åˆ°å…¨å±€å˜é‡<code>chain_type</code>ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_addchain</span><span class="params">(struct nft_ctx *ctx, u8 family, u8 genmask,</span></span></span><br><span class="line"><span class="params"><span class="function">			      u8 policy, u32 flags,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct netlink_ext_ack *extack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nlattr</span> * <span class="title">const</span> *<span class="title">nla</span> =</span> ctx-&gt;nla;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_table</span> *<span class="title">table</span> =</span> ctx-&gt;table;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_base_chain</span> *<span class="title">basechain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> ctx-&gt;net;</span><br><span class="line">	<span class="keyword">char</span> name[NFT_NAME_MAXLEN];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_rule_blob</span> *<span class="title">blob</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_trans</span> *<span class="title">trans</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nla[NFTA_CHAIN_HOOK]) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_stats</span> __<span class="title">percpu</span> *<span class="title">stats</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain_hook</span> <span class="title">hook</span> =</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (table-&gt;flags &amp; __NFT_TABLE_F_UPDATE)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (flags &amp; NFT_CHAIN_BINDING)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"></span><br><span class="line">		err = nft_chain_parse_hook(net, <span class="literal">NULL</span>, nla, &amp;hook, family, flags,</span><br><span class="line">					   extack);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">		basechain = kzalloc(<span class="keyword">sizeof</span>(*basechain), GFP_KERNEL_ACCOUNT);</span><br><span class="line">		<span class="keyword">if</span> (basechain == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			nft_chain_release_hook(&amp;hook);</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">		&#125;</span><br><span class="line">		chain = &amp;basechain-&gt;chain;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (nla[NFTA_CHAIN_COUNTERS]) &#123;</span><br><span class="line">			stats = nft_stats_alloc(nla[NFTA_CHAIN_COUNTERS]);</span><br><span class="line">			<span class="keyword">if</span> (IS_ERR(stats)) &#123;</span><br><span class="line">				nft_chain_release_hook(&amp;hook);</span><br><span class="line">				kfree(basechain);</span><br><span class="line">				<span class="keyword">return</span> PTR_ERR(stats);</span><br><span class="line">			&#125;</span><br><span class="line">			rcu_assign_pointer(basechain-&gt;stats, stats);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		err = nft_basechain_init(basechain, family, &amp;hook, flags);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			nft_chain_release_hook(&amp;hook);</span><br><span class="line">			kfree(basechain);</span><br><span class="line">			free_percpu(stats);</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (stats)</span><br><span class="line">			static_branch_inc(&amp;nft_counters_enabled);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This must be LAST to ensure no packets are walking over this chain. */</span></span><br><span class="line">	err = nf_tables_register_hook(net, table, chain);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_register_hook;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_register_hook:</span><br><span class="line">	nft_chain_del(chain);</span><br><span class="line">err_chain_add:</span><br><span class="line">	nft_trans_destroy(trans);</span><br><span class="line">err_trans:</span><br><span class="line">	nft_use_dec_restore(&amp;table-&gt;use);</span><br><span class="line">err_destroy_chain:</span><br><span class="line">	nf_tables_chain_destroy(ctx);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ç”¨æˆ·æŒ‡å®šäº†<code>NFTA_CHAIN_HOOK</code>å°±ä¼šè¿›å…¥åˆ°base chainçš„åˆ†æ”¯ä¸­ï¼Œè¿™é‡Œé¦–å…ˆä¼šé€šè¿‡<code>nft_chain_parse_hook</code>å‡½æ•°è¿›è¡Œè§£æhookï¼Œå…¶å†…å®¹ä¸»è¦æ˜¯è·å–åˆ°hookçš„åè®®ã€hookç‚¹ä½ã€ä¼˜å…ˆçº§ä»¥åŠtypeï¼ˆå³å‰é¢çš„ç»“æ„ä½“ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nft_basechain_init</span><span class="params">(struct nft_base_chain *basechain, u8 family,</span></span></span><br><span class="line"><span class="params"><span class="function">			      struct nft_chain_hook *hook, u32 flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_chain</span> *<span class="title">chain</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_hook</span> *<span class="title">h</span>;</span></span><br><span class="line"></span><br><span class="line">	basechain-&gt;type = hook-&gt;type;</span><br><span class="line">	INIT_LIST_HEAD(&amp;basechain-&gt;hook_list);</span><br><span class="line">	chain = &amp;basechain-&gt;chain;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_base_chain_netdev(family, hook-&gt;num)) &#123;</span><br><span class="line">		list_splice_init(&amp;hook-&gt;<span class="built_in">list</span>, &amp;basechain-&gt;hook_list);</span><br><span class="line">		list_for_each_entry(h, &amp;basechain-&gt;hook_list, <span class="built_in">list</span>)</span><br><span class="line">			nft_basechain_hook_init(&amp;h-&gt;ops, family, hook, chain);</span><br><span class="line">	&#125;</span><br><span class="line">	nft_basechain_hook_init(&amp;basechain-&gt;ops, family, hook, chain);</span><br><span class="line"></span><br><span class="line">	chain-&gt;flags |= NFT_CHAIN_BASE | flags;</span><br><span class="line">	basechain-&gt;policy = NF_ACCEPT;</span><br><span class="line">	<span class="keyword">if</span> (chain-&gt;flags &amp; NFT_CHAIN_HW_OFFLOAD &amp;&amp;</span><br><span class="line">	    !nft_chain_offload_support(basechain)) &#123;</span><br><span class="line">		list_splice_init(&amp;basechain-&gt;hook_list, &amp;hook-&gt;<span class="built_in">list</span>);</span><br><span class="line">		<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flow_block_init(&amp;basechain-&gt;flow_block);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éšåé€šè¿‡<code>nft_basechain_init</code>å‡½æ•°åˆå§‹åŒ–base chainã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">nft_basechain_hook_init</span><span class="params">(struct nf_hook_ops *ops, u8 family,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">const</span> struct nft_chain_hook *hook,</span></span></span><br><span class="line"><span class="params"><span class="function">				    struct nft_chain *chain)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ops-&gt;pf			= family;</span><br><span class="line">	ops-&gt;hooknum		= hook-&gt;num;</span><br><span class="line">	ops-&gt;priority		= hook-&gt;priority;</span><br><span class="line">	ops-&gt;priv		= chain;</span><br><span class="line">	ops-&gt;hook		= hook-&gt;type-&gt;hooks[ops-&gt;hooknum];</span><br><span class="line">	ops-&gt;hook_ops_type	= NF_HOOK_OP_NF_TABLES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å…¶ä¸­ä¸»è¦é€šè¿‡<code>nft_basechain_hook_init</code>å‡½æ•°å¯¹base chainçš„opsè¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nf_tables_register_hook</span><span class="params">(struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">				   <span class="keyword">const</span> struct nft_table *table,</span></span></span><br><span class="line"><span class="params"><span class="function">				   struct nft_chain *chain)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_base_chain</span> *<span class="title">basechain</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (table-&gt;flags &amp; NFT_TABLE_F_DORMANT ||</span><br><span class="line">	    !nft_is_base_chain(chain))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	basechain = nft_base_chain(chain);</span><br><span class="line">	ops = &amp;basechain-&gt;ops;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (basechain-&gt;type-&gt;ops_register)</span><br><span class="line">		<span class="keyword">return</span> basechain-&gt;type-&gt;ops_register(net, ops);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nft_base_chain_netdev(table-&gt;family, basechain-&gt;ops.hooknum))</span><br><span class="line">		<span class="keyword">return</span> nft_netdev_register_hooks(net, &amp;basechain-&gt;hook_list);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nf_register_net_hook(net, &amp;basechain-&gt;ops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å®Œæˆå¯¹base chainçš„åˆå§‹åŒ–ä¹‹åï¼Œä¼šåœ¨æ·»åŠ chainçš„æœ€åä¸€æ­¥è¿›å…¥åˆ°<code>nf_tables_register_hook</code>å‡½æ•°ä¸­ï¼Œå°†base chainæ³¨å†Œåˆ°hookã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_register_net_hook</span><span class="params">(struct net *net, <span class="keyword">const</span> struct nf_hook_ops *reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (reg-&gt;pf == NFPROTO_INET) &#123;</span><br><span class="line">		<span class="keyword">if</span> (reg-&gt;hooknum == NF_INET_INGRESS) &#123;</span><br><span class="line">			err = __nf_register_net_hook(net, NFPROTO_INET, reg);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> err;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			err = __nf_register_net_hook(net, NFPROTO_IPV4, reg);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">			err = __nf_register_net_hook(net, NFPROTO_IPV6, reg);</span><br><span class="line">			<span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				__nf_unregister_net_hook(net, NFPROTO_IPV4, reg);</span><br><span class="line">				<span class="keyword">return</span> err;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		err = __nf_register_net_hook(net, reg-&gt;pf, reg);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nf_register_net_hook);</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°å‡½æ•°ä¼šæ ¹æ®åè®®è¿›å…¥ä¸åŒåˆ†æ”¯ç„¶åæ‰§è¡Œ<code>__nf_register_net_hook</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __nf_register_net_hook(struct net *net, <span class="keyword">int</span> pf,</span><br><span class="line">				  <span class="keyword">const</span> struct nf_hook_ops *reg)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> *<span class="title">p</span>, *<span class="title">new_hooks</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> __<span class="title">rcu</span> **<span class="title">pp</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (pf) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFPROTO_NETDEV:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_NETFILTER_INGRESS</span></span><br><span class="line">		<span class="keyword">if</span> (reg-&gt;hooknum == NF_NETDEV_INGRESS)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_NETFILTER_EGRESS</span></span><br><span class="line">		<span class="keyword">if</span> (reg-&gt;hooknum == NF_NETDEV_EGRESS)</span><br><span class="line">			<span class="keyword">return</span> -EOPNOTSUPP;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">if</span> ((reg-&gt;hooknum != NF_NETDEV_INGRESS &amp;&amp;</span><br><span class="line">		     reg-&gt;hooknum != NF_NETDEV_EGRESS) ||</span><br><span class="line">		    !reg-&gt;dev || dev_net(reg-&gt;dev) != net)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFPROTO_INET:</span><br><span class="line">		<span class="keyword">if</span> (reg-&gt;hooknum != NF_INET_INGRESS)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		err = nf_ingress_check(net, reg, NF_INET_INGRESS);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> err;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pp = nf_hook_entry_head(net, pf, reg-&gt;hooknum, reg-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (!pp)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;nf_hook_mutex);</span><br><span class="line"></span><br><span class="line">	p = nf_entry_dereference(*pp);</span><br><span class="line">	new_hooks = nf_hook_entries_grow(p, reg);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!IS_ERR(new_hooks)) &#123;</span><br><span class="line">		hooks_validate(new_hooks);</span><br><span class="line">		rcu_assign_pointer(*pp, new_hooks);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;nf_hook_mutex);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(new_hooks))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(new_hooks);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER_INGRESS</span></span><br><span class="line">	<span class="keyword">if</span> (nf_ingress_hook(reg, pf))</span><br><span class="line">		net_inc_ingress_queue();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER_EGRESS</span></span><br><span class="line">	<span class="keyword">if</span> (nf_egress_hook(reg, pf))</span><br><span class="line">		net_inc_egress_queue();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	nf_static_key_inc(reg, pf);</span><br><span class="line"></span><br><span class="line">	BUG_ON(p == new_hooks);</span><br><span class="line">	nf_hook_entries_free(p);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰é¢çš„switchä¸»è¦åšçš„äº‹å°±æ˜¯éªŒè¯åè®®å’Œopsæ˜¯å¦åˆæ³•ã€‚éšåé€šè¿‡<code>nf_hook_entry_head</code>å‡½æ•°æ‰¾åˆ°<code>nf_hook_entries</code>çš„å¤´ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct nf_hook_entries *</span></span><br><span class="line"><span class="function"><span class="title">nf_hook_entries_grow</span><span class="params">(<span class="keyword">const</span> struct nf_hook_entries *old,</span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="keyword">const</span> struct nf_hook_ops *reg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i, alloc_entries, nhooks, old_entries;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> **<span class="title">orig_ops</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> **<span class="title">new_ops</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> *<span class="title">new</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> inserted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	alloc_entries = <span class="number">1</span>;</span><br><span class="line">	old_entries = old ? old-&gt;num_hook_entries : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (old) &#123;</span><br><span class="line">		orig_ops = nf_hook_entries_get_hook_ops(old);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; old_entries; i++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (orig_ops[i] != &amp;dummy_ops)</span><br><span class="line">				alloc_entries++;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Restrict BPF hook type to force a unique priority, not</span></span><br><span class="line"><span class="comment">			 * shared at attach time.</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * This is mainly to avoid ordering issues between two</span></span><br><span class="line"><span class="comment">			 * different bpf programs, this doesn&#x27;t prevent a normal</span></span><br><span class="line"><span class="comment">			 * hook at same priority as a bpf one (we don&#x27;t want to</span></span><br><span class="line"><span class="comment">			 * prevent defrag, conntrack, iptables etc from attaching).</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (reg-&gt;priority == orig_ops[i]-&gt;priority &amp;&amp;</span><br><span class="line">			    reg-&gt;hook_ops_type == NF_HOOK_OP_BPF)</span><br><span class="line">				<span class="keyword">return</span> ERR_PTR(-EBUSY);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (alloc_entries &gt; MAX_HOOK_COUNT)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-E2BIG);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">new</span> = allocate_hook_entries_size(alloc_entries);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">new</span>)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	new_ops = nf_hook_entries_get_hook_ops(<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">	i = <span class="number">0</span>;</span><br><span class="line">	nhooks = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (i &lt; old_entries) &#123;</span><br><span class="line">		<span class="keyword">if</span> (orig_ops[i] == &amp;dummy_ops) &#123;</span><br><span class="line">			++i;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (inserted || reg-&gt;priority &gt; orig_ops[i]-&gt;priority) &#123;</span><br><span class="line">			new_ops[nhooks] = (<span class="keyword">void</span> *)orig_ops[i];</span><br><span class="line">			<span class="keyword">new</span>-&gt;hooks[nhooks] = old-&gt;hooks[i];</span><br><span class="line">			i++;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			new_ops[nhooks] = (<span class="keyword">void</span> *)reg;</span><br><span class="line">			<span class="keyword">new</span>-&gt;hooks[nhooks].hook = reg-&gt;hook;</span><br><span class="line">			<span class="keyword">new</span>-&gt;hooks[nhooks].priv = reg-&gt;priv;</span><br><span class="line">			inserted = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		nhooks++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!inserted) &#123;</span><br><span class="line">		new_ops[nhooks] = (<span class="keyword">void</span> *)reg;</span><br><span class="line">		<span class="keyword">new</span>-&gt;hooks[nhooks].hook = reg-&gt;hook;</span><br><span class="line">		<span class="keyword">new</span>-&gt;hooks[nhooks].priv = reg-&gt;priv;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éšåè¿›å…¥åˆ°<code>nf_hook_entries_grow</code>å‡½æ•°è·å¾—æ–°çš„<code>nf_hook_entries</code>ã€‚åˆ°è¿™ä¸€æ­¥å°±å¯ä»¥ç†è§£åˆ°å‰é¢æˆ‘æ‰€æåˆ°çš„<code>nf_hook_entries</code>ç»“æ„ä½“çš„ç”³è¯·ï¼ŒååŠéƒ¨åˆ†å°±æ˜¯æ ¹æ®priorityè¿›è¡Œæ’åºï¼Œå…·ä½“é€»è¾‘å¾ˆç®€å•å°±ä¸å¤šèµ˜è¿°ã€‚</p>
<p>åç»­åˆ™æ˜¯å°†å…¶æ·»åŠ åˆ°hookä¸­ã€‚</p>
<h3 id="HOOKè§¦å‘è¿‡ç¨‹"><a href="#HOOKè§¦å‘è¿‡ç¨‹" class="headerlink" title="HOOKè§¦å‘è¿‡ç¨‹"></a>HOOKè§¦å‘è¿‡ç¨‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * IP receive entry point</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ip_rcv</span><span class="params">(struct sk_buff *skb, struct net_device *dev, struct packet_type *pt,</span></span></span><br><span class="line"><span class="params"><span class="function">	   struct net_device *orig_dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> =</span> dev_net(dev);</span><br><span class="line"></span><br><span class="line">	skb = ip_rcv_core(skb, net);</span><br><span class="line">	<span class="keyword">if</span> (skb == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> NET_RX_DROP;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING,</span><br><span class="line">		       net, <span class="literal">NULL</span>, skb, dev, <span class="literal">NULL</span>,</span><br><span class="line">		       ip_rcv_finish);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°çš„<code>ip_rcv</code>å‡½æ•°æ˜¯ipæ¥å—çš„å…¥å£ç‚¹ï¼Œå…¶ä¸­çš„<code>ip_rcv_core</code>å‡½æ•°ä¸»è¦çš„æ“ä½œæ˜¯å¯¹æ•°æ®åŒ…çš„æ£€éªŒä»¥åŠè£å‰ªç­‰ï¼Œåœ¨å®Œæˆè¯¥æ­¥éª¤åè¿›å…¥åˆ°<code>NF_HOOK</code>ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">NF_HOOK</span><span class="params">(<span class="keyword">uint8_t</span> pf, <span class="keyword">unsigned</span> <span class="keyword">int</span> hook, struct net *net, struct sock *sk, struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">	struct net_device *in, struct net_device *out,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">int</span> (*okfn)(struct net *, struct sock *, struct sk_buff *))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = nf_hook(pf, hook, net, sk, skb, in, out, okfn);</span><br><span class="line">	<span class="keyword">if</span> (ret == <span class="number">1</span>)</span><br><span class="line">		ret = okfn(net, sk, skb);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¯¥å‡½æ•°ä¸­ä¼šå…ˆè°ƒç”¨<code>nf_hook</code>è€Œä¸æ˜¯ç›´æ¥è°ƒç”¨okfnå›è°ƒã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">nf_hook</span><span class="params">(<span class="keyword">u_int8_t</span> pf, <span class="keyword">unsigned</span> <span class="keyword">int</span> hook, struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">			  struct sock *sk, struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">			  struct net_device *indev, struct net_device *outdev,</span></span></span><br><span class="line"><span class="params"><span class="function">			  <span class="keyword">int</span> (*okfn)(struct net *, struct sock *, struct sk_buff *))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_entries</span> *<span class="title">hook_head</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_JUMP_LABEL</span></span><br><span class="line">	<span class="keyword">if</span> (__builtin_constant_p(pf) &amp;&amp;</span><br><span class="line">	    __builtin_constant_p(hook) &amp;&amp;</span><br><span class="line">	    !static_key_false(&amp;nf_hooks_needed[pf][hook]))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	<span class="keyword">switch</span> (pf) &#123;</span><br><span class="line">	<span class="keyword">case</span> NFPROTO_IPV4:</span><br><span class="line">		hook_head = rcu_dereference(net-&gt;nf.hooks_ipv4[hook]);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFPROTO_IPV6:</span><br><span class="line">		hook_head = rcu_dereference(net-&gt;nf.hooks_ipv6[hook]);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFPROTO_ARP:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_ARP</span></span><br><span class="line">		<span class="keyword">if</span> (WARN_ON_ONCE(hook &gt;= ARRAY_SIZE(net-&gt;nf.hooks_arp)))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		hook_head = rcu_dereference(net-&gt;nf.hooks_arp[hook]);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> NFPROTO_BRIDGE:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER_FAMILY_BRIDGE</span></span><br><span class="line">		hook_head = rcu_dereference(net-&gt;nf.hooks_bridge[hook]);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		WARN_ON_ONCE(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hook_head) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_state</span> <span class="title">state</span>;</span></span><br><span class="line"></span><br><span class="line">		nf_hook_state_init(&amp;state, hook, pf, indev, outdev,</span><br><span class="line">				   sk, net, okfn);</span><br><span class="line"></span><br><span class="line">		ret = nf_hook_slow(skb, &amp;state, hook_head, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°å†…éƒ¨é¦–å…ˆæ ¹æ®åè®®æ‰¾åˆ°hookçš„å¤´éƒ¨ï¼Œéšåè¿›å…¥ä¸‹é¢å¯¹stateè¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">nf_hook_state_init</span><span class="params">(struct nf_hook_state *p,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">unsigned</span> <span class="keyword">int</span> hook,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">u_int8_t</span> pf,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct net_device *indev,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct net_device *outdev,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct sock *sk,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct net *net,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">int</span> (*okfn)(struct net *, struct sock *, struct sk_buff *))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	p-&gt;hook = hook;</span><br><span class="line">	p-&gt;pf = pf;</span><br><span class="line">	p-&gt;in = indev;</span><br><span class="line">	p-&gt;out = outdev;</span><br><span class="line">	p-&gt;sk = sk;</span><br><span class="line">	p-&gt;net = net;</span><br><span class="line">	p-&gt;okfn = okfn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å®Œæˆå¯¹stateçš„åˆå§‹åŒ–ä¹‹åè°ƒç”¨<code>nf_hook_slow</code>å‡½æ•°è¿›è¡Œhookç‚¹ä½çš„è°ƒç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Returns 1 if okfn() needs to be executed by the caller,</span></span><br><span class="line"><span class="comment"> * -EPERM for NF_DROP, 0 otherwise.  Caller must hold rcu_read_lock. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nf_hook_slow</span><span class="params">(struct sk_buff *skb, struct nf_hook_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">		 <span class="keyword">const</span> struct nf_hook_entries *e, <span class="keyword">unsigned</span> <span class="keyword">int</span> s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> verdict;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (; s &lt; e-&gt;num_hook_entries; s++) &#123;</span><br><span class="line">		verdict = nf_hook_entry_hookfn(&amp;e-&gt;hooks[s], skb, state);</span><br><span class="line">		<span class="keyword">switch</span> (verdict &amp; NF_VERDICT_MASK) &#123;</span><br><span class="line">		<span class="keyword">case</span> NF_ACCEPT:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> NF_DROP:</span><br><span class="line">			kfree_skb_reason(skb,</span><br><span class="line">					 SKB_DROP_REASON_NETFILTER_DROP);</span><br><span class="line">			ret = NF_DROP_GETERR(verdict);</span><br><span class="line">			<span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">				ret = -EPERM;</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">case</span> NF_QUEUE:</span><br><span class="line">			ret = nf_queue(skb, state, s, verdict);</span><br><span class="line">			<span class="keyword">if</span> (ret == <span class="number">1</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">/* Implicit handling for NF_STOLEN, as well as any other</span></span><br><span class="line"><span class="comment">			 * non conventional verdicts.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(nf_hook_slow);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ³¨é‡Šå¯¹è¯¥å‡½æ•°çš„è¿”å›å€¼åšäº†è¯´æ˜ã€‚è¯¥å‡½æ•°åœ¨è¿›å…¥å¾ªç¯å°±ä¼šè°ƒç”¨<code>nf_hook_entry_hookfn</code>å‡½æ•°æ¥è°ƒç”¨hookã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">nf_hook_entry_hookfn</span><span class="params">(<span class="keyword">const</span> struct nf_hook_entry *entry, struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">		     struct nf_hook_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> entry-&gt;hook(entry-&gt;priv, skb, state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“åˆå‰é¢çš„æ¥çœ‹ï¼Œè¿™é‡Œhookçš„å…¶å®å°±æ˜¯<code>basechain-&gt;ops-&gt;hook-&gt;type-&gt;hooks[ops-&gt;hooknum];</code>å³<code>nft_do_chain_ipv4</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">nft_do_chain_ipv4</span><span class="params">(<span class="keyword">void</span> *priv,</span></span></span><br><span class="line"><span class="params"><span class="function">				      struct sk_buff *skb,</span></span></span><br><span class="line"><span class="params"><span class="function">				      <span class="keyword">const</span> struct nf_hook_state *state)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nft_pktinfo</span> <span class="title">pkt</span>;</span></span><br><span class="line"></span><br><span class="line">	nft_set_pktinfo(&amp;pkt, skb, state);</span><br><span class="line">	nft_set_pktinfo_ipv4(&amp;pkt);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nft_do_chain(&amp;pkt, priv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œè¯¥å‡½æ•°ä¸­å‰é¢ä¸»è¦æ˜¯å¯¹pktçš„åˆå§‹åŒ–ï¼Œæœ€åè¿›å…¥åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„<code>nft_do_chain</code>å‡½æ•°ã€‚</p>
<h2 id="conntrackå®ç°"><a href="#conntrackå®ç°" class="headerlink" title="conntrackå®ç°"></a>conntrackå®ç°</h2><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p>åœ¨<code>nf_ct_set</code>å‡½æ•°ä¸­å¦‚ä½•å¤„ç†skb-&gt;_nfctæˆå‘˜çš„ã€‚</p>
<p>bucketsåœ¨å†…æ ¸ä¸­çš„ç»“æ„ï¼Œä»¥åŠå¦‚ä½•å·¥ä½œï¼ˆçœ‹èµ·æ¥åƒæ˜¯ä¸€ä¸ªå®¹çº³<code>nf_conn</code>çš„å“ˆå¸Œè¡¨ï¼‰</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/netfilter/">netfilter</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2025/12/19/CVE-2025-38678/"
                                   title="CVE-2025-38678"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">CVE-2025-38678</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2024/09/07/nftables-CVEs2/"
                                   title="nftables CVEå¤ç°ç³»åˆ—ã€äºŒã€‘"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">nftables CVEå¤ç°ç³»åˆ—ã€äºŒã€‘</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#netfilter%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%86%E6%9E%90"><span class="nav-text">netfilteråˆå§‹åŒ–åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HOOK%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">HOOKåˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HOOK%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="nav-text">HOOKæ³¨å†Œè¿‡ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HOOK%E8%A7%A6%E5%8F%91%E8%BF%87%E7%A8%8B"><span class="nav-text">HOOKè§¦å‘è¿‡ç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#conntrack%E5%AE%9E%E7%8E%B0"><span class="nav-text">conntrackå®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-text">é—®é¢˜</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">341.8k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#netfilter%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%86%E6%9E%90"><span class="nav-text">netfilteråˆå§‹åŒ–åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HOOK%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">HOOKåˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HOOK%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="nav-text">HOOKæ³¨å†Œè¿‡ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HOOK%E8%A7%A6%E5%8F%91%E8%BF%87%E7%A8%8B"><span class="nav-text">HOOKè§¦å‘è¿‡ç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#conntrack%E5%AE%9E%E7%8E%B0"><span class="nav-text">conntrackå®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-text">é—®é¢˜</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
