<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            Racing_against_the_clock--hitting_a_tiny_kernel_race_windowå‰åº |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/rocket-lunch.svg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/rocket-lunch.svg"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Racing_against_the_clock--hitting_a_tiny_kernel_race_windowå‰åº
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2026-01-07 18:46:04</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Jan 07 2026 18:48:53 GMT+0800">2026-01-07 18:48:53</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/race/">race</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>4.1k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>19 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>è¯¥æŠ€æœ¯çš„æ ¸å¿ƒåœ¨äºå±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨ä¸€ä¸ªç†è®ºä¸Šå‡ ä¹ä¸å¯èƒ½åˆ©ç”¨çš„ã€æ—¶é—´çª—å£æçŸ­çš„æ¡ä»¶ç«äº‰æ¼æ´ã€‚è¯¥æ–¹æ³•æ˜¯ä¸€ç§åˆ©ç”¨ç¡¬ä»¶ç‰¹æ€§ï¼ˆç³»ç»Ÿç®¡ç†ä¸­æ–­ï¼ŒSMIï¼‰æ¥äººä¸ºâ€œæ‹‰é•¿â€è¿™ä¸ªæ—¶é—´çª—å£çš„åˆ›æ–°æŠ€æœ¯ã€‚</p>
<h1 id="å‰æ™¯æè¦ï¼šCVE-2021-0920"><a href="#å‰æ™¯æè¦ï¼šCVE-2021-0920" class="headerlink" title="å‰æ™¯æè¦ï¼šCVE-2021-0920"></a>å‰æ™¯æè¦ï¼šCVE-2021-0920</h1><p>å› ä¸ºè¯¥æŠ€æœ¯æ˜¯åŸºäºè¯¥æ¼æ´å‘ç°äº†å¦å¤–ä¸€ä¸ªæ¼æ´è€Œå‡ºç°çš„ï¼Œæ‰€ä»¥ä¸ºäº†ä¾¿äºç†è§£å°±å°†è¯¥æ¼æ´åˆ†æä¸€æ¬¡ã€‚</p>
<p><strong>åç»­åˆ†æçš„å†…æ ¸ç‰ˆæœ¬ä¸ºï¼šLinux v4.14.201</strong></p>
<h1 id="SCM-RIGHTS-æ¶ˆæ¯"><a href="#SCM-RIGHTS-æ¶ˆæ¯" class="headerlink" title="SCM_RIGHTS æ¶ˆæ¯"></a>SCM_RIGHTS æ¶ˆæ¯</h1><p><strong><code>SCM_RIGHTS</code>æ§åˆ¶æ¶ˆæ¯</strong>ï¼šLinux å¼€å‘è€…å¯ä»¥ä½¿ç”¨ sendmsg ç³»ç»Ÿè°ƒç”¨å‘é€ <code>SCM_RIGHTS</code> æ•°æ®ï¼ˆå‚è§<a class="link"   target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/unix.7.html%EF%BC%89**%E5%B0%86%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6" >https://man7.org/linux/man-pages/man7/unix.7.htmlï¼‰**å°†æ–‡ä»¶æè¿°ç¬¦<i class="fas fa-external-link-alt"></i></a> fd ä»ä¸€ä¸ªè¿›ç¨‹å…±äº«åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ï¼ˆè¯¥åŠŸèƒ½çš„æœ¬æ„æ˜¯æœ‰æƒé™æ‰“å¼€æ–‡ä»¶çš„è¿›ç¨‹æ‰“å¼€æ–‡ä»¶ç„¶åä¼ é€’ç»™æ²¡æƒé™æ‰“å¼€çš„è¿›ç¨‹ä½¿ç”¨ï¼Œå’Œ<code>dup2()</code>ä¸åŒçš„æ˜¯ï¼Œä¼ é€’åˆ°å¯¹ç«¯çš„æ–‡ä»¶æè¿°ç¬¦æ•°å­—å’Œæœ¬ç«¯ä¸ä¸€æ ·ï¼‰**ã€‚å½“senderè¿›ç¨‹å°†æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™å¦ä¸€ä¸ªè¿›ç¨‹receiveræ—¶ï¼Œ<code>SCM_RIGHTS</code> å°†åˆ›å»ºä¸€ä¸ªå¯¹ <code>file</code> ç»“æ„çš„å¼•ç”¨ï¼ˆè¯¥ <code>file</code> ç»“æ„æŒ‡é’ˆæ”¾åœ¨receiverç«¯çš„ <code>sock-&gt;sk_receive_queue</code> é˜Ÿåˆ—ä¸Šï¼‰ï¼Œè¿™æ ·å³ä½¿receiverè¿›ç¨‹å°šæœªæ¥æ”¶åˆ°æ–‡ä»¶æè¿°ç¬¦ï¼Œsenderä¹Ÿå¯ä»¥ç«‹å³å…³é—­è¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚å½“æ–‡ä»¶æè¿°ç¬¦å¤„äºâ€œqueuedâ€ æ’é˜ŸçŠ¶æ€ï¼ˆè¡¨ç¤ºsenderå·²å‘é€å¹¶å…³é—­äº†è¯¥ fdï¼Œä½†receiverå°šæœªæ¥æ”¶ fd å¹¶å–å¾—æ‰€æœ‰æƒï¼‰æ—¶ï¼Œéœ€è¦è¿›è¡Œä¸“é—¨çš„åƒåœ¾å›æ”¶ã€‚ä¸ºäº†è·Ÿè¸ªè¿™ç§â€œqueuedâ€çŠ¶æ€ï¼Œæ–‡ç«  <a class="link"   target="_blank" rel="noopener" href="https://lwn.net/Articles/779472/" >io_uring, SCM_RIGHTS, and reference-count cycles<i class="fas fa-external-link-alt"></i></a> å¾ˆå¥½åœ°è§£é‡Šäº†<code>SCM_RIGHTS</code> å¼•ç”¨è®¡æ•°å’Œåƒåœ¾å›æ”¶åŸç†ã€‚</p>
<p><strong>å†…å­˜æ³„éœ²é—®é¢˜</strong>ï¼šå¦‚æœä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ FD1 å’Œ FD2 éƒ½æŠŠè‡ªå·±å‘é€ç»™å¯¹æ–¹ï¼Œåœ¨éƒ½æ²¡æœ‰æ¥æ”¶åˆ°æ–‡ä»¶æè¿°ç¬¦çš„æƒ…å†µä¸‹å…³é—­ FD1 å’Œ FD2ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ª <code>file</code> ç»“æ„éƒ¨å°†æ°¸è¿œæ— æ³•é‡Šæ”¾ï¼Œé€ æˆå†…å­˜æ³„éœ²ã€‚æ‰€ä»¥è¦å¼•å…¥Linuxåƒåœ¾å›æ”¶æœºåˆ¶ï¼Œ<strong>é‡‡ç”¨ <code>inflight</code> é£è¡Œè®¡æ•°æ¥ç»Ÿè®¡æ­£åœ¨è¢«å‘é€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯†åˆ«å†…æ ¸ä¸­çš„ä¸å¯ç ´å¾ªç¯ï¼Œå¹¶é‡Šæ”¾ä¸å¯ç ´å¾ªç¯ä¸­çš„ <code>file</code> å¯¹è±¡</strong>ã€‚</p>
<h1 id="å‘é€æ–‡ä»¶æè¿°ç¬¦"><a href="#å‘é€æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="å‘é€æ–‡ä»¶æè¿°ç¬¦"></a>å‘é€æ–‡ä»¶æè¿°ç¬¦</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_sendmsg</span><span class="params">(struct socket *sock, struct msghdr *msg,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">other</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> err, size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">int</span> sent = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	<span class="keyword">bool</span> fds_sent = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">int</span> data_len;</span><br><span class="line"></span><br><span class="line">	wait_for_unix_gc();</span><br><span class="line">	err = scm_send(sock, msg, &amp;scm, <span class="literal">false</span>); <span class="comment">// è¿™é‡Œä¼šå¤„ç†scmæ¶ˆæ¯ï¼Œåç»­åˆ†æ</span></span><br><span class="line">	<span class="comment">// ...... å¦‚æœå‰é¢å‡½æ•°å¤±è´¥åˆ™é”™è¯¯è¿”å›</span></span><br><span class="line"></span><br><span class="line">	err = -EOPNOTSUPP; <span class="comment">// åˆå§‹åŒ–errçš„åªä¸ºä¸æ”¯æŒ</span></span><br><span class="line">	<span class="comment">// ...... å¦‚æœæ¶ˆæ¯çš„æ ‡è¯†ç¬¦æœ‰MSG_OOBåˆ™è·³è½¬è‡³out_erråˆ†æ”¯</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (msg-&gt;msg_namelen) &#123; <span class="comment">// å¦‚æœæ¶ˆæ¯æœ‰åå­—é•¿åº¦</span></span><br><span class="line">		err = sk-&gt;sk_state == TCP_ESTABLISHED ? -EISCONN : -EOPNOTSUPP; <span class="comment">// è¿™é‡Œç¡®å®šé”™è¯¯ç±»å‹</span></span><br><span class="line">		<span class="keyword">goto</span> out_err; <span class="comment">// è·³è½¬è‡³é”™è¯¯é€€å‡ºåˆ†æ”¯</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		err = -ENOTCONN;</span><br><span class="line">		other = unix_peer(sk); <span class="comment">// è·å–åˆ°ç›®æ ‡sockç»“æ„ä½“</span></span><br><span class="line">		<span class="comment">// ...... å¦‚æœæ— æ³•æ‰¾åˆ°åˆ™è·³è½¬è‡³out_erråˆ†æ”¯</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...... å¦‚æœç›®æ ‡å¥—æ¥å­—å…³é—­åˆ™è·³è½¬è‡³pipe_erråˆ†æ”¯</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (sent &lt; len) &#123; <span class="comment">// å¦‚æœå‘é€å¤§å°å°äºæ•°æ®å¤§å°åˆ™å¾ªç¯</span></span><br><span class="line">		size = len - sent; <span class="comment">// æ‹¿åˆ°æ­¤æ¬¡è¦å‘é€çš„æ¶ˆæ¯çš„å¤§å°</span></span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, (sk-&gt;sk_sndbuf &gt;&gt; <span class="number">1</span>) - <span class="number">64</span>);</span><br><span class="line">		size = <span class="keyword">min_t</span>(<span class="keyword">int</span>, size, SKB_MAX_HEAD(<span class="number">0</span>) + UNIX_SKB_FRAGS_SZ); <span class="comment">// è¿™ä¸¤æ­¥å°±æ˜¯ä¿è¯sizeä¸èƒ½è¶…è¿‡è¿™ä¿©</span></span><br><span class="line"></span><br><span class="line">		data_len = <span class="keyword">max_t</span>(<span class="keyword">int</span>, <span class="number">0</span>, size - SKB_MAX_HEAD(<span class="number">0</span>));</span><br><span class="line">		data_len = <span class="keyword">min_t</span>(<span class="keyword">size_t</span>, size, PAGE_ALIGN(data_len)); <span class="comment">// è®¡ç®—æ•°æ®é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">		skb = sock_alloc_send_pskb(sk, size - data_len, data_len,</span><br><span class="line">					   msg-&gt;msg_flags &amp; MSG_DONTWAIT, &amp;err, <span class="comment">// åˆ›å»ºskb</span></span><br><span class="line">					   get_order(UNIX_SKB_FRAGS_SZ));</span><br><span class="line">		<span class="comment">// ...... å¦‚æœåˆ†é…skbå¤±è´¥åˆ™è·³è½¬è‡³out_err</span></span><br><span class="line"></span><br><span class="line">		err = unix_scm_to_skb(&amp;scm, skb, !fds_sent); <span class="comment">// å°†scmè®¾ç½®åˆ°skbä¸­</span></span><br><span class="line">		<span class="comment">// ...... å¦‚æœè®¾ç½®å¤±è´¥åˆ™é‡Šæ”¾skbå¹¶ä¸”è·³è½¬è‡³out_erråˆ†æ”¯</span></span><br><span class="line">		fds_sent = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		skb_put(skb, size - data_len);</span><br><span class="line">		skb-&gt;data_len = data_len;</span><br><span class="line">		skb-&gt;len = size; <span class="comment">// è®¾ç½®skb</span></span><br><span class="line">		err = skb_copy_datagram_from_iter(skb, <span class="number">0</span>, &amp;msg-&gt;msg_iter, size); <span class="comment">// å°†æ¶ˆæ¯æ‹·è´è‡³skb</span></span><br><span class="line">		<span class="comment">// ...... å¦‚æœé”™è¯¯åˆ™é‡Šæ”¾skbå¹¶è·³è½¬è‡³out_erråˆ†æ”¯</span></span><br><span class="line"></span><br><span class="line">		unix_state_lock(other); <span class="comment">// å¯¹ç›®æ ‡å¥—æ¥å­—åŠ é”</span></span><br><span class="line">		<span class="comment">// ...... å¦‚æœç›®æ ‡å¥—æ¥å­—çš„æ ‡å¿—ç¬¦ä¸ºdeadæˆ–è¿æ¥å…³é—­åˆ™è·³è½¬è‡³pipe_err_freeåˆ†æ”¯</span></span><br><span class="line"></span><br><span class="line">		maybe_add_creds(skb, sock, other);</span><br><span class="line">		skb_queue_tail(&amp;other-&gt;sk_receive_queue, skb); <span class="comment">// å°†skbæ·»åŠ åˆ°ç›®æ ‡å¥—æ¥å­—çš„receive_queue</span></span><br><span class="line">		unix_state_unlock(other);</span><br><span class="line">		other-&gt;sk_data_ready(other); <span class="comment">// å‘Šè¯‰ç›®æ ‡å¥—æ¥å­—æ•°æ®ä»¥åŠå‡†å¤‡å¥½äº†</span></span><br><span class="line">		sent += size; <span class="comment">// å¢åŠ å‘é€çš„æ•°æ®é•¿åº¦</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	scm_destroy(&amp;scm); <span class="comment">// é‡Šæ”¾scm</span></span><br><span class="line">	<span class="keyword">return</span> sent;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...... é”™è¯¯åˆ†æ”¯ï¼Œä¸æ­¤åˆ†ææ— å…³çœç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°æ˜¯å‘é€å‡½æ•°çš„æ‰€æœ‰é€»è¾‘ï¼Œå¤§è‡´å°±æ˜¯å¤„ç†scmæ¶ˆæ¯ï¼Œå°†scmæ¶ˆæ¯æ•´åˆåˆ°skbä¸­æœ€ç»ˆå°†skbæ·»åŠ åˆ°ç›®æ ‡å¥—æ¥å­—çš„æ¥æ”¶é˜Ÿåˆ—ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scm_fp_list</span> &#123;</span></span><br><span class="line">	<span class="keyword">short</span>			count;</span><br><span class="line">	<span class="keyword">short</span>			max;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span>	*<span class="title">user</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span>		*<span class="title">fp</span>[<span class="title">SCM_MAX_FD</span>];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span>		*<span class="title">pid</span>;</span>		<span class="comment">/* Skb credentials */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_fp_list</span>	*<span class="title">fp</span>;</span>		<span class="comment">/* Passed files		*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_creds</span>	<span class="title">creds</span>;</span>		<span class="comment">/* Skb credentials	*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY_NETWORK</span></span><br><span class="line">	u32			secid;		<span class="comment">/* Passed security ID 	*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä¸¤ä¸ªç»“æ„ä½“åœ¨åç»­å¾ˆéœ€è¦ï¼Œåœ¨<code>scm_fp_list-&gt;fp</code>ä¸­å­˜å‚¨çš„æ˜¯è¦å‘é€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __scm_send(struct socket *sock, struct msghdr *msg, struct scm_cookie *p)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cmsghdr</span> *<span class="title">cmsg</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	for_each_cmsghdr(cmsg, msg) &#123; <span class="comment">// éå†ç”¨æˆ·æ€ä¼ å…¥çš„æ¶ˆæ¯</span></span><br><span class="line">		err = -EINVAL;</span><br><span class="line">		<span class="comment">// ...... å¦‚æœæ¶ˆæ¯ä¸æ­£å¸¸åˆ™è·³è½¬è‡³erroråˆ†æ”¯</span></span><br><span class="line">		<span class="comment">// ...... å¦‚æœæ¶ˆæ¯çš„ç­‰çº§ä¸æ˜¯SOL_SOCKETåˆ™è·³è¿‡</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (cmsg-&gt;cmsg_type)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">case</span> SCM_RIGHTS:</span><br><span class="line">      <span class="comment">// ...... å¦‚æœå½“å‰å¥—æ¥å­—æ²¡æœ‰opsæˆ–æ‰€å±çš„å®¶æ—ä¸æ˜¯PF_UNIXåˆ™è·³è½¬è‡³erroråˆ†æ”¯</span></span><br><span class="line">			err=scm_fp_copy(cmsg, &amp;p-&gt;fp); <span class="comment">// è¿™é‡Œä¼ å…¥çš„æ˜¯scm_fp_listç»“æ„ä½“ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†ç”¨æˆ·æ€çš„ä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦å†™å…¥fpæ•°ç»„</span></span><br><span class="line">			<span class="comment">// ...... å¦‚æœé”™è¯¯åˆ™è·³è½¬è‡³erroråˆ†æ”¯</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> SCM_CREDENTIALS:</span><br><span class="line">		<span class="comment">// ...... ä¸æ­¤æ¼æ´æ— å…³</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (p-&gt;fp &amp;&amp; !p-&gt;fp-&gt;count)</span><br><span class="line">	&#123;</span><br><span class="line">		kfree(p-&gt;fp);</span><br><span class="line">		p-&gt;fp = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...... é”™è¯¯åˆ†æ”¯ä¸æ­¤å¤„æ— å…³</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¯¥å‡½æ•°ä¼šå°†ç”¨æˆ·æ€ä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦è§£æè‡³<code>unix_stream_sendmsg</code>å‡½æ•°ä¸­çš„<code>struct scm_cookie scm;</code>å˜é‡ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_scm_to_skb</span><span class="params">(struct scm_cookie *scm, struct sk_buff *skb, <span class="keyword">bool</span> send_fds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	UNIXCB(skb).pid  = get_pid(scm-&gt;pid);</span><br><span class="line">	UNIXCB(skb).uid = scm-&gt;creds.uid;</span><br><span class="line">	UNIXCB(skb).gid = scm-&gt;creds.gid;</span><br><span class="line">	UNIXCB(skb).fp = <span class="literal">NULL</span>;</span><br><span class="line">	unix_get_secdata(scm, skb);</span><br><span class="line">	<span class="keyword">if</span> (scm-&gt;fp &amp;&amp; send_fds)</span><br><span class="line">		err = unix_attach_fds(scm, skb);</span><br><span class="line"></span><br><span class="line">	skb-&gt;destructor = unix_destruct_scm;</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯¹skbè¿›è¡Œåˆå§‹åŒ–ï¼Œä¼šé€šè¿‡<code>unix_attach_fds</code>å°†<code>struct file</code>å†™åˆ°skbä¸Šã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">unix_attach_fds</span><span class="params">(struct scm_cookie *scm, struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (too_many_unix_fds(current))</span><br><span class="line">		<span class="keyword">return</span> -ETOOMANYREFS;</span><br><span class="line"></span><br><span class="line">	UNIXCB(skb).fp = scm_fp_dup(scm-&gt;fp);</span><br><span class="line">	<span class="keyword">if</span> (!UNIXCB(skb).fp)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = scm-&gt;fp-&gt;count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">		unix_inflight(scm-&gt;fp-&gt;user, scm-&gt;fp-&gt;fp[i]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¯¥å‡½æ•°ä¸­ä¼šé€šè¿‡<code>scm_fp_dup</code>å‡½æ•°å¢åŠ è¯¥æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°ï¼Œé€šè¿‡<code>unix_inflight</code>å‡½æ•°å¢åŠ è¦ä¼ è¾“æ–‡ä»¶çš„é£è¡Œè®¡æ•°ã€‚</p>
<h1 id="æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦"><a href="#æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦"></a>æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">unix_stream_read_generic</span><span class="params">(struct unix_stream_read_state *state,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">bool</span> freezable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span> =</span> state-&gt;socket;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">unix_sock</span> *<span class="title">u</span> =</span> unix_sk(sk);</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">  </span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="comment">// ......</span></span><br><span class="line">		last = skb = skb_peek(&amp;sk-&gt;sk_receive_queue);</span><br><span class="line">		<span class="comment">// ...... æ‰¾ä¸åˆ°skbçš„æƒ…å†µ</span></span><br><span class="line">		<span class="comment">// ...... è·³è¿‡æ•°æ®é•¿åº¦å¤§äºskbé•¿åº¦ï¼Œè¿›ä¸€æ­¥æ‰¾ä¸‹ä¸€ä¸ªskb</span></span><br><span class="line">		<span class="comment">// ...... å‡­è¯ç›¸å…³</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!(flags &amp; MSG_PEEK)) &#123; <span class="comment">// å¦‚æœä¸æ˜¯PEEKæ¨¡å¼</span></span><br><span class="line">			UNIXCB(skb).consumed += chunk;</span><br><span class="line"></span><br><span class="line">			sk_peek_offset_bwd(sk, chunk);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (UNIXCB(skb).fp) <span class="comment">// å¦‚æœåŒ…å«æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">				unix_detach_fds(&amp;scm, skb); <span class="comment">// å°†æ–‡ä»¶æè¿°ç¬¦ä»skbä¸­åˆ†ç¦»è®¾ç½®åˆ°scm</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (unix_skb_len(skb))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			skb_unlink(skb, &amp;sk-&gt;sk_receive_queue); <span class="comment">// å°†skbä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»é™¤</span></span><br><span class="line">			consume_skb(skb); <span class="comment">// é‡Šæ”¾skb</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (scm.fp) <span class="comment">// æ‹¿åˆ°fpä¹‹åé€€å‡ºå¾ªç¯</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123; <span class="comment">// PEEKæ¨¡å¼</span></span><br><span class="line">			<span class="keyword">if</span> (UNIXCB(skb).fp) <span class="comment">// å¦‚æœåŒ…å«æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">				scm.fp = scm_fp_dup(UNIXCB(skb).fp); <span class="comment">// åˆæ˜¯æ‹¿åˆ°æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"></span><br><span class="line">			sk_peek_offset_fwd(sk, chunk);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (UNIXCB(skb).fp) <span class="comment">// å¦‚æœæœ‰æ–‡ä»¶æè¿°ç¬¦åˆ™é€€å‡º</span></span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ......</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span> (size);</span><br><span class="line"></span><br><span class="line">	mutex_unlock(&amp;u-&gt;iolock);</span><br><span class="line">	<span class="keyword">if</span> (state-&gt;msg) <span class="comment">// å¦‚æœæœ‰æ¶ˆæ¯ç»“æ„</span></span><br><span class="line">		scm_recv(sock, state-&gt;msg, &amp;scm, flags); <span class="comment">// å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		scm_destroy(&amp;scm);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> copied ? : err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥æ”¶æ¶ˆæ¯çš„å¤§è‡´æµç¨‹å¦‚ä¸Šï¼Œä¸»è¦åˆ†ä¸ºPEEKæ¨¡å¼å’ŒéPEEKæ¨¡å¼çš„æ­£å¸¸æ¥æ”¶ã€‚</p>
<h2 id="ä¸å¸¦PEEKè°ƒç”¨recvmsg"><a href="#ä¸å¸¦PEEKè°ƒç”¨recvmsg" class="headerlink" title="ä¸å¸¦PEEKè°ƒç”¨recvmsg"></a>ä¸å¸¦PEEKè°ƒç”¨recvmsg</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unix_detach_fds</span><span class="params">(struct scm_cookie *scm, struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	scm-&gt;fp = UNIXCB(skb).fp;</span><br><span class="line">	UNIXCB(skb).fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = scm-&gt;fp-&gt;count<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">		unix_notinflight(scm-&gt;fp-&gt;user, scm-&gt;fp-&gt;fp[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨åˆ†ç¦»æ–‡ä»¶æè¿°çš„å‡½æ•°å†…éƒ¨å®ç°å¦‚ä¸Šï¼Œé¦–å…ˆå°†æ–‡ä»¶æè¿°ç¬¦èµ‹å€¼åˆ°scmä¸­ï¼Œç„¶åæ¸…ç©ºskbä¸Šçš„fpæŒ‡é’ˆï¼Œæœ€ååœ¨ä¸‹é¢å‡å°‘é£è¡Œè®¡æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unix_notinflight</span><span class="params">(struct user_struct *user, struct file *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">s</span> =</span> unix_get_socket(fp);</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;unix_gc_lock);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (s) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">unix_sock</span> *<span class="title">u</span> =</span> unix_sk(s);</span><br><span class="line"></span><br><span class="line">		BUG_ON(!atomic_long_read(&amp;u-&gt;inflight));</span><br><span class="line">		BUG_ON(list_empty(&amp;u-&gt;link));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (atomic_long_dec_and_test(&amp;u-&gt;inflight)) <span class="comment">// [1]</span></span><br><span class="line">			list_del_init(&amp;u-&gt;link);</span><br><span class="line">		<span class="comment">/* Paired with READ_ONCE() in wait_for_unix_gc() */</span></span><br><span class="line">		WRITE_ONCE(unix_tot_inflight, unix_tot_inflight - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	user-&gt;unix_inflight--;</span><br><span class="line">	spin_unlock(&amp;unix_gc_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å‡å»é£è¡Œè®¡æ•°çš„æ—¶å€™ä¼šåŠ ä¸Šgcé”ï¼Œåœ¨[1]å¤„ä¼šå‡å°‘é£è¡Œè®¡æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consume_skb</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!skb_unref(skb))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	trace_consume_skb(skb);</span><br><span class="line">	__kfree_skb(skb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿›å…¥åˆ°<code>__kfree_skb</code>ä¹‹åä¼šè¿›å…¥ä¸€ä¸‹è°ƒç”¨é“¾ï¼Œ<code>__kfree_skb</code>&#x3D;&gt;<code>skb_realease_all</code>&#x3D;&gt;<code>skb_release_head_state</code>&#x3D;&gt;<code>skb-&gt;destructor</code>ï¼Œè¿™é‡Œè°ƒç”¨çš„è§£æ„å‡½æ•°å®é™…æ˜¯<code>unix_destruct_scm</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unix_destruct_scm</span><span class="params">(struct sk_buff *skb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_cookie</span> <span class="title">scm</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;scm, <span class="number">0</span>, <span class="keyword">sizeof</span>(scm));</span><br><span class="line">	scm.pid  = UNIXCB(skb).pid;</span><br><span class="line">	<span class="keyword">if</span> (UNIXCB(skb).fp)</span><br><span class="line">		unix_detach_fds(&amp;scm, skb);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Alas, it calls VFS */</span></span><br><span class="line">	<span class="comment">/* So fscking what? fput() had been SMP-safe since the last Summer */</span></span><br><span class="line">	scm_destroy(&amp;scm);</span><br><span class="line">	sock_wfree(skb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ­¤å¤„å¦‚æœskbå¦‚æœè¿˜æ˜¯æœ‰æ–‡ä»¶æè¿°ç¬¦åˆ™ä¼šå†ä¸€æ¬¡è°ƒç”¨<code>unix_detach_fds</code>å‡½æ•°ã€‚</p>
<h2 id="å¸¦PEEKè°ƒç”¨recvmsg"><a href="#å¸¦PEEKè°ƒç”¨recvmsg" class="headerlink" title="å¸¦PEEKè°ƒç”¨recvmsg"></a>å¸¦PEEKè°ƒç”¨recvmsg</h2><p>å¯ä»¥å‘ç°çš„æ˜¯ï¼Œåœ¨å¸¦PEEKæ¨¡å¼ä¸‹çš„recvmsgæ˜¯ç›´æ¥é€šè¿‡<code>scm_fp_dup</code>æ‹¿åˆ°æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct scm_fp_list *<span class="title">scm_fp_dup</span><span class="params">(struct scm_fp_list *fpl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">scm_fp_list</span> *<span class="title">new_fpl</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!fpl)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	new_fpl = kmemdup(fpl, offsetof(struct scm_fp_list, fp[fpl-&gt;count]),</span><br><span class="line">			  GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (new_fpl) &#123;</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; fpl-&gt;count; i++)</span><br><span class="line">			get_file(fpl-&gt;fp[i]);</span><br><span class="line">		new_fpl-&gt;max = new_fpl-&gt;count;</span><br><span class="line">		new_fpl-&gt;user = get_uid(fpl-&gt;user);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> new_fpl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†é…<code>scm_fp_list</code>ï¼Œç„¶åé€šè¿‡<code>get_file</code>å‡½æ•°å¢åŠ æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°æœ€åè¿”å›<code>scm_fp_list</code>ã€‚</p>
<p><strong>å¹¶ä¸”ä»å‰é¢çš„recvmsgå‡½æ•°æ¥çœ‹ï¼Œå½“å¸¦PEEKæ¨¡å¼æ—¶ä¸ä¼šé”€æ¯skbå¹¶ä¸”ä¼šæ‹¿åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦</strong></p>
<h1 id="åƒåœ¾å›æ”¶"><a href="#åƒåœ¾å›æ”¶" class="headerlink" title="åƒåœ¾å›æ”¶"></a>åƒåœ¾å›æ”¶</h1><p>åƒåœ¾å›æ”¶çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æ¸…é™¤å†…å­˜ä¸­æ— æ³•ä¸»åŠ¨åˆ é™¤æ‰çš„å†…å­˜å—ï¼Œå³ä»¥ä¸‹æƒ…å†µï¼š</p>
<blockquote>
<p>Socket A	&#x3D;&#x3D;å‘é€A&#x3D;&#x3D;&gt;	Socket B</p>
<p>Socket B	&#x3D;&#x3D;å‘é€B&#x3D;&#x3D;&gt;	Socket A</p>
<p>close(A); </p>
<p>close(B);</p>
<p>çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<p>Socket A			   Socket B</p>
<p>ref &#x3D; 1				ref &#x3D; 1</p>
<p>inflight &#x3D; 1			inflight &#x3D; 1</p>
</blockquote>
<p>åœ¨ä¸Šè¿°æƒ…å†µä¸­ï¼Œå³æ²¡æœ‰Socket Açš„å¼•ç”¨ï¼ŒåŒæ—¶æ²¡æœ‰Socket Bçš„å¼•ç”¨ï¼Œå¯¼è‡´å½¢æˆäº†ä¸€ä¸ªä¸å¯ç ´å¾ªç¯ï¼Œé¢å¯¹æ­¤ç±»æƒ…å†µå°±åº”å½“è¿›è¡Œgcã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unix_gc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">unix_sock</span> *<span class="title">u</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">unix_sock</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span> <span class="title">hitlist</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cursor</span>;</span></span><br><span class="line">	LIST_HEAD(not_cycle_list);</span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;unix_gc_lock); <span class="comment">// åŠ ä¸Šgcé”</span></span><br><span class="line">	<span class="comment">// ...... å¦‚æœå·²ç»æœ‰gcåœ¨ç¨‹åºå†…åˆ™é€€å‡ºå¦‚æœæ²¡æœ‰åˆ™è®¾ç½®æ­£åœ¨ç¨‹åºä¸­</span></span><br><span class="line"></span><br><span class="line">	list_for_each_entry_safe(u, next, &amp;gc_inflight_list, link) &#123; <span class="comment">// éå†é£è¡Œä¸­çš„sock</span></span><br><span class="line">		<span class="keyword">long</span> total_refs;</span><br><span class="line">		<span class="keyword">long</span> inflight_refs;</span><br><span class="line"></span><br><span class="line">		total_refs = file_count(u-&gt;sk.sk_socket-&gt;file); <span class="comment">// å–æ–‡ä»¶å¼•ç”¨è®¡æ•°</span></span><br><span class="line">		inflight_refs = atomic_long_read(&amp;u-&gt;inflight); <span class="comment">// å–é£è¡Œè®¡æ•°</span></span><br><span class="line"></span><br><span class="line">		BUG_ON(inflight_refs &lt; <span class="number">1</span>);</span><br><span class="line">		BUG_ON(total_refs &lt; inflight_refs);</span><br><span class="line">		<span class="keyword">if</span> (total_refs == inflight_refs) &#123; <span class="comment">// å¦‚æœå¼•ç”¨è®¡æ•°ä¸é£è¡Œè®¡æ•°ä¸€è‡´åˆ™å°†sockæ·»åŠ è‡³gcçš„å€™é€‰åˆ—è¡¨</span></span><br><span class="line">			list_move_tail(&amp;u-&gt;link, &amp;gc_candidates);</span><br><span class="line">			__set_bit(UNIX_GC_CANDIDATE, &amp;u-&gt;gc_flags);</span><br><span class="line">			__set_bit(UNIX_GC_MAYBE_CYCLE, &amp;u-&gt;gc_flags);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	list_for_each_entry(u, &amp;gc_candidates, link) <span class="comment">// éå†æ‰€æœ‰å€™é€‰åˆ—è¡¨</span></span><br><span class="line">		scan_children(&amp;u-&gt;sk, dec_inflight, <span class="literal">NULL</span>); <span class="comment">// å¯¹å€™é€‰åˆ—è¡¨ä¸­çš„é£è¡Œè®¡æ•°å‡ä¸€</span></span><br><span class="line"></span><br><span class="line">	list_add(&amp;cursor, &amp;gc_candidates);</span><br><span class="line">	<span class="keyword">while</span> (cursor.next != &amp;gc_candidates) &#123;</span><br><span class="line">		u = list_entry(cursor.next, struct unix_sock, link);</span><br><span class="line"></span><br><span class="line">		list_move(&amp;cursor, &amp;u-&gt;link);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (atomic_long_read(&amp;u-&gt;inflight) &gt; <span class="number">0</span>) &#123; <span class="comment">// å¦‚æœå‡ä¸€ä¹‹åé£è¡Œè®¡æ•°ä»å¤§äº0åˆ™ä»£è¡¨æœ‰å¤–éƒ¨å¼•ç”¨ï¼Œé‚£ä¹ˆè¯¥sockä¸è¯¥è¢«gc</span></span><br><span class="line">			list_move_tail(&amp;u-&gt;link, &amp;not_cycle_list);</span><br><span class="line">			__clear_bit(UNIX_GC_MAYBE_CYCLE, &amp;u-&gt;gc_flags);</span><br><span class="line">			scan_children(&amp;u-&gt;sk, inc_inflight_move_tail, <span class="literal">NULL</span>); <span class="comment">// æ¢å¤é£è¡Œè®¡æ•°</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	list_del(&amp;cursor);</span><br><span class="line"></span><br><span class="line">	skb_queue_head_init(&amp;hitlist);</span><br><span class="line">	list_for_each_entry(u, &amp;gc_candidates, link) <span class="comment">// ç°åœ¨å‰©ä¸‹çš„å°±æ˜¯éœ€è¦è¢«gcçš„sock</span></span><br><span class="line">		scan_children(&amp;u-&gt;sk, inc_inflight, &amp;hitlist); <span class="comment">// å¢åŠ sockçš„é£è¡Œè®¡æ•°å¹¶è½¬ç§»åˆ°hitlisté“¾è¡¨</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (!list_empty(&amp;not_cycle_list)) &#123;</span><br><span class="line">		u = list_entry(not_cycle_list.next, struct unix_sock, link);</span><br><span class="line">		__clear_bit(UNIX_GC_CANDIDATE, &amp;u-&gt;gc_flags);</span><br><span class="line">		list_move_tail(&amp;u-&gt;link, &amp;gc_inflight_list);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spin_unlock(&amp;unix_gc_lock);</span><br><span class="line"></span><br><span class="line">	__skb_queue_purge(&amp;hitlist); <span class="comment">// åˆ é™¤è¯¥é“¾è¡¨ä¸­çš„skb</span></span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;unix_gc_lock);</span><br><span class="line"></span><br><span class="line">	BUG_ON(!list_empty(&amp;gc_candidates));</span><br><span class="line">	WRITE_ONCE(gc_in_progress, <span class="literal">false</span>);</span><br><span class="line">	wake_up(&amp;unix_gc_wait);</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">	spin_unlock(&amp;unix_gc_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¿™é‡Œçš„åƒåœ¾å›æ”¶æœºåˆ¶å°±æ˜¯ï¼š</p>
<ol>
<li>å¦‚æœå¼•ç”¨è®¡æ•°ä¸é£è¡Œè®¡æ•°ä¸€è‡´åˆ™è¿›å…¥gcçš„å€™é€‰åˆ—è¡¨ã€‚</li>
<li>éå†å€™é€‰åˆ—è¡¨ä¸­çš„sockï¼Œå¯¹å…¶æ¥æ”¶åˆ—è¡¨ä¸­çš„sockè¿›è¡Œé£è¡Œè®¡æ•°å‡ä¸€</li>
<li>å¦‚æœé£è¡Œè®¡æ•°å¤§äº0åˆ™ç§»é™¤gcçš„å€™é€‰åˆ—è¡¨å¹¶æ¢å¤å…¶é£è¡Œè®¡æ•°</li>
<li>æ¢å¤gcå€™é€‰åˆ—è¡¨ä¸­çš„sockçš„é£è¡Œè®¡æ•°</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scan_children</span><span class="params">(struct sock *x, <span class="keyword">void</span> (*func)(struct unix_sock *),</span></span></span><br><span class="line"><span class="params"><span class="function">			  struct sk_buff_head *hitlist)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (x-&gt;sk_state != TCP_LISTEN) &#123;</span><br><span class="line">		scan_inflight(x, func, hitlist);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		struct sk_buff *skb;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">next</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">unix_sock</span> *<span class="title">u</span>;</span></span><br><span class="line">		LIST_HEAD(embryos);</span><br><span class="line"></span><br><span class="line">		spin_lock(&amp;x-&gt;sk_receive_queue.lock);</span><br><span class="line">		skb_queue_walk_safe(&amp;x-&gt;sk_receive_queue, skb, next) &#123;</span><br><span class="line">			u = unix_sk(skb-&gt;sk);</span><br><span class="line"></span><br><span class="line">			BUG_ON(!list_empty(&amp;u-&gt;link));</span><br><span class="line">			list_add_tail(&amp;u-&gt;link, &amp;embryos);</span><br><span class="line">		&#125;</span><br><span class="line">		spin_unlock(&amp;x-&gt;sk_receive_queue.lock);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (!list_empty(&amp;embryos)) &#123;</span><br><span class="line">			u = list_entry(embryos.next, struct unix_sock, link);</span><br><span class="line">			scan_inflight(&amp;u-&gt;sk, func, hitlist);</span><br><span class="line">			list_del_init(&amp;u-&gt;link);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤„ä¼šå…ˆå°†æ¥æ”¶é˜Ÿåˆ—ä¸­çš„skbæ·»åŠ åˆ°<code>embryos</code>åˆ—è¡¨ä¸­ï¼Œæœ€åè°ƒç”¨<code>scan_inflight</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scan_inflight</span><span class="params">(struct sock *x, <span class="keyword">void</span> (*func)(struct unix_sock *),</span></span></span><br><span class="line"><span class="params"><span class="function">			  struct sk_buff_head *hitlist)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;x-&gt;sk_receive_queue.lock);</span><br><span class="line">	skb_queue_walk_safe(&amp;x-&gt;sk_receive_queue, skb, next) &#123;</span><br><span class="line">		<span class="keyword">if</span> (UNIXCB(skb).fp) &#123;</span><br><span class="line">			<span class="keyword">bool</span> hit = <span class="literal">false</span>;</span><br><span class="line">			<span class="keyword">int</span> nfd = UNIXCB(skb).fp-&gt;count;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">file</span> **<span class="title">fp</span> =</span> UNIXCB(skb).fp-&gt;fp;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">while</span> (nfd--) &#123;</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> unix_get_socket(*fp++);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (sk) &#123;</span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">unix_sock</span> *<span class="title">u</span> =</span> unix_sk(sk);</span><br><span class="line"></span><br><span class="line">					<span class="keyword">if</span> (test_bit(UNIX_GC_CANDIDATE, &amp;u-&gt;gc_flags)) &#123;</span><br><span class="line">						hit = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">						func(u);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (hit &amp;&amp; hitlist != <span class="literal">NULL</span>) &#123;</span><br><span class="line">				__skb_unlink(skb, &amp;x-&gt;sk_receive_queue);</span><br><span class="line">				__skb_queue_tail(hitlist, skb);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;x-&gt;sk_receive_queue.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤„åˆä¸€æ¬¡éå†å¥—æ¥å­—çš„æ¥æ”¶é˜Ÿåˆ—ï¼Œå¦‚æœskbæœ‰æ–‡ä»¶æè¿°ç¬¦åˆ™ä¼šè¿›å…¥å†…éƒ¨è°ƒç”¨å¤–éƒ¨ä¼ å…¥çš„å‡½æ•°ï¼ˆå‡å»é£è¡Œè®¡æ•°æˆ–å¢åŠ é£è¡Œè®¡æ•°ç­‰ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> __skb_queue_purge(struct sk_buff_head *<span class="built_in">list</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb</span>;</span></span><br><span class="line">	<span class="keyword">while</span> ((skb = __skb_dequeue(<span class="built_in">list</span>)) != <span class="literal">NULL</span>)</span><br><span class="line">		kfree_skb(skb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åé€šè¿‡è¯¥å‡½æ•°åˆ é™¤skbã€‚</p>
<h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>æ­¤å¤„çš„æ¼æ´å‡ºç°åœ¨ä½¿ç”¨å¸¦PEEKçš„æ¨¡å¼è°ƒç”¨recvmsgæ—¶æ²¡æœ‰ä¸gcè¿›è¡ŒåŒæ­¥ï¼Œæ‰€ä»¥åœ¨gcçš„è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡è°ƒç”¨å¸¦PEEKçš„recvmsgè¾¾åˆ°æ¡ä»¶ç«äº‰çš„æ•ˆæœã€‚</p>
<p>è§¦å‘UAFçš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="center">Unix_gc</th>
<th align="center">çº¿ç¨‹ä¸€ï¼šSocket A</th>
<th align="center">çº¿ç¨‹äºŒï¼šSocket B</th>
<th align="center">çº¿ç¨‹ä¸‰ï¼šSocket C</th>
</tr>
</thead>
<tbody><tr>
<td align="center"></td>
<td align="center">å°†å¥—æ¥å­—Aå‘é€åˆ°Bå¹¶å…³é—­A<br />Aï¼šref &#x3D;&gt; 1; inflight &#x3D;&gt; 1</td>
<td align="center">å°†å¥—æ¥å­—Bå‘é€åˆ°Aä¸å…³é—­B<br />å°†å¥—æ¥å­—Bå‘é€åˆ°Cå¹¶å…³é—­B<br />Bï¼šref &#x3D;&gt; 2; inflight &#x3D;&gt; 2</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">è§¦å‘GC<br />å°†Aå’ŒBæ·»åŠ è¿›GCå€™é€‰åˆ—è¡¨</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">å¯¹å¥—æ¥å­—Cä½¿ç”¨å¸¦PEEKçš„recvmsgæ¥æ”¶å¥—æ¥å­—B<br />Bï¼šref &#x3D;&gt; 3; inflight &#x3D;&gt; 2</td>
</tr>
<tr>
<td align="center">å¯¹å€™é€‰åˆ—è¡¨ä¸­çš„é£è¡Œè®¡æ•°å‡ä¸€<br />Aï¼šref &#x3D;&gt; 1; inflight &#x3D;&gt; 0<br />Bï¼šref &#x3D;&gt; 3; inflight &#x3D;&gt; 1</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">å¯¹å¥—æ¥å­—Bä½¿ç”¨ä¸å¸¦PEEKçš„recvmsg<br />Aï¼šref &#x3D;&gt; 1; inflight &#x3D;&gt; 1<br />UNIXCB(skb).fp &#x3D; NULL;<br />æ­¤å¤„ä¼šå› ä¸ºunix_notinflighté˜»å¡</td>
</tr>
<tr>
<td align="center">å› ä¸ºBçš„é£è¡Œè®¡æ•°å¤§äº0<br />æ‰€ä»¥ä¼šæ¢å¤è¯¥æ¶ˆæ¯<br />ä¸”æ¢å¤å…¶æ¥æ”¶åˆ—è¡¨çš„é£è¡Œè®¡æ•°<br />ä½†å› ä¸ºUNIXCB(skb).fp &#x3D; NULL;ä¼šå¯¼è‡´Açš„é£è¡Œè®¡æ•°ä¾æ—§ä¸º0</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">å¯¹å¥—æ¥å­—Bä½¿ç”¨å¸¦PEEKçš„recvmsg<br />skb &#x3D; skb_peek(&amp;sk-&gt;sk_receive_queue);æ‹¿åˆ°skb</td>
</tr>
<tr>
<td align="center">gcé‡Šæ”¾skb</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">state-&gt;recv_actor(skb, skip, chunk, state);è¾¾åˆ°UAF</td>
</tr>
</tbody></table>
<p>æ€»çš„æ¥è¯´ï¼Œè¿™é‡Œçš„è§¦å‘æ¼æ´è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œç„¶ååœ¨æ­¤å¤„å¢åŠ æ—¶é—´çª—å£åªéœ€è¦åˆ›å»ºå¤šä¸ªç±»ä¼¼äºA &lt;&#x3D;&#x3D;&gt; B &#x3D;&#x3D;&gt; Cè¿™æ ·çš„å½¢å¼å³å¯ã€‚</p>
<h1 id="patchåˆ†æ"><a href="#patchåˆ†æ" class="headerlink" title="patchåˆ†æ"></a>patchåˆ†æ</h1><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---</span></span><br><span class="line"> net/unix/af_unix.c |   51 +++++++++++++++++++++++++++++++++++++++++++++++++--</span><br><span class="line"> 1 file changed, 49 insertions(+), 2 deletions(-)</span><br><span class="line"></span><br><span class="line"><span class="comment">--- a/net/unix/af_unix.c</span></span><br><span class="line"><span class="comment">+++ b/net/unix/af_unix.c</span></span><br><span class="line"><span class="meta">@@ -1507,6 +1507,53 @@</span> out:</span><br><span class="line"> 	return err;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+static void unix_peek_fds(struct scm_cookie *scm, struct sk_buff *skb)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+	scm-&gt;fp = scm_fp_dup(UNIXCB(skb).fp);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+	/*</span></span><br><span class="line"><span class="addition">+	 * Garbage collection of unix sockets starts by selecting a set of</span></span><br><span class="line"><span class="addition">+	 * candidate sockets which have reference only from being in flight</span></span><br><span class="line"><span class="addition">+	 * (total_refs == inflight_refs).  This condition is checked once during</span></span><br><span class="line"><span class="addition">+	 * the candidate collection phase, and candidates are marked as such, so</span></span><br><span class="line"><span class="addition">+	 * that non-candidates can later be ignored.  While inflight_refs is</span></span><br><span class="line"><span class="addition">+	 * protected by unix_gc_lock, total_refs (file count) is not, hence this</span></span><br><span class="line"><span class="addition">+	 * is an instantaneous decision.</span></span><br><span class="line"><span class="addition">+	 *</span></span><br><span class="line"><span class="addition">+	 * Once a candidate, however, the socket must not be reinstalled into a</span></span><br><span class="line"><span class="addition">+	 * file descriptor while the garbage collection is in progress.</span></span><br><span class="line"><span class="addition">+	 *</span></span><br><span class="line"><span class="addition">+	 * If the above conditions are met, then the directed graph of</span></span><br><span class="line"><span class="addition">+	 * candidates (*) does not change while unix_gc_lock is held.</span></span><br><span class="line"><span class="addition">+	 *</span></span><br><span class="line"><span class="addition">+	 * Any operations that changes the file count through file descriptors</span></span><br><span class="line"><span class="addition">+	 * (dup, close, sendmsg) does not change the graph since candidates are</span></span><br><span class="line"><span class="addition">+	 * not installed in fds.</span></span><br><span class="line"><span class="addition">+	 *</span></span><br><span class="line"><span class="addition">+	 * Dequeing a candidate via recvmsg would install it into an fd, but</span></span><br><span class="line"><span class="addition">+	 * that takes unix_gc_lock to decrement the inflight count, so it&#x27;s</span></span><br><span class="line"><span class="addition">+	 * serialized with garbage collection.</span></span><br><span class="line"><span class="addition">+	 *</span></span><br><span class="line"><span class="addition">+	 * MSG_PEEK is special in that it does not change the inflight count,</span></span><br><span class="line"><span class="addition">+	 * yet does install the socket into an fd.  The following lock/unlock</span></span><br><span class="line"><span class="addition">+	 * pair is to ensure serialization with garbage collection.  It must be</span></span><br><span class="line"><span class="addition">+	 * done between incrementing the file count and installing the file into</span></span><br><span class="line"><span class="addition">+	 * an fd.</span></span><br><span class="line"><span class="addition">+	 *</span></span><br><span class="line"><span class="addition">+	 * If garbage collection starts after the barrier provided by the</span></span><br><span class="line"><span class="addition">+	 * lock/unlock, then it will see the elevated refcount and not mark this</span></span><br><span class="line"><span class="addition">+	 * as a candidate.  If a garbage collection is already in progress</span></span><br><span class="line"><span class="addition">+	 * before the file count was incremented, then the lock/unlock pair will</span></span><br><span class="line"><span class="addition">+	 * ensure that garbage collection is finished before progressing to</span></span><br><span class="line"><span class="addition">+	 * installing the fd.</span></span><br><span class="line"><span class="addition">+	 *</span></span><br><span class="line"><span class="addition">+	 * (*) A -&gt; B where B is on the queue of A or B is on the queue of C</span></span><br><span class="line"><span class="addition">+	 * which is on the queue of listening socket A.</span></span><br><span class="line"><span class="addition">+	 */</span></span><br><span class="line"><span class="addition">+	spin_lock(&amp;unix_gc_lock);</span></span><br><span class="line"><span class="addition">+	spin_unlock(&amp;unix_gc_lock);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> static int unix_scm_to_skb(struct scm_cookie *scm, struct sk_buff *skb, bool send_fds)</span><br><span class="line"> &#123;</span><br><span class="line"> 	int err = 0;</span><br><span class="line"><span class="meta">@@ -2140,7 +2187,7 @@</span> static int unix_dgram_recvmsg(struct soc</span><br><span class="line"> 		sk_peek_offset_fwd(sk, size);</span><br><span class="line"></span><br><span class="line"> 		if (UNIXCB(skb).fp)</span><br><span class="line"><span class="deletion">-			scm.fp = scm_fp_dup(UNIXCB(skb).fp);</span></span><br><span class="line"><span class="addition">+			unix_peek_fds(&amp;scm, skb);</span></span><br><span class="line"> 	&#125;</span><br><span class="line"> 	err = (flags &amp; MSG_TRUNC) ? skb-&gt;len - skip : size;</span><br><span class="line"></span><br><span class="line"><span class="meta">@@ -2385,7 +2432,7 @@</span> unlock:</span><br><span class="line"> 			/* It is questionable, see note in unix_dgram_recvmsg.</span><br><span class="line"> 			 */</span><br><span class="line"> 			if (UNIXCB(skb).fp)</span><br><span class="line"><span class="deletion">-				scm.fp = scm_fp_dup(UNIXCB(skb).fp);</span></span><br><span class="line"><span class="addition">+				unix_peek_fds(&amp;scm, skb);</span></span><br><span class="line"></span><br><span class="line"> 			sk_peek_offset_fwd(sk, chunk);</span><br></pre></td></tr></table></figure>

<p>é’ˆå¯¹è¯¥æ¼æ´çš„ä¿®å¤æ˜¯åœ¨å°†æ–‡ä»¶æè¿°ç¬¦è®¾ç½®åˆ°scmæ—¶åœ¨æœ«å°¾åŠ ä¸Šgcé”ã€‚</p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/race/">race</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2025/12/19/CVE-2025-38678/"
                                   title="CVE-2025-38678"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">CVE-2025-38678</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">ç®€ä»‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E6%99%AF%E6%8F%90%E8%A6%81%EF%BC%9ACVE-2021-0920"><span class="nav-text">å‰æ™¯æè¦ï¼šCVE-2021-0920</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SCM-RIGHTS-%E6%B6%88%E6%81%AF"><span class="nav-text">SCM_RIGHTS æ¶ˆæ¯</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-text">å‘é€æ–‡ä»¶æè¿°ç¬¦</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-text">æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%B8%A6PEEK%E8%B0%83%E7%94%A8recvmsg"><span class="nav-text">ä¸å¸¦PEEKè°ƒç”¨recvmsg</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%A6PEEK%E8%B0%83%E7%94%A8recvmsg"><span class="nav-text">å¸¦PEEKè°ƒç”¨recvmsg</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="nav-text">åƒåœ¾å›æ”¶</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90"><span class="nav-text">patchåˆ†æ</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2026
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">345.9k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">ç®€ä»‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E6%99%AF%E6%8F%90%E8%A6%81%EF%BC%9ACVE-2021-0920"><span class="nav-text">å‰æ™¯æè¦ï¼šCVE-2021-0920</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SCM-RIGHTS-%E6%B6%88%E6%81%AF"><span class="nav-text">SCM_RIGHTS æ¶ˆæ¯</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-text">å‘é€æ–‡ä»¶æè¿°ç¬¦</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="nav-text">æ¥æ”¶æ–‡ä»¶æè¿°ç¬¦</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%B8%A6PEEK%E8%B0%83%E7%94%A8recvmsg"><span class="nav-text">ä¸å¸¦PEEKè°ƒç”¨recvmsg</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%A6PEEK%E8%B0%83%E7%94%A8recvmsg"><span class="nav-text">å¸¦PEEKè°ƒç”¨recvmsg</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="nav-text">åƒåœ¾å›æ”¶</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90"><span class="nav-text">patchåˆ†æ</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
